# 第八章：8

# 使用 Terraform 部署无服务器项目

无服务器计算在近年来变得越来越流行，原因也很充分。有了 AWS Lambda 和 AWS Fargate，你可以开发和部署应用程序，而无需管理服务器或基础设施。Terraform 使得在 AWS 上设计、部署和管理无服务器基础设施变得容易。

在本章中，我们将探讨 AWS 着陆区和基础设施的概念，以及它们如何帮助你设置和管理 AWS 账户和基础设施。我们将涵盖实现着陆区的不同选项，并帮助你选择适合你需求的最佳设计。此外，我们还将探索如何使用 AWS Organizations 和 Terraform 来管理你的 AWS 基础设施。

接下来，我们将深入探讨无服务器计算的世界，了解它是什么以及何时使用它。我们将介绍 AWS Lambda 和 AWS Fargate，并讲解如何使用它们构建和部署应用程序。我们还将探索不同的部署模式，并讲解如何使用 Terraform 设计和部署无服务器基础设施。

在本章结束时，你将对 AWS 着陆区和基础设施有一个扎实的理解，并且掌握如何使用 Terraform 设计和部署无服务器基础设施。

# 什么是着陆区，为什么我们需要它们？

着陆区是多账户 AWS 环境的参考架构。它提供了一组基础资源和最佳实践，你可以将其作为基础来开始你的基础设施设计。

着陆区通常包括以下组件：

+   **一个核心账户**：这是包含环境共享资源的主要账户，例如着陆区本身和**身份与访问管理**（**IAM**）资源。

+   **一个或多个成员账户**：这些账户包含你的应用程序和工作负载的资源。成员账户与核心账户关联，并继承核心账户的共享资源和政策。

+   **一个网络层**：包括**虚拟私有云**（**VPCs**）和其他在各账户之间共享的网络资源。

+   **一个安全层**：包括 IAM 政策和其他在各账户之间共享的安全资源。

+   **一个治理层**：包括用于执行合规性和管理环境的政策和控制措施。

着陆区可以通过提供一致的资源和实践，帮助你更有效、更高效地管理多账户环境。它还可以通过提供一个标准框架，帮助你更快地引导新账户和应用程序。

你可能希望在 AWS 环境中使用着陆区的原因有几个：

+   **提高安全性和合规性**：着陆区提供了一组共享的安全性和合规性资源，例如 IAM 策略和网络控制，这些资源会在所有账户中一致应用。这可以通过强制执行最佳实践并减少配置错误的风险，帮助您提高环境的安全性和合规性。

+   **提高效率和自动化**：着陆区可以通过提供一套标准的资源和实践来帮助您自动化设置和管理多账户环境。这可以节省时间和精力，减少出错的风险。

+   **提高可扩展性和灵活性**：着陆区可以通过提供一个灵活、模块化的架构，帮助您更容易地扩展环境，随着需要添加新账户和应用程序。

+   **改进的治理和控制**：一个着陆区可以通过提供一个集中位置来管理共享资源和策略，帮助您强制执行环境中的治理和控制。

## AWS 基础架构

AWS 基础架构是一组用于在 AWS 上构建和管理基础设施的最佳实践和推荐配置。它提供了如何设置您的 AWS 账户、网络、安全和治理的指南，确保架构可扩展、安全且合规。

AWS 基础架构包括以下领域的建议：

+   **账户结构**：这包括如何设置和组织您的 AWS 账户，以及如何使用 AWS Organizations 来管理这些账户的指南。

+   **网络**：这包括如何设置您的 VPC、子网和路由，以创建可扩展和安全的网络架构的指南。

+   **安全**：这包括如何使用 IAM、加密和其他安全控制来保护您的 AWS 资源的指南。

+   **治理**：这包括如何使用政策、控制和监控来强制执行合规性并管理您的 AWS 环境的指南。

AWS 基础架构旨在提供一套最佳实践和建议，您可以将其作为构建和管理 AWS 上基础设施的起点。它不是一种通用解决方案，您可能需要根据组织的具体需求调整这些建议。

AWS 基础架构不是 AWS 提供的产品或服务，而是一套您可以用来在 AWS 上构建基础设施的指南和建议。

AWS 基础架构包括设置和组织您的 AWS 账户、创建可扩展和安全的网络架构、保护您的 AWS 资源以及在环境中强制执行合规性和治理的推荐。

AWS 基础架构旨在成为一个动态文档，随着新最佳实践和推荐的发布，定期更新。

## 如何使用 Terraform 在 AWS 中构建着陆区

AWS Control Tower Account Factory 是 AWS Control Tower 的一项功能，允许您在多账户的 AWS 环境中自动化创建成员账户。通过 Account Factory，您可以使用 Terraform 模板来定义成员账户的资源和配置，然后使用 AWS Control Tower API 自动创建账户并提供资源。

下面是 AWS Control Tower Account Factory 的一些主要特性：

+   **自动化账户创建**：通过 Account Factory，您可以使用 Terraform 模板来定义成员账户的资源和配置，然后使用 AWS Control Tower API 自动创建账户并提供资源。

+   **标准化账户设置**：Account Factory 允许您对成员账户强制执行一套标准的资源和配置，帮助您确保环境中的一致性和合规性。

+   **自定义选项**：您可以在 Terraform 模板中使用变量来定制成员账户的资源和配置。这使您能够创建符合组织特定需求的账户。

+   **与 AWS Control Tower 的集成**：Account Factory 与 AWS Control Tower 集成，允许您使用 AWS Control Tower 仪表板来监控和管理您的成员账户。

Terraform 有一个详细的教程，介绍如何利用 Terraform 的 Account Factory (AFT)：[`developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft`](https://developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft)。

# 什么是无服务器计算？

无服务器计算是一种云计算执行模型，允许云服务提供商动态分配资源来运行用户的代码，用户仅为实际消耗的资源付费。这种模型让用户无需烦恼底层基础设施的配置、扩展和维护。

在无服务器模型中，用户以函数的形式创建和部署代码，这些函数会根据事件或调用进行执行。云服务提供商会自动分配必要的资源来运行该函数，用户只需为函数的实际执行付费。

无服务器计算可以带来多个好处，包括减少运营开销、可扩展性和成本效益。它特别适合那些具有间歇性或不可预测工作负载的应用程序，因为用户只需为运行代码所使用的资源付费。

AWS 提供多个无服务器计算服务，包括 AWS Lambda，它允许您在事件或调用时运行代码，以及 AWS Fargate，它允许您在无服务器环境中运行容器化应用程序。

# 什么是 AWS 无服务器模式？

AWS 无服务器模式是用于在 **Amazon Web Services** (**AWS**) 上使用无服务器技术构建和部署应用程序的常见模板。这些模式提供了设计和架构应用程序的指导，帮助你利用无服务器计算的优势。

根据应用程序的需求，你可以使用多种不同的无服务器模式。一些常见的无服务器模式包括以下几种：

+   **事件驱动架构**：这一模式涉及构建响应事件的应用程序，例如用户上传文件或传感器发送数据。

+   **微服务**：这一模式涉及将一个大型应用程序拆分成更小的、独立的服务，这些服务可以独立开发、部署和扩展。

+   **数据处理**：这一模式涉及使用无服务器技术处理大量数据，例如将数据从一种格式转换为另一种格式，或从多个来源汇总数据。

+   **Web 应用程序**：这一模式涉及使用无服务器技术构建和部署 Web 应用程序，例如静态网站或动态 Web 应用程序。

这些只是可用的无服务器模式类型中的一部分。你可以使用许多其他模式在 AWS 上构建和部署应用程序。

AWS 无服务器资源是用来构建和部署使用 AWS 上无服务器技术的应用程序的资源。这些资源可能包括各种不同的服务和工具，以下是一些例子：

+   **AWS Lambda**：一个让你无需配置或管理服务器就能运行代码的服务。

+   **Amazon API Gateway**：一个使得创建、发布、维护、监控和保护 API 变得简单的服务。

+   **AWS Fargate**：一个让你可以运行容器而无需管理底层 EC2 实例的服务。

+   **AWS Step Functions**：一个使得协调分布式应用程序和微服务的功能变得简单的服务。

+   **AWS App Runner**：一个使得构建和部署容器化应用程序变得简单的服务。

# 什么是 AWS Lambda？

AWS Lambda 是一个完全托管的无服务器计算服务，允许你响应各种事件来执行代码，例如 Amazon S3 存储桶中的数据变化或向 DynamoDB 表中添加新项。它会自动为你管理底层的计算资源，因此你无需担心配置或维护任何服务器。这使你能够专注于编写和部署代码，而无需任何管理开销。

一些常见的 AWS Lambda 使用案例包括以下几种：

+   运行 Web 和移动应用程序的后端逻辑。

+   处理数据流和事件触发器。

+   自动化维护和管理任务。

在 Lambda 中，您编写代码并将其上传到服务。当发生触发代码的事件时，Lambda 会执行代码，并自动扩展底层基础设施来运行您的代码。您只需为实际使用的计算时间付费，因此可以在不担心管理服务器或基础设施的情况下运行代码。

AWS Lambda 支持多种编程语言，包括 Node.js、Python、Java、C# 和 Go，您可以与其他 AWS 服务结合使用，构建强大且可扩展的应用程序。

让我们来看一些关键功能：

+   **Lambda 函数**：在 Lambda 中，您创建包含代码的函数。这些函数由事件触发，例如用户将文件上传到 Amazon S3 或向 API Gateway 端点发出请求。您可以指定触发函数的事件，并且当这些事件发生时，Lambda 会自动执行该函数。

+   **执行环境**：AWS Lambda 提供完全托管的执行环境，供您的函数使用。此环境包括基础设施、操作系统以及语言运行时（例如 Node.js、Python、Java 等）。创建函数时，您可以指定运行时和要分配给函数的内存大小。

+   **扩展**：使用 AWS Lambda 的一个好处是，它会自动扩展以满足应用程序的需求。当您的函数被调用时，Lambda 会分配必要的计算资源来运行您的代码。如果函数被调用的频率增加，Lambda 会自动扩展以满足更高的需求。

+   **集成**：AWS Lambda 与多种其他 AWS 服务集成，使您能够构建强大且可扩展的应用程序。例如，您可以将 Lambda 与 Amazon S3 一起使用，自动处理上传到存储桶的文件，或与 Amazon DynamoDB 一起使用，自动更新数据库中添加或修改的记录。

# 什么是 AWS Fargate？

AWS Fargate 是一项完全托管的服务，使得在 AWS 上运行容器化应用程序变得更加容易。AWS Fargate 免除了管理底层基础设施的需求，因此您可以专注于构建和运行您的应用程序。

使用 AWS Fargate，您只需指定要分配给应用程序的资源数量和类型，AWS Fargate 会处理其余部分。它会自动分配必要的计算资源，例如 Amazon **弹性计算云**（**EC2**）实例，并确保您的容器以高可用和可扩展的方式运行。

AWS Fargate 是开发者在不需要管理底层基础设施的情况下，运行容器化应用程序的理想选择。它特别适用于需要快速扩展或具有不可预测工作负载的应用程序，因为 AWS Fargate 可以根据需要自动扩展资源。

AWS Fargate 是一种完全托管的服务，这意味着 AWS 会为你管理底层基础设施。这包括为运行任务的 EC2 实例提供资源和管理，以及处理任何基础设施维护或修补。

AWS Fargate 在所有 Amazon ECS 可用的区域都可以使用，你可以使用它在 Amazon ECS 和 Amazon **弹性 Kubernetes 服务**（**EKS**）上运行任务。

AWS Fargate 支持与 Amazon ECS 相同的所有功能，包括使用 Amazon ECS 任务定义来定义任务、与其他 AWS 服务（如 Amazon CloudWatch 和 AWS IAM）的集成，以及对 Docker 容器的支持。

AWS Fargate 非常适合运行容器的用例，尤其是当你不想担心底层基础设施时。它适合那些想专注于构建和部署应用程序，而非管理基础设施的开发者，或是那些想运行容器化应用程序，但没有内部管理底层基础设施能力的组织。

你可以使用 AWS Fargate 和 Amazon **弹性容器服务**（**ECS**）或 Amazon EKS 来运行你的容器化应用程序。它还与其他 AWS 服务集成，如 Amazon CloudWatch 和 AWS IAM，您可以使用这些服务来监控和保护您的应用程序。

# 如何使用 Terraform 设计无服务器基础设施

以下是使用 Terraform 设计无服务器基础设施的通用步骤：

1.  确定可以作为无服务器资源实现的基础设施组件。这可能包括 API、后台工作者和数据处理管道等内容。

1.  确定你将使用哪些无服务器平台和服务来实现这些组件。这可能包括像 AWS Lambda、Amazon API Gateway 和 Amazon DynamoDB 这样的服务，或者像 AWS Fargate 或 AWS AppSync 这样的托管服务。

1.  定义服务器资源所需的 IAM 角色和权限。通常这涉及创建 IAM 策略并将其附加到资源可以假定的 IAM 角色上。

1.  使用 Terraform 创建必要的基础设施资源，如 VPC、网络安全组和子网。你也可以使用 Terraform 创建和配置无服务器资源本身。

1.  使用 Terraform 的依赖关系语法定义资源之间的任何依赖关系。这将确保资源按正确的顺序创建，并且它们之间建立必要的连接。

1.  使用 Terraform 的测试和验证功能确保你的基础设施配置正确，并遵循最佳实践。这可能包括运行 `terraform plan` 预览更改，或运行 `terraform validate` 检查语法错误。

1.  使用 Terraform 的版本控制集成来管理基础架构的变更。这将允许您跟踪变更、在必要时回滚到先前的版本，并与团队其他成员进行协作。

此外，以下是设计无服务器基础架构时需要考虑的一些额外要点：

+   为您的组织选择适合的部署策略。这可能包括使用 Terraform 的 `apply` 命令直接部署更改，或使用像 AWS CodePipeline 这样的持续集成/持续部署（CI/CD）平台自动化部署流程。

+   考虑您的无服务器资源的可伸缩性和可用性要求。您可以使用 Terraform 指定诸如 Amazon ECS 服务的副本数量或 AWS Lambda 函数的函数实例数量等内容。

+   使用 Terraform 的输出值来向其他工具和流程公开有关您基础架构的重要信息。例如，您可以输出 API Gateway 端点的 URL，以便其他基础架构的部分可以使用它。

+   使用 Terraform 的工作空间功能管理多个环境，如生产、测试和开发环境。这将使您能够轻松切换环境并将更改应用于适当的环境。

+   考虑使用 Terraform 模块来封装可重用的基础设施片段。这可以帮助您减少重复，并使随时间推移更轻松地管理和维护您的基础架构。

# 如何开发无服务器基础架构

要开发无服务器基础架构，您可以按照以下一般步骤进行：

1.  确定您的基础架构的组件可以作为无服务器资源实施。这可能包括诸如 API、后端工作程序和数据处理管道等内容。

1.  确定您将使用哪些无服务器平台和服务来实现这些组件。这可能包括 AWS Lambda、Amazon API Gateway 和 Amazon DynamoDB 等服务，或者像 AWS Fargate 或 AWS AppSync 这样的托管服务。

1.  为您的无服务器资源定义所需的 IAM 角色和权限。这通常涉及创建 IAM 策略并将其附加到您的资源可以承担的 IAM 角色上。

1.  使用相关工具和 API 创建和配置您的无服务器资源。这可能包括使用 AWS 管理控制台、AWS CLI 或 AWS SDK。

1.  定义资源之间的任何依赖关系，例如 API Gateway 和 Lambda 函数之间的连接，或 Lambda 函数与 DynamoDB 表之间的连接。

1.  测试您的基础架构，以确认一切都按预期运行。

1.  使用监控和日志记录工具跟踪您的无服务器资源的性能和健康状况。这可能包括使用 Amazon CloudWatch 监控资源指标和日志，或使用 AWS X-Ray 跟踪请求在您基础架构中的流动情况。

# 如何使用 Terraform 部署无服务器基础架构

部署无服务器基础设施使用 Terraform，你可以按照以下步骤操作：

1.  编写 Terraform 配置文件来定义基础设施的期望状态。这些配置文件可以使用 **HashiCorp 配置语言**（**HCL**）来指定你希望创建的资源以及这些资源的属性。

1.  如果你正在遵循事件驱动架构，应该考虑将所有触发器和资源划分到同一个 Terraform 项目中。

1.  使用 `terraform init` 命令初始化你的工作目录，并下载任何必要的插件或依赖项。

1.  使用 `terraform plan` 命令预览 Terraform 对基础设施所做的更改。这将允许你查看将要创建、修改或销毁的资源，并确认这些更改是否符合预期。

1.  使用 `terraform apply` 命令将更改应用到你的基础设施中。这将根据你的配置文件创建或更新资源。

1.  测试你的基础设施，确认一切是否按预期工作。

1.  使用 Terraform 的版本控制集成功能，管理基础设施随时间的变化。这将允许你跟踪更改，必要时回滚到以前的版本，并与其他团队成员协作。

1.  创建一个单独的 S3 存储桶，并设置相关权限，将你的 Terraform 状态文件移动到安全位置，这样也方便与其他团队成员协作。

1.  考虑在你的 CI/CD 系统中创建一个管道，用于执行你的 Terraform 模板，以提高安全性和可观察性。

1.  避免手动配置资源；使用 Terraform 来覆盖所有资源、配置和环境。任何现有或遗留的资源都可以轻松导入到 Terraform 中。

# 总结

在这一章中，我们学习了如何使用 Terraform 部署无服务器项目。我们介绍了无服务器计算的基础知识、AWS Lambda 和 AWS Fargate，以及如何使用 Terraform 设计和部署无服务器基础设施。我们还探讨了 AWS 着陆区的重要性，以及如何选择和实施它们。此外，我们还讨论了 AWS Organizations 以及如何将其与 Terraform 一起使用。

在下一章中，我们将探讨如何使用 Terraform 在 AWS 上部署容器。我们将介绍容器的基础知识、AWS ECS、Amazon EKS，以及如何使用 Terraform 部署容器。我们还将讨论在 AWS 上部署容器的最佳实践，以及如何使用 Terraform 管理容器部署。
