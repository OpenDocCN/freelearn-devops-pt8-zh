<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;4.&#xA0;Building VM Clouds and IaaS Offerings" id="164MG1-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04" class="calibre1"/>Chapter 4. Building VM Clouds and IaaS Offerings</h1></div></div></div><p class="calibre8">In the previous chapter, we installed and configured Windows Azure Pack components. The portals accessible to admins and tenants, available at this point of time, are just plain with respect to cloud services offering. In this chapter, we will build VM Clouds with the integration of Windows Azure Pack, SPF, and SCVMM. Windows Azure Pack VM Clouds are used to provide IaaS (Infrastructure as a Service) capabilities, such as virtual machines, virtual networks, and so on.</p><p class="calibre8">You will learn about VM Cloud's architecture, planning, and implementation. Furthermore, we will start building the cloud offerings, such as VMs and templates, gallery resources and their integration, and mapping with fabric resources in SCVMM. You will learn to use Microsoft-provided standard cloud services gallery items as well as develop custom gallery items for custom needs.</p><p class="calibre8">In this chapter, we will be covering the following topic:</p><div class="book"><ul class="itemizedlist"><li class="listitem">VM Clouds overview</li><li class="listitem">Registering SCVMM with Windows Azure Pack</li><li class="listitem">Building a SCVMM cloud for Windows Azure Pack cloud</li><li class="listitem">Preparing OS images for a cloud catalogue (Windows and Linux VMs)</li><li class="listitem">IaaS virtual machine offerings – standalone VM versus VM role</li><li class="listitem">Building standalone VM IaaS offerings</li><li class="listitem">The VM Role architecture</li><li class="listitem">Building VM Role IaaS offerings using gallery resources</li><li class="listitem">Using the<a id="id445" class="calibre1"/> <span class="strong"><strong class="calibre9">GRIT</strong></span> (<span class="strong"><strong class="calibre9">Gallery Resource Import</strong></span>) tool</li><li class="listitem">Developing VM Role gallery resources using VM Role Authoring Tool</li><li class="listitem">Accessing tenant's virtual machines – Windows Azure Pack Console Connect</li></ul></div></div>

<div class="book" title="Chapter&#xA0;4.&#xA0;Building VM Clouds and IaaS Offerings" id="164MG1-b479cf466c26404ca54119871a9b2715">
<div class="book" title="VM Clouds overview"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch04lvl1sec33" class="calibre1"/>VM Clouds overview</h1></div></div></div><p class="calibre8">VM Clouds in Windows Azure Pack cloud solution is a top-level umbrella to provide IaaS services. Clouds created in <span class="strong"><strong class="calibre9">System Center Virtual Machine</strong></span> <span class="strong"><strong class="calibre9">Manager (SCVMM)</strong></span> are represented as VM Clouds in the Windows Azure Pack management portal.</p><p class="calibre8">VM Clouds can be<a id="id446" class="calibre1"/> used to provide IaaS services with multitenancy capabilities. In Windows Azure Pack-based cloud, cloud plans and subscriptions and cloud offering catalogues and fabric resources are provisioned, mapped, and managed on a VM Cloud level.</p><p class="calibre8">Windows Azure Pack uses SPF to communicate with VMM for all operations and management with respect to VM Clouds. There can be a multiple number of VM Clouds created in one or more SCVMM as per requirements; it is recommended to only single or fewer VM Clouds.</p><p class="calibre8">Use case for creating multiple VM Cloud includes GEO site locations, dedicated hardware services to tenants, backup/secondary/DR infrastructure, or as per the features available as per the cloud provider's strategy; but, they are not limited to these.</p><p class="calibre8">IaaS services include virtual machines, virtual networks, and IaaS machines with automated application deployment, and they are provided using VM Clouds. But, they are not limited to these.</p><p class="calibre8">VM Clouds are responsible for delivering IaaS services including virtual machines and networks along with automated application deployment inside the virtual machines.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Registering SCVMM with Windows Azure Pack"><div class="book" id="173722-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec34" class="calibre1"/>Registering SCVMM with Windows Azure Pack</h1></div></div></div><p class="calibre8">Before we start building<a id="id447" class="calibre1"/> VM Clouds and IaaS offerings, we <a id="id448" class="calibre1"/>must register our SCVMM instance with Windows Azure Pack. This is also called stamp registration.</p><p class="calibre8">The following steps need to be carried out for registering SCVMM stamp with Windows Azure Pack:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the Windows Azure Pack Management portal for administrators.</li><li class="listitem" value="2">Browse the <span class="strong"><strong class="calibre9">vm clouds</strong></span> workspace.<div class="mediaobject"><img src="../images/00056.jpeg" alt="Registering SCVMM with Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Click on <span class="strong"><strong class="calibre9">USE AN EXISTING VIRTUAL MACHINE CLOUD PROVIDER TO PROVISION VIRTUAL MACHINES</strong></span>.</li><li class="listitem" value="4">Provide <span class="strong"><strong class="calibre9">VIRTUAL MACHINE MANAGER SERVER FQDN</strong></span> and <span class="strong"><strong class="calibre9">PORT NUMBER</strong></span> (if customized). Note that it doesn't ask for credentials as Windows Azure<a id="id449" class="calibre1"/> Pack uses the service provider foundation <a id="id450" class="calibre1"/>VMM service account for accessing VMM. Enter <span class="strong"><strong class="calibre9">REMOTE DESKTOP GATEWAY FQDN</strong></span>, which will be used for Azure Pack Console Connect. This can be configured later as a remote Desktop Gateway is covered later in this chapter.<div class="mediaobject"><img src="../images/00057.jpeg" alt="Registering SCVMM with Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Upon successful registration, VMM stamps will be displayed in the <span class="strong"><strong class="calibre9">CLOUDS</strong></span> workspace in the Windows Azure Pack portal.<div class="mediaobject"><img src="../images/00058.jpeg" alt="Registering SCVMM with Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="6">Review<a id="id451" class="calibre1"/> the Windows Azure Pack registration error, Windows Azure Pack, SPF, and VMM logs in case of any registration failure.</li></ol><div class="calibre27"/></div><p class="calibre8">We do not see any <a id="id452" class="calibre1"/>cloud listed in the Windows Azure Pack portal at this point as we have only integrated the virtualization machine cloud provider. Now, we will start building VM Clouds.</p></div>

<div class="book" title="Registering SCVMM with Windows Azure Pack">
<div class="book" title="Building a SCVMM cloud for Windows Azure Pack cloud"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec55" class="calibre1"/>Building a SCVMM cloud for Windows Azure Pack cloud</h2></div></div></div><p class="calibre8">A cloud in <span class="strong"><strong class="calibre9">SCVMM</strong></span> is an<a id="id453" class="calibre1"/> umbrella containing our VMM fabric resources, such as compute (hypervisors), networking, and storage along with resources, such as VM, services, and templates. A cloud created in SCVMM is used by Windows Azure Pack to offer IaaS services to tenants using plans and subscriptions.</p><p class="calibre8">A cloud in SCVMM can<a id="id454" class="calibre1"/> be created using SCVMM host groups, which may contain different hypervisors or can be created from the VMware resource pool. At the time of writing this book, Windows Azure Pack VM Cloud didn't support SCVMM cloud created using the VMware resource pool.</p><p class="calibre8">Note that though VMware or server resources can be added in a SCVMM Cloud, IaaS resource provisioning on these via Windows Azure Pack tenant portal isn't possible. At this point of time, only Hyper-V is the supported hypervisor for IaaS services in a WAP VM Cloud. The third-party partner solutions are available for using Windows Azure Pack with VMware-based virtualization solutions. This limitation is applicable only for tenants' IaaS workloads, VMware/Xen, and other based VMs that can be used to host Windows Azure Pack management servers, websites, DBaaS servers, and more.</p><p class="calibre8">Before creating a SCVMM cloud, let's have a look at the SCVMM cloud's requirements with respect to Windows Azure Pack VM Cloud support.</p></div></div>

<div class="book" title="Registering SCVMM with Windows Azure Pack">
<div class="book" title="Requirements for Windows Azure Pack VM Clouds"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec56" class="calibre1"/>Requirements for Windows Azure Pack VM Clouds</h2></div></div></div><p class="calibre8">While creating a <a id="id455" class="calibre1"/>SCVMM cloud, consider the following prerequisites that need to be taken care of with respect to the Windows Azure Pack VM Cloud:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An SCVMM cloud must be created from host groups. A cloud created with VMware resource pool is not supported by Windows Azure Pack at this point of time.</li><li class="listitem">The cloud capability profile (ESX server, Hyper-V, or XenServer) must not be selected while creating the cloud.</li><li class="listitem">A cloud capacity (compute/network/storage resource) must be selected as per the available capacity. The limits of these resources will be applicable for tenants using Windows Azure Pack cloud while provisioning resources.</li><li class="listitem">Logical network planned for Windows Azure Pack must be already created and associated with the SCVMM cloud.</li><li class="listitem">The VMM library share must be already created and configured with the cloud.</li><li class="listitem"> <span class="strong"><strong class="calibre9">Service Management Automation</strong></span> (<span class="strong"><strong class="calibre9">SMA</strong></span>) will <a id="id456" class="calibre1"/>be discussed in the upcoming chapters. If it is being used for automation with respect to the SCVMM cloud, then the SMA web service certificate must be trusted on the SPF server. This will be discussed in detail in <a class="calibre1" title="Chapter 9. Automation and Authentication – Service Management Automation and ADFS" href="part0082_split_000.html#2E6E41-b479cf466c26404ca54119871a9b2715">Chapter 9</a>, <span class="strong"><em class="calibre12">Automation and Authentication – Service Management Automation and ADFS</em></span>.</li></ul></div></div></div>

<div class="book" title="Registering SCVMM with Windows Azure Pack">
<div class="book" title="Creating a cloud in SCVMM"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec57" class="calibre1"/>Creating a cloud in SCVMM</h2></div></div></div><p class="calibre8">The SCVMM<a id="id457" class="calibre1"/> management console is used to create a cloud in VMM. Before<a id="id458" class="calibre1"/> creating a cloud, verify that you have configured all the required fabric components. See <a class="calibre1" title="Chapter 2. Getting the Cloud Fabric Ready" href="part0023_split_000.html#LTSU2-b479cf466c26404ca54119871a9b2715">Chapter 2</a>, <span class="strong"><em class="calibre12">Getting the Cloud Fabric Ready</em></span>, to review the fabric components requirements.</p><p class="calibre8">Carry out these steps to create the SCVMM cloud:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the SCVMM server using the VMM console with administrative access.</li><li class="listitem" value="2">Click on <span class="strong"><strong class="calibre9">Create Cloud</strong></span> in the <span class="strong"><strong class="calibre9">Home</strong></span> ribbon.<div class="mediaobject"><img src="../images/00059.jpeg" alt="Creating a cloud in SCVMM" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Provide the <a id="id459" class="calibre1"/>cloud name and description in <span class="strong"><strong class="calibre9">Create Cloud Wizard</strong></span>.<p class="calibre15"> </p><div class="mediaobject"><img src="../images/00060.jpeg" alt="Creating a cloud in SCVMM" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Select the<a id="id460" class="calibre1"/> <span class="strong"><strong class="calibre9">Host groups</strong></span> cloud that is to be used for Windows Azure Pack tenant's workload in the <span class="strong"><strong class="calibre9">Select resource for this cloud</strong></span> section. The wizard will also display the capacity or host groups in terms of CPU's memory and network.<div class="mediaobject"><img src="../images/00061.jpeg" alt="Creating a cloud in SCVMM" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">On the <span class="strong"><strong class="calibre9">Logical Networks</strong></span> page, select logical network or networks created for the <a id="id461" class="calibre1"/>usage of Windows Azure Pack Cloud. It will be used by tenants to create and use VM networks. This will leverage network<a id="id462" class="calibre1"/> virtualization for provisioning virtual networks for tenants independent of each other. See <a class="calibre1" title="Chapter 2. Getting the Cloud Fabric Ready" href="part0023_split_000.html#LTSU2-b479cf466c26404ca54119871a9b2715">Chapter 2</a>, <span class="strong"><em class="calibre12">Getting the Cloud Fabric Ready</em></span>, to learn more about network virtualization.<div class="note" title="Note"><h3 class="title2"><a id="note21" class="calibre1"/>Note</h3><p class="calibre8">Note that logical networks assigned with physical network adaptors on Hyper-V hosts will only be visible on this page.</p></div><div class="mediaobject"><img src="../images/00062.jpeg" alt="Creating a cloud in SCVMM" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="6">Optionally, select <span class="strong"><strong class="calibre9">Load Balancers</strong></span> to be made available for access in this cloud.</li><li class="listitem" value="7">Optionally, select <span class="strong"><strong class="calibre9">VIP Templates</strong></span> for cloud usage. VIP templates are used in conjunction<a id="id463" class="calibre1"/> with load balancers for virtual IPs and other related configurations.</li><li class="listitem" value="8">Optionally, select <span class="strong"><strong class="calibre9">Port Classifications </strong></span>to be used for cloud resources. The port profile<a id="id464" class="calibre1"/> can be used to specify <span class="strong"><strong class="calibre9">QOS</strong></span> (<span class="strong"><strong class="calibre9">Quality of Service</strong></span>) at the <a id="id465" class="calibre1"/>cloud layer along with a granular control at the Windows Azure Pack plans level.</li><li class="listitem" value="9">Optionally, select <span class="strong"><strong class="calibre9">Storage</strong></span> to be used to store virtual machines for this cloud. See <a class="calibre1" title="Chapter 2. Getting the Cloud Fabric Ready" href="part0023_split_000.html#LTSU2-b479cf466c26404ca54119871a9b2715">Chapter 2</a>, <span class="strong"><em class="calibre12">Getting the Cloud Fabric Ready</em></span>, to know more on storage options for the Windows Azure Pack cloud.</li><li class="listitem" value="10">Select the stored VM path and read only library shares for cloud usage.<div class="mediaobject"><img src="../images/00063.jpeg" alt="Creating a cloud in SCVMM" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="11">Select <span class="strong"><strong class="calibre9">Capacity</strong></span> to know about the cloud capacity available for usage by tenants. This is one of the most important settings at the SCVMM layer for the cloud. The <a id="id466" class="calibre1"/>capacity should be wisely selected as per the <a id="id467" class="calibre1"/>availability of resources. This capacity limit will be applicable for all the tenants that the IaaS workload has hosted inside the cloud. The tenant level capacity limit shall be configured and at the Windows Azure Pack plan's level. While values such as CPU and memory are self-explanatory, custom quota values in capacity are values defined for virtual machine templates based upon parameters such as size. Later, these are used for restricting maximum resources provisioned by any self-service user in cloud.<div class="note" title="Note"><h3 class="title2"><a id="note22" class="calibre1"/>Note</h3><p class="calibre8">Note that custom quota points provide backward compatibility and are only applicable for self-service users created in VMM 2008 R2. These aren't applicable for Windows Azure Pack VM Clouds.</p></div><div class="mediaobject"><img src="../images/00064.jpeg" alt="Creating a cloud in SCVMM" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="12">On the <span class="strong"><strong class="calibre9">Capability Profiles</strong></span> page, do not select any of the profiles (ESX/Hyper-V/XenServer). Windows Azure Pack doesn't support using a SCVMM cloud with a capability<a id="id468" class="calibre1"/> profile for IaaS workload of tenants.</li><li class="listitem" value="13">If applicable, add any <span class="strong"><strong class="calibre9">Cloud Disaster Recovery Solutions</strong></span> on <span class="strong"><strong class="calibre9">Replication Groups</strong></span> page.</li><li class="listitem" value="14">Review the <a id="id469" class="calibre1"/>settings on the <span class="strong"><strong class="calibre9">Summary</strong></span> page.</li><li class="listitem" value="15">Click on <span class="strong"><strong class="calibre9">Finish</strong></span> to create the cloud.</li><li class="listitem" value="16">View the jobs to verify the status of cloud creation jobs. The newly created cloud will be visible in the <span class="strong"><strong class="calibre9">SCVMM VMs</strong></span> and <span class="strong"><strong class="calibre9">Service Management</strong></span> workspaces.<div class="note" title="Note"><h3 class="title2"><a id="note23" class="calibre1"/>Note</h3><p class="calibre8">Azure Site Recovery, Microsoft's cloud-based disaster recovery offering, can be leveraged<a id="id470" class="calibre1"/> for protecting SCVMM clouds against disasters. See <a class="calibre1" href="https://azure.microsoft.com/en-in/services/site-recovery/">https://azure.microsoft.com/en-in/services/site-recovery/</a> to learn more about Azure Site Recovery.</p></div></li></ol><div class="calibre27"/></div><div class="book" title="Verifying a SCVMM cloud in the Windows Azure Pack portal"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch04lvl3sec24" class="calibre1"/>Verifying a SCVMM cloud in the Windows Azure Pack portal</h3></div></div></div><p class="calibre8">We created a<a id="id471" class="calibre1"/> SCVMM cloud in the previous topic. In order to use it for building IaaS cloud offerings, it must be visible in the Windows Azure Pack Management portal for administrators under VM Clouds. Service provider foundation does the job of synchronizing the changes made at SCVMM and Windows Azure Pack level and vice versa. Let's verify that the cloud is visible in the Windows Azure Pack Management portal:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the Windows Azure Pack Management portal for administrators.</li><li class="listitem" value="2">Browse the <span class="strong"><strong class="calibre9">VM CLOUDS</strong></span> sections.</li><li class="listitem" value="3">Expand the currently registered SCVMM stamp.</li><li class="listitem" value="4">The newly <a id="id472" class="calibre1"/>created cloud in the previous topic will be visible.<div class="mediaobject"><img src="../images/00065.jpeg" alt="Verifying a SCVMM cloud in the Windows Azure Pack portal" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div><p class="calibre8">If you do not see the newly created cloud listed in the Windows Azure Pack Management portal, verify the status of <span class="strong"><strong class="calibre9">Create new Cloud</strong></span> Job in VMM. Have a look at the SPF SCVMM and Windows Azure Pack Integration checklist and status.</p><p class="calibre8">The SCVMM <span class="strong"><strong class="calibre9">Jobs</strong></span> window provides clear details, comprising events occurred to perform any particular task along with individual status. This can be handy for any troubleshooting operation.</p><div class="mediaobject"><img src="../images/00066.jpeg" alt="Verifying a SCVMM cloud in the Windows Azure Pack portal" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre8">With this topic, we have successfully<a id="id473" class="calibre1"/> integrated our fabric and cloud with Windows Azure Pack. Furthermore, we will start creating cloud offerings for our Windows Azure Pack cloud.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Preparing OS images for a cloud catalogue (Windows and Linux VMs)"><div class="book" id="181NK2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec35" class="calibre1"/>Preparing OS images for a cloud catalogue (Windows and Linux VMs)</h1></div></div></div><p class="calibre8">A cloud offering catalogue can be compared with any online shopping websites items catalogue. In any online shopping website, there are different types of items available for purchase, and then each item maybe available in different sizes or versions.</p><p class="calibre8">Customers choose items available in the given catalogue and make a purchase. The similar purchase<a id="id474" class="calibre1"/> aspect applies in the case of cloud catalogues. If we see any public cloud provider, such as Microsoft, Amazon, and more such catalogues for virtual machines offerings, there would be a range of operating systems available in different formats, such as Vanilla OS or an OS customized for particular application or workload type, which are available in different size configurations (CPU/memory/storage capacity). There can be other characteristics as well as differentiating catalogues, such as high availability, performance, features, and so on.</p><p class="calibre8">In the case of Windows Azure Pack-based cloud solution, SCVMM VM templates and Windows Azure Pack gallery items are the backbone of cloud catalogues. Both VM templates and gallery items rely on preinstalled OS VHDXs for the provisioning of virtual machines and applications. This<a id="id475" class="calibre1"/> Hyper-V <span class="strong"><strong class="calibre9">Virtual Hard Disk</strong></span> (<span class="strong"><strong class="calibre9">VHD</strong></span>) or VHDXs is stored in the VMM library for usage by VM templates and gallery resources.</p><p class="calibre8">In this section, we will cover the planning and execution of the preparation of virtual disks for VM templates and gallery items.</p></div>

<div class="book" title="Preparing OS images for a cloud catalogue (Windows and Linux VMs)">
<div class="book" title="Planning VM images"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec58" class="calibre1"/>Planning VM images</h2></div></div></div><p class="calibre8">Preparing<a id="id476" class="calibre1"/> VM images and catalogues is a continuous process in any cloud solution since the cloud has to fulfil the daily changing needs of IT solutions. The number and types of images to be prepared for any cloud will depend on the provider's strategy and offerings portfolio.</p><p class="calibre8">In a generic scenario for a Windows Azure Pack-based cloud solution, the following images can be prepared for both organizations and service providers cloud solutions.</p><p class="calibre8">The following are based upon the operating systems supported by Hyper-V:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Images for all the available and supported Windows operating systems are as follows:<div class="book"><ul class="itemizedlist1"><li class="listitem">Windows Server 2012 R2</li><li class="listitem">Windows Server 2012</li><li class="listitem">Windows Server 2008 R2 SP1</li><li class="listitem">Windows Client Operating Systems (Win 7/8/8.1)</li></ul></div></li><li class="listitem">Images for all available and supported Unix/Linux flavor operating systems are as follows:<div class="book"><ul class="itemizedlist1"><li class="listitem">Red Hat Enterprise Linux</li><li class="listitem">Cent OS</li><li class="listitem">Any other supported Unix distributions</li></ul></div></li><li class="listitem">Any other Hyper-V supported operating system</li></ul></div><p class="calibre8">For the size of the operating system disk, Windows Azure Pack provides the same size to the tenant's virtual machines as that of the VHD's template. Though it can be customized using Windows Azure Pack automation capabilities, it's a good idea to have OS virtual disks available in multiple size variants such as the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">150 GB</li><li class="listitem">100 GB</li><li class="listitem">80 GB</li><li class="listitem">40 GB</li><li class="listitem">Any other size as per the organization's or tenant's needs</li></ul></div><p class="calibre8">In applications or workload specific OS disk Infrastructure as a Service (IaaS) Virtual machines are not just about providing plain operating systems for tenants' workloads; it can also provide servers with preconfigured applications of automated application deployment as per tenant's requirement; examples include web servers, dedicated database server dedicated for tenant, and so on. Separate OS disks can be created for applications or workload <a id="id477" class="calibre1"/>specific offerings having specific preinstalled or configuration apps or platforms for deploying applications (such as .NET framework).</p></div></div>

<div class="book" title="Preparing OS images for a cloud catalogue (Windows and Linux VMs)">
<div class="book" title="Preparing a Sysprepped virtual disk for Windows OS virtual machine"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec59" class="calibre1"/>Preparing a Sysprepped virtual disk for Windows OS virtual machine</h2></div></div></div><p class="calibre8">Each Windows<a id="id478" class="calibre1"/> operating system has<a id="id479" class="calibre1"/> a unique identifier attached, that is, a SID (secure ID). To avoid any SID conflict, Sysprep is used for VMs deployed using template VHD.</p><p class="calibre8">Once planning is completed for VM images to be prepared, the following instructions can be followed to prepare a Sysprepped virtual disk.</p><p class="calibre8">Steps for preparing VHD for Windows operating systems templates are as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a Hyper-V virtual machine.</li><li class="listitem" value="2">Mount OS installation ISO and install the operating system.</li><li class="listitem" value="3">Install or verify Hyper-V integration services.</li><li class="listitem" value="4">Configure any required local hardening policies.</li><li class="listitem" value="5">Configure the accessibility setting such as enabling RDP and configuring Windows Firewall.</li><li class="listitem" value="6">Install required agents (Antivirus, Backup, and so on).</li><li class="listitem" value="7">Install any required Windows Roles and features if applicable.</li><li class="listitem" value="8">Install any other third-party applications if applicable.</li><li class="listitem" value="9">Add any script in start-up (such as Windows activation, agents configuration, and application deployment).</li><li class="listitem" value="10">Update OS with the latest Windows patches and services packs.</li><li class="listitem" value="11">Perform the necessary housekeeping such as removing installation media, event viewer logs, temp files, and more.</li><li class="listitem" value="12">Have a final look at the OS to identify any missing component or issue.</li><li class="listitem" value="13">For generalizing the OS image using Sysprep, we can find <code class="email">Sysprep.exe</code> in <code class="email">C:\Windows\System32\Sysprep</code> folder. Select <span class="strong"><strong class="calibre9">Enter System Out-of-Box Experience (OOBE)</strong></span> in <span class="strong"><strong class="calibre9">System Clean-up Action</strong></span> with the <span class="strong"><strong class="calibre9">Generalize</strong></span> option checked. Select <span class="strong"><strong class="calibre9">Shutdown</strong></span> in <span class="strong"><strong class="calibre9">Shutdown Options</strong></span> to power off the VM post in completion of Sysprep.<div class="mediaobject"><img src="../images/00067.jpeg" alt="Preparing a Sysprepped virtual disk for Windows OS virtual machine" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div><p class="calibre8">Post completion<a id="id480" class="calibre1"/> of this process, the virtual disk file can be copied to the VMM library for the usage of templates. It's a<a id="id481" class="calibre1"/> good idea to keep multiple copies of the prepared disk file for future usage and rollback.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note24" class="calibre1"/>Note</h3><p class="calibre8">Product key, hostname, and other values configured in the virtual disk don't have any effect on the provisioned VM using this. These will not be used after the Sysprep process.</p></div></div></div>

<div class="book" title="Preparing OS images for a cloud catalogue (Windows and Linux VMs)">
<div class="book" title="Preparing VHDX for a Linux OS virtual machine"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec60" class="calibre1"/>Preparing VHDX for a Linux OS virtual machine</h2></div></div></div><p class="calibre8">Linux operating systems don't have any SID associates; hence, it does not require any Sysprep operation to be performed. However, there are additional considerations that need to be followed<a id="id482" class="calibre1"/> for generalizing OS image for the Linux workload.</p><p class="calibre8">Let's carry out the<a id="id483" class="calibre1"/> following steps to prepare the Linux OS image:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Finalize the Linux version, partitions/LVM configurations, and more.</li><li class="listitem" value="2">Mount the OS installation ISO and install the operating system.</li><li class="listitem" value="3">Install or verify <span class="strong"><strong class="calibre9">Linux Integration Services</strong></span> (<span class="strong"><strong class="calibre9">LIS</strong></span>).</li><li class="listitem" value="4">Configure any required local hardening policies.</li><li class="listitem" value="5">Install required agents (Antivirus, Backup, and so on).</li><li class="listitem" value="6">Install the SCVMM guest agent.</li><li class="listitem" value="7">Install any other third-party applications if applicable.</li><li class="listitem" value="8">Add any script in start-up (such as agents configuration /application deployment).</li><li class="listitem" value="9">Update the OS with the latest patches and updates.</li><li class="listitem" value="10">Perform<a id="id484" class="calibre1"/> some necessary housekeeping, such as removing installation media, logs, temp files, and so on.</li><li class="listitem" value="11">Have a final look at the OS to identify any missing components or issues.</li><li class="listitem" value="12">Remove <a id="id485" class="calibre1"/>any IP configuration and shutdown the virtual machine.</li></ol><div class="calibre27"/></div><p class="calibre8">Post completion of this process, the virtual disk file can be copied to the VMM library for the usage of templates. It's a good idea to keep multiple copies of prepared disk file for future usage and rollback.</p><p class="calibre8">The SCVMM guest agent for the Linux operating system can be found on <code class="email">C:\Program Files\Microsoft System Center 2012\Virtual Machine Manager\agents\Linux</code> on the VMM management server. Copy the agents into the Linux VM and execute the following commands for installation:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">chmod +x install</strong></span>
</pre></div></li><li class="listitem">Run either of the following commands as applicable for x86 or x64:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">./install scvmmguestagent.1.0.0.544.x64.tar</strong></span>
<span class="strong"><strong class="calibre9">./install scvmmguestagent.1.0.0.544.x86.tar</strong></span>
</pre></div></li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="IaaS virtual machine offerings &#x2013; standalone VM versus VM Role" id="190861-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec36" class="calibre1"/>IaaS virtual machine offerings – standalone VM versus VM Role</h1></div></div></div><p class="calibre8">Windows Azure Pack-based cloud solution provides the following two options to tenants for provisioning virtual <a id="id486" class="calibre1"/>machine workloads:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Standalone virtual machine</li><li class="listitem">Virtual machine role (VM Role)</li></ul></div></div>

<div class="book" title="IaaS virtual machine offerings &#x2013; standalone VM versus VM Role" id="190861-b479cf466c26404ca54119871a9b2715">
<div class="book" title="Standalone virtual machine"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec61" class="calibre1"/>Standalone virtual machine</h2></div></div></div><p class="calibre8">Standalone virtual machine in Windows Azure Pack tenant admin portal is a direct mapping between standalone the VM offerings catalogue and the VM template created and configured in SCVMM.</p><p class="calibre8">For a standalone <a id="id487" class="calibre1"/>virtual machine, all the configurations are performed at the SCVMM level. The Windows Azure Pack portal is used to create virtual machine using predefined configurations in the SCVMM VM template. This does not give any flexibility to the tenant user to customize VM as per custom needs.</p><p class="calibre8">Cloud administrator <a id="id488" class="calibre1"/>needs to precreate multiple SCVMM VM templates for different sizes and options for providing flexibility to tenants in terms of choice. Any changes in the existing standalone VM offering has to be performed at the SCVMM end only.</p><p class="calibre8">Since standalone VM in Windows Azure Pack uses SCVMM VM templates directly, it is normally used to provide the vanilla operating system or OS with preinstalled or configured applications. It cannot be used to install applications as per tenants' needs in an automated fashion (which is provided by the service template engine in SCVMM).</p><p class="calibre8">In further topics, you will learn to create a SCVMM VM template, which can be used by standalone VM Role in Windows Azure Pack.</p></div></div>

<div class="book" title="IaaS virtual machine offerings &#x2013; standalone VM versus VM Role" id="190861-b479cf466c26404ca54119871a9b2715">
<div class="book" title="VM Role"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec62" class="calibre1"/>VM Role</h2></div></div></div><p class="calibre8">VM Role in Windows Azure Pack provides a customizable self-service wizard for tenant users to request for virtual <a id="id489" class="calibre1"/>machines, which gives flexibility to tenant users to customize their virtual machines as per requirements. VM Roles can also be used to deploy automated applications at the top of virtual machines being delivered in the same self-service manner.</p><p class="calibre8">Unlike standalone<a id="id490" class="calibre1"/> VM Role, VM Role uses a service template engine of SCVMM for provisioning OS and apps.</p><p class="calibre8">VM Role in Windows Azure Pack subscription may contain multiple virtual machines of the same type or application and can be scaled easily (by just moving a sliding bar).</p><p class="calibre8">VM Role provides a lot of flexibilities over standalone VMs such as the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Customizable self-service <a id="id491" class="calibre1"/>wizard for tenant's VM requests</li><li class="listitem">With VM Role, tenants control VM configurations and deployment with options provided by the cloud provider, which removes any dependency on the VMM administrator for any VM changes required on the standard template.</li><li class="listitem">It adds extreme automation<a id="id492" class="calibre1"/> capabilities with the integration of <span class="strong"><strong class="calibre9">SMA</strong></span> (<span class="strong"><strong class="calibre9">Service Management Automation</strong></span>)</li><li class="listitem">It deploys applications and not just virtual machines in a self-service automated manner</li><li class="listitem">It deploys and manage multiple instances of the same type under a single umbrella</li><li class="listitem">It scales out the <a id="id493" class="calibre1"/>number of instances in just one click (by moving a slider)</li><li class="listitem">It provides the flexibility of using Hyper-V differencing or dedicated disks (added in CU5) for operating systems saving ample amount of disk space and management in larger deployments</li><li class="listitem">Microsoft <a id="id494" class="calibre1"/>and third-party vendors provide a wide range of preconfigured gallery items for VM Roles for standard usage. Custom VM Roles can also be developed which makes sky the limit for VM Role offerings possibilities.</li></ul></div><p class="calibre8">In further topics, you will learn architecture, implementation, and other aspects of VM Roles.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Building standalone VM IaaS offerings"><div class="book" id="19UOO2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec37" class="calibre1"/>Building standalone VM IaaS offerings</h1></div></div></div><p class="calibre8">For every<a id="id495" class="calibre1"/> standalone VM offering in Windows Azure pack cloud, there has to be a direct mapping present with VM template in the SCVMM library. The VM template in the SCVMM library can be configured using a virtual disk prepared in the earlier topics. Let's start creating VM templates in SCVMM for Windows Azure Pack usage. Multiple templates can be created using the same VHD and defined hardware/OS profile combinations to provide flexible options for tenants for deploying VM workloads.</p></div>

<div class="book" title="Building standalone VM IaaS offerings">
<div class="book" title="Requirements for using VM templates for Windows Azure Pack"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec63" class="calibre1"/>Requirements for using VM templates for Windows Azure Pack</h2></div></div></div><p class="calibre8">The following <a id="id496" class="calibre1"/>consideration must be taken care while creating VM templates to be used for a standalone VM in Windows Azure Pack:</p><div class="book"><ul class="itemizedlist"><li class="listitem">There must not be any cloud capability profile selected on the hardware profile page in the template creation wizard. The same case applies in case of any preconfigured hardware profile that is being used.</li><li class="listitem">The VHD that is being used to create the template must have a remote desktop enabled.</li><li class="listitem">While creating the VM template, the guest OS profile must be selected from the drop-down list. It <a id="id497" class="calibre1"/>should not be selected as none.</li></ul></div></div></div>

<div class="book" title="Building standalone VM IaaS offerings">
<div class="book" title="Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec64" class="calibre1"/>Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings</h2></div></div></div><p class="calibre8">Before<a id="id498" class="calibre1"/> creating VM templates, prepare the required VHDs for templates and copy them to the VMM library.</p><p class="calibre8">Steps for<a id="id499" class="calibre1"/> creating a VM template for the standalone VM Role are as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into SCVMM using the VMM management console with administrator privileges.</li><li class="listitem" value="2">Navigate to the <span class="strong"><strong class="calibre9">Library</strong></span> workspace and expand <span class="strong"><strong class="calibre9">Templates</strong></span>.<div class="mediaobject"><img src="../images/00068.jpeg" alt="Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Click <a id="id500" class="calibre1"/><span class="strong"><strong class="calibre9">Create VM Template</strong></span> to start the VM template wizard.</li><li class="listitem" value="4">Select <span class="strong"><strong class="calibre9">Use an Existing VM template or virtual hard disk stored in the library</strong></span>. You can also choose <span class="strong"><strong class="calibre9">From an existing virtual machine that is deployed on a host</strong></span> if the VHD file isn't already copied to the VMM library.<div class="mediaobject"><img src="../images/00069.jpeg" alt="Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Click on <span class="strong"><strong class="calibre9">Browse</strong></span> to select VHD from the disks available in the VMM library.</li><li class="listitem" value="6">Provide the <a id="id501" class="calibre1"/>Template Name, Description, and Generation. Use a self-explanatory name and description that provides details about VM as this will be visible to the tenant user on the Windows Azure Pack portal. It's a good idea to include<a id="id502" class="calibre1"/> both hardware and software configurations along with the feature set available in the description.<div class="note" title="Note"><h3 class="title2"><a id="note25" class="calibre1"/>Note</h3><p class="calibre8">The generation of VM describes features and functionality available with virtual machines. Generation 2 VM introduces the Hyper-V 2012 R2; it provides support for the UEFI firmware, all synthetic devices, and more. See <a class="calibre1" href="https://technet.microsoft.com/en-in/library/dn282285.aspx">https://technet.microsoft.com/en-in/library/dn282285.aspx</a> to learn more <a id="id503" class="calibre1"/>about generation 2 virtual machines.</p></div><div class="mediaobject"><img src="../images/00070.jpeg" alt="Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="7">Use a precreated hardware profile or custom settings to customize hardware for the<a id="id504" class="calibre1"/> template. Ensure that no cloud capability profile is selected. Any hardware change in the offering at later storage has to be done in the hardware profile properties of the VM template.</li><li class="listitem" value="8">Configure <a id="id505" class="calibre1"/>a proper network configuration such as virtual switch name, IP pool, and MAC (has to be static) as per the tenant's requirement. Add any additional hardware such as data disks at this stage.<div class="mediaobject"><img src="../images/00071.jpeg" alt="Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="9">Configure <a id="id506" class="calibre1"/>operating system profile settings. Do not select none in the OS profile settings; instead, precreate <span class="strong"><strong class="calibre9">Guest OS profiles</strong></span> and select it from the drop-down list. Make necessary changes, such as Windows OS version, administrator <a id="id507" class="calibre1"/>password, time zone, product key, Domain/Workgroup, scripts to run, and so on. Do not select any Roles and features to add in this page. These are supported only with service templates or VM Role.<div class="mediaobject"><img src="../images/00072.jpeg" alt="Creating a SCVMM virtual machine template for Windows Azure Pack standalone VM Cloud offerings" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="10">Select <a id="id508" class="calibre1"/>none for the application profile and SQL profile settings as these aren't supported with standalone VM.</li><li class="listitem" value="11">Review the<a id="id509" class="calibre1"/> settings on the <span class="strong"><strong class="calibre9">Summary</strong></span> page and finish the wizard for creating the VM template.</li><li class="listitem" value="12">View job status under the <span class="strong"><strong class="calibre9">Jobs</strong></span> windows in <span class="strong"><strong class="calibre9">Settings</strong></span>.</li><li class="listitem" value="13">The newly created template will be available in the VMM library workspace under the <span class="strong"><strong class="calibre9">VM Templates</strong></span> section.</li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Building standalone VM IaaS offerings">
<div class="book" title="Testing the VM template functionality"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec65" class="calibre1"/>Testing the VM template functionality</h2></div></div></div><p class="calibre8">Before assigning<a id="id510" class="calibre1"/> this standalone VM template in a Windows Azure Pack deployment, it's a good idea to test the<a id="id511" class="calibre1"/> configuration by provisioning a test virtual machine using the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into SCVMM and browse the <span class="strong"><strong class="calibre9">VM template</strong></span> section under the <span class="strong"><strong class="calibre9">Library</strong></span> workspace.</li><li class="listitem" value="2">Right-click on the newly created VM template and select <span class="strong"><strong class="calibre9">Create Virtual Machine</strong></span>.<div class="mediaobject"><img src="../images/00073.jpeg" alt="Testing the VM template functionality" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Provide the VM name and description. It's good to use the same the VM name and hostname for any VM to ensure consistency and easy identification at each layer.</li><li class="listitem" value="4">Customize<a id="id512" class="calibre1"/> the hardware and guest OS profile if required.</li><li class="listitem" value="5">Select the newly <a id="id513" class="calibre1"/>created cloud or host group as the destination for VM.<div class="mediaobject"><img src="../images/00074.jpeg" alt="Testing the VM template functionality" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="6">Configure the operating system computer name and add custom properties such as server power on/off action.</li><li class="listitem" value="7">Review the selected values in the summary and click on <span class="strong"><strong class="calibre9">Create</strong></span> to start creating this virtual machine.</li><li class="listitem" value="8">Monitor the VM creation job for any errors; browse VMs and the service workspace in SCVMM management console post successful completion.</li><li class="listitem" value="9">Log into the<a id="id514" class="calibre1"/> newly created virtual machine and verify the expected results as per the <a id="id515" class="calibre1"/>configuration.</li></ol><div class="calibre27"/></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="The VM Role architecture"><div class="book" id="1AT9A2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec38" class="calibre1"/>The VM Role architecture</h1></div></div></div><p class="calibre8">VM Role in Windows<a id="id516" class="calibre1"/> Azure Pack adds greater flexibilities and self-service capabilities in IaaS offerings. VM Role is not just about providing virtual machines for tenant's workload, it takes IaaS services to another level by offering automated applications deployment in VM in a self-service manner.</p><p class="calibre8">VM Role packages are <a id="id517" class="calibre1"/>developed in JSON and provide resources or values, which are used to provision virtual machines and applications. <span class="strong"><strong class="calibre9">JSON</strong></span> (<span class="strong"><strong class="calibre9">JavaScript Object Notation</strong></span>) is a lightweight format used for data interchanging.</p><p class="calibre8">JSON files<a id="id518" class="calibre1"/> for a VM Role along with metadata such as logos, resources, and more make a VM Role package.</p><p class="calibre8">A VM Role is <a id="id519" class="calibre1"/>primarily made up of two components/packages as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Resource Definition package</li><li class="listitem">Resource Extension package</li></ul></div><p class="calibre8">Before diving into these packages, let's understand VM Role's working mechanism. In a traditional scenario without any self-service portal, VM creation requires some set of input as variables, such as hardware configuration (the number of CPUs, the amount of memory, and more) and network configurations (virtual switch ), which are provided by virtualization administrators during the VM creation process. Similar things happen in a cloud-based self-service scenario where some value, such as VM name, configuration, and so on, would be provided to tenants as per their needs and some will be preconfigured by the cloud administrator, such as the hypervisor host to use, or SCVMM cloud to leverage for deploying VM.</p><p class="calibre8">In Windows Azure Pack-based cloud solution, a tenant user will provide tenant-specific values in Windows Azure Pack tenant portal using a self-service wizard. These values need to be passed to SCVMM where it will add up the administrator specified values and start the creation of virtual machine. In a similar manner, application deployment on IaaS services will also have to get values from the tenant user and administrator to deploy applications.</p><p class="calibre8">All these operations have to be done in a self-service and automated manner.</p><p class="calibre8">VM Role packages or gallery resource packages that were mentioned previously facilitate the preceding functionalities.</p></div>

<div class="book" title="The VM Role architecture">
<div class="book" title="Resource definition packages"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec66" class="calibre1"/>Resource definition packages</h2></div></div></div><p class="calibre8">A resource definition<a id="id520" class="calibre1"/> package consists of VM configuration or values available to tenant users in a self-service wizard and their mapping with resourced resources in SCVMM, defined via a resource extension package. The definition of resource also contains a small package called <code class="email">View Definition</code>, which includes values and graphical images visible to tenant users. If applicable, view resource definition values are mapped to the resource extension, and they are passed to VMM for VM and application deployment. Resource definition packages are stored with the <code class="email">.resdefpkg</code> extension and gets imported in Windows Azure Pack.</p><p class="calibre8">Overall, the following files make up the resource definition package:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Resource Definition file</strong></span> <span class="strong"><strong class="calibre9">(RESDEF File)</strong></span>: It contains all parameters required by SCVMM—from VM Role to provisioning virtual machines and services</li><li class="listitem"><span class="strong"><strong class="calibre9">View Definition file</strong></span> <span class="strong"><strong class="calibre9">(VIEWDEF File)</strong></span>: It contains forms and icon mapping (Publisher icon/Resource icon) that are visible to tenant users while requesting IaaS resource using the VM Role gallery items</li><li class="listitem"><span class="strong"><strong class="calibre9">Icons</strong></span>: These icons are visible to tenant users in the list of gallery items</li><li class="listitem"><span class="strong"><strong class="calibre9">Localization files</strong></span>: These files are used to display the gallery item self-service deployment wizard with localized values</li></ul></div><p class="calibre8">Resource definition package includes conditions or parameters values, which must be met at SCVMM resource level to know which hard disk to use for OS or data . These values need to be configured on resources stored in SCVMM for VM Role usage. For example, a VM Role for Windows Server 2012 R2 VM is likely to have a condition configured that uses VHD available in SCVMM with the operating system family Windows Server 2012 and so on. Only compatible resources are available to tenant users to choose in the gallery resource deployment wizard.</p></div></div>

<div class="book" title="The VM Role architecture">
<div class="book" title="Resources extension packages"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec67" class="calibre1"/>Resources extension packages</h2></div></div></div><p class="calibre8">Resources extension packages are imported in System Center Virtual Machine Manager. Extension<a id="id521" class="calibre1"/> packages are used to provision the applications as a part of VM Role deployment. This is an optional component of VM Role and is used only while deploying VM Roles with automated applications provisioning. This can be compared to application profiles in VMM service templates. Resource extension leverages the SCVMM service template engine for executing application logic.</p><p class="calibre8">Parameters configured in resource extension packages are mapped to parameters in resource definition.</p><p class="calibre8">Along with resource extension packages, some VM<a id="id522" class="calibre1"/> Roles also contain <span class="strong"><strong class="calibre9">Application payload</strong></span>.</p><p class="calibre8">Application payload<a id="id523" class="calibre1"/> contains resources such as installation binaries or media and scripts and other prerequisites for application deployment. This is an optional component, and its necessity varies from application to application.</p></div></div>

<div class="book" title="The VM Role architecture">
<div class="book" title="Getting VM Role gallery resources"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec68" class="calibre1"/>Getting VM Role gallery resources</h2></div></div></div><p class="calibre8">Gallery resources <a id="id524" class="calibre1"/>consist of required packages such as resource definition packages, resource extension packages, and application payloads for any VM Role. Organizations or service providers choose the following ways to get gallery resources for<a id="id525" class="calibre1"/> their Cloud VM Role offerings:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Use Microsoft or third party provided gallery resources</strong></span>: The Microsoft web platform installer includes a wide range of ready-made gallery resources for various offering, such as Windows Server Virtual Machine, web servers, domain controllers, and more. These gallery items can be downloaded and customized as per specific environment-based requirements</li><li class="listitem"><span class="strong"><strong class="calibre9">Develop own custom gallery items</strong></span>: Organizations or service providers may also choose to develop their own gallery items in JSON. This gives the flexibility of offering almost everything in the Windows Azure Pack-based cloud solution.</li></ul></div></div></div>

<div class="book" title="The VM Role architecture">
<div class="book" title="Dealing with gallery items – available tools"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec69" class="calibre1"/>Dealing with gallery items – available tools</h2></div></div></div><p class="calibre8">While JSON files and<a id="id526" class="calibre1"/> packages look more of developer stuff instead of IT professional, there are certain tools available that can be leveraged by IT professionals or cloud providers to deal with gallery items without any development knowledge (at least language specific). Microsoft and third-party vendors provide the following tools for dealing with gallery items in Windows Azure Pack-based deployment:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">VM Role authoring tool</strong></span>: This tool can be used to create, view, and edit gallery item packages, such<a id="id527" class="calibre1"/> as resource definition package, resource extension package, and more. It can also be used to edit Microsoft or vendor provided gallery<a id="id528" class="calibre1"/> items for custom modifications. This tool is developed by CodePlex (<a class="calibre1" href="https://vmRoleauthor.codeplex.com/">https://vmRoleauthor.codeplex.com/</a>).</li><li class="listitem"><span class="strong"><strong class="calibre9">Gallery resource import tool</strong></span>: This tool simplifies the process of importing resource definition<a id="id529" class="calibre1"/> package into Windows Azure Pack, resource extension package into SCVMM, and sets the properties of resources such as hard disks. This tool is completely written in PowerShell.</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Building VM Role IaaS offerings using gallery resources"><div class="book" id="1BRPS2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec39" class="calibre1"/>Building VM Role IaaS offerings using gallery resources</h1></div></div></div><p class="calibre8">Microsoft and <a id="id530" class="calibre1"/>some third-party vendors have developed a wide range of standard gallery items for public usage. These <a id="id531" class="calibre1"/>gallery items can be downloaded and used by organizations or service providers for their cloud IaaS offerings. The beauty is that these can also be customized or modified to meet specific custom requirements.</p><p class="calibre8">The Microsoft Web Platform installer is used to download the Microsoft provided Windows Azure Pack gallery items.</p></div>

<div class="book" title="Building VM Role IaaS offerings using gallery resources">
<div class="book" title="Downloading gallery items using Microsoft Web PI"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec70" class="calibre1"/>Downloading gallery items using Microsoft Web PI</h2></div></div></div><p class="calibre8">Windows <a id="id532" class="calibre1"/>Azure Pack gallery items aren't available in the standard WEB PI downloads list; custom feeds have to be added. Let's have a look at the steps to download these resources:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into Windows Azure Pack or any other server with Internet connectivity.</li><li class="listitem" value="2">Launch<a id="id533" class="calibre1"/> <span class="strong"><strong class="calibre9">Microsoft Web Platform Installer</strong></span> (<a class="calibre1" href="https://www.microsoft.com/web/downloads/platform.aspx">https://www.microsoft.com/web/downloads/platform.aspx</a>).</li><li class="listitem" value="3">Click on the <span class="strong"><strong class="calibre9">Options</strong></span> link at the bottom of Web PI.</li><li class="listitem" value="4">Add <a class="calibre1" href="http://www.microsoft.com/web/webpi/partners/servicemodels.xml">http://www.microsoft.com/web/webpi/partners/servicemodels.xml</a> in <span class="strong"><strong class="calibre9">Custom Feeds</strong></span>.<div class="mediaobject"><img src="../images/00075.jpeg" alt="Downloading gallery items using Microsoft Web PI" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">The new<a id="id534" class="calibre1"/> <span class="strong"><strong class="calibre9">Service Models</strong></span> options will now be available in the Web PI.</li><li class="listitem" value="6">Browse<a id="id535" class="calibre1"/> through the <span class="strong"><strong class="calibre9">Server Model</strong></span> option and <span class="strong"><strong class="calibre9">Gallery Resource</strong></span>. Select <span class="strong"><strong class="calibre9">Add</strong></span> for gallery resources to be downloaded.</li><li class="listitem" value="7">Clicking on <span class="strong"><strong class="calibre9">Install</strong></span> will download these gallery resources on a local folder on a server where PI is running.<div class="mediaobject"><img src="../images/00076.jpeg" alt="Downloading gallery items using Microsoft Web PI" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Building VM Role IaaS offerings using gallery resources">
<div class="book" title="Preparing and importing gallery resources in Windows Azure Pack and SCVMM"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec71" class="calibre1"/>Preparing and importing gallery resources in Windows Azure Pack and SCVMM</h2></div></div></div><p class="calibre8">Each gallery<a id="id536" class="calibre1"/> resource downloaded from Web PI usually contains one<a id="id537" class="calibre1"/> or more packages from<a id="id538" class="calibre1"/> the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">One or more<a id="id539" class="calibre1"/> Resource Definition Packages</li><li class="listitem">Resource Extension Packages</li><li class="listitem">ReadMe file</li><li class="listitem">Any other application payload files</li></ul></div><p class="calibre8">The <code class="email">ReadMe</code> file in gallery resources files usually contains a description about VM Role, package details, other application payload details, and download link if applicable. The most important thing is that it contains instructions for preparing SCVMM resources to be used for provisioning VM and applications.</p><p class="calibre8">Importing a gallery item in Windows Azure Pack/SCVMM and making it usable usually consists of the following operations:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Download gallery resources and any application payload specified in the. <code class="email">ReadMe</code> file.</li><li class="listitem" value="2">Prepare operating system or data disks as specified in <code class="email">ReadMe</code>. The OS disk must be prepared with <code class="email">sysprep</code> and uploaded to the VMM library.</li><li class="listitem" value="3">Import Resource Extension Package in SCVMM.</li><li class="listitem" value="4">Prepare<a id="id540" class="calibre1"/> virtual hard disks (OS/data disks) properties as specified in <code class="email">ReadMe</code>.</li><li class="listitem" value="5">Import Resource Definition<a id="id541" class="calibre1"/> Packages in Windows Azure Pack.</li><li class="listitem" value="6">Perform any<a id="id542" class="calibre1"/> other additional tasks if required as per the <code class="email">ReadMe</code> file.</li><li class="listitem" value="7">Test the provisioning.</li></ol><div class="calibre27"/></div><div class="book" title="Importing resource extension packages in SCVMM"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch04lvl3sec25" class="calibre1"/>Importing resource extension packages in SCVMM</h3></div></div></div><p class="calibre8">Windows <a id="id543" class="calibre1"/>PowerShell cmdlet is used to import resource extension packages in SCVMM. There is no VMM or Windows Azure Pack GUI available to perform this function at this point of time.</p><p class="calibre8">The following PowerShell commands can be used to import this:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Launch Virtual Machine Manager PowerShell Module.</li><li class="listitem" value="2">Connect to the VMM server using admin privileges. The following PowerShell code can be used for connecting to the VMM server in a PowerShell session:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">Get-VMMServer</strong></span>
</pre></div></li><li class="listitem" value="3">Enter VMM FQDN on the computer name attribute value. This will connect to the VMM service using credentials logged into Windows.</li><li class="listitem" value="4">Execute the following PowerShell as per requirements to import the resource extension in VMM.<p class="calibre15">The following code will import the Resource Extension named <code class="email">SampleVMRole.resextpkg</code> stored at the <code class="email">SystemDrive\GalleryResources\Sample-VMRole-Pkg\MyVMRole.resextpkg</code> folder in the SCVMM library named<code class="email"> MSSCVMMLibrary</code>:</p><div class="informalexample"><pre class="programlisting">$libraryShare = Get-SCLibraryShare | Where-Object {$_.Name -eq <span class="strong"><strong class="calibre9">'MSSCVMMLibrary'</strong></span>}
$resextpkg = $Env<span class="strong"><strong class="calibre9">:SystemDrive + "\GalleryResources\Sample-VMRole-Pkg\SampleVMRole.resextpkg</strong></span>"
Import-CloudResourceExtension –ResourceExtensionPath $resextpkg -SharePath $libraryShare –AllowUnencryptedTransfer</pre></div></li><li class="listitem" value="5">Verify successful import by checking resource extension imported status using the following PowerShell command:<div class="informalexample"><pre class="programlisting">Get-CloudResourceExtension</pre></div></li><li class="listitem" value="6">The results<a id="id544" class="calibre1"/> will display all the Resource Extension imported in SCVMM.</li></ol><div class="calibre27"/></div></div><div class="book" title="Configuring virtual hard disks properties for VM Role"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch04lvl3sec26" class="calibre1"/>Configuring virtual hard disks properties for VM Role</h3></div></div></div><p class="calibre8">Each VM Role gallery<a id="id545" class="calibre1"/> resource requires at least one OS virtual disk for VM deployment, and optionally, it requires one or more additional data disks. Since VMM usually contains lots of virtual hard disks, VHD properties such as OS name, OS family name and release, and tags are used to identify disks<a id="id546" class="calibre1"/> compatible with a specific VM Role.</p><p class="calibre8">Each gallery resource has its own specific values for the previously mentioned parameters, which are defined in the <code class="email">ReadMe</code> file. These parameters need to be configured manually on virtual hard disks prepared for the given VMM Role. All the compatible virtual hard disks, as per required parameters, are made available to tenant users' self-service portal while requesting for resources.</p><p class="calibre8">For example, the following attributes are required to be configured to the virtual hard disks that are available for a given gallery resource, which provisions VMs for Windows Server 2012 operating systems:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22"><span><strong class="calibre29">Configuration</strong></span></p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Install the following software:</p>
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Windows Server 2012</li></ul></div>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22"><span><strong class="calibre29">The Operating System property</strong></span></p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Use one of the<a id="id547" class="indexterm"/> following:</p>
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">64-bit edition of Windows Server 2012 Datacenter</li><li class="listitem1">64-bit edition of Windows Server 2012 Standard</li><li class="listitem1">64-bit edition of Windows Server 2012 Essentials</li><li class="listitem1">Windows Server 2012 R2 Datacenter Preview</li><li class="listitem1">Windows Server 2012 R2 Standard Preview</li><li class="listitem1">Windows Server 2012 R2 Essentials Preview</li></ul></div>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22"><span><strong class="calibre29">The Familyname property</strong></span></p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Consider the<a id="id548" class="indexterm"/> following values for a familyname:</p>
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Windows Server 2012 Datacenter</li><li class="listitem1">Windows Server 2012 Standard</li><li class="listitem1">Windows Server 2012 Essentials</li><li class="listitem1">Windows Server 2012 R2 Datacenter Preview</li><li class="listitem1">Windows Server 2012 R2 Standard Preview</li><li class="listitem1">Windows Server 2012 R2 Essentials Preview</li></ul></div>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22"><span><strong class="calibre29">Tags</strong></span></p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Add all of the<a id="id549" class="indexterm"/> following tags:</p>
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Windows Server 2012</li><li class="listitem1">Windows Server 2012 R2</li></ul></div>
</td></tr></tbody></table></div><p class="calibre8">These parameters <a id="id550" class="calibre1"/>can be configured using VMM GUI or VMM PowerShell. Tags parameter can only be configured using VMM PowerShell.</p><div class="book" title="Configuring the operating system property"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch04lvl4sec05" class="calibre1"/>Configuring the operating system property</h4></div></div></div><p class="calibre8">The operating<a id="id551" class="calibre1"/> system property specifies the operating system installed inside the virtual hard disk. This can be configured using the VMM management console or PowerShell.</p><p class="calibre8">In the following sample PowerShell, values can be replaced as per the gallery resource specific <code class="email">Readme</code> file values:</p><div class="informalexample"><pre class="programlisting">$myVHD = Get-SCVirtualHardDisk | where {$_.Name –eq <span class="strong"><strong class="calibre9">'2012R2BASE.vhd'</strong></span>}
$WS2012Datacenter = Get-SCOperatingSystem | where { $_.name –eq <span class="strong"><strong class="calibre9">'Windows Server 2012 R2 Datacenter Preview'</strong></span> }
Set-scvirtualharddisk –virtualharddisk $myVHD –OperatingSystem $WS2012Datacenter</pre></div><p class="calibre8">For data disks, the operating system property must be set to <span class="strong"><em class="calibre12">None</em></span>.</p></div><div class="book" title="Configuring family name and release property"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch04lvl4sec06" class="calibre1"/>Configuring family name and release property</h4></div></div></div><p class="calibre8">The <code class="email">familyName</code> and <code class="email">release</code> properties are the configuration behind virtual disk availability in the<a id="id552" class="calibre1"/> tenant self-service provisioning wizard. All virtual disks having <code class="email">familyName</code> and <code class="email">release</code> properties <a id="id553" class="calibre1"/>configured, as per gallery resources requirements, are visible to a tenant user for usage.</p><p class="calibre8">The <code class="email">familyName</code> usually contains OS version and VM Role specific values, such as webserver, domain controller, and so on. The <code class="email">release</code> property usually controls multiple versions of virtual hard disks and is usually mentioned as 1.0.0.0, 1.0.0.1, 1.1.0.0 and more.</p><p class="calibre8">The <code class="email">familyName</code> and <code class="email">release</code> properties can be configured using the VMM administrator console or PowerShell. See the following sample PowerShell for configuring the <code class="email">familyName</code> and <code class="email">release</code> properties for virtual hard disks. The values can be replaced <a id="id554" class="calibre1"/>as per requirements provided in the gallery resource <code class="email">Readme</code> file:</p><div class="informalexample"><pre class="programlisting">$myVHD = Get-SCVirtualHardDisk | where {$_.Name –eq <span class="strong"><strong class="calibre9">'2012R2BASE.vhd'</strong></span>}
$familyName = "<span class="strong"><strong class="calibre9">Windows Server 2012 R2 DataCenter Preview</strong></span>"
$release = "<span class="strong"><strong class="calibre9">1.0.0.0</strong></span>"
Set-scvirtualharddisk –virtualharddisk $myVHD –FamilyName $familyName –Release $release</pre></div><p class="calibre8">Data disks may have values, such as SQL DB disk, larger disks, smaller disks, and so on.</p></div><div class="book" title="Configuring the tags property"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch04lvl4sec07" class="calibre1"/>Configuring the tags property</h4></div></div></div><p class="calibre8">The <code class="email">tags</code> property<a id="id555" class="calibre1"/> must be configured properly as per gallery resource requirements to make it available for provisioning. While it is a must for operating systems disks to have <code class="email">tags</code> configured, data disks may or may not have <code class="email">tags</code> specific requirement. Tags may be words defining Roles or features that VM Roles provides.</p><p class="calibre8">Tags can be configured only using VMM PowerShell. There is no VMM GUI option available at this point of time for configuring <code class="email">tags</code> on virtual hard disks.</p><p class="calibre8">See the following sample PowerShell for configuring the <code class="email">tags</code> property for virtual hard disks. Values can be replaced as per requirements provided in the gallery resource <code class="email">Readme</code> file:</p><div class="informalexample"><pre class="programlisting">$myVHD = Get-SCVirtualHardDisk | where {$_.Name –eq <span class="strong"><strong class="calibre9">'2012R2BASE.vhd'</strong></span>}
$tags = $myVHD.Tag
if ( $tags -cnotcontains "<span class="strong"><strong class="calibre9">WindowsServer2012R1</strong></span>" ) { $tags += @(" <span class="strong"><strong class="calibre9">WindowsServer2012</strong></span>") }
Set-scvirtualharddisk –virtualharddisk $myVHD –Tag $tags</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note26" class="calibre1"/>Note</h3><p class="calibre8">PowerShell for configuring virtual disk properties must be executed on VMM PowerShell or Windows PowerShell, loaded with VMM modules, connected with the SCVMM instance.</p></div></div></div><div class="book" title="Importing the Resource Definition package in Windows Azure Pack"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch04lvl3sec27" class="calibre1"/>Importing the Resource Definition package in Windows Azure Pack</h3></div></div></div><p class="calibre8">The Windows Azure<a id="id556" class="calibre1"/> Pack management or administrator portal or Windows Azure Pack PowerShell can be used to import gallery Resource Definition package in Windows Azure Pack.</p><p class="calibre8">The following are the steps for importing gallery resource definition package in Windows Azure Pack:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the Windows Azure Pack management portal for administrators.</li><li class="listitem" value="2">Navigate to the <span class="strong"><strong class="calibre9">vm clouds</strong></span> workspace.</li><li class="listitem" value="3">Click on the <span class="strong"><strong class="calibre9">GALLERY</strong></span> tab.</li><li class="listitem" value="4">Click the <span class="strong"><strong class="calibre9">IMPORT</strong></span> button from the tasks pane.<div class="mediaobject"><img src="../images/00077.jpeg" alt="Importing the Resource Definition package in Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Select the<a id="id557" class="calibre1"/> resource definition file (<code class="email">RESDEFPKG</code>) to be imported.</li><li class="listitem" value="6">Items will be listed in the gallery upon successful import.<div class="mediaobject"><img src="../images/00078.jpeg" alt="Importing the Resource Definition package in Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div><p class="calibre8">Imported gallery items can now be tested for deployment using Windows Azure Pack tenant portal. This will be covered in detail in the next chapter.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using GRIT (Gallery Resource Import) tool"><div class="book" id="1CQAE2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec40" class="calibre1"/>Using GRIT (Gallery Resource Import) tool</h1></div></div></div><p class="calibre8">GRIT, also<a id="id558" class="calibre1"/> known as Gallery Resource Import tool, is a Microsoft provided tool written in PowerShell. It can be used to ease the gallery resource downloading and installing process covered in the previous topic. The GRIT tool provides a graphical user interface for the lifecycle of gallery resource installation or import.</p><p class="calibre8">It is recommended to use the GRIT tool while dealing with gallery resources for ease administrator and to avoid any human errors in PowerShell scripts.</p></div>

<div class="book" title="Using GRIT (Gallery Resource Import) tool">
<div class="book" title="GRIT functionalities"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec72" class="calibre1"/>GRIT functionalities</h2></div></div></div><p class="calibre8">GRIT provides<a id="id559" class="calibre1"/> the following capabilities in an easy-to-use graphical user interface:</p><div class="book"><ul class="itemizedlist"><li class="listitem">It can be used with both Microsoft provided gallery resources as well as custom developed resources</li><li class="listitem">It can download gallery resources directly from Microsoft (no need for a web PI)</li><li class="listitem">Importing of Resource Extension files</li><li class="listitem">Importing of Resource Definition files</li><li class="listitem">It can compare and configure virtual disk properties (for both OS and data disks) required for gallery resource with disks available in the VMM library</li><li class="listitem">It makes gallery items private and public (this is discussed in detail in the next chapter)</li><li class="listitem">Removal of Resource Definition or Extension files</li></ul></div></div></div>

<div class="book" title="Using GRIT (Gallery Resource Import) tool">
<div class="book" title="Using GRIT for dealing with gallery resource"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec73" class="calibre1"/>Using GRIT for dealing with gallery resource</h2></div></div></div><p class="calibre8">The latest version of the GRIT tool is 1.2, which can be download from <a class="calibre1" href="https://gallery.technet.microsoft.com/Gallery-Resource-Import-2273ce71">https://gallery.technet.microsoft.com/Gallery-Resource-Import-2273ce71</a>. The GRIT tool <a id="id560" class="calibre1"/>needs to have access to SCVMM, SPF, and <a id="id561" class="calibre1"/>Windows Azure Pack; hence, the SPF server is the best place to run the tool.</p><p class="calibre8">We need to carry<a id="id562" class="calibre1"/> out the following steps to use GRIT:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Download the GRIT tool and log into Windows with an account having permission on SCVMM, SPF, and Windows Azure Pack.</li><li class="listitem" value="2">Execute the downloaded <code class="email">GalleryResourceImportTool.ps1</code> PowerShell script with elevated access.</li><li class="listitem" value="3">The PowerShell <a id="id563" class="calibre1"/>script execution will start with check parameters and prerequisites.</li><li class="listitem" value="4">It will launch a GUI console similar to the following, depending upon Internet access.<div class="mediaobject"><img src="../images/00079.jpeg" alt="Using GRIT for dealing with gallery resource" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Browse<a id="id564" class="calibre1"/> your local computer for gallery resource files or select any online available gallery resource to download and import the files.<div class="mediaobject"><img src="../images/00080.jpeg" alt="Using GRIT for dealing with gallery resource" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="6">Select the <span class="strong"><strong class="calibre9">Virtual Disks Configuration</strong></span> page to set VHD properties.</li><li class="listitem" value="7">Choose an<a id="id565" class="calibre1"/> operating system version from the drop-down list as applicable.</li><li class="listitem" value="8">Choosing<a id="id566" class="calibre1"/> the OS version will automatically display the available VHD and its status (matching with requirement specified in VM Role packages). Select VHD to use this particular gallery items, and hit <span class="strong"><strong class="calibre9">Apply These OS Disk Settings to Selected Disks(s) and Refresh List</strong></span> to apply OS disk parameters and <span class="strong"><strong class="calibre9">Apply These Data Disk Settings to Selected Disks(s) and Refresh List</strong></span> to apply data disk parameters. The refreshing list will display disks configured with status as green, which means configured.<div class="mediaobject"><img src="../images/00081.jpeg" alt="Using GRIT for dealing with gallery resource" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="9">Select the <a id="id567" class="calibre1"/><span class="strong"><strong class="calibre9">Gallery Resource Import</strong></span> page to import Resource Extension and Definition packages in SCVMM and Windows Azure Pack respectively.</li><li class="listitem" value="10">Choose <span class="strong"><strong class="calibre9">VMM Library </strong></span><a id="id568" class="calibre1"/><span class="strong"><strong class="calibre9">Share</strong></span> from the drop down list.</li><li class="listitem" value="11">Select <span class="strong"><strong class="calibre9">Import Resource Extension</strong></span>, <span class="strong"><strong class="calibre9">Import Resource Definition</strong></span>, or both as applicable.</li><li class="listitem" value="12">Select <span class="strong"><strong class="calibre9">Make Gallery Item Public</strong></span> if required (this is discussed in detail in the next chapter).</li><li class="listitem" value="13">Clicking on import will import the resource Extension and Definition packages in SCVMM and Windows Azure Pack respectively.<div class="mediaobject"><img src="../images/00082.jpeg" alt="Using GRIT for dealing with gallery resource" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="14">The <span class="strong"><strong class="calibre9">Bonus tools</strong></span> page can be used to access additional features such as removing<a id="id569" class="calibre1"/> extension and definition packages or making any definition package<a id="id570" class="calibre1"/> private.<div class="mediaobject"><img src="../images/00083.jpeg" alt="Using GRIT for dealing with gallery resource" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Developing VM Role gallery resource using VM Role Authoring tool"><div class="book" id="1DOR02-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec41" class="calibre1"/>Developing VM Role gallery resource using VM Role Authoring tool</h1></div></div></div><p class="calibre8">VM Role Authoring<a id="id571" class="calibre1"/> tool is published as an open source project on CodePlex. It provides an easy-to use-GUI for developing custom gallery resources for Windows Azure Pack VM Role.</p><p class="calibre8">With VM Role <a id="id572" class="calibre1"/>Authoring tool, the components of VM Role such as Resource Definition package and Resource Extension package can be developed from scratch, and it can also be used to modify the available gallery items at Microsoft for environmental specific requirements.</p><p class="calibre8">VM Role Authoring tool can be used for VM Roles developing and modifications operations, including:</p><div class="book"><ul class="itemizedlist"><li class="listitem">A Resource Definition package</li><li class="listitem">View<a id="id573" class="calibre1"/> Definition packages and localized resource files</li><li class="listitem">Resource Extension packages<a id="id574" class="calibre1"/> for Windows and Linux machines</li><li class="listitem">The mapping of parameters and values of Resource Definition to Resource Extension</li></ul></div></div>

<div class="book" title="Developing VM Role gallery resource using VM Role Authoring tool">
<div class="book" title="Getting the VM Role Authoring tool"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec74" class="calibre1"/>Getting the VM Role Authoring tool</h2></div></div></div><p class="calibre8">This tool is<a id="id575" class="calibre1"/> available on the CodePlex site. The latest, stable version available at the point of writing this book was 1.1.</p><p class="calibre8">Any supported Windows system can be used for developing VM Roles using this tool.</p><p class="calibre8">You can the download <a id="id576" class="calibre1"/>VM Role Authoring tool from <a class="calibre1" href="https://vmroleauthor.codeplex.com/">https://vmroleauthor.codeplex.com/</a>. Post downloading, the tool can be extracted to any location in the system.</p></div></div>

<div class="book" title="Developing VM Role gallery resource using VM Role Authoring tool">
<div class="book" title="Developing sample gallery resource – VM Role"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec75" class="calibre1"/>Developing sample gallery resource – VM Role</h2></div></div></div><p class="calibre8">VM Roles <a id="id577" class="calibre1"/>are written in JSON language. The VM Role Authoring tool adds a basic graphic user interface to it. Using VM Role Authoring tool, IT professionals can develop custom gallery resources without the knowledge of JSON (it's good to have it though).</p><p class="calibre8">The VM Role<a id="id578" class="calibre1"/> Authoring tool displays each configuration and bindings in two ways:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Editor View: This provide GUI.</li><li class="listitem">JSON View: This is the configuration view in the advanced JSON language. It can be modified for any deep custom modifications.</li></ul></div><p class="calibre8">Let's create a sample VM Role gallery resource for a Windows machine IaaS VM Role to learn more about using VM Role Authoring tool and developing custom VM Roles.</p><p class="calibre8">The following are the steps to create VM Role:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Execute <code class="email">VM Role Authoring Tool.exe</code>.<div class="mediaobject"><img src="../images/00084.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="2">Provide the<a id="id579" class="calibre1"/> package name and<a id="id580" class="calibre1"/> directory to store the gallery resources.<div class="mediaobject"><img src="../images/00085.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Provide gallery resources called <span class="strong"><strong class="calibre9">Version</strong></span> and <span class="strong"><strong class="calibre9">Publisher</strong></span>.<p class="calibre15">. </p><div class="mediaobject"><img src="../images/00086.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4"><span class="strong"><strong class="calibre9">Resource Requirements</strong></span> contains parameters that are required to be set on virtual hard<a id="id581" class="calibre1"/> disks to be used for provisioning of this VM Role. Enter parameters such as<a id="id582" class="calibre1"/> Tags.<div class="mediaobject"><img src="../images/00087.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Expand <span class="strong"><strong class="calibre9">Application Profile (Windows)</strong></span> and select <span class="strong"><strong class="calibre9">Roles &amp; Features</strong></span>. This option can be used to enable Windows Roles and features in VM Role post deployment in an automated fashion. Select the compatible OS and required Roles and features.<div class="mediaobject"><img src="../images/00088.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="6">Click on <span class="strong"><strong class="calibre9">Add</strong></span> <a id="id583" class="calibre1"/>and select <span class="strong"><strong class="calibre9">Web Application</strong></span> / <span class="strong"><strong class="calibre9">SQL DAC Application</strong></span> / <span class="strong"><strong class="calibre9">Script Application</strong></span> or anything else, as applicable for automated application installation. This<a id="id584" class="calibre1"/> feature enables cloud providers to deliver more than IaaS: automated web, applications, and database provisioning at the top of Vanilla IaaS services.<div class="mediaobject"><img src="../images/00089.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="7">Select <span class="strong"><strong class="calibre9">File</strong></span> and select the new <span class="strong"><strong class="calibre9">Resource Definition</strong></span> file. Provide the Resource <a id="id585" class="calibre1"/>Definition file<a id="id586" class="calibre1"/> name and location. Add <span class="strong"><strong class="calibre9">Version</strong></span> and <span class="strong"><strong class="calibre9">Publisher</strong></span> properties.<div class="mediaobject"><img src="../images/00090.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="8">In the <span class="strong"><strong class="calibre9">Extension Reference</strong></span> page, binding or mapping between Resource Definition and Resource Extension parameters is performed. Select the available Resource<a id="id587" class="calibre1"/> Extension package. It will populate <span class="strong"><strong class="calibre9">Name</strong></span> and <span class="strong"><strong class="calibre9">Publisher</strong></span> details and more<a id="id588" class="calibre1"/> automatically.<div class="mediaobject"><img src="../images/00091.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="9">In the <span class="strong"><strong class="calibre9">Parameters</strong></span> tab, add values to be provided by tenant users in self-service form.<div class="mediaobject"><img src="../images/00092.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="10">The <span class="strong"><strong class="calibre9">Scale Out</strong></span> configuration adds easy (by just moving a slider) scale in and scale out features<a id="id589" class="calibre1"/> for this VM Role. Minimum, initial, and maximum instance counts can be <a id="id590" class="calibre1"/>provided.<div class="mediaobject"><img src="../images/00093.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="11"><span class="strong"><strong class="calibre9">Hardware Profile</strong></span> provides options to tenant users with respect to the size of VM in terms of compute (CPU and memory). <span class="strong"><strong class="calibre9">Param.VMRoleVMSize</strong></span> provides<a id="id591" class="calibre1"/> standard Azure size available to tenant users, such as extra small, small, and <a id="id592" class="calibre1"/>so on.<div class="mediaobject"><img src="../images/00094.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="12">In <span class="strong"><strong class="calibre9">Storage Profile</strong></span>, cloud administrators can add additional VDHXs to VM Role such as data disks and DB disks as applicable. Parameters such as tags and others need to be defined for each disk added in VM Role.<div class="mediaobject"><img src="../images/00095.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="13"><span class="strong"><strong class="calibre9">Network Profile</strong></span> provides options to configure networking options for a VM Role such as NIC <a id="id593" class="calibre1"/>connectivity, load balancers, and more. Additional network adaptors can be used <a id="id594" class="calibre1"/>using the <span class="strong"><strong class="calibre9">Add</strong></span> button.<div class="mediaobject"><img src="../images/00096.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="14"><span class="strong"><strong class="calibre9">Operating System Profile</strong></span> provides OS options to configure such as local administrator password, machine to join domain, or workgroup. Tenant specific settings can be entered by user in a self-service wizard. Map values to the self-service wizard using generate new parameter in the drop-down list.<div class="mediaobject"><img src="../images/00097.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="15">In the <span class="strong"><strong class="calibre9">ViewDefinition</strong></span><a id="id595" class="calibre1"/> section, graphical icons such as <span class="strong"><strong class="calibre9">Label</strong></span>, <span class="strong"><strong class="calibre9">PublisherLabel</strong></span>, and <span class="strong"><strong class="calibre9">Description</strong></span><a id="id596" class="calibre1"/> that are available to tenant users in the gallery catalogue can be added.<div class="mediaobject"><img src="../images/00098.jpeg" alt="Developing sample gallery resource – VM Role" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="16">Click on <span class="strong"><strong class="calibre9">Validate</strong></span> to verify all configurations and mapping.</li><li class="listitem" value="17">Click on <span class="strong"><strong class="calibre9">Save</strong></span> to save packages and other components.</li></ol><div class="calibre27"/></div><p class="calibre8">These packages can <a id="id597" class="calibre1"/>now be imported to Windows Azure Pack and SCVMM respectively. See the previous topic to see how to import gallery resources.</p><p class="calibre8">With VM Role<a id="id598" class="calibre1"/> Authoring tool, JSON language scripting capabilities, and <span class="strong"><strong class="calibre9">Service Management Automation</strong></span> (<span class="strong"><strong class="calibre9">SMA</strong></span>), service providers may <a id="id599" class="calibre1"/>configure XaaS (anything as a service) cloud service offerings.</p></div></div>

<div class="book" title="Developing VM Role gallery resource using VM Role Authoring tool">
<div class="book" title="The virtual machine Role example kit"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec76" class="calibre1"/>The virtual machine Role example kit</h2></div></div></div><p class="calibre8">Microsoft<a id="id600" class="calibre1"/> provides a virtual machine Role example kit, which can be used as a reference for developing custom VM Role using VM Role Authoring tool.</p><p class="calibre8">The example kit contains example configurations of Resource Extension packages, Resource Definition packages, payload, custom scripts, and a lot more. This can help cloud providers in developing customer VM Role gallery resources.</p><p class="calibre8">The virtual machine<a id="id601" class="calibre1"/> Role example kit can be downloaded from <a class="calibre1" href="http://blogs.technet.com/b/privatecloud/archive/2013/12/11/virtual-machine-Role-example-kit.aspx">http://blogs.technet.com/b/privatecloud/archive/2013/12/11/virtual-machine-Role-example-kit.aspx</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Accessing tenant virtual machines &#x2013; Windows Azure Pack Console Connect"><div class="book" id="1ENBI2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec42" class="calibre1"/>Accessing tenant virtual machines – Windows Azure Pack Console Connect</h1></div></div></div><p class="calibre8">Windows Azure Pack<a id="id602" class="calibre1"/> provides two ways of connecting to virtual machine for tenants:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Remote desktop connection</li><li class="listitem">Windows Azure Pack Console Connect</li></ul></div><p class="calibre8">Remote desktop<a id="id603" class="calibre1"/> connection in a <a id="id604" class="calibre1"/>Windows Azure Pack Cloud works in the traditional RDP mechanism, requiring network connectivity to VM guest OS, RDP to be enabled, firewall rules to allow <a id="id605" class="calibre1"/>RDP communications, and lots more. If machines need to be accessed on Internet (service provider cloud scenarios), public IP would also be required.</p><p class="calibre8">The other option, Windows Azure Pack Console Connect, solves the challenges of RDP method. It provides access to VM guest OS through Hypervisor host using remote desktop gateways. Console Connect does not require any network reachability to the guest OS.</p><p class="calibre8">The Console Connect gives access to tenant users of their VM in similar way as of VM connect for Hyper-V manager over SSL using remote desktop gateway.</p><p class="calibre8">Console Connect doesn't have any dependency on the state of the operating system inside virtual machine (powered off, crashed, or something else). Since Console Connect works in a different way from RDP, few RDP features such as clipboard redirection, drives mapping, sound and printer redirection, and more aren't available.</p></div>

<div class="book" title="Accessing tenant virtual machines &#x2013; Windows Azure Pack Console Connect">
<div class="book" title="Windows Azure Pack Console Connect architecture"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec77" class="calibre1"/>Windows Azure Pack Console Connect architecture</h2></div></div></div><p class="calibre8">Windows <a id="id606" class="calibre1"/>Azure Pack Console Connect leverages the Remote Desktop Gateway services of Windows Server 2012 R2 for establishing Console Connect to VM via an underlying hypervisor on SSL.</p><p class="calibre8">Console Connect doesn't use any guest OS (inside VM) level authentication. It works upon SSL certificate token claim-based authentication. This requires Windows Azure Pack, SPF, remote desktop gateway server, VMM, and Hyper-V hosts to trust each other.</p><p class="calibre8">Windows Azure Pack along with the remote desktop gateway, SPF, and SCVMM authenticates users and authorizes access to virtual machine and generate token assigned to tenants for accessing this particular VM. This token is used by Hyper-V host to ensure that tenant users get access to only authorized virtual machine.</p><p class="calibre8">This process isn't visible to tenant users. When a tenant user connects to any VM using Console Connect on the Azure Pack portal, it downloads a RDM file containing all required connectivity details. Running this RDP file connects user to the VM's console.</p><div class="mediaobject"><img src="../images/00099.jpeg" alt="Windows Azure Pack Console Connect architecture" class="calibre10"/><div class="caption"><p class="calibre30">Diagram Source: TechNet</p></div></div><p class="calibre11"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note27" class="calibre1"/>Note</h3><p class="calibre8">All servers participating<a id="id607" class="calibre1"/> in the Console Connect architecture must run Windows Server 2012 R2.</p><p class="calibre8">Minimum RDP version for Console Connect at the client end is 8.1.</p></div></div></div>

<div class="book" title="Accessing tenant virtual machines &#x2013; Windows Azure Pack Console Connect">
<div class="book" title="Preparing certificates for Console Connect deployment"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec78" class="calibre1"/>Preparing certificates for Console Connect deployment</h2></div></div></div><p class="calibre8">A trust relationship needs to be configured between remote the Desktop Gateway Server, SPF, SCVMM, and Hyper-V hosts to support claim token-based authentication. Single or multiple SSL certificates can be used to establish this trust relationship.</p><p class="calibre8">The SSL certificate <a id="id608" class="calibre1"/>used for Console Connect must meet the following requirements:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The certificate must be valid, which is not expired</li><li class="listitem">The key usage field must contain a digital signature</li><li class="listitem">The enhanced key usage field must contain the following client authentication object identifier: (1.3.6.1.5.5.7.3.2)</li><li class="listitem">Root certificates for the <span class="strong"><strong class="calibre9">certification authority</strong></span> (<span class="strong"><strong class="calibre9">CA</strong></span>) that issued the certificate must be installed in the Trusted Root Certification Authorities certificate store</li><li class="listitem">The cryptographic service provider for the certificate must support SHA256</li></ul></div><p class="calibre8">SSL certificates can be self-signed as well as issued from any internal enterprise or public certificate authority. It is recommended to use CA provided SSL for better management and easy renewals.</p></div></div>

<div class="book" title="Accessing tenant virtual machines &#x2013; Windows Azure Pack Console Connect">
<div class="book" title="Deploying Console Connect"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec79" class="calibre1"/>Deploying Console Connect</h2></div></div></div><p class="calibre8">Deploying Windows<a id="id609" class="calibre1"/> Azure Pack Console Connect requires multiple operations to be performed, such as importing the Console Connect certificate, configuring RDS Gateway, and adding RDS Gateway in Windows Azure Pack.</p><div class="book" title="Importing trusted certificates (Console Connect) to management servers"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch04lvl3sec28" class="calibre1"/>Importing trusted certificates (Console Connect) to management servers</h3></div></div></div><p class="calibre8">Instead of importing a Console Connect certificate to each Hyper-V hosts individually, it can first be<a id="id610" class="calibre1"/> imported in the VMM database, and then be distributed to Hyper-V hosts. For this, the following steps are carried out:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Execute VMM PowerShell on as an administrator.</li><li class="listitem" value="2">Connect to the SCVMM server using the <code class="email">Set-SCVMMServer</code> PowerShell cmdlet.</li><li class="listitem" value="3">Use the following script to import the certificate in the VMM DB. Update highlighted values as per environmental specific details:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">PS C:\&gt; $mypwd = ConvertTo-SecureString "password" -AsPlainText -Force</strong></span>
<span class="strong"><strong class="calibre9">PS C:\&gt; $cert = Get-ChildItem .\RemoteConsoleConnect.pfx</strong></span>
<span class="strong"><strong class="calibre9">PS C:\&gt; $VMMServer = WAPCLOUD-SCVMM01.wapcloud.com</strong></span>
<span class="strong"><strong class="calibre9">PS C:\&gt; Set-SCVMMServer -VMConnectGatewayCertificatePassword $mypwd -   VMConnectGatewayCertificatePath $cert -VMConnectHostIdentificationMode FQDN -VMConnectHyperVCertificatePassword $mypwd -VMConnectHyperVCertificatePath $cert -VMConnectTimeToLiveInMinutes 2 -VMMServer $VMMServer</strong></span>
</pre></div></li><li class="listitem" value="4">Wait for all Hyper-V hosts to refresh in SCVMM, or manual refresh it by logging into the VMM management console.</li><li class="listitem" value="5">If you use a self-signed certificate, import the public key of the certificate to the trusted root certification authorities certificate store for the Hyper-V hosts. Restart the Hyper-V management service post import:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">Import-Certificate -CertStoreLocation cert:\LocalMachine\Root -Filepath "&lt;certificate path&gt;.cer"</strong></span>
</pre></div></li><li class="listitem" value="6">Import a certificate to the SPF server; here, PowerShell can be used:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9"> Import-PfxCertificate -CertStoreLocation Cert:LocalMachineMy -Filepath "&lt;certificate path&gt;.pfx"-Password &lt;Secure String&gt;</strong></span>
</pre></div></li><li class="listitem" value="7">Configure the service provider foundation to use this certificate to create claim tokens using the following PowerShell cmdlet. Replace thumbprint values as applicable:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">import-module spfadmin</strong></span>

<span class="strong"><strong class="calibre9">Set-SCSPFVmConnectGlobalSettings -AccessTokenLifetimeInMinutes 5 -CertificateThumbprint 4D92EF6B88AA2A76A1BA28834A42E599C917A9C2-HostIdentityType IPv4</strong></span>
</pre></div></li><li class="listitem" value="8">Define token<a id="id611" class="calibre1"/> lifetime in minutes from 1 to 60. Thumbprint value of SSL certificate can be found using the following PowerShell cmdlet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">$thumbprints = @(dir cert:localmachineMy | Where-Object { $_.subject -eq "CN=Remote Console Connect" } ).thumbprint</strong></span>
</pre></div></li></ol><div class="calibre27"/></div></div><div class="book" title="Setting up Remote Desktop Services Gateway"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch04lvl3sec29" class="calibre1"/>Setting up Remote Desktop Services Gateway</h3></div></div></div><p class="calibre8">To set up<a id="id612" class="calibre1"/> Remote Desktop Services Gateway, the following steps are carried out:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the VM designated for RDS Gateway Role.</li><li class="listitem" value="2">Install the Remote Desktop Gateway component using <span class="strong"><strong class="calibre9">Add Roles and Features</strong></span> in Server Manager.</li><li class="listitem" value="3">Install the Microsoft System Center Virtual Machine Manager Console Connect Gateway component on the Remote Desktop Gateway server. The MSI installer for SCVMM Console Connect Gateway can be found in the SCVMM installation media location <code class="email">CDLayout.EVAL\amd64\Setup\msi\RDGatewayFedAuth</code>.</li><li class="listitem" value="4">Import the public key of the certificate into the personal certificate store:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">Import-Certificate -CertStoreLocation cert:\LocalMachine\My -Filepath "&lt;certificate path&gt;.cer"</strong></span>
</pre></div></li><li class="listitem" value="5">Configure the RDS Gateway server to accept tokens using Console Connect SSL and hash algorithms.<p class="calibre15">This is configured using the <code class="email">TrustedIssuerCertificateHashes</code> and <code class="email">AllowedHashAlgorithms</code> properties in the <span class="strong"><strong class="calibre9">Windows Management Instrumentation</strong></span> (<span class="strong"><strong class="calibre9">WMI</strong></span>) <code class="email">FedAuthSettings</code> class. Use the following PowerShell to configure<a id="id613" class="calibre1"/> the RDS Gateway server:</p><p class="calibre15">Replace the server as thumbprint values with environment-specific values:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">$Server = "WAPMGT-RDSG.wapcloud.com"</strong></span>
<span class="strong"><strong class="calibre9">$Thumbprint = "4D92EF6B88AA2A76A1BA28834A42E599C917A9C2"</strong></span>
<span class="strong"><strong class="calibre9">$TSData = Get-WmiObject -computername $Server -NameSpace "root\TSGatewayFedAuth2" -Class "FedAuthSettings"</strong></span>
<span class="strong"><strong class="calibre9">$TSData.TrustedIssuerCertificates = $Thumbprint</strong></span>
<span class="strong"><strong class="calibre9">$TSData.Put()</strong></span>
</pre></div></li><li class="listitem" value="6">Configure the SSL certificate for RDS Gateway server. This certificate will be used to<a id="id614" class="calibre1"/> identify RDS server by clients. Use the RDS Gateway manager to create a self-signed SSL or use the existing trusted SSL.</li><li class="listitem" value="7">Verify the configuration at SCVMM, Hyper-V hosts, SPF, and RDS Gateway server.</li></ol><div class="calibre27"/></div></div></div></div>

<div class="book" title="Accessing tenant virtual machines &#x2013; Windows Azure Pack Console Connect">
<div class="book" title="Registering RDS Gateway server in Windows Azure Pack"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec80" class="calibre1"/>Registering RDS Gateway server in Windows Azure Pack</h2></div></div></div><p class="calibre8">Windows Azure Pack provides the option to register Remote Desktop Gateway server while registering the SCVMM stamp. The RDS Gateway server must be registered with mapping to the VMM server to function.</p><p class="calibre8">Any existing<a id="id615" class="calibre1"/> registered SCVMM connection can also be modified to add RDS Gateway at a later stage.</p><p class="calibre8">Let's see the following <a id="id616" class="calibre1"/>steps for registering RDS Gateway:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the Windows Azure Pack management portal and browse to the VM Clouds.</li><li class="listitem" value="2">Select an existing SCVMM registration and click on <span class="strong"><strong class="calibre9">Edit</strong></span>.</li><li class="listitem" value="3">Provide RDS Gateway FQDN and click on <span class="strong"><strong class="calibre9">Finish</strong></span> to complete the configuration.<div class="mediaobject"><img src="../images/00100.jpeg" alt="Registering RDS Gateway server in Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Accessing tenant virtual machines &#x2013; Windows Azure Pack Console Connect">
<div class="book" title="Securing the Console Connect deployment"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch04lvl2sec81" class="calibre1"/>Securing the Console Connect deployment</h2></div></div></div><p class="calibre8">Windows Azure Pack<a id="id617" class="calibre1"/> Console Connect uses SSL token-based claim authentication. It is recommended to consider the following security recommendations while deploying the Console Connect<a id="id618" class="calibre1"/> environment:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Token Lifetime: RDP File downloaded by the tenant user for accessing VM console contains the <code class="email">EndpointFedAuth</code> token to verify user's authenticity. It is recommended to configure token lifetime to small values such as 1 or 2 minutes to eliminate the security risk of losing or leaking this file.</li><li class="listitem">Configure strong firewall and security policies on the RDS Gateway server to protect it from malicious users or attacks. For example, it's a good idea to block the RDP (3389) port.</li><li class="listitem">Access to the certificate store on the SCVMM server generating token should be restricted.</li><li class="listitem">It is recommend to use a CA-provided certificate with a valid chain for the Hyper-V host. This will prevent the RDP connection warning related to the identification of the computer's identity.</li><li class="listitem">The RDP file downloaded by tenant user contains hostname/network details of Hyper-V server hosting that machine. This allows tenant users to see hypervisor host network details. It is recommended to secure Hyper-V hosts and prevent Internet access to avoid the misuse of these details.</li></ul></div></div></div>
<div class="book" title="Summary" id="1FLS41-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec43" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">With this chapter, we are ready with a Windows Azure Pack-based cloud solution having IaaS services ready for tenants. You learned about Windows Azure Pack VM Clouds architecture and steps for building SCVMM cloud for Windows Azure Pack. You learned about building IaaS offerings, also known as catalogues, for Windows and Linux operating systems. We also covered creating custom offerings using the VM Role authoring tool as well as using GRIT for easy import of gallery resources in Windows Azure Pack and SCVMM.</p><p class="calibre8">Accessing virtual machines using RDP and Console Connect along with Console Connect architecture and deployment was also covered.</p><p class="calibre8">In the next chapter, we will be assigning these services to tenants using Windows Azure Pack plans and subscriptions.</p></div></body></html>