<html><head></head><body>
<div id="_idContainer638" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-344"><a id="_idTextAnchor2025" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-345" class="calibre5"><a id="_idTextAnchor2026" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.2.1">Maintaining Your Zabbix Setup</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">Like any good piece of software, Zabbix needs to be maintained in order to keep working over the years. </span><span class="kobospan" id="kobo.3.2">A lot of users have been running their setups since the days of Zabbix 2.0. </span><span class="kobospan" id="kobo.3.3">It’s perfectly viable to do this if you bring the right knowledge of Zabbix to </span><span><span class="kobospan" id="kobo.4.1">the equation.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, we are going to see  how to do some of the most important parts of Zabbix maintenance to make sure you can keep your setup available and running smoothly. </span><span class="kobospan" id="kobo.5.2">We are going to cover creating maintenance periods, how to make backups, how to upgrade Zabbix and various Zabbix components, and how to do some </span><span><span class="kobospan" id="kobo.6.1">performance maintenance.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.7.1">We’ll cover these in the </span><span><span class="kobospan" id="kobo.8.1">following recipes:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.9.1">Setting Zabbix </span><span><span class="kobospan" id="kobo.10.1">maintenance periods</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.11.1">Backing up your </span><span><span class="kobospan" id="kobo.12.1">Zabbix setup</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.13.1">Upgrading the Zabbix backend from older PHP versions to PHP 8.2 </span><span><span class="kobospan" id="kobo.14.1">or higher</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.15.1">Upgrading a Zabbix database from older MariaDB versions to </span><span><span class="kobospan" id="kobo.16.1">MariaDB 10.11</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.17.1">Upgrading your </span><span><span class="kobospan" id="kobo.18.1">Zabbix setup</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.19.1">Maintaining Zabbix performance </span><span><span class="kobospan" id="kobo.20.1">over time</span></span></li>
</ul>
<h1 id="_idParaDest-346" class="calibre5"><a id="_idTextAnchor2027" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2028" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.21.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.22.1">We are going to need several important servers for these recipes. </span><span class="kobospan" id="kobo.22.2">First of all, we are going to need a running Zabbix 7 server for which to set up maintenance periods and do </span><span><span class="kobospan" id="kobo.23.1">performance tuning.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.24.1">For the upgrade part, we will need one of the </span><span><span class="kobospan" id="kobo.25.1">following servers:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.26.1">A Rocky Linux 8 server running Zabbix server 6, a PHP version before 8.2, and a MariaDB version </span><span><span class="kobospan" id="kobo.27.1">before 11.4</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.28.1">An Ubuntu 22.04 server running Zabbix server 6 a PHP version before 8.3, and a MariaDB version </span><span><span class="kobospan" id="kobo.29.1">before 11.4</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.30.1">I will call the upgrade server </span><strong class="source-inline"><span class="kobospan" id="kobo.31.1">lar-book-zbx6</span></strong><span class="kobospan" id="kobo.32.1">, which you can run with a distribution of </span><span><span class="kobospan" id="kobo.33.1">your choice.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.34.1">If you do not have any prior experience with Zabbix, this chapter may prove a good challenge, as we are going to go into the more advanced Zabbix processes </span><span><span class="kobospan" id="kobo.35.1">in depth.</span></span></p>
<h1 id="_idParaDest-347" class="calibre5"><a id="_idTextAnchor2029" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2030" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.36.1">Setting Zabbix maintenance periods</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.37.1">When we are </span><a id="_idTextAnchor2031" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.38.1">working on our Zabbix server or on other hosts, it’s super useful to set up maintenance periods in the Zabbix frontend. </span><span class="kobospan" id="kobo.38.2">With maintenance periods we can make sure that our Zabbix users don’t get alerts going off because of our maintenance. </span><span class="kobospan" id="kobo.38.3">One improvement you’ll find in</span><a id="_idIndexMarker873" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.39.1"> Zabbix 7 is the inclusion of near-instant maintenance periods. </span><span class="kobospan" id="kobo.39.2">As we no longer have to wait long for the config cache reload, Zabbix also altered the timer process to instantly enable a new </span><span><span class="kobospan" id="kobo.40.1">maintenance period.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.41.1">Let’s see how we can schedule maintenance periods in </span><span><span class="kobospan" id="kobo.42.1">this recipe.</span></span><a id="_idTextAnchor2032" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2033" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-348" class="calibre7"><a id="_idTextAnchor2034" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.43.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.44.1">All we are going to need in this recipe is our Zabbix server, for which I’ll use </span><strong class="source-inline"><span class="kobospan" id="kobo.45.1">lar-book-rocky</span></strong><span class="kobospan" id="kobo.46.1">. </span><span class="kobospan" id="kobo.46.2">The server will need at least some hosts and host groups to create maintenance periods for. </span><span class="kobospan" id="kobo.46.3">Furthermore, we’ll need to know how to navigate the </span><span><span class="kobospan" id="kobo.47.1">Zabbix frontend.</span></span><a id="_idTextAnchor2035" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2036" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-349" class="calibre7"><a id="_idTextAnchor2037" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.48.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.49.1">Let’s get started with this recipe by logging in to our frontend and navigating to </span><strong class="bold"><span class="kobospan" id="kobo.50.1">Data collection</span></strong><span class="kobospan" id="kobo.51.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.52.1">Maintenance</span></strong></span><span><span class="kobospan" id="kobo.53.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.54.1">We are going to click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.55.1">Create maintenance period</span></strong><span class="kobospan" id="kobo.56.1"> button in the </span><span><span class="kobospan" id="kobo.57.1">top-right corner.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.58.1">This will show us a popup, where we can set up our maintenance period. </span><span class="kobospan" id="kobo.58.2">Let’s start by defining the maintenance period parameters. </span><span class="kobospan" id="kobo.58.3">Fill in </span><span><span class="kobospan" id="kobo.59.1">the following:</span></span></li>
</ol>
<p class="calibre3"><a id="_idTextAnchor2038" class="pcalibre calibre6 pcalibre1"/></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer616">
<span class="kobospan" id="kobo.60.1"><img alt="Figure 11.1 – Zabbix Data collection | Maintenance, create maintenance window, Patch Tuesday" src="image/B19803_11_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.61.1">Figure 11.1 – Zabbix Data collection | Maintenance, create maintenance window, Patch Tuesday</span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.62.1">Now, at the </span><strong class="bold"><span class="kobospan" id="kobo.63.1">Periods</span></strong><span class="kobospan" id="kobo.64.1"> part, we’ll create a new maintenance period. </span><span class="kobospan" id="kobo.64.2">We need to click on the underlined </span><span><strong class="bold"><span class="kobospan" id="kobo.65.1">Add</span></strong></span><span><span class="kobospan" id="kobo.66.1"> text.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.67.1">This will</span><a id="_idTextAnchor2039" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.68.1"> bring us to </span><a id="_idIndexMarker874" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.69.1">another pop-up window where we can set the maintenance period. </span><span class="kobospan" id="kobo.69.2">We need to fill in the </span><span><span class="kobospan" id="kobo.70.1">following information:</span></span><a id="_idTextAnchor2040" class="pcalibre calibre6 pcalibre1"/></li>
</ol>
<p class="calibre3"> </p>
<div class="calibre2">
<div class="img---figure" id="_idContainer617">
<span class="kobospan" id="kobo.71.1"><img alt="Figure 11.2 – Zabbix Data collection | Maintenance, create maintenance period window, Patch Tuesday" src="image/B19803_11_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.72.1">Figure 11.2 – Zabbix Data collection | Maintenance, create maintenance period window, Patch Tuesday</span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.73.1">Now click the blue </span><strong class="bold"><span class="kobospan" id="kobo.74.1">Add</span></strong><span class="kobospan" id="kobo.75.1"> button to continue. </span><span class="kobospan" id="kobo.75.2">You should now see that our maintenance period is </span><span><span class="kobospan" id="kobo.76.1">filled in:</span></span></li>
</ol>
<p class="calibre3"><a id="_idTextAnchor2041" class="pcalibre calibre6 pcalibre1"/> </p>
<div class="calibre2">
<div class="img---figure" id="_idContainer618">
<span class="kobospan" id="kobo.77.1"><img alt="Figure 11.3 – Zabbix Configuration | Maintenance, create maintenance period page, Patch Tuesday" src="image/B19803_11_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.78.1">Figure 11.3 – Zabbix Configuration | Maintenance, create maintenance period page, Patch Tuesday</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.79.1">Now, next to the </span><strong class="bold"><span class="kobospan" id="kobo.80.1">Host groups </span></strong><span class="kobospan" id="kobo.81.1">field, click on the </span><strong class="bold"><span class="kobospan" id="kobo.82.1">Select</span></strong><span class="kobospan" id="kobo.83.1"> button and select the </span><strong class="bold"><span class="kobospan" id="kobo.84.1">Linux servers</span></strong><span class="kobospan" id="kobo.85.1"> host group. </span><span class="kobospan" id="kobo.85.2">Our </span><a id="_idTextAnchor2042" class="pcalibre calibre6 pcalibre1"/><a id="_idIndexMarker875" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.86.1">page should look </span><span><span class="kobospan" id="kobo.87.1">like this:</span></span></li>
</ol>
<p class="calibre3"><a id="_idTextAnchor2043" class="pcalibre calibre6 pcalibre1"/> </p>
<div class="calibre2">
<div class="img---figure" id="_idContainer619">
<span class="kobospan" id="kobo.88.1"><img alt="Figure 11.4 – Zabbix Configuration | Maintenance, add hosts to maintenance page, Patch Tuesday" src="image/B19803_11_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.89.1">Figure 11.4 – Zabbix Configuration | Maintenance, add hosts to maintenance page, Patch Tuesday</span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.90.1">You can still add a </span><strong class="bold"><span class="kobospan" id="kobo.91.1">Description</span></strong><span class="kobospan" id="kobo.92.1"> if </span><span><span class="kobospan" id="kobo.93.1">you’d like.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.94.1">Next, click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.95.1">Add</span></strong><span class="kobospan" id="kobo.96.1"> button at the bottom of the page to finish creating the maintenance period. </span><span class="kobospan" id="kobo.96.2">This will bring us back to our </span><strong class="bold"><span class="kobospan" id="kobo.97.1">Maintenance periods</span></strong><span class="kobospan" id="kobo.98.1"> page, where we should see that our maintenance window has </span><span><span class="kobospan" id="kobo.99.1">been created.</span></span></li>
</ol>
<h2 id="_idParaDest-350" class="calibre7"><span class="kobospan" id="kobo.100.1">H</span><a id="_idTextAnchor2044" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2045" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.101.1">ow it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.102.1">When configuring actions in Zabbix, we tell Zabbix to do a certain defined operation when a trigger is fired. </span><span class="kobospan" id="kobo.102.2">Maintenance periods (with data collection) work by suppressing these Zabbix operations for the time period defined in the maintenance period. </span><span class="kobospan" id="kobo.102.3">We do this to make sure that no Zabbix users are notified of any problems going on as maintenance is being done on a host. </span><span class="kobospan" id="kobo.102.4">Of course, it’s a good idea to only use this during the time that we are actually working on the hosts in question. </span><span class="kobospan" id="kobo.102.5">This only works if the </span><strong class="bold"><span class="kobospan" id="kobo.103.1">Pause operations for suppressed problems</span></strong><span class="kobospan" id="kobo.104.1"> checkbox is ticked on the </span><span><span class="kobospan" id="kobo.105.1">action, though.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.106.1">In the case of this recipe, we’ve </span><a id="_idIndexMarker876" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.107.1">created a recurring maintenance period (with data collection) for the entire year of 2023. </span><span class="kobospan" id="kobo.107.2">Let’s say the organization we’re working for has a lot of Linux hosts that need to be patched weekly. </span><span class="kobospan" id="kobo.107.3">We set up the maintenance period to recur weekly every Tuesday between 22:00 </span><span><span class="kobospan" id="kobo.108.1">and 04:00.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.109.1">Now keep in mind that after December 31, 2023, Zabbix will stop this maintenance period as it won’t be active any longer. </span><span class="kobospan" id="kobo.109.2">We have two time/date values to bear in mind when setting up scheduled maintenance. </span><span class="kobospan" id="kobo.109.3">The </span><strong class="bold"><span class="kobospan" id="kobo.110.1">Active since</span></strong><span class="kobospan" id="kobo.111.1">/</span><strong class="bold"><span class="kobospan" id="kobo.112.1">Active till</span></strong><span class="kobospan" id="kobo.113.1"> time/date value of the maintenance period and the </span><strong class="bold"><span class="kobospan" id="kobo.114.1">Periods</span></strong><span class="kobospan" id="kobo.115.1"> time/date value of the maintenance period. </span><span class="kobospan" id="kobo.115.2">This allows us to create more flexible periods, along with recurring ones as we </span><span><span class="kobospan" id="kobo.116.1">just did.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.117.1">Also, note that this maintenance period is </span><strong class="bold"><span class="kobospan" id="kobo.118.1">With data collection</span></strong><span class="kobospan" id="kobo.119.1">. </span><span class="kobospan" id="kobo.119.2">We can also create a maintenance period with the option of </span><strong class="bold"><span class="kobospan" id="kobo.120.1">No data collection</span></strong><span class="kobospan" id="kobo.121.1">. </span><span class="kobospan" id="kobo.121.2">When we use the </span><strong class="bold"><span class="kobospan" id="kobo.122.1">With data collection</span></strong><span class="kobospan" id="kobo.123.1"> option, we will keep collecting data but won’t send any alerts to Zabbix Users. </span><span class="kobospan" id="kobo.123.2">If you want to stop collecting the data, simply select the </span><strong class="bold"><span class="kobospan" id="kobo.124.1">No data collection</span></strong><span class="kobospan" id="kobo.125.1"> option. </span><span class="kobospan" id="kobo.125.2">Keep in mind, no data collection also means your triggers won’t fire anymore, nor will they resolve. </span><span class="kobospan" id="kobo.125.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.126.1">nodata</span></strong><span class="kobospan" id="kobo.127.1"> trigger function is also affected by maintenance and it won’t fire in </span><span><span class="kobospan" id="kobo.128.1">both situations.</span></span></p>
<h1 id="_idParaDest-351" class="calibre5"><a id="_idTextAnchor2046" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2047" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.129.1">Backing up your Zabbix setup</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.130.1">Before working on any </span><a id="_idTextAnchor2048" class="pcalibre calibre6 pcalibre1"/><a id="_idIndexMarker877" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.131.1">Zabbix setup, it is vital to make a backup of everything important. </span><span class="kobospan" id="kobo.131.2">In this recipe, we will go through some of the most important steps you should always take before doing maintenance on your </span><span><span class="kobospan" id="kobo.132.1">Zabbix setup.</span></span><a id="_idTextAnchor2049" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2050" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-352" class="calibre7"><a id="_idTextAnchor2051" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.133.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.134.1">We are going to need our Zabbix server, for which I’ll use </span><strong class="source-inline"><span class="kobospan" id="kobo.135.1">lar-book-rocky</span></strong><span class="kobospan" id="kobo.136.1">. </span><span class="kobospan" id="kobo.136.2">Make sure to get the CLI to the server ready, as this whole recipe will use the </span><span><span class="kobospan" id="kobo.137.1">Linux CLI.</span></span><a id="_idTextAnchor2052" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2053" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-353" class="calibre7"><a id="_idTextAnchor2054" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.138.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.139.1">Let’s start by logging in to our Zabbix server via the Linux CLI and create some new directories that </span><a id="_idIndexMarker878" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.140.1">we are going to use for our Zabbix backups. </span><span class="kobospan" id="kobo.140.2">Preferably, this directory would be on </span><span><span class="kobospan" id="kobo.141.1">another partition:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.142.1">mkdir /opt/zbx-backup/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.143.1">mkdir /opt/zbx-backup/database/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.144.1">mkdir /opt/zbx-backup/zbx-config/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.145.1">mkdir /opt/zbx-backup/nginx/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.146.1">mkdir /opt/zbx-backup/lib/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.147.1">mkdir /opt/zbx-backup/shared/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.148.1">mkdir /opt/zbx-backup/shared/zabbix/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.149.1">mkdir /opt/zbx-backup/shared/doc/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.150.1">It’s important to bac</span><a id="_idTextAnchor2055" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.151.1">k up all of our Zabbix configuration data, which is located at </span><strong class="source-inline1"><span class="kobospan" id="kobo.152.1">/etc/zabbix/</span></strong><span class="kobospan" id="kobo.153.1">. </span><span class="kobospan" id="kobo.153.2">We can manually copy the data from our current folder to our new backup folder by issuing the </span><span><span class="kobospan" id="kobo.154.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.155.1">cp -r /etc/zabbix/ /opt/zbx-backup/zbx-config/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.156.1">Now, let’s do the same for our </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.157.1">nginx</span></strong></span><span><span class="kobospan" id="kobo.158.1"> configuration:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.159.1">cp -r /etc/nginx/ /opt/zbx-backup/nginx/</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.160.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.161.1">Please note that if you are using Apache, your web configuration location might be different. </span><span class="kobospan" id="kobo.161.2">Adjust your command accordingly. </span><span class="kobospan" id="kobo.161.3">For Red Hat-based systems it’s usually </span><strong class="source-inline1"><span class="kobospan" id="kobo.162.1">/etc/httpd</span></strong><span class="kobospan" id="kobo.163.1"> and for Debian-based </span><span><span class="kobospan" id="kobo.164.1">systems, </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.165.1">/etc/apache2</span></strong></span><span><span class="kobospan" id="kobo.166.1">.</span></span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.167.1">It’s also important to keep our Zabbix PHP files and binaries backed up. </span><span class="kobospan" id="kobo.167.2">We can do that using the </span><span><span class="kobospan" id="kobo.168.1">following commands:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.169.1">cp -r /usr/share/zabbix/ /opt/zbx-backup/shared/zabbix/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.170.1">cp -r /usr/share/doc/zabbix-* /opt/zbx-backup/shared/doc/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.171.1">Lastly, let’s make sure to also back up the Zabbix files </span><span><span class="kobospan" id="kobo.172.1">in </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.173.1">/usr/lib</span></strong></span><span><span class="kobospan" id="kobo.174.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.175.1">cp -r /usr/lib/zabbix/ /opt/zbx-backup/lib/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.176.1">We could also create </span><a id="_idIndexMarker879" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.177.1">a cronjob to automatically compress and back up these files for us every day at </span><strong class="source-inline1"><span class="kobospan" id="kobo.178.1">00:00</span></strong><span class="kobospan" id="kobo.179.1">. </span><span class="kobospan" id="kobo.179.2">Simply issue the </span><span><span class="kobospan" id="kobo.180.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.181.1">crontab -e</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.182.1">And add t</span><a id="_idTextAnchor2056" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.183.1">he </span><span><span class="kobospan" id="kobo.184.1">following information:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.185.1">0 0 * * * tar -zcvf /opt/zbx-backup/zbx-config/zabbix.tar.gz /etc/zabbix/ &gt;/dev/null 2&gt;&amp;1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.186.1">0 0 * * * tar -zcvf /opt/zbx-backup/web-config/zabbix-web.tar.gz /etc/nginx/ &gt;/dev/null 2&gt;&amp;1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.187.1">0 0 * * * tar -zcvf /opt/zbx-backup/shared/zabbix/zabbix_usr_share.tar.gz /usr/share/zabbix/ &gt;/dev/null 2&gt;&amp;1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.188.1">0 0 * * * tar -zcvf /opt/zbx-backup/shared/doc/zabbix_usr_share_doc.tar.gz /usr/share/doc/ &gt;/dev/null 2&gt;&amp;1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.189.1">0 0 * * * tar -zcvf /opt/zbx-backup/lib /zabbix_usr_lib.tar.gz /usr/lib/zabbix/ &gt;/dev/null 2&gt;&amp;1</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.190.1">These are all of the most important files we need to back up from our Zabbix stack. </span><span class="kobospan" id="kobo.190.2">Let’s move on to our database. </span><span class="kobospan" id="kobo.190.3">We could now additionally use a rotation tool such as </span><strong class="source-inline1"><span class="kobospan" id="kobo.191.1">logrotate</span></strong><span class="kobospan" id="kobo.192.1"> to manage </span><span><span class="kobospan" id="kobo.193.1">our files.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.194.1">Backing up our database is quite easy. </span><span class="kobospan" id="kobo.194.2">We can simply use the built-in tools provided by MySQL and PostgreSQL. </span><span class="kobospan" id="kobo.194.3">Issue the following command for your respective database (make sure to fill in the right username, database name, </span><span><span class="kobospan" id="kobo.195.1">and password):</span></span><p class="calibre3"><span class="kobospan" id="kobo.196.1">For </span><span><span class="kobospan" id="kobo.197.1">MySQL databases:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.198.1">mysqldump --add-drop-table --add-locks --extended-insert --single-transaction --quick -u zabbixuser -p zabbixdb &gt; /opt/zbx-backup/database/backup_zabbixDB_&lt;DATE&gt;.sql</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.199.1">For </span><span><span class="kobospan" id="kobo.200.1">PostgreSQL databases:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.201.1">pg_dump zabbixdb &gt; /opt/zbx-backup/database/backup_ zabbixDB_&lt;DATE&gt;.bak</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.202.1">Make sure </span><a id="_idTextAnchor2057" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.203.1">to add the right location, as </span><a id="_idIndexMarker880" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.204.1">the database dump will be quite large if the database itself is large. </span><span class="kobospan" id="kobo.204.2">Preferably, dump to another disk/partition or even better, another machine. </span><span class="kobospan" id="kobo.204.3">As such, </span><strong class="source-inline1"><span class="kobospan" id="kobo.205.1">/opt/</span></strong><span class="kobospan" id="kobo.206.1"> might not be the </span><span><span class="kobospan" id="kobo.207.1">best location.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.208.1">We can also do this with a cronjob by issuing the </span><span><span class="kobospan" id="kobo.209.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.210.1">crontab -e</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.211.1">Then for MySQL, add the following line where </span><strong class="source-inline1"><span class="kobospan" id="kobo.212.1">-u</span></strong><span class="kobospan" id="kobo.213.1"> is the username, </span><strong class="source-inline1"><span class="kobospan" id="kobo.214.1">-p</span></strong><span class="kobospan" id="kobo.215.1"> is the password, and the database name is </span><strong class="source-inline1"><span class="kobospan" id="kobo.216.1">zabbix</span></strong><span class="kobospan" id="kobo.217.1">. </span><span class="kobospan" id="kobo.217.2">This is the command </span><span><span class="kobospan" id="kobo.218.1">for MySQL:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.219.1">55 22 * * 0 mysqldump -u'zabbixuser' -p'password' zabbixdb &gt; /opt/zbx-backup/database/backup_zabbixDB.sql</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.220.1">If you want to back up a PostgreSQL database with a cronjob, we will need to create a file in our user’s </span><span><span class="kobospan" id="kobo.221.1">home directory:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.222.1">vim ~/.pgpass</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.223.1">We add the following to this file, where </span><strong class="source-inline1"><span class="kobospan" id="kobo.224.1">zabbixuser</span></strong><span class="kobospan" id="kobo.225.1"> is the username and </span><strong class="source-inline1"><span class="kobospan" id="kobo.226.1">zabbixdb</span></strong><span class="kobospan" id="kobo.227.1"> is the </span><span><span class="kobospan" id="kobo.228.1">database name:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.229.1">#hostname:port:database:username:password</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.230.1">localhost:5432:zabbixdb:zabbixuser:password</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.231.1">Then we can add a cronjob for PostgreSQL </span><span><span class="kobospan" id="kobo.232.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.233.1">55 22 * * 0 pg_dump --no-password -U zabbixuser zabbixdb &gt;</span></strong> <strong class="bold1"><span class="kobospan1" id="kobo.234.1">/opt/zbx-backup/database/backup_zabbixDB_date.bak</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.235.1">We can also add a cronjob to </span><a id="_idIndexMarker881" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.236.1">only keep a certain number of days’ worth of backups. </span><span class="kobospan" id="kobo.236.2">Issue the </span><span><span class="kobospan" id="kobo.237.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.238.1">crontab -e</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.239.1">Then add the following line, where </span><strong class="source-inline1"><span class="kobospan" id="kobo.240.1">+60</span></strong><span class="kobospan" id="kobo.241.1"> is the number of days you want to keep </span><span><span class="kobospan" id="kobo.242.1">backups for:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.243.1">55 22 * * 0 find /opt/zbx-backup/database/ -mtime +60 -type f -delete</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.244.1">That conc</span><a id="_idTextAnchor2058" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.245.1">ludes our demonstration of backing up our Zabbix components the </span><span><span class="kobospan" id="kobo.246.1">easy way.</span></span></li>
</ol>
<p class="callout-heading"><span class="kobospan" id="kobo.247.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.248.1">For MySQL databases, there are also tools such as</span><a id="_idIndexMarker882" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.249.1"> ExtraBackup, and for Postgres we could use PGBarman. </span><span class="kobospan" id="kobo.249.2">It’s never a </span><a id="_idIndexMarker883" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.250.1">bad idea to look into tools such as these to create backups for your system, but the built-in examples provided here can prove to be just </span><span><span class="kobospan" id="kobo.251.1">as u</span><a id="_idTextAnchor2059" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2060" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.252.1">seful.</span></span></p>
<h2 id="_idParaDest-354" class="calibre7"><a id="_idTextAnchor2061" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.253.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.254.1">A Zabbix setup consists of several components. </span><span class="kobospan" id="kobo.254.2">We have the Zabbix frontend, Zabbix server, and Zabbix database. </span><span class="kobospan" id="kobo.254.3">These components in this setup require different pieces of software to run on, as shown in the </span><span><span class="kobospan" id="kobo.255.1">following dia</span><a id="_idTextAnchor2062" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.256.1">gram:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer620">
<span class="kobospan" id="kobo.257.1"><img alt="Figure 11.5 – Zabbix key components setup diagram" src="image/B19803_11_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.258.1">Figure 11.5 – Zabbix key components setup diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.259.1">Looking at the pre</span><a id="_idTextAnchor2063" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.260.1">ceding diagram, we can see that our Zabbix frontend runs on a web engine such as NGINX or Apache. </span><span class="kobospan" id="kobo.260.2">We</span><a id="_idIndexMarker884" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.261.1"> also need PHP to run our Zabbix web pages. </span><span class="kobospan" id="kobo.261.2">This means that we have to back up </span><span><span class="kobospan" id="kobo.262.1">two components:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.263.1">The web engine: NGINX, Apache, </span><span><span class="kobospan" id="kobo.264.1">or another</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.265.1">PHP</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.266.1">The Zabbix server is the application designed by</span><a id="_idIndexMarker885" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.267.1"> Zabbix, so we only need to back up one thing here: the </span><strong class="bold"><span class="kobospan" id="kobo.268.1">Zabbix server </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.269.1">config files</span></strong></span><span><span class="kobospan" id="kobo.270.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.271.1">Then last, but definitely not least, we need to make a backup of our database. </span><span class="kobospan" id="kobo.271.2">The most common databases used are MySQL and PostgreSQL, so we only need to do one thing for this: </span><strong class="bold"><span class="kobospan" id="kobo.272.1">create a dump of the </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.273.1">Zabbix da</span><a id="_idTextAnchor2064" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2065" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.274.1">tabase</span></strong></span><span><span class="kobospan" id="kobo.275.1">.</span></span></p>
<h2 id="_idParaDest-355" class="calibre7"><a id="_idTextAnchor2066" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.276.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.277.1">Backing up your Zabbix setup like this is one thing, but of course, it’s not everything. </span><span class="kobospan" id="kobo.277.2">Make sure you take the correct backups of your Linux system using snapshots and </span><span><span class="kobospan" id="kobo.278.1">other technologies.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.279.1">When you follow standard backup implementations, you should be prepared for any unforeseen circumstances with your </span><span><span class="kobospan" id="kobo.280.1">Zabbix</span><a id="_idTextAnchor2067" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2068" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.281.1"> setup.</span></span></p>
<h1 id="_idParaDest-356" class="calibre5"><a id="_idTextAnchor2069" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.282.1">Upgrading the Zabbix backend from older PHP versions to PHP 8.2 or higher</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.283.1">RHEL7, Ubuntu 20.04, and Debian 9 (Stretch) are no longer supported by Zabbix, thus our upgrade</span><a id="_idTextAnchor2070" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.284.1"> recipe no</span><a id="_idIndexMarker886" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.285.1"> longer includes any information about the upgrade path from PHP versions before 7.2 to version 8.2 or higher. </span><span class="kobospan" id="kobo.285.2">Newer Linux versions already ship with PHP8.0 or higher, which means that when we are upgrading a Zabbix setup from Zabbix version 6 to Zabbix 7, we can </span><span><span class="kobospan" id="kobo.286.1">upgrade immediately.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.287.1">The PHP requirement for Zabbix 7 is different than it was for Zabbix 6, meaning that if we are running PHP 7.2, we actually have a mandatory upgrade to do before we can run the latest Zabbix 7 release. </span><span class="kobospan" id="kobo.287.2">I also like to work in a </span><em class="italic"><span class="kobospan" id="kobo.288.1">future-proofing</span></em><span class="kobospan" id="kobo.289.1"> kind of way, so in this recipe, we will go over how to upgrade PHP 7.2 to 8.2 which is the latest supported version on RHEL8-based systems at the time </span><span><span class="kobospan" id="kobo.290.1">of </span><a id="_idTextAnchor2071" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2072" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.291.1">writing.</span></span></p>
<h2 id="_idParaDest-357" class="calibre7"><a id="_idTextAnchor2073" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.292.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.293.1">For this recipe, we will need our server installed with a RHEL8-based system, which will be running Zabbix server 6 with PHP </span><span><span class="kobospan" id="kobo.294.1">version 7.2.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.295.1">Another possibility is that you have a server running a Debian-based distribution such as Ubuntu 20.04, Debian 11, or a newer version of those Linux distributions. </span><span class="kobospan" id="kobo.295.2">These include PHP version 7.2 or higher </span><span><span class="kobospan" id="kobo.296.1">by default.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.297.1">I will refer to both possible servers as </span><strong class="source-inline"><span class="kobospan" id="kobo.298.1">lar-book-zbx6</span></strong><span class="kobospan" id="kobo.299.1"> throughout </span><span><span class="kobospan" id="kobo.300.1">this recipe.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.301.1">Lastly, make sure to take backups of your system and read the release notes for the new version </span><span><span class="kobospan" id="kobo.302.1">you’re ins</span><a id="_idTextAnchor2074" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2075" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.303.1">talling.</span></span></p>
<h2 id="_idParaDest-358" class="calibre7"><a id="_idTextAnchor2076" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.304.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.305.1">This recipe is split into two different</span><a id="_idIndexMarker887" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.306.1"> sections, one for RHEL8-based systems and another for Ubuntu systems. </span><span class="kobospan" id="kobo.306.2">We will start by going through the steps </span><span><span class="kobospan" id="kobo.307.1">for RHEL8.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.308.1">RHEL8-based systems</span></h3>
<p class="calibre3"><a id="_idTextAnchor2077" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.309.1">If you are already running PHP version 7.2 on a RHEL8-based system, the upgrade process is a bit simpler. </span><span class="kobospan" id="kobo.309.2">Let’s</span><a id="_idIndexMarker888" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.310.1"> check out how we can upgrade our </span><strong class="source-inline"><span class="kobospan" id="kobo.311.1">lar-book-zbx6</span></strong><span class="kobospan" id="kobo.312.1"> server in </span><span><span class="kobospan" id="kobo.313.1">this scenario:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.314.1">First, always verify </span><a id="_idIndexMarker889" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.315.1">what PHP version we are running with the </span><span><span class="kobospan" id="kobo.316.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.317.1">php-fpm --version</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.318.1">If the version is older than 8.2, we can continue with the next step. </span><span class="kobospan" id="kobo.318.2">We’ll execute </span><span><span class="kobospan" id="kobo.319.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.320.1">dnf module list php</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.321.1">This will show us something like the </span><span><span class="kobospan" id="kobo.322.1">following s</span><a id="_idTextAnchor2078" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.323.1">creenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer621">
<span class="kobospan" id="kobo.324.1"><img alt="Figure 11.6 – RHEL8 DNF module list for PHP" src="image/B19803_11_06.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.325.1">Figure 11.6 – RHEL8 DNF module list for PHP</span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.326.1">Unfortunately, on RHEL8, the latest stable PHP 8.3 version is not included in the DNF modules from AppStream. </span><span class="kobospan" id="kobo.326.2">This means we will have to find an alternative route for RHEL8-based systems. </span><span class="kobospan" id="kobo.326.3">If you want to install PHP 8.3 or higher, continue to </span><span><em class="italic"><span class="kobospan" id="kobo.327.1">step 9</span></em></span><span><span class="kobospan" id="kobo.328.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.329.1">Since PHP 8.2 is included in the AppStream list, reset your already available </span><span><span class="kobospan" id="kobo.330.1">PHP modules:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.331.1">dnf module reset php</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.332.1">Make sure to answer with </span><strong class="source-inline1"><span class="kobospan" id="kobo.333.1">Y</span></strong><span class="kobospan" id="kobo.334.1">. </span><span class="kobospan" id="kobo.334.2">Then we will enable the latest PHP version with the </span><span><span class="kobospan" id="kobo.335.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.336.1">dnf module enable php:8.2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.337.1">Answer with </span><strong class="source-inline1"><span class="kobospan" id="kobo.338.1">Y</span></strong><span class="kobospan" id="kobo.339.1"> again to enable PHP 8.2 and then we can upgrade our PHP version by using the </span><span><span class="kobospan" id="kobo.340.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.341.1">dnf update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.342.1">Answer </span><strong class="source-inline1"><span class="kobospan" id="kobo.343.1">Y</span><a id="_idTextAnchor2079" class="pcalibre calibre6 pcalibre1"/></strong><span class="kobospan" id="kobo.344.1"> again and your PHP version will now be running the latest PHP </span><span><span class="kobospan" id="kobo.345.1">8.2 version.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.346.1">If we cannot</span><a id="_idIndexMarker890" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.347.1"> use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.348.1">dnf module enable</span></strong><span class="kobospan" id="kobo.349.1"> method to reach the version you want to install, we are going to</span><a id="_idIndexMarker891" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.350.1"> have to rely on different means of getting PHP, the most popular route being the </span><span><span class="kobospan" id="kobo.351.1">REMI repositories.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.352.1">Make sure your system is up to date with the </span><span><span class="kobospan" id="kobo.353.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.354.1">dnf update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.355.1">REMI depends on the EPEL repository, so we will have to add </span><span><span class="kobospan" id="kobo.356.1">that first:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.357.1">dnf install epel-release</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.358.1">After installing </span><strong class="source-inline1"><span class="kobospan" id="kobo.359.1">epel-release</span></strong><span class="kobospan" id="kobo.360.1">, make sure to exclude Zabbix from it. </span><span class="kobospan" id="kobo.360.2">This ensures that Zabbix is only downloaded and updated from the official </span><span><span class="kobospan" id="kobo.361.1">Zabbix repositories:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.362.1">[epel]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.363.1">excludepkgs=zabbix*</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.364.1">.Then we install the REMI repository with the </span><span><span class="kobospan" id="kobo.365.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.366.1">sudo dnf -y install http://rpms.remirepo.net/enterprise/remi-release-8.rpm</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.367.1">Reset the PHP modules and enable the REMI PHP </span><span><span class="kobospan" id="kobo.368.1">8.3 version:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.369.1">dnf module reset php -y</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.370.1">dnf module install php:remi-8.3</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.371.1">Enter </span><strong class="source-inline1"><span class="kobospan" id="kobo.372.1">Y</span></strong><span class="kobospan" id="kobo.373.1"> or </span><strong class="source-inline1"><span class="kobospan" id="kobo.374.1">Yes</span></strong><span class="kobospan" id="kobo.375.1"> everywhere during the </span><span><span class="kobospan" id="kobo.376.1">installation procedure.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.377.1">Then, verify whether the upgrade </span><span><span class="kobospan" id="kobo.378.1">was successful:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.379.1">php-fpm -v</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.380.1">Make sure to restart NGINX (or Apache) </span><span><span class="kobospan" id="kobo.381.1">and </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.382.1">php-fpm</span></strong></span><span><span class="kobospan" id="kobo.383.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.384.1">systemctl restart nginx php-fpm</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.385.1">These steps have been tested on a Rocky Linux RHEL system, but they should work with any RHEL8-based system, be it in Stream or when it’s a full rebuild as with </span><span><span class="kobospan" id="kobo.386.1">Alma Linux.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.387.1">Consider upgrading to</span><a id="_idIndexMarker892" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.388.1"> RHEL9-based systems for</span><a id="_idIndexMarker893" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.389.1"> further support for newer versions of the </span><span><span class="kobospan" id="kobo.390.1">PHP packages.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.391.1">Ubuntu systems</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.392.1">Let’s upgrade to the latest version</span><a id="_idIndexMarker894" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.393.1"> of PHP available on our</span><a id="_idIndexMarker895" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.394.1">Ubuntu system:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.395.1">First, start by adding the PPA repository to our host with the </span><span><span class="kobospan" id="kobo.396.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.397.1">apt install software-properties-common</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.398.1">add-apt-repository ppa:ondrej/php</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.399.1">Now update the repositories with the </span><span><span class="kobospan" id="kobo.400.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.401.1">apt update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.402.1">On some installations, the key for the repository might not be available, in which case we might see an error reading </span><strong class="source-inline1"><span class="kobospan" id="kobo.403.1">Key is not available</span></strong><span class="kobospan" id="kobo.404.1">. </span><span class="kobospan" id="kobo.404.2">We can fix this with the following command, where </span><strong class="source-inline1"><span class="kobospan" id="kobo.405.1">PUB_KEY_HERE</span></strong><span class="kobospan" id="kobo.406.1"> is the key shown in </span><span><span class="kobospan" id="kobo.407.1">the error:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.408.1">apt-key adv --keyserver keyserver.ubuntu.com --recv- keys PUB_KEY_HERE</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.409.1">Now we can install PHP version 8.3 with the </span><span><span class="kobospan" id="kobo.410.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.411.1">apt install -y php8.3</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.412.1">apt upgrade -y php</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.413.1">apt autoremove</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.414.1">That’s it, the version of PHP should now be the one we want. </span><span class="kobospan" id="kobo.414.2">Check the version of PHP with the </span><span><span class="kobospan" id="kobo.415.1">following comman</span><a id="_idTextAnchor2080" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2081" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.416.1">d:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.417.1">php --version</span></strong></pre></li> </ol>
<h2 id="_idParaDest-359" class="calibre7"><span class="kobospan" id="kobo.418.1">How i</span><a id="_idTextAnchor2082" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.419.1">t works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.420.1">Because Zabbix 7 requires us to</span><a id="_idIndexMarker896" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.421.1"> install PHP version 8.0 or higher, we need to upgrade the PHP version if we are still using PHP 7.2 for our Zabbix 6</span><a id="_idIndexMarker897" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.422.1"> install. </span><span class="kobospan" id="kobo.422.2">It’s a different requirement than for Zabbix 6, making the upgrade process fairly long in some cases. </span><span class="kobospan" id="kobo.422.3">If you are still running RHEL7, Ubuntu 20.04, or Debian 9 (Stretch), then you will need to upgrade your Linux system first as well. </span><span class="kobospan" id="kobo.422.4">Zabbix has dropped support for these older Linux versions in favor of installation simplicity in terms of package management, security, </span><span><span class="kobospan" id="kobo.423.1">and support.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.424.1">Now, it is still possible to run Zabbix on older Linux versions by building from sources, but it is </span><span><span class="kobospan" id="kobo.425.1">not recommended.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.426.1">In this recipe, we did an upgrade from PHP 7.2 to PHP 8.2 or 8.3, which are some of the latest supported stable versions at the time of writing. </span><span class="kobospan" id="kobo.426.2">Doing this upgrade will not break our current Zabbix server installation. </span><span class="kobospan" id="kobo.426.3">As mentioned, this is a mandatory upgrade as PHP versions below 8.0 are too old to run Zabbix 7. </span><span class="kobospan" id="kobo.426.4">Even if the upgrade was optional, it is always good to consider running the latest stable release of software to make sure that we are ready for </span><span><span class="kobospan" id="kobo.427.1">the future.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.428.1">Now that we have upgraded PHP, we are ready to move on to upgrading the Zabbi</span><a id="_idTextAnchor2083" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2084" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.429.1">x </span><span><span class="kobospan" id="kobo.430.1">database engine.</span></span></p>
<h1 id="_idParaDest-360" class="calibre5"><a id="_idTextAnchor2085" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.431.1">Upgrading a Zabbix database from older MariaDB versions to Ma</span><a id="_idTextAnchor2086" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.432.1">riaDB 11.4</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.433.1">For our Zabbix 7 installation, we</span><a id="_idIndexMarker898" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.434.1"> are going to need MariaDB 10.5 or a newer supported version, so, it is a good idea to keep your database version up to date. </span><span class="kobospan" id="kobo.434.2">MariaDB regularly makes improvements to how it handles certain aspects </span><span><span class="kobospan" id="kobo.435.1">of performance.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.436.1">This recipe details how to upgrade MariaDB to the latest stable LTS version, which is MariaDB 11.4 at t</span><a id="_idTextAnchor2087" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2088" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.437.1">he time </span><span><span class="kobospan" id="kobo.438.1">of writing.</span></span></p>
<h2 id="_idParaDest-361" class="calibre7"><a id="_idTextAnchor2089" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.439.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.440.1">For this recipe, we will need our server which we called </span><strong class="source-inline"><span class="kobospan" id="kobo.441.1">lar-book-zbx6</span></strong><span class="kobospan" id="kobo.442.1">. </span><span class="kobospan" id="kobo.442.2">At this point, the server is running a </span><span><span class="kobospan" id="kobo.443.1">RHEL8-based distribution.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.444.1">Another option is to have a server running a Debian-based distribution such as Ubuntu 22.04, Debian 12, or a newer version of those Linux distributions. </span><span class="kobospan" id="kobo.444.2">We will be upgrading the MariaDB instance on this server to </span><span><span class="kobospan" id="kobo.445.1">version 11.4.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.446.1">If you’ve followed the </span><em class="italic"><span class="kobospan" id="kobo.447.1">Upgrading the Zabbix backend from older PHP versions to PHP 8.2 or higher</span></em><span class="kobospan" id="kobo.448.1"> recipe, your server will now be running PHP version 8.2 or higher. </span><span class="kobospan" id="kobo.448.2">If not, it’s a good idea to follow that </span><span><span class="kobospan" id="kobo.449.1">recip</span><a id="_idTextAnchor2090" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.450.1">e first.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.451.1">Also, make sure to take</span><a id="_idIndexMarker899" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.452.1"> backups of your system and read the release notes for the new version you’re installing. </span><span class="kobospan" id="kobo.452.2">We covered this in the </span><em class="italic"><span class="kobospan" id="kobo.453.1">Backing up your </span><a id="_idTextAnchor2091" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2092" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.454.1">Zabbix </span></em><span><em class="italic"><span class="kobospan" id="kobo.455.1">setup</span></em></span><span><span class="kobospan" id="kobo.456.1"> recipe.</span></span></p>
<h2 id="_idParaDest-362" class="calibre7"><a id="_idTextAnchor2093" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.457.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.458.1">First things first, let’s log in to our Linux host CLI to check out our versions. </span><span class="kobospan" id="kobo.458.2">Issue the </span><span><span class="kobospan" id="kobo.459.1">following commands:</span></span><p class="calibre3"><span class="kobospan" id="kobo.460.1">For </span><span><span class="kobospan" id="kobo.461.1">Zabbix server:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.462.1">zabbix_server --version</span></strong></pre><p class="calibre3"><span><span class="kobospan" id="kobo.463.1">For PHP:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.464.1">php-fpm --version</span></strong></pre><p class="calibre3"><span><span class="kobospan" id="kobo.465.1">For MariaDB:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.466.1">mysql --version</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.467.1">After verifying our versions match the versions mentioned in the </span><em class="italic"><span class="kobospan" id="kobo.468.1">Getting ready</span></em><span class="kobospan" id="kobo.469.1"> section of this recipe, let’s move on to upgrade our version </span><span><span class="kobospan" id="kobo.470.1">of MariaDB.</span></span></li>
</ol>
<h3 class="calibre8"><span class="kobospan" id="kobo.471.1">RHEL</span><a id="_idTextAnchor2094" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.472.1">-based systems</span></h3>
<ol class="calibre16">
<li value="1" class="calibre15"><span class="kobospan" id="kobo.473.1">On our RHEL-based </span><a id="_idIndexMarker900" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.474.1">server, the first thing we’ll do after </span><a id="_idIndexMarker901" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.475.1">checking the versions is to stop our </span><span><span class="kobospan" id="kobo.476.1">Zabbix environment:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.477.1">systemctl stop mariadb nginx zabbix-server</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.478.1">Now set up a repository file for MariaDB with the </span><span><span class="kobospan" id="kobo.479.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.480.1">vim /etc/yum.repos.d/mariadb.repo</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.481.1">We will add the following code to this new file. </span><span class="kobospan" id="kobo.481.2">Make sure to add the correct architecture after </span><strong class="source-inline1"><span class="kobospan" id="kobo.482.1">baseurl</span></strong><span class="kobospan" id="kobo.483.1"> if using </span><a id="_idIndexMarker902" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.484.1">anything other</span><a id="_idIndexMarker903" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.485.1">than </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.486.1">amd64</span></strong></span><span><span class="kobospan" id="kobo.487.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.488.1">[mariadb-main]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.489.1">name = MariaDB Server</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.490.1">baseurl = https://dlm.mariadb.com/repo/mariadb-server/11.4/yum/rhel/8/x86_64</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.491.1">gpgkey = file:///etc/pki/rpm-gpg/MariaDB-Server-GPG-KEY</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.492.1">gpgcheck = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.493.1">enabled = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.494.1">module_hotfixes = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.495.1">[mariadb-maxscale]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.496.1"># To use the latest stable release of MaxScale, use "latest" as the version</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.497.1"># To use the latest beta (or stable if no current beta) release of MaxScale, use "beta" as the version</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.498.1">name = MariaDB MaxScale</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.499.1">baseurl = https://dlm.mariadb.com/repo/maxscale/latest/yum/rhel/8/x86_64</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.500.1">gpgkey = file:///etc/pki/rpm-gpg/MariaDB-MaxScale-GPG-KEY</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.501.1">gpgcheck = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.502.1">enabled = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.503.1">[mariadb-tools]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.504.1">name = MariaDB Tools</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.505.1">baseurl = https://downloads.mariadb.com/Tools/rhel/8/x86_64</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.506.1">gpgkey = file:///etc/pki/rpm-gpg/MariaDB-Enterprise-GPG-KEY</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.507.1">gpgcheck = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.508.1">enabled = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.509.1">[mariadb-main]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.510.1">name = MariaDB Server</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.511.1">baseurl = https://dlm.mariadb.com/repo/mariadb-server/11.4/yum/rhel/8/x86_64</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.512.1">gpgkey = file:///etc/pki/rpm-gpg/MariaDB-Server-GPG-KEY</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.513.1">gpgcheck = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.514.1">enabled = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.515.1">module_hotfixes = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.516.1">[mariadb-maxscale]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.517.1"># To use the latest stable release of MaxScale, use "latest" as the version</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.518.1"># To use the latest beta (or stable if no current beta) release of MaxScale, use "beta" as the version</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.519.1">name = MariaDB MaxScale</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.520.1">baseurl = https://dlm.mariadb.com/repo/maxscale/latest/yum/rhel/8/x86_64</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.521.1">gpgkey = file:///etc/pki/rpm-gpg/MariaDB-MaxScale-GPG-KEY</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.522.1">gpgcheck = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.523.1">enabled = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.524.1">[mariadb-tools]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.525.1">name = MariaDB Tools</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.526.1">baseurl = https://downloads.mariadb.com/Tools/rhel/8/x86_64</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.527.1">gpgkey = file:///etc/pki/rpm-gpg/MariaDB-Enterprise-GPG-KEY</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.528.1">gpgcheck = 1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.529.1">enabled = 1</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.530.1">Alternatively and probably the</span><a id="_idIndexMarker904" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.531.1"> best method is to use</span><a id="_idIndexMarker905" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.532.1"> the MariaDB </span><span><span class="kobospan" id="kobo.533.1">setup script:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.534.1">curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash -s -- --mariadb-server-</span><a id="_idTextAnchor2095" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.535.1">version="mariadb-11.4"</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.536.1">Now upgrade your MariaDB server with the </span><span><span class="kobospan" id="kobo.537.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.538.1">dnf upgrade MariaDB*</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.539.1">Restart the MariaDB service with the </span><span><span class="kobospan" id="kobo.540.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.541.1">systemctl start mariadb zabbix-server nginx</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.542.1">That’s it, MariaDB should now be upgraded to the intended version. </span><span class="kobospan" id="kobo.542.2">Check the version again with the following </span><a id="_idIndexMarker906" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.543.1">command to</span><a id="_idIndexMarker907" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.544.1">make sure:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.545.1">mariad</span><a id="_idTextAnchor2096" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.546.1">b --version</span></strong></pre></li> </ol>
<h3 class="calibre8"><span class="kobospan" id="kobo.547.1">Ubuntu systems</span></h3>
<ol class="calibre16">
<li value="1" class="calibre15"><span class="kobospan" id="kobo.548.1">On our Ubuntu server, the</span><a id="_idIndexMarker908" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.549.1"> first thing we’ll </span><a id="_idIndexMarker909" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.550.1">do after checking the versions is to stop our Zabbix </span><span><span class="kobospan" id="kobo.551.1">server environment:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.552.1">systemctl stop mariadb zabbix-server nginx</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.553.1">Check for the MariaDB repository file at </span><strong class="source-inline1"><span class="kobospan" id="kobo.554.1">/etc/apt/sources.list.d/mariadb.list</span></strong><span class="kobospan" id="kobo.555.1">. </span><span class="kobospan" id="kobo.555.2">To check whether it is on version 11.4, edit it with the </span><span><span class="kobospan" id="kobo.556.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.557.1">vim /etc/apt/source</span><a id="_idTextAnchor2097" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.558.1">s.list.d/mariadb.list</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.559.1">The file should look like the following code block. </span><span class="kobospan" id="kobo.559.2">If it doesn’t look right, edit it to match. </span><span class="kobospan" id="kobo.559.3">Make sure to add the correct architecture on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.560.1">deb</span></strong><span class="kobospan" id="kobo.561.1"> lines if using anything other </span><span><span class="kobospan" id="kobo.562.1">than </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.563.1">amd64</span></strong></span><span><span class="kobospan" id="kobo.564.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.565.1"># MariaDB Server</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.566.1"># To use a different major version of the server, or to pin to a specific minor version, change URI below.</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.567.1">deb [arch=amd64,arm64] https://dlm.mariadb.com/repo/mariadb-server/11.4/repo/ubuntu jammy main</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.568.1">deb [arch=amd64,arm64] https://dlm.mariadb.com/repo/mariadb-server/11.4/repo/ubuntu jammy main/debug</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.569.1"># MariaDB MaxScale</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.570.1"># To use the latest stable release of MaxScale, use "latest" as the version</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.571.1"># To use the latest beta (or stable if no current beta) release of MaxScale, use "beta" as the version</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.572.1">deb [arch=amd64,arm64] https://dlm.mariadb.com/repo/maxscale/latest/apt jammy main</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.573.1"># MariaDB Tools</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.574.1">deb [arch=amd64] http://downloads.mariadb.com/Tools/ubuntu jammy main</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.575.1">Alternatively, we can</span><a id="_idIndexMarker910" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.576.1"> use the MariaDB</span><a id="_idIndexMarker911" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.577.1"> repository setup script to update to the right repository. </span><span class="kobospan" id="kobo.577.2">Execute the </span><span><span class="kobospan" id="kobo.578.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.579.1">curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash -s -- --mariadb-server-version="mariadb-11.4"</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.580.1">We need to remove our old MariaDB packages with the </span><span><span class="kobospan" id="kobo.581.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.582.1">apt remove mariadb-server mariadb-client</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.583.1">Now upgrade the MariaDB server version with the </span><span><span class="kobospan" id="kobo.584.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.585.1">apt install mariadb-server mariadb-client</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.586.1">Restart MariaDB with the </span><span><span class="kobospan" id="kobo.587.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.588.1">systemctl restart mariadb</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.589.1">Then issue the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.590.1">upgrade</span></strong></span><span><span class="kobospan" id="kobo.591.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.592.1">mariadb-upgrade</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.593.1">Now start Zabbix </span><span><span class="kobospan" id="kobo.594.1">back up:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.595.1">systemctl restart zabbix</span><a id="_idTextAnchor2098" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.596.1">-server nginx</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.597.1">That’s it, MariaDB should now be upgraded to the correct version. </span><span class="kobospan" id="kobo.597.2">Check the version again with </span><a id="_idIndexMarker912" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.598.1">the </span><span><span class="kobospan" id="kobo.599.1">fol</span><a id="_idTextAnchor2099" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2100" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.600.1">lowing command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.601.1">mariadb --ve</span><a id="_idTextAnchor2101" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.602.1">rsion</span></strong></pre></li> </ol>
<h2 id="_idParaDest-363" class="calibre7"><a id="_idTextAnchor2102" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.603.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.604.1">Now, while it might </span><a id="_idIndexMarker913" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.605.1">not always be a requirement, it is a smart idea to upgrade your database version regularly. </span><span class="kobospan" id="kobo.605.2">New versions of your database engine might include improvements to stability and performance, both of which could improve your Zabbix </span><span><span class="kobospan" id="kobo.606.1">server greatly.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.607.1">Do keep the release notes and bug reports on your radar though. </span><span class="kobospan" id="kobo.607.2">MariaDB 11.4 is, at the time of writing, the newest LTS version on the market. </span><span class="kobospan" id="kobo.607.3">You might want to stay behind one or two releases as these are still supported and have been running in production for a while already. </span><span class="kobospan" id="kobo.607.4">After all, nobody likes unforeseen issues such </span><span><span class="kobospan" id="kobo.608.1">as bugs.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.609.1">For Zabbix 7, we do need to install at least MariaDB 10.5 or a newer supported ver</span><a id="_idTextAnchor2103" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2104" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.610.1">sion though, so keep that </span><span><span class="kobospan" id="kobo.611.1">in mind.</span></span></p>
<h2 id="_idParaDest-364" class="calibre7"><a id="_idTextAnchor2105" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.612.1">There’s more...</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.613.1">If you really cannot upgrade to MariaDB version 10.5 or, if you are running another database, the supported version for that one, then there’s a new Zabbix feature. </span><span class="kobospan" id="kobo.613.2">Zabbix 7 allows us to run unsupported database versions. </span><span class="kobospan" id="kobo.613.3">When we edit the Zabbix server configuration files at </span><strong class="source-inline"><span class="kobospan" id="kobo.614.1">/etc/zabbix/zabbix_server.conf</span></strong><span class="kobospan" id="kobo.615.1">, we can add the </span><span><span class="kobospan" id="kobo.616.1">following parameter:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.617.1">
AllowUnsupportedDBVersions=1</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.618.1">This will allow you to run an older or newer version of your database that is not officially tested and supported by Zabbix yet, but keep in mind that it is not recommend</span><a id="_idTextAnchor2106" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.619.1">ed to do so. </span><span class="kobospan" id="kobo.619.2">Check out the current Zabbix LTS installation </span><span><span class="kobospan" id="kobo.620.1">requirements here:</span></span></p>
<p class="calibre3"><a href="https://www.zabbix.com/documentation/current/en/manual/installation/requirements" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.621.1">https://www.zabbix.com/documentation/current/e</span><span id="_idTextAnchor2107"/><span id="_idTextAnchor2108"/><span class="kobospan" id="kobo.622.1">n/manual/installation/requirements</span></span></a></p>
<h1 id="_idParaDest-365" class="calibre5"><span class="kobospan" id="kobo.623.1">Upgrad</span><a id="_idTextAnchor2109" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.624.1">ing your Zabbix setup</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.625.1">As we’ve seen throughout the book</span><a id="_idIndexMarker914" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.626.1"> already, Zabbix 7 offers a great d</span><a id="_idTextAnchor2110" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.627.1">eal</span><a id="_idTextAnchor2111" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.628.1"> of cool new features. </span><span class="kobospan" id="kobo.628.2">Zabbix 7.0 is a </span><strong class="bold"><span class="kobospan" id="kobo.629.1">Long-Term Support</span></strong><span class="kobospan" id="kobo.630.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.631.1">LTS</span></strong><span class="kobospan" id="kobo.632.1">) release, so just like 5.0 and 6.0, you will receive long-term </span><a id="_idIndexMarker915" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.633.1">support for it. </span><span class="kobospan" id="kobo.633.2">Let’s see how we can upgrade a Zabbix ser</span><a id="_idTextAnchor2112" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2113" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.634.1">ver from version 6.0 to </span><span><span class="kobospan" id="kobo.635.1">version 7.0.</span></span></p>
<h2 id="_idParaDest-366" class="calibre7"><a id="_idTextAnchor2114" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.636.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.637.1">For this recipe, we will need our server called </span><strong class="source-inline"><span class="kobospan" id="kobo.638.1">lar-book-zbx6</span></strong><span class="kobospan" id="kobo.639.1">. </span><span class="kobospan" id="kobo.639.2">At this point, your server will be running either a RHEL8-based Linux distribution or a Debian-based distribution like Ubuntu 22.04, Debian 12, or newer versions of </span><span><span class="kobospan" id="kobo.640.1">those distributions.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.641.1">If you followed the </span><em class="italic"><span class="kobospan" id="kobo.642.1">Upgrading the Zabbix backend from older PHP versions to PHP 8.2 or higher</span></em><span class="kobospan" id="kobo.643.1"> recipe, your server will now be running PHP version 8.2 or higher. </span><span class="kobospan" id="kobo.643.2">If not, it’s a good option to follow</span><a id="_idIndexMarker916" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.644.1"> that </span><span><span class="kobospan" id="kobo.645.1">recipe first.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.646.1">If you followed the </span><em class="italic"><span class="kobospan" id="kobo.647.1">Upgrading a Zabbix database from older MariaDB versions to MariaDB 11.4</span></em><span class="kobospan" id="kobo.648.1"> recipe, it will now be running MariaDB version 11.4. </span><span class="kobospan" id="kobo.648.2">If not, it’s wise to follow that </span><span><span class="kobospan" id="kobo.649.1">recipe first.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.650.1">Also, make sure to take backups of your system and read the release notes for the new version you’re installing. </span><span class="kobospan" id="kobo.650.2">We covered this in the</span><a id="_idTextAnchor2115" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2116" class="pcalibre calibre6 pcalibre1"/> <em class="italic"><span class="kobospan" id="kobo.651.1">Backing up your Zabbix </span></em><span><em class="italic"><span class="kobospan" id="kobo.652.1">setup</span></em></span><span><span class="kobospan" id="kobo.653.1"> recipe.</span></span></p>
<h2 id="_idParaDest-367" class="calibre7"><span class="kobospan" id="kobo.654.1">How to d</span><a id="_idTextAnchor2117" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.655.1">o it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.656.1">First things first, let’s log in to our Linux host CLI to check out our </span><span><span class="kobospan" id="kobo.657.1">software versions:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.658.1">Issue the following commands to check the respective </span><span><span class="kobospan" id="kobo.659.1">software versions:</span></span><p class="calibre3"><span class="kobospan" id="kobo.660.1">For </span><span><span class="kobospan" id="kobo.661.1">Zabbix server:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.662.1">zabbix_server --version</span></strong></pre><p class="calibre3"><span><span class="kobospan" id="kobo.663.1">For PHP:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.664.1">php-fpm --version</span></strong></pre><p class="calibre3"><span><span class="kobospan" id="kobo.665.1">For MariaDB:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.666.1">mariadb --version</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.667.1">After verifying our versions match the versions mentioned in the </span><em class="italic"><span class="kobospan" id="kobo.668.1">Getting ready</span></em><span class="kobospan" id="kobo.669.1"> section of this recipe, let’s move on to upgrade our </span><span><span class="kobospan" id="kobo.670.1">Zabbix server.</span></span></li>
</ol>
<h3 class="calibre8"><span class="kobospan" id="kobo.671.1">RHEL-b</span><a id="_idTextAnchor2118" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.672.1">ased systems</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.673.1">First, we will start with upgrading the Zabbix server on a </span><span><span class="kobospan" id="kobo.674.1">RHEL-based system:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.675.1">Let’s stop our Zabbix </span><a id="_idIndexMarker917" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.676.1">server components with</span><a id="_idIndexMarker918" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.677.1"> the </span><span><span class="kobospan" id="kobo.678.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.679.1">systemctl stop zabbix-server zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.680.1">On our server, let’s issue the following command to add the new Zabbix </span><span><span class="kobospan" id="kobo.681.1">7.0 repository:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.682.1">rpm -Uvh https://repo.zabbix.com/zabbix/7.0/rhel/8/ x86_64/zabbix-release-7.0-1.el8noarch.rpm</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.683.1">Run the following </span><a id="_idIndexMarker919" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.684.1">command to clean </span><span><span class="kobospan" id="kobo.685.1">the repositories:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.686.1">dnf clean all</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.687.1">Now upgrade the Zabbix setup with the </span><span><span class="kobospan" id="kobo.688.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.689.1">dnf upgrade zabbix-server-mysql zabbix-web-mysql zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.690.1">Additionally, install the</span><a id="_idIndexMarker920" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.691.1"> Zabbix </span><span><span class="kobospan" id="kobo.692.1">NGINX configuration:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.693.1">dnf install zabbix-nginx-conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.694.1">Start the Zabbix components with the </span><span><span class="kobospan" id="kobo.695.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.696.1">systemctl restart zabbix-server zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.697.1">When we check if the server is running, it should say </span><strong class="source-inline1"><span class="kobospan" id="kobo.698.1">Active</span></strong><span class="kobospan" id="kobo.699.1"> (</span><strong class="source-inline1"><span class="kobospan" id="kobo.700.1">running</span></strong><span class="kobospan" id="kobo.701.1">) when we issue the </span><span><span class="kobospan" id="kobo.702.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.703.1">systemctl status zabbix-server</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.704.1">If not, we check the logs with </span><a id="_idIndexMarker921" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.705.1">the following command, so we can see what </span><span><span class="kobospan" id="kobo.706.1">is happening:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.707.1">tail </span><a id="_idTextAnchor2119" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.708.1">-f /var/log/zabbix/zabbix_server.log</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.709.1">Check the log file for any notable errors and if you find any, fix them </span><span><span class="kobospan" id="kobo.710.1">before continuing.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.711.1">If we start the server again, this error should be gone and the Zabbix server should </span><span><span class="kobospan" id="kobo.712.1">keep running:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.713.1">systemctl restart zabbix-server</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.714.1">Now restart the Zabbix components with the </span><span><span class="kobospan" id="kobo.715.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.716.1">systemctl restart nginx p</span><a id="_idTextAnchor2120" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.717.1">hp-fpm zabbix-server mariadb</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.718.1">Now everything should be working as expected and we should see the new Zabbix 7 fronte</span><a id="_idTextAnchor2121" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.719.1">nd, as shown in the </span><span><span class="kobospan" id="kobo.720.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer622">
<span class="kobospan" id="kobo.721.1"><img alt="Figure 11.7 – Zabbix 7 frontend after the up﻿grade on RHEL" src="image/B19803_11_07.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.722.1">Figure 11.7 – Zabbix 7 frontend after the up</span><a id="_idTextAnchor2122" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.723.1">grade on RHEL</span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.724.1">Ubuntu systems</span></h3>
<ol class="calibre16">
<li value="1" class="calibre15"><span class="kobospan" id="kobo.725.1">First, let’s stop our Zabbix </span><a id="_idIndexMarker922" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.726.1">server components with</span><a id="_idIndexMarker923" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.727.1"> the </span><span><span class="kobospan" id="kobo.728.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.729.1">systemctl stop zabbix-server zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.730.1">Now add the new repository for Zabbix 7 on Ubuntu with the </span><span><span class="kobospan" id="kobo.731.1">following commands:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.732.1">wget https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.733.1">dpkg -i zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.734.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.735.1">Always check </span><strong class="source-inline1"><span class="kobospan" id="kobo.736.1">zabbix.com/download</span></strong><span class="kobospan" id="kobo.737.1"> to get the right repository for your systems. </span><span class="kobospan" id="kobo.737.2">In the example, I used the Ubuntu repository. </span><span class="kobospan" id="kobo.737.3">Switch this out for the right repository for </span><span><span class="kobospan" id="kobo.738.1">your system.</span></span></p>
<ol class="calibre16">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.739.1">Update the repository information with the </span><span><span class="kobospan" id="kobo.740.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.741.1">apt update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.742.1">Now upgrade the Zabbix server components with the </span><span><span class="kobospan" id="kobo.743.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.744.1">apt install –-only-upgrade zabbix-server-mysql zabbix-frontend-php zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.745.1">Make sure to not</span><a id="_idIndexMarker924" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.746.1"> overwrite your Zabbix server configuration. </span><span class="kobospan" id="kobo.746.2">If you do overwrite your</span><a id="_idIndexMarker925" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.747.1"> configuration file, you can restore it from the backup taken in the </span><em class="italic"><span class="kobospan" id="kobo.748.1">Backup up your Zabbix </span></em><span><em class="italic"><span class="kobospan" id="kobo.749.1">setup</span></em></span><span><span class="kobospan" id="kobo.750.1"> recipe.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.751.1">Then install the new Zabbix NGINX configuration with the </span><span><span class="kobospan" id="kobo.752.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.753.1">apt install zabbix-nginx-conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.754.1">Restart the Zabbix server components with the following command and you should </span><span><span class="kobospan" id="kobo.755.1">be done:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.756.1">systemctl restart zabbix-server nginx zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.757.1">We check the logs with the following command so we can see what </span><span><span class="kobospan" id="kobo.758.1">is happening:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.759.1">tail -f /var/log/zabbix/zabbix_server.log</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.760.1">Check the log file for any notable errors and if you find any, fix them </span><span><span class="kobospan" id="kobo.761.1">bef</span><a id="_idTextAnchor2123" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.762.1">ore continuing.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.763.1">If we start the server again, this error should be gone and the Zabbix server should </span><span><span class="kobospan" id="kobo.764.1">keep running:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.765.1">systemctl restart zabbix-server</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.766.1">This </span><a id="_idTextAnchor2124" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.767.1">should conclude the upgrade process, and if we go to the fronte</span><a id="_idTextAnchor2125" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.768.1">nd, we should see the new Zabbix </span><span><span class="kobospan" id="kobo.769.1">7 frontend:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer623">
<span class="kobospan" id="kobo.770.1"><img alt="Figure 11.8 ﻿﻿– Zabbix ﻿7 frontend after the U﻿buntu upgrade" src="image/B19803_11_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.771.1">Figure 11.8 </span><a id="_idTextAnchor2126" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2127" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.772.1">– Zabbix 7 frontend after the U</span><a id="_idTextAnchor2128" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.773.1">buntu upgrade</span></p>
<h2 id="_idParaDest-368" class="calibre7"><a id="_idTextAnchor2129" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.774.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.775.1">Upgrading Zabbix can be an easy task when we are running the latest version of Linux. </span><span class="kobospan" id="kobo.775.2">When we are running older</span><a id="_idIndexMarker926" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.776.1"> versions of software though, we might run into </span><span><span class="kobospan" id="kobo.777.1">some issues.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.778.1">The recipe we’ve just</span><a id="_idIndexMarker927" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.779.1"> followed shows us the upgrade process for a Zabbix 6 instance resulting in a setup running Zabbix 7, along with the most common issues we might </span><span><span class="kobospan" id="kobo.780.1">run into.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.781.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.782.1">While upgrading, make sure to keep an eye on your </span><strong class="source-inline1"><span class="kobospan" id="kobo.783.1">zabbix_server.log</span></strong><span class="kobospan" id="kobo.784.1"> file, as this file will tell you if something has gone wrong during the </span><span><span class="kobospan" id="kobo.785.1">upgrade process.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.786.1">We made sure to upgrade PHP to a version higher than 8.0 as this was the requirement for Zabbix 7, making the upgrade process from Zabbix 6 a bit more complicated if we ran an older PHP version. </span><span class="kobospan" id="kobo.786.2">For the database, Zabbix kept the same requirements between Zabbix 6 and Zabbix 7, requiring MariaDB 10.5 or a newer supported </span><a id="_idTextAnchor2130" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.787.1">version for your </span><span><span class="kobospan" id="kobo.788.1">Zabbix setup.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.789.1">Now that you’ve upgraded all the components, you should be ready to work with Zabbix 7 and your setup will be future-proof for a while – of course, until Zabbix 8 comes out, when </span><a id="_idTextAnchor2131" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2132" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.790.1">we might see</span><a id="_idIndexMarker928" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.791.1"> some new requirements </span><span><span class="kobospan" id="kobo.792.1">come along.</span></span></p>
<h2 id="_idParaDest-369" class="calibre7"><a id="_idTextAnchor2133" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.793.1">See also</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.794.1">Make sure to check out the Zabbix documentation for the versions you are upgrading from and to. </span><span class="kobospan" id="kobo.794.2">Zabbix always includes detailed descriptio</span><a id="_idTextAnchor2134" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.795.1">ns of the requirements and processes to make it as easy as possible for you to upgrade. </span><span class="kobospan" id="kobo.795.2">Check out the right documentation for </span><span><span class="kobospan" id="kobo.796.1">your version:</span></span></p>
<p class="calibre3"><a href="https://www.zabbix.com/documentation/current/en/manual/installation/upgrade" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.797.1">https://www.zabbix.com/docum</span><span id="_idTextAnchor2135"/><span id="_idTextAnchor2136"/><span class="kobospan" id="kobo.798.1">entation/current/en/manual/installation/upgrade</span></span></a></p>
<h1 id="_idParaDest-370" class="calibre5"><span class="kobospan" id="kobo.799.1">Maintaining</span><a id="_idTextAnchor2137" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.800.1"> Zabbix performance over time</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.801.1">It’s important to make sure that your Zabbix setup keeps performing well over time. </span><span class="kobospan" id="kobo.801.2">There are several key</span><a id="_idIndexMarker929" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.802.1"> components that are important to keep your </span><a id="_idIndexMarker930" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.803.1">Zabbix setup performing optimally. </span><span class="kobospan" id="kobo.803.2">Let’s see how to work on some of these compon</span><a id="_idTextAnchor2138" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2139" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.804.1">ents and keep your Zabbix setup </span><span><span class="kobospan" id="kobo.805.1">running smoothly.</span></span></p>
<h2 id="_idParaDest-371" class="calibre7"><a id="_idTextAnchor2140" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.806.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.807.1">All we are go</span><a id="_idTextAnchor2141" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2142" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.808.1">ing to need for this recipe is a Zabbix </span><span><span class="kobospan" id="kobo.809.1">7 server.</span></span></p>
<h2 id="_idParaDest-372" class="calibre7"><a id="_idTextAnchor2143" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.810.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.811.1">We will go through three of the main problems people face whilst maintaining Zabbix server performance. </span><span class="kobospan" id="kobo.811.2">First things first, let’s look at the Zabbix processes and how to </span><span><span class="kobospan" id="kobo.812.1">edit them.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.813.1">Z</span><a id="_idTextAnchor2144" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.814.1">abbix processes</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.815.1">A regular problem people face is </span><a id="_idIndexMarker931" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.816.1">a Zabbix process being too busy. </span><span class="kobospan" id="kobo.816.2">Let’s log in to our</span><a id="_idIndexMarker932" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.817.1"> Zabbix frontend and check out how this problem </span><span><span class="kobospan" id="kobo.818.1">might look.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.819.1">First, let’s start by logging in to our Zabbix server frontend and check out </span><span><span class="kobospan" id="kobo.820.1">some messages:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.821.1">When we navigate to </span><strong class="bold"><span class="kobospan" id="kobo.822.1">Monitoring</span></strong><span class="kobospan" id="kobo.823.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.824.1">Dashboard</span></strong><span class="kobospan" id="kobo.825.1"> and then select the default dashbo</span><a id="_idTextAnchor2145" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.826.1">ard </span><strong class="bold"><span class="kobospan" id="kobo.827.1">Global view</span></strong><span class="kobospan" id="kobo.828.1">, we might see something </span><span><span class="kobospan" id="kobo.829.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer624">
<span class="kobospan" id="kobo.830.1"><img alt="Figure 11.9 – Zabbix problem from our Zabbix server, discoverer processes 75% busy" src="image/11.9.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.831.1">Figure 11.9 – Zabbix problem from our Zabbix server, discoverer processes 75% busy</span></p>
<ol class="calibre16">
<li value="2" class="calibre15"><span class="kobospan" id="kobo.832.1">Then we navigate to </span><strong class="bold"><span class="kobospan" id="kobo.833.1">Monitoring</span></strong><span class="kobospan" id="kobo.834.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.835.1">Hosts</span></strong><span class="kobospan" id="kobo.836.1"> and click on </span><strong class="bold"><span class="kobospan" id="kobo.837.1">Latest data</span></strong><span class="kobospan" id="kobo.838.1"> for the Zabbix server host (which, in my case, is called </span><strong class="source-inline1"><span class="kobospan" id="kobo.839.1">lar-book-rocky</span></strong><span class="kobospan" id="kobo.840.1">). </span><span class="kobospan" id="kobo.840.2">This will take us to the latest data for </span><span><span class="kobospan" id="kobo.841.1">our host.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.842.1">For the filters, type </span><strong class="source-inline1"><span class="kobospan" id="kobo.843.1">discovery</span></strong><span class="kobospan" id="kobo.844.1"> in the </span><strong class="bold"><span class="kobospan" id="kobo.845.1">Name</span></strong><span class="kobospan" id="kobo.846.1"> field, then click on </span><strong class="bold"><span class="kobospan" id="kobo.847.1">Graph</span></strong><span class="kobospan" id="kobo.848.1"> for the discovery </span><a id="_idIndexMarker933" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.849.1">wo</span><a id="_idTextAnchor2146" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.850.1">rker item. </span><span class="kobospan" id="kobo.850.2">This will show you the </span><span><span class="kobospan" id="kobo.851.1">following graph:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer625">
<span class="kobospan" id="kobo.852.1"><img alt="Figure 11.10 – Zabbix server discoverer graph, Utilization of discoverer data collector in %" src="image/B19803_11_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.853.1">Figure 11.10 – Zabbix server discoverer graph, Utilization of discoverer data collector in %</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.854.1">This graph is at 100% almost all the time, which explains why we see the problem shown in </span><span><em class="italic"><span class="kobospan" id="kobo.855.1">Figure 11</span></em></span><em class="italic"><span class="kobospan" id="kobo.856.1">.9</span></em><span class="kobospan" id="kobo.857.1"> on </span><span><span class="kobospan" id="kobo.858.1">our dashboard.</span></span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.859.1">Let’s log in to the Linux CLI of our Zabbix server to edit </span><span><span class="kobospan" id="kobo.860.1">this process.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.861.1">Edit the following file on your </span><span><span class="kobospan" id="kobo.862.1">Zabbix server:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.863.1">vim /etc/zabbix/zabbix_server.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.864.1">Now, if we want to give our Zabbix server’s </span><strong class="source-inline1"><span class="kobospan" id="kobo.865.1">discoverer</span></strong><span class="kobospan" id="kobo.866.1"> process more room, we need to edit the </span><a id="_idIndexMarker934" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.867.1">correct p</span><a id="_idTextAnchor2147" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.868.1">arameter. </span><span class="kobospan" id="kobo.868.2">Scroll down until you see </span><span><span class="kobospan" id="kobo.869.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer626">
<span class="kobospan" id="kobo.870.1"><img alt="Figure 11.11 – Zabbix server conf﻿iguration file, StartDiscoverers default" src="image/B19803_11_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.871.1">Figure 11.11 – Zabbix server conf</span><a id="_idTextAnchor2148" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.872.1">iguration file, StartDiscoverers default</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.873.1">Now add a new line under </span><a id="_idIndexMarker935" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.874.1">this and add the </span><span><span class="kobospan" id="kobo.875.1">following line:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.876.1">StartDiscoverers=2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.877.1">If your file now looks like the fol</span><a id="_idTextAnchor2149" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.878.1">lowing screenshot, you can save and exit </span><span><span class="kobospan" id="kobo.879.1">the file:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer627">
<span class="kobospan" id="kobo.880.1"><img alt="Figure 11.12 – Zabbix server configuration file, StartDiscoverers 2" src="image/B19803_11_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.881.1">Figure 11.12 – Zabbix server configuration file, StartDiscoverers 2</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.882.1">For the changes to take effect, we will need to restart the Zabbix server with the </span><span><span class="kobospan" id="kobo.883.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.884.1">systemctl restart zabbix-server</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.885.1">Now if we go back to our Zabbix frontend, we should stil</span><a id="_idTextAnchor2150" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.886.1">l be at our graph where we can see </span><span><span class="kobospan" id="kobo.887.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer628">
<span class="kobospan" id="kobo.888.1"><img alt="Figure 11.13 – Zab﻿bix server discoverer graph" src="image/B19803_11_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.889.1">Figure 11.13 – Zab</span><a id="_idTextAnchor2151" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.890.1">bix server discoverer graph</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.891.1">The utilization of our discoverer </span><a id="_idIndexMarker936" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.892.1">process has gone down, which means our utilization problem won’t show up</span><a id="_idIndexMarker937" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.893.1"> anymore. </span><span class="kobospan" id="kobo.893.2">That’s how we edit Zabbix </span><span><span class="kobospan" id="kobo.894.1">server processes.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.895.1">Zabbix housek</span><a id="_idTextAnchor2152" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.896.1">eeper</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.897.1">Another very common problem people face is the </span><a id="_idIndexMarker938" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.898.1">Zabbix housekeeper process </span><a id="_idIndexMarker939" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.899.1">being too busy. </span><span class="kobospan" id="kobo.899.2">Let’s log in to our Zabbix frontend and check out </span><span><span class="kobospan" id="kobo.900.1">the problem:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.901.1">When we navigate to </span><strong class="bold"><span class="kobospan" id="kobo.902.1">Monitoring</span></strong><span class="kobospan" id="kobo.903.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.904.1">Dashboard</span></strong><span class="kobospan" id="kobo.905.1"> and then select the default dash</span><a id="_idTextAnchor2153" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.906.1">board </span><strong class="bold"><span class="kobospan" id="kobo.907.1">Global view</span></strong><span class="kobospan" id="kobo.908.1">, we might see something </span><span><span class="kobospan" id="kobo.909.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer629">
<span class="kobospan" id="kobo.910.1"><img alt="Figure 11.14 – A problem with Zabbix housekeeper" src="image/11.14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.911.1">Figure 11.14 – A problem with Zabbix housekeeper</span></p>
<ol class="calibre16">
<li value="2" class="calibre15"><span class="kobospan" id="kobo.912.1">Similar to editing any Zabbix process, we can also edit the Zabbix housekeeper process. </span><span class="kobospan" id="kobo.912.2">Let’s log in to the Linux CLI of our Zabbix server to edit </span><span><span class="kobospan" id="kobo.913.1">our process.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.914.1">Let’s edit the following file on our </span><span><span class="kobospan" id="kobo.915.1">Zabbix server:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.916.1">vim /etc/zabbix/zabbix_server.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.917.1">Now, if we want to edit this process, we need to edit the correct p</span><a id="_idTextAnchor2154" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.918.1">arameters. </span><span class="kobospan" id="kobo.918.2">Scroll down until you see </span><span><span class="kobospan" id="kobo.919.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer630">
<span class="kobospan" id="kobo.920.1"><img alt="Figure 11.15 – Zabbix configuration file, HousekeepingFrequency 1" src="image/B19803_11_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.921.1">Figure 11.15 – Zabbix configuration file, HousekeepingFrequency 1</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.922.1">This is our first </span><a id="_idIndexMarker940" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.923.1">housekeeper parameter. </span><span class="kobospan" id="kobo.923.2">Let’s edit this parameter by adding</span><a id="_idIndexMarker941" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.924.1"> the following line under </span><span><span class="kobospan" id="kobo.925.1">this block:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.926.1">HousekeepingFrequency=2</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.927.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.928.1">Making the interval longer is not going to solve your issue; at most, you are delaying the inevitable. </span><span class="kobospan" id="kobo.928.2">It is only recommended to change this setting until the next maintenance window, an</span><a id="_idTextAnchor2155" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.929.1">d it should be avoided as much </span><span><span class="kobospan" id="kobo.930.1">as po</span><a id="_idTextAnchor2156" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.931.1">ssible.</span></span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.932.1">Now scroll down until you see </span><span><span class="kobospan" id="kobo.933.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer631">
<span class="kobospan" id="kobo.934.1"><img alt="Figure 11.16 – Zabbix configuration file, HousekeepingDelete 5000" src="image/B19803_11_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.935.1">Figure 11.16 – Zabbix configuration file, HousekeepingDelete 5000</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.936.1">The preceding screenshot shows our second housekeeper parameter. </span><span class="kobospan" id="kobo.936.2">Let’s edit this parameter by adding the following line under</span><a id="_idTextAnchor2157" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.937.1"> this </span><span><span class="kobospan" id="kobo.938.1">code block:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.939.1">MaxHousekeeperDelete=20000</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.940.1">For the changes to</span><a id="_idIndexMarker942" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.941.1"> take effect, we need to restart the Zabbix server with the </span><span><span class="kobospan" id="kobo.942.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.943.1">systemctl re</span><a id="_idTextAnchor2158" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.944.1">start zabbix-server</span></strong></pre></li> </ol>
<h3 class="calibre8"><span class="kobospan" id="kobo.945.1">Tuning a MySQL database</span></h3>
<ol class="calibre16">
<li value="1" class="calibre15"><span class="kobospan" id="kobo.946.1">Let’s see how we can tune a MySQL database with ease. </span><span class="kobospan" id="kobo.946.2">First off, let’s go to the following link in our </span><span><span class="kobospan" id="kobo.947.1">browser: </span></span><a href="https://github.com/major/MySQLTuner-perl" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.948.1">https://github.com/major/MySQLTuner-perl</span></span></a><span><span class="kobospan" id="kobo.949.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.950.1">This link brings us to an </span><a id="_idIndexMarker943" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.951.1">open source GitHub project started by </span><em class="italic"><span class="kobospan" id="kobo.952.1">Major Hayden</span></em><span class="kobospan" id="kobo.953.1">. </span><span class="kobospan" id="kobo.953.2">Be sure to follow the repository and do all you can to help out. </span><span class="kobospan" id="kobo.953.3">Let’s download the script from the GitHub repository or simply use the </span><span><span class="kobospan" id="kobo.954.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.955.1">wget https://raw.githubusercontent.com/major/MySQLTuner-perl/master/mysqltuner.pl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.956.1">Now we can execute this script with the </span><span><span class="kobospan" id="kobo.957.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.958.1">perl mysqltuner.pl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.959.1">This will bring us to a prompt for our My</span><a id="_idTextAnchor2159" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.960.1">SQL database credentials. </span><span class="kobospan" id="kobo.960.2">Fill them out </span><span><span class="kobospan" id="kobo.961.1">and continue:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer632">
<span class="kobospan" id="kobo.962.1"><img alt="Figure 11.17 – MySQL tuner script execution" src="image/B19803_11_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.963.1">Figure 11.17 – MySQL tuner script execution</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.964.1">Now, the script will output a lot of information that you will need to read carefully, but the most important</span><a id="_idIndexMarker944" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.965.1"> part </span><a id="_idTextAnchor2160" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.966.1">is at the end – everything after </span><strong class="source-inline1"><span class="kobospan" id="kobo.967.1">Variables </span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.968.1">to adjust</span></strong></span><span><span class="kobospan" id="kobo.969.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer633">
<span class="kobospan" id="kobo.970.1"><img alt="Figure 11.18 – MySQL tuner script output" src="image/B19803_11_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.971.1">Figure 11.18 – MySQL tuner script output</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.972.1">Important note</span></p>
<p class="callout"><em class="italic"><span class="kobospan" id="kobo.973.1">DO NOT</span></em><span class="kobospan" id="kobo.974.1"> simply copy over the output from this script. </span><span class="kobospan" id="kobo.974.2">The script is simply giving us an indicator of what might be tuned in our MySQL settings. </span><span class="kobospan" id="kobo.974.3">Always look up the settings suggested and re</span><a id="_idTextAnchor2161" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.975.1">ad about the best practices for </span><span><span class="kobospan" id="kobo.976.1">those settings.</span></span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.977.1">We can edit these variables in the MySQL </span><strong class="source-inline1"><span class="kobospan" id="kobo.978.1">my.cnf</span></strong><span class="kobospan" id="kobo.979.1"> file. </span><span class="kobospan" id="kobo.979.2">In my case, I edit it with the </span><span><span class="kobospan" id="kobo.980.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.981.1">vim /etc/my.cnf.d/server.cnf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.982.1">Now, you simply edit or add the variables that are suggested in the script and then</span><a id="_idTextAnchor2162" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2163" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.983.1"> restart your </span><span><span class="kobospan" id="kobo.984.1">MySQL server:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.985.1">systemctl restart mariadb</span></strong></pre></li> </ol>
<h2 id="_idParaDest-373" class="calibre7"><a id="_idTextAnchor2164" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.986.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.987.1">We’ve just done three of the main performance tweaks we can do for a Zabbix server, but there’s a lot more to do. </span><span class="kobospan" id="kobo.987.2">Let’s take a look at what we’ve just edited, consider why we’ve edited it, and find out whether it’s</span><a id="_idTextAnchor2165" class="pcalibre calibre6 pcalibre1"/> <a id="_idTextAnchor2166" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.988.1">really </span><span><span class="kobospan" id="kobo.989.1">that simple.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.990.1">Zabbix processes</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.991.1">Zabbix processes are a big part of </span><a id="_idIndexMarker945" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.992.1">your Zabbix server setup and must be edited with care. </span><span class="kobospan" id="kobo.992.2">In this recipe, we’ve only just edited the discoverer process on a small installation. </span><span class="kobospan" id="kobo.992.3">This problem was easy as the server had more than enough resources to account for another </span><span><span class="kobospan" id="kobo.993.1">process running.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.994.1">Now if we look at the following diagram, we can see the situatio</span><a id="_idTextAnchor2167" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.995.1">n as it was before we added a new </span><span><span class="kobospan" id="kobo.996.1">discoverer process:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer634">
<span class="kobospan" id="kobo.997.1"><img alt="Figure 11.19 – Zabbix server single-process setup diagram" src="image/B19803_11_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.998.1">Figure 11.19 – Zabbix server single-process setup diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.999.1">We can </span><a id="_idIndexMarker946" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1000.1">see our </span><strong class="bold"><span class="kobospan" id="kobo.1001.1">Linux host</span></strong><span class="kobospan" id="kobo.1002.1"> running our </span><strong class="bold"><span class="kobospan" id="kobo.1003.1">Zabbix server</span></strong><span class="kobospan" id="kobo.1004.1"> application and we can see our </span><strong class="bold"><span class="kobospan" id="kobo.1005.1">LLDProcessors 1</span></strong><span class="kobospan" id="kobo.1006.1"> process discovering </span><strong class="bold"><span class="kobospan" id="kobo.1007.1">LLD rule 1</span></strong><span class="kobospan" id="kobo.1008.1">. </span><strong class="bold"><span class="kobospan" id="kobo.1009.1">LLD rule 2</span></strong><span class="kobospan" id="kobo.1010.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.1011.1">LLD rule 3</span></strong><span class="kobospan" id="kobo.1012.1"> are queueing up as one LLDProcessor</span><a id="_idIndexMarker947" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1013.1"> subprocess can only handle one rule at </span><span><span class="kobospan" id="kobo.1014.1">a time.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1015.1">As we’ve seen that this is apparently too hea</span><a id="_idTextAnchor2168" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1016.1">vy for our system, we have added </span><span><span class="kobospan" id="kobo.1017.1">another LLDProcessor:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer635">
<span class="kobospan" id="kobo.1018.1"><img alt="Figure 11.20 – Zabbix server multiple-process setup diagram" src="image/B19803_11_20.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1019.1">Figure 11.20 – Zabbix server multiple-process setup diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1020.1">Our new setup will balance the load to a certain extent. </span><span class="kobospan" id="kobo.1020.2">It’s only possible for a discovery rule to be handled by a single discoverer process. </span><span class="kobospan" id="kobo.1020.3">This means that if we have multiple discovery rules, we can add discoverers like this to make sure there are enough resources available per discovery rule. </span><span class="kobospan" id="kobo.1020.4">It works the same for the other processes – more processes mean better distributions </span><span><span class="kobospan" id="kobo.1021.1">of tasks.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1022.1">However, there are several things to be careful of here. </span><span class="kobospan" id="kobo.1022.2">First of all, not all issues can be solved by simply throwing more resources at them. </span><span class="kobospan" id="kobo.1022.3">Some Zabbix setups are configured poorly, where there’s something in the configuration making our processes unnecessarily busy. </span><span class="kobospan" id="kobo.1022.4">If we deal with the poor configuration aspect, we can take away t</span><a id="_idTextAnchor2169" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1023.1">he high load, thus we need </span><span><span class="kobospan" id="kobo.1024.1">fewer processes.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1025.1">The second thing I’d like to </span><a id="_idIndexMarker948" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1026.1">stress is that we can keep adding processes to our Zabbix server configuration – within limits. </span><span class="kobospan" id="kobo.1026.2">Before we reach those limits though, you are definitely going to reach the roof of what our Linux host hardware is capable of. </span><span class="kobospan" id="kobo.1026.3">Make sure you have enough RAM and CPU power to actually run all these processes or use Zabbix proxies for offloading. </span><span class="kobospan" id="kobo.1026.4">Also keep in mind that adding more processes might require additional database tuning, for example allowing more connections to </span><span><span class="kobospan" id="kobo.1027.1">the database.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1028.1">Last but not least, keep in mind that changing the Zabbix server configuration requires a restart of the </span><strong class="source-inline"><span class="kobospan" id="kobo.1029.1">zabbix-server</span></strong><span class="kobospan" id="kobo.1030.1"> process. </span><span class="kobospan" id="kobo.1030.2">On large installations, this can take a long time. </span><span class="kobospan" id="kobo.1030.3">The Zabbix server might have to do a lot of database writes (for example, of the trend data) to get the </span><strong class="source-inline"><span class="kobospan" id="kobo.1031.1">zabbix-server</span></strong><span class="kobospan" id="kobo.1032.1"> process to </span><span><span class="kobospan" id="kobo.1033.1">shut down.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1034.1">Zabbix housekeeper</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1035.1">Now for Zabbix housekeeper, which is</span><a id="_idIndexMarker949" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1036.1"> a very important process for Zabbix administrators who haven’t set up MySQL partitioning or Postgre</span><a id="_idTextAnchor2170" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1037.1">SQL TimescaleDB partitioning yet. </span><span class="kobospan" id="kobo.1037.2">The Zabbix housekeeper process connects to our database and then drops information line by line that has </span><em class="italic"><span class="kobospan" id="kobo.1038.1">expired</span></em><span class="kobospan" id="kobo.1039.1">. </span><span class="kobospan" id="kobo.1039.2">You might think, how do you mean expired? </span><span class="kobospan" id="kobo.1039.3">Well, we can set limits in the Zabbix server for how long an item should be kept in </span><span><span class="kobospan" id="kobo.1040.1">the database.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1041.1">If we look at </span><strong class="bold"><span class="kobospan" id="kobo.1042.1">Administration</span></strong><span class="kobospan" id="kobo.1043.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1044.1">Housekeeping</span></strong><span class="kobospan" id="kobo.1045.1">, part of</span><a id="_idTextAnchor2171" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1046.1"> what we will see is shown in the </span><span><span class="kobospan" id="kobo.1047.1">following screenshot:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer636">
<span class="kobospan" id="kobo.1048.1"><img alt="Figure 11.21 – Zabbix server history and trends housekeeping setup" src="image/B19803_11_21.JPG" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1049.1">Figure 11.21 – Zabbix server history and trends housekeeping setup</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1050.1">These are our global </span><strong class="bold"><span class="kobospan" id="kobo.1051.1">History</span></strong><span class="kobospan" id="kobo.1052.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.1053.1">Trends</span></strong><span class="kobospan" id="kobo.1054.1"> housekeeping parameters. </span><span class="kobospan" id="kobo.1054.2">This defines how long an item’s data should be kept in our database. </span><span class="kobospan" id="kobo.1054.3">If we look at an item on</span><a id="_idTextAnchor2172" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1055.1"> a template or host, we can also see </span><span><span class="kobospan" id="kobo.1056.1">these</span></span><span><a id="_idIndexMarker950" class="pcalibre calibre6 pcalibre1"/></span><span><span class="kobospan" id="kobo.1057.1"> parameters:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer637">
<span class="kobospan" id="kobo.1058.1"><img alt="Figure 11.22 – Zabbix item hi﻿story and trends housekeeping parameters" src="image/B19803_11_22.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1059.1">Figure 11.22 – Zabbix item hi</span><a id="_idTextAnchor2173" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1060.1">story and trends housekeeping parameters</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1061.1">These settings override the global settings so you can tweak the housekeeper further. </span><span class="kobospan" id="kobo.1061.2">That’s how the housekeeper keeps your database </span><span><span class="kobospan" id="kobo.1062.1">in check.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1063.1">But now, let’s look at the tweaks we made in our Zabbix server configuration file, the first of which is </span><strong class="source-inline"><span class="kobospan" id="kobo.1064.1">HousekeepingFrequency</span></strong><span class="kobospan" id="kobo.1065.1">. </span><span class="kobospan" id="kobo.1065.2">Housekeeping frequency is how often the housekeeper process is started. </span><span class="kobospan" id="kobo.1065.3">We’ve lowered this from every hour to every two hours. </span><span class="kobospan" id="kobo.1065.4">Now you might think that’s worse, but it doesn’t have to be. </span><span class="kobospan" id="kobo.1065.5">A lot of the time, we see that housekeeping is not done after one hour and then it just keeps going on </span><span><span class="kobospan" id="kobo.1066.1">and on.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1067.1">We also changed the </span><strong class="source-inline"><span class="kobospan" id="kobo.1068.1">MaxHousekeeperDelete</span></strong><span class="kobospan" id="kobo.1069.1"> parameter, which is something completely different. </span><span class="kobospan" id="kobo.1069.2">This determines how many database rows our Zabbix housekeeper is allowed to delete in each run. </span><span class="kobospan" id="kobo.1069.3">The default settings determined that every hour, we can delete 5,000 database rows. </span><span class="kobospan" id="kobo.1069.4">With our new settings, we can now delete 20,000 database rows every two hours. </span><span class="kobospan" id="kobo.1069.5">Each row will basically just be a single metric we are allowed </span><span><span class="kobospan" id="kobo.1070.1">to delete.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1071.1">How does this change anything at all? </span><span class="kobospan" id="kobo.1071.2">Well, it might not. </span><span class="kobospan" id="kobo.1071.3">It completely depends on your setup. </span><span class="kobospan" id="kobo.1071.4">Tweaking the Zabbix housekeeper is different for every setup, and you will have to determine your optimum</span><a id="_idIndexMarker951" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1072.1"> settings for yourself. </span><span class="kobospan" id="kobo.1072.2">Try to balance what you see in your graphs with the two settings we’ve discuss</span><a id="_idTextAnchor2174" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1073.1">ed here to see how well you can </span><span><span class="kobospan" id="kobo.1074.1">optimize it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1075.1">However, at one point, your Zabbix setup might grow big enough and Zabbix housekeeping won’t be able to keep up. </span><span class="kobospan" id="kobo.1075.2">This is when you’ll need to look at MySQL partitioning or PostgreSQL TimescaleDB. </span><span class="kobospan" id="kobo.1075.3">There’s no predefined point where the Zabbix housekeeper won’t be able to keep up, so it is smarter to just start with MySQL partitioning or PostgreSQL TimescaleDB right from the start. </span><span class="kobospan" id="kobo.1075.4">After all, any setup might grow larger than expected, right? </span><span class="kobospan" id="kobo.1075.5">More on this subject is explained in </span><a href="B19803_12.xhtml#_idTextAnchor2180" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.1076.1">Chapter 12</span></em></span></a><span class="kobospan" id="kobo.1077.1"> o</span><a id="_idTextAnchor2175" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1078.1">f </span><span><span class="kobospan" id="kobo.1079.1">this book.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1080.1">Tuning a MySQL database</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1081.1">Now for tuning your MySQL database with the </span><strong class="source-inline"><span class="kobospan" id="kobo.1082.1">mysqltuner.pl</span></strong><span class="kobospan" id="kobo.1083.1"> script. </span><span class="kobospan" id="kobo.1083.2">This script does a lot in the background, but</span><a id="_idIndexMarker952" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1084.1"> we can summarize it as follows: it looks at what the current utilization of your MySQL database is, and then outputs what it thinks the correct tuning variables </span><span><span class="kobospan" id="kobo.1085.1">would be.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1086.1">Do not take the script output as a given, as with Zabbix housekeeping, there is no way to give you a definitive setup for your database. </span><span class="kobospan" id="kobo.1086.2">Databases are simply more complicated than just doing some tweaks and being done </span><span><span class="kobospan" id="kobo.1087.1">with it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1088.1">The script will definitely help you tweak your MySQL database to an extent, especially for smaller setups. </span><span class="kobospan" id="kobo.1088.2">But make sure to extend your knowledge by re</span><a id="_idTextAnchor2176" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2177" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1089.1">ading blogs, guides, and books about </span><span><span class="kobospan" id="kobo.1090.1">databases regularly.</span></span></p>
<h2 id="_idParaDest-374" class="calibre7"><a id="_idTextAnchor2178" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1091.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1092.1">We went over how to tune a MySQL database, but we didn’t go over how to tune a PostgreSQL instance. </span><span class="kobospan" id="kobo.1092.2">There’s a wide variety of options out there to do this, so for</span><a id="_idTextAnchor2179" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1093.1"> more on that I recommend checking out the PostgreSQL wiki at </span><a href="https://wiki.postgresql.org/wiki/Performance_Optimization" class="pcalibre calibre6 pcalibre1"><span class="kobospan" id="kobo.1094.1">https://wiki.postgresql.org/wiki/Performance_Optimization</span></a><span class="kobospan" id="kobo.1095.1">. </span><span class="kobospan" id="kobo.1095.2">There are different varieties and different preferences at play here. </span><span class="kobospan" id="kobo.1095.3">Make sure to check them all out well and pick the one that works the best </span><span><span class="kobospan" id="kobo.1096.1">for you.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1097.1">There’s also a new</span><a id="_idIndexMarker953" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1098.1"> addition in Zabbix 7.0, which is specifically for the following </span><span><span class="kobospan" id="kobo.1099.1">three pollers:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span><span class="kobospan" id="kobo.1100.1">Agent poller</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1101.1">HTTP </span><span><span class="kobospan" id="kobo.1102.1">agent poller</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1103.1">SNMP poller (for walk[OID] and </span><span><span class="kobospan" id="kobo.1104.1">get[OID] items)</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1105.1">These processes now execute checks asynchronously. </span><span class="kobospan" id="kobo.1105.2">What that means is that they can execute multiple (item) checks at the same time. </span><span class="kobospan" id="kobo.1105.3">In older versions of Zabbix, these pollers could only execute a single check at </span><span><span class="kobospan" id="kobo.1106.1">the time.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1107.1">It’s still possible to add multiple of these processes with, for example, </span><strong class="bold"><span class="kobospan" id="kobo.1108.1">StartAgentPollers</span></strong><span class="kobospan" id="kobo.1109.1">, but it now functions differently. </span><span class="kobospan" id="kobo.1109.2">This will execute a maximum of 1,000 checks per poller, which is configurable with the </span><span><strong class="bold"><span class="kobospan" id="kobo.1110.1">MaxConcurrentChecksPerPoller</span></strong></span><span><span class="kobospan" id="kobo.1111.1"> parameter.</span></span></p>
</div>
</body></html>