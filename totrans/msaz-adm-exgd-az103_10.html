<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Creating and Configuring VMs for Windows and Linux</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we covered Azure file shares and how to sync your on-premises file shares with Azure using the Azure File Sync service. You also learned how to back up and restore file shares in Azure.</p>
<p>This chapter introduces the <em>Deploying and Managing Virtual Machines</em><span> </span>objective.<span> </span>In this chapter, we are going to cover <strong>V</strong><strong>irtual Machines</strong> (<strong>VMs</strong>) in Azure, and the different VM sizes that are available for both Azure and Linux. You will learn how you can create and configure VMs for Windows and Linux. We will also cover high availability and what actions you can take to configure your VMs for high availability. You will also learn how to deploy your VMs using templates by using <strong>Azure Resource Manager</strong><span> (</span><strong>ARM</strong><span>)</span> templates, and how to automate your deployment using scale sets.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>VMs</li>
<li>Deploying Windows and Linux VMs</li>
<li>Configuring high availability</li>
<li>Deploying and configuring scale sets</li>
<li>Modifying and deploying ARM templates</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter uses the following tools for our examples:</p>
<ul>
<li>Azure PowerShell:<span> <a href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0">https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0</a></span><a href="https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1"/></li>
<li>Visual Studio Code: <a href="https://code.visualstudio.com/download">https://code.visualstudio.com/download</a></li>
</ul>
<p class="mce-root"/>
<p>The source code for this chapter can be downloaded from <a href="https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter07">https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter07</a>.<a href="https://github.com/PacktPublishing/Microsoft-Azure-Integration-and-Security-Exam-Guide-AZ-101/tree/master/Chapter03"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VMs</h1>
                </header>
            
            <article>
                
<p>You can run both Windows VMs <span>as well as Linux VMs in Azure. VMs come in all sorts of sizes and a variety of prices, ranging from VMs with a small amount of memory and processing power for general purposes to large VMs that can be used for <strong>Graphics Processing Unit</strong> (<strong>GPU</strong>)-intensive and high-performance computing workloads.</span></p>
<p><span>To create a VM, you can choose from a number of predefined images. There are </span>images<span> available for operating systems such as Windows Server or Linux, as well as </span>predefined<span> applications, such as SQL Server images and complete </span>farms<span>, which consist of </span>multiple<span> VMs that can be deployed at once. An example of a farm is a three-tier SharePoint </span>farm<span>.</span></p>
<p>VMs<span> can be created and managed either from the Azure portal, PowerShell, or CLI, and they come in the following series and sizes.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VM series and sizes</h1>
                </header>
            
            <article>
                
<p>At the time of writing this book, the following VM series and sizes are available:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 24.1307%">
<p><strong><span>Series</span></strong></p>
</td>
<td style="width: 31.8693%">
<p><strong><span>Type </span></strong></p>
</td>
<td style="width: 41%">
<p><strong><span>Description</span></strong></p>
</td>
</tr>
<tr>
<td style="width: 24.1307%">
<p><span>B, Dsv3, Dv3, DSv2, Dv2, Av2, DC</span></p>
</td>
<td style="width: 31.8693%">
<p><span>General purpose</span></p>
</td>
<td style="width: 41%">
<p><span>These VMs have a balanced CPU-</span>to-memory ratio<span> and are ideal for testing </span>and<span> development scenarios. They are </span>also<span> suitable for small and medium </span>databases,<span> and web servers with low-to-</span>medium<span> traffic.</span></p>
</td>
</tr>
<tr>
<td style="width: 24.1307%">
<p><span>Fsv2, Fs, F</span></p>
</td>
<td style="width: 31.8693%">
<p><span>Compute optimized</span></p>
</td>
<td style="width: 41%">
<p><span>These VMs have a high CPU-to-memory </span>ratio<span> and are suitable for web servers </span>with<span> medium traffic, application </span>servers<span>, and network appliances for </span>nodes<span> in batch processing.</span></p>
</td>
</tr>
<tr>
<td style="width: 24.1307%">
<p><span>Esv3, Ev3, M, GS, G, DSv2, Dv2</span></p>
</td>
<td style="width: 31.8693%">
<p><span>Memory optimized</span></p>
</td>
<td style="width: 41%">
<p><span>These VMs have a high memory-to-CPU </span>ratio<span> and are suitable for relational </span>database<span> servers, medium-to-large </span>caches<span>, and in-memory analytics.</span></p>
</td>
</tr>
<tr>
<td style="width: 24.1307%">
<p><span>Lsv2, Ls</span></p>
</td>
<td style="width: 31.8693%">
<p><span>Storage optimized</span></p>
</td>
<td style="width: 41%">
<p><span>These VMs have high disk throughput </span>and<span> IO and are suitable for big </span>data<span>, SQL, and NoSQL databases.</span></p>
</td>
</tr>
<tr>
<td style="width: 24.1307%">
<p><span>NV, NVv2, NC, NCv2, NCv3, ND, NDv2 (Preview)</span></p>
</td>
<td style="width: 31.8693%">
<p>GPU</p>
</td>
<td style="width: 41%">
<p>These VMs are targeted for heavy graphic rendering and video editing, deep learning applications, and machine learning model training. These VMs are available with single or multiple GPUs.</p>
</td>
</tr>
<tr>
<td style="width: 24.1307%">
<p>H</p>
</td>
<td style="width: 31.8693%">
<p>High-performance compute</p>
</td>
<td style="width: 41%">
<p>These are the fastest VMs available. They offer the most powerful CPU with optional high-throughput network interfaces (<strong>R</strong><span><strong>emote Direct Memory Access</strong> (</span><strong>RDMA</strong>)).</p>
</td>
</tr>
</tbody>
</table>
<div class="packt_infobox"><br/>
VM series are updated constantly. New series, types, and sizes are added and removed frequently. To stay up to date with these changes, you can refer to the following site for Windows VM sizes: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes</a>. For Linux VM sizes, you can refer to <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes?toc=%2fazure%2fvirtualmachines%2flinux%2ftoc.json</a>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Managed disks</h1>
                </header>
            
            <article>
                
<p>Azure managed disks are the default disks selected when you create a VM in the Azure portal. They handle storage for your VMs completely. Previously, you would have had to manually create storage accounts to store VM hard disks, and when your VM needed to scale up, you had to add additional storage accounts to make sure you didn't exceed the limit of 20,000 <span><strong>Input/Output Operations Per Second</strong> (</span><strong>IOPS</strong>) per account.</p>
<p>With managed disks, this burden is now handled for you by Azure. You can now create 10,000 VM disks inside a subscription, which can result in thousands of VMs inside a subscription, without the need to copy disks between storage accounts.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Availability sets</h1>
                </header>
            
            <article>
                
<p>To create a reliable infrastructure, adding your VMs to an availability set is key. There are several scenarios that can have an impact on the availability of your Azure VMs. These are as follows:</p>
<ul>
<li><strong>Unplanned hardware maintenance event</strong>:<span> </span>When hardware is about to fail, Azure fires an unplanned hardware maintenance event. Live migration technology is used, which predicts the failure and then moves the VM, the network connections, memory, and storage to different physical machines, without disconnecting the client. When your VM is moved, the performance is reduced for a short time because the VM is paused for 30 seconds. Network connections, memory, and open files are still preserved.</li>
<li><strong>Unexpected downtime</strong>:<span> </span>The VM is down when this event occurs because Azure needs to heal your VM inside the same data center. A hardware or physical infrastructure failure often causes this event to happen.</li>
<li><strong>Planned hardware maintenance event</strong>:<span> </span>This type of event is a periodic update from Microsoft in Azure to improve the platform. Most of these updates don't have a significant impact on the uptime of VMs, but some of them may require a reboot<span> </span>or restart.</li>
</ul>
<p>To provide redundancy during these types of events, you can group two or more VMs in an availability set. By leveraging availability sets, VMs are distributed across multiple isolated hardware nodes in a cluster. This way, Azure can ensure that during an event or failure, only a subset of your VMs is impacted and your overall solution will remain operational and available. This way, the 99.95% Azure <strong>Service Level Agreement</strong><span> (</span><strong>SLA</strong><span>)</span> can still be met during outages and other failures. </p>
<div class="packt_tip">VMs<span> can only be assigned to an availability set during initial deployment. </span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Fault domains and update domains</h1>
                </header>
            
            <article>
                
<p>When you place your VMs in an availability set, Azure guarantees to spread them across fault and update domains. By default, Azure will assign three fault domains and five update domains (which can be increased to a maximum of 20) to the availability set.</p>
<p>When spreading your VMs over fault domains, your VMs sit over three different racks in the Azure Datacenter. So, in the case of an event or failure of the underlying platform, only one rack gets affected and the other VMs remain accessible as depicted in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c9b3494f-cf22-4657-986f-cba1aeec22ef.png"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">VMs spread over three fault domains</div>
<p class="mce-root"/>
<p>Update domains are useful in the case of an OS or host update. When you spread your VMs across multiple update domains, one domain will be updated and rebooted while the others remain accessible as <span>depicted in the following diagram:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e91df8b7-c4c4-4f85-b78d-a005e98279df.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">VMs spread over five update domains and three fault domains</div>
<p class="mce-root">In the next demonstration, we are going to create a new Windows VM in the Azure portal.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying Windows and Linux VMs</h1>
                </header>
            
            <article>
                
<p>In the upcoming demonstrations, we are going to deploy a Windows Server VM from both the Azure portal and PowerShell.</p>
<p class="mce-root"/>
<div class="packt_infobox">Deploying Linux machines is quite similar to deploying Windows machines. We are not going to cover how to deploy Linux machines. For more information about how to deploy Linux machines in Azure, you can refer to the <em>Further reading</em> section at the end of this chapter.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying a Windows VM from the Azure portal</h1>
                </header>
            
            <article>
                
<p>In this demonstration, we are going to deploy a Windows VM from the Azure portal. We are going to set up networking and storage, and select a VM size for this VM. We are also going to configure high availability for this VM, by placing it in an <em>availability set</em>. To do so, perform the following steps:</p>
<ol>
<li><span>Navigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a>.</li>
<li>In the left menu, click <span class="packt_screen">Virtual machines</span>, and then, in the top menu, click <span class="packt_screen">+ Add</span> as follows:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/4902b806-2c0a-4e80-bfd9-77b2c9bbc0d4.png"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Creating a new VM</span><strong><br/></strong></div>
<ol start="3">
<li>We are going to create a Windows VM, so in the <span class="packt_screen">Basics</span> blade, add the following values:
<ul>
<li><strong>Subscription</strong>: Choose a subscription.</li>
<li><strong>Resource group</strong>: <kbd>PacktVMGroup</kbd>.</li>
<li><strong>Virtual machine name</strong>: <kbd>PacktWindowsVM</kbd>.</li>
<li><strong>Region</strong>: Choose a region.</li>
<li><strong>Availability options</strong>: Here, select <strong><span class="packt_screen">Availability set</span></strong>.</li>
<li><strong>Availability set</strong>: Create new, and call it <span><kbd>PacktWindowsAS</kbd>. Keep the default fault domains and update the domains for this VM.</span></li>
<li><strong>Image</strong>: <span class="packt_screen">Windows Server Datacenter 2016</span>.</li>
<li><strong>Size</strong>: Here, you can choose between the different sizes. Click <span class="packt_screen">C</span><span class="packt_screen">hange size</span>, and select <span class="packt_screen">Standard DS1 v2</span>.</li>
<li><strong>Administrator account</strong>: Provide a username and a password. </li>
<li><strong>Inbound port rules</strong>: Select <strong><span class="packt_screen">Allow selected ports</span></strong> and enable <strong>Remote Desktop</strong><span><strong> Protocol</strong> </span>(<strong>RDP</strong>)<strong>.</strong> You will need this to log in to the server after creation. </li>
<li><strong>Save money</strong>: If you already have a valid Windows Server Datacenter license, you get a discount on this VM.</li>
</ul>
</li>
<li>Click <strong>Next: Disks</strong>.</li>
<li>Here, you can select the disk type. Keep the default as follows, which is <span class="packt_screen">Premium SSD</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/029e2366-cd9e-49eb-b197-5df6ddcfda7d.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Select disk type</div>
<ol start="6">
<li>Click<span> </span><strong>Next: <span class="packt_screen">Networking</span></strong>.</li>
</ol>
<ol start="7">
<li>In the <span class="packt_screen">Networking</span> blade, you can configure the virtual network. You can keep the default values for this machine as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e610ae0d-6521-44c2-989d-490e95404f31.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Set networking for VM</div>
<ol start="8">
<li>Click<span> </span><strong>Next: <span class="packt_screen">Management</span></strong>.</li>
</ol>
<p class="mce-root"/>
<ol start="9">
<li>In the <span class="packt_screen">Management</span> blade, you can configure monitoring, and create and select a storage account for monitoring. You can also assign a system-assigned managed identity, which can be used to authenticate to various Azure resources, such as Azure Key Vault, without storing any credentials in code. You can also enable auto shutdown in here as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/93e1efd4-147b-42c0-a193-1bd21d7f24f7.png" style="width:33.58em;height:46.17em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Set management features</div>
<ol start="10">
<li>We can now create the VM. Click <strong><span class="packt_screen">Review + create</span></strong> and the settings will be validated. After that, click <span class="packt_screen"><strong>Create</strong></span> to actually deploy the VM.</li>
</ol>
<div class="packt_tip"><span>The steps for deploying Linux VMs are similar to creating Windows VMs, so we are going to skip this in this demonstration. For more information on how to deploy Linux VMs from the Azure portal, you can refer to, <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-portal">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-portal</a>.</span></div>
<p>We have now deployed a Windows VM, placed it in an Availability Set, and looked at the networking, storage, and monitoring features, and capabilities for this VM. In the next section, we are going to deploy a Windows Server VM from PowerShell.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying a Windows VM from PowerShell</h1>
                </header>
            
            <article>
                
<p>In the next demonstration, we are going to create two Windows Server VMs from PowerShell and place them in an Availability Set. To do so you have to perform the following steps:</p>
<ol>
<li>First, we need to log in to the Azure account as follows:</li>
</ol>
<pre style="padding-left: 60px"><strong>Login-AzureRmAccount</strong></pre>
<ol start="2">
<li class="mce-root">If necessary, select the <span>right subscription as follows:</span></li>
</ol>
<pre style="color: black;padding-left: 60px"><strong>Select-AzureRmSubscription -SubscriptionId "********-****-****-****-***********"</strong></pre>
<ol start="3">
<li>Create a resource group for the Availability Set as follows:</li>
</ol>
<pre style="padding-left: 60px"><strong>New-AzResourceGroup -Name PacktVMResourceGroup -Location EastUS</strong></pre>
<ol start="4">
<li>Then, we c<span>an create an availability set for the VMs as follows:</span></li>
</ol>
<pre style="padding-left: 60px"><strong>New-AzAvailabilitySet `</strong><br/><strong>   -Location "EastUS" `</strong><br/><strong>   -Name "PacktVMAvailabilitySet" `</strong><br/><strong>   -ResourceGroupName PacktVMResourceGroup `</strong><br/><strong>   -Sku aligned `</strong><br/><strong>   -PlatformFaultDomainCount 2 `</strong><br/><strong>   -PlatformUpdateDomainCount 2</strong></pre>
<ol start="5">
<li>We have to set the administrator credentials for the VMs as follows:</li>
</ol>
<pre style="padding-left: 60px"><strong>$cred = Get-Credential</strong></pre>
<ol start="6">
<li>We can now create the two VMs inside the Availability Set as follows:</li>
</ol>
<pre style="padding-left: 60px"><strong> for ($i=1; $i -le 2; $i++)</strong><br/><strong>{</strong><br/><strong>    New-AzVm `</strong><br/><strong>        -ResourceGroupName PacktVMResourceGroup `</strong><br/><strong>        -Name "PacktVM$i" `</strong><br/><strong>        -Location "East US" `</strong><br/><strong>        -VirtualNetworkName "PacktVnet" `</strong><br/><strong>        -SubnetName "PacktSubnet" `</strong><br/><strong>        -SecurityGroupName "PacktNetworkSecurityGroup" `</strong><br/><strong>        -PublicIpAddressName "PacktPublicIpAddress$i" `</strong><br/><strong>        -AvailabilitySetName "PacktVMAvailabilitySet" `</strong><br/><strong>        -Credential $cred</strong><br/><strong>}</strong></pre>
<p><span>In the last two demonstrations, we created VMs inside an Availability Set from the Azure portal and PowerShell. In the next section, we are going to cover scale sets.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VM scale sets</h1>
                </header>
            
            <article>
                
<p>VM scale sets are used for deploying multiple VMs at once without the need for manual actions or using scripts. You can then manage them all at once from a single place. VM scale sets are typically used to build large-scale infrastructures, where keeping all of your VMs in sync is key. The maintenance of VMs, including keeping them in sync, is handled by Azure. VM scale sets use Availability Sets under the hood. VMs inside a scale set are automatically spread over the fault and update domains by the underlying platform. VM scale sets use Azure Autoscale by default. You can, however, add or remove instances yourself instead of using Autoscale.</p>
<p>When creating a scale set, a couple of artefacts are created for you automatically. As well as the number of VMs you have specified are added to the set, an Azure Load Balancer and Azure Autoscale are added, along with a virtual network and a public IP address, as shown in the following screenshot:</p>
<p class="mce-root"/>
<div class="CDPAlignCenter CDPAlign"><img src="assets/41dc19f5-9f21-45dd-b62c-d053b44c3112.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Azure VM scale set</div>
<p>In the next section, we are going to deploy and configure scale sets.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying and configuring scale sets</h1>
                </header>
            
            <article>
                
<p>To create a VM scale set from the Azure portal, take the following steps:</p>
<ol>
<li><span>Navigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a>.</li>
<li>Click on <span class="packt_screen">Create a resource</span> and type i<span>n</span> <kbd>Scale Set</kbd> <span>in the search bar. Select</span> <strong><span class="ext-gallery-details-header-displayname"><span class="packt_screen">Virtual machine scale se</span></span></strong><span class="packt_screen">t</span><span class="ext-gallery-details-header-displayname">.</span></li>
<li>In the next screen, click on <span class="packt_screen">Create</span> and add the following settings for creating the scale set:
<ul>
<li><strong>Virtual machine scale set name</strong>: <kbd>PacktScaleSet</kbd></li>
<li><strong>Operating system disk image</strong>: <span class="packt_screen">Windows Server 2016 Datacenter</span></li>
<li><strong>Subscription</strong>: Select a subscription</li>
<li><strong>Resource group</strong>: <kbd>PacktVMGroup</kbd></li>
<li><strong>Location</strong>: <span class="packt_screen">East US</span></li>
<li><strong>Availability zone</strong>: <span class="packt_screen">None</span></li>
<li><strong>Username</strong>: <kbd>SCPacktUser</kbd></li>
<li><strong>Password</strong>: Fill in a password</li>
<li><strong>Instance count</strong>: <kbd>2</kbd></li>
<li><strong>Instance size</strong>: <span class="packt_screen">Standard DS1 v2</span></li>
<li><strong>Use managed disks</strong>: <span class="packt_screen"><span class="packt_screen">Yes</span></span></li>
<li><strong>Enable scaling beyond 100 instances</strong>: <span class="packt_screen">No</span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/90ad840b-6871-4002-a0f7-5a986c20eeaf.png" style="width:27.92em;height:50.67em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Scale set</div>
<ol start="4">
<li>If you scroll down, you can configure the autoscale settings, you can choose between the different load balancing settings, and you can configure networking and monitoring capabilities as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8d0a868e-c416-4856-99b1-a97628064058.png" style="width:28.92em;height:47.92em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Scale set configuration settings</div>
<ol start="5">
<li>Click <strong><span class="packt_screen">Create</span></strong>. The scale set with the number of provided VMs in it is now deployed.</li>
</ol>
<p>In the next and last sections of this chapter, we are going to cover how to automate the deployment of VMs using ARM templates.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Modifying and deploying ARM templates</h1>
                </header>
            
            <article>
                
<p><span>ARM templates define the infrastructure and configuration of your Azure solution. Azure is managed by an API, which is called the Resource Manager or ARM API. You can use this API to deploy infrastructure as code and configure your Azure environment. This API can be called from various tooling and resources; you can do it using the Azure portal, PowerShell, CLI, by calling the API directly, and by creating ARM templates.</span></p>
<p><span>You can create an ARM template in JSON format and use this to repeatedly deploy your solution across your Azure environment in a consistent state. The template is processed by Resource Manager like any other request, and it will parse the template and convert the syntax into REST API operations for the appropriate resource providers. </span><span>The REST API uses the resources section inside the template to call the resource-specific APIs. An example of a resource provider is <kbd>Microsoft.Storage/storageAccounts</kbd>. </span></p>
<div class="packt_tip">Microsoft offers various predefined ARM templates that can be downloaded and deployed. You can download the quick start templates from GitHub, and deploy them directly from GitHub, or download them and make the necessary adjustments: <a href="https://github.com/Azure/azure-quickstart-templates">https://github.com/Azure/azure-quickstart-templates</a>.</div>
<p>In the next section, we are going to modify an ARM template in the Azure portal.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Modifying an ARM template</h1>
                </header>
            
            <article>
                
<p>In the demonstration, we are going to create <span>an </span>ARM template of a storage account it in the Azure portal. We are going to modify this template, so that it will generate a storage account name automatically. We will then deploy this template again and use it to create a new storage account from the Azure portal. Therefore, you have to take the following steps:</p>
<ol>
<li><span>Navigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a>.</li>
<li>In the left menu, select + <strong>Create a resource</strong>, then <strong>Storage</strong> and then <strong>Storage account</strong>.</li>
</ol>
<ol start="3">
<li>Add the following values:
<ul>
<li><strong>Subscription</strong>: Pick a subscription</li>
<li><strong>Resource group</strong>: Create a new one and call it <kbd>PacktARMResourceGroup</kbd></li>
<li><strong>Storage account name</strong>: <kbd>packtarm</kbd></li>
<li><strong>Location</strong>: <span class="packt_screen">(US) East US</span></li>
<li><strong>Performance</strong>: <span class="packt_screen">Standard</span></li>
<li><strong>Account kind</strong>: <span class="packt_screen">StorageV2 (general purpose v2)</span></li>
<li><strong>Replication</strong>: <span class="packt_screen">Read-access geo-redundant storage (RA-GRS)</span></li>
<li><strong>Access tier</strong><strong>:</strong> <span><span class="packt_screen">Hot</span></span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1d206643-8489-4d9c-b0b4-f2984d192f76.png" style="width:38.33em;height:37.08em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Create a new storage account</div>
<ol start="4">
<li>Click <strong>Review + create</strong>.<span> Do not select </span><strong>Create</strong>.</li>
<li><span>In the next step, but select <span class="packt_screen">Download a template for automation</span>:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/719a4de5-c47c-4a13-89c9-934689f6d2cf.png" style="width:37.58em;height:46.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Download template for automation<br/></span></div>
<ol start="6">
<li>The editor will be opened and the generated template will be displayed. <span>The main pane shows the template. It has six top-level elements: </span><kbd>schema</kbd>, <kbd>contentVersion</kbd>, <kbd>parameters</kbd>, <kbd>variables</kbd>, <kbd>resources</kbd>, and <kbd>output</kbd>. <span>There are also six parameters. The <kbd>storageAccountName</kbd> is highlighted in the following screenshot. In the template, one Azure resource is defined. The type is</span> <kbd>Microsoft.Storage/storageAccounts</kbd><span>. Select <strong>Download</strong> from the top menu:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/bd350a22-e162-4765-a1d7-543e6e1314cb.png" style="width:43.58em;height:43.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Main ARM template</div>
<ol start="7">
<li>Open the downlo<span>aded ZIP file, and then save </span><kbd>template.json</kbd><span> to your computer. In the next section, you use a template deployment tool to edit the template.</span></li>
<li>Select <strong>Parameters</strong> in the top menu, and look at the values. We will need this later during the deployment:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/37ea20fd-a538-417b-9f1b-529f0a3862e9.png" style="width:53.17em;height:41.67em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">ARM template parameters</div>
<ol start="9">
<li>The Azure portal can be used for basic editing of ARM templates. More complex ARM templates can be edited using Visual Studio Code, for instance. We are going to use the Azure portal for this demonstration. Therefore, select <strong>+ Create a resource</strong>, then in the search box type <kbd>Template Deployment</kbd>. Then select <strong>Create</strong>.</li>
<li>In the next blade, you have different options for loading templates. For this demonstration, select <strong>Build your own template in the editor</strong>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7f5665cd-6324-4f59-a328-8a85657983b9.png" style="width:21.75em;height:24.92em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Template options</div>
<ol start="11">
<li>Sele<span>ct </span><strong>Load file</strong><span>, and then follow the instructions to load the <kbd>template.json</kbd> that we have downloaded in the last section. Make the following changes:<br/></span>
<ol>
<li>Remove the <kbd>storageAccountName</kbd> parameter.</li>
<li>Add a new variable:</li>
</ol>
</li>
</ol>
<pre style="padding-left: 120px"><span class="hljs-string">"storageAccountName"</span><span>: </span><span class="hljs-string">"[concat(uniqueString(subscription().subscriptionId), 'storage')]"</span></pre>
<p class="mce-root"/>
<ol>
<li style="list-style-type: none">
<ol start="3">
<li>Replace <kbd>"name": "[parameters('storageAccountName')]"</kbd><span>, with </span><kbd>"name": "[variables('storageAccountName')]"</kbd><span><span class="hljs-string">:</span><br/></span></li>
</ol>
</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/27437052-e8c4-4e32-a3cd-4112961c803f.png" style="width:59.33em;height:54.42em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Make changes to the highlighted sections<br/></span></div>
<ol>
<li style="list-style-type: none">
<ol start="4">
<li>The code of the template will look as follows:</li>
</ol>
</li>
</ol>
<p style="padding-left: 150px">The <kbd>schema</kbd> and <kbd>parameters</kbd> sections:</p>
<pre style="padding-left: 120px">{<br/>    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",<br/>    "contentVersion": "1.0.0.0",<br/>    "parameters": {<br/>        "location": {<br/>            "type": "string"<br/>        },<br/>        "accountType": {<br/>            "type": "string"<br/>        },<br/>        "kind": {<br/>            "type": "string"<br/>        },<br/>        "accessTier": {<br/>            "type": "string"<br/>        },<br/>        "supportsHttpsTrafficOnly": {<br/>            "type": "bool"<br/>        }<br/>    },</pre>
<p style="padding-left: 150px">And the <kbd>variable</kbd> and <kbd>resources</kbd> section:</p>
<pre style="padding-left: 90px">    "variables": {<br/>        "storageAccountName": "[concat(uniqueString(subscription().subscriptionId), 'storage')]"<br/>    },<br/>    "resources": [<br/>        {<br/>            "name": "[variables('storageAccountName')]",<br/>            "type": "Microsoft.Storage/storageAccounts",<br/>            "apiVersion": "2018-07-01",<br/>            "location": "[parameters('location')]",<br/>            "properties": {<br/>                "accessTier": "[parameters('accessTier')]",<br/>                "supportsHttpsTrafficOnly": "[parameters('supportsHttpsTrafficOnly')]"<br/>            },<br/>            "dependsOn": [],<br/>            "sku": {<br/>                "name": "[parameters('accountType')]"<br/>            },<br/>            "kind": "[parameters('kind')]"<br/>        }<br/>    ],<br/>    "outputs": {}<br/>}</pre>
<p class="mce-root"/>
<ol start="5">
<li style="list-style-type: none">
<ol start="5">
<li>Then select <strong>Save.</strong></li>
</ol>
</li>
</ol>
<ol start="12">
<li>In the next screen, fill in the values for creating the storage account. You will see that the parameter for filling in the storage account name is removed. This will be generated automatically. Fill in the following values:
<ul>
<li><strong>Resource group</strong>: Select the resource group name you created in the previous section.</li>
<li><strong>Location</strong>: <span class="packt_screen">Central US</span></li>
<li><strong>Account type</strong>: <span class="packt_screen">Standard_LRS</span></li>
<li><strong>Kind</strong>: <span class="packt_screen">StorageV2</span></li>
<li><strong>Access Tier:</strong> <span class="packt_screen">Hot</span></li>
<li><strong>Https Traffic Only Enabled</strong>: <span class="packt_screen"><span class="packt_screen">true</span></span></li>
<li><strong>I agree to the terms and conditions stated above</strong>: Select this option:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e53cbef3-a6cd-4f40-bb76-3a50b35a95f8.png" style="width:42.75em;height:51.42em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Fill in values</div>
<ol start="13">
<li>Select <strong>Purchase</strong>.</li>
<li>The ARM template will now be deployed. After deployment, go to the <span class="packt_screen">Overview</span> blade of the resource group. You will see that the storage account name is automatically generated for you:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6913afbc-83f7-4e9e-9ec8-09ee52ca0da3.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Storage account name</div>
<div class="packt_tip">For more information about the syntax and structure of ARM templates, you can refer to the following website: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates</a>.</div>
<p>We have now modified an ARM template in the Azure portal and created a new storage account using the modified ARM templates. In the next demonstration, we are going to save a deployment as an ARM template.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Save a deployment as an ARM template</h1>
                </header>
            
            <article>
                
<p>For this demonstration, we are going to save a deployment as an ARM template from the Azure portal. We are going to export the template of the two VMs that we created in an Availability Set using PowerShell.</p>
<p>Once downloaded, you can then make changes to it, and redeploy it in Azure using PowerShell or code. The generated ARM template consists of a large amount of code, which makes it very difficult to make changes to it. For saving a deployment as an ARM template, take the following steps:</p>
<ol>
<li><span>Navigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a>.</li>
<li>Open the resource group that we created in the previous demonstration and under <span><span class="packt_screen">Settings</span>,</span> <span>select the <span class="packt_screen">Export template</span> as follows:</span> </li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/ca711df4-48f3-4651-bd3a-431d18f90f2e.png"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Export template</span></div>
<ol start="3">
<li>The template is generated for you based on the settings that we made during the creation of the different resources. You can download the template and redeploy it from here. You can also download the scripts for CLI, PowerShell, .NET, and Ruby, and create the different resources using these programming languages. Select <span class="packt_screen"><strong>Download</strong></span> from the top menu as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3505ba7f-8dd3-4191-82a3-a60d06f1091e.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Download template</div>
<p style="padding-left: 60px">The template is downloaded as a ZIP file to your local filesystem. </p>
<ol start="4">
<li>You can now extract the template files from the ZIP file and open them in <span>Visual Studio Code. If you don't have this installed, you can use the download link provided at the beginning of this chapter or use Notepad, or some other text editing tool. The ZIP file contains three different deployment files, created in different languages. There is one each for PowerShell, CLI, and Ruby. It also consists of a <kbd>DeploymentHelper.cs</kbd> file, a <kbd>parameters.json</kbd> file, and a <kbd>template.json</kbd> file.</span></li>
</ol>
<ol start="5">
<li>In Visual Studio Code, you can make all the modifications to the parameters and template file that are needed. If you then want to deploy the template again to Azure, use one of the deployment files inside the container. In the case of PowerShell, right-click on <kbd>deploy.ps1</kbd> and select <strong><span class="packt_screen">Run with PowerShell</span></strong>. Fill in the subscription ID, provide the resource group name and deployment name, and log in using your Azure credentials. This will start the deployment.</li>
</ol>
<div class="packt_tip">Creating ARM templates can be part of the exam questions, so I strongly advise you to take the time to familiarize yourself with the syntax and the code blocks that are part of the templates.  </div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we covered the first part of the <em>Deploying and Managing Virtual Machines</em> objective by covering how to create and configure VMs for Windows and Linux. You learned about the various aspects and parts that are created when you deploy a VM in Azure. We also covered how to automate the deployment of VMs using scale sets and ARM templates.</span></p>
<p>In the next chapter, we will continue with the second part of the <em>Deploying and Managing Virtual Machines</em> objective by covering how to manage Azure VMs and VM backups.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em><span> section at the end of this book:</span></p>
<ol>
<li>Can you use VM scale sets to automate the deployment of multiple VMs?
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
<li>Can you use availability sets for spreading VMs across update and fault domains?
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>
<ol start="3">
<li>Do you have to define resource providers in your ARM templates to deploy the various resources in Azure?
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check out the following links for more information about the topics that were covered in this chapter:</span></p>
<ul>
<li><em>Linux Virtual Machines</em>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/</a></li>
<li><em>Quickstart: Create a Linux virtual machine in the Azure portal</em>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-portal">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-portal</a></li>
<li><em>Virtual Machine Scale Sets Documentation</em>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/">https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/</a></li>
<li><em>Manage the availability of Windows virtual machines in Azure</em>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability</a></li>
<li><em>Azure Resource Manager overview</em>: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview</a></li>
<li><em>Understand the structure and syntax of Azure Resource Manager templates</em>: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authoring-templates</a></li>
<li><em>Quickstart: Create and deploy Azure Resource Manager templates by using the Azure portal</em>: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal?toc=%2Fazure%2Ftemplates%2Ftoc.json&amp;bc=%2Fazure%2Ftemplates%2Fbreadcrumb%2Ftoc.json">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal?toc=%2Fazure%2Ftemplates%2Ftoc.json&amp;bc=%2Fazure%2Ftemplates%2Fbreadcrumb%2Ftoc.json</a></li>
<li><em>Deploy resources with Resource Manager templates and Azure PowerShell</em>: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-deploy">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-deploy</a></li>
<li><em>Azure Quickstart Templates</em>: <a href="https://azure.microsoft.com/en-us/resources/templates/">https://azure.microsoft.com/en-us/resources/templates/</a></li>
<li><em>Define resources in Azure Resource Manager templates</em>: <a href="https://docs.microsoft.com/en-us/azure/templates/">https://docs.microsoft.com/en-us/azure/templates/</a></li>
</ul>


            </article>

            
        </section>
    </body></html>