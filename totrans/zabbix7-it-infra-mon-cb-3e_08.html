<html><head></head><body>
<div id="_idContainer510" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-259"><a id="_idTextAnchor1490" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-260" class="calibre5"><a id="_idTextAnchor1491" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.2.1"> Setting Up Zabbix Proxies</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">You can’t preach about Zabbix without actually preaching about the use of Zabbix </span><strong class="bold"><span class="kobospan" id="kobo.4.1">proxies</span></strong><span class="kobospan" id="kobo.5.1"> – a nice addition at first, but a no-brainer by now. </span><span class="kobospan" id="kobo.5.2">Anyone who’s expecting to set up a Zabbix environment of a medium/larger size will need proxies. </span><span class="kobospan" id="kobo.5.3">The main reason to use proxies is scalability, as Zabbix proxies offload the data collection and preprocessing load from the Zabbix server. </span><span class="kobospan" id="kobo.5.4">This way, we can scale up our Zabbix environment further and with greater ease. </span><span class="kobospan" id="kobo.5.5">Furthermore, proxies can provide an additional layer of security by collecting data in a local network and then sending it to the Zabbix server, splitting your data collection access requirements between hosts instead of consolidating it on a single </span><span><span class="kobospan" id="kobo.6.1">Zabbix server.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.7.1">In this chapter, we will first learn how to set up a Zabbix proxy. </span><span class="kobospan" id="kobo.7.2">We will then learn how to work with passive and active Zabbix proxies, and also how to monitor hosts with either form of the Zabbix proxy. </span><span class="kobospan" id="kobo.7.3">Zabbix 7 also introduces the possibility of adding proxies in a load-balancing pool together, which we will also discover in this chapter. </span><span class="kobospan" id="kobo.7.4">We will also cover some Zabbix network discovery using the proxies, and we’ll learn how to monitor Zabbix proxies to keep them healthy. </span><span class="kobospan" id="kobo.7.5">After these recipes, you’ll have no more excuses for not setting up the proxies, as we’ll cover most of the possible forms of proxy use in </span><span><span class="kobospan" id="kobo.8.1">this chapter.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.9.1">So, let’s go through the following recipes and check out how to work with </span><span><span class="kobospan" id="kobo.10.1">Zabbix proxies:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.11.1">Setting up a </span><span><span class="kobospan" id="kobo.12.1">Zabbix proxy</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.13.1">Working with passive </span><span><span class="kobospan" id="kobo.14.1">Zabbix proxies</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.15.1">Working with active </span><span><span class="kobospan" id="kobo.16.1">Zabbix proxies</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.17.1">Monitoring hosts with a </span><span><span class="kobospan" id="kobo.18.1">Zabbix proxy</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.19.1">Encrypting your Zabbix proxy connection with </span><span><span class="kobospan" id="kobo.20.1">pre-shared keys</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.21.1">Setting up Zabbix proxy </span><span><span class="kobospan" id="kobo.22.1">load balancing</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.23.1">Using discovery with </span><span><span class="kobospan" id="kobo.24.1">Zabbix proxies</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.25.1">Monitoring your </span><span><span class="kobospan" id="kobo.26.1">Zabbix proxies</span></span></li>
</ul>
<h1 id="_idParaDest-261" class="calibre5"><a id="_idTextAnchor1492" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1493" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.27.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.28.1">We are going to need several new Linux hosts for this chapter, as we’ll be building them as </span><span><span class="kobospan" id="kobo.29.1">Zabbix proxies.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.30.1">Set up two proxies by installing your preferred RHEL-based or Ubuntu Linux distribution on the following two </span><span><span class="kobospan" id="kobo.31.1">new hosts:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.32.1">lar-book-proxy-passive</span></strong></span></li>
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.33.1">lar-book-proxy-active</span></strong></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.34.1">You’ll also need the Zabbix server, with at least one monitored host. </span><span class="kobospan" id="kobo.34.2">We’ll be using the following new host to monitor with a Zabbix </span><span><span class="kobospan" id="kobo.35.1">agent installed:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.36.1">
lar-book-agent-by-proxy</span></pre> <h1 id="_idParaDest-262" class="calibre5"><a id="_idTextAnchor1494" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1495" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.37.1">Setting up a Zabbix proxy</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.38.1">Setting up </span><a id="_idTextAnchor1496" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.39.1">a Zabbix proxy can be quite daunting if you </span><a id="_idIndexMarker598" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.40.1">don’t have a lot of experience with Linux, but the task is quite simple once you get the hang of it. </span><span class="kobospan" id="kobo.40.2">We will install a Zabbix proxy on our </span><strong class="source-inline"><span class="kobospan" id="kobo.41.1">lar-book-proxy-passive</span></strong><span class="kobospan" id="kobo.42.1"> server; you can repeat the task </span><span><span class="kobospan" id="kobo.43.1">on </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.44.1">lar-book-proxy-active</span></strong></span><span><span class="kobospan" id="kobo.45.1">.</span></span><a id="_idTextAnchor1497" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1498" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-263" class="calibre7"><a id="_idTextAnchor1499" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.46.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.47.1">Make sure to have a new empty Linux host, with your distribution of choice ready and installed. </span><span class="kobospan" id="kobo.47.2">We won’t need our Zabbix server in this </span><span><span class="kobospan" id="kobo.48.1">recipe yet.</span></span><a id="_idTextAnchor1500" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1501" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-264" class="calibre7"><a id="_idTextAnchor1502" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.49.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.50.1">Let’s start by</span><a id="_idTextAnchor1503" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.51.1"> logging in</span><a id="_idIndexMarker599" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.52.1"> to the </span><strong class="bold"><span class="kobospan" id="kobo.53.1">command-line interface</span></strong><span class="kobospan" id="kobo.54.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.55.1">CLI</span></strong><span class="kobospan" id="kobo.56.1">) of our new </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.57.1">lar-book-proxy-passive</span></strong></span><span><span class="kobospan" id="kobo.58.1"> host.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.59.1">Now, execute the following command to add the Zabbix repository. </span><span class="kobospan" id="kobo.59.2">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.60.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.61.1">rpm -Uvh https://repo.zabbix.com/zabbix/7.0/rhel/8/ x86_64/zabbix-release-7.0-1.el8.noarch.rpm</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.62.1">dnf clean all</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.63.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.64.1">the following:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.65.1">wget https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/ main/z/zabbix-release/zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.66.1">dpkg -i zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.67.1">apt update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.68.1">Now, instal</span><a id="_idTextAnchor1504" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.69.1">l the Zabbix proxy by executing the </span><span><span class="kobospan" id="kobo.70.1">following command.</span></span><p class="calibre3"><span class="kobospan" id="kobo.71.1">RHEL-based systems, use </span><span><span class="kobospan" id="kobo.72.1">the following:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.73.1">dnf install zabbix-proxy-sqlite3 zabbix-selinux-policy</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.74.1">Ubuntu systems, use </span><span><span class="kobospan" id="kobo.75.1">the</span></span><span><a id="_idIndexMarker600" class="pcalibre calibre6 pcalibre1"/></span><span><span class="kobospan" id="kobo.76.1"> following:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.77.1">apt install zabbix-proxy-sqlite3</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.78.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.79.1">On RHEL-bas</span><a id="_idTextAnchor1505" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.80.1">ed servers, don’t forget to set </span><strong class="bold"><span class="kobospan" id="kobo.81.1">Security-Enhanced Linux</span></strong><span class="kobospan" id="kobo.82.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.83.1">SELinux</span></strong><span class="kobospan" id="kobo.84.1">) to permissive or allow Zabbix proxy in </span><a id="_idIndexMarker601" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.85.1">SELinux for production. </span><span class="kobospan" id="kobo.85.2">For lab environments, it is fine to set SELinux to permissive, but in production, I would recommend leaving it enabled. </span><span class="kobospan" id="kobo.85.3">For Ubuntu systems, in a lab environment, we can </span><span><span class="kobospan" id="kobo.86.1">disable AppArmor.</span></span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.87.1">Now, edit the Zabbix proxy configuration by executing the </span><span><span class="kobospan" id="kobo.88.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.89.1">vim /etc/zabbix/zabbix_proxy.conf</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.90.1">Let’s start by setting the proxy mode on the </span><strong class="source-inline"><span class="kobospan" id="kobo.91.1">passive</span></strong><span class="kobospan" id="kobo.92.1"> proxy. </span><span class="kobospan" id="kobo.92.2">The mode will be </span><strong class="source-inline"><span class="kobospan" id="kobo.93.1">1</span></strong><span class="kobospan" id="kobo.94.1"> on this proxy. </span><span class="kobospan" id="kobo.94.2">On the </span><strong class="source-inline"><span class="kobospan" id="kobo.95.1">active</span></strong><span class="kobospan" id="kobo.96.1"> proxy, this will </span><span><span class="kobospan" id="kobo.97.1">be </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.98.1">0</span></strong></span><span><span class="kobospan" id="kobo.99.1">:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.100.1">ProxyMode=1</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.101.1">Change the following line to your Zabbix </span><span><span class="kobospan" id="kobo.102.1">server address:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.103.1">Server=10.16.16.152</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.104.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.105.1">When working w</span><a id="_idTextAnchor1506" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.106.1">ith a Zabbix server in </span><strong class="bold"><span class="kobospan" id="kobo.107.1">high availability</span></strong><span class="kobospan" id="kobo.108.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.109.1">HA</span></strong><span class="kobospan" id="kobo.110.1">), make sure to add the Zabbix server IP addresses here for</span><a id="_idIndexMarker602" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.111.1"> every single node in your cluster. </span><span class="kobospan" id="kobo.111.2">The proxy will only be sending data to the active node. </span><span class="kobospan" id="kobo.111.3">Keep in mind that HA nodes are delimited by a semi-colon (</span><strong class="source-inline1"><span class="kobospan" id="kobo.112.1">;</span></strong><span class="kobospan" id="kobo.113.1">) instead of a </span><span><span class="kobospan" id="kobo.114.1">comma (</span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.115.1">,</span></strong></span><span><span class="kobospan" id="kobo.116.1">).</span></span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.117.1">Change the following</span><a id="_idIndexMarker603" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.118.1"> line to your </span><span><span class="kobospan" id="kobo.119.1">proxy hostname:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.120.1">Hostname=lar-book-proxy-passive</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.121.1">As </span><a id="_idTextAnchor1507" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.122.1">we’ll be using the </span><strong class="source-inline"><span class="kobospan" id="kobo.123.1">sqlite</span></strong><span class="kobospan" id="kobo.124.1"> version of the proxy for the example, change the </span><strong class="source-inline"><span class="kobospan" id="kobo.125.1">DBName</span></strong><span class="kobospan" id="kobo.126.1"> parameter to </span><span><span class="kobospan" id="kobo.127.1">the following:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.128.1">DBName=/tmp/zabbix_proxy.sqlite3</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.129.1">You can now enable the Zabbix proxy and start it with the following </span><span><span class="kobospan" id="kobo.130.1">two commands:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.131.1">systemctl enable zabbix-proxy</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.132.1">systemctl start zabbix-proxy</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.133.1">You should want to check that the Zabbix proxy logs are not showing any errors, with the </span><span><span class="kobospan" id="kobo.134.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.135.1">tail -f /var/log/zabbix/zabbix_prox</span><a id="_idTextAnchor1508" class="pcalibre calibre18 pcalibre1"/><a id="_idTextAnchor1509" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.136.1">y.log</span></strong></pre></li> </ol>
<h2 id="_idParaDest-265" class="calibre7"><a id="_idTextAnchor1510" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.137.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.138.1">Ther</span><a id="_idTextAnchor1511" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.139.1">e are three versions of Zabbix proxy to </span><span><span class="kobospan" id="kobo.140.1">work with:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.141.1">zabbix-proxy-mysql</span></strong></span></li>
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.142.1">zabbix-proxy-pgsql</span></strong></span></li>
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.143.1">zabbix-proxy-sqlite3</span></strong></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.144.1">We’ve</span><a id="_idTextAnchor1512" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.145.1"> just done the setup for the </span><strong class="source-inline"><span class="kobospan" id="kobo.146.1">zabbix-proxy-sqlite3</span></strong><span class="kobospan" id="kobo.147.1"> package, which is the easiest method if you ask me. </span><span class="kobospan" id="kobo.147.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.148.1">sqlite3</span></strong><span class="kobospan" id="kobo.149.1"> version of Zabbix proxy makes it possible for us to set up a Zabbix proxy with great ease as we don’t actually need to worry too much about database setup</span><a id="_idIndexMarker604" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.150.1">and maintenance.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.151.1">Please do note that the </span><strong class="source-inline"><span class="kobospan" id="kobo.152.1">sqlite3</span></strong><span class="kobospan" id="kobo.153.1"> versions might not be suited to Zabbix proxies with a very high load as </span><strong class="source-inline"><span class="kobospan" id="kobo.154.1">sqlite3</span></strong><span class="kobospan" id="kobo.155.1"> cannot be further scaled up. </span><span class="kobospan" id="kobo.155.2">You get more options to scale a </span><strong class="source-inline"><span class="kobospan" id="kobo.156.1">mysql</span></strong><span class="kobospan" id="kobo.157.1"> or </span><strong class="source-inline"><span class="kobospan" id="kobo.158.1">postgresql</span></strong><span class="kobospan" id="kobo.159.1"> database when using Zabbix proxy by the fine-tuning mechanisms available in those database types. </span><span class="kobospan" id="kobo.159.2">However, since the idea behind proxies in most cases is dividing the load between proxies, I find it easier to add the SQLite3 proxy once my database has reached </span><span><span class="kobospan" id="kobo.160.1">its capacity.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.161.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.162.1">Always pick the right type of Zabbix proxy for what you expect to need in the future. </span><span class="kobospan" id="kobo.162.2">Although it is easy to switch proxies later, don’t go too easy on this choice as you might save yourself hours in </span><span><span class="kobospan" id="kobo.163.1">the future.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.164.1">The a</span><a id="_idTextAnchor1513" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.165.1">mazing part about the </span><strong class="source-inline"><span class="kobospan" id="kobo.166.1">sqlite3</span></strong><span class="kobospan" id="kobo.167.1"> version is that if we run into database issues, it’s very easy to just remove the database by running </span><span><span class="kobospan" id="kobo.168.1">the following:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.169.1">
rm /tmp/zabbix_proxy.sqlite3</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.170.1">With this, the </span><strong class="source-inline"><span class="kobospan" id="kobo.171.1">sqlite3</span></strong><span class="kobospan" id="kobo.172.1"> Zabbix proxy then automatically creates a new database on startup, and we’re all ready to start collecting again. </span><span class="kobospan" id="kobo.172.2">Do note that we might lose some information that is in the proxy database though, which functions as a cache that might contain data still to be sent to Zabbix. </span><span class="kobospan" id="kobo.172.3">If the data hasn’t been sent to Zabbix yet and you delete the database, that’s when you will lose the metrics still in </span><span><span class="kobospan" id="kobo.173.1">the database.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.174.1">In Zabbix 7, however, the proxy database concept has been changed slightly, by the addition of an in-memory cache. </span><span class="kobospan" id="kobo.174.2">By default, proxies in Zabbix 7 will now run in one of </span><span><span class="kobospan" id="kobo.175.1">three modes:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.176.1">Hybrid (default for </span><span><span class="kobospan" id="kobo.177.1">new installations)</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.178.1">Memory</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.179.1">Disk (default for </span><span><span class="kobospan" id="kobo.180.1">existing installations)</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.181.1">We can adjust this setting by editing </span><strong class="source-inline"><span class="kobospan" id="kobo.182.1">ProxyBufferMode=</span></strong><span class="kobospan" id="kobo.183.1"> in the Zabbix proxy </span><span><span class="kobospan" id="kobo.184.1">configuration file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.185.1">This means that a Zabbix proxy will now buffer metrics to be sent in memory instead of in the database by default. </span><span class="kobospan" id="kobo.185.2">This is only in the case that the Zabbix proxy memory cache is full with the proxy start buffering</span><a id="_idIndexMarker605" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.186.1"> data to </span><span><span class="kobospan" id="kobo.187.1">the database.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.188.1">One last thing to keep in mind is that, in hybrid mode, we can still restart the Zabbix proxy safely; however, upon restarting, the Zabbix proxy process data will be flushed into the database. </span><span class="kobospan" id="kobo.188.2">In memory mode, however, this is not the cache and data will be lost upon restarting the Zabbix </span><span><span class="kobospan" id="kobo.189.1">proxy p</span><a id="_idTextAnchor1514" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1515" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.190.1">rocess.</span></span></p>
<h2 id="_idParaDest-266" class="calibre7"><span class="kobospan" id="kobo.191.1">There’s mor</span><a id="_idTextAnchor1516" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.192.1">e…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.193.1">More information about installing Zabbix proxies can be </span><span><span class="kobospan" id="kobo.194.1">found here:</span></span></p>
<p class="calibre3"><a href="https://www.zabbix.com/documentation/current/manual/installation/install_from_packages" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.195.1">https://www.zabbix.com/documentation/current/manual/installation/install_from_packages</span></span></a></p>
<p class="calibre3"><span class="kobospan" id="kobo.196.1">Choose the distribution you are using, and you can find the guides for all the different variants of </span><span><span class="kobospan" id="kobo.197.1">proxy install</span><a id="_idTextAnchor1517" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1518" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.198.1">ations.</span></span></p>
<h1 id="_idParaDest-267" class="calibre5"><a id="_idTextAnchor1519" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.199.1">Working with passive Zabbix proxies</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.200.1">N</span><a id="_idTextAnchor1520" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.201.1">ow that we have installed our Zabbix proxy in the previous recipe, we can start working with it. </span><span class="kobospan" id="kobo.201.2">Let’s start by setting up </span><a id="_idIndexMarker606" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.202.1">our passive Zabbix proxy in the frontend and see what we can do with it from </span><span><span class="kobospan" id="kobo.203.1">th</span><a id="_idTextAnchor1521" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1522" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.204.1">e start.</span></span></p>
<h2 id="_idParaDest-268" class="calibre7"><a id="_idTextAnchor1523" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.205.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.206.1">You will need the </span><strong class="source-inline"><span class="kobospan" id="kobo.207.1">lar-book-proxy-passive</span></strong><span class="kobospan" id="kobo.208.1"> host for this recipe ready and installed with Zabbix proxy. </span><span class="kobospan" id="kobo.208.2">We will also be using our Zabbix server in this </span><span><span class="kobospan" id="kobo.209.1">recip</span><a id="_idTextAnchor1524" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1525" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.210.1">e again.</span></span></p>
<h2 id="_idParaDest-269" class="calibre7"><span class="kobospan" id="kobo.211.1">How to do i</span><a id="_idTextAnchor1526" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.212.1">t…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.213.1">Let’s start by logging in to our Zabbix frontend and navigating to </span><strong class="bold"><span class="kobospan" id="kobo.214.1">Administration</span></strong><span class="kobospan" id="kobo.215.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.216.1">P</span><a id="_idTextAnchor1527" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.217.1">roxies</span></strong></span><span><span class="kobospan" id="kobo.218.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer468">
<span class="kobospan" id="kobo.219.1"><img alt="Figure 8.1 – Administration | Proxies page, without proxies" src="image/B18275_08_001.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.220.1">Figure 8.1 – Administration | Proxies page, without proxies</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.221.1">Our </span><strong class="bold"><span class="kobospan" id="kobo.222.1">Proxies</span></strong><span class="kobospan" id="kobo.223.1"> page is where we do all frontend </span><span><span class="kobospan" id="kobo.224.1">proxy-related configuration.</span></span></p>
<ol class="calibre16">
<li value="2" class="calibre15"><span class="kobospan" id="kobo.225.1">Let’s add a new proxy with the blue </span><strong class="bold"><span class="kobospan" id="kobo.226.1">Create proxy</span></strong><span class="kobospan" id="kobo.227.1"> button in the </span><span><span class="kobospan" id="kobo.228.1">top-right corner.</span></span><p class="calibre3"><span class="kobospan" id="kobo.229.1">This will show us</span><a id="_idIndexMarker607" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.230.1"> to the </span><strong class="bold"><span class="kobospan" id="kobo.231.1">Create proxy</span></strong><span class="kobospan" id="kobo.232.1"> popup, where we will fill out the </span><span><span class="kobospan" id="kobo.233.1">following infor</span><a id="_idTextAnchor1528" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.234.1">mation:</span></span></p></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer469">
<span class="kobospan" id="kobo.235.1"><img alt="Figure 8.2 – Administration | Proxies, Create proxy popup, lar-book-proxy-passive﻿" src="image/B19803_08_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.236.1">Figure 8.2 – Administration | Proxies, Create proxy popup, lar-book-proxy-passive</span><a id="_idTextAnchor1529" class="pcalibre calibre6 pcalibre1"/></p>
<p class="calibre3"><span class="kobospan" id="kobo.237.1">Before clicking the blue </span><strong class="bold"><span class="kobospan" id="kobo.238.1">Add</span></strong><span class="kobospan" id="kobo.239.1"> button, let’s take a look at the </span><span><strong class="bold"><span class="kobospan" id="kobo.240.1">Encryptio</span><a id="_idTextAnchor1530" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.241.1">n</span></strong></span><span><span class="kobospan" id="kobo.242.1"> tab:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer470">
<span class="kobospan" id="kobo.243.1"><img alt="Figure 8.3 – Administration | Proxies, Create proxy popup Encryption tab, lar-book-proxy-passive" src="image/B19803_08_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.244.1">Figure 8.3 – Administration | Proxies, Create proxy popup Encryption tab, lar-book-proxy-passive</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.245.1">By default, </span><strong class="bold"><span class="kobospan" id="kobo.246.1">No encryption</span></strong><span class="kobospan" id="kobo.247.1"> is </span><a id="_idIndexMarker608" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.248.1">checked here, which we’ll address in another recipe. </span><span class="kobospan" id="kobo.248.2">For now, leave it set to </span><span><strong class="bold"><span class="kobospan" id="kobo.249.1">No encryption</span></strong></span><span><span class="kobospan" id="kobo.250.1">.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.251.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.252.1">A lot of valuable information is exchanged between Zabbix servers and Zabbix proxies. </span><span class="kobospan" id="kobo.252.2">If you are working with insecure networks or just need an extra layer of security, use Zabbix proxy encryption. </span><a id="_idTextAnchor1531" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.253.1">You can find more</span><a id="_idIndexMarker609" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.254.1"> information on Zabbix encryption </span><span><span class="kobospan" id="kobo.255.1">here: </span></span><a href="https://www.zabbix.com/documentation/current/en/manual/encryption" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.256.1">https://www.zabbix.com/documentation/current/en/manual/encryption</span></span></a><span><span class="kobospan" id="kobo.257.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.258.1">Before we move on, there’s one more tab in our Zabbix proxy creation popup that we need to have a look at – </span><span><strong class="bold"><span class="kobospan" id="kobo.259.1">Timeouts</span></strong></span><span><span class="kobospan" id="kobo.260.1">:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer471">
<span class="kobospan" id="kobo.261.1"><img alt="Figure 8.4 – Administration | Proxies, Create proxy popup Timeouts tab, lar-book-proxy-passive" src="image/B19803_08_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.262.1">Figure 8.4 – Administration | Proxies, Create proxy popup Timeouts tab, lar-book-proxy-passive</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.263.1">We won’t change anything on the </span><strong class="bold"><span class="kobospan" id="kobo.264.1">Timeouts</span></strong><span class="kobospan" id="kobo.265.1"> tab here, but since Zabbix 7, it is possible to override global timeouts for various types of item checks, allowing us to significantly tweak our Zabbix setup to</span><a id="_idIndexMarker610" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.266.1"> avoid timeout </span><span><span class="kobospan" id="kobo.267.1">performance issues.</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.268.1">Now, click the blue </span><strong class="bold"><span class="kobospan" id="kobo.269.1">Add</span></strong><span class="kobospan" id="kobo.270.1"> button, which will take us back to our proxy </span><span><span class="kobospan" id="kobo.271.1">overview page.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.272.1">The </span><strong class="bold"><span class="kobospan" id="kobo.273.1">Last seen (age)</span></strong><span class="kobospan" id="kobo.274.1"> part of your newly added proxy should now show a time value, instead </span><span><span class="kobospan" id="kobo.275.1">of</span><a id="_idTextAnchor1532" class="pcalibre calibre6 pcalibre1"/> </span><span><strong class="bold"><span class="kobospan" id="kobo.276.1">Never</span></strong></span><span><span class="kobospan" id="kobo.277.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer472">
<span class="kobospan" id="kobo.278.1"><img alt="Figure 8.5 – Administration | Proxies page, Last see﻿﻿n (age)" src="image/B19803_08_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.279.1">Figure 8.5 – Administration | Proxies page, Last see</span><a id="_idTextAnchor1533" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1534" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.280.1">n (age)</span></p>
<h2 id="_idParaDest-270" class="calibre7"><span class="kobospan" id="kobo.281.1">How it works…</span><a id="_idTextAnchor1535" class="pcalibre calibre6 pcalibre1"/></h2>
<p class="calibre3"><span class="kobospan" id="kobo.282.1">Adding proxies isn’t the hardest task </span><a id="_idIndexMarker611" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.283.1">after we’ve already done the installation part. </span><span class="kobospan" id="kobo.283.2">After the steps we took in this recipe, we are ready to start monitoring with </span><span><span class="kobospan" id="kobo.284.1">this proxy.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.285.1">The proxy we just added is a </span><strong class="bold"><span class="kobospan" id="kobo.286.1">passive proxy</span></strong><span class="kobospan" id="kobo.287.1">. </span><span class="kobospan" id="kobo.287.2">These</span><a id="_idIndexMarker612" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.288.1"> proxies work by receiving configuration from the Zabbix server, which the Zabbix server sends to the Zabbix proxy on </span><span><span class="kobospan" id="kobo.289.1">por</span><a id="_idTextAnchor1536" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.290.1">t </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.291.1">10051</span></strong></span><span><span class="kobospan" id="kobo.292.1">:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer473">
<span class="kobospan" id="kobo.293.1"><img alt="Figure 8.6 – Diagram showing an active proxy connection" src="image/B19803_08_06.JPG" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.294.1">Figure 8.6 – Diagram showing an active proxy connection</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.295.1">Once the passive proxy knows what to monitor, every time the Zabbix server polls for data, data is sent back within the same TCP connection. </span><span class="kobospan" id="kobo.295.2">This means that the connection is always initiated from the Zabbix server side. </span><span class="kobospan" id="kobo.295.3">Once it’s set up, the Zabbix server will keep sending configuration changes and it will keep polling for </span><span><span class="kobospan" id="kobo.296.1">n</span><a id="_idTextAnchor1537" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1538" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.297.1">ew data.</span></span></p>
<h1 id="_idParaDest-271" class="calibre5"><span class="kobospan" id="kobo.298.1">Working with active Zabbix proxie</span><a id="_idTextAnchor1539" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.299.1">s</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.300.1">We now know how to install and add proxies. </span><span class="kobospan" id="kobo.300.2">Let’s set </span><a id="_idIndexMarker613" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.301.1">up our active proxy, like we did with the passive proxy in the previous recipe, and see how </span><a id="_idTextAnchor1540" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1541" class="pcalibre calibre6 pcalibre1"/><span><span class="kobospan" id="kobo.302.1">it works.</span></span></p>
<h2 id="_idParaDest-272" class="calibre7"><a id="_idTextAnchor1542" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.303.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.304.1">You will need the </span><strong class="source-inline"><span class="kobospan" id="kobo.305.1">lar-book-proxy-active</span></strong><span class="kobospan" id="kobo.306.1"> host for this recipe, ready and installed with Zabbix proxy, as set up in the first recipe of this chapter. </span><span class="kobospan" id="kobo.306.2">We will also be using our Zabbix server in </span><span><span class="kobospan" id="kobo.307.1">thi</span><a id="_idTextAnchor1543" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1544" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.308.1">s recipe.</span></span></p>
<h2 id="_idParaDest-273" class="calibre7"><a id="_idTextAnchor1545" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.309.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.310.1">Le</span><a id="_idTextAnchor1546" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.311.1">t’s start by logging in to our Zabbix frontend and navigating to </span><strong class="bold"><span class="kobospan" id="kobo.312.1">Administration</span></strong><span class="kobospan" id="kobo.313.1"> | </span><a id="_idTextAnchor1547" class="pcalibre calibre6 pcalibre1"/><span><strong class="bold"><span class="kobospan" id="kobo.314.1">Proxies</span></strong></span><span><span class="kobospan" id="kobo.315.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer474">
<span class="kobospan" id="kobo.316.1"><img alt="Figure 8.7 – Administration | Proxies page, no active proxies" src="image/B18275_08_001.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.317.1">Figure 8.7 – Administration | Proxies page, no active proxies</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.318.1">Our </span><strong class="bold"><span class="kobospan" id="kobo.319.1">Proxies</span></strong><span class="kobospan" id="kobo.320.1"> page is where</span><a id="_idIndexMarker614" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.321.1"> we do all configurations that are </span><span><span class="kobospan" id="kobo.322.1">proxy related.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.323.1">Let’s add a new proxy by clicking the blue </span><strong class="bold"><span class="kobospan" id="kobo.324.1">Create proxy</span></strong><span class="kobospan" id="kobo.325.1"> button in the </span><span><span class="kobospan" id="kobo.326.1">top-right corner.</span></span></p>
<ol class="calibre16">
<li value="2" class="calibre15"><span class="kobospan" id="kobo.327.1">This will open the </span><strong class="bold"><span class="kobospan" id="kobo.328.1">Create proxy</span></strong><span class="kobospan" id="kobo.329.1"> popup, where we will fill out the </span><span><span class="kobospan" id="kobo.330.1">following info</span><a id="_idTextAnchor1548" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.331.1">rmation:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer475">
<span class="kobospan" id="kobo.332.1"><img alt="Figure 8.8 – Administration | Proxies, Create proxy popup, lar-book-proxy-active" src="image/B19803_08_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.333.1">Figure 8.8 – Administration | Proxies, Create proxy popup, lar-book-proxy-active</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.334.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.335.1">The </span><strong class="bold"><span class="kobospan" id="kobo.336.1">Proxy address</span></strong><span class="kobospan" id="kobo.337.1"> field is actually optional for our active proxy. </span><span class="kobospan" id="kobo.337.2">You do not have to add this for the Zabbix proxy to function, but it is recommended to keep things clear. </span><span class="kobospan" id="kobo.337.3">Adding the </span><strong class="bold"><span class="kobospan" id="kobo.338.1">Proxy address</span></strong><span class="kobospan" id="kobo.339.1"> field also functions as a sort of whitelist in this case, as only the IP address listed will be allowed </span><span><span class="kobospan" id="kobo.340.1">to connect</span><a id="_idTextAnchor1549" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.341.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.342.1">Before clicking the</span><a id="_idIndexMarker615" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.343.1"> blue </span><strong class="bold"><span class="kobospan" id="kobo.344.1">Add</span></strong><span class="kobospan" id="kobo.345.1"> button, let’s take a look at the </span><span><strong class="bold"><span class="kobospan" id="kobo.346.1">Encrypt</span><a id="_idTextAnchor1550" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.347.1">ion</span></strong></span><span><span class="kobospan" id="kobo.348.1"> tab:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer476">
<span class="kobospan" id="kobo.349.1"><img alt="Figure 8.9 – Administration | Proxies, Create proxy popup Encryption tab, lar-book-proxy-active" src="image/B19803_08_09.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.350.1">Figure 8.9 – Administration | Proxies, Create proxy popup Encryption tab, lar-book-proxy-active</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.351.1">By default, </span><strong class="bold"><span class="kobospan" id="kobo.352.1">No encryption</span></strong><span class="kobospan" id="kobo.353.1"> is checked here, which </span><a id="_idIndexMarker616" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.354.1">we’ll leave be for </span><span><span class="kobospan" id="kobo.355.1">this recipe.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.356.1">Before we move on, there’s one more tab in our Zabbix proxy creation popup that we need to have a look at – </span><span><strong class="bold"><span class="kobospan" id="kobo.357.1">Timeouts</span></strong></span><span><span class="kobospan" id="kobo.358.1">:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer477">
<span class="kobospan" id="kobo.359.1"><img alt="Figure 8.10 – Administration | Proxies, Create proxy popup Timeouts tab, lar-book-proxy-passive" src="image/B19803_08_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.360.1">Figure 8.10 – Administration | Proxies, Create proxy popup Timeouts tab, lar-book-proxy-passive</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.361.1">We won’t change anything on the </span><strong class="bold"><span class="kobospan" id="kobo.362.1">Timeouts</span></strong><span class="kobospan" id="kobo.363.1"> tab here, but since Zabbix 7, it is possible to override global timeouts for various types of item checks, allowing us to significantly tweak our Zabbix setup to avoid timeout </span><span><span class="kobospan" id="kobo.364.1">performance issues.</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.365.1">Now, click the blue </span><strong class="bold"><span class="kobospan" id="kobo.366.1">Add</span></strong><span class="kobospan" id="kobo.367.1"> button, which will take us back to the proxy </span><span><span class="kobospan" id="kobo.368.1">overview page.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.369.1">Log in to the CLI and check the configuration with the </span><span><span class="kobospan" id="kobo.370.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.371.1">vim /etc/zabbix/zabbix_proxy.conf</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.372.1">Let’s change the proxy </span><a id="_idIndexMarker617" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.373.1">mode on the </span><strong class="source-inline"><span class="kobospan" id="kobo.374.1">active</span></strong><span class="kobospan" id="kobo.375.1"> proxy. </span><span class="kobospan" id="kobo.375.2">The mode will be </span><strong class="source-inline"><span class="kobospan" id="kobo.376.1">0</span></strong><span class="kobospan" id="kobo.377.1"> on this proxy instead </span><span><span class="kobospan" id="kobo.378.1">of </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.379.1">1</span></strong></span><span><span class="kobospan" id="kobo.380.1">:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.381.1">ProxyMode=0</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.382.1">Change the following line to your </span><span><span class="kobospan" id="kobo.383.1">proxy hostname:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.384.1">Hostname=lar-book-proxy-active</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.385.1">Then, restart </span><span><span class="kobospan" id="kobo.386.1">the proxy:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.387.1">systemctl restart Zabbix-proxy</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.388.1">The </span><strong class="bold"><span class="kobospan" id="kobo.389.1">Last seen (age)</span></strong><span class="kobospan" id="kobo.390.1"> part of your newly added proxy should now show a time value, instead </span><span><span class="kobospan" id="kobo.391.1">o</span><a id="_idTextAnchor1551" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.392.1">f </span></span><span><strong class="bold"><span class="kobospan" id="kobo.393.1">Never</span></strong></span><span><span class="kobospan" id="kobo.394.1">.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer478">
<span class="kobospan" id="kobo.395.1"><img alt="Figure 8.11 – Administration | proxies page, Last seen (age)" src="image/B19803_08_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.396.1">Figure 8.11 – Administration | proxies page, Last seen (age)</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.397.1">Depending on your setting in the proxy configuration file, the </span><strong class="bold"><span class="kobospan" id="kobo.398.1">Last seen (age)</span></strong><span class="kobospan" id="kobo.399.1"> part may take a while </span><span><span class="kobospan" id="kobo.400.1">to</span><a id="_idTextAnchor1552" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1553" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.401.1"> change.</span></span></p>
<h2 id="_idParaDest-274" class="calibre7"><a id="_idTextAnchor1554" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.402.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.403.1">If you followed the </span><em class="italic"><span class="kobospan" id="kobo.404.1">Working with passive Zabbix proxies</span></em><span class="kobospan" id="kobo.405.1"> recipe from this chapter, the s</span><a id="_idTextAnchor1555" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.406.1">teps are about the same, except for the part where we add the </span><span><span class="kobospan" id="kobo.407.1">proxy mode.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.408.1">The proxy we just added is an active proxy that works by requesting a configuration from the Zabbix server on </span><span><span class="kobospan" id="kobo.409.1">port</span><a id="_idTextAnchor1556" class="pcalibre calibre6 pcalibre1"/> </span><span><strong class="source-inline"><span class="kobospan" id="kobo.410.1">10051</span></strong></span><span><span class="kobospan" id="kobo.411.1">.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer479">
<span class="kobospan" id="kobo.412.1"><img alt="Figure 8.12 – Diagram showing an active proxy connection" src="image/B19803_08_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.413.1">Figure 8.12 – Diagram showing an active proxy connection</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.414.1">The Zabbix proxy keeps requesting configuration changes, and it keeps sending any newly collected data to the</span><a id="_idIndexMarker618" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.415.1"> Zabbix server every second or it sends out a heartbeat if no data </span><span><span class="kobospan" id="kobo.416.1">is available.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.417.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.418.1">It is recommended to use active Zabbix proxies, as we can use them to reduce the load on our Zabbix server. </span><span class="kobospan" id="kobo.418.2">Use the passive proxy only when you have a good reason t</span><a id="_idTextAnchor1557" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1558" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.419.1">o </span><span><span class="kobospan" id="kobo.420.1">do so.</span></span></p>
<h1 id="_idParaDest-275" class="calibre5"><a id="_idTextAnchor1559" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.421.1">Monitoring hosts with Zabbix proxy</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.422.1">We have our </span><strong class="source-inline"><span class="kobospan" id="kobo.423.1">active</span></strong><span class="kobospan" id="kobo.424.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.425.1">passive</span></strong><span class="kobospan" id="kobo.426.1"> Zabbix proxies ready to use, so it’s now time to </span><a id="_idTextAnchor1560" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.427.1">add some hosts to them. </span><span class="kobospan" id="kobo.427.2">Setting up th</span><a id="_idTextAnchor1561" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.428.1">e</span><a id="_idIndexMarker619" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.429.1"> Zabbix frontend to monitor hosts with</span><a id="_idIndexMarker620" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.430.1"> Zabbix proxies works in about the same way as monitoring directly from the Zabbix server. </span><span class="kobospan" id="kobo.430.2">The backend and design change completely though, which I’ll explain in the </span><em class="italic"><span class="kobospan" id="kobo.431.1">How it works…</span></em><span class="kobospan" id="kobo.432.1"> section of </span><span><span class="kobospan" id="kobo.433.1">th</span><a id="_idTextAnchor1562" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1563" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.434.1">is recipe.</span></span></p>
<h2 id="_idParaDest-276" class="calibre7"><a id="_idTextAnchor1564" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.435.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.436.1">Make sure you have your </span><strong class="source-inline"><span class="kobospan" id="kobo.437.1">lar-book-proxy-passive</span></strong><span class="kobospan" id="kobo.438.1"> passive proxy and your </span><strong class="source-inline"><span class="kobospan" id="kobo.439.1">lar-book-proxy-active</span></strong><span class="kobospan" id="kobo.440.1"> active proxy ready by following all of the previous recipes in </span><span><span class="kobospan" id="kobo.441.1">this chapter.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.442.1">You will also need your Zabbix server and at least two hosts to monitor. </span><span class="kobospan" id="kobo.442.2">We will be using </span><strong class="source-inline"><span class="kobospan" id="kobo.443.1">lar-book-agent_snmp</span></strong><span class="kobospan" id="kobo.444.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.445.1">lar-book-agent</span></strong><span class="kobospan" id="kobo.446.1"> in the example, but any host with an active and passive Zabbix agent </span><a id="_idTextAnchor1565" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1566" class="pcalibre calibre6 pcalibre1"/><span><span class="kobospan" id="kobo.447.1">will work.</span></span></p>
<h2 id="_idParaDest-277" class="calibre7"><a id="_idTextAnchor1567" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.448.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.449.1">We’ll configure a host on both our active and our passive proxies to show you what the difference is between these two. </span><span class="kobospan" id="kobo.449.2">Let’s start with the </span><span><span class="kobospan" id="kobo.450.1">passive proxy.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.451.1">Passive proxy</span></h3>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.452.1">L</span><a id="_idTextAnchor1568" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.453.1">et’s start this recipe by logging in to our Zabbix frontend and navigating to </span><strong class="bold"><span class="kobospan" id="kobo.454.1">Data collection</span></strong><span class="kobospan" id="kobo.455.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.456.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.457.1">.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.458.1">Let’s add the host with the passive agent to our passive proxy. </span><span class="kobospan" id="kobo.458.2">In my case, this is the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.459.1">lar-book-agent_snmp</span></strong></span><span><span class="kobospan" id="kobo.460.1"> host.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.461.1">Click on the </span><strong class="source-inline"><span class="kobospan" id="kobo.462.1">lar-book-agent_snmp</span></strong><span class="kobospan" id="kobo.463.1"> host and </span><a id="_idIndexMarker621" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.464.1">change the </span><strong class="bold"><span class="kobospan" id="kobo.465.1">Monitored by proxy</span></strong><span class="kobospan" id="kobo.466.1"> field to </span><strong class="source-inline"><span class="kobospan" id="kobo.467.1">lar-book-proxy-passive</span></strong><span class="kobospan" id="kobo.468.1">, as in the </span><span><span class="kobospan" id="kobo.469.1">following s</span><a id="_idTextAnchor1569" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.470.1">creenshot:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer480">
<span class="kobospan" id="kobo.471.1"><img alt="Figure 8.13 – Configuration | Hosts, Edit host page for host lar-book-agent_snmp" src="image/B19803_08_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.472.1">Figure 8.13 – Configuration | Hosts, Edit host page for host lar-book-agent_snmp</span></p>
<p class="calibre3"><a id="_idTextAnchor1570" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.473.1">Now, click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.474.1">Update</span></strong><span class="kobospan" id="kobo.475.1"> button. </span><span class="kobospan" id="kobo.475.2">Our</span><a id="_idIndexMarker622" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.476.1"> host will now be monitored by the </span><span><span class="kobospan" id="kobo.477.1">Zabbix proxy.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.478.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.479.1">Due to the configuration update interval and the fact we just switched the monitoring source to a proxy, we can see the SNMP icon turn </span><span><span class="kobospan" id="kobo.480.1">gray temporarily.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.481.1">Active pro</span><a id="_idTextAnchor1571" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.482.1">xy</span></h3>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.483.1">Let’s do the same for our </span><a id="_idIndexMarker623" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.484.1">other </span><strong class="source-inline1"><span class="kobospan" id="kobo.485.1">lar-book-agent</span></strong><span class="kobospan" id="kobo.486.1"> host by navigating back to </span><strong class="bold"><span class="kobospan" id="kobo.487.1">Data </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.488.1">collection|</span></strong></span><span> </span><span><strong class="bold"><span class="kobospan" id="kobo.489.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.490.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.491.1">Click on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.492.1">lar-book-agent</span></strong><span class="kobospan" id="kobo.493.1"> host and change the </span><strong class="bold"><span class="kobospan" id="kobo.494.1">Monitored by proxy</span></strong><span class="kobospan" id="kobo.495.1"> field to </span><strong class="source-inline1"><span class="kobospan" id="kobo.496.1">lar-book-proxy-active</span></strong><span class="kobospan" id="kobo.497.1">, as in the </span><span><span class="kobospan" id="kobo.498.1">following </span><a id="_idTextAnchor1572" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.499.1">screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer481">
<span class="kobospan" id="kobo.500.1"><img alt="Figure 8.14 – Configuration | Hosts, Edit host page for host lar-book-agent" src="image/B19803_08_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.501.1">Figure 8.14 – Configuration | Hosts, Edit host page for host lar-book-agent</span></p>
<ol class="calibre16">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.502.1">Now, click on the blue </span><span><strong class="bold"><span class="kobospan" id="kobo.503.1">Update</span></strong></span><span><span class="kobospan" id="kobo.504.1"> button.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.505.1">On the CLI of our</span><a id="_idIndexMarker624" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.506.1"> monitored Linux host, the </span><strong class="source-inline1"><span class="kobospan" id="kobo.507.1">lar-book-agent</span></strong><span class="kobospan" id="kobo.508.1"> host, execute </span><a id="_idIndexMarker625" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.509.1">the </span><span><span class="kobospan" id="kobo.510.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.511.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.512.1">When working with an active Zabbix agent, we need to make sure to add the proxy IP address to the </span><span><span class="kobospan" id="kobo.513.1">following line:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.514.1">ServerActive=</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.515.1">Our host will now be monitored by the Zabbix proxy once the proxy has received its new configuration data and the agent has execute</span><a id="_idTextAnchor1573" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1574" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.516.1">d </span><span><span class="kobospan" id="kobo.517.1">the checks.</span></span></p>
<h2 id="_idParaDest-278" class="calibre7"><a id="_idTextAnchor1575" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.518.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.519.1">Mon</span><a id="_idTextAnchor1576" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.520.1">itoring hosts with a Zabbix pro</span><a id="_idTextAnchor1577" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.521.1">xy in passive or active mode works in the same way from the frontend. </span><span class="kobospan" id="kobo.521.2">We </span><a id="_idIndexMarker626" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.522.1">merely configure which host is monitored by which proxy in our Zabbix frontend, and it will </span><span><span class="kobospan" id="kobo.523.1">be done.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.524.1">Let’s </span><a id="_idTextAnchor1578" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.525.1">take a look at how our </span><strong class="bold"><span class="kobospan" id="kobo.526.1">Simple Network Management Protocol</span></strong><span class="kobospan" id="kobo.527.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.528.1">SNMP</span></strong><span class="kobospan" id="kobo.529.1">) agent is now monitored by the </span><a id="_idIndexMarker627" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1579" class="pcalibre calibre6 pcalibre1"/><span><span class="kobospan" id="kobo.530.1">passive proxy:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer482">
<span class="kobospan" id="kobo.531.1"><img alt="Figure 8.15 – A completely passive Zabbix setup with proxy" src="image/B19803_08_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.532.1">Figure 8.15 – A completely passive Zabbix setup with proxy</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.533.1">Our passive Zabbix proxy now collects data from our SNMP agent, and after this is collected, the Zabbix server </span><a id="_idIndexMarker628" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.534.1">collects this data from our Zabbix proxy. </span><span class="kobospan" id="kobo.534.2">Sounds like a </span><a id="_idIndexMarker629" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.535.1">whole process </span><span><span class="kobospan" id="kobo.536.1">already, right?</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.537.1">Let’s look at our active Zabb</span><a id="_idTextAnchor1580" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.538.1">ix </span><span><span class="kobospan" id="kobo.539.1">proxy setup:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer483">
<span class="kobospan" id="kobo.540.1"><img alt="Figure 8.16 – A completely active Zabbix setup with proxy" src="image/B19803_08_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.541.1">Figure 8.16 – A completely active Zabbix setup with proxy</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.542.1">Our active Zabbix proxy receives data from our active Zabbix agent and then sends this data to our Zabbix server. </span><span class="kobospan" id="kobo.542.2">We’ve eliminated the part where the passive proxy is waiting to be polled in this proxy setup altogether. </span><span class="kobospan" id="kobo.542.3">Furthermore, we only have to allow firewall connections going toward the proxy or server, meaning this could provide </span><span><span class="kobospan" id="kobo.543.1">additional security.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.544.1">There are some of the reasons I would always recommend working with active proxies – and even active a</span><a id="_idTextAnchor1581" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.545.1">gents – as much as possible. </span><span class="kobospan" id="kobo.545.2">If we look a</span><a id="_idTextAnchor1582" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.546.1">t the following screenshot, we can see a setup that you might see</span><a id="_idTextAnchor1583" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.547.1"> at </span><span><span class="kobospan" id="kobo.548.1">a company:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer484">
<span class="kobospan" id="kobo.549.1"><img alt="Figure 8.17 – An active Zabbix proxy setup with different monitored types" src="image/B19803_08_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.550.1">Figure 8.17 – An active Zabbix proxy setup with different monitored types</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.551.1">Fortunately, we have the </span><a id="_idIndexMarker630" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.552.1">option of using a lot of different combinations of setups. </span><span class="kobospan" id="kobo.552.2">It is </span><a id="_idIndexMarker631" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.553.1">perfectly possible – and even logical – to combine your checks from a proxy,</span><a id="_idTextAnchor1584" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.554.1"> just as much as it would be with a Z</span><a id="_idTextAnchor1585" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.555.1">abbix server. </span><span class="kobospan" id="kobo.555.2">We can monitor all types </span><a id="_idIndexMarker632" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.556.1">from our proxy, whether it’s</span><a id="_idIndexMarker633" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.557.1"> a Zabbix agent, SNMP, or even </span><strong class="bold"><span class="kobospan" id="kobo.558.1">Java Management Extensions</span></strong><span class="kobospan" id="kobo.559.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.560.1">JMX</span></strong><span class="kobospan" id="kobo.561.1">) and the </span><strong class="bold"><span class="kobospan" id="kobo.562.1">Intelligent Platform Management </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.563.1">Interface</span></strong></span><span><span class="kobospan" id="kobo.564.1"> (</span></span><span><strong class="bold"><span class="kobospan" id="kobo.565.1">IPMI</span></strong></span><span><span class="kobospan" id="kobo.566.1">).</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.567.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.568.1">When designing a new Zabbix hosting infrastructure, start with adding proxies to your design if possible. </span><span class="kobospan" id="kobo.568.2">This way, you don’t have to change a lot later. </span><span class="kobospan" id="kobo.568.3">It’s easy to add and change proxies, but it’s harder to go from just using the Zabbix server to using Zabbix proxi</span><a id="_idTextAnchor1586" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1587" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.569.1">es in </span><span><span class="kobospan" id="kobo.570.1">your design.</span></span></p>
<h2 id="_idParaDest-279" class="calibre7"><a id="_idTextAnchor1588" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.571.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.572.1">We now have a solid setup with some proxies up and running. </span><span class="kobospan" id="kobo.572.2">We’ve figured </span><a id="_idTextAnchor1589" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.573.1">out the difference between active a</span><a id="_idTextAnchor1590" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.574.1">nd passive proxies and how they affect monitoring. </span><span class="kobospan" id="kobo.574.2">But why would we build a setup like this? </span><span class="kobospan" id="kobo.574.3">Well, Zabbix proxies are great for many environments – not just the big ones, but even sometimes in the </span><span><span class="kobospan" id="kobo.575.1">smallest ones.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.576.1">We can use Zabbix proxies to offload polling and preprocessing from our main Zabbix server, thus keeping the server</span><a id="_idIndexMarker634" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.577.1"> clear for handling data such as when writing to the </span><span><span class="kobospan" id="kobo.578.1">Zabbix d</span><a id="_idTextAnchor1591" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.579.1">atabase.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.580.1">We can use Zabbix proxies to monitor offsite locations, such as when you’re a </span><strong class="bold"><span class="kobospan" id="kobo.581.1">managed service provider</span></strong><span class="kobospan" id="kobo.582.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.583.1">MSP</span></strong><span class="kobospan" id="kobo.584.1">) and want to </span><a id="_idIndexMarker635" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.585.1">monitor a customer network. </span><span class="kobospan" id="kobo.585.2">We simply place a proxy on-site and mo</span><a id="_idTextAnchor1592" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.586.1">nitor it. </span><span class="kobospan" id="kobo.586.2">We can use industry-standard techniques such as monitoring through a </span><strong class="bold"><span class="kobospan" id="kobo.587.1">virtual private network</span></strong><span class="kobospan" id="kobo.588.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.589.1">VPN</span></strong><span class="kobospan" id="kobo.590.1">) or simply set up a connection</span><a id="_idIndexMarker636" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.591.1"> using built-in Zabbix </span><span><span class="kobospan" id="kobo.592.1">proxy encryption.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.593.1">When the connection to the </span><a id="_idIndexMarker637" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.594.1">remote site goes down, our proxy will keep collecting data on-site and send this to our Zabbix server when the connection comes back up. </span><span class="kobospan" id="kobo.594.2">By default, Zabbix will keep the data on disk for one hour, which is specified by the </span><strong class="source-inline"><span class="kobospan" id="kobo.595.1">ProxyOfflineBuffer=</span></strong><span class="kobospan" id="kobo.596.1"> parameter in the Zabbix proxy </span><span><span class="kobospan" id="kobo.597.1">configuration file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.598.1">We can also use the Zabbix proxy to bypass firewall complications. </span><span class="kobospan" id="kobo.598.2">When we place a proxy behind a firewall in a monitored network, we only need one firewall rule between the Zabbix server and the Zabbix proxy. </span><span class="kobospan" id="kobo.598.3">Our Zabbix proxy then monitors the different hosts and sends the collected data in one stream to the Zabbix server. </span><span class="kobospan" id="kobo.598.4">This means we don’t have to poke holes for ports </span><strong class="source-inline"><span class="kobospan" id="kobo.599.1">161</span></strong><span class="kobospan" id="kobo.600.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.601.1">162</span></strong><span class="kobospan" id="kobo.602.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.603.1">10050</span></strong><span class="kobospan" id="kobo.604.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.605.1">10051</span></strong><span class="kobospan" id="kobo.606.1">, Java, API ports, and many more through </span><span><span class="kobospan" id="kobo.607.1">our firewall.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.608.1">With this, you have loads of options to use Z</span><a id="_idTextAnchor1593" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1594" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.609.1">abbix </span><span><span class="kobospan" id="kobo.610.1">proxies already.</span></span></p>
<h2 id="_idParaDest-280" class="calibre7"><a id="_idTextAnchor1595" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.611.1">See also</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.612.1">Check out this interesting blog post about some mor</span><a id="_idTextAnchor1596" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.613.1">e cool hidden benefits of Zabbix </span><span><span class="kobospan" id="kobo.614.1">proxies: </span></span><a href="https://blog.zabbix.com/hidden-benefits-of-zabbix-proxy/9359/" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.615.1">https://blog.zabbix.com/hidden-benefits-of-zabbix-proxy/9359/</span></span></a><span><span class="kobospan" id="kobo.616.1">.</span></span></p>
<h1 id="_idParaDest-281" class="calibre5"><a id="_idTextAnchor1597" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.617.1">Encrypting your Zabbix proxy connection with pre-shared keys</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.618.1">For additional security, it’s recommended to </span><a id="_idIndexMarker638" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.619.1">make sure your </span><a id="_idIndexMarker639" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.620.1">Zabbix proxy is connecting over the network encrypted. </span><span class="kobospan" id="kobo.620.2">The simple reason for this is to make sure that any possible intruder on your network cannot see all the data sent between the Zabbix server and Zabbix proxy from your network in </span><span><span class="kobospan" id="kobo.621.1">plain text.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.622.1">Image you have macros configured</span><a id="_idIndexMarker640" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.623.1"> with important passwords. </span><span class="kobospan" id="kobo.623.2">These macros will flow over the network in plain</span><a id="_idIndexMarker641" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.624.1"> text if you do not encrypt the connection between the Zabbix server </span><span><span class="kobospan" id="kobo.625.1">and proxy.</span></span></p>
<h2 id="_idParaDest-282" class="calibre7"><a id="_idTextAnchor1598" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.626.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.627.1">For this recipe, we will need our Zabbix server and a connected proxy of either the passive or </span><span><span class="kobospan" id="kobo.628.1">active type.</span></span></p>
<h2 id="_idParaDest-283" class="calibre7"><a id="_idTextAnchor1599" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.629.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.630.1">Let’s get started on the CLI of our proxy, where we need to make some </span><span><span class="kobospan" id="kobo.631.1">configuration changes:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.632.1">First things first, let’s edit the Zabbix proxy </span><span><span class="kobospan" id="kobo.633.1">configuration file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.634.1">vim /etc/zabbix/zabbix_proxy.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.635.1">We will find the following and edit the </span><span><span class="kobospan" id="kobo.636.1">following variables:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.637.1">TLSConnect=psk</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.638.1">TLSAccept=psk</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.639.1">TLSPSKIdentity=lar-book-proxy-active</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.640.1">TLSPSKFile=/etc/zabbix/proxy_psk.key</span></strong></pre></li> </ol>
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.641.1">TLSConnect</span></strong><span class="kobospan" id="kobo.642.1"> is used for active proxy connections and </span><strong class="source-inline"><span class="kobospan" id="kobo.643.1">TLSAccept</span></strong><span class="kobospan" id="kobo.644.1"> is used for passive proxy connections. </span><span class="kobospan" id="kobo.644.2">It is smart, however, to set both parameters at all times, as then we will always ensure an </span><span><span class="kobospan" id="kobo.645.1">encrypted connection.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.646.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.647.1">In the example, I’m setting the identity to the hostname of the proxy for simplicity’s sake. </span><span class="kobospan" id="kobo.647.2">If the PSK identity and PSK itself are a unique combination every time, you can use anything though. </span><em class="italic"><span class="kobospan" id="kobo.648.1">Do not</span></em><span class="kobospan" id="kobo.649.1"> use the same PSK with a different identity, as this will result in errors and the proxy </span><span><span class="kobospan" id="kobo.650.1">won’t connect.</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.651.1">Save your proxy configuration file </span><span><span class="kobospan" id="kobo.652.1">and exit.</span></span><p class="calibre3"><span class="kobospan" id="kobo.653.1">We will create a new</span><a id="_idIndexMarker642" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.654.1"> file, the </span><strong class="source-inline"><span class="kobospan" id="kobo.655.1">/etc/zabbix</span></strong><span class="kobospan" id="kobo.656.1"> folder, which</span><a id="_idIndexMarker643" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.657.1"> contains the PSK. </span><span class="kobospan" id="kobo.657.2">To do that, execute the </span><span><span class="kobospan" id="kobo.658.1">following command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.659.1">openssl rand -hex 128 &gt; /etc/zabbix/proxy_psk.key</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.660.1">This will create the file with the new pre-shared key. </span><span class="kobospan" id="kobo.660.2">You can make sure it was created correctly with the </span><span><span class="kobospan" id="kobo.661.1">following command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.662.1">cat /etc/zabbix/proxy_psk.key</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.663.1">It should look </span><span><span class="kobospan" id="kobo.664.1">as follows:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer485">
<span class="kobospan" id="kobo.665.1"><img alt="Figure 8.18 – Created proxy PSK file" src="image/B19803_08_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.666.1">Figure 8.18 – Created proxy PSK file</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.667.1">Now, let’s make sure only the Zabbix proxy can read this </span><span><span class="kobospan" id="kobo.668.1">PSK file:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.669.1">chmod 400/etc/zabbix/proxy_psk.key</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.670.1">chown zabbix:zabbix /etc/zabbix/proxy_psk.key</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.671.1">3.	</span><span class="kobospan" id="kobo.671.2">Restart your Zabbix proxy to make the changes </span><span><span class="kobospan" id="kobo.672.1">take effect:</span></span></p>
<pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.673.1">Systemctl restart zabbix-proxy</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.674.1">4.	</span><span class="kobospan" id="kobo.674.2">Now, it’s time to move on to the frontend. </span><span class="kobospan" id="kobo.674.3">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.675.1">Administration</span></strong><span class="kobospan" id="kobo.676.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.677.1">Proxies</span></strong></span><span><span class="kobospan" id="kobo.678.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.679.1">You will probably see that the proxy is no longer connected and the </span><strong class="bold"><span class="kobospan" id="kobo.680.1">Last seen (age)</span></strong><span class="kobospan" id="kobo.681.1"> value is getting higher. </span><span class="kobospan" id="kobo.681.2">Edit the proxy on which you are adding encryption and go to the encryption tab. </span><span class="kobospan" id="kobo.681.3">For an active proxy, it will look </span><span><span class="kobospan" id="kobo.682.1">as follows:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer486">
<span class="kobospan" id="kobo.683.1"><img alt="Figure 8.19 – lar-book-proxy-active PSK settings" src="image/B19803_08_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.684.1">Figure 8.19 – lar-book-proxy-active PSK settings</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.685.1">For a passive proxy, make</span><a id="_idIndexMarker644" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.686.1"> sure </span><strong class="bold"><span class="kobospan" id="kobo.687.1">Connections to proxy</span></strong><span class="kobospan" id="kobo.688.1"> is set to </span><strong class="bold"><span class="kobospan" id="kobo.689.1">PSK</span></strong><span class="kobospan" id="kobo.690.1">, and for the active proxy, select </span><strong class="bold"><span class="kobospan" id="kobo.691.1">PSK</span></strong><span class="kobospan" id="kobo.692.1"> as the option we’d like to use for </span><strong class="bold"><span class="kobospan" id="kobo.693.1">Connections </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.694.1">from proxy</span></strong></span><span><span class="kobospan" id="kobo.695.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.696.1">Fill in the </span><strong class="bold"><span class="kobospan" id="kobo.697.1">PSK identity</span></strong><span class="kobospan" id="kobo.698.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.699.1">PSK</span></strong><span class="kobospan" id="kobo.700.1"> as set up in </span><em class="italic"><span class="kobospan" id="kobo.701.1">Steps 2</span></em><span class="kobospan" id="kobo.702.1"> and </span><em class="italic"><span class="kobospan" id="kobo.703.1">6</span></em><span class="kobospan" id="kobo.704.1"> of </span><span><span class="kobospan" id="kobo.705.1">this recipe.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.706.1">5.	</span><span class="kobospan" id="kobo.706.2">Now, click on </span><strong class="bold"><span class="kobospan" id="kobo.707.1">Update</span></strong><span class="kobospan" id="kobo.708.1"> and your</span><a id="_idIndexMarker645" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.709.1"> proxy should </span><span><span class="kobospan" id="kobo.710.1">connect again.</span></span></p>
<h2 id="_idParaDest-284" class="calibre7"><a id="_idTextAnchor1600" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.711.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.712.1">After setting up your active or passive Zabbix proxy encryption, not much will change. </span><span class="kobospan" id="kobo.712.2">Your proxy will still connect to or be connected from the Zabbix server. </span><span class="kobospan" id="kobo.712.3">The thing that changes is that the Zabbix server and proxy will now use encryption when communicating with </span><span><span class="kobospan" id="kobo.713.1">each other.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer487">
<span class="kobospan" id="kobo.714.1"><img alt="Figure 8.20 – Encrypted proxies connections" src="image/B19803_08_20.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.715.1">Figure 8.20 – Encrypted proxies connections</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.716.1">The method we have used utilizes a pre-shared key-based encryption method. </span><span class="kobospan" id="kobo.716.2">Although this provides a relatively safe method of adding encryption to these connections, there’s always the chance of a pre-shared key </span><a id="_idIndexMarker646" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.717.1">leaking somehow. </span><span class="kobospan" id="kobo.717.2">Since a pre-shared key never expires, that would create a</span><a id="_idIndexMarker647" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.718.1"> permanent hole in your security that only patches whenever you are going to change the pre-shared key. </span><span class="kobospan" id="kobo.718.2">In practice, this is </span><span><span class="kobospan" id="kobo.719.1">usually never.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.720.1">One of the benefits of utilizing certificate-based encryption methods is that certificates expire. </span><span class="kobospan" id="kobo.720.2">This does mean for an added layer of security, but at the same time it means that you will be regularly forced to update your encryption settings or risk losing the connection between the Zabbix proxy </span><span><span class="kobospan" id="kobo.721.1">and server.</span></span></p>
<h1 id="_idParaDest-285" class="calibre5"><a id="_idTextAnchor1601" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.722.1">Setting up Zabbix proxy load balancing</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.723.1">Long awaited and finally</span><a id="_idIndexMarker648" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.724.1"> implemented, Zabbix has finally introduced proxy high availability and load balancing. </span><span class="kobospan" id="kobo.724.2">This completes all the required functionality to truly make Zabbix a product that is highly reliable even in cases </span><span><span class="kobospan" id="kobo.725.1">of outages.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.726.1">It also means that Zabbix is now a lot easier to scale, utilizing the load balancing on proxies to divide the load between </span><span><span class="kobospan" id="kobo.727.1">available proxies.</span></span></p>
<h2 id="_idParaDest-286" class="calibre7"><a id="_idTextAnchor1602" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.728.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.729.1">For this recipe, we will utilize the active and passive proxy we’ve set up in earlier recipes in this chapter. </span><span class="kobospan" id="kobo.729.2">Besides that, all we need is the Zabbix setup and a host to monitor for which we will use a Zabbix agent in </span><span><span class="kobospan" id="kobo.730.1">active mode.</span></span></p>
<h2 id="_idParaDest-287" class="calibre7"><a id="_idTextAnchor1603" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.731.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.732.1">Let’s get started on the </span><a id="_idIndexMarker649" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.733.1">frontend, where we should already have two (or more) Zabbix </span><span><span class="kobospan" id="kobo.734.1">proxies available:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.735.1"> Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.736.1">Administration</span></strong><span class="kobospan" id="kobo.737.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.738.1">Proxies</span></strong><span class="kobospan" id="kobo.739.1"> and make sure you have two proxies available. </span><span class="kobospan" id="kobo.739.2">It does not matter what the proxy mode is, as we can combine active and passive proxies in proxy </span><span><span class="kobospan" id="kobo.740.1">load balancing.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer488">
<span class="kobospan" id="kobo.741.1"><img alt="Figure 8.21 – Administration | Proxies page with the two proxies we will use for load balancing" src="image/B19803_08_21.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.742.1">Figure 8.21 – Administration | Proxies page with the two proxies we will use for load balancing</span></p>
<ol class="calibre16">
<li value="2" class="calibre15"><span class="kobospan" id="kobo.743.1">Next, let’s navigate to </span><strong class="bold"><span class="kobospan" id="kobo.744.1">Administration</span></strong><span class="kobospan" id="kobo.745.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.746.1">Proxy groups</span></strong><span class="kobospan" id="kobo.747.1"> to define our first proxy load balancing and high </span><span><span class="kobospan" id="kobo.748.1">availability group.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.749.1">In the top-right corner, click on the </span><strong class="bold"><span class="kobospan" id="kobo.750.1">Create proxy group</span></strong><span class="kobospan" id="kobo.751.1"> button. </span><span class="kobospan" id="kobo.751.2">This will open the following </span><span><span class="kobospan" id="kobo.752.1">pop-up window:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer489">
<span class="kobospan" id="kobo.753.1"><img alt="Figure 8.22 – Administration | Proxy groups, New proxy group popup" src="image/B19803_08_22.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.754.1">Figure 8.22 – Administration | Proxy groups, New proxy group popup</span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.755.1">Here, we basically just have to give the proxy group a name and we will be done for now. </span><span class="kobospan" id="kobo.755.2">Let’s name this group </span><strong class="source-inline1"><span class="kobospan" id="kobo.756.1">lar-proxy-group</span></strong><span class="kobospan" id="kobo.757.1">. </span><span class="kobospan" id="kobo.757.2">Then, we can press the </span><strong class="bold"><span class="kobospan" id="kobo.758.1">Add</span></strong><span class="kobospan" id="kobo.759.1"> button to finish adding this </span><span><span class="kobospan" id="kobo.760.1">proxy group.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.761.1">Now, navigate</span><a id="_idIndexMarker650" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.762.1"> back to </span><strong class="bold"><span class="kobospan" id="kobo.763.1">Administration</span></strong><span class="kobospan" id="kobo.764.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.765.1">Proxies</span></strong><span class="kobospan" id="kobo.766.1">, and let’s add our two proxies to the new </span><span><span class="kobospan" id="kobo.767.1">proxy group.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.768.1">Click on a proxy and add it to the proxy group by filling in the </span><strong class="bold"><span class="kobospan" id="kobo.769.1">Proxy group</span></strong><span class="kobospan" id="kobo.770.1"> parameter or by using the </span><span><strong class="bold"><span class="kobospan" id="kobo.771.1">Select</span></strong></span><span><span class="kobospan" id="kobo.772.1"> button.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer490">
<span class="kobospan" id="kobo.773.1"><img alt="Figure 8.23 – Administration | Proxies, add proxy group to a proxy" src="image/B19803_08_23.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.774.1">Figure 8.23 – Administration | Proxies, add proxy group to a proxy</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.775.1">Do this for all proxies we want to add to </span><span><span class="kobospan" id="kobo.776.1">the group.</span></span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.777.1">Also, make sure to fill in the </span><strong class="bold"><span class="kobospan" id="kobo.778.1">Address for active agents</span></strong><span class="kobospan" id="kobo.779.1"> parameter as when we work with active </span><a id="_idIndexMarker651" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.780.1">agents, we’ll need to know where to connect to on </span><span><span class="kobospan" id="kobo.781.1">each proxy.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.782.1">We’ll do the same for our</span><a id="_idIndexMarker652" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.783.1">second proxy:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer491">
<span class="kobospan" id="kobo.784.1"><img alt="Figure 8.24 – Administration | Proxies, add proxy group to a proxy" src="image/B19803_08_24.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.785.1">Figure 8.24 – Administration | Proxies, add proxy group to a proxy</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.786.1">Now, let’s add a new host to be monitored by this proxy group. </span><span class="kobospan" id="kobo.786.2">I will use a new host called </span><strong class="source-inline1"><span class="kobospan" id="kobo.787.1">lar-book-proxyha-test</span></strong><span class="kobospan" id="kobo.788.1">. </span><span class="kobospan" id="kobo.788.2">When creating the host, make sure to add the </span><strong class="bold"><span class="kobospan" id="kobo.789.1">Proxy group</span></strong><span class="kobospan" id="kobo.790.1"> parameter </span><span><span class="kobospan" id="kobo.791.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer492">
<span class="kobospan" id="kobo.792.1"><img alt="Figure 8.25 – Data collection | Hosts, Edit or create host popup window" src="image/B19803_08_25.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.793.1">Figure 8.25 – Data collection | Hosts, Edit or create host popup window</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.794.1">In the agent configuration file for the host we are adding, let’s change some parameters. </span><span class="kobospan" id="kobo.794.2">If it’s a Linux host, edit the </span><span><span class="kobospan" id="kobo.795.1">configuration file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.796.1">
vim /etc/zabbix/zabbix_agent2.conf</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.797.1">Now, edit the following </span><span><span class="kobospan" id="kobo.798.1">two parameters:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.799.1">
ServerActive=192.168.2.175,192.168.2.174
Hostname=lar-book-proxyha-test</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.800.1">With two proxies active and</span><a id="_idIndexMarker653" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.801.1"> configured as part of a proxy group and a host monitored by that proxy, we are now done and ready to </span><a id="_idIndexMarker654" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.802.1">load balance our hosts between </span><span><span class="kobospan" id="kobo.803.1">the proxies</span></span></li>
</ol>
<h2 id="_idParaDest-288" class="calibre7"><a id="_idTextAnchor1604" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.804.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.805.1">As you can see, proxy load balancing and high availability is a pretty straightforward setup and there’s not much complexity to work with. </span><span class="kobospan" id="kobo.805.2">We simply add our proxies to a group and Zabbix will take care of the rest </span><span><span class="kobospan" id="kobo.806.1">for us.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.807.1">In our case, we’ve added two proxies to the group, an active and a passive proxy. </span><span class="kobospan" id="kobo.807.2">These two proxies will now work together, load balancing the load of the hosts </span><span><span class="kobospan" id="kobo.808.1">between them.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer493">
<span class="kobospan" id="kobo.809.1"><img alt="Figure 8.26 – Our proxy group working normally" src="image/B19803_08_26.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.810.1">Figure 8.26 – Our proxy group working normally</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.811.1">Our active agent </span><strong class="source-inline"><span class="kobospan" id="kobo.812.1">lar-book-proxyha-test</span></strong><span class="kobospan" id="kobo.813.1"> host will connect to one of the two proxies on the defined IP address </span><a id="_idIndexMarker655" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.814.1">under the </span><strong class="source-inline"><span class="kobospan" id="kobo.815.1">ServerActive=</span></strong><span class="kobospan" id="kobo.816.1"> parameter. </span><span class="kobospan" id="kobo.816.2">Because we entered </span><strong class="bold"><span class="kobospan" id="kobo.817.1">Address for active agents</span></strong><span class="kobospan" id="kobo.818.1"> under the proxy configuration in </span><a id="_idIndexMarker656" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.819.1">the Zabbix frontend, all the proxies in the proxy group also know the address for redirecting checks to in case load balancing needs to </span><span><span class="kobospan" id="kobo.820.1">be done.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.821.1">Our Zabbix proxy group will now make sure to load balance the hosts, even if they are in active mode. </span><span class="kobospan" id="kobo.821.2">In case there is an outage, the proxy group will need to recalculate the </span><span><span class="kobospan" id="kobo.822.1">load balancing.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer494">
<span class="kobospan" id="kobo.823.1"><img alt="Figure 8.27 – Our proxy group after an outage" src="image/B19803_08_27.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.824.1">Figure 8.27 – Our proxy group after an outage</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.825.1">The host will now be redirected to a different proxy in the proxy group for further monitoring. </span><span class="kobospan" id="kobo.825.2">This is why we do not even</span><a id="_idIndexMarker657" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.826.1"> need any floating IPs or virtual IPs to redirect active agent checks, as our</span><a id="_idIndexMarker658" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.827.1"> proxies can take care of it </span><span><span class="kobospan" id="kobo.828.1">for us.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.829.1">Do keep the proxy parameters in mind, however, to make sure our proxy group is functioning optimally. </span><span class="kobospan" id="kobo.829.2">If you have 4 proxies in a proxy group and set </span><strong class="bold"><span class="kobospan" id="kobo.830.1">Minimum number of proxies</span></strong><span class="kobospan" id="kobo.831.1"> to </span><strong class="source-inline"><span class="kobospan" id="kobo.832.1">1</span></strong><span class="kobospan" id="kobo.833.1">, make sure to configure every single proxy in the group to be able to handle the full load of all hosts in the proxy group. </span><span class="kobospan" id="kobo.833.2">Otherwise, your monitoring performance will still </span><span><span class="kobospan" id="kobo.834.1">be compromised.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.835.1">This is also true the other way around; if we have a proxy group of 4 proxies and we set </span><strong class="bold"><span class="kobospan" id="kobo.836.1">Minimum number of proxies</span></strong><span class="kobospan" id="kobo.837.1"> to </span><strong class="source-inline"><span class="kobospan" id="kobo.838.1">3</span></strong><span class="kobospan" id="kobo.839.1">, the whole proxy group will go down if we lose just two proxies. </span><span class="kobospan" id="kobo.839.2">Make sure to find the</span><a id="_idIndexMarker659" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.840.1"> correct balance between the number of proxies in a group and the minimum proxies required for the group to handle the </span><a id="_idIndexMarker660" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.841.1">full load </span><span><span class="kobospan" id="kobo.842.1">of monitoring.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer495">
<span class="kobospan" id="kobo.843.1"><img alt="Figure 8.28 – Our proxy group settings" src="image/B19803_08_28.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.844.1">Figure 8.28 – Our proxy group settings</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.845.1">Furthermore, we can change the </span><strong class="bold"><span class="kobospan" id="kobo.846.1">Failover period</span></strong><span class="kobospan" id="kobo.847.1"> value to determine how fast a failover needs </span><span><span class="kobospan" id="kobo.848.1">to happen.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.849.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.850.1">Keep in mind that if you’re working with certain other checks, you might need to do some additional configuration with things such as floating IPs or virtual IPs. </span><span class="kobospan" id="kobo.850.2">For a check with SNMP traps, for example, you might need to send your traps to all proxies in a group if supported by your device, addin</span><a id="_idTextAnchor1605" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1606" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.851.1">g additional load to </span><span><span class="kobospan" id="kobo.852.1">the network.</span></span></p>
<h1 id="_idParaDest-289" class="calibre5"><a id="_idTextAnchor1607" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.853.1">Using discovery with Zabbix proxies</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.854.1">In </span><a href="B19803_07.xhtml#_idTextAnchor1318" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.855.1">Chapter 7</span></em></span></a><span class="kobospan" id="kobo.856.1">, </span><em class="italic"><span class="kobospan" id="kobo.857.1">Using Discovery for Automatic Creation</span></em><span class="kobospan" id="kobo.858.1">, we talked a</span><a id="_idTextAnchor1608" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.859.1">bout Zabbix and discovery. </span><span class="kobospan" id="kobo.859.2">It is a ver</span><a id="_idTextAnchor1609" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.860.1">y good idea to </span><a id="_idIndexMarker661" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.861.1">edit your discovery rules if you followed along</span><a id="_idIndexMarker662" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.862.1"> with that chapter. </span><span class="kobospan" id="kobo.862.2">Let’s see</span><a id="_idTextAnchor1610" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1611" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.863.1"> how this would work in </span><span><span class="kobospan" id="kobo.864.1">this recipe.</span></span></p>
<h2 id="_idParaDest-290" class="calibre7"><a id="_idTextAnchor1612" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.865.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.866.1">You’ll need to have finished </span><a href="B19803_07.xhtml#_idTextAnchor1318" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.867.1">Chapter 7</span></em></span></a><span class="kobospan" id="kobo.868.1">, </span><em class="italic"><span class="kobospan" id="kobo.869.1">Using Discovery for Automatic Creation</span></em><span class="kobospan" id="kobo.870.1">, or have some discovery rules and active agent autoregistration </span><span><span class="kobospan" id="kobo.871.1">set up.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.872.1">I’ll be using the </span><strong class="source-inline"><span class="kobospan" id="kobo.873.1">lar-book-lnx-agent-auto</span></strong><span class="kobospan" id="kobo.874.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.875.1">lar-book-disc-lnx</span></strong><span class="kobospan" id="kobo.876.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.877.1">lar-book-disc-win</span></strong><span class="kobospan" id="kobo.878.1"> hosts in this example. </span><a id="_idTextAnchor1613" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1614" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.879.1">We will also need our </span><span><span class="kobospan" id="kobo.880.1">Zabbix server.</span></span></p>
<h2 id="_idParaDest-291" class="calibre7"><a id="_idTextAnchor1615" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.881.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.882.1">Let’s start with editing our discovery rule and then move on to editing our active agent to autoregister to</span><a id="_idTextAnchor1616" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.883.1">the proxy.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.884.1">Discovery rules</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.885.1">Starting with Zabbix discovery rules, let’s look at how to make sure we do this from the </span><span><span class="kobospan" id="kobo.886.1">Zabbix proxy:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.887.1">Log in to the CLI of </span><strong class="source-inline1"><span class="kobospan" id="kobo.888.1">lar-book-disc-lnx</span></strong><span class="kobospan" id="kobo.889.1"> and edit the </span><strong class="source-inline1"><span class="kobospan" id="kobo.890.1">/etc/zabbix/ zabbix_agent2.conf</span></strong><span class="kobospan" id="kobo.891.1"> file. </span><span class="kobospan" id="kobo.891.2">Edit the following lines to include our Zabbix </span><span><span class="kobospan" id="kobo.892.1">proxy address:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.893.1">
Server=127.0.0.1,10.16.16.152,10.16.16.160,10.16.16.161
ServerActive=10.16.16.160</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.894.1">Restart your Zabbix agent by executing the </span><span><span class="kobospan" id="kobo.895.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.896.1">systemctl restart zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.897.1">Now, make sure to log in to </span><strong class="source-inline1"><span class="kobospan" id="kobo.898.1">lar-book-disc-win</span></strong><span class="kobospan" id="kobo.899.1"> and edit the </span><strong class="source-inline1"><span class="kobospan" id="kobo.900.1">C:\Program Files\Zabbix agent\zabbix_agent2</span></strong><span class="kobospan" id="kobo.901.1"> file. </span><span class="kobospan" id="kobo.901.2">Edit the following lines to include our Zabbix </span><span><span class="kobospan" id="kobo.902.1">proxy address:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.903.1">
Server=127.0.0.1,10.16.16.152,10.16.16.160,10.16.16.161
ServerActive=10.16.16.160</span></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.904.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.905.1">On the </span><strong class="source-inline1"><span class="kobospan" id="kobo.906.1">ServerActive</span></strong><span class="kobospan" id="kobo.907.1"> lines in our</span><a id="_idIndexMarker663" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.908.1"> configuration files, make sure to only include the Zabbix proxy we want to send</span><a id="_idIndexMarker664" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.909.1"> data to. </span><span class="kobospan" id="kobo.909.2">The Zabbix agent will actively try to send data to all our Zabbix proxies or Zabbix servers listed here, so we should only lis</span><a id="_idTextAnchor1617" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.910.1">t the one we want </span><span><span class="kobospan" id="kobo.911.1">to use.</span></span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.912.1">Restart your Zabbix agent by</span><a id="_idIndexMarker665" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.913.1"> executing the following commands in the Windows </span><span><span class="kobospan" id="kobo.914.1">command line:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.915.1">zabbix_agent2.exe --stop</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.916.1">zabbix_agent2.exe --start</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.917.1">Or, use the Windows </span><strong class="bold"><span class="kobospan" id="kobo.918.1">Services</span></strong><span class="kobospan" id="kobo.919.1"> window to restart </span><span><span class="kobospan" id="kobo.920.1">the agent.</span></span></p><p class="calibre3"><span class="kobospan" id="kobo.921.1">Next, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.922.1">Data collection</span></strong><span class="kobospan" id="kobo.923.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.924.1">Hosts</span></strong><span class="kobospan" id="kobo.925.1"> and delete the </span><span><span class="kobospan" id="kobo.926.1">discovered hosts:</span></span></p><pre class="source-code"><span class="kobospan1" id="kobo.927.1">lar-book-disc-lnx
lar-book-disc-win</span></pre><p class="calibre3"><span class="kobospan" id="kobo.928.1">We do this to prevent </span><span><span class="kobospan" id="kobo.929.1">duplicate hosts.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.930.1">Now, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.931.1">Data collection</span></strong><span class="kobospan" id="kobo.932.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.933.1">Discovery</span></strong></span><span><span class="kobospan" id="kobo.934.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.935.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.936.1">Discover Zabbix Agent hosts</span></strong><span class="kobospan" id="kobo.937.1"> and change the </span><strong class="bold"><span class="kobospan" id="kobo.938.1">Discovered by proxy</span></strong><span class="kobospan" id="kobo.939.1"> field,</span><a id="_idTextAnchor1618" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.940.1"> as shown in the </span><span><span class="kobospan" id="kobo.941.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer496">
<span class="kobospan" id="kobo.942.1"><img alt="Figure 8.29 – Alerts | Actions, Discovery Actions by proxy lar-book-proxy-active" src="image/8.29.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.943.1">Figure 8.29 – Alerts | Actions, Discovery Actions by proxy lar-book-proxy-active</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.944.1">Click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.945.1">Update</span></strong><span class="kobospan" id="kobo.946.1"> button, and</span><a id="_idIndexMarker666" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.947.1"> that’s all there is to editing your discovery r</span><a id="_idTextAnchor1619" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.948.1">ule to be monitored</span><a id="_idIndexMarker667" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.949.1"> by </span><span><span class="kobospan" id="kobo.950.1">a proxy.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.951.1">You can now check out your </span><a id="_idIndexMarker668" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.952.1">newly discovered hosts under </span><strong class="bold"><span class="kobospan" id="kobo.953.1">Configuration</span></strong><span class="kobospan" id="kobo.954.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.955.1">Hosts</span></strong><span class="kobospan" id="kobo.956.1"> and s</span><a id="_idTextAnchor1620" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.957.1">ee that they are monitored by </span><span><span class="kobospan" id="kobo.958.1">the proxy:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer497">
<span class="kobospan" id="kobo.959.1"><img alt="Figure 8.30 – Data collection | Hosts page with our discovered ho﻿sts" src="image/B19803_08_30.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.960.1">Figure 8.30 – Data collection | Hosts page with our discovered ho</span><a id="_idTextAnchor1621" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.961.1">sts</span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.962.1">Active agent autoregistration</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.963.1">Moving on to active agent autoregistration, let’s see</span><a id="_idIndexMarker669" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.964.1"> how we can do this from our </span><span><span class="kobospan" id="kobo.965.1">Zabbix proxy:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.966.1">Start by navigating to </span><strong class="bold"><span class="kobospan" id="kobo.967.1">Data collection</span></strong><span class="kobospan" id="kobo.968.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.969.1">Hosts</span></strong><span class="kobospan" id="kobo.970.1"> and deleting </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.971.1">lar-book-lnx- agent-auto</span></strong></span><span><span class="kobospan" id="kobo.972.1">.</span></span><p class="calibre3"><span class="kobospan" id="kobo.973.1">To do active agent autoregistration to a proxy, we have to log in to our </span><strong class="source-inline"><span class="kobospan" id="kobo.974.1">lar-book-lnx-agent-auto</span></strong> <span><span class="kobospan" id="kobo.975.1">host CLI.</span></span></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.976.1">Edit the Zabbix agent configuration file with the </span><span><span class="kobospan" id="kobo.977.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.978.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.979.1">Make sure to edit the following line to the Zabbix proxy address instead of the Zabbix </span><span><span class="kobospan" id="kobo.980.1">server a</span><a id="_idTextAnchor1622" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.981.1">ddress:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.982.1">
ServerActive=10.16.16.160</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.983.1">Restart the </span><span><span class="kobospan" id="kobo.984.1">Zabbix agent:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.985.1">systemctl restart zabbix-agent2</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.986.1">We can now see our host autoregister to the Za</span><a id="_idTextAnchor1623" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.987.1">bbix proxy instead of the </span><span><span class="kobospan" id="kobo.988.1">Zabbix server:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer498">
<span class="kobospan" id="kobo.989.1"><img alt="Figure 8.31 – Data collection | Hosts﻿﻿ page with our two auto ﻿registered hosts" src="image/B19803_08_30.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.990.1">Figure 8.31 – Data collection | Hosts</span><a id="_idTextAnchor1624" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1625" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.991.1"> page with our two auto </span><a id="_idTextAnchor1626" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.992.1">registered hosts</span></p>
<h2 id="_idParaDest-292" class="calibre7"><span class="kobospan" id="kobo.993.1">How it wo</span><a id="_idTextAnchor1627" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.994.1">rks…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.995.1">Discovery with a Zabbix </span><a id="_idIndexMarker670" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.996.1">proxy works the same as discovery with a Zabbix server. </span><span class="kobospan" id="kobo.996.2">The only thing that changes is the location of where we are registering to or </span><span><span class="kobospan" id="kobo.997.1">discovering from.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.998.1">If you want to learn more about the process of discovery and autoregistration, check out </span><a href="B19803_07.xhtml#_idTextAnchor1318" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.999.1">Chapter 7</span></em></span></a><span class="kobospan" id="kobo.1000.1">, </span><em class="italic"><span class="kobospan" id="kobo.1001.1">Using Discovery for Au</span><a id="_idTextAnchor1628" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1629" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1002.1">tomatic Creation</span></em><span class="kobospan" id="kobo.1003.1">, if you </span><span><span class="kobospan" id="kobo.1004.1">haven’t already.</span></span></p>
<h1 id="_idParaDest-293" class="calibre5"><a id="_idTextAnchor1630" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1005.1">Monitoring your Zabbix proxies</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1006.1">A lot of Zabbix users – or even</span><a id="_idIndexMarker671" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1007.1"> monitoring users in gener</span><a id="_idTextAnchor1631" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1008.1">al – forget a very important part of their monitoring. </span><span class="kobospan" id="kobo.1008.2">They forget to monitor the monitoring infrastructure. </span><span class="kobospan" id="kobo.1008.3">I want to make sure that when you set up Zabbix proxies, you also know how to monitor the health of </span><span><span class="kobospan" id="kobo.1009.1">these proxies.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1010.1">Le</span><a id="_idTextAnchor1632" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1633" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1011.1">t’s check out how to do so in </span><span><span class="kobospan" id="kobo.1012.1">this recipe.</span></span></p>
<h2 id="_idParaDest-294" class="calibre7"><a id="_idTextAnchor1634" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1013.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1014.1">For this recipe, we will need our new </span><strong class="source-inline"><span class="kobospan" id="kobo.1015.1">lar-book-proxy-active</span></strong><span class="kobospan" id="kobo.1016.1"> Zabbix proxy. </span><span class="kobospan" id="kobo.1016.2">We will also need our </span><a id="_idTextAnchor1635" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1636" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1017.1">Zabbix server to monitor the </span><span><span class="kobospan" id="kobo.1018.1">Zabbix proxy.</span></span></p>
<h2 id="_idParaDest-295" class="calibre7"><a id="_idTextAnchor1637" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1019.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1020.1">We are going to build some </span><a id="_idIndexMarker672" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1021.1">monitoring in our Zabbix frontend, but we’ll also check the integrated monitoring options for Zabbix proxies. </span><span class="kobospan" id="kobo.1021.2">Let’s start by building </span><span><span class="kobospan" id="kobo.1022.1">our own.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1023.1">Monitoring the proxy with Zabbix</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1024.1">We can monitor our Zabbix proxy </span><a id="_idIndexMarker673" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1025.1">with the Zabbix proxy itself to make sure we know exactly what’s </span><span><span class="kobospan" id="kobo.1026.1">going on:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.1027.1">Let’s start by logging in to our </span><strong class="source-inline1"><span class="kobospan" id="kobo.1028.1">lar-book-proxy-active</span></strong><span class="kobospan" id="kobo.1029.1"> Zabbix </span><span><span class="kobospan" id="kobo.1030.1">proxy CLI.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1031.1">Issue the following command to install Zabbix agent 2 for </span><span><span class="kobospan" id="kobo.1032.1">RHEL-based systems:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1033.1">dnf install zabbix-agent2</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.1034.1">For Ubuntu, issue </span><span><span class="kobospan" id="kobo.1035.1">this command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.1036.1">apt install zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1037.1">Edit the Zabbix agent configuration file by issuing the </span><span><span class="kobospan" id="kobo.1038.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1039.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1040.1">Edit the following lines to point </span><span><span class="kobospan" id="kobo.1041.1">toward </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1042.1">localhost</span></strong></span><span><span class="kobospan" id="kobo.1043.1">:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.1044.1">
Server=127.0.0.1
ServerActive=127.0.0.1</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1045.1">Also, make sure to add the hostname to the Zabbix </span><span><span class="kobospan" id="kobo.1046.1">agent file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1047.1">Hostname=lar-book-proxy-active</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1048.1">Now, log in to the Zabbix frontend and n</span><a id="_idTextAnchor1638" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1049.1">avigate to </span><strong class="bold"><span class="kobospan" id="kobo.1050.1">Data collection</span></strong><span class="kobospan" id="kobo.1051.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.1052.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.1053.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1054.1">Click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.1055.1">Create host</span></strong><span class="kobospan" id="kobo.1056.1"> button in the t</span><a id="_idTextAnchor1639" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1057.1">op-right corner and add the </span><span><span class="kobospan" id="kobo.1058.1">following host:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer499">
<span class="kobospan" id="kobo.1059.1"><img alt="Figure 8.32 – Data collection | Hosts, Create host popup, lar-book-proxy-active" src="image/B19803_08_32.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1060.1">Figure 8.32 – Data collection | Hosts, Create host popup, lar-book-proxy-active</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1061.1">Take extra care at the </span><strong class="bold"><span class="kobospan" id="kobo.1062.1">Monitored by proxy</span></strong><span class="kobospan" id="kobo.1063.1"> field – we want to monitor from the proxy because we are doing Zabbix internal checks, which need to be handled by the</span><a id="_idIndexMarker674" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1064.1"> Zabbix daemon that received </span><span><span class="kobospan" id="kobo.1065.1">this configuration.</span></span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.1066.1">Before clicking the blue </span><strong class="bold"><span class="kobospan" id="kobo.1067.1">Add</span></strong><span class="kobospan" id="kobo.1068.1"> button, make sure to add </span><strong class="bold"><span class="kobospan" id="kobo.1069.1">Template</span><a id="_idTextAnchor1640" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1070.1">s</span></strong><span class="kobospan" id="kobo.1071.1">. </span><span class="kobospan" id="kobo.1071.2">Add the following templates to </span><span><span class="kobospan" id="kobo.1072.1">the host:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer500">
<span class="kobospan" id="kobo.1073.1"><img alt="Figure 8.33 – Data collection | Hosts, Create host popup temp﻿lates for host lar-book-proxy-active" src="image/B19803_08_33.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1074.1">Figure 8.33 – Data collection | Hosts, Create host popup temp</span><a id="_idTextAnchor1641" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1075.1">lates for host lar-book-proxy-active</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.1076.1">We can now click the blue </span><strong class="bold"><span class="kobospan" id="kobo.1077.1">Add</span></strong><span class="kobospan" id="kobo.1078.1"> button to create </span><span><span class="kobospan" id="kobo.1079.1">the host.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1080.1">Now, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.1081.1">Monitoring</span></strong><span class="kobospan" id="kobo.1082.1"> | </span><a id="_idTextAnchor1642" class="pcalibre calibre6 pcalibre1"/><strong class="bold"><span class="kobospan" id="kobo.1083.1">Latest data</span></strong><span class="kobospan" id="kobo.1084.1"> and add the </span><span><span class="kobospan" id="kobo.1085.1">following filters:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer501">
<span class="kobospan" id="kobo.1086.1"><img alt="Figure 8.34 – Monitoring | Latest data page with filters, host lar-book-proxy-active" src="image/B19803_08_34.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1087.1">Figure 8.34 – Monitoring | Latest data page with filters, host lar-book-proxy-active</span></p>
<ol class="calibre16">
<li value="11" class="calibre15"><span class="kobospan" id="kobo.1088.1">We can now see </span><a id="_idIndexMarker675" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1089.1">our Zabbix proxy statistics, such as the number of processed values and </span><a id="_idTextAnchor1643" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1090.1">utilization of certain </span><span><span class="kobospan" id="kobo.1091.1">internal processes:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer502">
<span class="kobospan" id="kobo.1092.1"><img alt="Figure 8.35 – Monitoring | Latest data page with data from our Zabbix proxy" src="image/B19803_08_35.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1093.1">Figure 8.35 – Monitoring | Latest data page with data from our Zabbix proxy</span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1094.1">Monitoring the pr</span><a id="_idTextAnchor1644" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1095.1">oxy remotely from our Zabbix server</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1096.1">We can also monitor our </span><a id="_idIndexMarker676" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1097.1">Zabbix proxy remotely from our Zabbix server, so, let’s see how </span><span><span class="kobospan" id="kobo.1098.1">that works:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.1099.1">Let’s start by logging in to our </span><strong class="source-inline1"><span class="kobospan" id="kobo.1100.1">lar-book-proxy-active</span></strong><span class="kobospan" id="kobo.1101.1"> host CLI and editing the </span><span><span class="kobospan" id="kobo.1102.1">following file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1103.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1104.1">Edit the following lines to match your Zabbix server address (every node in a Zabbix server </span><span><span class="kobospan" id="kobo.1105.1">HA cluster):</span></span><pre class="source-code"><span class="kobospan1" id="kobo.1106.1">
Server=127.0.0.1,10.16.16.152
ServerActive=127.0.0.1,10.16.16.152</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1107.1">Also, edit the </span><span><span class="kobospan" id="kobo.1108.1">following file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1109.1">vim /etc/zabbix/zabbix_proxy.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1110.1">Edit the following line to match your Zabbix </span><span><span class="kobospan" id="kobo.1111.1">server address:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.1112.1">
StatsAllowedIP=127.0.0.1,10.16.16.152</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1113.1">Now, navigate to the Zabbix frontend and go to </span><strong class="bold"><span class="kobospan" id="kobo.1114.1">Data collection</span></strong><span class="kobospan" id="kobo.1115.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.1116.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.1117.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1118.1">Click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.1119.1">Create host</span></strong><span class="kobospan" id="kobo.1120.1"> button in the to</span><a id="_idTextAnchor1645" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1121.1">p-right corner and add the </span><span><span class="kobospan" id="kobo.1122.1">following host:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer503">
<span class="kobospan" id="kobo.1123.1"><img alt="Figure 8.36 – Data collection | Hosts, Create host po﻿pup, lar-book-proxy-active_remotely" src="image/B19803_08_36.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1124.1">Figure 8.36 – Data collection | Hosts, Create host po</span><a id="_idTextAnchor1646" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1125.1">pup, lar-book-proxy-active_remotely</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.1126.1">Before clicking</span><a id="_idIndexMarker677" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1127.1"> the blue </span><strong class="bold"><span class="kobospan" id="kobo.1128.1">Add</span></strong><span class="kobospan" id="kobo.1129.1"> button, make sure to add the right </span><strong class="bold"><span class="kobospan" id="kobo.1130.1">Templates</span><a id="_idTextAnchor1647" class="pcalibre calibre6 pcalibre1"/></strong><span class="kobospan" id="kobo.1131.1">. </span><span class="kobospan" id="kobo.1131.2">Add the following templates to </span><span><span class="kobospan" id="kobo.1132.1">the host:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer504">
<span class="kobospan" id="kobo.1133.1"><img alt="Figure 8.37 – Data collection | Hosts, create new host popup templates, lar-book-proxy-active_ remotely" src="image/B19803_08_37.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1134.1">Figure 8.37 – Data collection | Hosts, create new host popup templates, lar-book-proxy-active_ remotely</span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.1135.1">We can now click the blue </span><strong class="bold"><span class="kobospan" id="kobo.1136.1">Add</span></strong><span class="kobospan" id="kobo.1137.1"> button to create </span><span><span class="kobospan" id="kobo.1138.1">the host.</span></span><p class="calibre3"><span class="kobospan" id="kobo.1139.1">Back at </span><strong class="bold"><span class="kobospan" id="kobo.1140.1">Data collection</span></strong><span class="kobospan" id="kobo.1141.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1142.1">Hosts</span></strong><span class="kobospan" id="kobo.1143.1">, click on your new </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1144.1">lar-book-proxy-active_remotely</span></strong></span><span><span class="kobospan" id="kobo.1145.1"> host.</span></span></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.1146.1">Go to</span><a id="_idTextAnchor1648" class="pcalibre calibre6 pcalibre1"/> <strong class="bold"><span class="kobospan" id="kobo.1147.1">Macros</span></strong><span class="kobospan" id="kobo.1148.1"> and add the following </span><span><span class="kobospan" id="kobo.1149.1">two macros:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer505">
<span class="kobospan" id="kobo.1150.1"><img alt="Figure 8.38 – Data collection | Hosts, Edit host popup, Macros tab, lar-book-proxy-active_remotely" src="image/B19803_08_38.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1151.1">Figure 8.38 – Data collection | Hosts, Edit host popup, Macros tab, lar-book-proxy-active_remotely</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1152.1">Now, click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.1153.1">Update</span></strong><span class="kobospan" id="kobo.1154.1"> b</span><a id="_idTextAnchor1649" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1155.1">utton, and that’s it for </span><span><span class="kobospan" id="kobo.1156.1">this host.</span></span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.1157.1">If we navigate</span><a id="_idIndexMarker678" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1158.1"> to </span><strong class="bold"><span class="kobospan" id="kobo.1159.1">Monitoring</span></strong><span class="kobospan" id="kobo.1160.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1161.1">Latest data</span></strong><span class="kobospan" id="kobo.1162.1"> and check the items </span><a id="_idTextAnchor1650" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1163.1">for this host, we can see data </span><span><span class="kobospan" id="kobo.1164.1">coming in:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer506">
<span class="kobospan" id="kobo.1165.1"><img alt="Figure 8.39 – Monitoring | Latest data page for host lar-book-proxy-active_remotely" src="image/B19803_08_39.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1166.1">Figure 8.39 – Monitoring | Latest data page for host lar-book-proxy-active_remotely</span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1167.1">Monitoring</span><a id="_idTextAnchor1651" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1168.1"> the proxy from the Zabbix frontend</span></h3>
<ol class="calibre16">
<li value="1" class="calibre15"><span class="kobospan" id="kobo.1169.1">Let’s start this off by</span><a id="_idIndexMarker679" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1170.1"> navigating to </span><strong class="bold"><span class="kobospan" id="kobo.1171.1">Administration</span></strong><span class="kobospan" id="kobo.1172.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.1173.1">Queue</span></strong></span><span><span class="kobospan" id="kobo.1174.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1175.1">Use the drop-do</span><a id="_idTextAnchor1652" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1176.1">wn menu to go to </span><strong class="bold"><span class="kobospan" id="kobo.1177.1">Queue overview </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.1178.1">by proxy</span></strong></span><span><span class="kobospan" id="kobo.1179.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer507">
<span class="kobospan" id="kobo.1180.1"><img alt="Figure 8.40 – Administration | Queue menu" src="image/B19803_08_40.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1181.1">Figure 8.40 – Administration | Queue menu</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1182.1">This will bring us to the</span><a id="_idTextAnchor1653" class="pcalibre calibre6 pcalibre1"/><a id="_idIndexMarker680" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1183.1"> page shown in the </span><span><span class="kobospan" id="kobo.1184.1">following screenshot:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer508">
<span class="kobospan" id="kobo.1185.1"><img alt="Figure 8.41 – Administration | Queue overview by proxy page" src="image/B19803_08_41.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1186.1">Figure 8.41 – Administration | Queue overview by proxy page</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1187.1">Let’s see how this</span><a id="_idTextAnchor1654" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1655" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1188.1"> works in the next sectio</span><a id="_idTextAnchor1656" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1189.1">n of </span><span><span class="kobospan" id="kobo.1190.1">our recipe.</span></span></p>
<h2 id="_idParaDest-296" class="calibre7"><a id="_idTextAnchor1657" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1191.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1192.1">Monitoring your Zabbix proxies is an important task, thus we need to make sure that whenever we add a new Zabbix proxy, we are taking care of it like we would any </span><span><span class="kobospan" id="kobo.1193.1">other host.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1194.1">Monit</span><a id="_idTextAnchor1658" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1195.1">oring the proxy with Zabbix</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1196.1">By adding the Zabbix proxy as a </span><a id="_idIndexMarker681" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1197.1">host, we can make sure the Linux system that is running our Zabbix proxy is healthy. </span><span class="kobospan" id="kobo.1197.2">We also make sure that the Zabbix proxy applications running on this server are in </span><span><span class="kobospan" id="kobo.1198.1">good health.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1199.1">Besides having the right triggers in these templates, we also get a load of options to troubleshoot issues with the </span><span><span class="kobospan" id="kobo.1200.1">Zabbix proxy.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1201.1">The Zabbix proxy works just like the Zabbix server when it comes to monitoring. </span><span class="kobospan" id="kobo.1201.2">This means that just as with the Zabbix server, we need to keep the proxies in great health by tweaking the Zabbix proxy con</span><a id="_idTextAnchor1659" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1202.1">figuration file to </span><span><span class="kobospan" id="kobo.1203.1">our needs.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1204.1">Scaling your proxies becomes a lot easier once you figure out what’s going on with them. </span><span class="kobospan" id="kobo.1204.2">So, this is why we make sure to always monitor them. </span><span class="kobospan" id="kobo.1204.3">We monitor them from the proxy itself to make </span><a id="_idIndexMarker682" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1205.1">sure that we get the right information with the Zabbix </span><span><span class="kobospan" id="kobo.1206.1">internal checks.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1207.1">Monitoring the proxy remotely from our Zabbix server</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1208.1">Now, when we monitor with </span><strong class="bold"><span class="kobospan" id="kobo.1209.1">Remote Zabbix proxy heal</span><a id="_idTextAnchor1660" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1210.1">th</span></strong><span class="kobospan" id="kobo.1211.1">, things go a little differently. </span><span class="kobospan" id="kobo.1211.2">Instead of doing our checks from the</span><a id="_idIndexMarker683" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1212.1"> Zabbix proxy itself, we do them remotely from the Zabbix server by defining the Zabbix proxy address and port in the macros. </span><span class="kobospan" id="kobo.1212.2">The Zabbix internal check type will still be used for this, executing the checks from the Zabbix server to the Zabbix proxy remotely in </span><span><span class="kobospan" id="kobo.1213.1">this case.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1214.1">On top of that, it is of course still recommended that we also keep our Zabbix agen</span><a id="_idTextAnchor1661" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1215.1">t running in either passive or </span><span><span class="kobospan" id="kobo.1216.1">active mode.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer509">
<span class="kobospan" id="kobo.1217.1"><img alt="Figure 8.42 – Zabbix agent running on Zabbix proxy monitored by Zabbix server" src="image/B19803_08_42.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1218.1">Figure 8.42 – Zabbix agent running on Zabbix proxy monitored by Zabbix server</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1219.1">This way, our Zabbix server is the one requesting and receiving information. </span><span class="kobospan" id="kobo.1219.2">Even when the proxy is having issues, the checks will still be done by the </span><span><span class="kobospan" id="kobo.1220.1">Zabbix server.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1221.1">We can use this template as a way to keep a closer eye on our proxy if we suspect issues with internal checks being performed locally, or we can use this template to bypass certain firewall setups. </span><span class="kobospan" id="kobo.1221.2">Both are </span><span><span class="kobospan" id="kobo.1222.1">valid reasons.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.1223.1">Monitoring </span><a id="_idTextAnchor1662" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1224.1">the proxy from the Zabbix frontend</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.1225.1">From the frontend, we can use the </span><strong class="bold"><span class="kobospan" id="kobo.1226.1">Administration</span></strong><span class="kobospan" id="kobo.1227.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1228.1">Queue</span></strong><span class="kobospan" id="kobo.1229.1"> page to monitor our proxies. </span><span class="kobospan" id="kobo.1229.2">The Zabbix </span><strong class="bold"><span class="kobospan" id="kobo.1230.1">Queue</span></strong><span class="kobospan" id="kobo.1231.1"> page is an important page, but a lot of new users neither know nor fully utilize </span><span><span class="kobospan" id="kobo.1232.1">this page.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1233.1">When a part of Zabbix starts</span><a id="_idIndexMarker684" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1234.1"> performing poorly, such as our example Zabbix proxy here, that’s when we can see stuff happening in the queue. </span><span class="kobospan" id="kobo.1234.2">There are six options on the Zabbix </span><span><strong class="bold"><span class="kobospan" id="kobo.1235.1">Queue</span></strong></span><span><span class="kobospan" id="kobo.1236.1"> page:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span><strong class="bold"><span class="kobospan" id="kobo.1237.1">5 seconds</span></strong></span></li>
<li class="calibre15"><span><strong class="bold"><span class="kobospan" id="kobo.1238.1">10 seconds</span></strong></span></li>
<li class="calibre15"><span><strong class="bold"><span class="kobospan" id="kobo.1239.1">30 seconds</span></strong></span></li>
<li class="calibre15"><span><strong class="bold"><span class="kobospan" id="kobo.1240.1">1 mi</span><a id="_idTextAnchor1663" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1241.1">nute</span></strong></span></li>
<li class="calibre15"><span><strong class="bold"><span class="kobospan" id="kobo.1242.1">5 minutes</span></strong></span></li>
<li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.1243.1">More than </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.1244.1">10 minutes</span></strong></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1245.1">What the options in the </span><strong class="bold"><span class="kobospan" id="kobo.1246.1">Queue</span></strong><span class="kobospan" id="kobo.1247.1"> mean is that the Zabbix proxy has been waiting on receiving a value that’s configured more than expected. </span><span class="kobospan" id="kobo.1247.2">I would state that anything up to one minute doesn’t necessarily have to be an issue, but this depends on the type of check. </span><span class="kobospan" id="kobo.1247.3">The </span><strong class="bold"><span class="kobospan" id="kobo.1248.1">5 minutes</span></strong><span class="kobospan" id="kobo.1249.1"> or </span><strong class="bold"><span class="kobospan" id="kobo.1250.1">More than 10 minutes</span></strong><span class="kobospan" id="kobo.1251.1"> options can mean serious performance issues with your Zabbix proxy, and you would have to troubleshoot this issue. </span><span class="kobospan" id="kobo.1251.2">Make sure to keep a good eye on the Zabbix queue when you suspect issues, which are also included as triggers in the templates we added to monitor our </span><span><span class="kobospan" id="kobo.1252.1">Zabbix proxies.</span></span></p>
</div>
</body></html>