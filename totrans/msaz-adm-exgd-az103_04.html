<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Managing Role-Based Access Control</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered the second part of this book's objective by covering how to analyze resource utilization and consumption in Azure</span><span>. We've covered how to monitor different Azure resources using Azure Monitor, and how to use Azure Log Analytics to query the logs. </span></p>
<p><span>This chapter will cover</span><span> </span><span>the last </span><span>part o</span>f the <em>Managing Azure Subscriptions and Resources</em><span> objective</span> by<span> </span><span>covering <strong>role-based access control</strong> (<strong>RBAC</strong>). You'll learn how to configure access to Azure resources by assigning RBAC roles from the Azure portal. You'll also learn </span><span>how to configure management access by assigning global administrators to your Azure subscription and other resources. You'll learn how to create custom roles, which you can apply when custom permissions are needed for your users. This chapter will finish by covering Azure policies and how you can apply them to your Azure resources</span><span>.</span></p>
<p><span>The following topics will be covered in this chapter:</span></p>
<ul>
<li>RBAC</li>
<li>Configuring access to Azure resources by assigning roles</li>
<li><span>Configuring</span><span> </span>management access<span> </span><span>to Azure</span></li>
<li>Creating a custom role</li>
<li>Azure Policy</li>
<li><span>Implementing and assigning Azure policies</span></li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter will use the <span>Azure PowerShell</span><span> (<a href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0">https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0</a>) for the examples.</span></p>
<p>The source code for the sample application can be downloaded from<span> <a href="https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter03">https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter03</a>.</span><a href="https://github.com/PacktPublishing/Microsoft-Azure-Integration-and-Security-Exam-Guide-AZ-101/tree/master/Chapter11"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">RBAC</h1>
                </header>
            
            <article>
                
<p>With<span> </span><span>RBAC, you can manage who has access to the different Azure resources inside of your tenant. You can also set what the users can do with different Azure resources.</span></p>
<p>A best practice for assigning permissions is using the <span>principle of least </span>permissions; this involves giving users the exact permissions they need to do their jobs properly. <span>Users,</span> groups<span>, and applications are added to roles in Azure, and those roles have certain </span>permissions<span>. You can use the built-in roles that Azure offers, or you can create custom roles</span> in <span>RBAC.</span></p>
<p>The roles in Azure can be added to a certain scope. This scope can be an Azure subscription, an Azure resource group, or a web application. Azure then uses access inheritance; roles that are added to a parent resource give access to child resources automatically. For instance, a group that is added to an Azure subscription gets access to all the resource groups and underlying resources that are in that subscription as well. A user that is added to a<span> </span><strong>virtual machine</strong><span> </span>(<strong>VM</strong>) only gets access to that particular VM.</p>
<p>Let's start looking at RBAC in detail by first looking at built-in roles.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Built-in roles</h1>
                </header>
            
            <article>
                
<p>Azure offers various built-in roles that you can use for assigning permissions to users, groups, and applications. RBAC offers the following three standard roles that you can assign to each Azure resource:</p>
<ul>
<li><strong>Owner</strong>: Users in this role can manage everything, and can create new resources.</li>
<li><strong>Contributor</strong>: Users in this role can manage everything, just like users in the owner role, but they can't assign access to others.</li>
<li><strong>Reader</strong>: Users in this role can read everything, but they are not allowed to make any changes.</li>
</ul>
<p>Aside from the standard roles, each Azure resource also has roles that are scoped to particular resources. For instance, you can assign users, groups, or applications to the SQL security manager, from which they can manage all security-related policies of the Azure SQL Server, or you<span> </span>can assign them to the VM contributor role, where they can manage the VMs, but not the VNet or storage accounts that are connected<span> </span>to a VM.</p>
<div class="packt_infobox">For an overview of all the built-in roles that Azure offers, you can refer to <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles">https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles</a>.</div>
<p>While these built-in roles usually cover all possible use cases, they can never account for every requirement in an organization. To allow for flexibility in role assignment, RBAC provides the ability to make custom roles. Let's look at this feature.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Custom roles</h1>
                </header>
            
            <article>
                
<p>You can also create custom roles in RBAC when none of the built-in roles suit your needs. Custom roles can be assigned to the exact same resources as built-in<span> </span>roles<span> </span>and can only be<span> </span>created using PowerShell, the CLI, and the REST API. You can't create them in the Azure portal. In each Azure tenant, you can create up to 2,000 roles.</p>
<p>Custom roles are defined in JSON, and after deployment, they are stored inside the Azure AD tenant. By storing them inside the Azure AD tenant, they can be used in all the<span> </span>different Azure subscriptions that are connected to the Azure AD tenant.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring access to Azure resources by assigning roles</h1>
                </header>
            
            <article>
                
<p>If a user in your organization needs permissions to access Azure resources, you need to assign the user to the appropriate role in Azure. In this demonstration, we are going to assign administrator access to a user for a VM. To configure access to the VM for the user, you have to perform the following steps:</p>
<ol>
<li><span>Navigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a>.<a href="https://portal.azure.com"/></li>
<li>Open the<span> </span><kbd>PacktNetworkWatcher</kbd><span> </span>resource group and select<span> </span><span class="packt_screen">VM1</span><span> </span>from the list:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e091c8c0-d990-44d8-a85e-3343ac7af461.png"/></p>
<div class="mce-root packt_figref CDPAlignCenter CDPAlign">The PacktNetworkWatcher resources</div>
<ol start="3">
<li>You will be redirected to the VM settings blade.</li>
</ol>
<ol start="4">
<li>In the settings blade, select <span class="packt_screen">Access control (IAM)</span><span> </span><span>and click on </span><span class="packt_screen"><span><strong>A</strong></span>dd |</span><span class="packt_screen"> Add role assignment</span><span><strong> </strong>in the top menu:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c38835bf-4580-4fd2-b21c-876f69ef37fc.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Access control settings</span><strong><span><br/></span></strong></div>
<ol start="5">
<li>In the <span class="packt_screen">Add role assignment</span><span> </span>blade, specify the following values:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/37995879-b452-4f40-ad19-b6de16e54cff.png" style="width:28.33em;height:31.17em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">The Add role assignment blade</div>
<ol start="6">
<li>Click on <span class="packt_screen">Save</span>.</li>
<li>The user now has administrator permissions on the VM.</li>
</ol>
<p>In this demonstration, <span>we assigned administrator access to </span>a<span> user for a VM. We are now going to look at how to configure management access to Azure.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring management access to Azure</h1>
                </header>
            
            <article>
                
<p>Management access to Azure can be configured at the subscription level. To do this, perform the following steps:</p>
<ol>
<li><span>N</span><span>avigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a>.</li>
<li>Select <span class="packt_screen">All services </span>and type<span> </span><kbd>subscriptions</kbd> in the search box. Then, select <span class="packt_screen">Subscriptions</span>, as highlighted in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7d11de38-2dec-42ad-921c-c251719feb06.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Selecting subscriptions</div>
<ol start="3">
<li>Select the subscription that you want to grant management access to from the list.</li>
</ol>
<ol start="4">
<li><span>In the</span> subscription settings blade, <span>select </span><span class="packt_screen"><span>Access control</span><span> </span><span>(IAM)</span></span><span> and click on <span class="packt_screen">Add</span></span> | <span><span class="packt_screen">Add co-administrator</span><strong> </strong>in the top menu</span><span>:<br/></span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b49da0c7-7154-48e5-8e65-881e79f7aa77.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>The access control settings</span></div>
<ol start="5">
<li>In the <span class="packt_screen">Add co-administrator</span><span> </span>blade, specify the following values:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/bbcd21ac-ddd2-4741-8876-086010e11f99.png" style="width:28.75em;height:32.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Adding a co-administrator</div>
<ol start="6">
<li>Click on <span class="packt_screen">Add</span>.</li>
</ol>
<p>Now that we have configured management access to Azure, we are going to look at how to create a custom role for your users.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a custom role</h1>
                </header>
            
            <article>
                
<p>In the following example, we will create a custom role that can only restart VMs in Azure. For this, you need to create a JSON file that will be deployed using PowerShell. We are assigning that role to a user account inside the JSON file, as follows:</p>
<ol>
<li>You can define the custom role by using the following JSON code. You should set<span> the </span><kbd>Id</kbd><span> </span>to null because the custom role<span> </span>gets<span> </span>an ID assigned to it at creation. We will add the custom role to two Azure subscriptions, as follows (replace the subscriptions in the <kbd>AssignableScopes</kbd> part with your subscription IDs):</li>
</ol>
<pre style="padding-left: 60px" class="mce-root"> <span>{</span> <br/>"Name": "Packt Custom Role",<br/> "Id": null,<br/> "IsCustom": true,<br/> "Description": "Allows for read access to Azure Storage, Network and Compute resources and access to support",<br/>    "Actions": [<br/>        "Microsoft.Compute/*/read",<br/>        "Microsoft.Storage/*/read",<br/>        "Microsoft.Network/*/read",<br/>        "Microsoft.Resources/subscriptions/resourceGroups/read",<br/>        "Microsoft.Support/*"<br/>    ],<br/>    "NotActions": [<br/>    ],<br/>    "AssignableScopes": [<br/>    "/subscriptions/********-****-****-****-***********",<br/>    "/subscriptions/********-****-****-****-***********"<br/>    ]<br/>}</pre>
<ol start="2">
<li>Save the JSON file in a folder named<span> </span><kbd>CustomRoles</kbd><span> </span>on<span> </span>the<span> </span><kbd>C:</kbd><span> </span>drive of your computer. Then, run the following PowerShell script to create the role. First, log in to your Azure account, as follows:</li>
</ol>
<pre style="padding-left: 60px" class="mce-root"><strong>Connect-AzAccount</strong></pre>
<ol start="3">
<li class="mce-root">If necessary, select the right subscription:</li>
</ol>
<pre style="color: black;padding-left: 60px"><strong>Select-AzSubscription -SubscriptionId "********-****-****-****-***********"</strong></pre>
<ol start="4">
<li>Then, create the custom role in Azure by importing the JSON file into PowerShell:</li>
</ol>
<pre style="padding-left: 60px"><strong><span>New-AzRoleDefinition</span> -InputFile "C:\CustomRoles\PacktCustomRole.json"</strong></pre>
<p>In this demonstration, we created <span>a custom role that can only restart VMs in Azure. Now, we're going to take a look at how you can create policies using Azure Policy.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Azure Policy</h1>
                </header>
            
            <article>
                
<p>With Azure Policy, you can create policies that enforce rules over your Azure resources. This way, resources stay compliant with s<span>ervice-level agreements and </span>corporate standards. With Azure Policy, you can evaluate all the different Azure resources for non-compliance. For example, you can create a policy to allow only a certain size of VM in your Azure environment. When the policy is created, Azure will check all the new and existing VMs to see whether they apply to this policy. </p>
<p>Azure Policy is different than RBAC because Azure Policy <span>focuses on resource properties for existing resources and during deployment. RBAC focuses on user actions at different scopes. A user can be added to the owner role in a resource group, for instance, which will give the user full rights to that resource group.</span></p>
<p>Azure offers built-in policies and custom policies. Some examples of these built-in policies are as follows:</p>
<ul>
<li><strong>Allowed VM<span> </span>SKUs</strong>: This policy specifies a set of VM sizes and types that can be deployed in Azure.</li>
<li><strong>Allowed locations</strong><span>: This policy restricts the available locations where resources can be deployed.</span></li>
<li><strong>Not allowed resource types</strong>: This policy prevents certain resource types from being deployed.</li>
<li><strong>Allowed resource types</strong>: This policy defines a list of resource types that you can deploy. Resource types that are not on the list can't be deployed inside the Azure environment.</li>
<li><strong>Allowed storage<span> a</span>ccount SKUs</strong><span>: This policy s</span>pecifies a set of storage account SKUs that can be deployed.</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>
<p>If the built-in policies don't match with your requirements, you can create a custom policy instead. Custom policies are created in JSON and look like the following example. The first part of the code sets the different properties: </p>
<pre>{<br/>    "properties": {<br/>        "displayName": "Deny storage accounts not using only HTTPS",<br/>        "description": "Deny storage accounts not using only HTTPS. Checks the supportsHttpsTrafficOnly property on StorageAccounts.",<br/>        "mode": "all",<br/>        "parameters": {<br/>            "effectType": {<br/>                "type": "string",<br/>                "defaultValue": "Deny",<br/>                "allowedValues": [<br/>                    "Deny",<br/>                    "Disabled"<br/>                ],<br/>                "metadata": {<br/>                    "displayName": "Effect",<br/>                    "description": "Enable or disable the execution of the policy"<br/>                }<br/>            }<br/>        },<br/> </pre>
<p><span>In this part of the code, we are looking at the policy rule:</span></p>
<pre>       "policyRule": {<br/>            "if": {<br/>                "allOf": [<br/>                    {<br/>                        "field": "type",<br/>                        "equals": "Microsoft.Storage/storageAccounts"<br/>                    },<br/>                    {<br/>                        "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",<br/>                        "notEquals": "true"<br/>                    }<br/>                ]<br/>            },<br/>            "then": {<br/>                "effect": "[parameters('effectType')]"<br/>            }<br/>        }<br/>    }<br/>}</pre>
<p class="mce-root"/>
<p>Policies are assigned at the m<span>anagement</span> g<span>roup</span><span> </span><span>level,</span> the subscription level, or the resource group level.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Implementing and assigning Azure policies</h1>
                </header>
            
            <article>
                
<p>To implement Azure policies, you have to assign them. In this demonstration, we are going to assign an <span class="packt_screen">Allowed location</span> policy to an Azure resource group. Therefore, you have to perform the following steps:</p>
<ol>
<li><span>Navigate to the Azure portal by opening </span><a href="https://portal.azure.com">https://portal.azure.com</a><span>.</span></li>
<li>Open the <kbd>PacktNetworkWatcher</kbd><strong> </strong>resource group.</li>
<li>Then, under <span class="packt_screen">Settings</span>, select <span class="packt_screen">Policies</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/728a0328-422b-4678-836c-b4be750c988b.png" style="width:45.42em;height:34.58em;"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Policies<strong><br/></strong></div>
<ol start="4">
<li>Click on the <span class="packt_screen">Getting started</span><span> </span>menu item. You will see a page that is similar to the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f92200b3-4207-4b84-ad2d-3f2af7a600a3.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Getting started with Azure policies</div>
<ol start="5">
<li>The first step is to view and select the policy definition. Select the <span class="packt_screen">View Definitions</span> link on the page.</li>
</ol>
<ol start="6">
<li class="CDPAlignLeft CDPAlign">You will go to the available built-in and custom policies inside your subscription. On the right-hand side, type <kbd>Locations</kbd><span> </span>in the search<span> </span>bar:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/451f7474-0a62-4c0c-964f-52e2ac2b1cb9.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Searching for a locations policy</div>
<ol start="7">
<li>Then, select the <span class="packt_screen">Allowed locations</span><strong> </strong>policy; you will be redirected to the blade where you can see the policy definition in JSON and assign the policy:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/de99f24d-f72d-48ee-82b1-7baa5ebbd272.png" style="width:46.75em;height:33.58em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Policy definition</div>
<ol start="8">
<li>Click<span> on </span><span class="packt_screen">Assign</span><span> </span>in the top menu.</li>
<li>To assign the policy, you have to fill in the following values:
<ul>
<li><strong><span class="packt_screen">Scope</span></strong>: Select a subscription, and, optionally, a resource group. I've selected the <kbd>PacktNetworkWatcher</kbd><span> </span>resource group for this demonstration.</li>
<li><span class="packt_screen">Allowed locations</span>: Only select <span class="packt_screen">West Europe</span>, as demonstrated in the following screenshot:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b5645eae-dcd9-4d5e-98b0-3920a261d0e3.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Assigning the policy definition</span></div>
<ol start="10">
<li>Click on <span class="packt_screen">Assign</span>. The policy will be assigned to the resource group. </li>
</ol>
<ol start="11">
<li>Now, when we add a new resource to the resource group (such as a new VM, for instance) and set the location to<span> </span><span class="packt_screen">East US</span>, we will notice a validation error on the top-left of the screen. When you click on it, you will see the following details on the right-hand side of the screen:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/30a90779-cf1a-4d29-8602-bdf9704fcb81.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Validation error</div>
<p>In this section, we covered how to assign a policy in Azure.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we covered the third part of the <em>Managing Azure Subscriptions and Resources </em>objective by covering how to configure access to Azure resources by assigning roles, how to configure management access, how to create a custom role, how to assign RBAC roles, and how to implement and assign Azure policies.</span></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>In the next chapter, which will introduce a new objective for<em> </em>implementing and managing storage, we are going to cover how to create and configure storage accounts.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</span></p>
<ol>
<li>With Azure Policy, can you assign permissions to users, giving them access to your Azure resources?<br/>
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
<li>Suppose that you want to check whether all the VMs inside your Azure subscription use managed disks. Can you use Azure Policy for this?<br/>
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>
<ol start="3">
<li>Are custom policies created in XML?<br/>
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can checkout the following links for more information about the topics that were covered in this chapter:</span></p>
<ul>
<li><em>What is role-based access control (RBAC) for Azure resources?</em>: <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/overview">https://docs.microsoft.com/en-us/azure/role-based-access-control/overview</a></li>
<li><em>Troubleshoot RBAC for Azure resources</em>: <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/troubleshooting">https://docs.microsoft.com/en-us/azure/role-based-access-control/troubleshooting</a></li>
<li><em>Overview of the Azure Policy service</em>: <a href="https://docs.microsoft.com/en-us/azure/governance/policy/overview">https://docs.microsoft.com/en-us/azure/governance/policy/overview</a></li>
<li><em>Create a custom policy definition</em>: <a href="https://docs.microsoft.com/en-us/azure/governance/policy/tutorials/create-custom-policy-definition">https://docs.microsoft.com/en-us/azure/governance/policy/tutorials/create-custom-policy-definition</a></li>
</ul>


            </article>

            
        </section>
    </body></html>