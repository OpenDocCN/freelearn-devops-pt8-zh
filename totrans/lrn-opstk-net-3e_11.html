<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Router Redundancy Using VRRP</h1>
                </header>
            
            <article>
                
<p>In the Juno release of OpenStack, the Neutron community introduced two methods of attaining high availability in routing. This chapter focuses on a method that uses the Virtual Routing Redundancy Protocol, also known as VRRP, to implement redundancy between two or more Neutron routers. High availability using distributed virtual routers, otherwise known as DVR, will be discussed in <a href="b441728b-4377-43cf-b675-166266fef6c9.xhtml"><em><span class="ChapterrefPACKT">Chapter 12</span></em></a><span><em>, <span class="ItalicsPACKT">Distributed Virtual Routers</span></em>.</span></p>
<p>In the previous chapter, we explored the concept of standalone routers and how they allow users to route traffic between project networks and external networks as well as provide network address translation for instances managed by the user. In this chapter, we will cover the following topics:</p>
<ul>
<li>High availability of routing using keepalived and VRRP</li>
<li>Installing and configuring additional L3 agents</li>
<li>Demonstrating the creation and management of a highly-available router</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using keepalived and VRRP to provide redundancy</h1>
                </header>
            
            <article>
                
<p><span class="KeyWordPACKT">Keepalived</span> is a software package for Linux that provides load balancing and high availability to Linux-based software and infrastructures.</p>
<p><span>The <span class="KeyWordPACKT">Virtual Router Redundancy Protocol</span>, or VRRP, is a first hop redundancy protocol that aims to provide high availability of a network's default gateway by allowing two or more routers to provide backup for that address. If the active router fails, a backup router will take over the address within a brief period of time. VRRP is an open standard and is based on the proprietary Hot Standby Router Protocol, or HSRP, developed by Cisco.</span></p>
<p>Neutron uses keepalived, which utilizes VRRP, to provide failover between multiple sets of router namespaces.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VRRP groups</h1>
                </header>
            
            <article>
                
<p>With VRRP, a group of routers can be configured to act as a single virtual router. Routers in the VRRP group elect a master to act as the active gateway device, and hosts in the network only need to configure the virtual router address as their default network gateway or next hop address. When a failover occurs, another router in the group will take over routing duties while the configuration of hosts in the network never changes.</p>
<div class="packt_infobox">A VRRP virtual router should not be confused with a Neutron virtual router. The former represents a logical entity, while the latter actually exists as a virtualized routing device, typically implemented as a network namespace.</div>
<p>In the following diagram, <span class="packt_screen">Router A</span>, <span class="packt_screen">Router B</span>, and <span class="packt_screen">Router C</span> form a single virtual router. In this configuration, each router has its own IP address and the virtual router has its own IP address. Hosts in the network use the virtual router address as their default gateway:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/080aa743-df33-458e-98db-67c3c051babf.png" style="width:28.50em;height:28.33em;"/></p>
<p>As the master router, <span class="packt_screen">Router B</span> in the preceding diagram is responsible for the virtual address <kbd>192.168.1.1</kbd>, and routes traffic for hosts using that address as their gateway. The master router sends VRRP advertisements to the group, which include the priority and state of the master router using the multicast address <kbd>224.0.0.18</kbd>. The backup routers use a variety of timers and configuration options to determine when a master router has failed and change their state accordingly.</p>
<div class="packt_infobox">Routers that make up the virtual router communicate between themselves using the multicast IP address <kbd>224.0.0.18</kbd> and IP protocol number 112. The network setup for this communication is automatically configured and is not impacted by security group rules or manageable by users or operators.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VRRP priority</h1>
                </header>
            
            <article>
                
<p>Routers in the VRRP group elect a master router according to their priorities. The router with the highest priority is elected master, while the other routers in the group are relegated to backup duties. When a master router fails to send its VRRP advertisements to the group, the backup routers in the VRRP group elect a new master to replace the failed master.</p>
<p>VRRP priorities range from 0 to 255, with 255 being the highest priority. Neutron configures each router in a group with the same priority of 50. Because the priority is the same between routers, in the event of a failover, the election process falls back to the highest IP address. That is to say that a backup router with IP address <kbd>192.168.1.200</kbd> on the HA interface will be elected master over a router with IP address <kbd>192.168.1.100</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VRRP working mode</h1>
                </header>
            
            <article>
                
<p>A router in a VRRP group works in one of two modes: preemptive and non-preemptive.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Preemptive</h1>
                </header>
            
            <article>
                
<p><span>In <span class="KeyWordPACKT">preemptive</span> mode, when a master router fails, it becomes the master router again when it returns to a group and has a higher priority than the newly elected master.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Non-preemptive</h1>
                </header>
            
            <article>
                
<p><span>In <span class="KeyWordPACKT">non-preemptive</span> mode, when a router in a VRRP group becomes the master, it continues to operate as the master under normal working conditions. If a backup router is assigned a higher priority later, the active master router will continue to operate as the master until it fails.</span></p>
<p>As of the Kilo release of OpenStack, Neutron configures each router to act in non-preemptive mode, although this may change in the future. In the event of a failure of the HA network, which is used for communication between the routers, a failed master router may not detect that it has failed. It can continue to operate as a master router, even though another router has been elected master. The lack of connectivity between the routers means that all routers may not receive VRRP advertisements. When connectivity is re-established, the routers may engage in an election to determine a single master router. This failure scenario is not common, but one to keep in mind when troubleshooting issues with highly-available routers.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VRRP timers</h1>
                </header>
            
            <article>
                
<p><span>Timers that are used within VRRP include an <span class="KeyWordPACKT">advertisement interval timer</span> and a <span class="KeyWordPACKT">preemption delay timer</span>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Advertisement interval timer</h1>
                </header>
            
            <article>
                
<p><span>The master router in a VRRP group periodically sends advertisements on an interval established by the <span class="KeyWordPACKT">advertisement interval timer</span> to inform other routers in the group that it is operating properly. If a backup router does not receive advertisements in a period of three times the interval, the backup regards itself as the master and sends VRRP advertisements to start a new master election process. Neutron routers in a master state are configured to send advertisements every two seconds.</span></p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Preemption delay timer</h1>
                </header>
            
            <article>
                
<p><span>After a backup router receives an advertisement with a priority lower than itself, it waits for a period of time established by the <span class="KeyWordPACKT">preemption delay timer</span> before sending out VRRP advertisements to start a new master election. This delay helps the routers avoid frequent state changes among members of the VRRP group in cases of network flapping. Because preemption is not enabled within Neutron routers, this timer is not configured.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Networking of highly available routers</h1>
                </header>
            
            <article>
                
<p>When a highly-available router is created, Neutron creates a VRRP group composed of at least two router namespaces by default. The namespaces are spread across multiple hosts running the Neutron L3 agent, and each runs the keepalived service with an automatically generated configuration. Traffic between the routers uses a dedicated network interface, which is discussed in the following section.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Dedicated HA network</h1>
                </header>
            
            <article>
                
<p>Routers in a VRRP group communicate among one another over a dedicated HA network. An HA router is automatically configured with an interface prefixed with that is only used for this communication.</p>
<p>The first time an HA router is created in a project, Neutron configures a network and subnet using the CIDR <kbd>169.254.192.0/18</kbd>. The network type used is based on the default project network type. Only one HA network is created per project, and it is used by all HA routers that are created by that project. If all HA routers in a project are deleted, the HA network will remain and will be reused for all other HA routers that get created by the project in the future.</p>
<div class="packt_infobox">Networks created by Neutron for VRRP communication between routers are not actually assigned to projects. As a result, these networks are hidden from regular users in the CLI and GUI. The name of the network reflects the associated project, however, and is used by the L3 agent for identification purposes. Under normal conditions, an HA network should remain hidden and not be modified by users or administrators.</div>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Limitations</h1>
                </header>
            
            <article>
                
<p><span>VRRP utilizes a <span class="KeyWordPACKT">virtual router identifier</span>, or VRID, to exchange VRRP protocol messages over multicast with other routers using the same VRID to determine which is the master router. The VRID is 8 bits in length and the valid range is 1-255. Because each project uses a single administrative network for VRRP communication between routers, individual projects are limited to 255 highly-available routers.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Virtual IP</h1>
                </header>
            
            <article>
                
<p>A VRRP virtual router has a virtual IP address that can serve as the default gateway for hosts in the network. The master router owns the IP address until a failover event occurs, at which time a backup router becomes the new master and takes over the IP and associated routing duties.</p>
<p>Due to limitations with keepalived, Neutron HA routers do not completely follow the VRRP networking conventions described up to this point. Neutron assigns a single virtual IP to an HA router, and that virtual IP is only configured on the master router in the group at any given time. While the address does fail over between routers during a failover event, it is not actually used as a gateway address for any network. As HA routers are created, a new virtual IP address is assigned to the respective group.</p>
<div class="packt_infobox">Neutron assigns virtual IP addresses from the <kbd>169.254.0.0/24</kbd> network by default. If an HA router's VRID is 5, then the assigned virtual IP would be <kbd>169.254.0.5</kbd>. Using the VRID in the virtual IP assignment process assures that the address is consistent among HA router instances on different nodes without having to be stored in the database.</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Instead of using virtual addresses for each connected subnet, Neutron uses the <kbd><span class="CodeInTextPACKT">virtual_ipaddress_excluded</span></kbd> configuration section found within the <kbd>keepalived configuration</kbd> file to specify routes, addresses, and their respective interfaces that should be configured when a router becomes master for the group. Likewise, the interface configuration will be removed once the router becomes a backup router. The following screenshot demonstrates various interfaces and routes that will be modified:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f9b3befd-420d-4910-9529-7347e2154b17.png" style="width:37.17em;height:28.33em;"/></p>
<p>The keepalived configuration file for an HA router will be discussed in further detail later in this chapter.</p>
<div class="packt_infobox">The reason for this behavior is due to the keepalived service being limited to 20 configured virtual addresses, which could artificially limit the number of subnets attached to a Neutron router. The use of <kbd><span class="CodeInTextPACKT">virtual_ipaddress_excluded</span></kbd> is a known workaround of that limitation.</div>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Determining the master router</h1>
                </header>
            
            <article>
                
<p>In the following screenshot, an HA router without any connected gateway or project networks is scheduled across three L3 agents running on a single <kbd>controller</kbd> and two compute nodes:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/59b9a246-80eb-4226-9244-9793e4d9395f.png"/></p>
<p> </p>
<div class="packt_infobox">The Neutron L3 agent is commonly installed on controller or network nodes, but can be installed on <kbd>compute</kbd> nodes as well. This is especially true when distributed virtual routers are configured.</div>
<p>In the preceding example, one router acts as the master while the other two are relegated to backup duties. The HA <span>interfaces are used for communication between the routers. At any given time, <span class="ItalicsPACKT">only</span> the master router should have the virtual IP address <kbd>169.254.0.1</kbd> configured on its</span> <span class="CodeInTextPACKT">HA</span> interface.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing and configuring additional L3 agents</h1>
                </header>
            
            <article>
                
<p>To configure HA routers, two or more L3 agents are required. The L3 agent was installed on the <kbd>controller01</kbd> node in the previous chapter. On all remaining <kbd>compute</kbd> nodes, run the following command to install the L3 agent:</p>
<pre># apt install neutron-l3-agent </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Defining an interface driver</h1>
                </header>
            
            <article>
                
<p>Both the Linux bridge and Open vSwitch mechanism drivers support HA routers, and the Neutron L3 agent must be configured to use the interface driver that corresponds to the chosen mechanism driver.</p>
<p>Update the Neutron L3 configuration file on the <kbd>compute</kbd> nodes at <kbd><span class="CodeInTextPACKT">/etc/neutron/l3_agent.ini</span></kbd> and specify one of the following interface drivers:</p>
<p>On <kbd>compute01</kbd> running the Linux bridge agent:</p>
<pre>[DEFAULT]<br/>...<br/>interface_driver = linuxbridge </pre>
<p>On <kbd>compute02</kbd> and <span>running the Open vSwitch agent:</span></p>
<pre>[DEFAULT]<br/>...<br/>interface_driver = openvswitch </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting the agent mode</h1>
                </header>
            
            <article>
                
<p>The Neutron <kbd>L3</kbd> agent considers HA routers as legacy routers, as many of the same mechanisms used for standalone routers are shared with HA routers. Therefore, the default value for <kbd><span class="CodeInTextPACKT">agent_mode</span></kbd> of <kbd><span class="CodeInTextPACKT">legacy</span></kbd> shall remain unchanged for the remainder of this chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Restarting the Neutron L3 agent</h1>
                </header>
            
            <article>
                
<p>After making changes to the configuration of the Neutron L3 agent, issue the following command on the <kbd>compute</kbd> nodes to restart the agent:</p>
<pre># systemctl restart neutron-l3-agent </pre>
<p>After a restart of the services, the additional agents should check in. Use the following <kbd><span class="CodeInTextPACKT">openstack network agent list</span></kbd> command to return a listing of all L3 agents:</p>
<pre># openstack network agent list --agent-type l3 </pre>
<p>The output should resemble the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/03668108-9251-4ba4-863d-17b9888ce895.png"/></p>
<p>If an agent is not listed in the output as expected, troubleshoot any errors that may be indicated in the <kbd><span class="CodeInTextPACKT">/var/log/neutron/l3-agent.log</span></kbd> log file on the respective node.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring Neutron</h1>
                </header>
            
            <article>
                
<p>Neutron uses default settings to determine the type of routers that users are allowed to create. In addition, the settings also specify the number of routers that make up a VRRP group, the default HA network CIDR, and the default network type.</p>
<p>The following settings are specified within the Neutron configuration file at <kbd><span class="CodeInTextPACKT">/etc/neutron/neutron.conf</span></kbd>, and only need to be modified on the host(s) running the Neutron API service. In this environment, the <kbd><span class="CodeInTextPACKT">neutron-server</span></kbd> service runs on the <kbd>controller01</kbd> node:</p>
<pre># Enable HA mode for virtual routers. (boolean value)<br/>#l3_ha = false<br/>#<br/># Maximum number of L3 agents which a HA router will be scheduled<br/># on. If it is to 0 then the router will be scheduled on every<br/># agent. (integer value)<br/>#max_l3_agents_per_router = 3<br/>#<br/># Subnet used for the l3 HA admin network. (string value)<br/>#l3_ha_net_cidr = 169.254.192.0/18<br/>#<br/># The network type to use when creating the HA network for an HA <br/># router. By default or if empty, the first 'tenant_network_types'<br/># is used. This is helpful when the VRRP traffic should use a<br/># specific network which is not the default one. (string value)<br/>#l3_ha_network_type =<br/># </pre>
<p>To set HA routers as the default router type for projects, set the <kbd><span class="CodeInTextPACKT">l3_ha</span></kbd> configuration option to <kbd><span class="CodeInTextPACKT">True</span></kbd> in <kbd><span class="CodeInTextPACKT">neutron.conf</span></kbd>. For this demonstration, the default value of <kbd><span class="CodeInTextPACKT">False</span></kbd> is sufficient.</p>
<div class="packt_infobox">With a value of <kbd><span class="CodeInTextPACKT">False</span></kbd>, only users with the <span class="CodeInTextPACKT">admin</span> role can create HA routers. Ordinary users will be limited to the default router type, which in most cases is standalone.</div>
<p>To set a maximum number of <kbd>L3</kbd> agents used for a virtual router, set <kbd> <span class="CodeInTextPACKT">max_l3_agents_per_router</span></kbd> accordingly. For this demonstration, the default value is sufficient and will mean that three network namespaces will be constructed to make up the VRRP virtual router.</p>
<p>To modify the network type used for HA routers, change the value of <kbd><span class="CodeInTextPACKT">l3_ha_network_type</span></kbd>. By default, the default project network type is used and is sufficient for this demonstration.</p>
<div class="packt_infobox">If the default project network type is <span class="CodeInTextPACKT">vlan</span>, VLANs may be consumed at a faster-than-expected rate, as each project can consume a single VLAN for the HA network.</div>
<p>Once the changes have been made, restart the <kbd><span class="CodeInTextPACKT">neutron-server</span></kbd> service on the <kbd>controller</kbd> node for the changes to take effect.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Working with highly available routers</h1>
                </header>
            
            <article>
                
<p>With a few exceptions, creating and managing an HA router is no different from its standalone counterpart. Neutron's router management commands were covered in the previous chapter, and the exceptions can be found in the following sections.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating highly-available routers</h1>
                </header>
            
            <article>
                
<p>Users with the <span class="CodeInTextPACKT">admin</span> role can create highly-available routers using the <kbd>-<span class="CodeInTextPACKT">-ha</span></kbd> argument with the <kbd><span class="CodeInTextPACKT">openstack router create</span> command</kbd> shown here:</p>
<pre>openstack router create --ha ROUTER </pre>
<p>Users without the <span class="CodeInTextPACKT">admin</span> role do not have the ability to override the default router type and cannot specify the <kbd>-<span class="CodeInTextPACKT">-ha</span></kbd> argument.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deleting highly-available routers</h1>
                </header>
            
            <article>
                
<p>To delete a highly-available router, simply use the <kbd><span class="CodeInTextPACKT">openstack router delete</span> command</kbd> shown here:</p>
<pre>openstack router delete ROUTER </pre>
<div class="packt_infobox">When all HA routers in a project are removed, the HA network used for communication between routers stays behind. That network will be reused upon the creation of HA routers at a later time.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Decomposing a highly available router</h1>
                </header>
            
            <article>
                
<p>Using concepts demonstrated in previous chapters, let's walk through the creation and decomposition of a highly available router. In the following example, I've started out with an external provider network named <kbd><span class="CodeInTextPACKT">GATEWAY_NET</span></kbd> and a project network named <kbd><span class="CodeInTextPACKT">PROJECT_NET</span></kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/138e2329-e4d3-41c1-bda2-6d05cbc98442.png"/></p>
<p>Using the <span class="CodeInTextPACKT"><kbd>openstack router create</kbd></span> command with the <kbd><span class="CodeInTextPACKT">--ha</span></kbd> argument, we can create an HA router named <kbd><span class="CodeInTextPACKT">MyHighlyAvailableRouter</span></kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1f590bb4-c404-4624-b2d9-4222b8135136.png" style="width:37.17em;height:25.00em;"/></p>
<p>Upon creation of the HA router, a network namespace was created on up to three hosts running the Neutron L3 agent. In this demonstration, the L3 agent is running on the <kbd>controller01</kbd> and two compute nodes.</p>
<p>In the following screenshot, a router namespace that corresponds to the <kbd><span class="CodeInTextPACKT">MyHighlyAvailableRouter</span></kbd> router can be observed on each host:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8bb73910-2b62-4115-a484-d5556f2c4f89.png" style="width:29.42em;height:12.67em;"/></p>
<p class="mce-root"/>
<p>Neutron automatically created a network reserved for communication between the routers upon creation of the first HA router within a project using the network defined by the <kbd><span class="CodeInTextPACKT">l3_ha_net_cidr</span></kbd> configuration option in the L3 agent configuration file:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/14891d53-2fda-4d20-af25-0db340e83821.png" style="width:58.25em;height:8.33em;"/></p>
<p>The HA network is not directly associated with the project and is not visible by anyone but an administrator, who is able to see all networks. The output here shows the details of the network:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/3c9c377b-1b86-48b1-814a-e7d4abbbf4c2.png" style="width:44.00em;height:38.00em;"/></div>
<p>As you can see, the <kbd><span class="CodeInTextPACKT">project_id</span></kbd> field is blank, while the name of the HA network includes the ID of the project. The network is used by Neutron for all HA routers created by that project in the future.</p>
<div class="packt_infobox">The HA network utilizes the default project network type and will consume a segmentation ID of that type.</div>
<p>Both a gateway and internal interface have been attached to the router. The <kbd><span class="CodeInTextPACKT">openstack port list</span></kbd> command reveals the gateway, internal, and HA ports associated with the router:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/8f9e1bbf-56f2-4735-aa66-c31bf12bcb20.png"/></div>
<p>The three HA ports were created automatically by Neutron and are used for communication between the router namespaces distributed across the hosts. Inside the network namespaces, we can find the corresponding interfaces:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/691c85b3-6ef0-4610-9e75-093c003daa60.png"/></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/25171b5d-d7fa-426f-adab-c9664d5e91a8.png"/></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/71a50c98-1c22-4250-a6c0-aefcefa07d0a.png"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>In the preceding screenshots, the router namespace on  <kbd>compute02</kbd> has been elected as the master router, as evidenced by the virtual IP, <kbd>169.254.0.1/24</kbd>, being configured on the HA interface within the namespace. In addition to the HA interface, the <kbd><span class="CodeInTextPACKT">qg</span></kbd> and <kbd><span class="CodeInTextPACKT">qr</span></kbd> interfaces are only fully configured on the master router. If more than one router owns the virtual IP, or if you see the <kbd><span class="CodeInTextPACKT">qg</span></kbd> and <kbd><span class="CodeInTextPACKT">qr</span></kbd> interfaces fully configured on more than one router, there may be communication issues between the routers on the <kbd>HA</kbd> network.</p>
<div class="packt_infobox">Based on Neutron's configuration of keepalived, the virtual IP is not used as a gateway address and is only used as a standardized address that can failover to other routers as part of the VRRP failover mechanisms. Neutron does not treat addresses on the <kbd><span class="CodeInTextPACKT">qg</span></kbd> or <kbd><span class="CodeInTextPACKT">qr</span></kbd> interfaces as virtual IPs. Along with the virtual IP, the <kbd><span class="CodeInTextPACKT">qg</span></kbd> and <kbd><span class="CodeInTextPACKT">qr</span></kbd> interfaces should only be configured and active on the master router at any given time.</div>
<p>You can use the <kbd><span class="CodeInTextPACKT">openstack network agent list</span></kbd> command with the <kbd><span class="CodeInTextPACKT">--router</span></kbd> and <kbd><span class="CodeInTextPACKT">--long</span></kbd> arguments to determine the agent(s) a router is scheduled to as well as see the HA state for the given agent, if applicable:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e67ac1c6-09d2-4eef-b51e-10531d4c7e58.png"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Examining the keepalived configuration</h1>
                </header>
            
            <article>
                
<p>Neutron has configured keepalived in each <span class="CodeInTextPACKT">qrouter</span> namespace so that, together, the namespaces can act as a single virtual router. A <span class="CodeInTextPACKT">keepalived</span> service runs in each namespace and uses the following configuration file located on the underlying host running the <kbd>L3</kbd> agent:</p>
<pre>/var/lib/neutron/ha_confs/&lt;router_id&gt;/keepalived.conf</pre>
<p>A look at the configuration file for the active router on <kbd>compute02</kbd> shows the keepalived and VRRP configurations currently in use:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b6af2916-c880-4268-9da9-e1f864948d15.png" style="width:36.25em;height:23.33em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Executing a failover</h1>
                </header>
            
            <article>
                
<p>Under normal circumstances, a node is not likely to fail, and router failover is unlikely to occur. A failure scenario can be recreated by manually rebooting the node hosting the active router or by putting its physical interfaces into a down state.</p>
<p>Failover actions are logged in the following location within the router namespaces:</p>
<pre>/var/lib/neutron/ha_confs/&lt;router_id&gt;/neutron-keepalived-state-change.log </pre>
<p>An example of a router going from a backup state to master state once failure is detected can be observed in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/76e2ca61-fbff-4a8b-b7c6-199414e7af1c.png"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>In the preceding screenshot, the router on <kbd>compute01</kbd> became the new master router. In the log, this was identified by the <kbd><span class="CodeInTextPACKT">state_master</span></kbd> message. Once the former master router regains connectivity and detects a new master has been elected, it moves to a backup state, as indicated by the <kbd><span class="CodeInTextPACKT">state_backup</span></kbd> message seen here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1f887b6a-1769-440f-bc98-29ad3e8b09df.png"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>Highly available routers can be created and managed using the same router command set discussed in the previous chapter. Neutron L3 agents are responsible for configuring the routers in a VRRP group, and the routers are left to elect a master router and implement their respective keepalived configuration based on their <span class="CodeInTextPACKT">master</span> or <span class="CodeInTextPACKT">backup</span> state at that time.</p>
<p>While HA routers provide a level of redundancy over their standalone counterparts, they are not without their drawbacks. A single node hosting a master router is still a bottleneck for traffic traversing that router. In addition, if the network used for dedicated VRRP traffic between routers experiences a loss of connectivity, the routers can become split-brained. This can cause two or more routers to become master routers and potentially cause ARP and MAC flapping issues in the network. Connection tracking between routers has not been implemented as of the Pike release, which means that connections to and from instances may be severed during a failover event. These shortcomings are being actively worked on and look to be addressed in future releases of OpenStack.</p>
<p>In the next chapter, we will look at how virtual routers can be distributed across <kbd>compute</kbd> nodes and serve as the gateway for their respective instances using a technology referred to as Distributed Virtual Routers, or DVR.</p>


            </article>

            
        </section>
    </body></html>