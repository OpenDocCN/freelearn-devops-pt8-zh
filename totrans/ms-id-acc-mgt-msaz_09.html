<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Deploying Solutions on Azure AD and ADFS</h1>
                </header>
            
            <article>
                
<p class="mce-root">What's better than using theory directly in a practical lab activity? Nothing, in our eyes. Working through <a href="1f239a9c-c62a-4e40-ab58-ce78cd87e8be.xhtml">Chapter 6</a>, <em>Managing Authentication Protocols,</em> you learned about the different authentication methods used in current environments. Now, we'll start to use this knowledge to deploy several scenarios to our <strong>Azure AD</strong> and <strong>Active Directory Federation Services </strong>(<strong>ADFS</strong>). We will help you to understand all the configuration steps for required a suitable authentication environment.</p>
<p class="mce-root">In this chapter, you will extend your current lab environment, install and configure the service we connect, and configure your authentication solution to handle different methods. W<span>e use</span><span> t</span><span>his approach so that you can understand all the stuff from scratch. We highly recommend that you read <a href="1f239a9c-c62a-4e40-ab58-ce78cd87e8be.xhtml">Chapter 6</a><span>, </span><em>Managing Authentication Protocols</em></span>, bef<span>ore you run through this chapter, which will cover the following topics:</span></p>
<ul>
<li>Basic environment installation and configuration</li>
<li>Azure AD authentication deployments</li>
<li>ADFS authentication deployments</li>
<li>Integrating Azure MFA into ADFS</li>
</ul>
<p>Are you ready to go? Yes! We'll start by preparing our environment.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Basic environment installation and configuration</h1>
                </header>
            
            <article>
                
<p>In this chapter, we start to extend our actual simulated on-premises infrastructure with the additional servers we need in order to demonstrate and configure different capabilities. In the following diagram, we introduce the complete environment we'll have configured after working through all the labs in the book:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8e724686-e24b-4fc7-a384-c4efe9e8f4da.png" width="1066" height="752"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Lab environment overview</div>
<p>In this chapter, we will add <kbd>YD1APP01</kbd> and <kbd>YD1URA01</kbd> to our environment. <kbd>YourDomain1</kbd> (<kbd>YD1</kbd>) is used to identify the machine in the correct domain. In our case, we used <kbd>INODEMOAPP01</kbd> as an example. You need to provision the machines with the previous values.</p>
<p class="mce-root"/>
<p>You already deployed the <kbd><span>YDADS01</span></kbd> <span>d</span><span>omain controller</span> <span>in</span> <a href="c0918163-6616-4bdb-aa82-4a65f578d268.xhtml">Chapter 2</a>,<span> </span><em>Understanding Identity Synchronization</em><span>. For all future virtual servers, use the same</span> <strong>Azure subscription</strong><span>, the same</span> <strong>resource group</strong><span>, and the same</span> <strong>virtual network</strong><span>. Join the virtual machines to your existing Active Directory. For the domain controller installation, we used</span> <kbd>inovitlabs.ch</kbd><span> as an example. In the following chapters, we will use similar DNS suffixes. To be clear, we use</span> <kbd>inovitdemos.ch</kbd><span> as a continuous representation of</span> <kbd>inovitlabs.ch</kbd><span> and we will add</span> <kbd>azureid.ch</kbd><span> and</span> <kbd>leano.ch</kbd><span> for the different scenarios.</span></p>
<div class="mce-root packt_tip"><kbd>azureid.ch</kbd> will be used for the second domain we use without any cloud integration.<br/>
<kbd>leano.ch</kbd> will be used as a cloud-only environment for business to business communication.<br/>
You can use the names you prefer.</div>
<p>For a better understanding, we show one example for an additional virtual machine, and you should run into the following result if you have provisioned all virtual machines by the end of the book:</p>
<p style="padding-left: 30px" class="CDPAlignCenter CDPAlign"><img src="Images/0d5e9c9f-0751-499f-b50d-01c9bd7f9564.png" width="1188" height="268"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Virtual machine overview</div>
<p>For <span class="packt_screen">INODEMOSAPP01</span> (<kbd>YDAPP01</kbd>), we use a Standard B4ms (4 VCPUs, 16 GB memory) virtual machine with Windows Server 2019. This virtual machine will be the host for running an SQL Server instance, most of our demo apps, and Visual Studio. For this reason, we use such a big machine type:</p>
<ul>
<li>Always use the same resource group</li>
<li><span>Always use </span>the same subscription</li>
<li>Use the size from the previous screenshot (recommended)</li>
<li><span>Always use </span>the same virtual network</li>
<li>Always configure a DNS name for a virtual machine</li>
</ul>
<p>You can use the <span class="packt_screen">Connect</span> button to download the RDP-connection file:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/19b96f9c-0759-4ad7-9da5-62422ab9d062.png" style="width:33.50em;height:12.92em;" width="855" height="330"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">VM configuration options</div>
<p>To make the labs as easy as we can, we define for every machine an <span class="packt_screen">RDP</span> inbound rule at creation time, and configure a static internal IP address for the virtual machine:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b3477c0c-1950-41aa-81e7-b84fc712c813.png" width="1367" height="368"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Firewall configuration</div>
<p>If you click on <span class="packt_screen">Network</span> <span class="packt_screen">Interface</span>, you can configure the static IP:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1a144a3e-14f6-4d45-a378-ee297d2d2df5.png" style="width:75.25em;height:20.00em;" width="1467" height="390"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Static IP configuration</div>
<p>Next, we need to click on the virtual network to configure our <kbd><span>YDADS01</span></kbd><span> </span><span>domain controller</span> <span>as the primary</span> <span class="packt_screen">DNS server</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b39aaf18-ed38-4ff1-94e4-7e750b8e110e.png" style="width:32.58em;height:27.92em;" width="567" height="487"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Custom DNS configuration</div>
<p>Now we are ready to go, and you can follow the same steps for any additional virtual machines. We also provide a scripting solution in the code package of the book.</p>
<div class="packt_infobox">This configuration is just for lab and demonstration purposes, and not for a production environment. We highly recommend that you do the same on your already provisioned domain controller configuration.</div>
<p>For this chapter, and specifically the <kbd>YD1URA01</kbd> virtual machine, we need to configure two additional inbound port rules to provide external access to our <kbd>Web Application Proxy</kbd>. We need to open port <span class="packt_screen">80 TCP</span> (<span class="packt_screen">HTTP</span>) and <span class="packt_screen">443 TCP</span> (<span class="packt_screen">HTTPS</span>). The expected configuration should look like the following:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/1d757751-0725-4b25-abe9-2f714aed5aae.png" width="1350" height="431"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Firewall configuration</div>
<p class="mce-root">Now that we have discussed the virtual machine setup, you should deploy the <kbd>YD1APP01</kbd> and <kbd>YD1URA01</kbd> servers to run the following labs in this chapter.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Create the certificate for your environment with let's encrypt</h1>
                </header>
            
            <article>
                
<p>To provide a valid certificate for our tasks, we need to install the <kbd>Posh-ACME</kbd> PowerShell module to use let's encrypt as our certificate provider. The certificates are valid for three months, without any cost. If you want to use your environment for longer, you just need to renew the certificate.</p>
<div class="packt_infobox">Find the module description and further information at the following source: <a href="https://docs.microsoft.com/en-us/office365/enterprise/base-configuration-dev-test-environment">https://docs.microsoft.com/en-us/office365/enterprise/base-configuration-dev-test-environment</a><a href="https://docs.microsoft.com/en-us/office365/enterprise/base-configuration-dev-test-environment"> </a></div>
<ol>
<li>With the following command, you install the module:</li>
</ol>
<pre style="padding-left: 90px"><strong><span class="pl-c"># Install for all users (requires an elevated PowerShell)</span>
<span class="pl-c1">Install-Module</span> <span class="pl-k">-</span>Name Posh<span class="pl-k">-</span>ACME

<span class="pl-c"># Install for current user</span>
<span class="pl-c1">Install-Module</span> <span class="pl-k">-</span>Name Posh<span class="pl-k">-</span>ACME <span class="pl-k">-</span>Scope CurrentUser</strong></pre>
<ol start="2">
<li>After installing the PowerShell module, we can request our certificate (replace the DNS suffix with your value):</li>
</ol>
<pre style="padding-left: 90px"><strong>New-PACertificate '*.inovitdemos.ch','certauth.login.inovitdemos.ch' -AcceptTOS -Contact jochen.nickel@inovit.ch</strong></pre>
<ol start="3">
<li>You will get a message that you need to create the <kbd>TXT</kbd> entries in your public DNS server required for the domain verification process:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f4c8739c-4aec-47db-a9a7-f495b63d1a2b.png" style="width:38.92em;height:5.42em;" width="1035" height="145"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Let's encrypt verification entries</div>
<ol start="4">
<li>Create the values in your public DNS like in the following example:</li>
</ol>
<pre style="padding-left: 90px"><strong>_acme-challenge.inovitdemos.ch   TXT   15MIN TTL   OtORHpZ1CruSu2Tb-iZ1oSnU7oMOsiT0fMPq8pDDeVM</strong><br/><strong>_acme-challenge.certauth.login.inovitdemos.ch  TXT  15MIN TTL  5je--CO7tiMYFXdclcFQKu9UwxnbQTVuzV4U8xpIBQs</strong></pre>
<div class="packt_tip">Keep in mind that it requires some time <span>for the values to become active</span>. After creating the entries, you can press any key to continue.</div>
<ol start="5">
<li>After a successful validation, you'll get a message that you can remove the values from your public DNS:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a5700560-539d-40a8-90b8-7ed43f2d1c6e.png" style="width:37.08em;height:3.83em;" width="1037" height="108"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Removal note for Let's encrypt verification option</div>
<ol start="6">
<li>Your new certificate is created:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/99920670-2412-4eb6-b889-221fb22f30bf.png" width="1566" height="92"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Newly created certificate information</div>
<ol start="7">
<li>Now, we need to find and import the certificate on every server in our environment. Use the following cmdlet:</li>
</ol>
<pre style="padding-left: 90px"><strong>Get-PACertificate | fl</strong></pre>
<p style="padding-left: 60px">The output of the preceding command is as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/94fb89b8-ad74-4639-9bc1-f7c86ed03b29.png" style="width:57.50em;height:12.92em;" width="1461" height="328"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Certificate information</div>
<ol start="8">
<li>Just type <kbd>.\cert.pfx</kbd> and hit <em>Enter,</em> and then follow the import wizard.</li>
<li>Choose <span class="packt_screen">Local Machin</span><span class="packt_screen">e</span> for the storage location:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4aef7c60-f41d-4d3f-8c19-49b2a8b74604.png" style="width:27.25em;height:16.25em;" width="476" height="284"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Certificate Import Wizard</div>
<ol start="10">
<li>The default password used from the PowerShell module to protect the <kbd>PFX</kbd> file is <kbd>poshacme</kbd>. Choose <span class="packt_screen">Mark key as exportable</span> only if you want to export the file with your own password to use it on other servers:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8708ee63-50c6-49fa-bab9-6a39a33583dc.png" style="width:26.83em;height:21.25em;" width="468" height="371"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Certificate import options</div>
<ol start="11">
<li>Now, open the certificate management console for the local machine store with the <kbd>certlm.msc</kbd> command and you are able to verify the installed <span class="packt_screen">Certificate</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/70dc1696-dc19-4869-a68c-43b2431d5e9f.png" style="width:29.92em;height:23.33em;" width="602" height="470"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Certificate store and Subject Alternative Names</div>
<div class="packt_infobox">We don't show this procedure in every following chapter, so be aware that you always install the certificate on a new server in your environment.</div>
<p class="mce-root">Now that we have finished all the preparation tasks, we can install <kbd>ADFS</kbd> and the <kbd>Web Application Proxy</kbd> for our demo application installations.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing the ADFS farm on YDADS01</h1>
                </header>
            
            <article>
                
<p>In our environment, we will install the <kbd>ADFS</kbd> farm on our domain controller. In production, this is not always the recommended option, but for cost saving, we'll use this option. Let's start!</p>
<ol>
<li>Create the internal DNS entry for the <kbd>ADFS</kbd> farm:</li>
</ol>
<pre style="padding-left: 90px"><strong>Add-DnsServerResourceRecord -ZoneName "inovitdemos.ch" -A -Name "login" -IPv4Address "10.0.0.4"</strong></pre>
<ol start="2">
<li>Create the internal DNS entries for the demo applications:</li>
</ol>
<pre style="padding-left: 90px"><strong>Add-DnsServerResourceRecord -ZoneName "inovitdemos.ch" -A -Name "claims" -IPv4Address "10.0.0.6"</strong><br/><strong>Add-DnsServerResourceRecord -ZoneName "inovitdemos.ch" -A -Name "kerb" -IPv4Address "10.0.0.6"</strong><br/><strong>Add-DnsServerResourceRecord -ZoneName "inovitdemos.ch" -A -Name "basic" -IPv4Address "10.0.0.6"</strong><br/><strong>Add-DnsServerResourceRecord -ZoneName "inovitdemos.ch" -A -Name "ntlm" -IPv4Address "10.0.0.6"</strong></pre>
<ol start="3">
<li>Create the <kbd>ADFS</kbd> <strong>group managed service account</strong> (<strong>gMSA</strong>):</li>
</ol>
<pre style="padding-left: 90px"><strong>Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)</strong><br/><strong>New-ADServiceAccount svcadfs -DNSHostName login.inovitdemos.ch -ServicePrincipalNames http/login.inovitdemos.ch</strong></pre>
<ol start="4">
<li>Install the <kbd>ADFS</kbd> farm:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><strong># Get the certificate thumbprint</strong><br/><strong>gci Cert:\LocalMachine\My\ | fl</strong><br/><strong># Install the ADFS Farm with WID</strong><br/><strong>Install-WindowsFeature ADFS-Federation -IncludeManagementTools</strong><br/><strong>Install-AdfsFarm -CertificateThumbprint 66F1BF8CCD904DF74154A5D24769DE155E874257 -FederationServiceName login.inovitdemos.ch -GroupServiceAccountIdentifier inovitdemos\svcadfs$ -FederationServiceDisplayName "INOVITDEMOS Login"</strong><br/><strong># Server restart</strong><br/><strong>Restart-Computer</strong></pre>
<ol start="5">
<li>Enable <span><kbd>IdP Initiated Signon Page</kbd>:</span></li>
</ol>
<pre style="padding-left: 90px"><strong>Set-AdfsProperties -EnableIdPInitiatedSignonPage $true</strong></pre>
<ol start="6">
<li>Check your <kbd>ADFS</kbd> infrastructure installation, opening the provided links in your browser:</li>
</ol>
<pre style="padding-left: 90px"><strong># Check ADFS Metadata</strong><br/><strong>https://login.inovitdemos.ch/adfs/fs/federationserverservice.asmx</strong><br/><strong># Check IDP Sign In</strong><br/><strong># Add "login.inovitdemos.ch" to the "Local Intranet" settings in IE</strong><br/><strong>https://login.inovitdemos.ch/adfs/ls/IdpInitiatedSignon.aspx</strong></pre>
<ol start="7">
<li>Now, we connect <kbd>ADFS</kbd> to our Azure AD and change to a federated environment. We use the <kbd>SupportMultipleDomain</kbd> options to be ready for later demonstrations, where we integrate a second domain suffix and an additional Active Directory forest:</li>
</ol>
<pre style="padding-left: 90px"><strong>Connect-MsolService</strong><br/><strong>Convert-MsolDomainToFederated -DomainName inovitdemos.ch -SupportMultipleDomain:$true</strong></pre>
<ol start="8">
<li>Next, we install and configure the <kbd>Web Application Proxy</kbd>.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing the Web Application Proxy on YD1URA01</h1>
                </header>
            
            <article>
                
<p>We will install the <kbd>Web Application Proxy</kbd> on <kbd>YD1URA01</kbd> to provide external access to our <kbd>ADFS</kbd> infrastructure by following these steps:</p>
<ol>
<li>Open an evaluated PowerShell instance and use the following commands:</li>
</ol>
<pre style="padding-left: 90px"><strong># Get the certificate thumbprint</strong><br/><strong>gci Cert:\LocalMachine\My\ | fl</strong><br/><br/><strong># Install Web Application Proxy</strong><br/><strong>Install-WindowsFeature Web-Application-Proxy -IncludeManagementTools</strong><br/><br/><strong># Configure Web Application Proxy</strong><br/><strong>$creds = Get-Credential</strong><br/><strong>Install-WebApplicationProxy -FederationServiceName "login.inovitdemos.ch" -FederationServiceTrustCredential $creds -CertificateThumbprint "66F1BF8CCD904DF74154A5D24769DE155E874257"</strong><br/><br/><strong># Server restart</strong><br/><strong>Restart-Computer</strong></pre>
<ol start="2">
<li>Next, we will publish Active Directory <kbd>Federation Services</kbd> with the <kbd>Web Application Proxy</kbd>:</li>
</ol>
<pre style="padding-left: 90px"><strong>Add-WebApplicationProxyApplication -Name "Federation Services" -BackendServerUrl "https://login.inovitdemos.ch/" -ExternalUrl "https://login.inovitdemos.ch/" -ExternalPreauthentication "PassThrough" -ExternalCertificateThumbprint "66F1BF8CCD904DF74154A5D24769DE155E874257"</strong></pre>
<ol start="3">
<li>Now, we need to create the entries in the public DNS for <kbd>ADFS</kbd> and the demo applications, where you need to use your DNS server names:</li>
</ol>
<pre style="padding-left: 90px"><strong>login.inovitdemos.ch.<span> </span>CNAME<span> </span>15 MIN<span> </span>inodemosura01.westeurope.cloudapp.azure.com</strong><br/><strong>basic.inovitdemos.ch.<span> </span>CNAME<span> </span>15 MIN<span> </span>inodemosura01.westeurope.cloudapp.azure.com</strong><br/><strong>kerb.inovitdemos.ch.<span> </span>CNAME<span> </span>15 MIN<span> </span>inodemosura01.westeurope.cloudapp.azure.com</strong><br/><strong>ntlm.inovitdemos.ch.<span> </span>CNAME<span> </span>15 MIN<span> </span>inodemosura01.westeurope.cloudapp.azure.com</strong><br/><strong>claims.inovitdemos.ch.<span> </span>CNAME<span> </span>15 MIN<span> </span>inodemosura01.westeurope.cloudapp.azure.com</strong></pre>
<ol start="4">
<li>Next, we will test the external <kbd>ADFS</kbd> functionality.</li>
<li>Use your administrative virtual machine or any other external client, open <a href="https://login.inovitdemos.ch/adfs/ls/idpinitiatedsignon.aspx">https://login.inovitdemos.ch/adfs/ls/idpinitiatedsignon.aspx</a> in a browser, and log in with one of your test users.</li>
</ol>
<p>Now, we have a working <kbd>ADFS</kbd> and <kbd>Web Application Proxy</kbd> infrastructure. The only missing actors are the demo applications that we will implement now on the <kbd>YD1APP01</kbd> server and subscribe to several cloud services.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing demo applications on (YD1APP01) for ADFS</h1>
                </header>
            
            <article>
                
<p>For our tasks in this and later chapters, we need to install a SQL Server and Management Tools instance on the server.</p>
<p>The following software needs to also be installed on the server:</p>
<ul>
<li>Visual Studio (<a href="https://bit.ly/2NzB14g">https://bit.ly/2NzB14g</a>) with the following options:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><span class="packt_screen"><img src="Images/7ced695a-3e78-4023-9d45-f055d7d665dc.png" style="width:48.75em;height:22.75em;" width="714" height="335"/></span></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Visual Studio package installation options</div>
<ul>
<li>Visual Studio Code (<a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a>)</li>
</ul>
<p>Next, we start with the <strong>Internet Information Service</strong> (<strong>IIS</strong>) base installation:</p>
<ol>
<li>Install IIS:</li>
</ol>
<pre style="padding-left: 90px"><strong>Install-WindowsFeature NET-Framework-Core,NET-Framework-45-Features,Web-Mgmt-Console,Web-Asp-Net,Web-Asp-Net45,Web-Basic-Auth,Web-Client-Auth,Web-Digest-Auth,Web-Dir-Browsing,Web-Dyn-Compression,Web-Http-Errors,Web-Http-Logging,Web-Http-Redirect,Web-Http-Tracing,Web-ISAPI-Ext,Web-ISAPI-Filter,Web-Lgcy-Mgmt-Console,Web-Metabase,Web-Mgmt-Console,Web-Mgmt-Service,Web-Net-Ext,Web-Net-Ext45,Web-Request-Monitor,Web-Server,Web-Stat-Compression,Web-Static-Content,Web-Windows-Auth,Web-WMI,Windows-Identity-Foundation</strong></pre>
<ol start="2">
<li>Now, we install the SQL instance. Create the SQL organizational unit in your Active Directory:</li>
</ol>
<pre style="padding-left: 90px"><strong>New-ADOrganizationalUnit -Name "SQL" -Path "OU=Managed Service Objects,DC=INOVITDEMOS,DC=CH"</strong><br/><strong>New-ADOrganizationalUnit -Name "Users" -Path "OU=SQL,OU=Managed Service Objects,DC=INOVITDEMOS,DC=CH"</strong></pre>
<ol start="3">
<li>Create the service accounts:</li>
</ol>
<pre style="padding-left: 90px"><strong># SQL Database engine service account</strong><br/><strong>New-ADUser -Name "svcsqldb" -SamAccountName svcsqldb -UserPrincipalName svcsqldb@inovitdemos.ch -path "OU=Users,OU=SQL,OU=Managed Service Objects,DC=inovitdemos,DC=ch" -AccountPassword (ConvertTo-SecureString "YourPassword" -AsPlainText -Force) -Description "SQL Database Engine" -Enabled $True</strong><br/><br/><strong># SQL Agent service account</strong><br/><strong>New-ADUser -Name "svcsqldbagent" -SamAccountName svcsqldbagent -UserPrincipalName svcsqldbagent@inovitdemos.ch -path "OU=Users,OU=SQL,OU=Managed Service Objects,DC=inovitdemos,DC=ch" -AccountPassword (ConvertTo-SecureString "YourPassword" -AsPlainText -Force) -Description "SQL Database Engine Agent" -Enabled $True</strong></pre>
<ol start="4">
<li>Next, we can do a standard installation of SQL Server 2017 (Trial Edition: <a href="https://bit.ly/2FoSE6z">https://bit.ly/2FoSE6z</a> ) with a default instance. You can follow the guidance at <a href="https://bit.ly/2FoSE6z">https://bit.ly/2lKJ9mi</a> to install the service.</li>
<li>Just use the following parameters to install:
<ul>
<li>In general, use the default settings</li>
<li>Add just the database engine and the Full-Text Index as features</li>
<li>Add the current user as administrator</li>
<li>Use the service accounts for the database engine and the SQL Agent; choose the start type to be automatic</li>
<li>Download and install <span class="packt_screen">SQL Management Studio</span></li>
</ul>
</li>
</ol>
<ol start="6">
<li>After the installation, you should be able to connect to the new SQL instance with <span class="packt_screen">SQL Management Studio</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0fca3397-1c5d-4889-9aeb-94834713f186.png" style="width:27.00em;height:20.33em;" width="456" height="344"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Connecting to the SQL instance with SQL Management Studio</div>
<div class="packt_infobox"><span>We use the test site from the Microsoft blog at </span><span><a href="https://bit.ly/2QDIqQN">https://bit.ly/2QDIqQN</a> (credit: </span><span>Emmanuel Boersma), to demonstrate the different authentication methods.</span></div>
<ol start="7">
<li>Configure the authentication demo apps.<br/>
You need to change the bold values to create all demo apps with the following values:
<ul>
<li><kbd>basic</kbd></li>
<li><kbd>kerberos</kbd></li>
<li><kbd>ntlm</kbd></li>
</ul>
</li>
</ol>
<ol start="8">
<li>Use the following script:</li>
</ol>
<pre style="padding-left: 90px">New-Item C:\inetpub\<strong>basic</strong>root -type Directory<br/>Import-Module Webadministration<br/>cd IIS:<br/>New-Item 'IIS:\Sites\Basic Web Site' -bindings @{protocol="http";bindingInformation=":80:<strong>basic</strong>.inovitdemos.ch"} -physicalPath 'c:\inetpub\<strong>basic</strong>root'</pre>
<ol start="9">
<li>Next, will add an HTTPS binding to every demo app:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3b02d728-d2da-414a-a5f8-7c66d186d7a4.png" style="width:58.58em;height:11.58em;" width="1036" height="206"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">IIS demo app configuration overview</div>
<ol start="10">
<li>Do this for every app!</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f3ab3d38-2acc-4f33-9182-ea545b9edfd8.png" style="width:36.75em;height:27.33em;" width="640" height="478"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">IIS binding configuration</div>
<p>Now, we need to work on some extra tasks for the applications.</p>
<p>We start with the claims app:</p>
<ol start="1">
<li>Use the claims demo app package from the code package and execute the script (change it to your values before execution):</li>
</ol>
<pre style="padding-left: 90px">.\deploy-testsite.ps1 -SourcePath<br/>"<strong>C:\inovit\deploy</strong>" -SiteName "claims Web Site" -SitePhysicalPath C:\inetpub\claimsroot -ADFSServer <strong>inodemosads01</strong> -AppFQDN claims.<strong>inovitdemos.ch</strong></pre>
<ol start="2">
<li>Connect the HTTPS binding of the claims demo app to your certificate.</li>
</ol>
<p>Let's do the tasks for the <kbd>kerberos</kbd> app:</p>
<ol start="1">
<li>Create and configure a service account on<kbd>YD1ADS01</kbd> to run the application pool with the name <kbd>svckrbapp</kbd>, and with the password never expires option selected. Note the password so you can provide it in the following configurations:</li>
</ol>
<pre style="padding-left: 90px">New-ADUser -Name "svckrbapp" -SamAccountName svckrbapp -UserPrincipalName svckrbapp@<strong>inovitdemos.ch</strong> -path "OU=Users,OU=AAD,OU=Managed Service Objects,DC=<strong>inovitdemos,DC=ch</strong>" -AccountPassword (ConvertTo-SecureString "<strong>YourPassword</strong>" -AsPlainText -Force) -Description "Kerberos App Pool Account" -Enabled $True</pre>
<ol start="2">
<li>Next, we need to configure the correct Service Principal Name for the Kerberos Delegation scenario later:</li>
</ol>
<pre style="padding-left: 90px">setspn -S http/kerb.<strong>inovitdemos.ch</strong> <strong>inovitdemos</strong>\svckrbapp</pre>
<ol start="3">
<li>Configure the Kerberos delegation on your <kbd>YD1APP01</kbd> and <kbd>YD1URA01 </kbd>computer account (for external access) with the <kbd>svckrbapp</kbd> user account:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ff1fc34c-2871-41f1-82d7-4a2b80a7bbfe.png" style="width:26.58em;height:24.83em;" width="460" height="430"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Kerberos Delegation configuration in AD</div>
<ol start="4">
<li>Next, we need to jump to your <kbd>YD1APP01</kbd> server to configure the Kerberos application.</li>
<li>Under <span class="packt_screen">Application pools</span>, click <span class="packt_screen">Add a new application pool</span>.</li>
<li>Name the pool Kerberos website and leave the other default values.</li>
<li>Click <span class="packt_screen">Advanced Settings</span> and change the identity to the <kbd>svckrbapp</kbd> account.</li>
<li>Click on the Kerberos <span>website</span> and click <span class="packt_screen">Advanced Settings</span>.</li>
<li>Change the application pool to the newly created one: Kerberos <span>website</span>.</li>
<li>Under <span class="packt_screen">IIS Authentication</span>, enable <span class="packt_screen">Windows Authentication</span> and disable <span class="packt_screen">Anonymous Authentication</span>.</li>
<li>Go to <span class="packt_screen">Windows Authentication</span> | <span class="packt_screen">Advanced Settings</span> | Clear <span class="packt_screen">Enable Kernel-mode</span>.</li>
<li>Copy the content of the <kbd>authpage</kbd> folder from the code package to the Kerberos root directory at <kbd>C:\inetpub\kerbroot</kbd>.</li>
</ol>
<p>Next, we will configure the <kbd>ntlm</kbd> app:</p>
<ol start="1">
<li>Click on the NTLM <span>website</span> and click <span class="packt_screen">Advanced Settings</span></li>
<li>Change the application pool to Kerberos <span>website</span></li>
<li>Under <span class="packt_screen">IIS Authentication</span>, enable <span class="packt_screen">Windows Authentication</span> and disable <span class="packt_screen">Anonymous Authentication</span></li>
<li>Go to <span class="packt_screen">Windows Authentication</span> | <span class="packt_screen">Advanced Settings</span> | <span class="packt_screen">Clear</span> <span class="packt_screen">Enable Kernel-mode</span></li>
<li><span>Go to <span class="packt_screen">Windows Authentication</span> | <span class="packt_screen">Advanced Settings</span> | <span class="packt_screen">Providers and leave only NTLM</span></span></li>
<li>Copy the content of the <kbd>authpage </kbd>folder from the code package to the NTLM root directory at <kbd>C:\inetpub\ntlmroot</kbd></li>
</ol>
<p><span>Next, we will configure t</span>he <kbd>basic</kbd> app:</p>
<ol start="1">
<li><span>Copy the content of the</span> <kbd>authpage</kbd><span> folder from the code package to the basic root directory at</span> <kbd>C:\inetpub\basicroot</kbd></li>
<li>In the IIS manager, go to the <kbd>basic</kbd> app and configure the authentication so that just the basic authentication is enabled</li>
</ol>
<p>Reboot your <kbd>YD1ADS01</kbd>, <kbd>YD1APP01</kbd>, and <kbd>YD1URA01</kbd> servers before we move on to the next steps.</p>
<p>Now that we have finished the on-premises demo apps, we need to sign up for some cloud demo apps.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Subscribing to demo apps (Azure AD)</h1>
                </header>
            
            <article>
                
<p>To complete all the authentication and information protection labs, we need to register for the following cloud applications:</p>
<ul>
<li>Sign up for a *salesforce developer account: <a href="https://developer.salesforce.com/signup">https://developer.salesforce.com/signup</a></li>
<li>Sign up for a service now developer account:<a href="https://bit.ly/2Ji2Ta9"> </a><a href="https://bit.ly/2FniUOC">https://bit.ly/2FniUOC</a></li>
<li>Sign up for a business dropbox account trial: <a href="https://bit.ly/1KYht6o">https://bit.ly/1KYht6o</a></li>
<li>Sign up for a LinkedIn account: <a href="https://bit.ly/1k7JbKB">https://bit.ly/1k7JbKB</a></li>
<li>Sign up for a *Twitter account: <a href="https://bit.ly/2Ji2Ta9">https://bit.ly/1k7JbKB</a></li>
</ul>
<ul>
<li><span>Sign up for a Google account: <a href="https://bit.ly/2reCBP3"><strong>https://bit.ly/2reCBP3</strong></a></span></li>
<li>Sign up for a Okta developer account: <a href="https://bit.ly/2IOw3ix">https://bit.ly/2IOw3ix</a></li>
<li>Sign up for a Proxyclick trial: <a href="https://bit.ly/2D5BKqV">https://bit.ly/2D5BKqV</a></li>
</ul>
<div class="packt_tip">The applications marked with * will be used in this chapter and the other one in the <a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml">Chapter 8</a>, <em>Using Azure AD App Proxy an</em><em>d Web Application Proxy</em> and the following.</div>
<p>After the successful trial or developer accounts, we can start with our journey through the <span>capabilities of </span><span>Azure AD and ADFS. </span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure AD authentication deployments</h1>
                </header>
            
            <article>
                
<p><span>In this</span> section, we will build applications for our users and work through the different authentication mechanisms provided by Azure AD. All the configurations we do in this section will be done with global administrator rights and on the Azure portal, <a href="https://portal.azure.com">https://portal.azure.com</a>. We will start with Salesforce configuration:</p>
<ol>
<li>Launch the Azure Active Directory blade and click <span class="packt_screen">Enterprise applications</span>.</li>
<li>Under <span class="packt_screen">All applications</span>, click <span class="packt_screen">New application</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/fd9fe36b-62e7-4d3b-b867-44228d1579b1.png" style="width:33.17em;height:13.50em;" width="490" height="200"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">New application creation context</div>
<ol start="3">
<li>Type <kbd>Salesforce</kbd> in the search field:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7cb4b682-19cb-4d96-91ff-fd16e362ad61.png" style="width:31.67em;height:13.83em;" width="495" height="217"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Salesforce enablement</div>
<ol start="4">
<li>Under <span class="packt_screen">Single sing-on</span>, change to <span class="packt_screen">SAML</span> authentication:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/bfce6ec2-038b-40c2-ac48-458c7b7841d8.png" style="width:45.50em;height:18.67em;" width="964" height="396"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choosing SAML as the authentication method</div>
<ol start="5">
<li>Go to the <span class="packt_screen">SAML Signing Certificate</span> section and click <span class="packt_screen">Download</span> on <span class="packt_screen">Certificate (RAW)</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/982902b6-7a23-4c18-8eaf-a5f80d5db248.png" style="width:40.42em;height:13.67em;" width="710" height="240"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Downloading the signing certificate</div>
<ol start="6">
<li>Now, log in to your Salesforce account and navigate to <span class="packt_screen">Identity</span> | <span class="packt_screen">Single Sign-On Settings</span>.</li>
<li>Edit the <span class="packt_screen">SAML settings</span> and click <span class="packt_screen">SAML Enabled</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0e51bf40-339c-4d68-b688-816db782af02.png" width="1227" height="455"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuration of SAML in Salesforce</div>
<ol start="8">
<li>Next, we will create new <strong><span class="packt_screen">SAML Single Sign-On Settings</span></strong>; click <span class="packt_screen">New</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/01836c54-7d3f-4b8d-9877-371fd0eedcaf.png" style="width:61.33em;height:4.42em;" width="792" height="58"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">New settings dialog</div>
<ol start="9">
<li>To gather the values for the configuration, you need to jump back to your Azure portal and copy the three links to Notepad:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5b2d7853-6a22-462b-9710-c2528bfa4b35.png" style="width:43.92em;height:10.17em;" width="618" height="143"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Salesforce configuration information about the Azure AD endpoints</div>
<ol start="10">
<li>Fill in the following information on the Salesforce configuration page:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2545a68e-f69c-478a-b6f3-31bd7792c06b.png" width="1286" height="574"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Salesforce SAML configuration page</div>
<ol start="11">
<li>Next, we need to configure our Salesforce domain name under <span class="packt_screen">SETTINGS</span> | <span class="packt_screen">Company Settings</span> | <span class="packt_screen">My Domain</span>.</li>
</ol>
<ol start="12">
<li>Use your tenant name and click <span class="packt_screen">C<span class="packt_screen">h</span></span><span class="packt_screen">eck Availability</span> and <span class="packt_screen">Register Domain</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/961bb4ef-5314-4ade-b773-4ce12678854f.png" style="width:68.83em;height:34.25em;" width="1391" height="693"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Salesforce domain registration process</div>
<div class="packt_tip">The registration process takes about 5-10 minutes.</div>
<ol start="13">
<li>Refresh the page and <span class="packt_screen">Edit</span> the <span class="packt_screen">Authentication Configuration</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/70b65762-2947-4697-8fdc-cb99170ab5ec.png" style="width:38.67em;height:2.75em;" width="548" height="40"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Authentication configuration dialog</div>
<ol start="14">
<li>Click <span class="packt_screen">O</span><span class="packt_screen">pen</span> and <span class="packt_screen">U</span><span class="packt_screen">pload a logo</span> from <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml">Chapter 1</a>, <em>Building and Managing Azure Active Directory</em>.</li>
</ol>
<ol start="15">
<li>Check <span class="packt_screen">AzureADSSO</span> and <span class="packt_screen">Save</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7a4c5ca8-0558-447e-9282-4bcce2a342f2.png" style="width:38.58em;height:24.08em;" width="699" height="436"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choosing the Authentication service AzureADSSO</div>
<ol start="16">
<li>Click on <span class="packt_screen">login</span> and if you are prompted to register your phone, click <strong><span class="packt_screen">I Don't want ...</span></strong>.</li>
<li>If you are prompted, log in with your Salesforce administrator account.</li>
<li>Next, under the <span class="packt_screen">My Domain</span> section, click <span class="packt_screen">Deploy to Users</span> and <span class="packt_screen">OK</span>.</li>
<li>Now, we switch back to our <strong>Azure AD</strong> configuration.</li>
<li>Set the <span class="packt_screen">Sign on URL</span> and <span class="packt_screen">Identifier (Entity ID)</span> text box values to your value, <kbd>https://&lt;TENANT&gt;-dev-ed.my.salesforce.com</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1be9d8fc-332d-46d7-9b08-49fc3053867b.png" width="1341" height="266"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Salesforce SAML configuration</div>
<p>Now that we have configured SAML authentication, we can activate user provisioning with Salesforce by following these steps:</p>
<ol>
<li>Under the <span class="packt_screen">Manage</span> section, click <span class="packt_screen">Provisioning</span>.</li>
<li><span class="packt_screen">Provisioning Mode</span> drop-down list, set <strong><span class="packt_screen">Automatic.</span></strong></li>
<li>Under <span class="packt_screen">Admin Credentials</span>, type in the admin username and password for accessing Salesforce.</li>
<li>Obtain a secret token by switching to the Salesforce administration:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9870154a-5792-4cb0-8aa0-104a2d66164d.png" style="width:21.08em;height:12.00em;" width="343" height="197"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Secret token creation for provisioning</div>
<ol start="5">
<li>Click <span class="packt_screen">Reset Security Token</span> and you will receive a new security token by mail:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/30eb22f3-1080-4697-affb-bf6e1f519501.png" style="width:54.25em;height:23.83em;" width="888" height="390"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Get new secret token</div>
<ol start="6">
<li>Next, we configure the provisioning settings in the Azure portal. Use the token from your mailbox and configure a notification email address:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/49b26f6d-3c62-40e1-8c4c-3b4a960a8d99.png" style="width:40.42em;height:21.08em;" width="633" height="332"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring the provisioning service</div>
<p style="padding-left: 90px">The following message is expected:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/56994c23-9475-49a5-a68d-f67d11ed3fbe.png" style="width:36.00em;height:6.25em;" width="501" height="88"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Test the connection to the Salesforce provisioning endpoint</div>
<ol start="7">
<li class="mce-root">To use the newly deployed application, we need to create and assign a group to the Salesforce application.</li>
<li>Create the following group and assign a licensed user from the Sales department:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5d7c9f53-ff94-4725-bb85-7a820e2dfae0.png" style="width:19.67em;height:21.00em;" width="301" height="322"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Group assignment for Salesforce app access</div>
<ol start="9">
<li>Assign this group with the following values:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a5aec567-b0a4-44d0-a6fd-57ea8d3d6df8.png" style="width:17.83em;height:12.67em;" width="273" height="196"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Role selection</div>
<ol start="10">
<li>Under <span class="packt_screen">Manage</span> | <span class="packt_screen">Provisioning</span> | <span class="packt_screen">Settings</span>, set <span class="packt_screen">P</span><span class="packt_screen">rovisioning Status</span> to <span class="packt_screen">On </span>and leave the default <span class="packt_screen">Scope</span>.</li>
<li>Click the checkbox for <span class="packt_screen">Clear current state and restart synchronization</span> and click <span class="packt_screen">Save</span>.</li>
<li>In the <span class="packt_screen">Restart Synchronization</span> window, click <span class="packt_screen">Yes</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/26722074-1765-4ce2-b22a-d533ffe53c4b.png" style="width:47.58em;height:33.08em;" width="698" height="485"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Synchronization and Provisioning status information</div>
<ol start="13">
<li>Test the application with your assigned test user at <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a>.</li>
</ol>
<ol start="14">
<li>The following result is expected, a successful logon:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6399ab9a-e1ad-4b8a-80cc-a12f68db50bc.png" width="1210" height="586"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Successful logon on Salesforce with test user</div>
<p>We successfully deployed Salesforce, including SAML and provisioning capabilities, to our Azure AD.</p>
<p>Now, we will use another feature in Azure AD with Twitter. For this, we use the password-based <span class="packt_screen">Sign-In</span> option:</p>
<ol>
<li>First, we need to add the <span class="packt_screen">Twitter</span> app from the application gallery. You already know the process from Salesforce:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8bfe76b4-cf37-45e6-aebd-5dd10370ce89.png" style="width:33.00em;height:14.75em;" width="545" height="246"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Adding Twitter to app catalog</div>
<ol start="2">
<li>Next, we choose <span class="packt_screen">Password-based</span> <span class="packt_screen">Single Sign-on</span> mode from the <span class="packt_screen">Single Sign-On</span> section.</li>
<li>The wizard automatically sets the correct URL to Twitter:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2cdc097f-0b69-4b07-a52f-7d92aeb0afb6.png" style="width:19.92em;height:6.67em;" width="303" height="102"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choosing password-based authentication option</div>
<ol start="4">
<li>We assign the sales and marketing application access group to the application, and the provide the credentials we want to use and hide from the user:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d2c9e299-cc85-4add-9715-c983d05880ff.png" style="width:36.75em;height:12.58em;" width="575" height="197"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Assigning the Twitter credentials to a group</div>
<ol start="5">
<li>You are also able to <span class="packt_screen">Update Credentials</span> on the assigned groups:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/01dd30fe-324b-4dee-a771-bd36487f8bac.png" style="width:55.83em;height:11.92em;" width="920" height="197"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Update credentials option</div>
<ol start="6">
<li>Now that we have configured the <span class="packt_screen">Twitter</span> app for our sales and marketing users, you can test the functionality with the user over at <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a>.</li>
<li>You should have a <span class="packt_screen">Single Sign-On</span> experience.</li>
</ol>
<p>Some applications require access to the application's access panel (<a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a>). In this case, the website requires a browser extension:</p>
<ol>
<li>To configure Microsoft Edge for the access panel extension, launch your browser and navigate to <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a></li>
<li>Log in as a test user</li>
<li>Click on <span class="packt_screen">Twitter</span></li>
<li>Click <span class="packt_screen">Install Now</span></li>
<li>Complete the installation wizard to install the <span class="packt_screen">My Apps Secure Sign-In Extension</span></li>
<li>You get a new extension notification; click <span class="packt_screen">Turn it on</span></li>
<li>Relaunch the browser and navigate to <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a></li>
<li>Log in as a test user</li>
</ol>
<p>This is our first impression of Azure AD's capabilities. We will dive deeper in the next <a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml">Chapter 8</a>, <em>Using Azure AD App Proxy and Web Application Proxy</em>, and now start to configure our first applications in our ADFS infrastructure.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">ADFS Authentication deployments</h1>
                </header>
            
            <article>
                
<p>To configure a claims-based application with <strong>WS-Federation</strong>, we can use our claims demo application. With this application, you can test many features of ADFS with claims authentication and learn in a <span>more</span><span> </span><span>practical way. Run the following configuration on your</span> <strong>YD1ADS01</strong><span>. Later, we'll configure the application to get more experience:</span></p>
<ol>
<li>Go to <span class="packt_screen">Server Manager</span>, click <span class="packt_screen">Tools</span>, and open ADFS Management.</li>
<li>Expand <span class="packt_screen">Trust Relationships</span> and select <span class="packt_screen">Relying Party Trusts</span>.</li>
<li>Select <span class="packt_screen">Actions</span>, add <span class="packt_screen">Relying Party Trust</span>, and click <span class="packt_screen">Start</span>.</li>
<li>In the box, type <kbd>https://claims.inovitdemos.ch</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0109ea84-b78a-4b3a-b44e-5da0370efa22.png" style="width:32.67em;height:7.92em;" width="536" height="130"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">ADFS relying party trust configuration</div>
<ol start="5">
<li>Click <span class="packt_screen">Next</span>.</li>
<li>Type the display name as <kbd>claims Demo Web Site</kbd> and click <span class="packt_screen">Next</span>.</li>
<li>Select <span class="packt_screen">I do not want to configure multi-factor authentication settings for this rel</span><span class="packt_screen">ying party trust currently</span> and click <span class="packt_screen">Next</span>.</li>
<li>Select <span class="packt_screen">Permit all users</span> <span class="packt_screen">to access this relying party</span>, and click <span class="packt_screen">Next</span> | <span class="packt_screen">Next</span>.</li>
<li>Clear the <span class="packt_screen">Open the Edit Claim Rules</span> dialog box for this relying party trust <span>when the wizard closes</span> <span>and click <span class="packt_screen">Close</span></span>.</li>
<li>Verify the new app with Internet Explorer by typing <kbd><span>https://claims.inovitdemos.ch</span></kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3945262b-4ff7-41b6-995b-66350ba01f71.png" style="width:41.67em;height:28.25em;" width="960" height="652"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Claims demo web site</div>
<div class="packt_tip">The installation script automatically puts the thumbprint of the <kbd>Token-Signing</kbd> certificate in the <kbd>web.config</kbd> file of the claims web application. If you renew the <kbd>Token-Signing</kbd> certificate, you need to update the thumbprint in the application configuration.</div>
<p>You can gather the <kbd>Token-Signing</kbd> certificate from our ADFS instance with the following command:</p>
<pre><strong>Invoke-Command -ComputerName INODEMOSADS01 -ScriptBlock {Get-ADFSCertificate}</strong></pre>
<p>The output of the preceding command will look as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/16392d3a-4671-4c6f-92eb-50561f192987.png" style="width:32.08em;height:5.83em;" width="423" height="77"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Get the Token-Signing certificate information</div>
<p>Another good helper for several test scenarios such as SAML, WS-Federation, OAuth2, and the strong authentication methods is the <strong>Claims X-Ray tool</strong> from Microsoft, which you can find at <a href="https://bit.ly/2EqoPOi">https://bit.ly/2EqoPOi</a>, and it's quite easy to configure by following these steps:</p>
<ol>
<li>Open an evaluated PowerShell instance on your <strong>YD1ADS01</strong> and run the following script:</li>
</ol>
<pre style="padding-left: 90px"><strong>$authzRules = "=&gt;issue(Type = `"http://schemas.microsoft.com/authorization/claims/permit`", Value = `"true`"); "</strong><br/><strong>$issuanceRules = "@RuleName = `"Issue all claims`"`nx:[]=&gt;issue(claim = x); "</strong><br/><strong>$redirectUrl = "https://adfshelp.microsoft.com/ClaimsXray/TokenResponse"</strong><br/><strong>$samlEndpoint = New-AdfsSamlEndpoint -Binding POST -Protocol SAMLAssertionConsumer -Uri $redirectUrl</strong><br/><br/><strong>Add-ADFSRelyingPartyTrust -Name "ClaimsXray" -Identifier "urn:microsoft:adfs:claimsxray" -IssuanceAuthorizationRules $authzRules -IssuanceTransformRules $issuanceRules -WSFedEndpoint $redirectUrl -SamlEndpoint $samlEndpoint</strong></pre>
<ol start="2">
<li>To use OAuth2, we need to create the required OAuth client:</li>
</ol>
<pre style="padding-left: 90px"><strong>Add-AdfsClient -Name "ClaimsXrayClient" -ClientId "claimsxrayclient" -RedirectUri https://adfshelp.microsoft.com/ClaimsXray/TokenResponse</strong><br/><br/><strong>if ([System.Environment]::OSVersion.Version.major -gt 6) { Grant-AdfsApplicationPermission -ServerRoleIdentifier urn:microsoft:adfs:claimsxray -AllowAllRegisteredClients -ScopeNames "openid","profile" }</strong></pre>
<ol start="3">
<li>You will get a <span class="packt_screen">WS-Federation Passive Endpoints</span> and <span class="packt_screen">SAML Assertion Consumer Endpoint</span> and OAuth2 configured:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/c274f4e7-132c-4788-856f-f86934c44e04.png" style="width:27.50em;height:16.00em;" width="392" height="229"/></p>
<ol start="4">
<li>Open a browser and test the basic capabilities with one of your test users on the following page: <a href="https://login.inovitdemos.ch/adfs/ls/IdpInitiatedSignon.aspx">https://login.inovitdemos.ch/adfs/ls/IdpInitiatedSignon.aspx</a>.<a href="https://login.inovitdemos.ch/adfs/ls/IdpInitiatedSignon.aspx"/></li>
</ol>
<ol start="5">
<li>Choose ClaimsXRay, log in, and see your token response:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/985b533f-1746-41f4-98b2-18d7a83a00a8.png" width="1351" height="750"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Get your claim information</div>
<p>Now that we have our first helper applications in place, we can start playing around with them. You are already able to view two sample implementations with WS-Federation, SAML, and OAuth.</p>
<p>With the <span class="packt_screen">Claims X-Ray</span> application, we can run several tests against our ADFS instance. For this, we use source at <a href="https://bit.ly/2EqoPOi">https://bit.ly/2EqoPOi</a>:</p>
<ol>
<li>Let's test our <span class="packt_screen">OAuth</span> configuration with the following settings:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8cce6977-847e-479b-a9c8-6936af9aa687.png" style="width:59.00em;height:43.83em;" width="1210" height="899"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Testing the OAuth configuration with the Claims X-Ray tool</div>
<ol start="2">
<li>Now, you can analyze your response and you will see that you already work with OAuth2:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4b60a275-a90c-4372-ac06-f9d25a003309.png" width="1351" height="750"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">View the response</div>
<p>What about if you want to translate a <strong>SAML Token</strong> into a <strong>Kerberos</strong> one:</p>
<ol>
<li>You can work with the <span class="packt_screen">Non claims aware</span> option in <kbd>ADFS</kbd>, which appears if you add a new <span class="packt_screen">Relying Party</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/486ea529-d160-4a3a-b71d-8ccbdf0fe7a3.png" style="width:33.00em;height:11.50em;" width="485" height="169"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Adding the Kerberos example app</div>
<ol start="2">
<li>Let's try this with our Kerberos example application:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/c0372bd0-76ce-4273-8e4a-d81b7c0c8b34.png" style="width:32.83em;height:4.58em;" width="551" height="76"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Providing a Display Name</div>
<ol start="3">
<li>Click <span class="packt_screen">Next</span> and enter <a href="https://kerb.inovitdemos.ch">https://kerb.inovitdemos.ch</a> in <span class="packt_screen">Relying party trust identifier</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6ec6d2d3-12e0-40c1-bcc6-ce5ac33d6e54.png" style="width:32.67em;height:9.92em;" width="543" height="164"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring the identifier</div>
<ol start="4">
<li>Click <span class="packt_screen">Next</span> in the <span class="packt_screen">Access Control Policy</span> section and next again until the relying party is added.</li>
<li>To test the application, we need to configure the <span class="packt_screen">Web Application Proxy</span> to publish the app externally.</li>
<li>Log in to <strong>YD1URA01</strong> and publish the <strong>Kerberos application</strong> over at the <span class="packt_screen">Remote Access Management</span> console:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/85793156-3867-4478-9000-2e790fc1efee.png" width="1510" height="497"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Publishing the Kerberos app with the Web Application Proxy</div>
<ol start="7">
<li>Click <span class="packt_screen">Next</span> and choose the <span class="packt_screen">Web and MSOFBA</span> option.</li>
<li>Next, choose <kbd>Kerberos Demo Web Site</kbd> and configure the following settings:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/55ad9956-01a0-4c28-9275-1732f5582b32.png" style="width:52.08em;height:29.58em;" width="776" height="441"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Providing the external/backend server URL and SPN</div>
<ol start="9">
<li>Finish the configuration and jump to your external admin virtual machine or any other external client</li>
<li><span>Open a browser and the Kerberos website, <a href="https://kerb.inovitdemos.ch">https://kerb.inovitdemos.ch</a>, and get a successful login</span></li>
</ol>
<p><span>Before we start to test more applications, we will install the Fiddler Debugging tool from <a href="https://bit.ly/2eBzw4C">https://bit.ly/2eBzw4C</a> to analyze our traffic:</span></p>
<ol>
<li>Start the Fiddler debugging tool:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ce2d91c6-51e4-4570-81ce-aba6d4c2aaa4.png" style="width:53.92em;height:6.17em;" width="819" height="94"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Using Fiddler for authentication analysis</div>
<ol start="2">
<li>Configure the <span class="packt_screen">HTTPS</span> capture options:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/31fe9b4f-e0b0-456b-a002-b1ca0d431f1b.png" style="width:34.08em;height:27.58em;" width="539" height="436"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Capturing HTTPS traffic with Fiddler</div>
<ol start="3">
<li><span>Press <em>F12</em> to start the debugging and o</span><span>pen a browser, and you'll see the traffic produced.</span></li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Integrating Azure MFA (YD1ADS01)</h1>
                </header>
            
            <article>
                
<p>In this section, we just integrate <span class="packt_screen">Azure MFA</span> into our <span class="packt_screen">ADFS</span> farm. We will customize and use this option in <a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml">Chapter 8</a>, <em>Using Azure AD App Proxy and Web Application Proxy</em>:</p>
<ol>
<li>First of all, we need to generate a certificate for <span class="packt_screen">Azure MFA</span> on each server using the following cmdlet:</li>
</ol>
<pre style="padding-left: 90px"><strong># Replace the tenant ID to your value</strong><br/><strong>$certbase64 = New-AdfsAzureMfaTenantCertificate -TenantID 181031inovitdemos.onmicrosoft.com</strong></pre>
<ol start="2">
<li>Next, we set the certificate as the new credential against the <span class="packt_screen">Azure Multi-Factor Auth</span> client:</li>
</ol>
<pre style="padding-left: 90px"><strong># Connect to the MsolService with your global administrator rights</strong><br/><strong>Connect-MsolService</strong><br/><br/><strong># Create a new Service Principal Credential the AppPrincipalId is the hardcoded one for Azure MFA</strong><br/><strong>New-MsolServicePrincipalCredential -AppPrincipalId 981f26a1-7f43-403b-a875-f8b09b8cd720 -Type asymmetric -Usage verify -Value $certBase64</strong></pre>
<ol start="3">
<li>Now, we can configure the ADFS farm:</li>
</ol>
<pre style="padding-left: 90px"><strong>Set-AdfsAzureMfaTenant -TenantId <span>181031inovitdemos.onmicrosoft.com</span> -ClientId 981f26a1-7f43-403b-a875-f8b09b8cd720</strong><br/><br/><strong>Restart-Service adfssrv</strong></pre>
<ol start="4">
<li>Afterwards, we can see that <span class="packt_screen">Azure MFA</span> is available as the primary authentication method for intranet/extranet use:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1c044925-ff3f-4659-931f-6d8e2d733f44.png" style="width:33.25em;height:19.08em;" width="471" height="270"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">ADFS Primary Authentication configuration</div>
<div class="packt_tip">ADFS 2019 allows you to use other third-party authentication providers as the primary method.</div>
<p>With this configuration, we have successful implemented <span class="packt_screen">Azure MFA</span> in our ADFS farm.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>A lot of practical work, hopefully you liked it! From our perspective, it's always the best to work directly with the authentication methods and capabilities you have just learned. Working through this chapter moves you to touch Azure AD and ADFS to provide several authentication methods. We know that we have many pre-configuration tasks, but it helps you to know the application configurations and to apply the correct authentication configuration. You touched on WS-Federation, SAML, and OAuth2 methods, including Azure AD's user provisioning capabilities.</p>
<p>In the next chapter, we will dive further into the different authentication scenarios and <span>also</span><span> </span><span>put the application proxy features in place. We'll be happy to see you in </span><a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml">Chapter 8</a>,<span> </span><em>Using Azure AD App Proxy and Web Application Proxy</em>.</p>


            </article>

            
        </section>
    </div>



  </body></html>