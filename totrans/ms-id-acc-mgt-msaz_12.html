<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Exploring Azure AD Identity Services</h1>
                </header>
            
            <article>
                
<p>In this chapter, we'll explore the different Azure AD identity services and AD FS as an on-premise identity service. We'll look at the Azure AD B2B and B2C functionality and explain the main concepts behind these technologies. Furthermore, we'll look at and extend the Azure AD Domain Services that we configured in <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml" target="_blank">Chapter 1</a>, <em>Building and Managing Azure Active Dire</em><em>ctory</em>. To get the whole picture, we'll also view the different capabilities of the Active Directory Federation Services, and how they support different authentication scenarios. You will learn how to use the Azure AD B2B and B2C services for your projects, in order to provide suitable access to your applications for customers, partners, and internal employees. Particularly, you can use Azure AD B2C as a complete identity platform for your developed applications.</p>
<p>The chapter will be divided into the following sections:</p>
<ul>
<li>Preparing your lab environment</li>
<li>Understanding Azure AD <strong>Business to Business</strong> (<strong>B2B</strong>)</li>
<li>Exploring Azure AD <strong>Business to Customer</strong> (<strong>B2C</strong>)</li>
<li>Extending Active Directory solutions with Azure AD Domain Services</li>
<li>AD FS as an on-premise identity service for the cloud</li>
</ul>
<p>In the first section, we start preparing our lab environment.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Preparing your lab environment</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will need to have an additional Azure AD, configured with Office 365, to test the different features. You already know how to create this configuration from <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml" target="_blank">Chapter 1</a>, <em>Building and Managing Azure Active Directory</em><em>. </em>Build this additional tenant with a minimum set of configurations. Basically, you'll need to have a custom domain verified and registered, and nothing else. Furthermore, you will need to install Visual Studio 2017 Community with the ASP.NET and web development workload on your administrative workstation:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5f186b00-0296-4ea8-a9d2-2f16fd0ba48d.png" width="1066" height="752"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Lab environment overview</div>
<p>To configure the Azure AD Domain Services LDAPS use case, you need to provide a public SSL certificate. You can use the procedure from <a href="468509fa-856c-411d-abdb-e9a39c266750.xhtml" target="_blank">Chapter 7</a>, <em>Deploying Solutions on Azure AD and AD FS</em>, to generate certificates for your needs with Let's Encrypt solution. We'll start with the Azure AD B2B functionality.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Understanding Azure AD B2B</h1>
                </header>
            
            <article>
                
<p>Azure AD B2B solves the problem of collaboration between business partners. It allows users to share business applications between partners, without going through inter-company federation relationships and internally-managed partner identities. With Azure AD B2B, you can create cross-company relationships by inviting and authorizing users from partner companies to access your resources. With this process, each company federates once, with Azure AD, and each user is then represented by a single Azure AD account. This option also provides a higher security level, because if a user leaves the partner organization, access is automatically disallowed. Inside of Azure AD, the user will be handled as a guest, and they won't be able to traverse other users in the directory. Permissions of the invited user will be provided over the correct associated group membership.</p>
<p><span class="fontstyle0">The following figure shows the process of enabling business partners to access your applications:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/adca06a2-b987-4aef-816d-4581782a6ca4.png" width="1072" height="750"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2B invitation flows</div>
<p class="mce-root"/>
<p>In the case of <strong>FLOW 1</strong>, the user will be able to sign in to the partner organization after they accept, and consent to, the invitation.</p>
<p><span class="fontstyle0">In the case of</span> <strong><span class="fontstyle2">FLOW 2</span></strong>, t<span class="fontstyle0">he user signs up for their own Azure Active Directory and will be added to the Azure AD from which the invitation process was started.</span></p>
<p>You can find more information about the service at <a href="https://docs.microsoft.com/en-us/azure/active-directory/b2b/what-is-b2b">https://docs.microsoft.com/en-us/azure/active-directory/b2b/what-is-b2b</a>. In <a href="c2cd3ca9-8110-49fe-893e-3f4078ee9e26.xhtml">Chapter 11</a>, <em>Creating Identity Life Cycle Management on Azure</em>, we'll provide the configuration tasks for the complete guest-management life cycle, which includes the Azure AD B2B portal, using Azure MFA, conditional access, and access reviews.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Providing resource access to external partners (on-premise)</h1>
                </header>
            
            <article>
                
<p class="mce-root">With the following on-premise configuration, we can provide resource access to external partners. You can use AD FS for this task, to allow employees and customers or partners to access your claims-aware applications. We can achieve the goal of providing federated B2B access by configuring federation partners.</p>
<p>The design and the traffic flow are shown in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/80a6590d-7671-4c16-9dfe-317c0af3a41b.png" width="1163" height="706"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">ADFS B2B configuration</div>
<p>Another capability of Active Directory Federation Service is the ability to support active clients using the <strong>WS-Trust</strong> specifications. This allows your client software to interact with the different players in such a scenario, without relying on browser redirects to locate the claims provider, resource provider, or other relevant components.</p>
<p class="mce-root">The flow runs in the following steps:</p>
<ol>
<li class="mce-root">The <strong>Requesting Service</strong> (software on client) queries the <strong>Target Service</strong> and requests a list of policy requirements. This includes a list of required claims and the STS.</li>
<li class="mce-root"><span>The</span><strong><span> </span></strong>Requesting Service queries the <strong>Relying Party STS</strong> for policies. This includes the list of claims providers that the STS trusts.</li>
</ol>
<ol start="3">
<li><span>The</span><strong><span> </span></strong>Requesting Service queries the <strong>Claims Provider STS</strong> for the list of policies. This includes the required authentication method and other information.</li>
<li><span>The</span><strong><span> </span></strong>Requesting Service receives all of the policy information; the client will request a token from the <strong>C</strong><strong>laims Provider</strong> (<strong>CP</strong>). This is a direct connection to the CP using <strong>SOAP over HTTPS</strong>.</li>
<li>The <strong>CP</strong> authenticates the user and returns a token.</li>
<li><span>The</span><strong><span> </span></strong>Requesting Service receives the token; a token will be directly requested from the <strong>Relying Party</strong> (<strong>RP</strong>) using SOAP over HTTPS.</li>
<li>The <strong>Relying Party Federation</strong> Server signs the token and sends it back to the user.</li>
<li><span>The</span><span> </span><strong>Requesting Service receives</strong> the token that has been issued and signed by the <strong>Relying Party STS</strong>. It submits the token to the target services and receives a response:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8051c144-6f62-44b9-91f0-67254195437d.png" style="width:33.50em;height:22.00em;" width="1023" height="672"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">WS-trust flow</div>
<p>Remember that this on-premise extension can always be supported and used with Azure Identity and Access Management services.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Exploring Azure AD B2C</h1>
                </header>
            
            <article>
                
<p><span class="fontstyle0">Azure AD </span><span class="fontstyle2">B2C</span><span class="fontstyle0"> builds a complete identity-management framework for developers and supports signing in to your application using social networks, such as Facebook, Google, or LinkedIn, and creating developed accounts with usernames and passwords specifically for your company-owned application. Self-service password management and profile management are also provided. Additionally, Azure MFA introduces a higher grade of security to the solution. Principally, this feature allows for small, medium, and large companies to hold their customers in a separate Azure Active Directory, with all the capabilities, and more, in a similar way to the corporate-managed Azure Active Directory. With different verification options, you are also able to provide the necessary identity assurance required for more sensible transactions. Azure AD B2C takes care of all of the IAM tasks for your own development activities.</span></p>
<p>Basically, the minimum architecture with the usage of Azure AD B2C looks like the following example. As we already mentioned, Azure AD B2C provides the identity-management framework for your application:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a291032e-0aa6-4c8d-a7eb-56d00f615397.png" style="width:35.00em;height:17.00em;" width="665" height="323"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2C basic concepts</div>
<p>To get a better understanding of Azure AD B2C, we'll build an example application from Microsoft that provides a small web application, including a web API. This application is a good starting point to get deeper into Azure AD B2C. We highly recommend building it in your lab environment. The application can also run against a predefined demo environment. You will find the source at <a href="https://github.com/Azure-Samples/active-directory-b2c-dotnet-webapp-and-webapi#Using-the-demo-environment">https://github.com/Azure-Samples/active-directory-b2c-dotnet-webapp-and-webapi#Using-the-demo-environment</a>.</p>
<div class="packt_tip">We recommend working through the following Azure AD B2C introduction before you start the lab activities: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-overview">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-overview</a></div>
<p>Let's start our journey and log in to our administrative workstation.</p>
<div class="packt_tip">We'll do all of the Azure AD B2C tasks on the first full-blown Azure AD that we created.</div>
<p>In the next section, we will create the Azure AD B2C tenant.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure AD B2C tenant creation</h1>
                </header>
            
            <article>
                
<p>Now that we know the basic concept of Azure AD B2C, we will start our configuration for the test application that uses Azure AD B2C to provide the identity platform:</p>
<ol>
<li>Open a shell or command line in your Visual Studio project folder, in my case <kbd>C:\Users\jochen.nickel\Documents\Visual Studio 2017\Projects</kbd>, and execute the following command:</li>
</ol>
<pre style="padding-left: 90px"><strong>git clone https://github.com/Azure-Samples/active-directory-b2c-dotnet-webapp-and-webapi.git</strong></pre>
<ol start="2">
<li>Create the <strong>Azure AD B2C directory</strong>.</li>
<li>Open the Azure Portal (<a href="https://portal.azure.com">https://portal.azure.com</a>) with global administrator credentials.</li>
<li>Use the search option to find the <span class="packt_screen">Azure AD B2C</span> blade to view the service that we'll create:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ccf4d5eb-89e7-424c-aa44-7458ee85ad15.png" width="1036" height="678"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2C creation procedure</div>
<ol start="5">
<li>Click on <span class="packt_screen">Create a resource</span> in the top-left corner of the Azure portal.</li>
<li>Click on <span class="packt_screen">Identity</span> and choose <span class="packt_screen">Azure Active Directory B2C</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/037e5dda-3095-4a09-9b32-26d9a3a952ed.png" style="width:28.92em;height:15.50em;" width="508" height="272"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choose Azure AD B2C</div>
<ol start="7">
<li>Click on <span class="packt_screen">Create a new Azure AD B2C Tenant</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0693f86b-8923-424e-aa3b-f3c988aa827b.png" style="width:32.75em;height:6.67em;" width="561" height="115"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Create the new Azure AD B2C tenant</div>
<ol start="8">
<li>Use the <kbd>YOURDOMAIN1</kbd> and <kbd>YOURDOMAINB2C</kbd> values for your demo environment:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/087afe05-7684-44dc-97ba-be18e038d85a.png" style="width:23.25em;height:22.83em;" width="300" height="294"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2C properties</div>
<ol start="9">
<li>Link the new Azure AD B2C to our Azure subscription:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/c8624929-7cf3-471a-8a8b-f41c4aedddd5.png" width="880" height="302"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Linking the Azure AD B2C tenant</div>
<ol start="10">
<li>Switch the directory to use the new Azure AD B2C tenant:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f5392e27-b426-4096-951a-00f80e413d32.png" style="width:23.50em;height:20.92em;" width="315" height="281"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD directory switching</div>
<ol start="11">
<li>Use the Azure AD B2C directory:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/e512e211-6e95-4429-85fe-0382b2efffba.png" style="width:22.58em;height:9.67em;" width="321" height="138"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choose the newly created Azure AD B2C tenant</div>
<ol start="12">
<li>Navigate to the <span class="packt_screen">Azure AD B2C</span> blade:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/21a2b993-cc5e-4a99-a301-51be0ddb5b63.png" width="1557" height="553"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2C overview page</div>
<p>In the next section, we will configure the demo application in Azure AD.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Demo app registration</h1>
                </header>
            
            <article>
                
<p>Next, we'll register the new <kbd>Demo Web App</kbd> and the <span class="packt_screen">Web App</span><strong> </strong>API under <span class="packt_screen">application</span>:</p>
<ol>
<li>Add the <span class="packt_screen">web app</span>, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/94e7d831-7d91-4953-8417-2350e7bfdfda.png" style="width:40.25em;height:41.67em;" width="574" height="594"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">Provide the app properties</div>
<ol start="2">
<li>Create an app key:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d3e47636-fdbc-4e25-94b5-d91544aa759f.png" style="width:38.75em;height:21.58em;" width="549" height="306"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">App key generation process</div>
<ol start="3">
<li>Copy the key value to a notepad.</li>
<li>Copy the app ID under the properties section to the notepad.</li>
<li><span>Register the second app</span> for the <span class="packt_screen">Web App</span> API.</li>
<li>Fill in the values, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/36fa302a-7db7-4f93-a277-6105bbc65cae.png" style="width:37.25em;height:36.58em;" width="575" height="565"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Register the second application with properties</div>
<ol start="7">
<li>Copy the <span class="packt_screen">App ID URI (optional)</span> to the notepad.</li>
</ol>
<ol start="8">
<li>Configure the <span class="packt_screen">Published scopes</span> of the web API:
<ul>
<li><span class="packt_screen">Hello.Write</span> | <span class="packt_screen">Write access to hello</span></li>
<li><span class="packt_screen">Hello.Read</span> | <span class="packt_screen">Read access to hello</span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/235e4f28-b3db-401d-9486-8a36dfcfd5df.png" style="width:60.25em;height:13.83em;" width="1315" height="301"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Defining scopes</div>
<ol start="9">
<li>Change to the <span class="packt_screen">Web App</span> and <span class="packt_screen">API access</span> section.</li>
<li>Click on <span class="packt_screen">Add</span> and select the <span class="packt_screen">Demo Web API</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3ddfd61d-9465-4362-89ff-45dfd4e8b050.png" style="width:57.25em;height:18.75em;" width="1003" height="329"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Define the app access</div>
<ol start="11">
<li>You should be presented with the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/979fd52b-2f60-4b45-a26e-df8f5f8d8712.png" style="width:59.75em;height:17.33em;" width="1092" height="316"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">API access result</div>
<ol start="12">
<li>You should have a notepad with the following values:</li>
</ol>
<pre style="padding-left: 90px"><strong>Web App</strong> <br/>ID d92c671f-c576-45b1-9d53-0510f306bccc<br/>Key WdLrw#+DZ6L#vW7,3(ryS.uP<br/><br/><strong>Web App API</strong><br/>ID 2f73f192-e9c5-4fa8-8429-9aa3fd13293e</pre>
<p>Now, we can start the user flow creation in Azure AD B2C.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">User flow creation</h1>
                </header>
            
            <article>
                
<p>In the following section, we will configure the first user flow in Azure AD B2C to get a user sign-up process to the demo application.</p>
<p>Next, we will create our first user flow:</p>
<ol>
<li>Navigate to <span class="packt_screen">user flows</span> (policies) and create your first flow:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7dca4889-7a6c-48f0-ba48-b762825e6171.png" width="980" height="178"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">New user flow creation</div>
<ol start="2">
<li>Use the <span class="packt_screen">Sign up and sign in</span> option:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/659bdb77-c731-4682-b813-ba5198d50056.png" style="width:27.50em;height:10.58em;" width="364" height="140"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choosing the Sign up and sign in option</div>
<ol start="3">
<li>Use the following values for the flow:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/90bfcf98-1fe3-4cd9-99fc-270c3ad8ad23.png" style="width:39.75em;height:52.67em;" width="577" height="764"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Defining the flow properties</div>
<ol start="4">
<li>And the following attributes:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/e8c9318f-1941-432c-a0cc-f322cb464beb.png" style="width:32.58em;height:39.75em;" width="531" height="649"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Choosing the attributes that will be collected and will also return a claim</div>
<ol start="5">
<li>Click on <span class="packt_screen">Create.</span></li>
</ol>
<p>Now that we have prepared the <span class="packt_screen">Sign up and sign in</span> options, we can start to modify the demo application code.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Visual Studio code modification</h1>
                </header>
            
            <article>
                
<p>To use the newly created user flow, we need to modify the demo application code.</p>
<p>Modify the <kbd>TaskWebApp</kbd> project, as follows:</p>
<ol>
<li>Open the <kbd>web.config</kbd> file from <kbd>TaskWebApp</kbd>.</li>
<li class="mce-root">Find the following keys and replace them:
<ul>
<li class="mce-root"><kbd>ida:Tenant</kbd>, with your tenant name, <kbd>yourdomainb2c.onmicrosoft.com</kbd></li>
<li class="mce-root"><kbd>ida:ClientId</kbd>, with the app ID from the notepad</li>
<li class="mce-root"><kbd>ida:ClientSecret</kbd>, with your key from the notepad</li>
<li class="mce-root"><kbd>ida:SignUpSignInPolicyId</kbd>, with <kbd>b2c_1_SiUpIn</kbd></li>
</ul>
</li>
</ol>
<ol start="3">
<li>Comment out the following entries:</li>
</ol>
<pre style="padding-left: 90px">&lt;!--&lt;add key="api:TaskServiceUrl" value="https://aadb2cplayground.azurewebsites.net/" /&gt;--&gt;</pre>
<ol start="4">
<li>Uncomment the following entries:</li>
</ol>
<pre style="padding-left: 90px">&lt;add key="api:TaskServiceUrl" value="https://localhost:44332/"/&gt; </pre>
<ol start="5">
<li>Change the <kbd>api:ApiIdentifier</kbd> key value to the app ID URI of the API:</li>
</ol>
<pre style="padding-left: 90px">&lt;!--&lt;add key="api:ApiIdentifier" value="https://fabrikamb2c.onmicrosoft.com/api/" /&gt;—&gt;<br/>&lt;add key="api:ApiIdentifier" value="https://<strong>yourdomainb2c.onmicrosoft.com</strong>/myAPISample/" /&gt;</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<ol start="6">
<li>Your code should look as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a81ab074-d9f1-449d-8ac8-f49ef4f90dd7.png" width="1125" height="460"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Modified code reference</div>
<p>Modify the <kbd>TaskService</kbd> project, as follows:</p>
<ol>
<li>Open the <kbd>Web.config</kbd> file from the <kbd>TaskService</kbd> project.</li>
<li>Find the following keys and replace them:
<ul>
<li><kbd>ida:Tenant</kbd>, with your <kbd>yourdomainb2c.onmicrosoft.com</kbd></li>
<li><kbd>ida:ClientId</kbd>, with the application ID from your web API</li>
<li><kbd>ida:SignUpSignInPolicyId</kbd>, with <kbd>b2c_1_SiUpIn</kbd></li>
<li><kbd>api:ReadScope</kbd>, with <kbd>Hello.Read</kbd></li>
<li><kbd>api:WriteScope</kbd>, with <kbd>Hello.Write</kbd></li>
</ul>
</li>
</ol>
<ol start="3">
<li>Your code should look like this:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/61e626ca-3091-43f2-aa04-ed2a500eab1f.png" width="1088" height="290"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Modified code reference</div>
<p>The Visual Studio <span class="packt_screen">Startup Project</span> modification is as follows:</p>
<ol>
<li>Go to the <span class="packt_screen">Solution Explorer</span> and<span class="packt_screen"> </span>right-click on <span class="packt_screen">P</span><span class="packt_screen">roperties</span>.</li>
<li>Under <span class="packt_screen">Common Properties</span>, go to <span class="packt_screen">Startup Project</span>.</li>
<li>Use the following configuration:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b127c982-4376-485b-b007-68240eb25fc0.png" width="765" height="668"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring the project start up options</div>
<ol start="4">
<li>Press <em>F5</em> in Visual Studio to start both the Web App and the Web App API:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/532bda90-6f96-453a-aa5d-49599549c63b.png" style="width:74.58em;height:17.17em;" width="1761" height="405"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Started applications view</div>
<ol start="5">
<li>Click on <span class="packt_screen">Sign up/Sign In</span> on the web app, and Azure AD B2C will come into the game:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0fe711b8-1ff2-46ce-91e4-101892114ed2.png" style="width:32.08em;height:18.92em;" width="658" height="388"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Testing the user flow</div>
<ol start="6">
<li>Click on <span class="packt_screen">Sign up now</span>.</li>
</ol>
<ol start="7">
<li>Enter your details and click on <span class="packt_screen">Send verification code</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2780ae59-f3cb-4022-9145-c905d5132f80.png" style="width:25.67em;height:27.58em;" width="548" height="589"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Providing the required data</div>
<ol start="8">
<li>You'll receive an email with the verification code, as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/22634846-deb7-4c57-902b-9d38de834654.png" style="width:26.50em;height:13.08em;" width="412" height="204"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Get your verification code</div>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="9">
<li>Verify and create the account.</li>
<li>Azure MFA will now come into the game; provide your preferred verification option:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7f57a770-f6be-4faa-8975-ef3ec3c8b407.png" style="width:25.17em;height:16.00em;" width="542" height="344"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Providing your verification</div>
<ol start="11">
<li>You've successfully signed in, and you can view your claims:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/53f10f96-6cda-4947-b2c7-4f71a86c8c8a.png" style="width:64.67em;height:30.58em;" width="1216" height="575"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Successful login on the demo app, including the provided claims</div>
<p>Yeah! Well done. You can dive deeper into Azure AD B2C at <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/">https://docs.microsoft.com/en-us/azure/active-directory-b2c/</a><a href="https://bit.ly/2AVqifY">.</a></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Comparing Azure AD B2B and B2C</h1>
                </header>
            
            <article>
                
<p>Basically, both of the Azure AD services allow you to work with external users. Azure AD B2B focuses on the business to simplify the collaboration process with the secure sharing of information and resources. It takes care of the federation between the organizations and allows for a simple invitation-and-redemption process with different account types, such as school and work accounts, or simply an email account.</p>
<p>Azure AD B2C focuses on developers that create customer-facing apps. Developers get a full-featured identity system for their applications. Azure AD B2C provides a local repository and the sign-in experience with many other identity providers:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong>Azure AD B2B</strong></td>
<td><strong>Azure AD B2C</strong></td>
</tr>
<tr>
<td>Authentication of users from partner organizations</td>
<td>Customer access with mobile and web apps</td>
</tr>
<tr>
<td>Partner life cycle = host and inviting organizations, including access reviews</td>
<td>Customer life cycle = self-service or application-managed</td>
</tr>
<tr>
<td>Supports work or school accounts, or any email address</td>
<td>Supports local user application accounts or supported identity providers</td>
</tr>
<tr>
<td>Supports SSO to all Azure AD connected applications</td>
<td>Supports SSO to customer-owned applications within the Azure AD B2C tenants</td>
</tr>
<tr>
<td>Security policy managed by both organizations</td>
<td>Security policy managed by the application</td>
</tr>
<tr>
<td>Branding managed by both organizations</td>
<td>Branding managed by the application</td>
</tr>
<tr>
<td>Partner users are included in the same Azure AD, by default, with the guest user type</td>
<td>Managed separately from the organization or partner Azure AD</td>
</tr>
</tbody>
</table>
<p> </p>
<p>In the next section, we'll compare AD FS against the two services, to provide you with a global view.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Comparing AD FS with Azure B2B and B2C</h1>
                </header>
            
            <article>
                
<p>In this section, we'll provide you with some helpful information so that you can differentiate between AD FS and the Azure AD B2B and B2C functionalities. </p>
<p>We'll start with the main differences between AD FS and the Azure B2B scenario. With Azure AD B2B comes the capability to invite users from partner organizations to access applications on your own Azure AD instance. With AD FS, you can provide the same functionality, with CP trusts, to any partner organization that's based on AD FS.</p>
<p class="mce-root"/>
<p class="mce-root">However, you will hit the following differences:</p>
<ul>
<li class="mce-root">With AD FS, you have a lot of flexibility, and can run any customized scenario</li>
<li class="mce-root">The following requirements need to be fulfilled:
<ul>
<li class="mce-root">Partner requires the Federation Service</li>
<li>Certificate handling</li>
<li>Administrative overhead</li>
</ul>
</li>
</ul>
<p>With<span> </span><strong>Azure AD B2B</strong>, there is an easy invitation process. <span>The feature is available for free, or by using a <strong>5.1 ratio</strong> if basic or premium features are used, and the partner doesn't need to fulfill any requirements—invitations for Azure AD and locally-based directory users, including social identities, are possible.</span></p>
<p><span class="fontstyle0">The admin controls all of the access to your corporate apps through your Azure AD directory. When collaboration is terminated, partner users can be removed from your Azure AD, and their access to your apps will immediately be revoked. Access reviews can be used to manage the life cycles of guest users. Additionally, when a partner user leaves the partner organization, access is automatically <span>lost</span></span> if the partner organizations uses a native Azure AD and not an AdHoc (unmanaged Azure AD tenant).</p>
<div class="packt_tip">Keep in mind that if you still want to use AD FS for B2B, you will need to manage the whole life cycle of the guest user's account.</div>
<p>The next thing that we will discuss is the difference between AD FS and Azure AD B2C. You have two main scenarios that you can run. First, you can handle customer accounts and an on-premise identity store, and the authentication can be managed by AD FS. This scenario is helpful if you want to have full control in your own environment. But you also need to provide several processes and technologies to support such a scenario—and this is for the whole year.</p>
<p>The other option is that customers can sign up or bring their own consumer identities with Azure AD B2C, so you will receive a fully-manageable solution with high availability and the most common processes and support functionalities already implemented.</p>
<p>AD FS delivers a very flexible and customizable solution in your own environment, but you have to integrate social media providers and build trust relationships, so that the users can bring their own identities. As we already mentioned, user management and self-servicing have to be built and provided with high availability.</p>
<p>With Azure AD B2C, you receive a fully-packed solution, which allows for the developer of a business application to use the whole identity framework of Azure AD and the B2C extensions. Sign-up pages are ready to use, or users can bring their own identities (Google, Live, Facebook, and so on), and you can enable self-servicing options.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Extending Active Directory solutions with Azure AD Domain Services</h1>
                </header>
            
            <article>
                
<p><span class="fontstyle0">Azure AD Domain Services helps you to move your on-premise applications, depending on traditional authentication methods, such as Kerberos and NTLM, to the cloud. This cloud-based service allows you to join your IaaS virtual machines to a managed domain without the need to provide domain controllers on virtual machines. With this solution, you can integrate your applications directly in your Azure Active Directory services and benefit from the rich feature set. With the synchronization of the Azure AD users to Azure AD DS, you can use identities to provide authentication and authorization. <span class="fontstyle2">You're also able to connect by<span> </span></span><strong>Lightweight Directory Access Protocol</strong><span> </span><span class="fontstyle2">(</span><strong>LDAP/S</strong><span class="fontstyle2">) to the directory service.<span> </span></span></span></p>
<p><span class="fontstyle0">The following diagram shows the integration scenario, from the perspective of an application installed on an IaaS virtual machine:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5847465d-3676-4d90-b74c-7ac1ffbfadb5.png" style="width:52.75em;height:20.75em;" width="975" height="384"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Domain Services overview</div>
<p>This service provides you with a flat organizational unit structure and group policies, by default, for managing the domain-joined server systems. Generally, it's not a good idea to join client computers in this directory.</p>
<p>The service is used to help you with the integration of the following systems:</p>
<ul>
<li>NAS systems</li>
<li>Print solutions</li>
</ul>
<p>It also lifts your on-premise services to Azure if they aren't claims-enabled.</p>
<p>The following configuration shows you how to extend the solution from <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml" target="_blank">Chapter 1</a>, <em>Building and Managing Azure Active Directory</em>, where we first enabled the service. To configure this solution, you will need to have a certificate. Refer to <a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml" target="_blank">Chapter 8</a>, <em>Using the Azure AD App Proxy and the Web Application Proxy</em>, to find instructions for creating a certificate for this purpose. Perform the following steps:</p>
<ol>
<li>Navigate to <a href="https://portal.azure.com">https://portal.azure.com</a> on the <span class="packt_screen">Azure AD Domain Services</span> blade.</li>
<li>Choose <span class="packt_screen">Secure LDAP</span> and <span class="packt_screen">Enable</span> the service:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/075ad8cb-9748-4433-8fe2-56c43e90856f.png" width="1094" height="444"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Secure LDAP activation procedure</div>
<ol start="3">
<li><span class="packt_screen">Enable</span> the <span class="packt_screen">Allow secure LDAP access over the internet</span>, and upload the certificate, including the private key:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0b938e07-5335-40d2-8723-00ac17b530eb.png" style="width:78.67em;height:40.33em;" width="1354" height="694"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Providing the certificate</div>
<ol start="4">
<li>Create a new LDAPS security rule in the network security group.</li>
<li>Add a rule with your source IP and the Azure AD DS destination network:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4cc813b5-6bb4-4581-bd3e-0aa1db006843.png" style="width:78.42em;height:31.25em;" width="1263" height="503"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Changing the firewall rules to allow LDAPS</div>
<ol start="6">
<li>Connect to the LDAPS service with your preferred LDAP browser:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a2aaad63-c812-44bf-98a9-6e205e107014.png" style="width:36.58em;height:16.83em;" width="452" height="208"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Testing the LDAPS connection</div>
<p>You can find more information about the LDAPS configuration at <a href="https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-admin-guide-configure-secure-ldap">https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-admin-guide-configure-secure-ldap</a>.</p>
<p class="mce-root">In the next section, we'll discuss how to use AD FS as an on-premise identity service for the cloud.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">AD FS as an on-premise identity service for the cloud</h1>
                </header>
            
            <article>
                
<p>Authenticating users in multi-forest environments is just a bit more complex than doing it in a typical single-forest deployment. You should already be aware of the basics of the different authentication protocols and AD FS, thanks to previous chapters. The configuration of the integration with Office 365 is a straightforward process; with the <kbd>Convert-MsolDomainToFederated</kbd> command, you can create everything that's needed in your AD FS configuration. With the <kbd>SupportMultipleDomain</kbd> switch, you can define whether you're using a multi-forest scenario.</p>
<p>Next, we'll start with the supported and possible scenarios in the case of using multiple forests and Office 365. We'll focus on the AD FS server deployment. Furthermore, you can always attach an AD FS proxy/WAP to these scenarios.</p>
<p>This section will cover the following scenarios:</p>
<ul>
<li>A typical single-forest deployment</li>
<li>Two or more Active Directory forests running separate AD FS instances</li>
<li>Running one AD FS instance for multiple trusted forests</li>
<li>Supporting one AD FS instance for multiple Active Directory forests without an AD trust relationship</li>
<li>Using a local CP trust to support multiple Active Directory forests</li>
<li>Using a shared Active Directory environment</li>
<li>Microsoft Cloud Solution Provider summary</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Typical single-forest deployment</h1>
                </header>
            
            <article>
                
<p>This scenario is a commonly seen configuration in smaller and medium-sized organizations; it's a one-forest scenario with AD FS authentication to Office 365. You can use one or more UPNs with the related verified UPN domains:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ca657763-f2a0-4807-92bd-d109585a725d.png" style="width:28.92em;height:9.50em;" width="668" height="220"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Single-forest deployment</div>
<p>We will follow up with the multiple AD forest scenarios in the next section.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Two or more Active Directory forests running separate AD FS instances</h1>
                </header>
            
            <article>
                
<p>This scenario is commonly used if there are no Active Directory trust relationships and CP trusts are in place. Every Active Directory forest holds its own AD FS server and responds to their own UPN. The administrator only needs to configure a unique UPN suffix. Azure AD Connect will do the relevant identity synchronization for the different forests:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1cb52f5b-59dc-4540-b4ab-a9194563d270.png" style="width:27.00em;height:15.92em;" width="657" height="387"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Two or more Active Directory forests running separate AD FS instances</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>In the next section, we will discuss a one-instance ADFS scenario for multiple forests.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Running one AD FS instance for multiple trusted forests</h1>
                </header>
            
            <article>
                
<p>Many organizations run several Active Directory forests. If a single authentication point is provided, one option is to work with an Active Directory <strong>Trust Relationship</strong>. With this design solution, every forest can use one AD FS environment, and all UPNs are running against this environment:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ee4bce0d-e147-4884-aab1-db2a2983a05c.png" style="width:40.17em;height:19.42em;" width="816" height="394"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">One AD FS instance for multiple trusted forests</div>
<p>Next, we will discuss the one ADFS instance approach for multiple forests without trust relationships.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">One AD FS instance for multiple Active Directory forests without an AD trust</h1>
                </header>
            
            <article>
                
<p>Another option for supporting multiple forests is to work with a CP trust, if Active Directory trust relationships can't be used. In this scenario, the AD FS server works, by default, against its own Active Directory forest. <span class="fontstyle0">The AD FS server will also be configured to ask another AD FS for specific UPNs:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d91cbfe2-c7d8-4025-a736-2afc2c17bd0b.png" style="width:37.83em;height:22.50em;" width="688" height="409"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">One AD FS instance for multiple Active Directory forests without an AD trust</div>
<p>In the next steps, we will discuss using the local claims provider trust to connect multiple AD forests.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using a local CP trust to support multiple Active Directory forests</h1>
                </header>
            
            <article>
                
<p>Beginning with AD FS 2016, you have the option of using a local CP trust to integrate additional forests. The only thing that you need to know is that you will lose automatic home-realm discovery for internal users. You can only provide a custom solution to do this for you:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a4656d3b-ed3a-4db2-8ee0-0f211ec4eb27.png" style="width:33.17em;height:19.67em;" width="688" height="409"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Using a local CP trust to support multiple Active Directory forests</div>
<p>You can configure the scenario with the following procedure:</p>
<ol>
<li>Set the credentials for the service account:</li>
</ol>
<pre style="padding-left: 60px"><strong>$credential = Get-Credential</strong></pre>
<ol start="2">
<li>Change the <kbd>HostName</kbd> to your domain controller, and use Port <kbd>636</kbd> if configured for a secure connection:</li>
</ol>
<pre style="padding-left: 60px"><strong># Example:</strong> $vendorDirectory = New-AdfsLdapServerConnection -<br/>HostName leanads01.leano.ch -Port 636 -SslMode None -<br/>AuthenticationMethod basic -Credential $credential<br/>$vendorDirectory = New-AdfsLdapServerConnection -HostName <br/>yourhostname-Port 636 -SslMode None -AuthenticationMethod basic -<br/>Credential $credential<br/>$Name = New-AdfsLdapAttributeToClaimMapping -LdapAttribute <br/>sAMAccountName -ClaimType "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"<br/>$Mail = New-AdfsLdapAttributeToClaimMapping -LdapAttribute mail -ClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"<br/><strong># Example:</strong> $AdditionalAttribute = New-AdfsLdapAttributeToClaimMapping -LdapAttribute mail -ClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress" </pre>
<ol start="3">
<li>Configure your own identifier, like <kbd>urn:example</kbd>, and define your root user container, like <kbd>DC=EXAMPLE,DC=COM</kbd>:</li>
</ol>
<pre style="padding-left: 60px"><strong># Choose your preferred display name in the Forms-Based Authentication with the -Name parameter
# Example:</strong> Add-AdfsLocalClaimsProviderTrust -Name "Partners" -Identifier "urn:leano" -Type Ldap -LdapServerConnection $vendorDirectory -UserObjectClass user -UserContainer "DC=leano,DC=CH" -LdapAuthenticationMethod basic -AnchorClaimLdapAttribute //userPrincipalName -AnchorClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn" -LdapAttributeToClaimMapping @($Name, $Mail) -AcceptanceTransformRules "c:[] =&gt; issue(claim=c);" -Enabled $true<br/><br/>Add-AdfsLocalClaimsProviderTrust -Name "External" -Identifier "urn:dev" -Type Ldap -LdapServerConnection $vendorDirectory -UserObjectClass user -UserContainer "DC=EXAMPLE,DC=COM" -LdapAuthenticationMethod basic -AnchorClaimLdapAttribute userPrincipalName -AnchorClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn" -LdapAttributeToClaimMapping @($Name, $Mail) -AcceptanceTransformRules "c:[] =&gt; issue(claim=c);" -Enabled $true </pre>
<ol start="4">
<li>Configure additional claim rules:</li>
</ol>
<pre style="padding-left: 60px"># Build a .txt file with the specific Claim rules - in my case <br/>ruleset.txt<br/># Change the samAccountName - Domain Suffix to your needs<br/>@RuleName = "Pass through UPN"<br/>c:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"]<br/>=&gt; issue(claim = c);<br/>@RuleName = "Pass through Mail"<br/>c:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"]<br/>=&gt; issue(claim = c);<br/>@RuleName = "Pass through sAMAccountName"<br/>c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]<br/>=&gt; issue(Type = "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Value = "Partners\" + c.Value);</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="5">
<li>Set the newly defined claim rules:</li>
</ol>
<pre style="padding-left: 60px"># <strong>Be aware to use the same name as you have chosen under Add-AdfsLocalClaimsProviderTrust -Name "Partners"<br/></strong>$ruleset = New-AdfsClaimRuleSet -ClaimRuleFile .\ruleset.txt<br/>Set-AdfsLocalClaimsProviderTrust -TargetName "Partners" -AcceptanceTransformRules $ruleset.ClaimRulesString <br/><br/><strong>Configure the HRD Cookie Lifetime to save the chosen IDP and to avoid further clicks for the user<br/></strong># In your case we would recommend a Lifetime of 1825 days = 5 years<br/>Set-AdfsWebConfig -HRDCookieLifetime 90 -HRDCookieEnabled:$true <br/><br/><strong>Add the additional IDP to your Relying Party Trust configuration</strong><span> <br/></span># TargetName = your RP you want to configure; and the ClaimsProviderName = Your defined name <br/><br/>Set-AdfsRelyingPartyTrust -TargetName "ClaimsXRay" -ClaimsProviderName @("Active Directory","Partners") </pre>
<ol start="6">
<li>Modify the display name of the Active Directory IDP:</li>
</ol>
<pre style="padding-left: 60px">// Insert the following code to the end of your onload.js script and define your own display name // Update your custom theme with the provided Theme Customization Scripts <br/>if ( document.getElementById("hrdArea") ) { <br/> var strADCPName = "Partners" ; <br/> //Create an array of all claim provider trust section in the page <br/> var listAllSpanForIdp = document.getElementsByClassName("idpDescription float") ; <br/> var inc; <br/> for (inc = 0; inc &lt; listAllSpanForIdp.length; inc++) { <br/> if ( listAllSpanForIdp[ inc ].innerHTML == "&lt;span class=\"largeTextNoWrap indentNonCollapsible\"&gt;Active Directory&lt;/span&gt;" ) { <br/> //Change the HTML content of the matching section to the value specified in the strADCPName variable <br/> listAllSpanForIdp[ inc ].innerHTML = "&lt;span class=\"largeTextNoWrap indentNonCollapsible\"&gt;"+ strADCPName +"&lt;/span&gt;" ; <br/> } <br/> } <br/>} </pre>
<ol start="7">
<li>Configure the relying party claims issuance policy:</li>
</ol>
<pre style="padding-left: 60px"># <strong>Sends all configured claim definitions</strong> from the local AD and the additional IDP (urn:example) <br/>Claim Issuance Rule 1 <br/>c:[Issuer =~ "^(SELF AUTHORITY|LOCAL AUTHORITY|urn:dev)$"]<br/> =&gt; issue(claim = c); <br/># <strong>Removes the domain suffix in the NameID claim</strong><span> <br/></span>Claim Issuance Rule 2 <br/>c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]<br/> =&gt; issue(Type = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier", Issuer = c.Issuer, OriginalIssuer = c.OriginalIssuer, Value = RegExReplace(c.Value, ".+?\\", ""), ValueType = c.ValueType, Properties["http://schemas.xmlsoap.org/ws/2005/05/identity/claimproperties/format"] = "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified"); <br/># <strong>Restart ADFS Service</strong><span> <br/></span>Restart-service ADFSsrv</pre>
<p>In the next section, we will discuss using a shared AD environment.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using a shared Active Directory environment</h1>
                </header>
            
            <article>
                
<p><span class="fontstyle0">In recent months, we've had several discussions about using a single forest environment with two Azure Active Directory tenants, including Office 365 services and an AD FS and Web Application Proxy combination. We often get these questions if the organization wants to use a separate Office 365 tenant, operated by 21Vianet or service providers that want to use a shared Active Directory infrastructure for small customers.</span></p>
<p>The following solution design is based on the following supported AAD Connect topology:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5ffcf133-1f05-48d6-840b-f5800de65047.png" style="width:34.00em;height:18.42em;" width="595" height="322"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Using a shared Active Directory environment</div>
<p class="mce-root">You can <span>only </span>use this option with AD FS or an equivalent product. Pass-Through Authentication won't work for this use case.</p>
<p>In this topology, an AAD Connect instance is configured for a mutually-exclusive set of objects; for example, an organizational unit or domain. Furthermore, different domains and user principle names need to be used for this scenario, as follows:</p>
<ul>
<li>A DNS name can only be registered in one Azure Active Directory (custom domains)</li>
<li>One-to-one relationships between an Azure AD Connect synchronization server and one Azure Active Directory</li>
<li>Azure Active Directory instances are, by design, isolated</li>
</ul>
<p><span class="fontstyle0">The requirement for a mutually-exclusive set of objects also applies to write-back. Some write-back features aren't supported with this topology, including the following:</span></p>
<ul>
<li><span class="fontstyle0">Group write-back with a default configuration</span></li>
<li><span class="fontstyle0">Device write-back</span></li>
</ul>
<p>The solution's design is based on the following key <span>features</span>:</p>
<ul>
<li>One single Active Directory forest, with organizational units based on regions or customers.</li>
<li>Users in the organizational units have the associated user principle names configured; for example, <strong>OU APAC</strong> uses the <kbd>@apac.inovitdemos.ch</kbd> UPN suffix or the <strong>specific customer suffix</strong>, such as <kbd>@azureid.ch</kbd>.</li>
<li>Two Azure AD Connect instances configured with the container filter, based on the organizational units.</li>
<li>One AD FS and Web Application Proxy combination, with the <kbd>login.inovit.ch</kbd> STS name.</li>
<li>One Azure Active Directory Tenant with Office 365 services, called <strong>Customer Tenant 1</strong>, and the following registered custom domain name: <kbd>inovitdemos.ch</kbd>.</li>
<li>One Azure Active Directory Tenant with Office 365 services, called <strong>Customer Tenant 2</strong>, and the <kbd>apac.inovitdemos.ch</kbd> or <kbd>azureid.ch</kbd> registered custom domain name:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img src="Images/19526e2c-f61b-4ae4-86d4-62096af9f8d9.png" style="width:42.75em;height:26.50em;" width="700" height="434"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Federation configuration overview</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The following description provides the main configuration steps to implement this scenario in your environment:</p>
<ul>
<li><strong>Configuration of the Federation Trust for Customer Tenant 1</strong>: This task is a very common one, because you just need to open an evaluated PowerShell on the AD FS server and type the following commands:</li>
</ul>
<pre style="padding-left: 90px">Connect-MsolService #Enter your global administrator credentials<br/>Convert-MsolDomainToFederated -DomainName inovit.ch -SupportMultipleDomain</pre>
<ul>
<li class="mce-root"><strong>Configuration of the Federation Trust for</strong> <strong>Customer Tenant 2</strong>: You can't use the same PowerShell command for the second tenant's configuration. If you try, you'll change the configuration completely to the second tenant. In this case, we need to use the <kbd>Set-MsolDomainAuthentication</kbd> command to configure the trust to the second tenant.</li>
</ul>
<div class="packt_tip"><kbd>Set-MsolDomainAuthentication</kbd> <span class="fontstyle2">is typically used to configure Federation Trusts with other Identity Providers.</span></div>
<p>To configure the second Federation Trust, you need to export the AD FS token-signing certificate from the AD FS farm configuration. You can do this with the AD FS management console or the following PowerShell commands:</p>
<pre><strong>$certTS=Get-AdfsCertificate -CertificateType Token-Signing</strong><br/><strong>$certInf=$certTS[0].Certificate.Export([System.Security.Cryptography.X509Certificates.X509ContentType]::Cert)</strong><br/><strong>[System.IO.File]::WriteAllBytes("c:\temp\inovit-ts.cer", $certBytes)</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Now that we have exported the token-signing certificate, we can start to configure the Federation Trust for <strong>Customer Tenant 2</strong>:</p>
<pre class="mce-root"><strong>$crt = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2("c:\temp\inovit-ts.cer ")</strong><br/><strong>$certData = [system.convert]::tobase64string($cert.rawdata)</strong><br/><strong>$customdomain="azureid.ch"</strong><br/><strong>#customdomain="apac.inovitdemos.ch"</strong><br/><strong>$url="https://login.inovitdemos.ch/adfs/ls/"</strong><br/><strong>$uri="http://login.inovitdemos.ch /adfs/services/trust/"</strong><br/><strong>$ura="https://login.inovitdemos.ch/adfs/services/trust/2005/usernamemixed"</strong><br/><strong>$logouturl="https://login.inovitdemos.ch/adfs/ls/"</strong><br/><strong>$metadata="https://login.inovitdemos.ch/adfs/services/trust/mex"</strong><br/><br/><strong>Set-MsolDomainAuthentication -DomainName $customdomain -Authentication Federated -ActiveLogOnUri $ura -PassiveLogOnUri $url -MetadataExchangeUri $metadata -SigningCertificate $certData -IssuerUri $uri -LogOffUri $logouturl -PreferredAuthenticationProtocol WsFed</strong></pre>
<p>With this solution, you're also ready to solve other scenarios with the same requirements.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Microsoft Cloud Solution Provider summary</h1>
                </header>
            
            <article>
                
<p class="mce-root">The following figure provides an overview of the best way to integrate and connect cloud services for Microsoft Cloud Service Providers. The most supported way is to use one Active Directory for the customer and connect a single Azure AD tenant, or move a small customer to a cloud-only scenario. Azure AD DS can be very helpful in such a scenario:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6f3e8f5d-1413-4742-bf31-aa29ae93b980.png" width="1140" height="900"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">Microsoft Cloud Solution Provider overview</div>
<p>The shared local Active Directory scenario can still be used, but with great effort.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you worked through the different Azure AD identity services, such as Azure AD B2B/B2C and the Domain Services. You also explored different options with AD FS as an identity service, in order to get the whole picture of a hybrid identity and the access-management world.</p>
<p>In the next chapter, we'll dive into different application types and deployment methods, including more details about conditional access and other features that we can use.</p>


            </article>

            
        </section>
    </div>



  </body></html>