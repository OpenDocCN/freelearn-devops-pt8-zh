<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Working with Files and Packages"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Working with Files and Packages</h1></div></div></div><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"A writer has the duty to be good, not lousy; true, not false; lively, not dull; accurate, not full of error."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>E.B. White</em></span></span></td></tr></table></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Making quick edits to config files</li><li class="listitem" style="list-style-type: disc">Editing INI style files with puppetlabs-inifile</li><li class="listitem" style="list-style-type: disc">Using Augeas to reliably edit config files</li><li class="listitem" style="list-style-type: disc">Building config files using snippets</li><li class="listitem" style="list-style-type: disc">Using ERB templates</li><li class="listitem" style="list-style-type: disc">Using array iteration in templates</li><li class="listitem" style="list-style-type: disc">Using EPP templates</li><li class="listitem" style="list-style-type: disc">Using GnuPG to encrypt secrets</li><li class="listitem" style="list-style-type: disc">Installing packages from a third-party repository</li><li class="listitem" style="list-style-type: disc">Comparing package versions</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec58"/>Introduction</h1></div></div></div><p>In this chapter, we'll see how to make small edits to files, how to make larger changes in a structured way using the<a id="id304" class="indexterm"/> <span class="strong"><strong>Augeas</strong></span> tool, how to construct files from concatenated snippets, and how to generate files from templates. We'll also learn how to install packages from additional repositories, and how to manage those repositories. In addition, we'll see how to store and decrypt secret data with Puppet.</p></div></div>
<div class="section" title="Making quick edits to config files"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec59"/>Making quick edits to config files</h1></div></div></div><p>When you need to<a id="id305" class="indexterm"/> have Puppet change a particular setting in a config file, it's<a id="id306" class="indexterm"/> common to simply deploy the whole file with Puppet. This isn't always possible, though; especially if it's a file that several different parts of your Puppet manifest may need to modify.</p><p>What would be useful is a simple recipe to add a line to a config file if it's not already present, for example, adding a module name to <code class="literal">/etc/modules</code> to tell the kernel to load that module at boot. There are several ways to do this, the simplest is to use the <code class="literal">file_line</code> type provided by the <code class="literal">puppetlabs-stdlib</code> module. In this example, we install the <code class="literal">stdlib</code> module and use this type to append a line to a text file.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec158"/>Getting ready</h2></div></div></div><p>Install the <code class="literal">puppetlabs-stdlib</code> module<a id="id307" class="indexterm"/> using puppet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~ $ puppet module install puppetlabs-stdlib</strong></span>
<span class="strong"><strong>Notice: Preparing to install into /home/thomas/.puppet/modules ...</strong></span>
<span class="strong"><strong>Notice: Downloading from https://forgeapi.puppetlabs.com ...</strong></span>
<span class="strong"><strong>Notice: Installing -- do not interrupt ...</strong></span>
<span class="strong"><strong>/home/thomas/.puppet/modules</strong></span>
<span class="strong"><strong>└── puppetlabs-stdlib (v4.5.1)</strong></span>
</pre></div><p>This installs the module from the forge into my user's puppet directory; to install into the system directory, run the command as root or use <code class="literal">sudo</code>. For the purpose of this example, we'll continue working as our own user.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec159"/>How to do it...</h2></div></div></div><p>Using the <code class="literal">file_line</code> resource type, we can ensure that a line exists or is absent in a config file. Using <code class="literal">file_line</code> we can quickly make edits to files without controlling the entire file.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a manifest named <code class="literal">oneline.pp</code> that will use <code class="literal">file_line</code> on a file in <code class="literal">/tmp</code>:<div class="informalexample"><pre class="programlisting">  file {'/tmp/cookbook':
    ensure =&gt; 'file',
  }
  file_line {'cookbook-hello':
    path    =&gt; '/tmp/cookbook',
    line    =&gt; 'Hello World!',
    require =&gt; File['/tmp/cookbook'],
  }</pre></div></li><li class="listitem">Run <code class="literal">puppet apply</code> on the <code class="literal">oneline.pp</code> manifest:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ puppet apply oneline.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for mylaptop in environment production in 0.39 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/File[/tmp/cookbook]/ensure: created</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/File_line[cookbook-hello]/ensure: created</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
</pre></div></li><li class="listitem">Now verify that <code class="literal">/tmp/cookbook</code> contains the line we defined:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/cookbook</strong></span>
<span class="strong"><strong>Hello World!</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec160"/>How it works…</h2></div></div></div><p>We installed<a id="id308" class="indexterm"/> the <code class="literal">puppetlabs-stdlib</code> module into the default module <a id="id309" class="indexterm"/>path for Puppet, so when we ran <code class="literal">puppet apply</code>, Puppet knew where to find the <code class="literal">file_line</code> type definition. Puppet then created the <code class="literal">/tmp/cookbook</code> file if it didn't exist. The line <code class="literal">Hello World!</code> was not found in the file, so Puppet added the line to the file.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec161"/>There's more…</h2></div></div></div><p>We can define more instances of <code class="literal">file_line</code> and add more lines to the file; we can have multiple resources modifying a single file.</p><p>Modify the <code class="literal">oneline.pp</code> file <a id="id310" class="indexterm"/>and <a id="id311" class="indexterm"/>add another <code class="literal">file_line</code> resource:</p><div class="informalexample"><pre class="programlisting">  file {'/tmp/cookbook':
    ensure =&gt; 'file',
  }
  file_line {'cookbook-hello':
    path    =&gt; '/tmp/cookbook',
    line    =&gt; 'Hello World!',
    require =&gt; File['/tmp/cookbook'],
  }
  file_line {'cookbook-goodbye':
    path    =&gt; '/tmp/cookbook',
    line    =&gt; 'So long, and thanks for all the fish.',
    require =&gt; File['/tmp/cookbook'],
  }</pre></div><p>Now apply the manifest again and verify whether the new line is appended to the file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ puppet apply oneline.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for mylaptop in environment production in 0.36 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/File_line[cookbook-goodbye]/ensure: created</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/cookbook </strong></span>
<span class="strong"><strong>Hello World!</strong></span>
<span class="strong"><strong>So long, and thanks for all the fish.</strong></span>
</pre></div><p>The <code class="literal">file_line</code> type also supports pattern matching and line removal as we'll show you in the following example:</p><div class="informalexample"><pre class="programlisting">  file {'/tmp/cookbook':
    ensure =&gt; 'file',
  }
  file_line {'cookbook-remove':
    ensure  =&gt; 'absent',
    path    =&gt; '/tmp/cookbook',
    line    =&gt; 'Hello World!',
    require =&gt; File['/tmp/cookbook'],
  }
  file_line {'cookbook-match':
    path    =&gt; '/tmp/cookbook',
    line    =&gt; 'Oh freddled gruntbuggly, thanks for all the fish.',
    match   =&gt; 'fish.$',
    require =&gt; File['/tmp/cookbook'],
  }</pre></div><p>Verify the<a id="id312" class="indexterm"/> contents <a id="id313" class="indexterm"/>of <code class="literal">/tmp/cookbook</code> before your Puppet run:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/cookbook </strong></span>
<span class="strong"><strong>Hello World!</strong></span>
<span class="strong"><strong>So long, and thanks for all the fish.</strong></span>
</pre></div><p>Apply the updated manifest:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ puppet apply oneline.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for mylaptop in environment production in 0.30 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/File_line[cookbook-match]/ensure: created</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/File_line[cookbook-remove]/ensure: removed</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
</pre></div><p>Verify that the line has been removed and the goodbye line has been replaced:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/cookbook </strong></span>
<span class="strong"><strong>Oh freddled gruntbuggly, thanks for all the fish.</strong></span>
</pre></div><p>Editing files with <code class="literal">file_line</code> works well if the file is unstructured. Structured files may have similar lines in different sections that have different meanings. In the next section, we'll show you how <a id="id314" class="indexterm"/>to deal <a id="id315" class="indexterm"/>with one particular type of structured file, a file using<a id="id316" class="indexterm"/> <span class="strong"><strong>INI syntax</strong></span>.</p></div></div>
<div class="section" title="Editing INI style files with puppetlabs-inifile"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec60"/>Editing INI style files with puppetlabs-inifile</h1></div></div></div><p>INI files are used throughout many systems, Puppet uses INI syntax for the <code class="literal">puppet.conf</code> file. The <code class="literal">puppetlabs-inifile</code> module creates two types, <code class="literal">ini_setting</code> and <code class="literal">ini_subsetting</code>, which can be used to edit INI style files.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec162"/>Getting ready</h2></div></div></div><p>Install the <a id="id317" class="indexterm"/>module from the forge as <a id="id318" class="indexterm"/>follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~ $ puppet module install puppetlabs-inifile</strong></span>
<span class="strong"><strong>Notice: Preparing to install into /home/tuphill/.puppet/modules ...</strong></span>
<span class="strong"><strong>Notice: Downloading from https://forgeapi.puppetlabs.com ...</strong></span>
<span class="strong"><strong>Notice: Installing -- do not interrupt ...</strong></span>
<span class="strong"><strong>/home/tuphill/.puppet/modules</strong></span>
<span class="strong"><strong>└── puppetlabs-inifile (v1.1.3)</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec163"/>How to do it...</h2></div></div></div><p>In this example, we will create a <code class="literal">/tmp/server.conf</code> file and ensure that the <code class="literal">server_true</code> setting is set in that file:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an <code class="literal">initest.pp</code> manifest with the following contents:<div class="informalexample"><pre class="programlisting">  ini_setting {'server_true':
    path    =&gt; '/tmp/server.conf',
    section =&gt; 'main',
    setting =&gt; 'server',
    value   =&gt; 'true',
  }</pre></div></li><li class="listitem">Apply the manifest:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ puppet apply initest.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for burnaby in environment production in 0.14 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Ini_setting[server_true]/ensure: created</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
</pre></div></li><li class="listitem">Verify the contents of the <code class="literal">/tmp/server.conf</code> file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/server.conf </strong></span>

<span class="strong"><strong>[main]</strong></span>
<span class="strong"><strong>server = true</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec164"/>How it works...</h2></div></div></div><p>The <code class="literal">inifile</code> module defines two types, <code class="literal">ini_setting</code> and <code class="literal">ini_subsetting</code>. Our manifest defines an <code class="literal">ini_setting</code> resource that creates a server = true setting within <a id="id319" class="indexterm"/>the main section of the <code class="literal">ini</code> file. In our case, the file <a id="id320" class="indexterm"/>didn't exist, so Puppet created the file, then created the <code class="literal">main</code> section, and finally added the setting to the <code class="literal">main</code> section.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec165"/>There's more...</h2></div></div></div><p>Using <code class="literal">ini_subsetting</code>, you can have <a id="id321" class="indexterm"/>several resources added to a setting. For instance, our <code class="literal">server.conf</code> file has a server's line, we could have each node append its own hostname to a server's line. Add the following to the end of the <code class="literal">initest.pp</code> file:</p><div class="informalexample"><pre class="programlisting">  ini_subsetting {'server_name':
    path    =&gt; '/tmp/server.conf',
    section =&gt; 'main',
    setting =&gt; 'server_host',
    subsetting =&gt; "$hostname",
  }</pre></div><p>Apply the manifest:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ puppet apply initest.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for mylaptop in environment production in 0.34 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Ini_subsetting[server_name]/ensure: created</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/server.conf </strong></span>
<span class="strong"><strong>[main]</strong></span>
<span class="strong"><strong>server = true</strong></span>
<span class="strong"><strong>server_host = mylaptop</strong></span>
</pre></div><p>Now temporarily change your hostname and rerun Puppet:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ sudo hostname inihost</strong></span>
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ puppet apply initest.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for inihost in environment production in 0.43 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Ini_subsetting[server_name]/ensure: created</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
<span class="strong"><strong>t@mylaptop ~/.puppet/manifests $ cat /tmp/server.conf </strong></span>
<span class="strong"><strong>[main]</strong></span>
<span class="strong"><strong>server = true</strong></span>
<span class="strong"><strong>server_host = mylaptop inihost</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>When working with INI syntax files, using the <code class="literal">inifile</code> module is an excellent choice.</p></div></div><p>If your configuration files are not in <a id="id322" class="indexterm"/>INI syntax, another tool, Augeas, can be used. In the following section, we will use <code class="literal">augeas</code> to modify files.</p></div></div>
<div class="section" title="Using Augeas to reliably edit config files"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec61"/>Using Augeas to reliably edit config files</h1></div></div></div><p>Sometimes it seems like every application has its own subtly different config file format, and writing regular expressions to parse and modify all of them can be a tiresome business.</p><p>Thankfully, Augeas<a id="id323" class="indexterm"/> is here to help. Augeas is a system <a id="id324" class="indexterm"/>that aims to simplify working with different config file formats by presenting them all as a simple tree of values. Puppet's Augeas support allows you to create <code class="literal">augeas</code> resources that can make the required config changes intelligently and automatically.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec166"/>How to do it…</h2></div></div></div><p>Follow these steps to create an example <code class="literal">augeas</code> resource:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Modify your <code class="literal">base</code> module as follows:<div class="informalexample"><pre class="programlisting">  class base {
    augeas { 'enable-ip-forwarding':
      incl    =&gt; '/etc/sysctl.conf',
      lens    =&gt; 'Sysctl.lns',
      changes =&gt; ['set net.ipv4.ip_forward 1'],
    }
  }</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1412130479'</strong></span>
<span class="strong"><strong>Notice: Augeas[enable-ip-forwarding](provider=augeas): </strong></span>
<span class="strong"><strong>--- /etc/sysctl.conf	2014-09-04 03:41:09.000000000 -0400</strong></span>
<span class="strong"><strong>+++ /etc/sysctl.conf.augnew	2014-09-30 22:28:03.503000039 -0400</strong></span>
<span class="strong"><strong>@@ -4,7 +4,7 @@</strong></span>
<span class="strong"><strong> # sysctl.conf(5) for more details.</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Controls IP packet forwarding</strong></span>
<span class="strong"><strong>-net.ipv4.ip_forward = 0</strong></span>
<span class="strong"><strong>+net.ipv4.ip_forward = 1</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> # Controls source route verification</strong></span>
<span class="strong"><strong> net.ipv4.conf.default.rp_filter = 1</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Base/Augeas[enable-ip-forwarding]/returns: executed successfully</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 2.27 seconds</strong></span>
</pre></div></li><li class="listitem">Check whether the setting has been correctly applied:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# sysctl -p |grep ip_forward</strong></span>
<span class="strong"><strong>net.ipv4.ip_forward = 1</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec167"/>How it works…</h2></div></div></div><p>We declare an <code class="literal">augeas</code> <a id="id325" class="indexterm"/>resource named <code class="literal">enable-ip-forwarding</code>:</p><div class="informalexample"><pre class="programlisting">augeas { 'enable-ip-forwarding':</pre></div><p>We specify that we want to make changes in the file <code class="literal">/etc/sysctl.conf</code>:</p><div class="informalexample"><pre class="programlisting">incl =&gt; '/etc/sysctl.conf',</pre></div><p>Next we specify the<a id="id326" class="indexterm"/> lens to use on this file. Augeas uses files called lenses to translate a configuration file into an object representation. Augeas ships with several lenses, they are located in <code class="literal">/usr/share/augeas/lenses</code> by default. When specifying the lens in an <code class="literal">augeas</code> resource, the name of the lens is capitalized and has the <code class="literal">.lns</code> suffix. In this case, we will specify the <code class="literal">Sysctl</code> lens as follows:</p><div class="informalexample"><pre class="programlisting">lens =&gt; 'Sysctl.lns',</pre></div><p>The <code class="literal">changes</code> parameter specifies the changes we want to make. Its value is an array, because we can supply several changes at once. In this example, there is only change, so the value is an array of one element:</p><div class="informalexample"><pre class="programlisting">changes =&gt; ['set net.ipv4.ip_forward 1'],</pre></div><p>In general, Augeas changes take the following form:</p><div class="informalexample"><pre class="programlisting">set &lt;parameter&gt; &lt;value&gt;</pre></div><p>In this case, the setting will be translated into a line like this in <code class="literal">/etc/sysctl.conf</code>:</p><div class="informalexample"><pre class="programlisting">net.ipv4.ip_forward=1</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec168"/>There's more…</h2></div></div></div><p>I've chosen <code class="literal">/etc/sysctl.conf</code> as the example because it can contain a wide variety of kernel settings and you may want to change these settings for all sorts of different purposes and in different Puppet classes. You might want to enable IP forwarding, as in the example, for a router class but you might also want to tune the value of <code class="literal">net.core.somaxconn</code> for a load-balancer class.</p><p>This means that simply puppetizing the <code class="literal">/etc/sysctl.conf</code> file and distributing it as a text file won't work because you might have several different and conflicting versions depending on the setting you want to modify. Augeas is the right solution here because you can define <code class="literal">augeas</code> resources in different places, which modify the same file and they won't conflict.</p><p>For more information about using Puppet and <a id="id327" class="indexterm"/>Augeas, see the page on the Puppet Labs website <a class="ulink" href="http://projects.puppetlabs.com/projects/1/wiki/Puppet_Augeas">http://projects.puppetlabs.com/projects/1/wiki/Puppet_Augeas</a>.</p><p>Another project that uses Augeas is<a id="id328" class="indexterm"/> <span class="strong"><strong>Augeasproviders</strong></span>. Augeasproviders uses Augeas to define several types. One of these types is <code class="literal">sysctl</code>, using this type you can make sysctl changes without knowing how to write the changes in Augeas. More information is <a id="id329" class="indexterm"/>available on the forge at <a class="ulink" href="https://forge.puppetlabs.com/domcleal/augeasproviders">https://forge.puppetlabs.com/domcleal/augeasproviders</a>.</p><p>Learning how to use Augeas can be a little confusing at first. Augeas provides a command line tool, <code class="literal">augtool</code>, which can be used to get acquainted with making changes in Augeas.</p></div></div>
<div class="section" title="Building config files using snippets"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec62"/>Building config files using snippets</h1></div></div></div><p>Sometimes you<a id="id330" class="indexterm"/> can't deploy a whole config file in one piece, yet <a id="id331" class="indexterm"/>making line by line edits isn't enough. Often, you need to build a config file from various bits of configuration managed by different classes. You may run into a situation where local information needs to be imported into the file as well. In this example, we'll build a config file using a local file as well as snippets defined in our manifests.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec169"/>Getting ready</h2></div></div></div><p>Although it's possible to create our own system to build files from pieces, we'll use the puppetlabs supported <code class="literal">concat</code> module. We will start by installing the <code class="literal">concat</code> module, in a previous example we installed the module to our local machine. In this example, we'll modify the Puppet server configuration and download the module to the Puppet server.</p><p>In your Git repository create an <code class="literal">environment.conf</code> file with the following contents:</p><div class="informalexample"><pre class="programlisting">modulepath = public:modules
manifest = manifests/site.pp</pre></div><p>Create the public directory and download the module into that directory as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ mkdir public &amp;&amp; cd public</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet/public $ puppet module install puppetlabs-concat --modulepath=.</strong></span>
<span class="strong"><strong>Notice: Preparing to install into /home/thomas/puppet/public ...</strong></span>
<span class="strong"><strong>Notice: Downloading from https://forgeapi.puppetlabs.com ...</strong></span>
<span class="strong"><strong>Notice: Installing -- do not interrupt ...</strong></span>
<span class="strong"><strong>/home/thomas/puppet/public</strong></span>
<span class="strong"><strong>└─┬ puppetlabs-concat (v1.1.1)</strong></span>
<span class="strong"><strong>  └── puppetlabs-stdlib (v4.3.2)</strong></span>
</pre></div><p>Now add the new modules to our Git repository:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet/public $ git add .</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet/public $ git commit -m "adding concat"</strong></span>
<span class="strong"><strong>[production 50c6fca] adding concat</strong></span>
<span class="strong"><strong> 407 files changed, 20089 insertions(+)</strong></span>
</pre></div><p>Then push to our Git server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet/public $ git push origin production</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec170"/>How to do it...</h2></div></div></div><p>Now that we have<a id="id332" class="indexterm"/> the <code class="literal">concat</code> module available on <a id="id333" class="indexterm"/>our server, we can create a <code class="literal">concat</code> container resource in our <code class="literal">base</code> module:</p><div class="informalexample"><pre class="programlisting">  concat {'hosts.allow':
    path =&gt; '/etc/hosts.allow',
    mode =&gt; 0644
  }</pre></div><p>Create a <code class="literal">concat::fragment</code> module for the header of the new file:</p><div class="informalexample"><pre class="programlisting">  concat::fragment {'hosts.allow header':
    target  =&gt; 'hosts.allow',
    content =&gt; "# File managed by puppet\n",
    order   =&gt; '01'
  }</pre></div><p>Create a <code class="literal">concat::fragment</code> that includes a local file:</p><div class="informalexample"><pre class="programlisting">  concat::fragment {'hosts.allow local':
    target =&gt; 'hosts.allow',
    source =&gt; '/etc/hosts.allow.local',
    order  =&gt; '10',
  }</pre></div><p>Create a <code class="literal">concat::fragment</code> module that will go at the end of the file:</p><div class="informalexample"><pre class="programlisting">  concat::fragment {'hosts.allow tftp':
    target  =&gt; 'hosts.allow',
    content =&gt; "in.ftpd: .example.com\n",
    order   =&gt; '50',
  }</pre></div><p>On the node, create <code class="literal">/etc/hosts.allow.local</code> with the following contents:</p><div class="informalexample"><pre class="programlisting">  in.tftpd: .example.com</pre></div><p>Run Puppet to have the file created:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook.example.com</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1412138600'</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Base/Concat[hosts.allow]/File[hosts.allow]/ensure: defined content as '{md5}b151c8bbc32c505f1c4a98b487f7d249'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.29 seconds</strong></span>
</pre></div><p>Verify the contents of the new file as:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# cat /etc/hosts.allow</strong></span>
<span class="strong"><strong># File managed by puppet</strong></span>
<span class="strong"><strong>in.tftpd: .example.com</strong></span>
<span class="strong"><strong>in.ftpd: .example.com</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec171"/>How it works...</h2></div></div></div><p>The <code class="literal">concat</code> resource defines <a id="id334" class="indexterm"/>a container that will hold all the<a id="id335" class="indexterm"/> subsequent <code class="literal">concat::fragment</code> resources. Each <code class="literal">concat::fragment</code> resource references the <code class="literal">concat</code> resource as the target. Each <code class="literal">concat::fragment</code> also includes an <code class="literal">order</code> attribute. The <code class="literal">order</code> attribute is used to specify the order in which the fragments are added to the final file. Our <code class="literal">/etc/hosts.allow</code> file is built with the header line, the contents of the local file, and finally the <code class="literal">in.tftpd</code> line we defined.</p></div></div>
<div class="section" title="Using ERB templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec63"/>Using ERB templates</h1></div></div></div><p>While you can deploy <a id="id336" class="indexterm"/>config files easily with Puppet as simple text files, templates are much more powerful. A template file can do calculations, execute Ruby code, or reference the values of variables from your Puppet manifests. Anywhere you might deploy a text file using Puppet, you can use a template instead.</p><p>In the simplest case, a template can just be a static text file. More usefully, you can insert variables into it using the ERB (embedded Ruby) syntax. For example:</p><div class="informalexample"><pre class="programlisting">  &lt;%= @name %&gt;, this is a very large drink.</pre></div><p>If the template is used in a context where the variable <code class="literal">$name</code> contains <code class="literal">Zaphod Beeblebrox</code>, the template will evaluate to:</p><div class="informalexample"><pre class="programlisting">  Zaphod Beeblebrox, this is a very large drink.</pre></div><p>This simple technique is very useful to generate lots of files that only differ in the values of one or two variables, for example, virtual hosts, and for inserting values into a script such as database names and passwords.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec172"/>How to do it…</h2></div></div></div><p>In this example, we'll use an ERB template to insert a password into a backup script:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the file <code class="literal">modules/admin/templates/backup-mysql.sh.erb</code> with the following contents:<div class="informalexample"><pre class="programlisting">#!/bin/sh
/usr/bin/mysqldump -uroot \ -p&lt;%= @mysql_password %&gt; \ --all-databases | \ /bin/gzip &gt; /backup/mysql/all-databases.sql.gz</pre></div></li><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">node 'cookbook' {
  $mysql_password = 'secret'
  file { '/usr/local/bin/backup-mysql':
    content =&gt; template('admin/backup-mysql.sh.erb'),
    mode    =&gt; '0755',
  }
}</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook.example.com</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1412140971'</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Node[cookbook]/File[/usr/local/bin/backup-mysql]/ensure: defined content as '{md5}c12af56559ef36529975d568ff52dca5'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.31 seconds</strong></span>
</pre></div></li><li class="listitem">Check whether Puppet has correctly inserted the password into the template:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# cat /usr/local/bin/backup-mysql </strong></span>
<span class="strong"><strong>#!/bin/sh</strong></span>
<span class="strong"><strong>/usr/bin/mysqldump -uroot \</strong></span>
<span class="strong"><strong>  -psecret \</strong></span>
<span class="strong"><strong>  --all-databases | \</strong></span>
<span class="strong"><strong>  /bin/gzip &gt; /backup/mysql/all-databases.sql.gz</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec173"/>How it works…</h2></div></div></div><p>Wherever a variable is <a id="id337" class="indexterm"/>referenced in the template, for example <code class="literal">&lt;%= @mysql_password %&gt;</code>, Puppet will replace it with the corresponding value, <code class="literal">secret</code>.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec174"/>There's more…</h2></div></div></div><p>In the example, we only used one variable in the template, but you can have as many as you like. These can also be facts:</p><div class="informalexample"><pre class="programlisting">ServerName &lt;%= @fqdn %&gt;</pre></div><p>Or Ruby expressions:</p><div class="informalexample"><pre class="programlisting">MAILTO=&lt;%= @emails.join(',') %&gt;</pre></div><p>Or any Ruby code you want:</p><div class="informalexample"><pre class="programlisting">ServerAdmin &lt;%= @sitedomain == 'coldcomfort.com' ? 'seth@coldcomfort.com' : 'flora@poste.com' %&gt;</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec175"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using GnuPG to encrypt secrets</em></span> recipe in this chapter</li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://docs.puppetlabs.com/guides/templating.html">https://docs.puppetlabs.com/guides/templating.html</a></li></ul></div></div></div>
<div class="section" title="Using array iteration in templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec64"/>Using array iteration in templates</h1></div></div></div><p>In the <a id="id338" class="indexterm"/>previous example, we saw that you can use Ruby to interpolate <a id="id339" class="indexterm"/>different values in templates depending on the result of an expression. But you're not limited to getting one value at a time. You can put lots of them in a Puppet array and then have the template generate some content for each element of the array using a loop.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec176"/>How to do it…</h2></div></div></div><p>Follow these steps to build an example of iterating over arrays:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">  node 'cookbook' {
    $ipaddresses = ['192.168.0.1', '158.43.128.1', '10.0.75.207' ]
    file { '/tmp/addresslist.txt':
      content =&gt; template('base/addresslist.erb')
    }
  }</pre></div></li><li class="listitem">Create the file <code class="literal">modules/base/templates/addresslist.erb</code> with the following contents:<div class="informalexample"><pre class="programlisting">&lt;% @ipaddresses.each do |ip| -%&gt;
IP address &lt;%= ip %&gt; is present
&lt;% end -%&gt;</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook.example.com</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1412141917'</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Node[cookbook]/File[/tmp/addresslist.txt]/ensure: defined content as '{md5}073851229d7b2843830024afb2b3902d'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.30 seconds</strong></span>
</pre></div></li><li class="listitem">Check the contents of the generated file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# cat /tmp/addresslist.txt </strong></span>
<span class="strong"><strong>  IP address 192.168.0.1 is present.</strong></span>
<span class="strong"><strong>  IP address 158.43.128.1 is present.</strong></span>
<span class="strong"><strong>  IP address 10.0.75.207 is present.</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec177"/>How it works…</h2></div></div></div><p>In the first line of the<a id="id340" class="indexterm"/> template, we reference the array <code class="literal">ipaddresses</code>, and<a id="id341" class="indexterm"/> call its <code class="literal">each</code> method:</p><div class="informalexample"><pre class="programlisting">&lt;% @ipaddresses.each do |ip| -%&gt;</pre></div><p>In Ruby, this creates a loop that will execute once for each element of the array. Each time round the loop, the variable <code class="literal">ip</code> will be set to the value of the current element.</p><p>In our example, the <code class="literal">ipaddresses</code> array contains three elements, so the following line will be executed three times, once for each element:</p><div class="informalexample"><pre class="programlisting">IP address &lt;%= ip %&gt; is present.</pre></div><p>This will result in three output lines:</p><div class="informalexample"><pre class="programlisting">IP address 192.168.0.1 is present.
IP address 158.43.128.1 is present.
IP address 10.0.75.207 is present.</pre></div><p>The final line <a id="id342" class="indexterm"/>ends the loop:</p><div class="informalexample"><pre class="programlisting">&lt;% end -%&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>Note that the first and last lines end with <code class="literal">-%&gt;</code> instead of just <code class="literal">%&gt;</code> as we saw before. The effect of the <code class="literal">-</code> is to suppress the new line that would otherwise be generated on each pass through the loop, giving us unwanted blank lines in the file.</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec178"/>There's more…</h2></div></div></div><p>Templates can also iterate <a id="id343" class="indexterm"/>over hashes, or arrays of hashes:</p><div class="informalexample"><pre class="programlisting">$interfaces = [ {name =&gt; 'eth0', ip =&gt; '192.168.0.1'},
  {name =&gt; 'eth1', ip =&gt; '158.43.128.1'},
  {name =&gt; 'eth2', ip =&gt; '10.0.75.207'} ]

&lt;% @interfaces.each do |interface| -%&gt;
Interface &lt;%= interface['name'] %&gt; has the address &lt;%= interface['ip'] %&gt;.
&lt;% end -%&gt;

Interface eth0 has the address 192.168.0.1.
Interface eth1 has the address 158.43.128.1.
Interface eth2 has the address 10.0.75.207.</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec179"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using ERB templates</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using EPP templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec65"/>Using EPP templates</h1></div></div></div><p>EPP templates are a new feature in Puppet 3.5 and newer versions. EPP templates use a syntax similar to ERB templates but are not compiled through Ruby. Two new functions are defined to call EPP <a id="id344" class="indexterm"/>templates, <code class="literal">epp</code>, and <code class="literal">inline_epp</code>. These functions are the EPP equivalents of the ERB functions <code class="literal">template</code> and <code class="literal">inline_template</code>, respectively. The main difference with EPP templates is that variables are referenced using the Puppet notation, <code class="literal">$variable</code> instead of <code class="literal">@variable</code>.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec180"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an EPP template in <code class="literal">~/puppet/epp-test.epp</code> with the following content:<div class="informalexample"><pre class="programlisting">This is &lt;%= $message %&gt;.</pre></div></li><li class="listitem">Create an <code class="literal">epp.pp</code> manifest, which uses the <code class="literal">epp</code> and <code class="literal">inline_epp</code> functions:<div class="informalexample"><pre class="programlisting">$message = "the message"
file {'/tmp/epp-test':
  content =&gt; epp('/home/thomas/puppet/epp-test.epp')
}
notify {inline_epp('Also prints &lt;%= $message %&gt;'):}</pre></div></li><li class="listitem">Apply the manifest making sure to use the future parser (the future parser is required for the <code class="literal">epp</code> and <code class="literal">inline_epp</code> functions to be defined):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ puppet apply epp.pp --parser=future</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for mylaptop in environment production in 1.03 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/File[/tmp/epp-test]/ensure: defined content as '{md5}999ccc2507d79d50fae0775d69b63b8c'</strong></span>
<span class="strong"><strong>Notice: Also prints the message</strong></span>
</pre></div></li><li class="listitem">Verify that the template worked as intended: <div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ cat /tmp/epp-test </strong></span>
<span class="strong"><strong>This is the message.</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec181"/>How it works...</h2></div></div></div><p>Using the future parser, the <code class="literal">epp</code> and <code class="literal">inline_epp</code> functions are defined. The main difference between EPP templates and ERB templates is that variables are referenced in the same way they are within Puppet manifests.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec182"/>There's more...</h2></div></div></div><p>Both <code class="literal">epp</code> and <code class="literal">inline_epp</code> allow<a id="id345" class="indexterm"/> for variables <a id="id346" class="indexterm"/>to be overridden within the function call. A second parameter to the function call can be used to specify values for variables used within the scope of the function call. For example, we can override the value of <code class="literal">$message</code> with the following code:</p><div class="informalexample"><pre class="programlisting">file {'/tmp/epp-test':
  content =&gt; epp('/home/tuphill/puppet/epp-test.epp',
    { 'message' =&gt; "override $message"} )
}
notify {inline_epp('Also prints &lt;%= $message %&gt;',
  { 'message' =&gt; "inline override $message"}):}</pre></div><p>Now when we run Puppet and verify the output we see that the value of <code class="literal">$message</code> has been overridden:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ puppet apply epp.pp --parser=future</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for mylaptop.pan.costco.com in environment production in 0.85 seconds</strong></span>
<span class="strong"><strong>Notice: Also prints inline override the message</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.05 seconds</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ cat /tmp/epp-test </strong></span>
<span class="strong"><strong>This is override the message.</strong></span>
</pre></div></div></div>
<div class="section" title="Using GnuPG to encrypt secrets"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec66"/>Using GnuPG to encrypt secrets</h1></div></div></div><p>We often need Puppet to have access to secret information, such as passwords or crypto keys, for it to configure systems properly. But how do you avoid putting such secrets directly into your Puppet code, where they're visible to anyone who has read access to your repository?</p><p>It's a common requirement for third-party developers and contractors to be able to make changes via Puppet, but they definitely shouldn't see any confidential information. Similarly, if you're using a distributed Puppet setup like that described in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span>, every machine has a copy of the whole repo, including secrets for other machines that it doesn't need and shouldn't have. How can we prevent this?</p><p>One answer is to encrypt the secrets using the <a id="id347" class="indexterm"/>
<span class="strong"><strong>GnuPG</strong></span> tool, so that any secret information in the Puppet repo is undecipherable (for all practical purposes) without the appropriate key. Then we distribute the key securely to the people or machines that need it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec183"/>Getting ready</h2></div></div></div><p>First you'll need an<a id="id348" class="indexterm"/> encryption key, so follow these steps to <a id="id349" class="indexterm"/>generate one. If you already have a GnuPG key that you'd like to use, go on to the next section. To complete this section, you will need to install the gpg command:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use <code class="literal">puppet</code> resource to install gpg:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># puppet resource package gnupg ensure=installed</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>You may need to use gnupg2 as the package name, depending on your target OS.</p></div></div></li><li class="listitem">Run the following <a id="id350" class="indexterm"/>command. Answer the prompts as<a id="id351" class="indexterm"/> shown, except to substitute your name and e-mail address for mine. When prompted for a passphrase, just hit <span class="emphasis"><em>Enter</em></span>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ gpg --gen-key</strong></span>
<span class="strong"><strong>gpg (GnuPG) 1.4.18; Copyright (C) 2014 Free Software Foundation, Inc.</strong></span>
<span class="strong"><strong>This is free software: you are free to change and redistribute it.</strong></span>
<span class="strong"><strong>There is NO WARRANTY, to the extent permitted by law.</strong></span>
<span class="strong"><strong>Please select what kind of key you want:</strong></span>
<span class="strong"><strong>   (1) RSA and RSA (default)</strong></span>
<span class="strong"><strong>   (2) DSA and Elgamal</strong></span>
<span class="strong"><strong>   (3) DSA (sign only)</strong></span>
<span class="strong"><strong>   (4) RSA (sign only)</strong></span>
<span class="strong"><strong>Your selection? 1</strong></span>
<span class="strong"><strong>RSA keys may be between 1024 and 4096 bits long.</strong></span>
<span class="strong"><strong>What keysize do you want? (2048) 2048</strong></span>
<span class="strong"><strong>Requested keysize is 2048 bits</strong></span>
<span class="strong"><strong>Please specify how long the key should be valid.</strong></span>
<span class="strong"><strong>         0 = key does not expire</strong></span>
<span class="strong"><strong>      &lt;n&gt;  = key expires in n days</strong></span>
<span class="strong"><strong>      &lt;n&gt;w = key expires in n weeks</strong></span>
<span class="strong"><strong>      &lt;n&gt;m = key expires in n months</strong></span>
<span class="strong"><strong>      &lt;n&gt;y = key expires in n years</strong></span>
<span class="strong"><strong>Key is valid for? (0) 0</strong></span>
<span class="strong"><strong>Key does not expire at all</strong></span>
<span class="strong"><strong>Is this correct? (y/N) y</strong></span>
<span class="strong"><strong>You need a user ID to identify your key; the software constructs the user ID</strong></span>
<span class="strong"><strong>from the Real Name, Comment and Email Address in this form:</strong></span>
<span class="strong"><strong>    "Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;"</strong></span>

<span class="strong"><strong>Real name: Thomas Uphill</strong></span>
<span class="strong"><strong>Email address: thomas@narrabilis.com</strong></span>
<span class="strong"><strong>Comment: &lt;enter&gt;</strong></span>
<span class="strong"><strong>You selected this USER-ID:</strong></span>
<span class="strong"><strong>    "Thomas Uphill &lt;thomas@narrabilis.com&gt;"</strong></span>

<span class="strong"><strong>Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o</strong></span>
<span class="strong"><strong>You need a Passphrase to protect your secret key.</strong></span>
</pre></div><p>Hit enter twice here to have an empty passphrase</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>You don't want a passphrase - this is probably a *bad* idea!</strong></span>
<span class="strong"><strong>I will do it anyway.  You can change your passphrase at any time,</strong></span>
<span class="strong"><strong>using this program with the option "--edit-key".</strong></span>

<span class="strong"><strong>gpg: key F1C1EE49 marked as ultimately trusted</strong></span>
<span class="strong"><strong>public and secret key created and signed.</strong></span>

<span class="strong"><strong>gpg: checking the trustdb</strong></span>
<span class="strong"><strong>gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</strong></span>
<span class="strong"><strong>gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</strong></span>
<span class="strong"><strong>pub   2048R/F1C1EE49 2014-10-01</strong></span>
<span class="strong"><strong>      Key fingerprint = 461A CB4C 397F 06A7 FB82  3BAD 63CF 50D8 F1C1 EE49</strong></span>
<span class="strong"><strong>uid                  Thomas Uphill &lt;thomas@narrabilis.com&gt;</strong></span>
<span class="strong"><strong>sub   2048R/E2440023 2014-10-01</strong></span>
</pre></div></li><li class="listitem">You may see a<a id="id352" class="indexterm"/> message like this if your system is <a id="id353" class="indexterm"/>not configured with a source of randomness:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>We need to generate a lot of random bytes. It is a good idea to perform</strong></span>
<span class="strong"><strong>some other action (type on the keyboard, move the mouse, utilize the</strong></span>
<span class="strong"><strong>disks) during the prime generation; this gives the random number</strong></span>
<span class="strong"><strong>generator a better chance to gain enough entropy.</strong></span>
</pre></div></li><li class="listitem">In this case, install and start a random number generator daemon such as <code class="literal">haveged</code> or <code class="literal">rng-tools</code>. Copy the gpg key you just created into the <code class="literal">puppet</code> user's account on your Puppet master:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~ $ scp -r .gnupg puppet@puppet.example.com:</strong></span>
<span class="strong"><strong>gpg.conf                                      100% 7680     7.5KB/s   00:00    </strong></span>
<span class="strong"><strong>random_seed                                   100%  600     0.6KB/s   00:00    </strong></span>
<span class="strong"><strong>pubring.gpg                                   100% 1196     1.2KB/s   00:00    </strong></span>
<span class="strong"><strong>secring.gpg                                   100% 2498     2.4KB/s   00:00    </strong></span>
<span class="strong"><strong>trustdb.gpg                                   100% 1280     1.3KB/s   00:00</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec184"/>How to do it...</h2></div></div></div><p>With your encryption key<a id="id354" class="indexterm"/> installed on the <code class="literal">puppet</code> user's<a id="id355" class="indexterm"/> keyring (the key generation process described in the previous section will do this for you), you're ready to set up Puppet to decrypt secrets.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the following directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/puppet$ mkdir -p modules/admin/lib/puppet/parser/functions</strong></span>
</pre></div></li><li class="listitem">Create the file <code class="literal">modules/admin/lib/puppet/parser/functions/secret.rb</code> with the following contents:<div class="informalexample"><pre class="programlisting">module Puppet::Parser::Functions
  newfunction(:secret, :type =&gt; :rvalue) do |args|
    'gpg --no-tty -d #{args[0]}'
  end
end</pre></div></li><li class="listitem">Create the file <code class="literal">secret_message</code> with the following contents:<div class="informalexample"><pre class="programlisting">For a moment, nothing happened.
Then, after a second or so, nothing continued to happen.</pre></div></li><li class="listitem">Encrypt this file with the following command (use the e-mail address you supplied when creating the GnuPG key):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ gpg -e -r thomas@narrabilis.com secret_message</strong></span>
</pre></div></li><li class="listitem">Move the resulting encrypted file into your Puppet repo:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop:~/puppet$ mv secret_message.gpg modules/admin/files/</strong></span>
</pre></div></li><li class="listitem">Remove the original (plaintext) file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop:~/puppet$ rm secret_message</strong></span>
</pre></div></li><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">node 'cookbook' {
  $message = secret('/etc/puppet/environments/production/ modules/admin/files/secret_message.gpg')
  notify { "The secret message is: ${message}": }
}</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook.example.com</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1412145910'</strong></span>
<span class="strong"><strong>Notice: The secret message is: For a moment, nothing happened. </strong></span>
<span class="strong"><strong>Then, after a second or so, nothing continued to happen.</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.27 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec185"/>How it works...</h2></div></div></div><p>First, we've created a <a id="id356" class="indexterm"/>custom function to allow Puppet to decrypt<a id="id357" class="indexterm"/> the secret files using GnuPG:</p><div class="informalexample"><pre class="programlisting">module Puppet::Parser::Functions
  newfunction(:secret, :type =&gt; :rvalue) do |args|
    'gpg --no-tty -d #{args[0]}'
  end
end</pre></div><p>The preceding code creates a function named <code class="literal">secret</code> that takes a file path as an argument and returns the decrypted text. It doesn't manage encryption keys so you need to ensure that the <code class="literal">puppet</code> user has the necessary key installed. You can check this with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>puppet@puppet:~ $ gpg --list-secret-keys</strong></span>
<span class="strong"><strong>/var/lib/puppet/.gnupg/secring.gpg</strong></span>
<span class="strong"><strong>----------------------------------</strong></span>
<span class="strong"><strong>sec   2048R/F1C1EE49 2014-10-01</strong></span>
<span class="strong"><strong>uid                  Thomas Uphill &lt;thomas@narrabilis.com&gt;</strong></span>
<span class="strong"><strong>ssb   2048R/E2440023 2014-10-01</strong></span>
</pre></div><p>Having set up the <code class="literal">secret</code> function and the required key, we now encrypt a message to this key:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>tuphill@mylaptop ~/puppet $ gpg -e -r thomas@narrabilis.com secret_message</strong></span>
</pre></div><p>This creates an encrypted file that can only be read by someone with access to the secret key (or Puppet running on a machine that has the secret key).</p><p>We then call the <code class="literal">secret</code> function to decrypt this file and get the contents:</p><div class="informalexample"><pre class="programlisting">$message = secret(' /etc/puppet/environments/production/modules/admin/files/secret_message.gpg')</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec186"/>There's more...</h2></div></div></div><p>You should use the<a id="id358" class="indexterm"/> <code class="literal">secret</code> function, or something like it, to protect any confidential data in your Puppet repo: passwords, AWS credentials, license keys, even other secret keys such as SSL host keys.</p><p>You may decide to use a single key, which you push to machines as they're built, perhaps as part of a bootstrap process like that described in the <span class="emphasis"><em>Bootstrapping Puppet with Bash</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span>. For even greater security, you might like to create a new key for each machine, or group of machines, and encrypt a given secret only for the machines that need it.</p><p>For example, your web servers might need a certain secret that you don't want to be accessible on any other machine. You could create a key for web servers, and encrypt the data only for this key.</p><p>If you want to use encrypted data with Hiera, there is a GnuPG backend<a id="id359" class="indexterm"/> for Hiera available at <a class="ulink" href="http://www.craigdunn.org/2011/10/secret-variables-in-puppet-with-hiera-and-gpg/">http://www.craigdunn.org/2011/10/secret-variables-in-puppet-with-hiera-and-gpg/</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec187"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Configuring Hiera</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Storing secret data with hiera-gpg</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span></li></ul></div></div></div>
<div class="section" title="Installing packages from a third-party repository"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec67"/>Installing packages from a third-party repository</h1></div></div></div><p>Most often you <a id="id360" class="indexterm"/>will want to install packages from <a id="id361" class="indexterm"/>the main distribution repo, so a simple package resource will do:</p><div class="informalexample"><pre class="programlisting">package { 'exim4': ensure =&gt; installed }</pre></div><p>Sometimes, you need a package that is only found in a third-party repository (an Ubuntu PPA, for example), or it might be that you need a more recent version of a package than that provided by the distribution, which is available from a third party.</p><p>On a manually-administered machine, you would normally do this by adding the repo source configuration to <code class="literal">/etc/apt/sources.list.d</code> (and, if necessary, a gpg key for the repo) before installing the package. We can automate this process easily with Puppet.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec188"/>How to do it…</h2></div></div></div><p>In this example, we'll use<a id="id362" class="indexterm"/> the popular Percona APT repo (Percona<a id="id363" class="indexterm"/> is a MySQL consulting firm who maintain and release their own<a id="id364" class="indexterm"/> specialized version of <a id="id365" class="indexterm"/>MySQL, more information is available at <a class="ulink" href="http://www.percona.com/software/repositories">http://www.percona.com/software/repositories</a>):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the file <code class="literal">modules/admin/manifests/percona_repo.pp</code> with the following contents:<div class="informalexample"><pre class="programlisting"># Install Percona APT repo
class admin::percona_repo {
  exec { 'add-percona-apt-key':
    unless  =&gt; '/usr/bin/apt-key list |grep percona',
    command =&gt; '/usr/bin/gpg --keyserver hkp://keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A &amp;&amp; /usr/bin/gpg -a --export CD2EFD2A | apt-key add -',
    notify  =&gt; Exec['percona-apt-update'],
  }

  exec { 'percona-apt-update':
    command     =&gt; '/usr/bin/apt-get update',
    require     =&gt; [File['/etc/apt/sources.list.d/percona.list'],
File['/etc/apt/preferences.d/00percona.pref']],
    refreshonly =&gt; true,
  }

  file { '/etc/apt/sources.list.d/percona.list':
    content =&gt; 'deb http://repo.percona.com/apt wheezy main',
    notify  =&gt; Exec['percona-apt-update'],
  }

  file { '/etc/apt/preferences.d/00percona.pref':
    content =&gt; "Package: *\nPin: release o=Percona
    Development Team\nPin-Priority: 1001",
    notify  =&gt; Exec['percona-apt-update'],
  }
}</pre></div></li><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">node 'cookbook' {
  include admin::percona_repo

  package { 'percona-server-server-5.5':
    ensure  =&gt; installed,
    require =&gt; Class['admin::percona_repo'],
  }
}</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@cookbook-deb:~# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook-deb</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Admin::Percona_repo/Exec[add-percona-apt-key]/returns: executed successfully</strong></span>
<span class="strong"><strong>Info: /Stage[main]/Admin::Percona_repo/Exec[add-percona-apt-key]: Scheduling refresh of Exec[percona-apt-update]</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Admin::Percona_repo/File[/etc/apt/sources.list.d/percona.list]/ensure: defined content as '{md5}b8d479374497255804ffbf0a7bcdf6c2'</strong></span>
<span class="strong"><strong>Info: /Stage[main]/Admin::Percona_repo/File[/etc/apt/sources.list.d/percona.list]: Scheduling refresh of Exec[percona-apt-update]</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Admin::Percona_repo/File[/etc/apt/preferences.d/00percona.pref]/ensure: defined content as '{md5}1d8ca6c1e752308a9bd3018713e2d1ad'</strong></span>
<span class="strong"><strong>Info: /Stage[main]/Admin::Percona_repo/File[/etc/apt/preferences.d/00percona.pref]: Scheduling refresh of Exec[percona-apt-update]</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Admin::Percona_repo/Exec[percona-apt-update]: Triggered 'refresh' from 3 events</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec189"/>How it works…</h2></div></div></div><p>In order to install any<a id="id366" class="indexterm"/> Percona package, we first need <a id="id367" class="indexterm"/>to have the repository configuration installed on the machine. This is why the <code class="literal">percona-server-server-5.5</code> package (Percona's version of the standard MySQL server) requires the <code class="literal">admin::percona_repo</code> class:</p><div class="informalexample"><pre class="programlisting">package { 'percona-server-server-5.5':
  ensure  =&gt; installed,
  require =&gt; Class['admin::percona_repo'],
}</pre></div><p>So, what does the <code class="literal">admin::percona_repo</code> class do? It:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installs the Percona APT key with which the packages are signed</li><li class="listitem" style="list-style-type: disc">Configures the Percona repo URL as a file in <code class="literal">/etc/apt/sources.list.d</code></li><li class="listitem" style="list-style-type: disc">Runs <code class="literal">apt-get update</code> to retrieve the repo metadata</li><li class="listitem" style="list-style-type: disc">Adds an APT pin configuration in <code class="literal">/etc/apt/preferences.d</code></li></ul></div><p>First of all, we install the APT key:</p><div class="informalexample"><pre class="programlisting">exec { 'add-percona-apt-key':
  unless  =&gt; '/usr/bin/apt-key list |grep percona',
  command =&gt; '/usr/bin/gpg --keyserver  hkp://keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A &amp;&amp; /usr/bin/gpg -a --export CD2EFD2A | apt-key add -',
  notify  =&gt; Exec['percona-apt-update'],
}</pre></div><p>The <code class="literal">unless</code> parameter checks <a id="id368" class="indexterm"/>the output of <code class="literal">apt-key list</code> to<a id="id369" class="indexterm"/> make sure that the Percona key is not already installed, in which case we need not do anything. Assuming it isn't, the <code class="literal">command</code> runs:</p><div class="informalexample"><pre class="programlisting">/usr/bin/gpg --keyserver  hkp://keys.gnupg.net --recv-keys 1C4CBDCDCD2EFD2A &amp;&amp; /usr/bin/gpg -a --export CD2EFD2A | apt-key add -</pre></div><p>This command retrieves the key from the GnuPG keyserver, exports it in the ASCII format, and pipes this into the <code class="literal">apt-key add</code> command, which adds it to the system keyring. You can use a similar pattern for most third-party repos that require an APT signing key.</p><p>Having installed the key, we add the repo configuration:</p><div class="informalexample"><pre class="programlisting">file { '/etc/apt/sources.list.d/percona.list':
  content =&gt; 'deb http://repo.percona.com/apt wheezy main',
  notify  =&gt; Exec['percona-apt-update'],
}</pre></div><p>Then run <code class="literal">apt-get update</code> to update the system's APT cache with the metadata from the new repo:</p><div class="informalexample"><pre class="programlisting">exec { 'percona-apt-update':
  command     =&gt; '/usr/bin/apt-get update',
  require     =&gt; [File['/etc/apt/sources.list.d/percona.list'], File['/etc/apt/preferences.d/00percona.pref']],
  refreshonly =&gt; true,
}</pre></div><p>Finally, we configure the APT pin priority for the repo:</p><div class="informalexample"><pre class="programlisting">file { '/etc/apt/preferences.d/00percona.pref':
  content =&gt; "Package: *\nPin: release o=Percona Development Team\nPin-Priority: 1001",
  notify  =&gt; Exec['percona-apt-update'],
}</pre></div><p>This ensures that packages <a id="id370" class="indexterm"/>installed from the Percona <a id="id371" class="indexterm"/>repo will never be superseded by packages from somewhere else (the main Ubuntu distro, for example). Otherwise, you could end up with broken dependencies and be unable to install the Percona packages automatically.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec190"/>There's more...</h2></div></div></div><p>The APT package framework is specific to the Debian and Ubuntu systems. There is a forge module<a id="id372" class="indexterm"/> for managing apt repos, <a class="ulink" href="https://forge.puppetlabs.com/puppetlabs/apt">https://forge.puppetlabs.com/puppetlabs/apt</a>. If you're on a Red Hat or CentOS-based system, you can use the <code class="literal">yumrepo</code> resources<a id="id373" class="indexterm"/> to manage RPM repositories directly:</p><p>
<a class="ulink" href="http://docs.puppetlabs.com/references/latest/type.html#yumrepo">http://docs.puppetlabs.com/references/latest/type.html#yumrepo</a>
</p></div></div>
<div class="section" title="Comparing package versions"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec68"/>Comparing package versions</h1></div></div></div><p>Package version numbers <a id="id374" class="indexterm"/>are odd things. They look like decimal numbers, but they're not: a version number is often in the form of <code class="literal">2.6.4</code>, for example. If you need to compare one version number with another, you can't do a straightforward string comparison: <code class="literal">2.6.4</code> would be interpreted as greater than <code class="literal">2.6.12</code>. And a numeric comparison won't work because they're not valid numbers.</p><p>Puppet's <code class="literal">versioncmp</code> function<a id="id375" class="indexterm"/> comes to the rescue. If you pass two things that look like version numbers, it will compare them and return a value indicating which is greater:</p><div class="informalexample"><pre class="programlisting">versioncmp( A, B )</pre></div><p>returns:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">0 if A and B are equal</li><li class="listitem" style="list-style-type: disc">Greater than 1 if A is higher than B</li><li class="listitem" style="list-style-type: disc">Less than 0 if A is less than B</li></ul></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec191"/>How to do it…</h2></div></div></div><p>Here's an example using the <code class="literal">versioncmp</code> function:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">node 'cookbook' {
  $app_version = '1.2.2'
  $min_version = '1.2.10'
	
  if versioncmp($app_version, $min_version) &gt;= 0 {
    notify { 'Version OK': }
  } else {
    notify { 'Upgrade needed': }
  }
}</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook.example.com</strong></span>
<span class="strong"><strong>Notice: Upgrade needed</strong></span>
</pre></div></li><li class="listitem">Now change the value of <code class="literal">$app_version</code>:<div class="informalexample"><pre class="programlisting">$app_version = '1.2.14'</pre></div></li><li class="listitem">Run <a id="id376" class="indexterm"/>Puppet again:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@cookbook ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook.example.com</strong></span>
<span class="strong"><strong>Notice: Version OK</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec192"/>How it works…</h2></div></div></div><p>We've specified that the minimum acceptable version (<code class="literal">$min_version</code>) is <code class="literal">1.2.10</code>. So, in the first example, we want to compare it with <code class="literal">$app_version</code> of <code class="literal">1.2.2</code>. A simple alphabetic comparison of these two strings (in Ruby, for example) would give the wrong result, but <code class="literal">versioncmp</code> correctly determines that <code class="literal">1.2.2</code> is less than <code class="literal">1.2.10</code> and alerts us that we need to upgrade.</p><p>In the second example, <code class="literal">$app_version</code> is now <code class="literal">1.2.14</code>, which <code class="literal">versioncmp</code> correctly recognizes as greater than <code class="literal">$min_version</code> and so we get the message <span class="strong"><strong>Version OK</strong></span>.</p></div></div></body></html>