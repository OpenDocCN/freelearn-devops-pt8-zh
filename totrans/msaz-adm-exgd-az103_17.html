<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Implementing Azure Load Balancer</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we covered the fourth part of the <span><em>Deploying and Managing Virtual Networks</em><em> </em>objective</span><span>. We've covered</span> <strong>Network Security Groups</strong> (<strong>NSGs</strong>) <span>and Azure DNS. You also learned how to create and configure NSGs and how to set up and configure Azure DNS.</span></p>
<p><span>This chapter covers the fifth and final part of this</span><em><span> </span></em><span>objective, by covering how to configure internal and external load balancers using <strong>Azure Load Balancer</strong>. In this chapter, we are going to focus on the features and capabilities of Azure Load Balancer. You will learn how to configure an internal load balancer and how to create health probes and configure load balancing rules. This chapter will finish by covering how you can configure a public load balancer.</span></p>
<p><span>The following topics will be covered in this chapter:</span></p>
<ul>
<li>Azure Load Balancer</li>
<li>Configuring an internal l<span>oad balancer</span></li>
<li>Creating health probes</li>
<li>Creating load balancing rules</li>
<li>Configuring a public l<span>oad balancer</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>The source code for this chapter can be downloaded from the GitHub repository at <a href="https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter13">https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter13</a>.<a href="https://github.com/PacktPublishing/Microsoft-Azure-Integration-and-Security-Exam-Guide-AZ-101/tree/master/Chapter07"/></p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Azure Load Balancer</h1>
                </header>
            
            <article>
                
<p>Azure Load Balancer is a l<span>oad balancer</span> that operates at the transport layer <span>(Layer 4 </span><span>in the OSI network reference stack</span><span>). Azure Load Balancer supports the <strong>Transmission Control Protocol</strong> (<strong>TCP</strong>) and <strong>User Datagram Protocol</strong> (<strong>UDP</strong>) and it can be used to load-balance traffic to your VMs. It provides high throughput and low latency, it can scale up to millions of flows, and it supports various inbound and outbound scenarios.</span></p>
<p>Azure Load Balancer can be used for the following:</p>
<ul>
<li><strong>Public</strong> <strong>Load Balance</strong>r: Incoming internet traffic is load balanced to VMs. </li>
<li><strong>Internal Load Balancer</strong>: Traffic can be load balanced across VMs inside a virtual network. You can use it in a hybrid scenario as well, where it reaches a <span>Load Balancer</span> inside an on-premises network.</li>
<li><strong>Port forwarding</strong>: You can forward traffic to specific ports on specific VMs using inbound <strong>Network Address Translation</strong><span> </span>(<strong>NAT</strong>) rules.</li>
<li><strong>Outbound connectivity</strong>: You can also provide outbound connectivity for VMs inside a virtual network using it on Azure Load Balancer as a public l<span>oad balancer</span>.</li>
</ul>
<p>Azure Load Balancer offers the following features and capabilities:</p>
<ul>
<li><strong>Load balancing</strong>: Traffic can be distributed from a frontend pool to a backend pool using rules. Azure Load Balancer uses a five-tuple hash by default, which is composed of the source IP address, source port, destination IP address, destination ports, and the IP protocol number to map flows to the available servers in the backend pool. </li>
<li><strong>Port forwarding</strong>: Inbound NAT rules can be created to forward traffic from a specific port of the frontend IP address of the l<span>oad balancer</span> to a specific port of a backend instance inside an Azure Virtual Network. Therefore, the same hash-based distribution is used as for load balancing. This can be used for the <strong>Remote Desktop Protocol</strong><span> </span>(<strong>RDP</strong>) and<span> </span><strong>Secure Shell</strong><span> </span>(<strong>SSH</strong>) sessions to VMs inside the VNet. Multiple internal endpoints can be mapped to various ports on the same frontend IP address. The VMs can be remotely administered using the frontend IP address. This way, an additional jump box is not needed.</li>
<li><strong>Automatic reconfiguration</strong>: The l<span>oad balancer</span> will automatically reconfigure itself when instances are scaled up or down. There is no need for additional operations on the l<span>oad balancer</span> when VMs are added or removed from the backend pool.</li>
<li><strong>Health probes</strong>: Azure Load Balancer uses health probes to determine the health on the VMs in the backend pool. The l<span>oad balancer</span> will stop sending new connections to an instance when a probe fails to respond. There are different health probes provided for HTTP, HTTPS, and TCP endpoints.</li>
<li><strong>Outbound connections</strong> (<strong>SNAT</strong>): Outbound connections are automatically translated to the public frontend IP address of the l<span>oad balancer</span>.</li>
</ul>
<p>Azure Load Balancer comes in two different pricing tiers:</p>
<ul>
<li><strong>Basic</strong>: <span>The Basic Balancer is free to use. It has the following capabilities:</span>
<ul>
<li><span><strong>Backend pool size</strong>: </span>The Basic tier supports up to 100 instances inside a backend pool.</li>
<li><strong>Health probes</strong>: TCP and HTTP.</li>
<li><span><strong>Availability zones</strong></span>: Not a<span>vailable.</span></li>
<li><strong>Outbound connections</strong>: A single frontend is supported, which is selected at random when multiple frontends are configured. The default<span> <strong>Source</strong> <strong>Network Address Translation</strong> (</span><strong>SNAT</strong>)<span> </span>is used when there is only an internal l<span>oad balancer</span> that is serving a VM, VM scale set, or availability set.</li>
<li><strong>Outbound rules</strong>: Not available.</li>
<li><span><strong>Diagnostics</strong></span>: Supp<span>ort for Azure Log Analytics for a public load balancer only, backend pool health count, and SNAT exhaustion alert.</span></li>
<li><strong>HA Ports</strong>: No<span>t available.</span></li>
<li><span><strong>Secure by default</strong></span>: Open b<span>y default; NSGs are optional.</span></li>
<li><strong>TCP Reset on Idle</strong>: Not ava<span>ilable.</span></li>
<li><strong>Multiple frontends</strong>: No<span>t available.</span></li>
<li><span><strong>Management Operations</strong></span>: 60-<span>90+ seconds.</span></li>
<li><strong>SLA</strong>: Not available.</li>
</ul>
</li>
<li><strong>Standard</strong>: You are charged for using the Standard tier of the Azure Load Balancer. The charge is based on <span>the number of rules and the data that is associated with the resource and are processed inbound and outbound:</span>
<ul>
<li><span><strong>B</strong></span><span><strong>ackend</strong></span><span><strong> </strong></span><span><strong>pool size</strong>: </span><span>The standard tier supports up to 1,000 instances inside a backend pool.</span></li>
<li><strong>Health probes</strong>: TCP, HTTP, and HTTPS.</li>
<li><span><strong>Availability Zones</strong></span>: Su<span><span>pport for zone-redundant and zonal frontends for inbound and outbound connections and cross-zone load balancing.</span></span></li>
<li><strong>Outbound connections</strong>: Multiple frontends can be used per load<span> </span><span>balancing rule opt-out</span>. Pool-based outbound NAT can be<span> </span><span>explicitly </span>defined using<span> </span>outbound rules. Outbound scenarios must<span> </span><span>be explicitly created to use outbound connectivity for the VM, VM scale set, or availability set. Virtual network service endpoints can be reached without defining outbound connectivity. Public IP addresses and <strong>Platform as a Service</strong> (<strong>PaaS</strong>), that are not available using VNet service endpoints, must be reached with outbound connectivity.</span></li>
<li><strong>Outbound rules</strong>: Outbound NAT configuration needs to be defined using public IP addresses, public IP prefixes, or both. You can configure the outbound idle timeout as well as custom SNAT port allocation.</li>
<li><span><strong>Diagnostics</strong></span>: Azure Load Balancer has s<span>upport for Azure Monitor, with features including health probe status, outbound connection health (SNAT successful and failed flows), multi-dimensional metrics, and active data plane measurements.</span></li>
<li><strong>HA Ports</strong>: Highly<span> </span><span>available ports for the internal load balancer only.</span></li>
<li><span><strong>Secure by default</strong></span>: Unless<span> </span><span>internal load balancers are whitelisted by an NSG, the endpoints are closed to inbound flows by default. Public IP addresses and load balancer endpoints are secured as well.</span></li>
<li><strong>TCP Reset on Idle</strong>: This can be enabled on the idle timeout on any rule.</li>
<li><strong>Multiple frontends</strong>: For inbound and outbound connections.</li>
<li><span><strong>Management operations</strong></span>: &lt; 3<span>0 seconds for most operatio</span><span>ns</span><span>.</span></li>
<li><span><strong>SLA</strong></span>: 99<span>.99% for a data path with two healthy virtual machines.</span></li>
</ul>
</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring an internal load balancer</h1>
                </header>
            
            <article>
                
<p>In this demonstration, we are going to create and configure a l<span>oad balancer</span> from the Azure portal. We are going to route internal traffic with a basic l<span>oad balancer</span> to spread incoming requests to multiple virtual machines. For this demonstration, we are going to create a l<span>oad balancer</span>, <span>backend servers, and network resources at the Basic pricing tier.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the VNet</h1>
                </header>
            
            <article>
                
<p>First, we are going to create the VNet, backend servers, and a test VM. To do this, take the following steps:</p>
<ol>
<li>Navigate to the Azure portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.<a href="https://portal.azure.com/"/></li>
<li>In the left menu, select<span> </span><span class="packt_screen">Create a resource</span><span> </span>| <span class="packt_screen">Networking</span>, and then select <span class="packt_screen">Virtual Network.</span></li>
<li>Add the following values:<br/>
<ul>
<li><strong>Name</strong>: <kbd>PacktLBVnet</kbd></li>
<li><strong>Address space</strong>: <kbd>172.16.0.0/16</kbd></li>
<li><strong>Subscription</strong>: Select a subscription</li>
<li><strong>Resource group</strong>: Create a new one and call it <strong>PacktLoadBalancer</strong></li>
<li><strong>Location</strong>: <span class="packt_screen">East US</span></li>
<li><strong>Subnet name</strong>: <kbd>PacktLBBackendSubnet</kbd></li>
<li><strong>Subnet address range</strong>: <kbd>172.16.0.0/24</kbd></li>
<li><strong>DDoS protection</strong>: <span class="packt_screen">Basic</span></li>
<li><strong>Service endpoints</strong>: <span class="packt_screen">Disabled</span></li>
<li><strong>Firewall</strong>: <span class="packt_screen">Disabled</span>:</li>
</ul>
</li>
</ol>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="assets/9eb90c4f-2de4-4f01-afa5-005bb2dc4783.png" style="width:19.25em;height:48.58em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>VNet settings</span></div>
<ol start="4">
<li>Click <span class="packt_screen">Create.</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign packt_figref"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the VMs</h1>
                </header>
            
            <article>
                
<p>The next step is to create the VMs that are used inside the backend pool and for testing. To do this, take the following steps:</p>
<ol>
<li>To create the VMs, select <strong><span class="packt_screen">Create a resource</span></strong><span> </span>in the left menu, and then select <span class="packt_screen">Compute</span><span> </span>and then <span class="packt_screen">Windows Server 2016 Datacenter</span>.</li>
<li>In the <span class="packt_screen">Create a virtual machine</span><span> </span>blade on the<span> </span><span class="packt_screen">Basic</span><span> </span>tab, fill in the following values:
<ul>
<li><span class="packt_screen">Subscription: <span>Select a subscription</span><br/>
Resource group</span>:<span> </span><kbd>PacktLoadBalancer</kbd><span> </span>(which is created in the previous step).</li>
<li><span class="packt_screen">Virtual machine name</span>: <kbd>PacktLBVM1</kbd>.</li>
<li><span class="packt_screen">Region</span>:<span> </span><span class="packt_screen">East US</span>.</li>
<li><span class="packt_screen">Availability options</span>: Select<span> </span><span class="packt_screen">Avail</span><span class="packt_screen">ability</span> <strong><span class="packt_screen">set</span></strong><span> </span>and create a new one named<span> </span><kbd>PacktLBAvailabilitySet</kbd>. Leave the default domain and update the domain settings.</li>
<li><span class="packt_screen">Image</span>: <span class="packt_screen">Windows Server 2016 Datacenter.</span></li>
<li><span class="packt_screen">Size</span>: <span class="packt_screen">Standard DS1 v2.</span></li>
<li><strong>Credentials</strong>: Specify a username and password for the VM. </li>
<li><span class="packt_screen">Public inbound ports</span>:<span> </span><span class="packt_screen">Allow selected ports</span> | select<span> </span><span class="packt_screen">RDP (3389)</span>.</li>
</ul>
</li>
<li>Select the <span class="packt_screen">Networking</span><span> </span>tab and select the virtual network that we created in the previous step with the subnet, and fill in the following values:<br/>
<ul>
<li><span class="packt_screen">NIC<span> </span>network security group</span>: Select<span> </span><strong><span class="packt_screen">Advanced</span></strong><span> </span>and create a new network security group. Keep the default name for the new network security group.</li>
</ul>
</li>
<li><span>Select the </span><strong><span class="packt_screen">Management</span></strong><span> tab. </span><span>Under </span><strong><span class="packt_screen">Monitoring</span></strong><span>, set </span><strong><span class="packt_screen">Boot diagnostics</span></strong><span> to </span><strong><span class="packt_screen">Off</span></strong><span>.</span></li>
<li>Click the<span> </span><span class="packt_screen">Review + create</span><span> </span>button to create the VM.</li>
<li>Repeat the preceding steps to create a second VM called <kbd>PacktLBVM2</kbd><span> </span><span>and a third VM called</span><span> </span><kbd>PacktLBVMTest</kbd><span> </span><span>using the same settings, and place them in the same subscription, resource group, Availability Set and the same network security group.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the load balancer</h1>
                </header>
            
            <article>
                
<p>Now we can create the l<span>oad balancer</span> as follows:</p>
<ol>
<li>To create the basic load balancer, in the top menu, select <span class="packt_screen">Create a resource</span><span> | </span><span class="packt_screen">Networking</span><span> | </span><span class="packt_screen">Load Balancer</span><span>.</span></li>
<li>Add the following values:
<ul>
<li><strong><span>Subscription</span>:</strong> Pick a subscription</li>
<li><span class="packt_screen">Resource<span> </span>group</span>:<span> </span><kbd>PacktLoadBalancer</kbd>.</li>
<li><span class="packt_screen">Name</span>:<span> </span><kbd>PacktLoadBalancer</kbd>.</li>
<li><span class="packt_screen">Region</span>:<span> </span><span class="packt_screen">East US</span>.</li>
<li><span class="packt_screen">Type</span>:<span> </span><span class="packt_screen">Internal</span>.</li>
<li><span class="packt_screen">SKU</span>: <span class="packt_screen">Basic</span>.</li>
<li><span class="packt_screen">Virtual Network</span>:<span> </span>Select<span> </span><kbd>PacktLBVNet</kbd>.</li>
<li><span class="packt_screen">Subnet</span><span>: Select</span> <kbd>PacktLBBackendSubnet</kbd>.</li>
<li><span class="packt_screen">IP address assignment</span>:<span> </span><span class="packt_screen">Static</span>.</li>
<li><span class="packt_screen">Private IP address:</span> P<span>rovide an IP address that is in the address space of your virtual network and subnet, such as <kbd>172.16.0.7</kbd>.</span></li>
</ul>
</li>
</ol>
<ol start="3">
<li>Click<span> </span><span class="packt_screen">Review + Create</span><span><span class="packt_screen">. Then click Create</span></span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/f8a8a6f7-a348-486e-b1ad-f45dd8151243.png" style="width:44.58em;height:46.75em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Creating the load balancer</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a backend address pool</h1>
                </header>
            
            <article>
                
<p>Now, the VMs and the Azure Load Balancer instance have been created and the networking is configured, so it is time to create the backend pool, which is used by the l<span>oad balancer</span> to distribute the traffic to the VMs. The backend pool consists of the IP addresses of the <strong>Network Interface Cards</strong><span> </span>(<strong>NICs</strong>).</p>
<p>We are going to create a backend pool with <span><kbd>PacktLBVM1</kbd> and <kbd>PacktLBVM2</kbd> in it:</span></p>
<ol>
<li>Open the l<span>oad balancer</span> resource that we created in the previous step inside the Azure portal.</li>
<li class="CDPAlignLeft CDPAlign">Under<span> </span><span class="packt_screen">Settings</span>, select <span class="packt_screen">Backend pools</span>, and then click the <span class="packt_screen">Add</span><span> </span>button:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/590a2165-4bb5-4272-82d3-80bdb5dc00d2.png"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Creating the backend pool</span></div>
<ol start="3">
<li>Add the following values:
<ul>
<li><span class="packt_screen">Name</span>:<span> </span><kbd>P<span>acktLBBackendPool</span></kbd><span>.</span></li>
<li><span class="packt_screen">Associated to</span>: Select<span> </span><strong>Availability set</strong>.</li>
<li><span class="packt_screen">Availability set</span>: Select<span> </span><kbd>PacktLBAvailabilitySet</kbd>.</li>
<li><span>Select </span><span class="packt_screen">Add a target network IP configuration</span><span> </span>and add<span> </span><kbd>PacktLBVM1</kbd><span> </span>and <span><kbd>PacktLBVM2</kbd> to the backend pool.</span></li>
</ul>
</li>
</ol>
<ol start="4">
<li>Click<span> </span><span class="packt_screen">OK</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4c2fa7f4-f2ec-4e8d-a10a-85080520ba88.png" style="width:37.25em;height:45.58em;"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Adding the VMs to the backend pool</span></div>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating health probes</h1>
                </header>
            
            <article>
                
<p>The next step is to create a health probe for the l<span>oad balancer</span>. The health probe is used for the l<span>oad balancer</span> to monitor the status of the VM. The probe will <span>dynamically add or remove VMs from the load balancer rotation, based on the response to the health checks that are performed by the health probe.</span></p>
<p>To create a health probe, take the following steps:</p>
<ol>
<li>Again, open the L<span>oad Balancer</span> resource.</li>
<li>Under<span> </span><span class="packt_screen">Settings</span>, select<span> </span><span class="packt_screen">Health probes</span>, and then select<span> </span><span class="packt_screen">Add</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ca460c19-c5af-480d-a024-c04424ec0401.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating a new health probe</div>
<ol start="3">
<li>Add the following values:
<ul>
<li><span class="packt_screen">Name</span>:<span> </span><kbd>PacktHealthProbe</kbd>.</li>
<li><span class="packt_screen">Protocol</span>:<span class="packt_screen"> HTTP</span>.</li>
<li><span class="packt_screen">Port</span>:<span> </span><kbd>80</kbd>.</li>
<li><span class="packt_screen">Path</span>:<span> </span><kbd><em>/</em></kbd><em><em>.</em></em></li>
<li><span class="packt_screen">Interval</span>:<span class="packt_screen"> </span><kbd>15</kbd>—this is the number of seconds between probe attempts.</li>
<li><span class="packt_screen">Unhealthy threshold</span>:<span> </span><kbd>2</kbd><em>—</em>this value is the number of consecutive probe failures that occur before a VM is considered unhealthy.</li>
</ul>
</li>
<li>Click <span class="packt_screen">OK</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/1ff08521-5951-400a-a11e-06cf1316e641.png" style="width:35.92em;height:37.42em;"/></div>
<div style="text-align: center;color: black" class="packt_figref CDPAlignCenter CDPAlign">Health probe settings</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating load balancing rules</h1>
                </header>
            
            <article>
                
<p>Load balancing rules define how the traffic is distributed to the VMs inside the backend pool. When you create a new rule, you define the <span>frontend IP configuration for incoming traffic, the</span> <span>bac</span><span>kend</span> <span>IP pool that receives the traffic, and the required source and destination ports.</span></p>
<p>The rule that we are going to create listens to port<span> </span><kbd>80</kbd><span> </span>at the frontend. The rule then sends the network traffic to the backend pool, also on port<span> </span><kbd>80</kbd>.</p>
<p>To create the rule, take the following steps:</p>
<ol>
<li>Again, open the <span>Load Balancer</span> resource.</li>
<li>Under<span> </span><span class="packt_screen">Settings</span>, <span>select</span><span> </span><span class="packt_screen">Load balancing rules</span>, <span>and then select</span><span> </span><span class="packt_screen">Add</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/bf27a893-3d2c-416a-b56d-c62f4b92fc71.png"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Creating a new rule</span></div>
<ol start="3">
<li>Add the following values:
<ul>
<li><span class="packt_screen">Name</span>:<span> </span><kbd>PacktLoadBalancerRule</kbd></li>
<li><span class="packt_screen">Frontend IP address</span>:<span> </span><kbd>LoadBalancerFrontEnd</kbd></li>
<li><span class="packt_screen">Protocol</span>: <span class="packt_screen">TCP</span></li>
<li><span class="packt_screen">Port</span>:<span> </span><kbd><kbd>80</kbd></kbd></li>
<li><span class="packt_screen">Backend port</span>:<span> </span><kbd>80</kbd></li>
<li><span class="packt_screen">Backend pool</span>:<span> </span><kbd>PacktLBBackendPool</kbd></li>
<li><span class="packt_screen">Health probe</span>:<span> </span><kbd>PacktHealthProbe</kbd></li>
</ul>
</li>
<li>Click <span class="packt_screen">OK</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/096d4baa-5900-47d8-9d22-a6f9a95f11dd.png" style="width:34.83em;height:46.92em;"/></div>
<div class="CDPAlignCenter packt_figref CDPAlign">Configuring the rule<strong><br/></strong></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing the load balancer</h1>
                </header>
            
            <article>
                
<p>To test the VMs properly, we are going to install <span><strong>Internet Information Services</strong> (</span><strong>IIS</strong><span>)</span> on the<span> </span><span><kbd>PacktLBVM1</kbd> and <kbd>PacktLBVM2</kbd> VMs </span>using PowerShell. Then, we can use the <kbd>PacktLBVMTest</kbd><span> VM to test the load balancer by calling its private IP address.</span></p>
<p>First, we need to obtain the private IP address of the l<span>oad balancer</span>. Take the following steps:</p>
<ol>
<li>In the <span class="packt_screen">Overview</span> page of the l<span>oad balancer</span>, copy the private IP address as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3732d015-404a-476a-a495-d62180d9995a.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Obtaining the private IP address</div>
<ol start="2">
<li>Now, we need to connect to the <kbd>PacktLBVM1</kbd><span class="packt_screen"> </span><span>and <kbd>PacktLBVM2</kbd></span> <span>VM using an RDP session and install IIS and a testing web page on it. Connect to both the VMs, open the PowerShell console, and provide the following PowerShell script:<br/></span></li>
</ol>
<pre style="padding-left: 60px"># Install IIS<br/>  <strong>Install-WindowsFeature -name Web-Server -IncludeManagementTools</strong><br/><br/># Remove default htm file<br/> <strong>remove-item C:\inetpub\wwwroot\iisstart.htm</strong><br/><br/>#Add custom htm file<br/> <strong>Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)</strong></pre>
<ol start="3">
<li>Next, connect to the <kbd>PacktLBVMTest</kbd><span> VM using RDP as well, open a browser session, and navigate to the private IP address of the load balancer. Refresh the browser a couple of times to see the load balancer distributing the requests over the two VMs, as the following screenshot shows:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="assets/250069a7-a4b4-4aa6-96e7-980bab339db4.png"/><br/>
<br/>
Testing the l<span>oad balancer</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring a public load balancer</h1>
                </header>
            
            <article>
                
<p>In this section, we are going to create a public l<span>oad balancer</span> using the Azure CLI. You can copy the code snippets in Azure Cloud Shell, which is accessible from the Azure portal.</p>
<div class="packt_tip">The full script for creating the public l<span>oad balancer</span> can be downloaded from GitHub as well. Refer to the location specified under the <em>Technical requirements</em> section at the beginning of this chapter.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the load balancer</h1>
                </header>
            
            <article>
                
<p>To create the public l<span>oad balancer</span>, a series of steps need to be taken. In the upcoming sections, we will create the public l<span>oad balancer</span> with all the necessary components.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a resource group</h1>
                </header>
            
            <article>
                
<p>We start by creating a resource group for the l<span>oad balancer</span> and other resources as follows:</p>
<pre># Create a resource group<br/><strong>az group create \</strong><br/><strong> --name PacktResourceGroupSLB \</strong><br/><strong> --location eastus</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a public IP address</h1>
                </header>
            
            <article>
                
<p>Next, we are going to configure a public IP address for the l<span>oad balancer</span> to access it from the internet. A standard l<span>oad balancer</span> only supports s<span>tandard public IP addresses, as shown in the following code:</span></p>
<pre># Create a public IP address<br/><strong>az network public-ip create --resource-group PacktResourceGroupSLB --name PacktPublicIP --sku standard</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the load balancer</h1>
                </header>
            
            <article>
                
<p>In the following sections, we are going to create the load balancer and will create the components, including a frontend IP pool, backend IP pool, a health probe, and a load balancer rule.</p>
<p>To create the l<span>oad balancer</span>, add the following code:</p>
<pre># Create the <span>Load Balancer</span><br/><strong>az network lb create \</strong><br/><strong> --resource-group PacktResourceGroupSLB \</strong><br/><strong> --name PacktLoadBalancer \</strong><br/><strong> --sku standard</strong><br/><strong> --public-ip-address PacktPublicIP \</strong><br/><strong> --frontend-ip-name PacktFrontEnd \</strong><br/><strong> --backend-pool-name PacktBackEndPool</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the health probe</h1>
                </header>
            
            <article>
                
<p>All VM instances are checked by the health probe to define whether they are healthy enough to send network traffic to them. Virtual machine instances that are unhealthy are removed from the l<span>oad balancer</span> until the probe check determines that they are healthy again.</p>
<p>To create the health probe, add the following code:</p>
<pre>#Create the health probe<br/><strong>az network lb probe create \</strong><br/><strong>    --resource-group PacktResourceGroupSLB \</strong><br/><strong>    --lb-name PacktLoadBalancer \</strong><br/><strong>    --name PacktHealthProbe \</strong><br/><strong>    --protocol tcp \</strong><br/><strong>    --port 80</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the load balancer rule</h1>
                </header>
            
            <article>
                
<p>The l<span>oad balancer</span> rule defines the frontend IP configuration for the incoming traffic and the backend IP pool to receive the traffic, together with the required source and destination ports, as follows:</p>
<pre>#Create the Load Balancer rule<br/><strong>az network lb rule create \</strong><br/><strong> --resource-group PacktResourceGroupSLB \</strong><br/><strong> --lb-name PacktLoadBalancer \</strong><br/><strong> --name PacktHTTPRule \</strong><br/><strong> --protocol tcp \</strong><br/><strong> --frontend-port 80 \</strong><br/><strong> --backend-port 80 \</strong><br/><strong> --frontend-ip-name PacktFrontEnd \</strong><br/><strong> --backend-pool-name PacktBackEndPool \</strong><br/><strong> --probe-name PacktHealthProbe</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the virtual network</h1>
                </header>
            
            <article>
                
<p>We now need to create the virtual network to deploy the VMs too, with the following code:</p>
<pre>#Create a virtual network<br/><strong>az network vnet create \</strong><br/><strong>    --resource-group PacktResourceGroupSLB \</strong><br/><strong>    --location eastus \</strong><br/><strong>    --name PacktVnet \</strong><br/><strong>    --subnet-name PacktSubnet</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an NSG</h1>
                </header>
            
            <article>
                
<p>Next, we will create an NSG. It is a requirement for a standard l<span>oad balancer</span> that the VMs in the backend have NICs that are placed in an<span> </span><span>NSG. We need to create the NSG to define the inbound connections to the virtual network as follows:</span></p>
<pre><strong>az network nsg create \</strong><br/><strong>    --resource-group PacktResourceGroupSLB \</strong><br/><strong>    --name PacktNetworkSecurityGroup</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an NSG rule</h1>
                </header>
            
            <article>
                
<p>To allow inbound connections<span> </span><span>through port <kbd>80</kbd>, </span>create an NSG rule as follows:</p>
<pre>#Create a Network Security Group rule<br/><strong>az network nsg rule create \</strong><br/><strong>    --resource-group PacktResourceGroupSLB \</strong><br/><strong>    --nsg-name PacktNetworkSecurityGroup \</strong><br/><strong>    --name PacktNetworkSecurityGroupRuleHTTP \</strong><br/><strong>    --protocol tcp \</strong><br/><strong>    --direction inbound \</strong><br/><strong>    --source-address-prefix '*' \</strong><br/><strong>    --source-port-range '*' \</strong><br/><strong>    --destination-address-prefix '*' \</strong><br/><strong>    --destination-port-range 80 \</strong><br/><strong>    --access allow \</strong><br/><strong>    --priority 200</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating NICs</h1>
                </header>
            
            <article>
                
<p>We need to create two network interfaces and associate them with the NSG and the public IP address, as follows:</p>
<pre>#Create NICs<br/><strong>for i in `seq 1 2`; do</strong><br/><strong> az network nic create \</strong><br/><strong> --resource-group PacktResourceGroupSLB \</strong><br/><strong> --name PacktNic$i \</strong><br/><strong> --vnet-name PacktVnet \</strong><br/><strong> --subnet PacktSubnet \</strong><br/><strong> --network-security-group PacktNetworkSecurityGroup \</strong><br/><strong> --lb-name PacktLoadBalancer \</strong><br/><strong> --lb-address-pools PacktBackEndPool</strong><br/><strong>done</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating backend servers</h1>
                </header>
            
            <article>
                
<p>Next is creating the backend servers. We are going to create two VMs that are going to be used as backend servers for the l<span><span>oad balancer</span></span><span>. We are also going to install <strong>NGINX</strong> (which is an open source, </span><span>high-performance HTTP server, and reverse proxy) on it to test the l<span>oad balancer</span>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an availability set</h1>
                </header>
            
            <article>
                
<p>To create an availability set, add the following piece of code:</p>
<pre>#Create an Availability set<br/><strong>az vm availability-set create \</strong><br/><strong> --resource-group PacktResourceGroupSLB \</strong><br/><strong> --name PacktAvailabilitySet</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating two virtual machines</h1>
                </header>
            
            <article>
                
<p>We are going to create two VMs with NGINX installed on it. We are also going to create a <kbd>Hello World</kbd><span> Node.js app on the Linux virtual machines. For this, we need to create a file called </span><kbd>cloud-init.txt</kbd><span> </span><span>and paste the configuration in it. </span><span>The following <kbd>cloud-init</kbd> configuration installs </span><span>all the required packages, then creates the </span><kbd>Hello World</kbd><span> </span><span>app, and then starts the app. </span>To create the <kbd>cloud-init.txt</kbd><span> </span>file, add the following line:</p>
<pre><strong><span>sensible-editor cloud-init.txt</span></strong></pre>
<p>Select an editor and paste in the following configuration. First, add the packages:</p>
<pre>#cloud-config<br/><strong>package_upgrade: true</strong><br/><strong>packages:</strong><br/><strong>  - nginx</strong><br/><strong>  - nodejs</strong><br/><strong>  - npm</strong></pre>
<p>Then set up the server:</p>
<pre><strong>write_files:</strong><br/><strong>  - owner: www-data:www-data</strong><br/><strong>  - path: /etc/nginx/sites-available/default</strong><br/><strong>    content: |</strong><br/><strong>      server {</strong><br/><strong>        listen 80;</strong><br/><strong>        location / {</strong><br/><strong>          proxy_pass http://localhost:3000;</strong><br/><strong>          proxy_http_version 1.1;</strong><br/><strong>          proxy_set_header Upgrade $http_upgrade;</strong><br/><strong>          proxy_set_header Connection keep-alive;</strong><br/><strong>          proxy_set_header Host $host;</strong><br/><strong>          proxy_cache_bypass $http_upgrade;</strong><br/><strong>        }</strong><br/><strong>      }</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Next, create the app:</p>
<pre><strong>- owner: azureuser:azureuser</strong><br/><strong>  - path: /home/azureuser/myapp/index.js</strong><br/><strong>    content: |</strong><br/><strong>      var express = require('express')</strong><br/><strong>      var app = express()</strong><br/><strong>      var os = require('os');</strong><br/><strong>      app.get('/', function (req, res) {</strong><br/><strong>        res.send('Hello World from host ' + os.hostname() + '!')</strong><br/><strong>      })</strong><br/><strong>      app.listen(3000, function () {</strong><br/><strong>        console.log('Hello world app listening on port 3000!')</strong><br/><strong>      })</strong></pre>
<p>And, finally, run the app:</p>
<pre><strong>runcmd:</strong><br/><strong>  - service nginx restart</strong><br/><strong>  - cd "/home/azureuser/myapp"</strong><br/><strong>  - npm init</strong><br/><strong>  - npm install express -y</strong><br/><strong>  - nodejs index.js</strong></pre>
<p>With the above blocks of code, we now created the <span>cloud-</span>init.txt file for our VMs. save the file in the editor and exit it.  Now, we can continue with creating the two virtual machines and apply the configuration on it, as follows:</p>
<pre>#Create two virtual machines <br/><strong>for i in `seq 1 2`; do</strong><br/><strong> az vm create \</strong><br/><strong>   --resource-group PacktResourceGroupSLB \</strong><br/><strong>   --name myVM$i \</strong><br/><strong>   --availability-set PacktAvailabilitySet \</strong><br/><strong>   --nics PacktNic$i \</strong><br/><strong>   --image UbuntuLTS \</strong><br/><strong>   --generate-ssh-keys \</strong><br/><strong>   --custom-data cloud-init.txt \</strong><br/><strong>   --no-wait</strong><br/><strong>done</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing the load balancer</h1>
                </header>
            
            <article>
                
<p>To test the load balancer, we need to obtain the public IP address of it and paste this into a browser window. Wait for the VMs to be fully provisioned and running. You can check this in the Azure portal. Then, to obtain the public IP address, add the following line of code:</p>
<pre>#Obtain public IP address<br/><strong>az network public-ip show \</strong><br/><strong>    --resource-group PacktResourceGroupSLB \</strong><br/><strong>    --name PacktPublicIP \</strong><br/><strong>    --query [ipAddress] \</strong><br/><strong>    --output tsv</strong></pre>
<p>Paste the output of this line of code into your browser window to see the Azure Load Balancer in action:</p>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="assets/5932aeb6-6c51-4542-9552-b8fc914a690a.png" style="width:20.42em;height:9.00em;"/><br/>
<br/>
Testing the public load balancer</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we covered how to configure internal and external load balancers. You also learned how to configure load balancing rules and health probes.</span></p>
<p><span>In the next chapter, we will continue with the fifth part of <em>Deploying and Managing Virtual Networks</em> objective by covering how to integrate an on-premises network with an Azure Virtual Network.</span></p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</span></p>
<ol>
<li>Can a basic load balancer only be created from the Azure portal?
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
<li><span>Is it necessary for a standard load balancer that the VMs in the backend have NICs that are placed in an NSG?</span>
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>
<ol start="3">
<li>Does a standard load balancer needs a standard public IP address to function properly?<br/>
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that are covered in this chapter:</span></p>
<ul>
<li><em>Load Balancer</em>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/">https://docs.microsoft.com/en-us/azure/load-balancer/</a><a href="https://azure.microsoft.com/en-us/services/azure-migrate/"/></li>
<li><em>Quickstart: Create a load balancer to load balance VMs using Azure CLI</em>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-cli">https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-cli</a></li>
<li><em>Quickstart: Create a public load balancer using Azure PowerShell</em>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-powershell">https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-powershell</a></li>
<li><em>Quickstart: Create a Standard Load Balancer to load balance VMs using the Azure portal</em>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal">https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal</a></li>
<li><em>Quickstart: Create a Standard Load Balancer using Azure PowerShell</em>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-standard-load-balancer-powershell">https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-standard-load-balancer-powershell</a></li>
</ul>


            </article>

            
        </section>
    </body></html>