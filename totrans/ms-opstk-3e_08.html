<html><head></head><body>
  <div id="_idContainer165">
   <h1 class="chapter-number" id="_idParaDest-143">
    <a id="_idTextAnchor188">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     8
    </span>
   </h1>
   <h1 id="_idParaDest-144">
    <a id="_idTextAnchor189">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Monitoring and Logging – Remediating Proactively
    </span>
   </h1>
   <p class="author-quote">
    <span class="koboSpan" id="kobo.3.1">
     “To accept something on mere presumption and, likewise, to fail to investigate it may cover over, blind, and lead astray.”
    </span>
   </p>
   <p class="author-quote">
    <span class="koboSpan" id="kobo.4.1">
     – Abu Nasr Al Farabi
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.5.1">
     Monitoring the underlying infrastructure of the private cloud is an essential operational activity that requires consistent tools and automated ways to achieve real-time metrics collection and alerting mechanisms.
    </span>
    <span class="koboSpan" id="kobo.5.2">
     Among the different OpenStack releases, a variety of open-source and commercial tools exist to support the monitoring of different pieces of the OpenStack ecosystem.
    </span>
    <span class="koboSpan" id="kobo.5.3">
     In the latest releases, we can find more emerging tools with successful monitoring stories, offering more simplicity and easier integration into the OpenStack ecosystem.
    </span>
    <span class="koboSpan" id="kobo.5.4">
     Collecting metrics data is one part of OpenStack’s operational tasks; the other part is the log data.
    </span>
    <span class="koboSpan" id="kobo.5.5">
     Each OpenStack and shared service generates a load of log data with different logging levels, which, combined, would become a complicated task to manually parse and find anomalies when issues occur.
    </span>
    <span class="koboSpan" id="kobo.5.6">
     Having a robust logging pipeline is a requirement to satisfy one pillar of the OpenStack operational journey.
    </span>
    <span class="koboSpan" id="kobo.5.7">
     This chapter will combine both monitoring and logging practices with recent emerging tools that can be integrated into a running
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.6.1">
      OpenStack environment.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.7.1">
     We will discuss the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.8.1">
      following topics:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.9.1">
      Introducing Prometheus as a solution for the OpenStack infrastructure and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.10.1">
       workload monitoring
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.11.1">
      Deploying and integrating Prometheus in the current OpenStack deployment and starting to use a separate monitoring stack to expose
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.12.1">
       OpenStack metrics
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.13.1">
      Exploring, deploying, and building dashboards using Grafana as a central observability tool for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.14.1">
       data representation
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.15.1">
      Building an efficient and centralized logging solution using OpenSearch to ship, parse, and build custom search queries for collected logs, enabling
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.16.1">
       further analysis
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-145">
    <a id="_idTextAnchor190">
    </a>
    <span class="koboSpan" id="kobo.17.1">
     OpenStack infrastructure monitoring
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.18.1">
     Beyond the workloads running in
    </span>
    <a id="_idIndexMarker764">
    </a>
    <span class="koboSpan" id="kobo.19.1">
     OpenStack tenants, cloud operators must ensure that they have the necessary metrics to ensure OpenStack services’ availability, performance, and usage status.
    </span>
    <span class="koboSpan" id="kobo.19.2">
     Monitoring data should involve mainly two different categories of the OpenStack infrastructure services,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.20.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.21.1">
       Cloud software
      </span>
     </strong>
     <span class="koboSpan" id="kobo.22.1">
      : This includes
     </span>
     <a id="_idIndexMarker765">
     </a>
     <span class="koboSpan" id="kobo.23.1">
      OpenStack APIs, schedulers, databases, message busses, and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.24.1">
       load-balancing services.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.25.1">
       Under cloud
      </span>
     </strong>
     <span class="koboSpan" id="kobo.26.1">
      : This includes running
     </span>
     <a id="_idIndexMarker766">
     </a>
     <span class="koboSpan" id="kobo.27.1">
      operating systems, storage, and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.28.1">
       network hardware.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.29.1">
     In the following section, we will explore Prometheus, a well-integrated and adopted monitoring and alerting toolkit for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.30.1">
      large-scale deployment.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-146">
    <a id="_idTextAnchor191">
    </a>
    <span class="koboSpan" id="kobo.31.1">
     Prometheus in a nutshell
    </span>
   </h2>
   <p>
    <strong class="bold">
     <span class="koboSpan" id="kobo.32.1">
      Prometheus
     </span>
    </strong>
    <span class="koboSpan" id="kobo.33.1">
     allows you to collect and store metrics as time-series data.
    </span>
    <span class="koboSpan" id="kobo.33.2">
     Prometheus is considered a great fit for large deployment, as it provides exporters with components that ship various amounts of metrics to a Prometheus server.
    </span>
    <span class="koboSpan" id="kobo.33.3">
     Additionally, the tool includes an alerting mechanism to
    </span>
    <a id="_idIndexMarker767">
    </a>
    <span class="koboSpan" id="kobo.34.1">
     manage alerts and notifications based on configured thresholds.
    </span>
    <span class="koboSpan" id="kobo.34.2">
     Unlike other tools, such as Zabbix or Nagios, Prometheus offers flexible ways to feed metrics and data collected in its format.
    </span>
    <span class="koboSpan" id="kobo.34.3">
     This is performed by third-party exporters that provide Prometheus-compatible metrics with less effort to develop separate converters for each system of the software framework.
    </span>
    <span class="koboSpan" id="kobo.34.4">
     Some of the official exporters are maintained in Prometheus’s GitHub repository and can be found at
    </span>
    <a href="https://github.com/prometheus">
     <span class="koboSpan" id="kobo.35.1">
      https://github.com/prometheus
     </span>
    </a>
    <span class="koboSpan" id="kobo.36.1">
     .
    </span>
    <span class="koboSpan" id="kobo.36.2">
     In the OpenStack world, a vast number of metrics can be exported to Prometheus via the OpenStack Prometheus exporter, with a full list at
    </span>
    <a href="https://github.com/openstack-exporter/openstack-exporter">
     <span class="koboSpan" id="kobo.37.1">
      https://github.com/openstack-exporter/openstack-exporter
     </span>
    </a>
    <span class="koboSpan" id="kobo.38.1">
     .
    </span>
    <span class="koboSpan" id="kobo.38.2">
     As shown in the following diagram, Prometheus also has a discovery service that can be used by the OpenStack APIs to explore and generate data metrics for the Prometheus server.
    </span>
    <span class="koboSpan" id="kobo.38.3">
     This is mainly useful for reporting metrics for virtual machines – for example, when utilizing the service discovery on the Nova API service.
    </span>
    <span class="koboSpan" id="kobo.38.4">
     As soon as metrics are collected and stored by Prometheus, a single pane of glass should exist to consolidate and organize all data in comprehensible dashboards.
    </span>
    <span class="koboSpan" id="kobo.38.5">
     Grafana is a great open-source tool for metrics visualization that can be configured to use Prometheus as its
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.39.1">
      data source.
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer136">
     <span class="koboSpan" id="kobo.40.1">
      <img alt="Figure 8.1 – A Prometheus integration and monitoring stack in OpenStack" src="image/B21716_08_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.41.1">
     Figure 8.1 – A Prometheus integration and monitoring stack in OpenStack
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.42.1">
     In the following section, Prometheus
    </span>
    <a id="_idIndexMarker768">
    </a>
    <span class="koboSpan" id="kobo.43.1">
     will be deployed and integrated as the main monitoring tool in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.44.1">
      OpenStack environment.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-147">
    <a id="_idTextAnchor192">
    </a>
    <span class="koboSpan" id="kobo.45.1">
     Deploying infrastructure monitoring
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.46.1">
     Adopting the Prometheus and Grafana pair as a central monitoring and observability solution for the OpenStack infrastructure is a quick win for cloud operators, due to the well-tested and integrated monitoring solution in the latest OpenStack releases.
    </span>
    <span class="koboSpan" id="kobo.46.2">
     Kolla Ansible promotes and supports
    </span>
    <a id="_idIndexMarker769">
    </a>
    <span class="koboSpan" id="kobo.47.1">
     Prometheus and Grafana integration in the latest code releases.
    </span>
    <span class="koboSpan" id="kobo.47.2">
     An additional monitoring host can be dedicated to run the Prometheus server and, optionally, Grafana.
    </span>
    <span class="koboSpan" id="kobo.47.3">
     This can be achieved through the following configuration in the infrastructure as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.48.1">
      code settings:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.49.1">
      Update the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.50.1">
       multi_packtpub_prod
      </span>
     </strong>
     <span class="koboSpan" id="kobo.51.1">
      inventory file by adding the new monitoring host,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.52.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.53.1">
...
</span><span class="koboSpan" id="kobo.53.2">[monitoring]
mon01.os.packtpub</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.54.1">
      Add the Prometheus service to the monitoring
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.55.1">
       host group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.56.1">
...
</span><span class="koboSpan" id="kobo.56.2">[prometheus:children]
monitoring</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.57.1">
      Add the built-in Prometheus alert manager service to the monitoring
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.58.1">
       host group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.59.1">
...
</span><span class="koboSpan" id="kobo.59.2">[prometheus-alertmanager:children]
monitoring</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.60.1">
      Include the OpenStack Prometheus exporter in the monitoring host group.
     </span>
     <span class="koboSpan" id="kobo.60.2">
      This will create a dedicated
     </span>
     <a id="_idIndexMarker770">
     </a>
     <span class="koboSpan" id="kobo.61.1">
      service container to automatically pull formatted Prometheus data from the OpenStack
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.62.1">
       services’ metrics:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.63.1">
...
</span><span class="koboSpan" id="kobo.63.2">[prometheus-openstack-exporter:children]
monitoring</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.64.1">
      Add the Prometheus Node Exporter role to run in each host.
     </span>
     <span class="koboSpan" id="kobo.64.2">
      The Node Exporter provides a wide range of Linux operating system and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.65.1">
       hardware metrics:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.66.1">
...
</span><span class="koboSpan" id="kobo.66.2">[prometheus-node-exporter:children]
monitoring
control
compute
network
storage</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.67.1">
      Prometheus provides a dedicated exporter for the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.68.1">
       MariaDB database
      </span>
     </strong>
     <span class="koboSpan" id="kobo.69.1">
      .
     </span>
     <span class="koboSpan" id="kobo.69.2">
      The MySQL server metrics exposed through the
     </span>
     <a id="_idIndexMarker771">
     </a>
     <span class="koboSpan" id="kobo.70.1">
      exporter provide an extended list of data metrics available for scraping.
     </span>
     <span class="koboSpan" id="kobo.70.2">
      The Prometheus MySQL exporter can be added to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.71.1">
       mariadb
      </span>
     </strong>
     <span class="koboSpan" id="kobo.72.1">
      role running in the cloud
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.73.1">
       controller nodes:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.74.1">
...
</span><span class="koboSpan" id="kobo.74.2">[prometheus-mysqld-exporter:children]
mariadb</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.75.1">
      Similarly, Prometheus can be configured to scrape the load balancing metrics and stats running HAProxy via its dedicated exporter running in the load
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.76.1">
       balancer nodes:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.77.1">
...
</span><span class="koboSpan" id="kobo.77.2">[prometheus-haproxy-exporter:children]
loadbalancer</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.78.1">
      Another available exporter that exposes
     </span>
     <a id="_idIndexMarker772">
     </a>
     <span class="koboSpan" id="kobo.79.1">
      both host and instance metrics is the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.80.1">
       Prometheus Libvirt exporter
      </span>
     </strong>
     <span class="koboSpan" id="kobo.81.1">
      .
     </span>
     <span class="koboSpan" id="kobo.81.2">
      This exporter collects
     </span>
     <a id="_idIndexMarker773">
     </a>
     <span class="koboSpan" id="kobo.82.1">
      data from the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.83.1">
       Libvirt API
      </span>
     </strong>
     <span class="koboSpan" id="kobo.84.1">
      and exposes useful metrics
     </span>
     <a id="_idIndexMarker774">
     </a>
     <span class="koboSpan" id="kobo.85.1">
      for compute nodes and running instances.
     </span>
     <span class="koboSpan" id="kobo.85.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.86.1">
       libvirt
      </span>
     </strong>
     <span class="koboSpan" id="kobo.87.1">
      exporter can be installed in the compute nodes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.88.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.89.1">
...
</span><span class="koboSpan" id="kobo.89.2">[prometheus-libvirt-exporter:children]
compute</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.90.1">
      For a broader monitoring setup across the OpenStack infrastructure, consider keeping an eye on the status
     </span>
     <a id="_idIndexMarker775">
     </a>
     <span class="koboSpan" id="kobo.91.1">
      of the containers running in each node.
     </span>
     <span class="koboSpan" id="kobo.91.2">
      The Prometheus
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.92.1">
       cAdvisor
      </span>
     </strong>
     <span class="koboSpan" id="kobo.93.1">
      (short for
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.94.1">
       Container Advisor
      </span>
     </strong>
     <span class="koboSpan" id="kobo.95.1">
      ) exporter is designed to collect, analyze, aggregate, and export container performance and metrics data.
     </span>
     <span class="koboSpan" id="kobo.95.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.96.1">
       cAdvisor
      </span>
     </strong>
     <span class="koboSpan" id="kobo.97.1">
      exporter will run across all OpenStack nodes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.98.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.99.1">
...
</span><span class="koboSpan" id="kobo.99.2">[prometheus-cadvisor:children]
monitoring
control
compute
network
storage</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.100.1">
      The next step is to enable and install the Prometheus service using
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.101.1">
       kolla-ansible
      </span>
     </strong>
     <span class="koboSpan" id="kobo.102.1">
      .
     </span>
     <span class="koboSpan" id="kobo.102.2">
      At the time of writing this edition,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.103.1">
       kolla-ansible
      </span>
     </strong>
     <span class="koboSpan" id="kobo.104.1">
      will install the latest version of the Prometheus server after 2.0 by adding the following variable to the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.105.1">
        globals.yml
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.106.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.107.1">
...
</span><span class="koboSpan" id="kobo.107.2">enable_prometheus: "yes"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.108.1">
      For data exposure and visualization, enable Grafana in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.109.1">
        globals.yml
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.110.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.111.1">
...
</span><span class="koboSpan" id="kobo.111.2">enable_grafana: "yes"</span></pre>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.112.1">
       kolla-ansible
      </span>
     </strong>
     <span class="koboSpan" id="kobo.113.1">
      allows custom settings for the monitoring layer for both the Prometheus and Grafana services.
     </span>
     <span class="koboSpan" id="kobo.113.2">
      Once both services are installed, you will need to provide a username and password for access.
     </span>
     <span class="koboSpan" id="kobo.113.3">
      By default,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.114.1">
       kolla-ansible
      </span>
     </strong>
     <span class="koboSpan" id="kobo.115.1">
      installs Prometheus
     </span>
     <a id="_idIndexMarker776">
     </a>
     <span class="koboSpan" id="kobo.116.1">
      using basic authentication via HTTP, with an
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.117.1">
       admin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.118.1">
      user and a Grafana user,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.119.1">
       grafana
      </span>
     </strong>
     <span class="koboSpan" id="kobo.120.1">
      .
     </span>
     <span class="koboSpan" id="kobo.120.2">
      Both default variables are assigned to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.121.1">
       /kolla-ansible/ansible/group_vars/all.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.122.1">
      file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.123.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.124.1">
...
</span><span class="koboSpan" id="kobo.124.2">prometheus_alertmanager_user: "admin"
prometheus_grafana_user: "grafana"</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.125.1">
       For custom user access settings, you can override the default usernames by adjusting the variables directly from the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.126.1">
        all.yml
       </span>
      </strong>
      <span class="koboSpan" id="kobo.127.1">
       file or in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.128.1">
        prometheus_basic_auth_users
       </span>
      </strong>
      <span class="koboSpan" id="kobo.129.1">
       configuration section in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.130.1">
        /kolla-ansible/ansible/roles/prometheus/defaults/main.yml
       </span>
      </strong>
      <span class="koboSpan" id="kobo.131.1">
       file,
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.132.1">
        as follows:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.133.1">...
</span><span class="koboSpan" id="kobo.133.2">prometheus_basic_auth_users_default:
  - username: admin
    password: "{{ prometheus_password }}"
    enabled: true
  - username: "{{ prometheus_grafana_user }}"
    password: "{{ prometheus_grafana_password }}"
    enabled: "{{ enable_grafana }}"</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.134.1">
       User passwords for both Prometheus and Grafana can be reconfigured in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.135.1">
        /etc/kolla/passwords.yml
       </span>
      </strong>
      <span class="koboSpan" id="kobo.136.1">
       file, where all service secrets are defined.
      </span>
      <span class="koboSpan" id="kobo.136.2">
       Both passwords are defined
      </span>
      <a id="_idIndexMarker777">
      </a>
      <span class="koboSpan" id="kobo.137.1">
       with the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.138.1">
        following variables:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.139.1">prometheus_password:
prometheus_grafana_password:</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.140.1">
       The other option is to create new users using either custom passwords or the default ones, without overriding the existing ones, by extending the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.141.1">
        prometheus_basic_auth_users_extra
       </span>
      </strong>
      <span class="koboSpan" id="kobo.142.1">
       variable in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.143.1">
        /kolla-ansible/ansible/roles/prometheus/defaults/main.yml
       </span>
      </strong>
      <span class="koboSpan" id="kobo.144.1">
       file,
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.145.1">
        as follows:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.146.1">prometheus_basic_auth_users_extra:
   - username: prometheus_pp_admin2
     password: "{{ prometheus_password }}"
     enabled: true
   - username: prometheus_pp_2
     password: prometheus_pp_password
     enabled: true</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.147.1">
      Another great metrics-scraping way is to configure a custom Prometheus run by listing a set of startup parameters in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.148.1">
       prometheus_cmdline_extras
      </span>
     </strong>
     <span class="koboSpan" id="kobo.149.1">
      variable, in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.150.1">
       globals.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.151.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.151.2">
      For example, Prometheus can be configured to retain metrics data up to a specific size, via the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.152.1">
       --storage.tsdb.retention.size
      </span>
     </strong>
     <span class="koboSpan" id="kobo.153.1">
      parameter.
     </span>
     <span class="koboSpan" id="kobo.153.2">
      In the following listing, a customized configuration is defined to limit the maximum number of simultaneous connections on the Prometheus dashboard to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.154.1">
       30
      </span>
     </strong>
     <span class="koboSpan" id="kobo.155.1">
      connections, adjust the log severity level to include
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.156.1">
       error
      </span>
     </strong>
     <span class="koboSpan" id="kobo.157.1">
      (the default severity level is
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.158.1">
       info
      </span>
     </strong>
     <span class="koboSpan" id="kobo.159.1">
      ), increase the frequency
     </span>
     <a id="_idIndexMarker778">
     </a>
     <span class="koboSpan" id="kobo.160.1">
      of resending an alert to the Prometheus alert manager every
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.161.1">
       30
      </span>
     </strong>
     <span class="koboSpan" id="kobo.162.1">
      seconds, and retain metrics data for
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.163.1">
       30
      </span>
     </strong>
     <span class="koboSpan" id="kobo.164.1">
      days
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.165.1">
       in storage:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.166.1">
prometheus_cmdline_extras: " --web.max-connections 30 --log.level error  --rules.alert.resend-delay 30s  --storage.tsdb.retention.time 30d "</span></pre>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.167.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.168.1">
     A full list of the Prometheus startup parameters can be found
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.169.1">
      at
     </span>
    </span>
    <a href="https://prometheus.io/docs/prometheus/latest/command-line/prometheus/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.170.1">
       https://prometheus.io/docs/prometheus/latest/command-line/prometheus/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.171.1">
      .
     </span>
    </span>
   </p>
   <ol>
    <li value="14">
     <span class="koboSpan" id="kobo.172.1">
      Run a pipeline to deploy the Prometheus server, Grafana, Prometheus cAdvisor, and relevant exporter components.
     </span>
     <span class="koboSpan" id="kobo.172.2">
      Once the deployment pipeline is completed, verify the newly deployed containers by running the following command line in one of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.173.1">
       controller nodes:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.174.1">$ docker ps -a | grep -e prometheus -e grafana</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.175.1">
       We get the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.176.1">
        following output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer137">
     <span class="koboSpan" id="kobo.177.1">
      <img alt="Figure 8.2 – Listing the Prometheus and Grafana Kolla containers" src="image/B21716_08_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.178.1">
     Figure 8.2 – Listing the Prometheus and Grafana Kolla containers
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.179.1">
     In the following section, we will check out the Prometheus-collected metrics and build insightful dashboards
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.180.1">
      using
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker779">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.181.1">
      Grafana.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-148">
    <a id="_idTextAnchor193">
    </a>
    <span class="koboSpan" id="kobo.182.1">
     Exploring the monitoring data
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.183.1">
     The latest
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.184.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.185.1">
     deployment enables the Prometheus server to start collecting different metrics available for
    </span>
    <a id="_idIndexMarker780">
    </a>
    <span class="koboSpan" id="kobo.186.1">
     scraping that can be checked on the Prometheus dashboard.
    </span>
    <span class="koboSpan" id="kobo.186.2">
     The main Prometheus dashboard can be accessed by pointing to the IP address of the monitoring host:
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.187.1">
      http://host_monitoring_ip/prometheus
     </span>
    </strong>
    <span class="koboSpan" id="kobo.188.1">
     , where
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.189.1">
      host_monitoring_ip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.190.1">
     is the IP address of the monitoring host running the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.191.1">
      Prometheus server.
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer138">
     <span class="koboSpan" id="kobo.192.1">
      <img alt="Figure 8.3 – The Prometheus dashboard interface" src="image/B21716_08_03.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.193.1">
     Figure 8.3 – The Prometheus dashboard interface
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.194.1">
     Prometheus collects an exhaustive list of metrics from each installed exporter across all defined hosts in the inventory.
    </span>
    <span class="koboSpan" id="kobo.194.2">
     It uses
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.195.1">
      labels
     </span>
    </strong>
    <span class="koboSpan" id="kobo.196.1">
     to define
    </span>
    <a id="_idIndexMarker781">
    </a>
    <span class="koboSpan" id="kobo.197.1">
     each metric’s target endpoint.
    </span>
    <span class="koboSpan" id="kobo.197.2">
     For example, once the OpenStack exporter is installed, Prometheus starts collecting OpenStack-related metrics that can be checked by pointing to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.198.1">
      http://host_monitoring_ip:9090/targets
     </span>
    </strong>
    <span class="koboSpan" id="kobo.199.1">
     , where
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.200.1">
      host_monitoring_ip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.201.1">
     is the IP address of the monitoring host running the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.202.1">
      Prometheus server.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.203.1">
     Collected metrics will be visible in the Prometheus dashboard as soon as the exporter service in each node sends metrics data for scraping.
    </span>
    <span class="koboSpan" id="kobo.203.2">
     It might take a while to visualize all the metrics in the Prometheus dashboard.
    </span>
    <span class="koboSpan" id="kobo.203.3">
     For example, the following listing shows that the initial OpenStack service exported metrics through
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.204.1">
      http://host_monitoring_ip:9100/metrics
     </span>
    </strong>
    <span class="koboSpan" id="kobo.205.1">
     , where
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.206.1">
      host_monitoring_ip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.207.1">
     is the IP address of the monitoring host running the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.208.1">
      Prometheus server:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer139">
     <span class="koboSpan" id="kobo.209.1">
      <img alt="Figure 8.4 – A listing of the collected OpenStack service metrics in Prometheus" src="image/B21716_08_04.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.210.1">
     Figure 8.4 – A listing of the collected OpenStack service metrics in Prometheus
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.211.1">
     The Node Exporter service installed on each OpenStack physical machine to gather host metrics, such as memory usage and
    </span>
    <a id="_idIndexMarker782">
    </a>
    <span class="koboSpan" id="kobo.212.1">
     stats, can be checked through the metrics listing at the same Prometheus dashboard URL, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.213.1">
      following example:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer140">
     <span class="koboSpan" id="kobo.214.1">
      <img alt="Figure 8.5 – A listing of the collected memory metrics and stats in Prometheus" src="image/B21716_08_05.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.215.1">
     Figure 8.5 – A listing of the collected memory metrics and stats in Prometheus
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.216.1">
     With more nodes joining the OpenStack infrastructure, the number of collected metrics could be doubled, which would affect the monitoring host performance and disk capacity.
    </span>
    <span class="koboSpan" id="kobo.216.2">
     For this reason, it is highly encouraged to use more than one Prometheus server instance to handle more metrics export and scraping jobs.
    </span>
    <span class="koboSpan" id="kobo.216.3">
     Prometheus is designed to scale well in large deployments, with gazillions of resource types
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.217.1">
      and metrics.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.218.1">
     Browsing hundreds of metrics on the Prometheus dashboard to follow up on hundreds of service statuses and related usage information can be cumbersome.
    </span>
    <span class="koboSpan" id="kobo.218.2">
     Prometheus can be very helpful with most essential operational tasks, including
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.219.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.220.1">
      Metrics data
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.221.1">
       collection configuration
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.222.1">
      Management and configuration
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.223.1">
       of alerts
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.224.1">
      Troubleshooting metrics
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.225.1">
       export issues
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.226.1">
     Prometheus is a highly configurable tool and provides a native command-line interface to customize metrics collection
    </span>
    <a id="_idIndexMarker783">
    </a>
    <span class="koboSpan" id="kobo.227.1">
     and scraping settings, which are beyond the scope of this book.
    </span>
    <span class="koboSpan" id="kobo.227.2">
     We will use the exported metrics data by Prometheus and visualize it in a simple
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.228.1">
      Grafana dashboard.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.229.1">
     The latest
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.230.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.231.1">
     run should enable the Grafana service with the default dashboard and configure Prometheus as a data source.
    </span>
    <span class="koboSpan" id="kobo.231.2">
     To validate the Prometheus data source, point to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.232.1">
      http://host_monitoring_ip:3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.233.1">
     , where
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.234.1">
      host_monitoring_ip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.235.1">
     is the IP address of the monitoring host running the Grafana instance.
    </span>
    <span class="koboSpan" id="kobo.235.2">
     Provide the username and password to access the Grafana dashboard configured in the previous steps.
    </span>
    <span class="koboSpan" id="kobo.235.3">
     If you did not customize the Grafana access credentials, use the username and password pair as
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.236.1">
       admin
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.237.1">
      /
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.238.1">
       admin
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.239.1">
      , respectively.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.240.1">
     Once logged in, navigate in the dashboard to the settings icon |
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.241.1">
      Configuration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.242.1">
     |
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.243.1">
      Data sources
     </span>
    </strong>
    <span class="koboSpan" id="kobo.244.1">
     , and make sure that the Prometheus data source is added.
    </span>
    <span class="koboSpan" id="kobo.244.2">
     Verify that the data source is functional, and no errors are reported.
    </span>
    <span class="koboSpan" id="kobo.244.3">
     Click on the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.245.1">
      Save &amp; test
     </span>
    </strong>
    <span class="koboSpan" id="kobo.246.1">
     button, which should display that the data source configuration is functional, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.247.1">
      following screenshot:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer141">
     <span class="koboSpan" id="kobo.248.1">
      <img alt="Figure 8.6 – Adding a Prometheus data source in the Grafana dashboard" src="image/B21716_08_06.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.249.1">
     Figure 8.6 – Adding a Prometheus data source in the Grafana dashboard
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.250.1">
     Once the data source is checked, building dashboards in Grafana is straightforward and can be done either by creating freestyle dashboards or by importing dashboards from the Grafana website catalog.
    </span>
    <a href="https://grafana.com/">
     <span class="koboSpan" id="kobo.251.1">
      https://grafana.com/
     </span>
    </a>
    <span class="koboSpan" id="kobo.252.1">
     exposes different dashboards for each Prometheus exporter, identified by a dashboard ID that can be simply added to the local Grafana server.
    </span>
    <span class="koboSpan" id="kobo.252.2">
     You can also import the dashboard in the JSON format and copy and paste it into the Grafana import
    </span>
    <a id="_idIndexMarker784">
    </a>
    <span class="koboSpan" id="kobo.253.1">
     section.
    </span>
    <span class="koboSpan" id="kobo.253.2">
     In the next wizard, we will import Grafana dashboards for the OpenStack and Node Exporters using the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.254.1">
      dashboard import IDs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.255.1">
     option.
    </span>
    <span class="koboSpan" id="kobo.255.2">
     To do so, simply navigate to the Grafana home page, then click on the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.256.1">
      +
     </span>
    </strong>
    <span class="koboSpan" id="kobo.257.1">
     icon and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.258.1">
      select
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.259.1">
       Import
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.260.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer142">
     <span class="koboSpan" id="kobo.261.1">
      <img alt="Figure 8.7 – Adding a dashboard in Grafana" src="image/B21716_08_07.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.262.1">
     Figure 8.7 – Adding a dashboard in Grafana
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.263.1">
     Starting with the OpenStack metrics exporter, navigate to the OpenStack Grafana dashboard at
    </span>
    <a href="https://grafana.com/grafana/dashboards/9701-openstack-dashboard/">
     <span class="koboSpan" id="kobo.264.1">
      https://grafana.com/grafana/dashboards/9701-openstack-dashboard/
     </span>
    </a>
    <span class="koboSpan" id="kobo.265.1">
     and copy the ID of the dashboard,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.266.1">
      as follows:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer143">
     <span class="koboSpan" id="kobo.267.1">
      <img alt="Figure 8.8 – Obtaining the dashboard ID" src="image/B21716_08_08.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.268.1">
     Figure 8.8 – Obtaining the dashboard ID
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.269.1">
     Paste the copied dashboard ID into the Grafana dashboard
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.270.1">
      Import
     </span>
    </strong>
    <span class="koboSpan" id="kobo.271.1">
     page.
    </span>
    <span class="koboSpan" id="kobo.271.2">
     The dashboard ID should
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.272.1">
      be
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.273.1">
       9701
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.274.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer144">
     <span class="koboSpan" id="kobo.275.1">
      <img alt="Figure 8.9 – Importing the dashboard ID into Grafana" src="image/B21716_08_09.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.276.1">
     Figure 8.9 – Importing the dashboard ID into Grafana
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.277.1">
     The next page of the import wizard will guide you through the settings of the imported dashboard.
    </span>
    <span class="koboSpan" id="kobo.277.2">
     Enter the name of the
    </span>
    <a id="_idIndexMarker785">
    </a>
    <span class="koboSpan" id="kobo.278.1">
     dashboard of your choice, and make sure that the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.279.1">
      Prometheus
     </span>
    </strong>
    <span class="koboSpan" id="kobo.280.1">
     data source is selected, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.281.1">
      following screenshot:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer145">
     <span class="koboSpan" id="kobo.282.1">
      <img alt="Figure 8.10 – Configuring the dashboard with Prometheus as the data source" src="image/B21716_08_10.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.283.1">
     Figure 8.10 – Configuring the dashboard with Prometheus as the data source
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.284.1">
     Once the import wizard has completed, the imported Grafana dashboard for the OpenStack exporter metrics will display a variety of graphs and metrics, such as a generic overview of a resource’s usage per OpenStack service.
    </span>
    <span class="koboSpan" id="kobo.284.2">
     Some highlights of the services metrics are
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.285.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.286.1">
      The current existing Keystone users, groups,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.287.1">
       and projects
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.288.1">
      Neutron resources such as the floating IPs, virtual networks, and security
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.289.1">
       groups deployed
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.290.1">
      The number of running instances by the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.291.1">
       Nova service
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.292.1">
      The current count of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.293.1">
       Glance images
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.294.1">
      The volumes and
     </span>
     <a id="_idIndexMarker786">
     </a>
     <span class="koboSpan" id="kobo.295.1">
      snapshots managed by the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.296.1">
       Cinder service
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.297.1">
      The overall usage of the CPU, RAM, and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.298.1">
       disk resources
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.299.1">
     Several dashboards can be displayed, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.300.1">
      following screenshot:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer146">
     <span class="koboSpan" id="kobo.301.1">
      <img alt="Figure 8.11 – The imported generic dashboard with Prometheus as the data source" src="image/B21716_08_11.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.302.1">
     Figure 8.11 – The imported generic dashboard with Prometheus as the data source
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.303.1">
     The imported dashboard has more insights into each service and its relative subcomponents, such as API services
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.304.1">
      and agents.
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer147">
     <span class="koboSpan" id="kobo.305.1">
      <img alt="Figure 8.12 – The imported dashboards for each OpenStack API service status" src="image/B21716_08_12.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.306.1">
     Figure 8.12 – The imported dashboards for each OpenStack API service status
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.307.1">
     Another useful dashboard should exist to monitor the hosts themselves running the cloud environment, via the Prometheus Node Exporter.
    </span>
    <span class="koboSpan" id="kobo.307.2">
     The Grafana template dashboard can be found at
    </span>
    <a href="https://grafana.com/grafana/dashboards/1860-node-exporter-full/">
     <span class="koboSpan" id="kobo.308.1">
      https://grafana.com/grafana/dashboards/1860-node-exporter-full/
     </span>
    </a>
    <span class="koboSpan" id="kobo.309.1">
     , with the dashboard ID
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.310.1">
      1860
     </span>
    </strong>
    <span class="koboSpan" id="kobo.311.1">
     .
    </span>
    <span class="koboSpan" id="kobo.311.2">
     Follow the same import instructions performed for the OpenStack exporter dashboard to make sure the data source selected
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.312.1">
      is Prometheus.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.313.1">
     Once imported, a new Grafana
    </span>
    <a id="_idIndexMarker787">
    </a>
    <span class="koboSpan" id="kobo.314.1">
     namespace will be created, with Prometheus as the data source.
    </span>
    <span class="koboSpan" id="kobo.314.2">
     The collected data reflects granular and insightful information about the operating system and hardware metrics collected from each OpenStack host, using the installed Node
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.315.1">
      Exporter service:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer148">
     <span class="koboSpan" id="kobo.316.1">
      <img alt="Figure 8.13 – A consolidated dashboard for OpenStack" src="image/B21716_08_13.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.317.1">
     Figure 8.13 – A consolidated dashboard for OpenStack
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.318.1">
     Similarly, you can import ready-to-go Grafana dashboards for each installed Prometheus exporter.
    </span>
    <span class="koboSpan" id="kobo.318.2">
     The database metrics dashboard can be found at
    </span>
    <a href="https://grafana.com/grafana/dashboards/14057-mysql/">
     <span class="koboSpan" id="kobo.319.1">
      https://grafana.com/grafana/dashboards/14057-mysql/
     </span>
    </a>
    <span class="koboSpan" id="kobo.320.1">
     , and HAProxy is available
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.321.1">
      at
     </span>
    </span>
    <a href="https://grafana.com/grafana/dashboards/2428-haproxy/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.322.1">
       https://grafana.com/grafana/dashboards/2428-haproxy/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.323.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.324.1">
     As far as data collected from the hosts running OpenStack services is concerned, the Prometheus Node Exporter service supports proactively identifying possible system anomalies.
    </span>
    <span class="koboSpan" id="kobo.324.2">
     The imported dashboard consolidates all hosts’ metrics in one single pane of glass that can be filtered by
    </span>
    <a id="_idIndexMarker788">
    </a>
    <span class="koboSpan" id="kobo.325.1">
     one or a group of hosts, offering a more custom
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.326.1">
      visualization experience.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.327.1">
     Next, we will move on to keep track of the workloads running on top of the OpenStack
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.328.1">
      private cloud.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-149">
    <a id="_idTextAnchor194">
    </a>
    <span class="koboSpan" id="kobo.329.1">
     OpenStack workload monitoring
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.330.1">
     The next remaining part of the operational task of cloud operators is to provide monitoring support to the running workloads of the OpenStack tenants.
    </span>
    <span class="koboSpan" id="kobo.330.2">
     Operators should also monitor some generic metrics
    </span>
    <a id="_idIndexMarker789">
    </a>
    <span class="koboSpan" id="kobo.331.1">
     of the provisioned resources by tenants to anticipate quota limitations and gain insightful analysis of the infrastructure usage.
    </span>
    <span class="koboSpan" id="kobo.331.2">
     This can be achieved by using the same toolsets covered in the previous section.
    </span>
    <span class="koboSpan" id="kobo.331.3">
     Workload monitoring focuses more on the resources deployed by each tenant – more precisely, the Nova instances.
    </span>
    <span class="koboSpan" id="kobo.331.4">
     Prometheus is
    </span>
    <a id="_idIndexMarker790">
    </a>
    <span class="koboSpan" id="kobo.332.1">
     capable of querying the Nova API, and along with its labeling configuration settings, you should be able to filter and organize a list of thousands of instances into a set of scraped targets.
    </span>
    <span class="koboSpan" id="kobo.332.2">
     In the previous section, the Prometheus Libvirt exporter was deployed in each compute node (see
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.333.1">
      Step 8
     </span>
    </em>
    <span class="koboSpan" id="kobo.334.1">
     of the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.335.1">
      Deploying infrastructure monitoring
     </span>
    </em>
    <span class="koboSpan" id="kobo.336.1">
     section).
    </span>
    <span class="koboSpan" id="kobo.336.2">
     Thus, there is no need to reconfigure any part of the infrastructure hosts.
    </span>
    <span class="koboSpan" id="kobo.336.3">
     Instances metrics should be available in the Prometheus server, but identifying any reported instances with additional information is optional.
    </span>
    <span class="koboSpan" id="kobo.336.4">
     Prometheus can be configured to discover instances in OpenStack by applying exporter configuration and the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.337.1">
      relabel_configs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.338.1">
     settings, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.339.1">
      following example:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.340.1">
- job_name: 'openstack_pp'
openstack_sd_configs:
  - role: 'instance'
...
</span><strong class="bold"><span class="koboSpan" id="kobo.341.1">relabel_configs</span></strong><span class="koboSpan" id="kobo.342.1">:
  - source_labels: [__meta_openstack_public_ip]
    target_label: __address__
    replacement: '$1:9100'
  - source_labels: [__meta_openstack_tag_prometheus]
    regex: true.*
    action: keep
- source_labels: [__meta_openstack_tag_node_exporter]
 regex: true.*
    action: keep
 - action: labelmap
   regex: __meta_openstack_(.+)</span></pre>
   <p>
    <span class="koboSpan" id="kobo.343.1">
     The tag-relabeling configuration helps to pull the metadata of discovered instances that matches a regular expression in Prometheus.
    </span>
    <span class="koboSpan" id="kobo.343.2">
     In the previous example, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.344.1">
      __meta_openstack_(.+)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.345.1">
     regular expression is applied and added for each metric received for all different source labels.
    </span>
    <span class="koboSpan" id="kobo.345.2">
     This is useful to visualize tenant resources with more specific information, such as the instance
    </span>
    <a id="_idIndexMarker791">
    </a>
    <span class="koboSpan" id="kobo.346.1">
     name, IP address, and instance status, as shown in the following Prometheus server endpoint
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.347.1">
      dashboard example:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer149">
     <span class="koboSpan" id="kobo.348.1">
      <img alt="Figure 8.14 – A listing of instance metrics in the Prometheus dashboard" src="image/B21716_08_14.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.349.1">
     Figure 8.14 – A listing of instance metrics in the Prometheus dashboard
    </span>
   </p>
   <p>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.350.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.351.1">
     ’s default Prometheus configuration does not include a full set of labels for each exporter type.
    </span>
    <span class="koboSpan" id="kobo.351.2">
     The main configuration of Prometheus for all exporters can be found in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.352.1">
      kolla-ansible/ansible/roles/prometheus/templates/prometheus.yml.j2
     </span>
    </strong>
    <span class="koboSpan" id="kobo.353.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.353.2">
     One way to include a custom relabeling configuration is to edit the latter file and amend each exporter section settings.
    </span>
    <span class="koboSpan" id="kobo.353.3">
     The recommended way is to create a new custom configuration file – for example, one named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.354.1">
      custom.yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.355.1">
     under the new config directory, such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.356.1">
      /etc/kolla/config/prometheus/prometheus.yml.d/
     </span>
    </strong>
    <span class="koboSpan" id="kobo.357.1">
     , and apply the new additional settings by running the pipeline.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.358.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.359.1">
     will merge the additional configurations in the running Prometheus server, but bear in mind that that will require a short restart of the server to load the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.360.1">
      new configuration.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.361.1">
     Visualizing the instance metrics in Grafana would require only building corresponding dashboards.
    </span>
    <span class="koboSpan" id="kobo.361.2">
     Similar to how observability is performed for the host metrics, the Node Exporter and Libvirt template
    </span>
    <a id="_idIndexMarker792">
    </a>
    <span class="koboSpan" id="kobo.362.1">
     dashboards combine instance-specific metrics to build custom tabs for instances’ resource usage per compute node.
    </span>
    <span class="koboSpan" id="kobo.362.2">
     This includes an overview of the total resource consumption, such as the CPU, RAM, and allocated volumes.
    </span>
    <span class="koboSpan" id="kobo.362.3">
     At the time of writing this edition, importing Grafana dashboards for virtual machine metrics using the Prometheus discovery service is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.363.1">
      not available.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.364.1">
     A Grafana dashboard for instance metrics from
    </span>
    <a href="http://grafana.com">
     <span class="koboSpan" id="kobo.365.1">
      grafana.com
     </span>
    </a>
    <span class="koboSpan" id="kobo.366.1">
     can be found at
    </span>
    <a href="https://grafana.com/grafana/dashboards/15330-openstack-instance-metrics/">
     <span class="koboSpan" id="kobo.367.1">
      https://grafana.com/grafana/dashboards/15330-openstack-instance-metrics/
     </span>
    </a>
    <span class="koboSpan" id="kobo.368.1">
     with the dashboard ID
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.369.1">
      15330
     </span>
    </strong>
    <span class="koboSpan" id="kobo.370.1">
     .
    </span>
    <span class="koboSpan" id="kobo.370.2">
     The dashboard cannot be used without a fully running
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.371.1">
      telemetry OpenStack
     </span>
    </strong>
    <span class="koboSpan" id="kobo.372.1">
     service (composed of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.373.1">
      Ceilometer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.374.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.375.1">
      Gnocchi
     </span>
    </strong>
    <span class="koboSpan" id="kobo.376.1">
     ), which will be covered in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.377.1">
      next section.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-150">
    <a id="_idTextAnchor195">
    </a>
    <span class="koboSpan" id="kobo.378.1">
     Telemetry and charging back
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.379.1">
     OpenStack provides telemetry for tenant environments with the Ceilometer service.
    </span>
    <span class="koboSpan" id="kobo.379.2">
     The Ceilometer project aims to support cloud operators to collect metrics, further assisting and understanding resource utilization.
    </span>
    <span class="koboSpan" id="kobo.379.3">
     This enables us to address infrastructure scalability issues and update resource
    </span>
    <a id="_idIndexMarker793">
    </a>
    <span class="koboSpan" id="kobo.380.1">
     planning for expansion and growth before hitting the resource limits.
    </span>
    <span class="koboSpan" id="kobo.380.2">
     Since the Queens OpenStack release, the telemetry module has been extended with additional components that work in tandem with Ceilometer, including
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.381.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.382.1">
       Aodh
      </span>
     </strong>
     <span class="koboSpan" id="kobo.383.1">
      : An alarming
     </span>
     <a id="_idIndexMarker794">
     </a>
     <span class="koboSpan" id="kobo.384.1">
      service that
     </span>
     <a id="_idIndexMarker795">
     </a>
     <span class="koboSpan" id="kobo.385.1">
      acts upon collected
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.386.1">
       metrics data
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.387.1">
       Gnocchi
      </span>
     </strong>
     <span class="koboSpan" id="kobo.388.1">
      : A data store
     </span>
     <a id="_idIndexMarker796">
     </a>
     <span class="koboSpan" id="kobo.389.1">
      and collection
     </span>
     <a id="_idIndexMarker797">
     </a>
     <span class="koboSpan" id="kobo.390.1">
      of time
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.391.1">
       series data
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.392.1">
       Panko
      </span>
     </strong>
     <span class="koboSpan" id="kobo.393.1">
      : A data store for
     </span>
     <a id="_idIndexMarker798">
     </a>
     <span class="koboSpan" id="kobo.394.1">
      events data generated
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.395.1">
       by Ceilometer
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.396.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.397.1">
     At the time of writing this
    </span>
    <a id="_idIndexMarker799">
    </a>
    <span class="koboSpan" id="kobo.398.1">
     edition, the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.399.1">
      Panko
     </span>
    </strong>
    <span class="koboSpan" id="kobo.400.1">
     module has been deprecated and is no longer maintained by the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.401.1">
      OpenStack community.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.402.1">
     The next section will highlight the telemetry stack in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.403.1">
      more detail.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-151">
    <a id="_idTextAnchor196">
    </a>
    <span class="koboSpan" id="kobo.404.1">
     The Ceilometer anatomy
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.405.1">
     The Ceilometer project originally aimed (until the Folsom release) to collect resources’ usage metrics from cloud tenants
    </span>
    <a id="_idIndexMarker800">
    </a>
    <span class="koboSpan" id="kobo.406.1">
     and transform them into billable items for invoicing purposes.
    </span>
    <span class="koboSpan" id="kobo.406.2">
     The continuous development of the Ceilometer project has enabled
    </span>
    <a id="_idIndexMarker801">
    </a>
    <span class="koboSpan" id="kobo.407.1">
     additional monitoring and alarming capabilities.
    </span>
    <span class="koboSpan" id="kobo.407.2">
     They have been split into their own modules since the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.408.1">
      Liberty release.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.409.1">
     As shown in the following diagram, Ceilometer relies on agents to collect, process, store, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.410.1">
      retrieve data.
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer150">
     <span class="koboSpan" id="kobo.411.1">
      <img alt="Figure 8.15 – A general overview of the Ceilometer architecture" src="image/B21716_08_15.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.412.1">
     Figure 8.15 – A general overview of the Ceilometer architecture
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.413.1">
     Each data workflow is actioned by a dedicated agent that can be listed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.414.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.415.1">
       Polling agents
      </span>
     </strong>
     <span class="koboSpan" id="kobo.416.1">
      : These regularly poll each
     </span>
     <a id="_idIndexMarker802">
     </a>
     <span class="koboSpan" id="kobo.417.1">
      OpenStack infrastructure service to formulate measurements via API calls.
     </span>
     <span class="koboSpan" id="kobo.417.2">
      A compute polling agent gathers statistics from instances running in a compute node and polls them to the message queue.
     </span>
     <span class="koboSpan" id="kobo.417.3">
      The central agent runs in a central management server in OpenStack, such as a cloud controller.
     </span>
     <span class="koboSpan" id="kobo.417.4">
      It polls statistics of resources other
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.418.1">
       than instances.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.419.1">
       Notification agents
      </span>
     </strong>
     <span class="koboSpan" id="kobo.420.1">
      : These listen periodically on the message queue bus, collect new notification messages set by different OpenStack services, and translate them into metrics before pushing them back to the appropriate message
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.421.1">
       queue bus.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.422.1">
       Collector agents
      </span>
     </strong>
     <span class="koboSpan" id="kobo.423.1">
      : These monitor the message queue, gather samples, and collect the metering messages generated by either polling or notification agents.
     </span>
     <span class="koboSpan" id="kobo.423.2">
      Therefore, the new metering messages will be recorded in a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.424.1">
       backend storage.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.425.1">
       API service
      </span>
     </strong>
     <span class="koboSpan" id="kobo.426.1">
      : This exposes a standard API that provides access to the internal Ceilometer database, if enabled, to query metering data
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.427.1">
       against it.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.428.1">
     Gathering data is mainly performed by agents using a pipeline mechanism.
    </span>
    <span class="koboSpan" id="kobo.428.2">
     Internally, they periodically send requests for sample objects that reflect a certain meter.
    </span>
    <span class="koboSpan" id="kobo.428.3">
     Every sample request will be forwarded to the pipeline.
    </span>
    <span class="koboSpan" id="kobo.428.4">
     Once passed to the pipeline, meters can be manipulated by several
    </span>
    <a id="_idIndexMarker803">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.429.1">
      transformer types:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.430.1">
       Accumulator
      </span>
     </strong>
     <span class="koboSpan" id="kobo.431.1">
      : This accumulates multi-values and sends them in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.432.1">
       a batch.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.433.1">
       Aggregator
      </span>
     </strong>
     <span class="koboSpan" id="kobo.434.1">
      : This aggregates multi-values into one arithmetic.
     </span>
     <span class="koboSpan" id="kobo.434.2">
      This includes arithmetic functions to compute
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.435.1">
       the percentage.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.436.1">
       Rate of change
      </span>
     </strong>
     <span class="koboSpan" id="kobo.437.1">
      : This identifies trends by deriving another meter from the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.438.1">
       previous data.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.439.1">
       Unit conversion
      </span>
     </strong>
     <span class="koboSpan" id="kobo.440.1">
      : This gives the type of unit conversion to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.441.1">
       be used.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.442.1">
     Once manipulated and transformed, a meter might follow its path via one of the multiple
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.443.1">
      publisher types:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.444.1">
       Notifier
      </span>
     </strong>
     <span class="koboSpan" id="kobo.445.1">
      : This is the meter data pushed over a reliable
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.446.1">
       messaging queue.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.447.1">
       rpc
      </span>
     </strong>
     <span class="koboSpan" id="kobo.448.1">
      : This is the synchronous RPC meter
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.449.1">
       data publisher.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.450.1">
       udp
      </span>
     </strong>
     <span class="koboSpan" id="kobo.451.1">
      : This is the meter data sent over
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.452.1">
       the UDP.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.453.1">
       file
      </span>
     </strong>
     <span class="koboSpan" id="kobo.454.1">
      : This is the meter data sent into
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.455.1">
       a file.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.456.1">
     The aforementioned components are illustrated
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.457.1">
      as follows:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer151">
     <span class="koboSpan" id="kobo.458.1">
      <img alt="Figure 8.16 – Metrics data transformation and publishing through metric pipelines" src="image/B21716_08_16.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.459.1">
     Figure 8.16 – Metrics data transformation and publishing through metric pipelines
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.460.1">
     Data collected can be stored in different types of databases supported by Ceilometer.
    </span>
    <span class="koboSpan" id="kobo.460.2">
     Originally, MongoDB was a widely adopted data store for the telemetry metric storage.
    </span>
    <span class="koboSpan" id="kobo.460.3">
     Due to MongoDB’s scalability
    </span>
    <a id="_idIndexMarker804">
    </a>
    <span class="koboSpan" id="kobo.461.1">
     and performance issues, Gnocchi has been evaluated as a well-suited time series database for Ceilometer, which will be covered in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.462.1">
      next section.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-152">
    <a id="_idTextAnchor197">
    </a>
    <span class="koboSpan" id="kobo.463.1">
     The Gnocchi data store
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.464.1">
     Since the Train OpenStack release,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.465.1">
      Gnocchi
     </span>
    </strong>
    <span class="koboSpan" id="kobo.466.1">
     has been considered the default and official supported storage service for Ceilometer.
    </span>
    <span class="koboSpan" id="kobo.466.2">
     Given the performance and scalability issues of former metrics data store options, the introduction of Gnocchi as a time series database has solved main
    </span>
    <a id="_idIndexMarker805">
    </a>
    <span class="koboSpan" id="kobo.467.1">
     bottlenecks issues when processing and storing metrics
    </span>
    <a id="_idIndexMarker806">
    </a>
    <span class="koboSpan" id="kobo.468.1">
     data in large-scale environments.
    </span>
    <span class="koboSpan" id="kobo.468.2">
     Data samples are no longer written directly into a database.
    </span>
    <span class="koboSpan" id="kobo.468.3">
     Rather, they are converted into Gnocchi elements and posted afterward on its native API.
    </span>
    <span class="koboSpan" id="kobo.468.4">
     Aggregated data is recorded in a time series.
    </span>
    <span class="koboSpan" id="kobo.468.5">
     Each converted sample presents a data point that has a timestamp
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.469.1">
      and measurement.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.470.1">
     The hallmark of data optimization using Gnocchi is indexing resources and their associated attributes.
    </span>
    <span class="koboSpan" id="kobo.470.2">
     As a result, data searches are quicker.
    </span>
    <span class="koboSpan" id="kobo.470.3">
     As mentioned previously, Gnocchi offers a scalable metric storage design by utilizing metric data storage in a scalable storage system, such as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.471.1">
      Swift
     </span>
    </strong>
    <span class="koboSpan" id="kobo.472.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.473.1">
      Ceph
     </span>
    </strong>
    <span class="koboSpan" id="kobo.474.1">
     .
    </span>
    <span class="koboSpan" id="kobo.474.2">
     As shown in the next figure, Gnocchi can be configured to aggregate and store measures in Swift or Ceph as a storage backend, using its built-in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.475.1">
      storage drivers:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer152">
     <span class="koboSpan" id="kobo.476.1">
      <img alt="Figure 8.17 – The Gnocchi data store multi-backend support" src="image/B21716_08_17.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.477.1">
     Figure 8.17 – The Gnocchi data store multi-backend support
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.478.1">
     Data is processed by
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.479.1">
      metricd
     </span>
    </strong>
    <span class="koboSpan" id="kobo.480.1">
     for aggregation and storage.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.481.1">
      metricd
     </span>
    </strong>
    <span class="koboSpan" id="kobo.482.1">
     handles flushing metrics marked for deletion.
    </span>
    <span class="koboSpan" id="kobo.482.2">
     Gnocchi
    </span>
    <a id="_idIndexMarker807">
    </a>
    <span class="koboSpan" id="kobo.483.1">
     provides a compatible
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.484.1">
      statsd
     </span>
    </strong>
    <span class="koboSpan" id="kobo.485.1">
     protocol (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.486.1">
      gnocchi-statsd
     </span>
    </strong>
    <span class="koboSpan" id="kobo.487.1">
     ) that listens to the incoming metrics.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.488.1">
      statsd
     </span>
    </strong>
    <span class="koboSpan" id="kobo.489.1">
     will be used later for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.490.1">
      Gnocchi deployment.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-153">
    <a id="_idTextAnchor198">
    </a>
    <span class="koboSpan" id="kobo.491.1">
     Alerting with Aodh
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.492.1">
     Since the Liberty release, the Ceilometer alarm module has been forked and renamed to
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.493.1">
      Aodh
     </span>
    </strong>
    <span class="koboSpan" id="kobo.494.1">
     , which takes the lead in triggering alarms based on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.495.1">
      custom rules.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.496.1">
     As shown in the
    </span>
    <a id="_idIndexMarker808">
    </a>
    <span class="koboSpan" id="kobo.497.1">
     following diagram, a significant difference can be noticed when comparing the current alarm service to Ceilometer’s preceding one – the ability to scale horizontally
    </span>
    <a id="_idIndexMarker809">
    </a>
    <span class="koboSpan" id="kobo.498.1">
     when hitting more load.
    </span>
    <span class="koboSpan" id="kobo.498.2">
     Using the same messaging queue, Aodh exposes an event listener that catches new notifications and provides an instant response time, with zero latency.
    </span>
    <span class="koboSpan" id="kobo.498.3">
     Aodh listeners rely on predefined alarms that will trigger instantly based on events and configured measures.
    </span>
    <span class="koboSpan" id="kobo.498.4">
     In this case, reacting against auto-scaling conditions when using an orchestration service (e.g.,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.499.1">
      Heat
     </span>
    </strong>
    <span class="koboSpan" id="kobo.500.1">
     ) becomes
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.501.1">
      very useful:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer153">
     <span class="koboSpan" id="kobo.502.1">
      <img alt="Figure 8.18 – An Aodh alarm overview in OpenStack" src="image/B21716_08_18.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.503.1">
     Figure 8.18 – An Aodh alarm overview in OpenStack
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.504.1">
     Aodh is constructed mainly by an API server (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.505.1">
      aodh-api
     </span>
    </strong>
    <span class="koboSpan" id="kobo.506.1">
     ) that provides access to the data store.
    </span>
    <span class="koboSpan" id="kobo.506.2">
     The Aodh alarm evaluator (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.507.1">
      aodh-evaluator
     </span>
    </strong>
    <span class="koboSpan" id="kobo.508.1">
     ) triggers alarms, based on the collected statistical trends crossing a threshold within a certain period.
    </span>
    <span class="koboSpan" id="kobo.508.2">
     Alarms are triggered by an Aodh notification listener (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.509.1">
      aodh-listener
     </span>
    </strong>
    <span class="koboSpan" id="kobo.510.1">
     ), based on rules against events reported by the notification agents.
    </span>
    <span class="koboSpan" id="kobo.510.2">
     The Aodh alarm notifier (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.511.1">
      aodh-notifier
     </span>
    </strong>
    <span class="koboSpan" id="kobo.512.1">
     ) enables alarm settings
    </span>
    <a id="_idIndexMarker810">
    </a>
    <span class="koboSpan" id="kobo.513.1">
     based on the threshold for a collection
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.514.1">
      of samples.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.515.1">
     Aodh notification supports both event- and threshold-based alarms.
    </span>
    <span class="koboSpan" id="kobo.515.2">
     In the latest OpenStack releases, Aodh queries measurements by default from the Gnocchi
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.516.1">
      data store.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-154">
    <a id="_idTextAnchor199">
    </a>
    <span class="koboSpan" id="kobo.517.1">
     Deploying the telemetry service
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.518.1">
     The current
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.519.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.520.1">
     repository supports a
    </span>
    <a id="_idIndexMarker811">
    </a>
    <span class="koboSpan" id="kobo.521.1">
     full deployment of the telemetry service in OpenStack.
    </span>
    <span class="koboSpan" id="kobo.521.2">
     This includes the Ceilometer, Aodh, and Gnocchi services.
    </span>
    <span class="koboSpan" id="kobo.521.3">
     As we have already deployed the Ceilometer service in
    </span>
    <a href="B21716_03.xhtml#_idTextAnchor108">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.522.1">
        Chapter 3
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.523.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.524.1">
      OpenStack Control Plane – Shared Services
     </span>
    </em>
    <span class="koboSpan" id="kobo.525.1">
     , we will walk through a detailed configuration of the Ansible roles for the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.526.1">
      telemetry stack:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.527.1">
      Make sure the Ceilometer service is added to run it as part of the cloud controller nodes if it is
     </span>
     <a id="_idIndexMarker812">
     </a>
     <span class="koboSpan" id="kobo.528.1">
      not enabled by adding it to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.529.1">
       multi_packtpub_prod
      </span>
     </strong>
     <span class="koboSpan" id="kobo.530.1">
      inventory file,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.531.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.532.1">
...
</span><span class="koboSpan" id="kobo.532.2">[ceilometer:children]
control</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.533.1">
      Add the Ceilometer central polling and notification agents to the cloud
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.534.1">
       controller group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.535.1">
...
</span><span class="koboSpan" id="kobo.535.2">[ceilometer-central:children]
ceilometer
[ceilometer-notification:children]
ceilometer</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.536.1">
      Add the ceilometer polling agent for the compute
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.537.1">
       nodes group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.538.1">
...
</span><span class="koboSpan" id="kobo.538.2">[ceilometer-compute:children]
compute</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.539.1">
      Run the Gnocchi service as part of the cloud controller
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.540.1">
       nodes group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.541.1">
...
</span><span class="koboSpan" id="kobo.541.2">[gnocchi:children]
control</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.542.1">
      Assign the Gnocchi components, including the API,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.543.1">
       statsd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.544.1">
      (the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.545.1">
       gnocchi-statsd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.546.1">
      daemon), and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.547.1">
       metricd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.548.1">
      (the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.549.1">
       gnocchi-metricd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.550.1">
      daemon) services, to run as part of the Gnocchi instance in the cloud controller
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.551.1">
       nodes group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.552.1">
...
</span><span class="koboSpan" id="kobo.552.2">[gnocchi-api:children]
gnocchi
[gnocchi-statsd:children]
gnocchi
[gnocchi-metricd:children]
gnocchi</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.553.1">
      Run the Aodh alarm service as part of the cloud controller
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.554.1">
       nodes group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.555.1">
...
</span><span class="koboSpan" id="kobo.555.2">[aodh:children]
control</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.556.1">
      Assign the Aodh components, including the API, evaluator, listener, and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.557.1">
       notifier
      </span>
     </strong>
     <span class="koboSpan" id="kobo.558.1">
      services, to
     </span>
     <a id="_idIndexMarker813">
     </a>
     <span class="koboSpan" id="kobo.559.1">
      run as part of the Aodh instance in the cloud controller
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.560.1">
       nodes group:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.561.1">
...
</span><span class="koboSpan" id="kobo.561.2">[aodh-api:children]
aodh
[aodh-evaluator:children]
aodh
[aodh-listener:children]
aodh
[aodh-notifier:children]
aodh</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.562.1">
      Next, make sure the Ceilometer service is enabled in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.563.1">
        globals.yml
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.564.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.565.1">
...
</span><span class="koboSpan" id="kobo.565.2">enable_ceilometer: "yes"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.566.1">
      Enable the Gnocchi service in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.567.1">
       globals.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.568.1">
      file and, optionally, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.569.1">
       statsd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.570.1">
      protocol support that will install and run the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.571.1">
        gnocchi-statd
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.572.1">
       daemon:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.573.1">
...
</span><span class="koboSpan" id="kobo.573.2">enable_gnocchi: "yes"
enable_gnocchi_statsd: "yes"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.574.1">
      The last configuration in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.575.1">
       globals.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.576.1">
      file is to enable the Aodh alerting service by setting its corresponding variable
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.577.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.578.1">
        yes
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.579.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.580.1">
...
</span><span class="koboSpan" id="kobo.580.2">enable_aodh: "yes"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.581.1">
      Run the deployment
     </span>
     <a id="_idIndexMarker814">
     </a>
     <span class="koboSpan" id="kobo.582.1">
      pipeline and make sure that no errors have been reported when installing the telemetry service.
     </span>
     <span class="koboSpan" id="kobo.582.2">
      Verify that the telemetry service containers are up and running in one of the cloud controller nodes using the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.583.1">
       command line:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.584.1">$ docker ps -a | grep -e ceilometer -e gnocchi -e aodh</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.585.1">
       This is the output
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.586.1">
        we get:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer154">
     <span class="koboSpan" id="kobo.587.1">
      <img alt="Figure 8.19 – A listing of the deployed telemetry Kolla containers" src="image/B21716_08_19.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.588.1">
     Figure 8.19 – A listing of the deployed telemetry Kolla containers
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.589.1">
     Once the trio of Ceilometer, Gnocchi, and Aodh are joined to the OpenStack deployment, you should have a fully functional telemetry service.
    </span>
    <span class="koboSpan" id="kobo.589.2">
     Navigating through Ceilometer metrics is straightforward and can be used to configure alarms via Aodh.
    </span>
    <span class="koboSpan" id="kobo.589.3">
     Metrics and alarms are essential elements to tackle daily monitoring operations.
    </span>
    <span class="koboSpan" id="kobo.589.4">
     However, even these would not be sufficient without the addition of service logs, which we will cover in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.590.1">
      next section.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-155">
    <a id="_idTextAnchor200">
    </a>
    <span class="koboSpan" id="kobo.591.1">
     Grasping centralized logging
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.592.1">
     The second essential part of operating an OpenStack cloud environment is to embrace the inspection of events in the infrastructure through logging information.
    </span>
    <span class="koboSpan" id="kobo.592.2">
     With dozens of deployed services involved in the OpenStack setup, cloud operators should enable logging in each service, running at least within the control plane for troubleshooting, analysis, and even creating
    </span>
    <a id="_idIndexMarker815">
    </a>
    <span class="koboSpan" id="kobo.593.1">
     custom metrics for alerting.
    </span>
    <span class="koboSpan" id="kobo.593.2">
     Depending on the OpenStack deployment tool and configuration settings used, the standard services in Linux/Unix systems write their logs in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.594.1">
      /var/log/
     </span>
    </strong>
    <span class="koboSpan" id="kobo.595.1">
     directory
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.596.1">
      and subdirectories.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.597.1">
     With the tons of log data generated, parsing and processing it all presents a hindrance to extracting meaningful information or troubleshooting unexpected issues, which take a longer time to solve.
    </span>
    <span class="koboSpan" id="kobo.597.2">
     To overcome such a challenge, your log environment must evolve to become centralized.
    </span>
    <span class="koboSpan" id="kobo.597.3">
     A good option is to start flowing logs in a dedicated
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.598.1">
      rsyslog
     </span>
    </strong>
    <span class="koboSpan" id="kobo.599.1">
     server.
    </span>
    <span class="koboSpan" id="kobo.599.2">
     You might put in so much data that your log server starts starving for larger storage capacity.
    </span>
    <span class="koboSpan" id="kobo.599.3">
     Furthermore, archiving the aforementioned data will not be useful when you need to extract information for a particular context.
    </span>
    <span class="koboSpan" id="kobo.599.4">
     Additionally, correlating log data that has different formats (taking into consideration the RabbitMQ and MySQL logs) with generated events might even be impossible.
    </span>
    <span class="koboSpan" id="kobo.599.5">
     So, what we need at this point is a set of quality requirements for a good OpenStack logging experience,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.600.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.601.1">
      A parsing capability for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.602.1">
       log metadata
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.603.1">
      Fast indexing of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.604.1">
       log data
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.605.1">
      A comprehensible presentation
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.606.1">
       of data
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.607.1">
      Metrics constructed from custom log
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.608.1">
       data aggregations
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.609.1">
     Generated logs in OpenStack are structured, making them suitable for processing, and can be parsed by several tools, including the open-source
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.610.1">
      ELK
     </span>
    </strong>
    <span class="koboSpan" id="kobo.611.1">
     stack, which is composed of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.612.1">
      Elasticsearch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.613.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.614.1">
      Logstash
     </span>
    </strong>
    <span class="koboSpan" id="kobo.615.1">
     , and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.616.1">
      Kibana
     </span>
    </strong>
    <span class="koboSpan" id="kobo.617.1">
     , or even by commercial third-party tools, such as Datadog and Splunk.
    </span>
    <span class="koboSpan" id="kobo.617.2">
     ELK is the
    </span>
    <a id="_idIndexMarker816">
    </a>
    <span class="koboSpan" id="kobo.618.1">
     most adopted tool as a logging pipeline in large OpenStack deployments.
    </span>
    <span class="koboSpan" id="kobo.618.2">
     Most OpenStack deployment tools, other than
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.619.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.620.1">
     , are supported by an ELK stack installation out of the box.
    </span>
    <span class="koboSpan" id="kobo.620.2">
     Although the ELK stack is still a valid option to manage logs in OpenStack, the latest OpenStack releases have shifted gears to adopt a forked open-source Elasticsearch solution, and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.621.1">
      OpenSearch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.622.1">
     was announced as the new way to handle logging in the next
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.623.1">
      OpenStack operations.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-156">
    <a id="_idTextAnchor201">
    </a>
    <span class="koboSpan" id="kobo.624.1">
     OpenSearch under the hood
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.625.1">
     OpenSearch is an open-source software offered under the Apache version 2.0 license.
    </span>
    <span class="koboSpan" id="kobo.625.2">
     It has become a very popular search
    </span>
    <a id="_idIndexMarker817">
    </a>
    <span class="koboSpan" id="kobo.626.1">
     engine and log analytics suite, due to its large community and active commits, and originated from the Elasticsearch project.
    </span>
    <span class="koboSpan" id="kobo.626.2">
     The OpenSearch suite includes a search engine, data store, and dashboards for
    </span>
    <a id="_idIndexMarker818">
    </a>
    <span class="koboSpan" id="kobo.627.1">
     visualizations, which originated from Kibana.
    </span>
    <span class="koboSpan" id="kobo.627.2">
     The OpenSearch architecture is based on a distributed design, where different components can run in different cluster nodes.
    </span>
    <span class="koboSpan" id="kobo.627.3">
     The following diagram shows an overview of a logging solution based on OpenSearch
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.628.1">
      for OpenStack:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer155">
     <span class="koboSpan" id="kobo.629.1">
      <img alt="Figure 8.20 – An overview of the OpenSearch logging cluster in an OpenStack environment" src="image/B21716_08_20.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.630.1">
     Figure 8.20 – An overview of the OpenSearch logging cluster in an OpenStack environment
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.631.1">
     As shown in the previous diagram, a typical OpenSearch environment for mid to large deployments consists of a variety of cluster node roles, such as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.632.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.633.1">
       The cluster manager node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.634.1">
      : This keeps track of the
     </span>
     <a id="_idIndexMarker819">
     </a>
     <span class="koboSpan" id="kobo.635.1">
      OpenSearch formation cluster state, including node state changes (i.e., joiners and leavers) and health, indexing management, and shard allocation.
     </span>
     <span class="koboSpan" id="kobo.635.2">
      For high availability reasoning, it is recommended to run at least two manager nodes for production
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.636.1">
       use cases.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.637.1">
       The coordinator node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.638.1">
      : This receives
     </span>
     <a id="_idIndexMarker820">
     </a>
     <span class="koboSpan" id="kobo.639.1">
      requests initiated
     </span>
     <a id="_idIndexMarker821">
     </a>
     <span class="koboSpan" id="kobo.640.1">
      from a dashboard or client libraries and delegates
     </span>
     <a id="_idIndexMarker822">
     </a>
     <span class="koboSpan" id="kobo.641.1">
      them to the right shards on the data nodes, and then fetches, aggregates, and returns the data results to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.642.1">
       the client.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.643.1">
       The data source node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.644.1">
      : This represents
     </span>
     <a id="_idIndexMarker823">
     </a>
     <span class="koboSpan" id="kobo.645.1">
      the worker horses of the OpenSearch cluster that store the data and perform different data-related operations, including indexing, aggregation,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.646.1">
       and searching.
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.647.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.648.1">
     Other types, including the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.649.1">
      master-eligible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.650.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.651.1">
      ingest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.652.1">
     nodes, can
    </span>
    <a id="_idIndexMarker824">
    </a>
    <span class="koboSpan" id="kobo.653.1">
     form part of an OpenSearch formation cluster.
    </span>
    <span class="koboSpan" id="kobo.653.2">
     Any
    </span>
    <a id="_idIndexMarker825">
    </a>
    <span class="koboSpan" id="kobo.654.1">
     node that is not marked as a master is designated with a master-eligible role.
    </span>
    <span class="koboSpan" id="kobo.654.2">
     Ingest nodes are recommended for heavy data ingestion pipelines and to offload indexing workloads from
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.655.1">
      data nodes.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.656.1">
     OpenSearch is highly extensible, and several types of plugins can be installed for an enhanced search experience, security features, machine learning, and performance analysis.
    </span>
    <span class="koboSpan" id="kobo.656.2">
     The available plugins are listed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.657.1">
      at
     </span>
    </span>
    <a href="https://opensearch.org/docs/latest/install-and-configure/plugins/#available-plugins">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.658.1">
       https://opensearch.org/docs/latest/install-and-configure/plugins/#available-plugins
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.659.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.660.1">
     The OpenSearch solution comes with a distributed architecture, enabling you to scale for large search and analytics operations.
    </span>
    <span class="koboSpan" id="kobo.660.2">
     Niche features are supported by the OpenSearch core search service, making it easy to run log analytics, data ingestion, and observability capabilities.
    </span>
    <span class="koboSpan" id="kobo.660.3">
     Additionally, performance has become a valid reason to adopt OpenSearch, due to additional ways to handle shards across multiple nodes that speed up the search operation.
    </span>
    <span class="koboSpan" id="kobo.660.4">
     The amount of data generated by different OpenStack and common infrastructure services can be immense and can be fed into an OpenSearch cluster formation.
    </span>
    <span class="koboSpan" id="kobo.660.5">
     By providing a minimum size of an OpenSearch cluster, cloud operators can start exploring a rich search and visualization experience.
    </span>
    <span class="koboSpan" id="kobo.660.6">
     This enables you to create visualizations to spot the malfunctioning parts of complex and large systems that are hard to detect with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.661.1">
      basic metrics.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-157">
    <a id="_idTextAnchor202">
    </a>
    <span class="koboSpan" id="kobo.662.1">
     Deploying OpenSearch
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.663.1">
     At the time of writing this edition,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.664.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.665.1">
     supports OpenSearch installation.
    </span>
    <span class="koboSpan" id="kobo.665.2">
     The community recommends the adoption of the OpenSearch option, which can be deployed in a few steps.
    </span>
    <span class="koboSpan" id="kobo.665.3">
     It is highly recommended to dedicate a logging cluster that runs
    </span>
    <a id="_idIndexMarker826">
    </a>
    <span class="koboSpan" id="kobo.666.1">
     different OpenSearch node types, as covered in the previous section.
    </span>
    <span class="koboSpan" id="kobo.666.2">
     Other considerations should be taken for each OpenSearch node requirement so that you can tailor your logging cluster, based on the required performance.
    </span>
    <span class="koboSpan" id="kobo.666.3">
     For example, data nodes would require more disk space and could be upgraded with fast disks with
    </span>
    <a id="_idIndexMarker827">
    </a>
    <span class="koboSpan" id="kobo.667.1">
     higher IOPS, such as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.668.1">
      solid-state drives
     </span>
    </strong>
    <span class="koboSpan" id="kobo.669.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.670.1">
      SSDs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.671.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.671.2">
     Master and coordinating nodes are more demanding computers that can be deployed with higher CPU power.
    </span>
    <span class="koboSpan" id="kobo.671.3">
     For the next setup, we will run a simple instance of the OpenSearch service as part of the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.672.1">
      control node:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.673.1">
      Assign the OpenSearch engine and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.674.1">
       dashboards
      </span>
     </strong>
     <span class="koboSpan" id="kobo.675.1">
      roles to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.676.1">
       control node:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.677.1">
...
</span><span class="koboSpan" id="kobo.677.2">[opensearch:children]
control
[opensearch-dashboards:children]
opensearch</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.678.1">
      Change the following variable in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.679.1">
       globals.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.680.1">
      file to install OpenSearch as a central
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.681.1">
       logging service:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.682.1">
...
</span><span class="koboSpan" id="kobo.682.2">enable_central_logging: "yes"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.683.1">
      By default, Kolla deploys the OpenSearch service to listen on port
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.684.1">
       9200
      </span>
     </strong>
     <span class="koboSpan" id="kobo.685.1">
      .
     </span>
     <span class="koboSpan" id="kobo.685.2">
      When deployed in the controller nodes, OpenSearch Dashboards should be accessible via the reserved VIP assigned to Keepalived to run the cloud controller clusters.
     </span>
     <span class="koboSpan" id="kobo.685.3">
      Optionally, you can assign an FQDN and populate the hostname internally across all OpenStack nodes.
     </span>
     <span class="koboSpan" id="kobo.685.4">
      The dashboards can be accessed with a browser internally on port
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.686.1">
       5601
      </span>
     </strong>
     <span class="koboSpan" id="kobo.687.1">
      and the configured
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.688.1">
       kolla_internal_fqdn
      </span>
     </strong>
     <span class="koboSpan" id="kobo.689.1">
      variable set in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.690.1">
       globals.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.691.1">
      file that points to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.692.1">
       kolla_internal_vip_address
      </span>
     </strong>
     <span class="koboSpan" id="kobo.693.1">
      variable.
     </span>
     <span class="koboSpan" id="kobo.693.2">
      Make sure that at least the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.694.1">
       kolla_internal_vip_address
      </span>
     </strong>
     <span class="koboSpan" id="kobo.695.1">
      variable is set to the VIP address or mapped DNS
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.696.1">
       endpoint name:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.697.1">
kolla_internal_vip_address: "10.0.0.47"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.698.1">
      OpenStack dashboards
     </span>
     <a id="_idIndexMarker828">
     </a>
     <span class="koboSpan" id="kobo.699.1">
      are created with the default
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.700.1">
       'opensearch'
      </span>
     </strong>
     <span class="koboSpan" id="kobo.701.1">
      username, and the password can be edited in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.702.1">
       kolla-ansible/etc/kolla/passwords.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.703.1">
      file by setting the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.704.1">
       following variable:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.705.1">
opensearch_dashboards_password: 'openstestpass'</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.706.1">
      Other advanced and useful configurations that can be performed in advance to address common OpenSearch operation settings are the log retention policies, which are critical when dealing with disk-size management, data rotation, and the life cycle.
     </span>
     <span class="koboSpan" id="kobo.706.2">
      OpenSearch comes
     </span>
     <a id="_idIndexMarker829">
     </a>
     <span class="koboSpan" id="kobo.707.1">
      with an
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.708.1">
       Index State Management
      </span>
     </strong>
     <span class="koboSpan" id="kobo.709.1">
      plugin to manage data rotation through the definition of log retention policies.
     </span>
     <span class="koboSpan" id="kobo.709.2">
      Make sure that is enabled in the Ansible OpenSearch role defined in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.710.1">
       ansible/roles/opensearch/defaults/main.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.711.1">
      file by checking the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.712.1">
       following variable:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.713.1">
opensearch_apply_log_retention_policy: true</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.714.1">
      Once enabled, OpenSearch provides an indices data life cycle by defining the soft and hard retention periods.
     </span>
     <span class="koboSpan" id="kobo.714.2">
      The soft retention period is defined by the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.715.1">
       opensearch_soft_retention_period_days
      </span>
     </strong>
     <span class="koboSpan" id="kobo.716.1">
      variable in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.717.1">
       ansible/roles/opensearch/defaults/main.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.718.1">
      file where indices are closed, no longer active, and staged for deletion, but they still occupy space on the disk and can be reopened.
     </span>
     <span class="koboSpan" id="kobo.718.2">
      The hard retention period is the duration after which indices are deleted permanently and no longer occupy a space on the disk.
     </span>
     <span class="koboSpan" id="kobo.718.3">
      They are defined by the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.719.1">
       opensearch_hard_retention_period_days
      </span>
     </strong>
     <span class="koboSpan" id="kobo.720.1">
      variable in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.721.1">
       ansible/roles/opensearch/defaults/main.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.722.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.722.2">
      The default soft and hard duration periods are set to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.723.1">
       30
      </span>
     </strong>
     <span class="koboSpan" id="kobo.724.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.725.1">
       60
      </span>
     </strong>
     <span class="koboSpan" id="kobo.726.1">
      , respectively.
     </span>
     <span class="koboSpan" id="kobo.726.2">
      That can be edited either by creating new variables in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.727.1">
       globals.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.728.1">
      file and referencing them in the OpenSearch playbook, or directly in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.729.1">
       ansible/roles/opensearch/defaults/main.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.730.1">
      file by changing the soft duration to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.731.1">
       45
      </span>
     </strong>
     <span class="koboSpan" id="kobo.732.1">
      and the hard one to
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.733.1">
        90
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.734.1">
       days:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.735.1">
opensearch_soft_retention_period_days: "{{ elasticsearch_curator_soft_retention_period_days | default(45) }}"
opensearch_hard_retention_period_days: "{{ elasticsearch_curator_hard_retention_period_days | default(90) }}"</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.736.1">
      Run the pipeline and ensure
     </span>
     <a id="_idIndexMarker830">
     </a>
     <span class="koboSpan" id="kobo.737.1">
      that the output does not contain errors in the job configuration.
     </span>
     <span class="koboSpan" id="kobo.737.2">
      After completion, run the following command line to validate the additional
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.738.1">
       Kolla containers:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.739.1">$ docker ps –a | grep –e opensearch</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.740.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.741.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer156">
     <span class="koboSpan" id="kobo.742.1">
      <img alt="Figure 8.21 – Listing of OpenSearch Kolla containers" src="image/B21716_08_21.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.743.1">
     Figure 8.21 – Listing of OpenSearch Kolla containers
    </span>
   </p>
   <ol>
    <li value="8">
     <span class="koboSpan" id="kobo.744.1">
      Point to the OpenSearch Dashboards URL from a browser at
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.745.1">
       http://10.0.0.47:5601
      </span>
     </strong>
     <span class="koboSpan" id="kobo.746.1">
      .
     </span>
     <span class="koboSpan" id="kobo.746.2">
      Enter the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.747.1">
       'opensearch'
      </span>
     </strong>
     <span class="koboSpan" id="kobo.748.1">
      username and configured password to start a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.749.1">
       log search:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer157">
     <span class="koboSpan" id="kobo.750.1">
      <img alt="Figure 8.22 – The OpenSearch login page" src="image/B21716_08_22.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.751.1">
     Figure 8.22 – The OpenSearch login page
    </span>
   </p>
   <ol>
    <li value="9">
     <span class="koboSpan" id="kobo.752.1">
      To start searching logs after the first login, an index pattern must be created to pull data from the logs’ sources.
     </span>
     <span class="koboSpan" id="kobo.752.2">
      The index pattern points to a specific index that can pull log data from a
     </span>
     <a id="_idIndexMarker831">
     </a>
     <span class="koboSpan" id="kobo.753.1">
      specific date, for example.
     </span>
     <span class="koboSpan" id="kobo.753.2">
      From the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.754.1">
       OpenSearch Dashboards
      </span>
     </strong>
     <span class="koboSpan" id="kobo.755.1">
      panel, click on the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.756.1">
       Index Patterns
      </span>
     </strong>
     <span class="koboSpan" id="kobo.757.1">
      button,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.758.1">
       as follows:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer158">
     <span class="koboSpan" id="kobo.759.1">
      <img alt="Figure 8.23 – Creating index patterns in the OpenSearch dashboard" src="image/B21716_08_23.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.760.1">
     Figure 8.23 – Creating index patterns in the OpenSearch dashboard
    </span>
   </p>
   <ol>
    <li value="10">
     <span class="koboSpan" id="kobo.761.1">
      Next, specify the index pattern settings by applying a filter to pull and aggregate data.
     </span>
     <span class="koboSpan" id="kobo.761.2">
      In the current example, the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.762.1">
       timestamp
      </span>
     </strong>
     <span class="koboSpan" id="kobo.763.1">
      filter will be applied.
     </span>
     <span class="koboSpan" id="kobo.763.2">
      By default, OpenSearch associates a unique identifier to each index pattern,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.764.1">
       as follows:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer159">
     <span class="koboSpan" id="kobo.765.1">
      <img alt="Figure 8.24 – Applying a filter for the index pattern" src="image/B21716_08_24.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.766.1">
     Figure 8.24 – Applying a filter for the index pattern
    </span>
   </p>
   <ol>
    <li value="11">
     <span class="koboSpan" id="kobo.767.1">
      Once created, the index pattern will apply the filter to the source data and visualize the field’s mapped core type, as saved by OpenSearch.
     </span>
     <span class="koboSpan" id="kobo.767.2">
      For example, the created index pattern references a set of fields that are visible in the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.768.1">
       Discover
      </span>
     </strong>
     <span class="koboSpan" id="kobo.769.1">
      tab on the upper side of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.770.1">
       the dashboard:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer160">
     <span class="koboSpan" id="kobo.771.1">
      <img alt="Figure 8.25 – Listing the field selection for the index pattern" src="image/B21716_08_25.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.772.1">
     Figure 8.25 – Listing the field selection for the index pattern
    </span>
   </p>
   <ol>
    <li value="12">
     <span class="koboSpan" id="kobo.773.1">
      Logs can be filtered using the search bar in the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.774.1">
       Discover
      </span>
     </strong>
     <span class="koboSpan" id="kobo.775.1">
      panel, which lists all the associated events
     </span>
     <a id="_idIndexMarker832">
     </a>
     <span class="koboSpan" id="kobo.776.1">
      ending with a time frame, as shown in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.777.1">
       following figure:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer161">
     <span class="koboSpan" id="kobo.778.1">
      <img alt="Figure 8.26 – Applying time frames for logs filtering" src="image/B21716_08_26.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.779.1">
     Figure 8.26 – Applying time frames for logs filtering
    </span>
   </p>
   <ol>
    <li value="13">
     <span class="koboSpan" id="kobo.780.1">
      Further filtering can be applied using the search filters bar.
     </span>
     <span class="koboSpan" id="kobo.780.2">
      In the following example, an added filter is applied to pull all data with an
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.781.1">
       ERROR
      </span>
     </strong>
     <span class="koboSpan" id="kobo.782.1">
      value in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.783.1">
        log_level
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.784.1">
       field:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer162">
     <span class="koboSpan" id="kobo.785.1">
      <img alt="Figure 8.27 – Applying a log_level filter for log filtering" src="image/B21716_08_27.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.786.1">
     Figure 8.27 – Applying a log_level filter for log filtering
    </span>
   </p>
   <p class="list-inset">
    <span class="koboSpan" id="kobo.787.1">
     To quickly monitor the trend of the pulled data with a specific filter, it is important to use the power of OpenSearch’s visualization capability.
    </span>
    <span class="koboSpan" id="kobo.787.2">
     With a rich variety of supported dashboard objects, operators can build different types of visualizations for each search-filtered query.
    </span>
    <span class="koboSpan" id="kobo.787.3">
     To create a visualization, point to the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.788.1">
      Visualize
     </span>
    </strong>
    <span class="koboSpan" id="kobo.789.1">
     tab and click on the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.790.1">
      Create Visualization
     </span>
    </strong>
    <span class="koboSpan" id="kobo.791.1">
     button.
    </span>
    <span class="koboSpan" id="kobo.791.2">
     From the returned list, the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.792.1">
      Vertical Bar Chart
     </span>
    </strong>
    <span class="koboSpan" id="kobo.793.1">
     visualization type is selected to expose the collected error occurrences in the last hour from the last saved query search.
    </span>
    <span class="koboSpan" id="kobo.793.2">
     Once created, a new graph is generated that can be broken up into more specific fields, referred to as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.794.1">
      Buckets
     </span>
    </strong>
    <span class="koboSpan" id="kobo.795.1">
     .
    </span>
    <span class="koboSpan" id="kobo.795.2">
     Data graph aggregation can be performed by adding, for
    </span>
    <a id="_idIndexMarker833">
    </a>
    <span class="koboSpan" id="kobo.796.1">
     example, a bucket in the created graph settings and selecting the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.797.1">
      X-axis
     </span>
    </strong>
    <span class="koboSpan" id="kobo.798.1">
     option.
    </span>
    <span class="koboSpan" id="kobo.798.2">
     As shown in the next example, the data aggregation is fixed with the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.799.1">
      Date Histogram
     </span>
    </strong>
    <span class="koboSpan" id="kobo.800.1">
     type, with the default
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.801.1">
      @
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.802.1">
       timestamp
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.803.1">
      field:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer163">
     <span class="koboSpan" id="kobo.804.1">
      <img alt="Figure 8.28 – Data aggregation using OpenSearch buckets" src="image/B21716_08_28.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.805.1">
     Figure 8.28 – Data aggregation using OpenSearch buckets
    </span>
   </p>
   <ol>
    <li value="14">
     <span class="koboSpan" id="kobo.806.1">
      Once updated, a generic overview of the error rate across all pulled log data can be visualized in a single pane
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.807.1">
       of glass:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer164">
     <span class="koboSpan" id="kobo.808.1">
      <img alt="Figure 8.29 – The log visualization dashboard based on the applied filters" src="image/B21716_08_29.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.809.1">
     Figure 8.29 – The log visualization dashboard based on the applied filters
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.810.1">
     OpenSearch dashboards are highly customizable so that more data aggregation can be performed for more granular data presentation.
    </span>
    <span class="koboSpan" id="kobo.810.2">
     For example, the previous graph representation can be saved in
    </span>
    <a id="_idIndexMarker834">
    </a>
    <span class="koboSpan" id="kobo.811.1">
     a dedicated service state dashboard, and then you can add a new visualization from the same graph by exposing the errors for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.812.1">
      each service.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-158">
    <a id="_idTextAnchor203">
    </a>
    <span class="koboSpan" id="kobo.813.1">
     Summary
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.814.1">
     This chapter covered two essential practices for operating an OpenStack environment, exploring the possible ways to monitor and log.
    </span>
    <span class="koboSpan" id="kobo.814.2">
     Both deployed monitoring and logging stacks can vary from one setup to another, depending on the operator’s experience and their familiarity with a specific tool, or some other third-party solutions.
    </span>
    <span class="koboSpan" id="kobo.814.3">
     One of the best practices is to always monitor what is happening under and on top of the cloud platform, providing the necessary ways to capture metrics and collect data before it reaches a higher severity level and you have to start dealing with incidents.
    </span>
    <span class="koboSpan" id="kobo.814.4">
     Prometheus, as demonstrated throughout this chapter, provides a multitude of configurations, and with the simple integration of exporters, cloud operators can easily ship metrics in an automated fashion.
    </span>
    <span class="koboSpan" id="kobo.814.5">
     A single pane, Grafana, centralizes all the metrics in comprehensive dashboards, and operators can closely observe different system elements’ trends.
    </span>
    <span class="koboSpan" id="kobo.814.6">
     The OpenStack telemetry service, commonly referred to as the Ceilometer, Aodh, and Gnocchi trio, was covered and deployed to start charging and tracking resource usage for tenants.
    </span>
    <span class="koboSpan" id="kobo.814.7">
     At the end of the chapter, the logging pipeline challenge was explored, as well as a widely adopted solution, OpenSearch, that enables the consolidation of the immense amount of generated logs in each corner of OpenStack, where you can explore suspicious events to remediate them proactively.
    </span>
    <span class="koboSpan" id="kobo.814.8">
     Logs provide valuable information if combined in a robust pipeline for analysis, and cloud operators can identify anomalies that are hard to detect with simple metrics.
    </span>
    <span class="koboSpan" id="kobo.814.9">
     Early detection of signs of failure can help to evaluate cloud infrastructure performance and provide feedback, enhancing an environment’s services to keep up with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.815.1">
      promised SLA.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.816.1">
     Besides setting a logging pipeline, the next chapter will cover how to conduct benchmarking to gain more insights into the OpenStack infrastructure and evaluating the private
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.817.1">
      cloud capacity.
     </span>
    </span>
   </p>
  </div>
 </body></html>