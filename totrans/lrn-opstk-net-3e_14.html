<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Advanced Networking Topics</h1>
                </header>
            
            <article>
                
<p>OpenStack Networking provides many networking functions that enable users to develop topologies that best support their applications. While this book focuses on many of the core features of OpenStack Networking, there are times when certain use cases require advanced functionality. In this chapter, we will look at some advanced OpenStack Networking features, including the following:</p>
<ul>
<li>VLAN-aware VMs</li>
<li>BGP Speaker</li>
<li>Network availability zones</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VLAN-aware VMs</h1>
                </header>
            
            <article>
                
<p>VLAN tagging is a method in which a VLAN tag is added to an Ethernet header to help distinguish traffic from multiple networks carried over the same interface. In the architectures described so far in this book, an instance connected to multiple networks has a corresponding interface for each network. This works at small scale, but PCI limitations may cap the number of interfaces that can be attached to an instance. In addition, hot-plugging interfaces to running VMs when attaching new networks may have unexpected results.</p>
<p>The following diagram visualizes the concept of one vNIC per network:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/2b526e8a-0a19-451a-bf9d-6a6449b75d7c.png" style="width:40.58em;height:25.50em;"/></div>
<div class="packt_figure packt_figref CDPAlignCenter CDPAlign">Figure 14.1</div>
<p>In Figure 14.1, a single vNIC is associated with a Neutron port. Neutron typically performs VLAN tagging at the virtual switch based on the <kbd><span class="CodeInTextPACKT">segmentation_id</span></kbd> provider attribute of the respective VLAN network. In this case, instances are not expected to perform any VLAN tagging themselves and any tagged traffic from the instance may be dropped by the compute node.</p>
<p>The <span class="CodeInTextPACKT">trunk</span> service plugin for Neutron allows VLAN-aware VM instances to tag traffic within the guest operating system, enabling the quick addition and removal of network sub-interfaces and setting up advanced use cases such as <strong>Network Function Virtualization (NFV)</strong>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring the trunk plugin</h1>
                </header>
            
            <article>
                
<p>The <span class="CodeInTextPACKT">trunk</span> service plugin was first introduced in the Newton release of OpenStack Networking and supports both the Open vSwitch and Linux bridge ML2 mechanism drivers. Other drivers may be supported but are outside the scope of this book.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>To install the <span class="CodeInTextPACKT">trunk</span> service plugin, modify the Neutron configuration file on the <kbd>controller</kbd> node hosting the Neutron API service. In this environment, API services are running on <kbd>controller01</kbd>. Append <kbd><span class="CodeInTextPACKT">trunk</span></kbd> to the list of existing service plugins as shown here:</p>
<pre>[DEFAULT]<br/>...<br/>service_plugins = router,<br/>neutron_lbaas.services.loadbalancer.plugin.LoadBalancerPluginv2, trunk </pre>
<div class="packt_tip">Be sure to append to the existing list of plugins, rather than replacing the list contents, to avoid issues with the API and existing network objects.</div>
<p>Close the file and restart the <kbd>neutron-server</kbd> service:</p>
<pre><strong># systemctl restart neutron-server</strong> </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Defining the workflow</h1>
                </header>
            
            <article>
                
<p>Trunking in OpenStack Networking introduces some concepts that are important to the workflow needed when attaching trunks to an instance. Those concepts include the following:</p>
<ul>
<li>Trunks</li>
<li>Parent ports</li>
<li>Sub-ports</li>
</ul>
<p>A <span class="KeyWordPACKT">trunk</span> is an object that binds a parent port to sub-ports.</p>
<p>A <span class="KeyWordPACKT">parent port</span> is a port that is attached to the instance and represents the trunk link from within the guest operating system. The interface looks and feels like a normal interface and inherits the MAC and IP addresses of the parent port. Any traffic sent over the associated interface inside the guest operating system is considered untagged and follows normal Neutron port behavior.</p>
<p>A <span class="KeyWordPACKT">sub-port</span> is associated with a network and subnet and is not directly attached to an instance. Instead, the sub-port is associated with the trunk object. A VLAN sub-interface can be configured within the guest operating system using the properties of the sub-port and network, including a unique MAC address, IP address, and 802.1q VLAN tag. Traffic sent over the sub-interface is tagged by the guest operating system and forwarded through the parent port.</p>
<p>The following diagram visualizes the concept of one vNIC per instance using 802.1q VLAN encapsulation:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/016ba293-12e7-455e-97b9-55aa2158269b.png" style="width:58.83em;height:43.25em;"/></div>
<div class="packt_figure packt_figref CDPAlignCenter CDPAlign">Figure 14.2</div>
<p>In Figure 14.2, a single vNIC is associated with a parent port. The parent port and multiple sub-ports<span class="packt_screen"><span class="packt_screen"> </span></span>are associated with a trunk. Instances can tag traffic using 802.1q encapsulation and the Neutron agent configures the underlying bridges to support this tagged traffic.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>When leveraging trunking within OpenStack, the following workflow should be used:</p>
<ol>
<li>Create networks and subnets for the trunk and sub-ports</li>
<li>Create the trunk</li>
<li>Add sub-ports to the trunk</li>
<li>Launch an instance connected to the trunk</li>
</ol>
<p>Once the instance is active, additional sub-ports can be associated with the trunk and configured within the instance.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Managing trunks in the CLI</h1>
                </header>
            
            <article>
                
<p>The following commands are used to manage trunk objects in the CLI:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Trunk Management Commands</strong></p>
</td>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Description</strong></p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network trunk create</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Create a trunk.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network trunk delete</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Delete a given trunk.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network trunk list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">List trunks that belong to a given project.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network trunk set</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Update properties of a given trunk.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network trunk show</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Show details of a given trunk.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network trunk unset</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Unset properties of a given trunk.</p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating trunks in the CLI</h1>
                </header>
            
            <article>
                
<p>To create a trunk, use the <kbd><span class="CodeInTextPACKT">openstack network trunk create</span></kbd> command shown here:</p>
<pre>openstack network trunk create<br/>[--description &lt;description&gt;]<br/>--parent-port &lt;parent-port&gt;<br/>[--subport &lt;port=,segmentation-type=,segmentation-id=&gt;]<br/>[--enable | --disable]<br/>[--project &lt;project&gt;]<br/>[--project-domain &lt;project-domain&gt;]<br/>&lt;name&gt; </pre>
<p>The <kbd><span class="CodeInTextPACKT">--description</span></kbd> argument is optional and can be used to provide a description for the trunk.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The <span class="CodeInTextPACKT"><kbd>--parent-port</kbd></span> argument is required and is used to associate a parent port with the trunk. The parent port is the port attached to the instance and acts as the trunk within the guest operating system.</p>
<p>The <kbd><span class="CodeInTextPACKT">--subport</span></kbd> argument is optional and is used to associate a sub-port to the trunk. A sub-port corresponds to an <kbd>802.1q</kbd> sub-interface within the guest operating system. If sub-ports are not specified, all tagged traffic from the instance will be dropped.</p>
<p>The <kbd><span class="CodeInTextPACKT">--project</span></kbd> and <kbd><span class="CodeInTextPACKT">--project-domain</span></kbd> arguments are optional and can be used to associate the trunk with a project and/or domain other than the creating project.</p>
<p>The <kbd><span class="CodeInTextPACKT">name</span></kbd> argument is required and can be used to specify a name for the trunk.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deleting trunks in the CLI</h1>
                </header>
            
            <article>
                
<p>To delete a trunk, use the <kbd><span class="CodeInTextPACKT">openstack network trunk delete</span></kbd> command shown here:</p>
<pre>openstack network trunk delete &lt;trunk&gt; [&lt;trunk&gt; ...] </pre>
<p>The <kbd><span class="CodeInTextPACKT">trunk</span></kbd> argument specifies the name or ID or the trunk to delete. Multiple trunks can be deleted simultaneously using a space-separated list.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Listing trunks in the CLI</h1>
                </header>
            
            <article>
                
<p>To list all load balances, use the <kbd><span class="CodeInTextPACKT">openstack network trunk list</span></kbd> command shown here:</p>
<pre>openstack network trunk list </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Showing trunk details in the CLI</h1>
                </header>
            
            <article>
                
<p>To show the details of a trunk, use the <kbd><span class="CodeInTextPACKT">openstack network trunk show</span></kbd> command shown here:</p>
<pre>openstack network trunk show &lt;trunk&gt; </pre>
<p>The <kbd><span class="CodeInTextPACKT">trunk</span></kbd> argument specifies the name or ID or the trunk to show.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Updating a trunk in the CLI</h1>
                </header>
            
            <article>
                
<p>To update the attributes of a trunk, use the <kbd><span class="CodeInTextPACKT">openstack network trunk set</span></kbd> or <kbd><span class="CodeInTextPACKT">openstack network trunk unset</span></kbd> commands shown here:</p>
<pre>openstack network trunk set<br/>[--name &lt;name&gt;]<br/>[--description &lt;description&gt;]<br/>[--subport &lt;port=,segmentation-type=,segmentation-id=&gt;]<br/>[--enable | --disable]<br/>&lt;trunk&gt;<br/><br/>openstack network trunk unset --subport &lt;subport&gt; &lt;trunk&gt; </pre>
<p>The <kbd><span class="CodeInTextPACKT">set</span></kbd> and <kbd><span class="CodeInTextPACKT">unset</span></kbd> commands can be used to add and remove sub-ports from a trunk without impacting the running instance.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Building a trunk</h1>
                </header>
            
            <article>
                
<p>To demonstrate the creation and use of trunks within OpenStack Networking, I have configured the following networks:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e854e11c-e424-4b13-be96-1635d17981e0.png"/></p>
<p>The guest instance will run the Ubuntu 16.04 LTS operating system and will be connected to a single interface.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the parent port</h1>
                </header>
            
            <article>
                
<p><span>The first step to building a functional trunk is to first create the parent port. The parent port should be associated with a network that handles untagged traffic, in other words, the <span class="KeyWordPACKT">native VLAN</span>. With the</span> O<span class="CodeInTextPACKT">penStack</span> client, create a port with the following attributes:</p>
<ul>
<li>Name: <kbd>parent0</kbd></li>
<li>Network: <kbd>GREEN_NET</kbd></li>
</ul>
<p>The following command can be used:</p>
<pre><strong>openstack port create --network GREEN_NET parent0</strong></pre>
<p>The output will resemble the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b1e40bbc-f999-4cf0-b089-43b72cde1022.png" style="width:42.50em;height:34.50em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a sub-port</h1>
                </header>
            
            <article>
                
<p>Sub-ports should be associated with networks that will be tagged using 802.1q VLAN encapsulation inside the instance. Sub-ports are then associated with a trunk and correspond to tagged sub-interfaces within the guest operating system. With the <span class="CodeInTextPACKT">openstack</span> client, create a sub-port with the following attributes:</p>
<ul>
<li><span>Name: <kbd><span class="NormalPACKTChar">child-p0c1</span></kbd></span></li>
<li>Network: <kbd>RED_NET</kbd></li>
</ul>
<p>The following command can be used:</p>
<pre><strong>openstack port create --network RED_NET child-p0c1</strong> </pre>
<p>The output will resemble the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/10da0eb0-4e3d-48e5-9945-a02f779bcdb0.png" style="width:40.25em;height:33.08em;"/></p>
<div class="packt_tip">Like any other port, when a sub-port is created, Neutron dynamically assigns a MAC address. However, when creating VLAN sub-interfaces inside an instance, the sub-interface may inherit the MAC address of the parent interface. This behavior is acceptable since the interfaces are on two different networks and MAC addresses do not pass the Layer 2 boundary. However, it may be problematic from a port security standpoint. When creating sub-interfaces in an instance, you will need to specify the MAC address Neutron assigned for the sub-port or create the sub-port with the same MAC address of the parent port.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a trunk</h1>
                </header>
            
            <article>
                
<p>The last step to building a functional trunk is to create a trunk object and associate parent and sub-ports. The information required for the trunk includes a name, a parent port with segment details, and sub-port(s) with segment details. With the <span class="CodeInTextPACKT">OpenStack</span> client, create a trunk object with the following attributes:</p>
<ul>
<li><span>Name: <kbd><span class="NormalPACKTChar">trunk0</span></kbd></span></li>
<li>Parent port: <kbd>parent0</kbd></li>
<li>Sub-port: <kbd>child-p0c1</kbd></li>
<li>Sub-port VLAN: <kbd>42</kbd></li>
</ul>
<p>The following command can be used:</p>
<pre><strong>openstack network trunk create \<br/></strong><strong>--parent-port parent0 \<br/></strong><strong>--subport port=child-p0c1,segmentation-type=vlan,segmentation-id=42 \<br/></strong><strong>trunk0</strong></pre>
<p>The output will resemble the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/aa517dcc-a558-4a02-9a97-27673fa1a1a4.png" style="width:44.50em;height:17.92em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Booting an instance with a trunk</h1>
                </header>
            
            <article>
                
<p><span>Now that the trunk has been created and associated with a parent and sub-port, an instance can be booted and attached <span class="ItalicsPACKT">only</span> to the parent port. Since a VIF is not being created for the subinterface(s), there's no need to attach them at boot. Logic within Neutron will associate traffic from sub-interfaces inside the instance with the parent interface.</span></p>
<p>The following O<span class="CodeInTextPACKT">penStack</span> command syntax can be used to boot the instance with a parent port attached:</p>
<pre><strong>openstack server create \<br/></strong><strong>--image &lt;image&gt; \<br/></strong><strong>--flavor&lt;flavor&gt; \<br/></strong><strong>--key-name &lt;keypair name&gt; \<br/></strong><strong>--nic port-id=&lt;parent port&gt; \<br/></strong><strong>&lt;name&gt;</strong> </pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e3b8f0b2-7c66-4598-b700-ed0d843018b5.png"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring the instance</h1>
                </header>
            
            <article>
                
<p>Once booted, the instance should be available via the IP address of the parent port and can be accessed from a namespace or workstation if the proper routing is in place. From within the respective <kbd><span class="CodeInTextPACKT">qdhcp</span></kbd> namespace, confirm connectivity to the instance:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4a461357-f987-47b7-97b1-e62eef974d4a.png"/></p>
<p>The <kbd><span class="CodeInTextPACKT">ip addr list</span></kbd> command confirms the IP address of the parent port has been configured by DHCP, and our ability to connect to the instance demonstrates traffic over the parent port of the trunk is untagged and behaves like an ordinary port.</p>
<p>Using utilities from the <kbd><span class="CodeInTextPACKT">iproute2</span></kbd> package, we can configure a sub-interface using the attributes of our sub-port shown here:</p>
<ul>
<li>MAC address: <kbd><span class="CodeInTextPACKT">fa:16:3e:a9:48:cc</span></kbd></li>
<li>VLAN ID: <kbd><span class="CodeInTextPACKT">42</span></kbd></li>
</ul>
<p>For convenience, an 802.1q VLAN sub-interface can be created with the <kbd><span class="CodeInTextPACKT">ip link</span></kbd> command. Or, on Ubuntu systems, the <kbd><span class="CodeInTextPACKT">/etc/network/interfaces</span></kbd><span class="CodeInTextPACKT"> </span>file can be modified for persistent interface configuration.</p>
<p>Using the <kbd><span class="CodeInTextPACKT">ip link add</span></kbd> command, create the sub-interface and modify the MAC address using the following commands:</p>
<pre><strong># ip link add link ens3 name ens3.42 type vlan id 42<br/></strong><strong># ip link set dev ens3.42 address fa:16:3e:a9:48:cc<br/></strong><strong># ip link set ens3.42 up</strong> </pre>
<p>Using the <kbd><span class="CodeInTextPACKT">ip addr list</span></kbd> command, the newly configured interface should be visible in an <span class="CodeInTextPACKT">UP</span> state and have the specified MAC address:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/291187a8-49d0-4f90-8c67-eff40f75ff29.png"/></p>
<p>The interface does not yet have an IP address, so connectivity cannot be confirmed just yet. There are two options available for IP address configuration:</p>
<ul>
<li>DHCP</li>
<li>Static address configuration</li>
</ul>
<p>To utilize DHCP, simply run the <kbd><span class="CodeInTextPACKT">dhclient ens3.42</span></kbd> command as root or with <span class="CodeInTextPACKT"><kbd>sudo</kbd> </span>privileges. When operating properly, the Neutron DHCP server should return the assigned address and the interface will be configured automatically as shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c70f1c9a-e5f3-4be7-a844-3163a40c1fa3.png"/></p>
<div class="packt_infobox">The specifics of a dynamic or static, but persistent, interface configuration will vary based on the installed guest operating system.</div>
<p>A quick ping to the DHCP server of the <kbd>RED_NET</kbd> network demonstrates tagged traffic from the instance's interface traverses the network appropriately:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/286de616-2220-456d-8151-928349eefe4f.png" style="width:38.75em;height:11.58em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Reviewing the network plumbing</h1>
                </header>
            
            <article>
                
<p>On the <kbd><span>c</span>ompute</kbd> node hosting instance, a quick look at the bridges using <kbd><span class="CodeInTextPACKT">brctl show</span></kbd> does not reveal anything unique about the configuration that would support tagging within the instance:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9ceca0aa-2211-4e39-be32-5a380c235635.png" style="width:40.08em;height:9.08em;"/></p>
<p>However, a deeper look at the <kbd>tap</kbd> interface that corresponds to the sub-port reveals that the interface has been configured as a VLAN interface off the parent port using VLAN ID 42:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/22da6da0-fd9c-4831-a3d9-5374e47c3092.png" style="width:57.83em;height:6.75em;"/></p>
<p>Performing a packet capture on the <kbd>tap</kbd> interface associated with the parent port, we can see traffic leaving the instance's sub-interface and through the parent interface is tagged with <kbd>802.1q VLAN ID 42</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9f462893-1c2b-408a-b884-8052391c61ee.png" style="width:72.25em;height:12.08em;"/></p>
<p><span>The <kbd>compute</kbd> node strips the <kbd>VLAN ID</kbd> and forwards the traffic out the <kbd>tap</kbd> interface associated with the sub-port <span class="ItalicsPACKT">untagged</span>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8b4bfd94-1e09-490b-bb7e-f3126c52efec.png"/></p>
<p>At this point, normal Linux bridge-related traffic operations take place and traffic is forwarded over the physical network infrastructure as described earlier in this book.</p>
<div class="packt_infobox">When an Open vSwitch network agent is used, flow rules may be used instead of the methods described here.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">BGP dynamic routing</h1>
                </header>
            
            <article>
                
<p>BGP dynamic routing enables the advertisement of self-service IPv4 and IPv6 network prefixes to network devices that support BGP, including many physical and virtual router and firewall devices. By advertising self-service networks attached to Neutron routers, the use of floating IPs can be avoided.</p>
<div class="packt_infobox">BGP speaker functionality relies on address scopes and requires knowledge of their operation for proper deployment.</div>
<p>BGP dynamic routing consists of a Neutron API service plugin that implements the Networking service extension and an agent that manages BGP peering sessions. A cloud administrator creates and configures a BGP speaker using the CLI or API and manually schedules it to one or more hosts running the agent.</p>
<p>The following diagram demonstrates the BGP agent's peering relationship with a physical router that enables the physical route to reach self-service networks behind Neutron routers via a common provider network:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/dd00ab74-3e18-4de4-a9c8-18baebc194f3.png" style="width:42.17em;height:35.33em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Prefix advertisement requirements</h1>
                </header>
            
            <article>
                
<p>BGP dynamic routing advertises prefixes for self-service networks and host routes for floating IP addresses. The following conditions must be met to advertise a self-service network:</p>
<ul>
<li>The external and self-service network must reside in the same address scope.</li>
<li>The Neutron router must contain an interface on the self-service subnet and a gateway on the external provider network.</li>
<li>The BGP speaker must peer with a device connected to the same external provider network as the Neutron router.</li>
<li>The BGP speaker has the <kbd><span class="CodeInTextPACKT">advertise_tenant_networks</span></kbd> attribute set to <kbd><span class="CodeInTextPACKT">True</span></kbd>.</li>
</ul>
<p>Advertisement of a floating IP address requires satisfying the following conditions:</p>
<ul>
<li>The BGP speaker must peer with a device connected to the same external provider network as the Neutron router hosting the floating IP.</li>
<li>The BGP speaker has the <kbd><span class="CodeInTextPACKT">advertise_floating_ip_host_rou</span>t<span class="CodeInTextPACKT">es</span></kbd> attribute set to <kbd><span class="CodeInTextPACKT">True</span></kbd>.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Operations with distributed virtual routers</h1>
                </header>
            
            <article>
                
<p><span>In deployments using distributed virtual routers, the BGP speaker advertises floating IP addresses and self-service networks differently. For floating IP addresses, the BGP speaker advertises the floating IP agent gateway on the corresponding compute node as the next-hop IP address. For self-service networks using SNAT, the BGP speaker advertises the DVR SNAT node as the next-hop IP address. This means that traffic directed to a self-service network behind a distributed virtual router must traverse a <kbd>network</kbd> node, while traffic to a floating IP will <span class="ItalicsPACKT">avoid</span> routing through a <kbd>network</kbd> node.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring BGP dynamic routing</h1>
                </header>
            
            <article>
                
<p>The BGP dynamic routing plugin was first introduced in the Mitaka release of OpenStack Networking and supports the native L3 agent provided by Neutron.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>To install the BGP service plugin, modify the Neutron configuration file on the controller node hosting the Neutron API service. In this environment, API services are running on <kbd>controller01</kbd>. Add the BGP plugin to the list of existing service plugins as shown here:</p>
<pre>[DEFAULT]<br/>...<br/>service_plugins = router,<br/>neutron_lbaas.services.loadbalancer.plugin.LoadBalancerPluginv2,<br/>trunk,neutron_dynamic_routing.services.bgp.bgp_plugin.BgpPlugin </pre>
<div class="packt_tip">Be sure to append to the existing list of plugins, rather than replacing the list contents, to avoid issues with the API and existing network objects.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing the agent</h1>
                </header>
            
            <article>
                
<p>To install the Neutron BGP agent, run the following command on the <kbd>controller01</kbd> node:</p>
<pre><strong># apt install neutron-bgp-dragent</strong> </pre>
<p>Neutron stores the BGP agent configuration in the <kbd><span class="CodeInTextPACKT">/etc/neutron/bgp_dragent.ini</span></kbd> file. The most common configuration options will be covered in the following sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring the agent</h1>
                </header>
            
            <article>
                
<p>Edit the BGP agent configuration file and add the following configuration, substituting the <kbd><span class="CodeInTextPACKT">bgp_router_id</span></kbd> value with the IP address of the respective controller node, if necessary:</p>
<pre>[bgp]<br/>...<br/>bgp_speaker_driver =<br/>neutron_dynamic_routing.services.bgp.agent.driver.ryu.driver.RyuBgpDriver <br/>bgp_router_id = 10.10.0.100 </pre>
<div class="packt_infobox">In this example, the management IP address of the host is used. Using an IP address and interface dedicated to router advertisements is possible but outside the scope of this book.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Restarting services</h1>
                </header>
            
            <article>
                
<p>For the configuration changes to take effect, restart the <kbd>Neutron API</kbd> service and the <kbd>Neutron BGP</kbd> agent with the following command:</p>
<pre><strong># systemctl restart neutron-server neutron-bgp-dragent</strong> </pre>
<p>Use the O<span class="CodeInTextPACKT">penStack</span> client to verify the BGP agent is checked in and ready for use:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/792267db-db0a-4736-823e-98df4e5efed7.png"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Managing BGP speakers in the CLI</h1>
                </header>
            
            <article>
                
<p>As of the Pike release of the O<span class="CodeInTextPACKT">penStack</span> client, BGP speaker-related commands are not yet available. The following <span class="CodeInTextPACKT">neutron</span> client commands are used to manage BGP speaker objects in the CLI:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>BGP speaker management Commands</strong></p>
</td>
<td>
<p class="TableColumnHeadingPACKT CDPAlignCenter CDPAlign"><strong>Description</strong></p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-dragent-list-hosting-speaker</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists dynamic routing agents hosting a BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-dragent-speaker-add</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Adds a BGP speaker to a dynamic routing agent.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-dragent-speaker-remove</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Removes a BGP speaker from a dynamic routing agent.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-peer-create</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Creates a BGP peer.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-peer-delete</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Deletes a BGP peer.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-peer-list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">List BGP peers.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-peer-show</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Shows information of a given BGP peer.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-peer-update</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Updates BGP peer information.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-advertiseroute-list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists routes advertised by a given BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-create</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Creates a BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-delete</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Deletes a BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists BGP speakers.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-list-on-dragent</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists BGP speakers hosted by a dynamic routing agent.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-network-add</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Adds a network to the BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-network-remove</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Removes a network from the BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-peer-add</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Adds a peer to the BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-peer-remove</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Removes a peer from the BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-show</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Shows information of a given BGP speaker.</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>bgp-speaker-update</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Updates BGP speaker information.</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p>Please refer to the upstream documentation on configuring address scopes and subnet pools for use with BGP dynamic routing. The following URL provides working examples that demonstrate BGP dynamic routing: <a href="https://docs.openstack.org/neutron/pike/admin/config-bgp-dynamic-routing.html"><span class="URLPACKT">https://docs.openstack.org/neutron/pike/admin/config-bgp-dynamic-routing.html</span></a><span class="URLPACKT">.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Network availability zones</h1>
                </header>
            
            <article>
                
<p>A network availability zone is a logical construct used to define a group of network nodes that share similar power, network, and cooling systems. Network resources can be scheduled to multiple availability zones to ensure a high level of reliability when a single zone fails. This is similar to how Nova availability zones work, as they as used to group compute nodes in a similar way to ensure components of an application are not in the same failure domain.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring network availability zones</h1>
                </header>
            
            <article>
                
<p>Availability zone support for Neutron was first introduced in the Mitaka release of OpenStack Networking, and supports both the DHCP and L3 agents included with Neutron. Other drivers may be supported but are outside the scope of this book.</p>
<p>In the environment built throughout this book, the Neutron L3 agent has been installed on most of the nodes to demonstrate standalone, highly available, and distributed virtual routers. A quick look at the Neutron agent list shows they all share a common availability zone based on default agent configuration options:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/05987e3f-947d-4093-bd84-809932f61d7a.png"/></p>
<p class="mce-root"/>
<p>To modify the availability zone for a particular L3 agent, edit the respective agent configuration file at <kbd><span class="CodeInTextPACKT">/etc/neutron/l3_agent.ini</span></kbd> and modify the <kbd><span class="CodeInTextPACKT">availability_zone</span></kbd> configuration option as shown here:</p>
<pre>[agent]<br/>...<br/># Availability zone of this node (string value)<br/># availability_zone = nova<br/>availability_zone = AZ1 </pre>
<p>Restart the L3 agent with the following command:</p>
<pre><strong># systemctl restart neutron-l3-agent</strong> </pre>
<p>A fresh look at the agent list reflects the change:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6974b509-d4da-4863-976b-29ba7f711adb.png"/></p>
<p>DHCP agents can also be associated with availability zones in a similar manner. To modify the availability zone for a particular DHCP agent, edit the respective agent configuration file at <kbd><span class="CodeInTextPACKT">/etc/neutron/dhcp_agent.ini</span></kbd> and modify the <span class="CodeInTextPACKT"><kbd>availability_zone</kbd></span> configuration option as shown here:</p>
<pre>[agent]<br/>...<br/># Availability zone of this node (string value)<br/># availability_zone = nova<br/>availability_zone = AZ1 </pre>
<p>Restart the <kbd>DHCP</kbd> agent with the following command:</p>
<pre><strong># systemctl restart neutron-dhcp-agent</strong></pre>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Scheduling routers to availability zones</h1>
                </header>
            
            <article>
                
<p>Neutron routers can be directed to a particular availability zone during the router creation process. Using the <kbd><span class="CodeInTextPACKT">openstack router create</span></kbd> command, we can schedule a router to availability zone <kbd><span class="CodeInTextPACKT">AZ1</span></kbd> with the <kbd><span class="CodeInTextPACKT">--availability-zone-hint</span></kbd> argument as shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d5d83fb7-9998-4222-9545-280a7a054222.png" style="width:43.58em;height:26.08em;"/></p>
<p>After attaching the router to the external provider network <kbd><span class="CodeInTextPACKT">GATEWAY_NET</span></kbd>, we can see the router was scheduled to an <kbd>L3</kbd> agent in availability zone <kbd><span class="CodeInTextPACKT">AZ1</span></kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b4642805-0141-48f9-8892-8f418a357589.png"/></p>
<p>Directing a router to a particular availability zone does not ensure it will be scheduled to an L3 agent in that zone, however, as the directive is more of a scheduler hint than an outright requirement. Neutron performs <span class="ItalicsPACKT">best effort</span> scheduling using availability zone hints. Multiple availability zones can be specified, if desired, by repeating the <kbd><span class="CodeInTextPACKT">--availability-zone-hint</span></kbd> argument as necessary.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Scheduling DHCP services to availability zones</h1>
                </header>
            
            <article>
                
<p>The DHCP service for a given network is something often taken for granted and is not directly seen, let alone configurable, by users or operators via the API. Neutron has scheduled DHCP services across multiple DHCP agents for some time using the following configuration option in the Neutron configuration file at <kbd><span class="CodeInTextPACKT">/etc/neutron/neutron.conf</span></kbd>:</p>
<pre># Number of DHCP agents scheduled to host a tenant network.<br/># If this number isgreaterthan 1, the scheduler automatically<br/># assigns multiple DHCP agents for a given tenant network,<br/># providing high availability for DHCP service.<br/># (integer value)<br/># dhcp_agents_per_network = 1 </pre>
<p>When <kbd><span class="CodeInTextPACKT">dhcp_agents_per_network</span></kbd> is greater than <kbd>1</kbd>, and more than one DHCP agent exists in the environment, Neutron will automatically schedule a network to multiple <kbd>DHCP</kbd> agents up to the specified value. Using the <kbd><span class="CodeInTextPACKT">openstack network create</span></kbd><span class="CodeInTextPACKT"> </span>command with the <span class="CodeInTextPACKT"><kbd>--availability-zone-hint</kbd></span> argument, we can suggest to the scheduler that <kbd>DHCP</kbd> services be split amongst multiple availability zones as shown here:</p>
<pre>openstack network create network01<br/>--availability-zone-hint AZ1<br/>--availability-zone-hint AZ2 </pre>
<p>Directing a network's DHCP services to a particular availability zone does not ensure it will be scheduled to a DHCP agent in that zone, however, as the directive is more of a scheduler hint than an outright requirement. Neutron performs <span class="ItalicsPACKT">best effort</span> scheduling using availability zone hints. Multiple availability zones can be specified, if desired, by repeating the <kbd><span class="CodeInTextPACKT">--availability-zone-hint</span></kbd> argument as necessary.</p>
<p>More information on the use of network availability zones can be found in upstream documentation available at the following URL: <span><a href="https://docs.openstack.org/neutron/pike/admin/config-az.html">https://docs.openstack.org/neutron/pike/admin/config-az.html</a>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>As workloads for OpenStack-based clouds have evolved, so have the features provided by OpenStack Networking. VLAN-aware VMs, BGP speakers, and network availability zones are just a few of the advanced network features that have been introduced in Neutron over the last few release cycles and there are more to come in future releases. Used in tandem, these features can provide users with the ability to define rich network topologies and provide high-availability to a number of different applications and workloads in the cloud.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The release notes for OpenStack Networking are a great place to find information on recently released features as well as bug fixes for existing functions. To find the release notes for a given release, please visit the following URL: <a href="https://docs.openstack.org/releasenotes/neutron/index.html"><span class="URLPACKT">https://docs.openstack.org/releasenotes/neutron/index.html</span></a><span class="URLPACKT">.</span></p>


            </article>

            
        </section>
    </body></html>