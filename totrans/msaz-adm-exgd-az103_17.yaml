- en: Implementing Azure Load Balancer
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, we covered the fourth part of the *Deploying and Managing
    Virtual Networks*objective. We've covered **Network Security Groups** (**NSGs**)
    and Azure DNS. You also learned how to create and configure NSGs and how to set
    up and configure Azure DNS.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: This chapter covers the fifth and final part of thisobjective, by covering how
    to configure internal and external load balancers using **Azure Load Balancer**.
    In this chapter, we are going to focus on the features and capabilities of Azure
    Load Balancer. You will learn how to configure an internal load balancer and how
    to create health probes and configure load balancing rules. This chapter will
    finish by covering how you can configure a public load balancer.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: 'The following topics will be covered in this chapter:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: Azure Load Balancer
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuring an internal load balancer
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating health probes
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating load balancing rules
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuring a public load balancer
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The source code for this chapter can be downloaded from the GitHub repository
    at [https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter13](https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter13).
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: Azure Load Balancer
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure Load Balancer is a load balancer that operates at the transport layer (Layer
    4 in the OSI network reference stack). Azure Load Balancer supports the **Transmission
    Control Protocol** (**TCP**) and **User Datagram Protocol** (**UDP**) and it can
    be used to load-balance traffic to your VMs. It provides high throughput and low
    latency, it can scale up to millions of flows, and it supports various inbound
    and outbound scenarios.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: 'Azure Load Balancer can be used for the following:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '**Public** **Load Balance**r: Incoming internet traffic is load balanced to
    VMs.'
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Internal Load Balancer**: Traffic can be load balanced across VMs inside
    a virtual network. You can use it in a hybrid scenario as well, where it reaches
    a Load Balancer inside an on-premises network.'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Port forwarding**: You can forward traffic to specific ports on specific
    VMs using inbound **Network Address Translation** (**NAT**) rules.'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Outbound connectivity**: You can also provide outbound connectivity for VMs
    inside a virtual network using it on Azure Load Balancer as a public load balancer.'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Azure Load Balancer offers the following features and capabilities:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: '**Load balancing**: Traffic can be distributed from a frontend pool to a backend
    pool using rules. Azure Load Balancer uses a five-tuple hash by default, which
    is composed of the source IP address, source port, destination IP address, destination
    ports, and the IP protocol number to map flows to the available servers in the
    backend pool.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Port forwarding**: Inbound NAT rules can be created to forward traffic from
    a specific port of the frontend IP address of the load balancer to a specific
    port of a backend instance inside an Azure Virtual Network. Therefore, the same
    hash-based distribution is used as for load balancing. This can be used for the **Remote
    Desktop Protocol** (**RDP**) and **Secure Shell** (**SSH**) sessions to VMs inside
    the VNet. Multiple internal endpoints can be mapped to various ports on the same
    frontend IP address. The VMs can be remotely administered using the frontend IP
    address. This way, an additional jump box is not needed.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Automatic reconfiguration**: The load balancer will automatically reconfigure
    itself when instances are scaled up or down. There is no need for additional operations
    on the load balancer when VMs are added or removed from the backend pool.'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Health probes**: Azure Load Balancer uses health probes to determine the
    health on the VMs in the backend pool. The load balancer will stop sending new
    connections to an instance when a probe fails to respond. There are different
    health probes provided for HTTP, HTTPS, and TCP endpoints.'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Outbound connections** (**SNAT**): Outbound connections are automatically
    translated to the public frontend IP address of the load balancer.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Azure Load Balancer comes in two different pricing tiers:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: '**Basic**: The Basic Balancer is free to use. It has the following capabilities:'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Backend pool size**: The Basic tier supports up to 100 instances inside a
    backend pool.'
  id: totrans-26
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Health probes**: TCP and HTTP.'
  id: totrans-27
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Availability zones**: Not available.'
  id: totrans-28
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Outbound connections**: A single frontend is supported, which is selected
    at random when multiple frontends are configured. The default **Source** **Network
    Address Translation** (**SNAT**) is used when there is only an internal load balancer
    that is serving a VM, VM scale set, or availability set.'
  id: totrans-29
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Outbound rules**: Not available.'
  id: totrans-30
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Diagnostics**: Support for Azure Log Analytics for a public load balancer
    only, backend pool health count, and SNAT exhaustion alert.'
  id: totrans-31
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**HA Ports**: Not available.'
  id: totrans-32
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Secure by default**: Open by default; NSGs are optional.'
  id: totrans-33
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**TCP Reset on Idle**: Not available.'
  id: totrans-34
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Multiple frontends**: Not available.'
  id: totrans-35
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Management Operations**: 60-90+ seconds.'
  id: totrans-36
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**SLA**: Not available.'
  id: totrans-37
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Standard**: You are charged for using the Standard tier of the Azure Load
    Balancer. The charge is based on the number of rules and the data that is associated
    with the resource and are processed inbound and outbound:'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**B****ackend****pool size**: The standard tier supports up to 1,000 instances
    inside a backend pool.'
  id: totrans-39
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Health probes**: TCP, HTTP, and HTTPS.'
  id: totrans-40
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Availability Zones**: Support for zone-redundant and zonal frontends for
    inbound and outbound connections and cross-zone load balancing.'
  id: totrans-41
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Outbound connections**: Multiple frontends can be used per load balancing
    rule opt-out. Pool-based outbound NAT can be explicitly defined using outbound
    rules. Outbound scenarios must be explicitly created to use outbound connectivity
    for the VM, VM scale set, or availability set. Virtual network service endpoints
    can be reached without defining outbound connectivity. Public IP addresses and **Platform
    as a Service** (**PaaS**), that are not available using VNet service endpoints,
    must be reached with outbound connectivity.'
  id: totrans-42
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Outbound rules**: Outbound NAT configuration needs to be defined using public
    IP addresses, public IP prefixes, or both. You can configure the outbound idle
    timeout as well as custom SNAT port allocation.'
  id: totrans-43
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Diagnostics**: Azure Load Balancer has support for Azure Monitor, with features
    including health probe status, outbound connection health (SNAT successful and
    failed flows), multi-dimensional metrics, and active data plane measurements.'
  id: totrans-44
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**HA Ports**: Highly available ports for the internal load balancer only.'
  id: totrans-45
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Secure by default**: Unless internal load balancers are whitelisted by an
    NSG, the endpoints are closed to inbound flows by default. Public IP addresses
    and load balancer endpoints are secured as well.'
  id: totrans-46
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**TCP Reset on Idle**: This can be enabled on the idle timeout on any rule.'
  id: totrans-47
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Multiple frontends**: For inbound and outbound connections.'
  id: totrans-48
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Management operations**: < 30 seconds for most operations.'
  id: totrans-49
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**SLA**: 99.99% for a data path with two healthy virtual machines.'
  id: totrans-50
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuring an internal load balancer
  id: totrans-51
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this demonstration, we are going to create and configure a load balancer
    from the Azure portal. We are going to route internal traffic with a basic load
    balancer to spread incoming requests to multiple virtual machines. For this demonstration,
    we are going to create a load balancer, backend servers, and network resources
    at the Basic pricing tier.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
- en: Creating the VNet
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'First, we are going to create the VNet, backend servers, and a test VM. To
    do this, take the following steps:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the left menu, select Create a resource | Networking, and then select Virtual
    Network.
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Add the following values:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktLBVnet`'
  id: totrans-58
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address space**: `172.16.0.0/16`'
  id: totrans-59
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subscription**: Select a subscription'
  id: totrans-60
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Resource group**: Create a new one and call it **PacktLoadBalancer**'
  id: totrans-61
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location**: East US'
  id: totrans-62
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subnet name**: `PacktLBBackendSubnet`'
  id: totrans-63
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subnet address range**: `172.16.0.0/24`'
  id: totrans-64
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**DDoS protection**: Basic'
  id: totrans-65
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Service endpoints**: Disabled'
  id: totrans-66
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Firewall**: Disabled:'
  id: totrans-67
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/9eb90c4f-2de4-4f01-afa5-005bb2dc4783.png)'
  id: totrans-68
  prefs: []
  type: TYPE_IMG
- en: VNet settings
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: Click Create.
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Creating the VMs
  id: totrans-71
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The next step is to create the VMs that are used inside the backend pool and
    for testing. To do this, take the following steps:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: To create the VMs, select **Create a resource** in the left menu, and then select Compute and
    then Windows Server 2016 Datacenter.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the Create a virtual machine blade on the Basic tab, fill in the following
    values:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Subscription: Select a subscription'
  id: totrans-75
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Resource group: `PacktLoadBalancer` (which is created in the previous step).
  id: totrans-76
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_NORMAL
- en: Virtual machine name: `PacktLBVM1`.
  id: totrans-77
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Region: East US.
  id: totrans-78
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Availability options: Select Availability **set** and create a new one named `PacktLBAvailabilitySet`.
    Leave the default domain and update the domain settings.'
  id: totrans-79
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Image: Windows Server 2016 Datacenter.'
  id: totrans-80
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Size: Standard DS1 v2.'
  id: totrans-81
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Credentials**: Specify a username and password for the VM.'
  id: totrans-82
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Public inbound ports: Allow selected ports | select RDP (3389).
  id: totrans-83
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Select the Networking tab and select the virtual network that we created in
    the previous step with the subnet, and fill in the following values:'
  id: totrans-84
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'NIC network security group: Select **Advanced** and create a new network security
    group. Keep the default name for the new network security group.'
  id: totrans-85
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Select the **Management** tab. Under **Monitoring**, set **Boot diagnostics** to **Off**.
  id: totrans-86
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click the Review + create button to create the VM.
  id: totrans-87
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Repeat the preceding steps to create a second VM called `PacktLBVM2` and a third
    VM called `PacktLBVMTest` using the same settings, and place them in the same subscription,
    resource group, Availability Set and the same network security group.
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Creating the load balancer
  id: totrans-89
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now we can create the load balancer as follows:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: To create the basic load balancer, in the top menu, select Create a resource | Networking | Load
    Balancer.
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Add the following values:'
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Subscription:** Pick a subscription'
  id: totrans-93
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Resource group: `PacktLoadBalancer`.
  id: totrans-94
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Name: `PacktLoadBalancer`.
  id: totrans-95
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Region: East US.
  id: totrans-96
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Type: Internal.
  id: totrans-97
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: SKU: Basic.
  id: totrans-98
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Virtual Network: Select `PacktLBVNet`.
  id: totrans-99
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Subnet: Select `PacktLBBackendSubnet`.'
  id: totrans-100
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: IP address assignment: Static.
  id: totrans-101
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Private IP address: Provide an IP address that is in the address space of your
    virtual network and subnet, such as `172.16.0.7`.
  id: totrans-102
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Click Review + Create. Then click Create:'
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/f8a8a6f7-a348-486e-b1ad-f45dd8151243.png)'
  id: totrans-104
  prefs: []
  type: TYPE_IMG
- en: Creating the load balancer
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: Creating a backend address pool
  id: totrans-106
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now, the VMs and the Azure Load Balancer instance have been created and the
    networking is configured, so it is time to create the backend pool, which is used
    by the load balancer to distribute the traffic to the VMs. The backend pool consists
    of the IP addresses of the **Network Interface Cards** (**NICs**).
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: 'We are going to create a backend pool with `PacktLBVM1` and `PacktLBVM2` in
    it:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
- en: Open the load balancer resource that we created in the previous step inside
    the Azure portal.
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Under Settings, select Backend pools, and then click the Add button:'
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/590a2165-4bb5-4272-82d3-80bdb5dc00d2.png)'
  id: totrans-111
  prefs: []
  type: TYPE_IMG
- en: Creating the backend pool
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: 'Add the following values:'
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Name: `PacktLBBackendPool`.
  id: totrans-114
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Associated to: Select **Availability set**.'
  id: totrans-115
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Availability set: Select `PacktLBAvailabilitySet`.'
  id: totrans-116
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Select Add a target network IP configuration and add `PacktLBVM1` and `PacktLBVM2` to
    the backend pool.
  id: totrans-117
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Click OK:'
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/4c2fa7f4-f2ec-4e8d-a10a-85080520ba88.png)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
- en: Adding the VMs to the backend pool
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: Creating health probes
  id: totrans-121
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The next step is to create a health probe for the load balancer. The health
    probe is used for the load balancer to monitor the status of the VM. The probe
    will dynamically add or remove VMs from the load balancer rotation, based on the
    response to the health checks that are performed by the health probe.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a health probe, take the following steps:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: Again, open the Load Balancer resource.
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Under Settings, select Health probes, and then select Add:'
  id: totrans-125
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/ca460c19-c5af-480d-a024-c04424ec0401.png)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
- en: Creating a new health probe
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: 'Add the following values:'
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Name: `PacktHealthProbe`.
  id: totrans-129
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Protocol: HTTP.
  id: totrans-130
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Port: `80`.
  id: totrans-131
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Path: `*/*`**.**
  id: totrans-132
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Interval: `15`—this is the number of seconds between probe attempts.
  id: totrans-133
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Unhealthy threshold: `2`*—*this value is the number of consecutive probe failures
    that occur before a VM is considered unhealthy.
  id: totrans-134
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Click OK:'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/1ff08521-5951-400a-a11e-06cf1316e641.png)'
  id: totrans-136
  prefs: []
  type: TYPE_IMG
- en: Health probe settings
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: Creating load balancing rules
  id: totrans-138
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Load balancing rules define how the traffic is distributed to the VMs inside
    the backend pool. When you create a new rule, you define the frontend IP configuration
    for incoming traffic, the backend IP pool that receives the traffic, and the required
    source and destination ports.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: The rule that we are going to create listens to port `80` at the frontend. The
    rule then sends the network traffic to the backend pool, also on port `80`.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: 'To create the rule, take the following steps:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: Again, open the Load Balancer resource.
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Under Settings, select Load balancing rules, and then select Add:'
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/bf27a893-3d2c-416a-b56d-c62f4b92fc71.png)'
  id: totrans-144
  prefs: []
  type: TYPE_IMG
- en: Creating a new rule
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: 'Add the following values:'
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Name: `PacktLoadBalancerRule`
  id: totrans-147
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Frontend IP address: `LoadBalancerFrontEnd`
  id: totrans-148
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Protocol: TCP
  id: totrans-149
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Port: `` `80` ``
  id: totrans-150
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Backend port: `80`
  id: totrans-151
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Backend pool: `PacktLBBackendPool`
  id: totrans-152
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Health probe: `PacktHealthProbe`
  id: totrans-153
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Click OK:'
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/096d4baa-5900-47d8-9d22-a6f9a95f11dd.png)'
  id: totrans-155
  prefs: []
  type: TYPE_IMG
- en: Configuring the rule
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: Testing the load balancer
  id: totrans-157
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To test the VMs properly, we are going to install **Internet Information Services**
    (**IIS**) on the `PacktLBVM1` and `PacktLBVM2` VMs using PowerShell. Then, we
    can use the `PacktLBVMTest` VM to test the load balancer by calling its private
    IP address.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
- en: 'First, we need to obtain the private IP address of the load balancer. Take
    the following steps:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
- en: 'In the Overview page of the load balancer, copy the private IP address as follows:'
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/3732d015-404a-476a-a495-d62180d9995a.png)'
  id: totrans-161
  prefs: []
  type: TYPE_IMG
- en: Obtaining the private IP address
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, we need to connect to the `PacktLBVM1` and `PacktLBVM2` VM using an RDP session
    and install IIS and a testing web page on it. Connect to both the VMs, open the
    PowerShell console, and provide the following PowerShell script:'
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Next, connect to the `PacktLBVMTest` VM using RDP as well, open a browser session,
    and navigate to the private IP address of the load balancer. Refresh the browser
    a couple of times to see the load balancer distributing the requests over the
    two VMs, as the following screenshot shows:'
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/250069a7-a4b4-4aa6-96e7-980bab339db4.png)'
  id: totrans-166
  prefs: []
  type: TYPE_IMG
- en: Testing the load balancer
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: Configuring a public load balancer
  id: totrans-168
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we are going to create a public load balancer using the Azure
    CLI. You can copy the code snippets in Azure Cloud Shell, which is accessible
    from the Azure portal.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: The full script for creating the public load balancer can be downloaded from
    GitHub as well. Refer to the location specified under the *Technical requirements*
    section at the beginning of this chapter.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: Creating the load balancer
  id: totrans-171
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To create the public load balancer, a series of steps need to be taken. In the
    upcoming sections, we will create the public load balancer with all the necessary
    components.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: Creating a resource group
  id: totrans-173
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We start by creating a resource group for the load balancer and other resources
    as follows:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Creating a public IP address
  id: totrans-176
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Next, we are going to configure a public IP address for the load balancer to
    access it from the internet. A standard load balancer only supports standard public
    IP addresses, as shown in the following code:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Creating the load balancer
  id: totrans-179
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the following sections, we are going to create the load balancer and will
    create the components, including a frontend IP pool, backend IP pool, a health
    probe, and a load balancer rule.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: 'To create the load balancer, add the following code:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Creating the health probe
  id: totrans-183
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: All VM instances are checked by the health probe to define whether they are
    healthy enough to send network traffic to them. Virtual machine instances that
    are unhealthy are removed from the load balancer until the probe check determines
    that they are healthy again.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: 'To create the health probe, add the following code:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Creating the load balancer rule
  id: totrans-187
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The load balancer rule defines the frontend IP configuration for the incoming
    traffic and the backend IP pool to receive the traffic, together with the required
    source and destination ports, as follows:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Creating the virtual network
  id: totrans-190
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We now need to create the virtual network to deploy the VMs too, with the following
    code:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Creating an NSG
  id: totrans-193
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Next, we will create an NSG. It is a requirement for a standard load balancer
    that the VMs in the backend have NICs that are placed in an NSG. We need to create
    the NSG to define the inbound connections to the virtual network as follows:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Creating an NSG rule
  id: totrans-196
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To allow inbound connections through port `80`, create an NSG rule as follows:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-198
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Creating NICs
  id: totrans-199
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We need to create two network interfaces and associate them with the NSG and
    the public IP address, as follows:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Creating backend servers
  id: totrans-202
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Next is creating the backend servers. We are going to create two VMs that are
    going to be used as backend servers for the load balancer. We are also going to
    install **NGINX** (which is an open source, high-performance HTTP server, and
    reverse proxy) on it to test the load balancer.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
- en: Creating an availability set
  id: totrans-204
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To create an availability set, add the following piece of code:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Creating two virtual machines
  id: totrans-207
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We are going to create two VMs with NGINX installed on it. We are also going
    to create a `Hello World` Node.js app on the Linux virtual machines. For this,
    we need to create a file called `cloud-init.txt` and paste the configuration in
    it. The following `cloud-init` configuration installs all the required packages,
    then creates the `Hello World` app, and then starts the app. To create the `cloud-init.txt` file,
    add the following line:'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-209
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Select an editor and paste in the following configuration. First, add the packages:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-211
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Then set up the server:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Next, create the app:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'And, finally, run the app:'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'With the above blocks of code, we now created the cloud-init.txt file for our
    VMs. save the file in the editor and exit it.  Now, we can continue with creating
    the two virtual machines and apply the configuration on it, as follows:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Testing the load balancer
  id: totrans-220
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To test the load balancer, we need to obtain the public IP address of it and
    paste this into a browser window. Wait for the VMs to be fully provisioned and
    running. You can check this in the Azure portal. Then, to obtain the public IP
    address, add the following line of code:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Paste the output of this line of code into your browser window to see the Azure
    Load Balancer in action:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/5932aeb6-6c51-4542-9552-b8fc914a690a.png)'
  id: totrans-224
  prefs: []
  type: TYPE_IMG
- en: Testing the public load balancer
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-226
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we covered how to configure internal and external load balancers.
    You also learned how to configure load balancing rules and health probes.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will continue with the fifth part of *Deploying and
    Managing Virtual Networks* objective by covering how to integrate an on-premises
    network with an Azure Virtual Network.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
- en: Questions
  id: totrans-229
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Answer the following questions to test your knowledge of the information in
    this chapter. You can find the answers in the *Assessments* section at the end
    of this book:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
- en: Can a basic load balancer only be created from the Azure portal?
  id: totrans-231
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  id: totrans-232
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  id: totrans-233
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Is it necessary for a standard load balancer that the VMs in the backend have
    NICs that are placed in an NSG?
  id: totrans-234
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  id: totrans-235
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  id: totrans-236
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Does a standard load balancer needs a standard public IP address to function
    properly?
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  id: totrans-238
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  id: totrans-239
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Further reading
  id: totrans-240
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'You can check the following links for more information about the topics that
    are covered in this chapter:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
- en: '*Load Balancer*: [https://docs.microsoft.com/en-us/azure/load-balancer/](https://docs.microsoft.com/en-us/azure/load-balancer/)'
  id: totrans-242
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Quickstart: Create a load balancer to load balance VMs using Azure CLI*: [https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-cli](https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-cli)'
  id: totrans-243
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Quickstart: Create a public load balancer using Azure PowerShell*: [https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-powershell](https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-basic-load-balancer-powershell)'
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Quickstart: Create a Standard Load Balancer to load balance VMs using the
    Azure portal*: [https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal](https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal)'
  id: totrans-245
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*快速入门：使用 Azure 门户创建标准负载均衡器以负载均衡虚拟机*: [https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal](https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal)'
- en: '*Quickstart: Create a Standard Load Balancer using Azure PowerShell*: [https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-standard-load-balancer-powershell](https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-standard-load-balancer-powershell)'
  id: totrans-246
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*快速入门：使用 Azure PowerShell 创建标准负载均衡器*: [https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-standard-load-balancer-powershell](https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-create-standard-load-balancer-powershell)'
