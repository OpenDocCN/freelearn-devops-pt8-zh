<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer182">
<h1 class="chapter-number" id="_idParaDest-70"><a id="_idTextAnchor070"/>6</h1>
<h1 id="_idParaDest-71"><a id="_idTextAnchor071"/>Integrating Testing, Security Tasks, and Other Tools</h1>
<p>Now that we have learned the basics of build and release pipelines, it is time to understand how Azure Pipelines can be extended with other tools, to perform additional tasks and be able to include additional capabilities beyond those built into the tool. By the end of this chapter, you will have the skills to go beyond the basics and be able to include tasks to increase the quality of the code produced in builds, detect vulnerabilities before deploying, and use source code from another repository and inclusive artifacts from <span class="No-Break">other locations.</span></p>
<p>In this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Understanding the Azure DevOps <span class="No-Break">extensibility model</span></li>
<li>Including automated tests for <span class="No-Break">your build</span></li>
<li>Increasing <span class="No-Break">code quality</span></li>
<li>Integrating with Jenkins for artifacts and <span class="No-Break">release pipelines</span></li>
</ul>
<h1 id="_idParaDest-72"><a id="_idTextAnchor072"/>Technical requirements</h1>
<p>To complete this chapter, you will need certain extensions. Let’s understand the <strong class="bold">Azure Devops extensibility model</strong> first and how you can access them. You will find the code for this chapter in the GitHub repository <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines/tree/main/ch06"><span class="No-Break">https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines/tree/main/ch06</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-73"><a id="_idTextAnchor073"/>Understanding the Azure DevOps extensibility model</h2>
<p>Azure DevOps and <a id="_idIndexMarker233"/>its sub-services provide several features that are included by default, but you can customize and extend your experience using extensions that can be developed using standard technologies such as HTML, JavaScript, <span class="No-Break">and CSS.</span></p>
<p>There is a very flexible<a id="_idIndexMarker234"/> model behind all sub-services that you can augment using <strong class="bold">extensions</strong> published by individuals and well-known third-party organizations available in the marketplace. You have the option to create your own and publish them as well if you don’t find what <span class="No-Break">you need.</span></p>
<p>The <a id="_idIndexMarker235"/>purpose of an extension is to make it easier to encapsulate reusable tasks, use external tools, and even enhance the look and feel of Azure DevOps. For Azure Pipelines, you will find extensions that do <span class="No-Break">the following:</span></p>
<ul>
<li>Make complex and repetitive <span class="No-Break">tasks easier</span></li>
<li>Use<a id="_idIndexMarker236"/> common <strong class="bold">Infrastructure as Code</strong> (<strong class="bold">IaC</strong>) tools easily, such as Terraform <span class="No-Break">or Ansible</span></li>
<li>Integrate with SaaS products to improve code quality <span class="No-Break">and security</span></li>
<li>Facilitate deployment tasks to cloud providers such as Azure and Amazon <span class="No-Break">Web Services</span></li>
</ul>
<p>You can <a id="_idIndexMarker237"/>access Visual Studio Marketplace for Azure DevOps <span class="No-Break">at </span><a href="https://marketplace.visualstudio.com/azuredevops"><span class="No-Break">https://marketplace.visualstudio.com/azuredevops</span></a><span class="No-Break">.</span></p>
<p>The following screenshot shows what this <span class="No-Break">looks like:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<img alt="Figure 6.1 – Visual Studio Marketplace for Azure DevOps" height="827" src="image/B18875_06_1.jpg" width="1200"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.1 – Visual Studio Marketplace for Azure DevOps</p>
<p>Each marketplace extension listing indicates the name of the extension, who published it, whether the publisher is verified, its rating, number of installations, and price. Some are provided for free, while others might require you to pay a fee for them. You can find these extensions by name, category, or tag to make it easier to find what you are <span class="No-Break">looking for.</span></p>
<h2 id="_idParaDest-74"><a id="_idTextAnchor074"/>Installing a code quality assessment tool, SonarQube</h2>
<p>Search<a id="_idIndexMarker238"/> the <a id="_idIndexMarker239"/>marketplace for SonarQube and click on the listing to see its details. Alternatively, go <span class="No-Break">to </span><a href="https://marketplace.visualstudio.com/items?itemName=SonarSource.sonarqube"><span class="No-Break">https://marketplace.visualstudio.com/items?itemName=SonarSource.sonarqube</span></a><span class="No-Break">.</span></p>
<p>You should see something similar to <span class="No-Break">the following:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer160">
<img alt="Figure 6.2 – Visual Studio Marketplace listing for the SonarQube extension" height="658" src="image/B18875_06_2.jpg" width="900"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.2 – Visual Studio Marketplace listing for the SonarQube extension</p>
<p>Once you have found the extension you want, simply click on the <strong class="bold">Get it free</strong> or <strong class="bold">Get</strong> button. You will be able to select the Azure DevOps organization to install it in, just in case you have more than one, as shown in the <span class="No-Break">following figure:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer161">
<img alt="Figure 6.3 – Installing the SonarQube extension from the marketplace" height="316" src="image/B18875_06_3.jpg" width="759"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.3 – Installing the SonarQube extension from the marketplace</p>
<p>Once you <a id="_idIndexMarker240"/>have reviewed the permissions and terms of service and selected the organization to install in, click the <strong class="bold">Install</strong> button. It typically takes just a few seconds to install the extension, after which you have the option to proceed to the Azure DevOps organization or go back to the marketplace to find <span class="No-Break">more extensions:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer162">
<img alt=" Figure 6.4 – The SonarQube extension has been installed" height="293" src="image/B18875_06_4.jpg" width="700"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 6.4 – The SonarQube extension has been installed</p>
<p>You will find the code for this chapter <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines/tree/main/ch06"><span class="No-Break">https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines/tree/main/ch06</span></a><span class="No-Break">.</span></p>
<p>Now that we have all the technical requirements in place, let’s see how we can add some automated test runs to your <span class="No-Break">build pipeline.</span></p>
<h1 id="_idParaDest-75"><a id="_idTextAnchor075"/>Including automated tests for your build</h1>
<p>All modern <a id="_idIndexMarker241"/>applications <a id="_idIndexMarker242"/>require some sort of validation to ensure they are working correctly, regardless of the number of developers working on the code at the same time. This is where <strong class="bold">automated tests</strong>, which are executed right after the application is built, can validate that there is no loss of quality or bugs are introduced with the <span class="No-Break">changes made.</span></p>
<p>There are many<a id="_idIndexMarker243"/> types <a id="_idIndexMarker244"/>of tests, such as <strong class="bold">unit tests</strong>, <strong class="bold">integration tests</strong>, and <strong class="bold">load tests</strong>, that can be executed <a id="_idIndexMarker245"/>against<a id="_idIndexMarker246"/> an application. There are also many automated testing frameworks available, depending on the programming language used to build the application and the preferences of the teams working <span class="No-Break">on it.</span></p>
<p class="callout-heading">Why is automated testing important?</p>
<p class="callout">Automated tests allow you to reduce the chance of releasing bugs in your applications by detecting them in the early stages of the development cycle, all while reducing the amount of time dedicated by testing teams to perform the verifications and avoiding human hours in repetitive tasks that could be used to develop more features and capabilities in <span class="No-Break">your applications.</span></p>
<p>In this section, you will learn how to integrate the execution of unit tests into your build pipeline <a id="_idIndexMarker247"/>using the <strong class="bold">NUnit test framework</strong> and a sample C#.NET application created in .NET <span class="No-Break">Core 6.0.</span></p>
<p>We will assume you’re using a Visual Studio solution where you have a <strong class="source-inline">CalculusService</strong> Class Library project. The test projects are included. The following is the example code of this class in the Class <span class="No-Break">Library project:</span></p>
<pre class="source-code">
namespace CalculusService
{
    public class Additions
    {
        public int Add(int number1, int number2)
        {
            return number1 + number2;
        }
    }
}</pre> <p>The following corresponding unit test is defined in a separate test project. Make sure you have a <a id="_idIndexMarker248"/>reference to the <strong class="source-inline">Nunit</strong>, <strong class="source-inline">NUnit3TestAdapter</strong>, and <strong class="source-inline">NUnit.Analyzers</strong> <span class="No-Break">NuGet packages:</span></p>
<pre class="source-code">
namespace CalculusService.Tests
{
    [TestFixture]
    public class AdditionsTests
    {
        private Additions additions;
        [SetUp]
        public void Setup()
        {
            additions = new Additions();
        }
        [TestCase(1, 2, 3)]
        [TestCase(2, 4, 6)]
        [TestCase(5, -10, -5)]
        public void TestAdd(int number1, int number2, int result)
        {
            Assert.That(result, Is.EqualTo(additions.Add(number1, number2)));
        }
    }
}</pre> <p>You will need<a id="_idIndexMarker249"/> to use a YAML pipeline, as shown in the following code snippet, to build and execute the <span class="No-Break">automated tests:</span></p>
<pre class="source-code">
trigger:
- main
pool:
  vmImage: 'windows-latest'
variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Debug'
steps:
- task: NuGetToolInstaller@1
- task: NuGetCommand@2
  inputs:
    restoreSolution: '$(solution)'
- task: VSBuild@1
  inputs:
    solution: '$(solution)'
    msbuildArgs: '/p:PackageAsSingleFile=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'
- task: VSTest@2
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\*.Tests.dll
      !**\*TestAdapter.dll
      !**\obj\**
    codeCoverageEnabled: true
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'</pre> <p>The most <a id="_idIndexMarker250"/>important section of this pipeline is the last step, which uses the <strong class="source-inline">VSTest@2</strong> task. This is a generic and out-of-the-box task available in Azure Pipelines for running unit and functional tests that support several test frameworks that take advantage of Visual Studio’s Test Explorer. It’s also important to set the <strong class="source-inline">codeCoverageEnabled</strong> property to <strong class="source-inline">true</strong> so that you can collect data that indicates how much of the code in the application is <span class="No-Break">being tested.</span></p>
<p class="callout-heading">Pro tip</p>
<p class="callout">When configuring the <strong class="source-inline">VSTest</strong> task and using the <strong class="source-inline">testAssemblyVer2</strong> attribute, ensure that you provide a list of patterns to specifically find the test assemblies to execute tests in. Otherwise, you will find yourself with <span class="No-Break">cryptic errors.</span></p>
<p>With unit tests executed and code coverage enabled, you will see the results in the <span class="No-Break"><strong class="bold">Summary</strong></span><span class="No-Break"> window:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<img alt="Figure 6.5 – Test and coverage results in the Summary window" height="380" src="image/B18875_06_5.jpg" width="826"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.5 – Test and coverage results in the Summary window</p>
<p>The <a id="_idIndexMarker251"/>benefit of using this task is that it provides support for automatically publishing test results and UI reporting built into Azure Pipelines, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<img alt="Figure 6.6 – The test results included in the Azure Pipelines run" height="577" src="image/B18875_06_6.jpg" width="979"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.6 – The test results included in the Azure Pipelines run</p>
<p>The <strong class="source-inline">VSTest@2</strong> task also supports more advanced scenarios such as executing tests in parallel across multiple agents, which is useful when you have many tests to run, or executing UI tests, which require additional configuration in the agent that will be executing <span class="No-Break">the test.</span></p>
<p>If your application is built using other programming languages, you must use the corresponding test runner and ensure the results are published in any of the formats supported by the <strong class="source-inline">PublishTestResults@2</strong> task to be able to import them and include them in <span class="No-Break">the UI.</span></p>
<p>Now that we’ve learned about running tests in an automated way, let’s learn how to increase the quality of <span class="No-Break">your code.</span></p>
<h1 id="_idParaDest-76"><a id="_idTextAnchor076"/>Increasing code quality</h1>
<p>Typically, developers<a id="_idIndexMarker252"/> are too busy to focus on the quality of their code and end up taking advantage of different automated tools to make sure they are producing the best and most secure <span class="No-Break">application possible.</span></p>
<p>There are two important areas in this space <span class="No-Break">to understand:</span></p>
<ul>
<li><strong class="bold">Static application security testing</strong>: This allows you to detect vulnerabilities in <span class="No-Break">your code</span></li>
<li><strong class="bold">Software composition analysis</strong>: This allows you to detect vulnerabilities in references to external packages and libraries used in <span class="No-Break">your code</span></li>
</ul>
<p class="callout-heading">Why use tools to improve code quality?</p>
<p class="callout">Developers and testers can only do so much with the time they have available to meet timelines and work on application features. Introducing these tools early allows them to detect bugs and vulnerabilities that could otherwise be costly when the application is released to <span class="No-Break">end users.</span></p>
<p>There are many well-known third-party tools you can use to scan and assess your code quality. In this chapter, we will <a id="_idIndexMarker253"/>use <strong class="bold">SonarQube</strong> as it is one of the most popular and easy to use. It allows developers to ensure they are producing clean code by identifying bugs and security vulnerabilities, as well as detecting common anti-maintainability patterns and duplicate code, among <span class="No-Break">other things.</span></p>
<p>It comes in different pricing tiers, starting with the free Community Edition, which will be used for the examples in this chapter. If you want to get more programming language support in the tool or advanced vulnerability detection, you need one of the <span class="No-Break">paid tiers.</span></p>
<p>Checkmarx, Veracode, OWASP, WhiteSource, and HP Fortify are among many others available. It is <a id="_idIndexMarker254"/>beyond the scope of this book to compare these tools, but you can certainly find plenty of <span class="No-Break">comparisons online.</span></p>
<p>Follow these steps to set up SonarQube analysis on <span class="No-Break">your code:</span></p>
<ol>
<li>Configure a <span class="No-Break">SonarQube project.</span></li>
<li>Create a service connection to SonarQube in <span class="No-Break">Azure DevOps.</span></li>
<li>Create an Azure pipeline to analyze <span class="No-Break">your code.</span></li>
</ol>
<p>We’ll walk through these steps in the <span class="No-Break">following sections.</span></p>
<h2 id="_idParaDest-77"><a id="_idTextAnchor077"/>Configuring a SonarQube project</h2>
<p>In <a id="_idIndexMarker255"/>your SonarQube instance, proceed to create a project from the wizard by selecting the <strong class="bold">From Azure DevOps</strong> option, as shown in the <span class="No-Break">following figure:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<img alt="Figure 6.7 – Creating a project in SonarQube using the From Azure DevOps option" height="383" src="image/B18875_06_7.jpg" width="993"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.7 – Creating a project in SonarQube using the From Azure DevOps option</p>
<p>If this is the first time you are setting up a connection to Azure DevOps, SonarQube will prompt you for <strong class="bold">Configuration name</strong>, <strong class="bold">Azure DevOps URL</strong>, and <strong class="bold">Personal Access Token</strong> details so that it can configure <span class="No-Break">the project:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer166">
<img alt="Figure 6.8 – Create a configuration" height="625" src="image/B18875_06_8.jpg" width="797"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.8 – Create a configuration</p>
<p>Then, select<a id="_idIndexMarker256"/> the Azure DevOps project to configure in the SonarQube side by selecting it from the available list and clicking on the <strong class="bold">Set up selected </strong><span class="No-Break"><strong class="bold">repository</strong></span><span class="No-Break"> button:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<img alt="Figure 6.9 – Selecting an Azure DevOps project in SonarQube" height="416" src="image/B18875_06_9.jpg" width="893"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.9 – Selecting an Azure DevOps project in SonarQube</p>
<p>Once you’ve done this, you are ready to proceed with the configuration in the Azure DevOps and <span class="No-Break">pipeline side.</span></p>
<h2 id="_idParaDest-78"><a id="_idTextAnchor078"/>Creating a service connection to SonarQube in Azure DevOps</h2>
<p>The <a id="_idIndexMarker257"/>next step is to create a <strong class="bold">service connection</strong> to the SonarQube instance. This will allow Azure Pipelines to use the SonarQube extension and communicate with the <span class="No-Break">SonarQube instance.</span></p>
<p>You can create and manage service connections by choosing the <strong class="bold">Azure DevOps Project Settings</strong> option and clicking the <strong class="bold">New service connection</strong> button. This will show a listing where you can search for the right option by typing just a few characters in the search field. In this case, <strong class="source-inline">Sonar</strong> should list the <span class="No-Break">SonarQube option:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<img alt="Figure 6.10 – The SonarQube service connection option" height="279" src="image/B18875_06_10.jpg" width="452"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.10 – The SonarQube service connection option</p>
<p>The next step is to provide details in the <strong class="bold">Server Url</strong>, <strong class="bold">Token</strong>, <strong class="bold">Service connection name</strong>, and <strong class="bold">Description (optional)</strong> boxes. Don’t forget to check the <strong class="bold">Grant access permission to all pipelines</strong> option, unless you want to manage access to the service connection separately for <span class="No-Break">each pipeline:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<img alt="Figure 6.11 – Service connection details for SonarQube" height="645" src="image/B18875_06_11.jpg" width="461"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.11 – Service connection details for SonarQube</p>
<p class="callout-heading">Important note</p>
<p class="callout">Service connections <a id="_idIndexMarker258"/>are an easy and centralized way to define the credentials needed to communicate with a service outside of Azure DevOps, removing the need to enter <span class="No-Break">credentials everywhere.</span></p>
<h2 id="_idParaDest-79"><a id="_idTextAnchor079"/>Creating an Azure Pipeline to analyze your code</h2>
<p>The next step <a id="_idIndexMarker259"/>is to include two tasks available that are in the SonarQube extension in your build pipeline. Let’s look at the <span class="No-Break">following pipeline:</span></p>
<pre class="source-code">
pool:
  vmImage: 'windows-2019'
variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
steps:
- task: SonarQubePrepare@5
  inputs:
    SonarQube: 'SonarQube'
    scannerMode: 'MSBuild'
    projectKey: 'PacktAzureDevOps_SonarQubeIntegration_########'
- task: NuGetToolInstaller@1
- task: NuGetCommand@2
  inputs:
    restoreSolution: '$(solution)'
- task: VSBuild@1
  inputs:
    solution: '$(solution)'
    msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'
- task: SonarQubeAnalyze@5</pre> <p>The <strong class="source-inline">SonarQubePrepare</strong> task is needed to provide the context necessary to perform the analysis, for which the service connection, scanner mode, and project key in SonarQube must <a id="_idIndexMarker260"/>be provided. This task must be placed before any compilation tasks <span class="No-Break">are executed.</span></p>
<p>The <strong class="source-inline">SonarQubeAnalyze</strong> task is responsible for performing the security scan and must be placed after all tasks that compile code. It will use the information collected since the execution of the <strong class="source-inline">SonarQubePrepare</strong> task to perform all necessary data collection and analysis for the security scan. This task will fail the pipeline if it does not pass the conditions defined in the <span class="No-Break">SonarQube project.</span></p>
<h2 id="_idParaDest-80"><a id="_idTextAnchor080"/>Reviewing SonarQube analysis results</h2>
<p>The<a id="_idIndexMarker261"/> results of the security scan will be available in the SonarQube portal. Depending on the nature of your project, you will get different quality indicators and recommendations to improve your code, as shown in the <span class="No-Break">following figure:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer170">
<img alt="Figure 6.12 – SonarQube analysis results" height="664" src="image/B18875_06_12.jpg" width="1131"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.12 – SonarQube analysis results</p>
<p class="callout-heading">Important note</p>
<p class="callout">It is possible to use the <strong class="source-inline">SonarQubePublish</strong> task to include a brief summary and link to the full report in your Azure Pipeline summary. However, this is only available for paid tiers <span class="No-Break">of SonarQube.</span></p>
<p>SonarQube<a id="_idIndexMarker262"/> will provide you with insights regarding bugs, vulnerabilities, security hotspots, duplication of code, and many other issues that might be present in code, helping the developers solve these by finding them and providing instructions on how to best <span class="No-Break">fix them.</span></p>
<p>Integrating this type of tool into your pipelines provides a fast feedback loop for developers to fix and mitigate risks in the applications early in the development process and avoid costly mistakes if those were deployed to a <span class="No-Break">production environment.</span></p>
<p>Azure Pipelines can also be used to orchestrate the deployment of <strong class="bold">artifacts</strong> created in other systems, such as the popular CI/CD tool <strong class="bold">Jenkins</strong>. We’ll look at this in detail in the <span class="No-Break">next section.</span></p>
<h1 id="_idParaDest-81"><a id="_idTextAnchor081"/>Integrating with Jenkins for artifacts and release pipelines</h1>
<p>In this <a id="_idIndexMarker263"/>section, we will walk through a simple setup demonstrating how to connect Azure Pipelines and Jenkins so that you can download an artifact generated in Jenkins and deploy it via <span class="No-Break">release pipelines.</span></p>
<p>A <strong class="bold">Jenkins Job</strong> is <a id="_idIndexMarker264"/>like an Azure Pipeline, an automated set of steps that executes actions and can produce artifacts or perform deployments. Let’s learn how to create a simple <span class="No-Break">Jenkins job.</span></p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor082"/>Creating a Jenkins job that produces an artifact</h2>
<p>This scenario<a id="_idIndexMarker265"/> assumes that we have a project called <strong class="source-inline">PacktFamily</strong> in a Jenkins server, as shown in the <span class="No-Break">following figure:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer171">
<img alt="Figure 6.13 – A Jenkins instance with a PackFamily project" height="356" src="image/B18875_06_13.jpg" width="1020"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.13 – A Jenkins instance with a PackFamily project</p>
<p>The <a id="_idIndexMarker266"/>configuration for the Jenkins job is very simple in this scenario, solely to demonstrate the ability the download an artifact on the Azure Pipelines side. The following figure shows the build steps for <span class="No-Break">producing </span><span class="No-Break"><strong class="source-inline">artifact.txt</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<img alt="Figure 6.14 – The build step in a Jenkins job for creating the artifact" height="307" src="image/B18875_06_14.jpg" width="551"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.14 – The build step in a Jenkins job for creating the artifact</p>
<p>The following figure shows the post-build actions <span class="No-Break">for </span><span class="No-Break"><strong class="source-inline">artifact.txt</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer173">
<img alt="Figure 6.15 – Post-build action publishing the Jenkins artifact" height="194" src="image/B18875_06_15.jpg" width="543"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.15 – Post-build action publishing the Jenkins artifact</p>
<p>The execution of the Jenkins job will yield a single artifact that can be downloaded by <span class="No-Break">Azure Pipelines:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<img alt="Figure 6.16 – Jenkins job results and artifacts" height="465" src="image/B18875_06_16.jpg" width="616"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.16 – Jenkins job results and artifacts</p>
<p>Now that<a id="_idIndexMarker267"/> we have a Jenkins job, let’s learn how to integrate Azure Pipelines <span class="No-Break">with it.</span></p>
<h2 id="_idParaDest-83"><a id="_idTextAnchor083"/>Creating a service connection to Jenkins in Azure DevOps</h2>
<p>This process is <a id="_idIndexMarker268"/>similar to what we discussed in the <em class="italic">Creating a service connection to SonarQube in Azure DevOps</em> section. In Azure DevOps’ project settings, click on the <strong class="bold">Service Connections</strong> section and then the <strong class="bold">New service connection</strong> button. Use the search box to type <strong class="source-inline">Jenkins</strong> and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer175">
<img alt="Figure 6.17 – The New service connection dialogue" height="248" src="image/B18875_06_17.jpg" width="490"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.17 – The New service connection dialogue</p>
<p>Provide the <strong class="bold">Server URL</strong>, <strong class="bold">Username</strong>, <strong class="bold">Password</strong>, and <strong class="bold">Service connection name</strong> details. Don’t forget to check the <strong class="bold">Grant access permission to all pipelines</strong> box if needed. Finally, click<a id="_idIndexMarker269"/> the <strong class="bold">Verify and save</strong> button <span class="No-Break">to proceed:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer176">
<img alt="Figure 6.18 – The New Jenkins service connection dialog" height="780" src="image/B18875_06_18.jpg" width="492"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.18 – The New Jenkins service connection dialog</p>
<p>Now, we can proceed to create a pipeline that will use <span class="No-Break">the artifact.</span></p>
<h2 id="_idParaDest-84"><a id="_idTextAnchor084"/>Creating a release pipeline to use Jenkins artifacts</h2>
<p>Now, it is <a id="_idIndexMarker270"/>time to configure a release pipeline. You can follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Navigate to <strong class="bold">Project</strong> | <strong class="bold">Pipelines</strong> | <strong class="bold">Releases</strong> and click <strong class="bold">New release pipeline</strong>. You will have the option to select a template, as shown in the following screenshot. We will start<a id="_idIndexMarker271"/> with an <span class="No-Break"><strong class="bold">empty job</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer177">
<img alt="Figure 6.19 – Selecting a template for a release pipeline" height="399" src="image/B18875_06_19.jpg" width="675"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.19 – Selecting a template for a release pipeline</p>
<ol>
<li value="2">By clicking<a id="_idIndexMarker272"/> on the <strong class="bold">Add an artifact</strong> widget and then the <strong class="bold">Jenkins</strong> option, you will be able to use the previously created service connection to pick the project in Jenkins from where you will use artifacts. Just pick the service connection that matches the name you created in the previous step and then the corresponding <strong class="bold">Source (</strong><span class="No-Break"><strong class="bold">job)</strong></span><span class="No-Break"> option:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer178">
<img alt="Figure 6.20 – Adding a Jenkins artifact to a release pipeline" height="858" src="image/B18875_06_20.jpg" width="1358"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.20 – Adding a Jenkins artifact to a release pipeline</p>
<ol>
<li value="3">You have the option to change the <strong class="bold">Source alias</strong> detail, which will be used as the directory where you can download artifacts once the pipeline executes. This is important when you have multiple artifacts from potentially different sources, to avoid any files from being overwritten when the pipeline executes. In this case, the default value <span class="No-Break">will work.</span></li>
<li>Once we’ve <a id="_idIndexMarker273"/>done this, we can add steps to the <strong class="bold">Deploy</strong> stage to verify and even print out the content of the artifact. Clicking on the <strong class="bold">1 job, 0 task</strong> option in the <strong class="bold">Deploy</strong> stage will allow us to customize the pipeline. For this scenario, we will use a Linux agent. Clicking on the <strong class="bold">Agent job</strong> option, as shown in the following screenshot, gives us access to the <strong class="bold">Agent selection</strong> section. Now, we can select <strong class="bold">Azure Pipelines</strong> from the <strong class="bold">Agent pool</strong> dropdown and <strong class="bold">ubuntu latest</strong> from the <strong class="bold">Agent Specification</strong> dropdown within the <strong class="bold">Agent </strong><span class="No-Break"><strong class="bold">selection</strong></span><span class="No-Break"> section:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer179">
<img alt="Figure 6.21 – Selecting an agent in the Deploy stage" height="392" src="image/B18875_06_21.jpg" width="898"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.21 – Selecting an agent in the Deploy stage</p>
<ol>
<li value="5">Once you’ve<a id="_idIndexMarker274"/> done this, click on the <strong class="bold">+</strong> button on the right-hand side of the <strong class="bold">Agent Job</strong> section to look up the <strong class="bold">Command line</strong> task to add it. This task can execute a custom script in the agent and will switch to the appropriate underlying process, depending on the <span class="No-Break">operating system:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer180">
<img alt="Figure 6.22 – The command-line task to list the contents of the artifact" height="448" src="image/B18875_06_22.jpg" width="840"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.22 – The command-line task to list the contents of the artifact</p>
<p class="list-inset">Let’s look at the script we used to show <span class="No-Break">the contents:</span></p>
<pre class="source-code">
ls -la
cd _PacktFamily
ls -la
echo "Show content of file artifact.txt file:"
cat artifact.txt</pre> <p class="list-inset">This script will do <span class="No-Break">the following:</span></p>
<ul>
<li>List the <a id="_idIndexMarker275"/>contents of the current directory, which should be where the agent is running the <span class="No-Break">current pipeline</span></li>
<li>Move into the directory where the Jenkins artifacts <span class="No-Break">were downloaded</span></li>
<li>List the contents of the current directory, which should be where the Jenkins artifacts <span class="No-Break">were downloaded</span></li>
<li>Print a label indicating the contents of the file that will <span class="No-Break">be displayed</span></li>
<li>Print the contents of the <span class="No-Break"><strong class="source-inline">artifact.txt</strong></span><span class="No-Break"> file</span></li>
</ul>
<ol>
<li value="6">Once you’ve saved the pipeline and created a release to execute it, you should be able to see that it effectively downloads the artifacts from Jenkins and lists the contents of the file, as shown in the <span class="No-Break">following figure:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer181">
<img alt="Figure 6.23 – The logs of the pipeline downloading Jenkins artifacts" height="445" src="image/B18875_06_23.jpg" width="1119"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.23 – The logs of the pipeline downloading Jenkins artifacts</p>
<p class="callout-heading">Important note</p>
<p class="callout">The <strong class="bold">Azure Pipelines</strong> option in the <strong class="bold">Agent selection</strong> section provides access to Microsoft-hosted agents. These are managed by the Azure DevOps platform without you needing to manage the underlying infrastructure. Several operating systems are supported and different versions also include different tools already installed in them to facilitate building and deploying applications. You also have the option to purchase parallel jobs capacity so that you can run multiple jobs at the same time. If needed, you can also install any required software in these agents during the pipeline’s execution. Just remember that these will increase the <span class="No-Break">execution time.</span></p>
<p>With that, we’ve <a id="_idIndexMarker276"/>completed <span class="No-Break">this chapter.</span></p>
<h1 id="_idParaDest-85"><a id="_idTextAnchor085"/>Summary</h1>
<p>In this chapter, we learned about the extensibility model of Azure DevOps and how the marketplace of extensions makes it extremely easy to find additional features to include in your build and release pipelines with ease. This will speed up your ability to create build and release pipelines and integrate them with other tools. We also learned how to increase the quality of our applications by integrating automated tests and security scans to alert developers in case something breaks or introduces a vulnerability, which will reduce the amount of time needed to find bugs, fix them, and reduce security risks before you deploy your applications to the final production environments. Then, we learned how to integrate Azure Pipelines to download artifacts from another CI/CD tool and use it for deployment, which can be useful in hybrid setups where not all teams are using the same CI/CD tools. Finally, we learned about the flexibility of the Microsoft-hosted agents that are available in Azure Pipelines. This allows you to implement your CI/CD needs without having to manage <span class="No-Break">the infrastructure.</span></p>
<p>In the next chapter, we will learn about monitoring Azure DevOps Pipelines, an important task that will ensure everything is working correctly and that if things go wrong, we get the visibility needed to fix <span class="No-Break">them promptly.</span></p>
</div>
</div></body></html>