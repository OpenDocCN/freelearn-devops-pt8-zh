<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Installing and Running LXC on Linux Systems"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Installing and Running LXC on Linux Systems</h1></div></div></div><p>LXC takes advantage of the kernel namespaces and cgroups to create process isolation we call containers, as we saw in the previous chapter. As such, LXC is not a separate software component in the Linux kernel, but rather a set of userspace tools, the <code class="literal">liblxc</code> library, and various language bindings.</p><p>In this chapter, we'll cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing LXC on Ubuntu and CentOS using distribution packages</li><li class="listitem" style="list-style-type: disc">Compiling and installing LXC from source code</li><li class="listitem" style="list-style-type: disc">Building and starting containers using the provided templates and configuration files</li><li class="listitem" style="list-style-type: disc">Manually building the root filesystem and configuration files using tools such as <code class="literal">debootstrap</code> and <code class="literal">yum</code></li></ul></div><div class="section" title="Installing LXC"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec11"/>Installing LXC</h1></div></div></div><p>At the time of writing this book, there are two long-term support versions of LXC: 1.0 and 2.0. The userspace tools that they provide have some minor differences in command-line flags and deprecations, which I'll be pointing out as we use them.</p><div class="section" title="Installing LXC on Ubuntu with apt"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Installing LXC on Ubuntu with apt</h2></div></div></div><p>Let's start by installing LXC 1.0 on Ubuntu 14.04.5 (Trusty Tahr):</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the main LXC package, tooling, and dependencies:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lsb_release -dc</strong></span>
<span class="strong"><strong>Description:       Ubuntu 14.04.5 LTS</strong></span>
<span class="strong"><strong>Codename:          trusty&#13;</strong></span>
<span class="strong"><strong>root@ubuntu:~# apt-get -y install -y lxc bridge-utils &#13;
      debootstrap libcap-dev &#13;
      cgroup-bin libpam-systemdbridge-utils</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre></li><li class="listitem">The package version that Trusty Tahr provides at this time is 1.0.8:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# dpkg --list | grep lxc | awk '{print $2,$3}'</strong></span>
<span class="strong"><strong>liblxc1 1.0.8-0ubuntu0.3</strong></span>
<span class="strong"><strong>lxc 1.0.8-0ubuntu0.3</strong></span>
<span class="strong"><strong>lxc-templates 1.0.8-0ubuntu0.3</strong></span>
<span class="strong"><strong>python3-lxc 1.0.8-0ubuntu0.3</strong></span>
<span class="strong"><strong>root@ubuntu:~# </strong></span>
</pre></li></ol></div><p>To install LXC 2.0, we'll need the Backports repository:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following two lines in the <code class="literal">apt</code> sources file:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# vim /etc/apt/sources.list</strong></span>
<span class="strong"><strong>deb http://archive.ubuntu.com/ubuntu trusty-backports main &#13;
      restricted universe multiverse</strong></span>
<span class="strong"><strong>deb-src http://archive.ubuntu.com/ubuntu trusty-backports &#13;
      main restricted universe multiverse</strong></span>
</pre></li><li class="listitem">Resynchronize the package index files from their sources:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# apt-get update</strong></span>
</pre></li><li class="listitem">Install the main LXC package, tooling, and dependencies:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# apt-get -y install -y &#13;
      lxc=2.0.3-0ubuntu1~ubuntu14.04.1 &#13;
      lxc1=2.0.3-0ubuntu1~ubuntu14.04.1 &#13;
      liblxc1=2.0.3-0ubuntu1~ubuntu14.04.1 python3-&#13;
      lxc=2.0.3-0ubuntu1~ubuntu14.04.1 cgroup-&#13;
      lite=1.11~ubuntu14.04.2 &#13;
      lxc-templates=2.0.3-0ubuntu1~ubuntu14.04.1bridge-utils</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre></li><li class="listitem">Ensure the package versions are on the 2.x branch, in this case 2.0.3:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# dpkg --list | grep lxc | awk '{print $2,$3}'</strong></span>
<span class="strong"><strong>liblxc1 2.0.3-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>lxc2.0.3-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>lxc-common    2.0.3-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>lxc-templates 2.0.3-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>lxc1          2.0.3-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>lxcfs         2.0.2-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>python3-lxc   2.0.3-0ubuntu1~ubuntu14.04.1</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre></li></ol></div></div><div class="section" title="Installing LXC on Ubuntu from source"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>Installing LXC on Ubuntu from source</h2></div></div></div><p>To use the latest version of LXC, you can download the source code from the upstream GitHub repository and compile it:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, let's install <code class="literal">git</code> and clone the repository:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# apt-get install git</strong></span>
<span class="strong"><strong>root@ubuntu:~# cd /usr/src</strong></span>
<span class="strong"><strong>root@ubuntu:/usr/src# git clone https://github.com/lxc/lxc.git</strong></span>
<span class="strong"><strong>Cloning into 'lxc'...</strong></span>
<span class="strong"><strong>remote: Counting objects: 29252, done.</strong></span>
<span class="strong"><strong>remote: Compressing objects: 100% (156/156), done.</strong></span>
<span class="strong"><strong>remote: Total 29252 (delta 101), reused 0 (delta 0), &#13;
      pack-reused 29096</strong></span>
<span class="strong"><strong>Receiving objects: 100% (29252/29252), 11.96 MiB | 12.62 &#13;
      MiB/s, done.</strong></span>
<span class="strong"><strong>Resolving deltas: 100% (21389/21389), done.</strong></span>
<span class="strong"><strong>root@ubuntu:/usr/src#</strong></span>
</pre></li><li class="listitem">Next, let's install the build tools and various dependencies:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src# apt-get install -y dev-utils &#13;
      build-essential aclocal automake pkg-config git bridge-utils &#13;
      libcap-dev libcgmanager-dev cgmanager</strong></span>
<span class="strong"><strong>root@ubuntu:/usr/src#</strong></span>
</pre></li><li class="listitem">Now, generate the <code class="literal">configure</code> shell script, which will attempt to guess correct values for different system-dependent variables used during compilation:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src# cd lxc</strong></span>
<span class="strong"><strong>root@ubuntu:/usr/src/lxc#./autogen.sh</strong></span>
</pre></li><li class="listitem">The <code class="literal">configure</code> script provides options that can be enabled or disabled based on what features you would like to be compiled. To learn what options are available and for a short description of each, run the following:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src/lxc# ./configure -help</strong></span>
</pre></li><li class="listitem">Its time now to run <code class="literal">configure</code>. In this example, I'll enable Linux capabilities and <code class="literal">cgmanager</code>, which will manage the cgroups for each container:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src/lxc# ./configure --enable-capabilities &#13;
      --enable-cgmanager</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>----------------------------</strong></span>
<span class="strong"><strong>Environment:</strong></span>
<span class="strong"><strong>   - compiler: gcc</strong></span>
<span class="strong"><strong>   - distribution: ubuntu</strong></span>
<span class="strong"><strong>   - init script type(s): upstart,systemd</strong></span>
<span class="strong"><strong>   - rpath: no</strong></span>
<span class="strong"><strong>   - GnuTLS: no</strong></span>
<span class="strong"><strong>   - Bash integration: yes</strong></span>
<span class="strong"><strong>Security features:</strong></span>
<span class="strong"><strong>   - Apparmor: no</strong></span>
<span class="strong"><strong>   - Linux capabilities: yes</strong></span>
<span class="strong"><strong>   - seccomp: no</strong></span>
<span class="strong"><strong>   - SELinux: no</strong></span>
<span class="strong"><strong>   - cgmanager: yes</strong></span>
<span class="strong"><strong>Bindings:</strong></span>
<span class="strong"><strong>   - lua: no</strong></span>
<span class="strong"><strong>   - python3: no</strong></span>
<span class="strong"><strong>Documentation:</strong></span>
<span class="strong"><strong>   - examples: yes</strong></span>
<span class="strong"><strong>   - API documentation: no</strong></span>
<span class="strong"><strong>   - user documentation: no</strong></span>
<span class="strong"><strong>Debugging:</strong></span>
<span class="strong"><strong>   - tests: no</strong></span>
<span class="strong"><strong>   - mutex debugging: no</strong></span>
<span class="strong"><strong>Paths:</strong></span>
<span class="strong"><strong>Logs in configpath: no</strong></span>
<span class="strong"><strong>root@ubuntu:/usr/src/lxc#</strong></span>
</pre><p>From the preceding abbreviated output we can see what options are going to be available after compilation. Notice that we are not enabling any of the security features for now, such as <code class="literal">Apparmor</code>.</p></li><li class="listitem">Next, compile with <code class="literal">make</code>:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src/lxc# make</strong></span>
</pre></li><li class="listitem">Finally, install the binaries, libraries, and templates:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src/lxc# make install</strong></span>
</pre><p>As of this writing, the LXC binaries look for their libraries in a different path than where they were installed. To fix this just copy them to the correct location:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src/lxc# cp /usr/local/lib/liblxc.so* &#13;
      /usr/lib/x86_64-linux-gnu/</strong></span>
</pre></li><li class="listitem">To check the version that was compiled and installed, execute the following code:<pre class="programlisting">
<span class="strong"><strong>root@ubuntu:/usr/src/lxc# lxc-create --version</strong></span>
<span class="strong"><strong>2.0.0</strong></span>
<span class="strong"><strong>root@ubuntu:/usr/src/lxc#  </strong></span>
</pre></li></ol></div></div><div class="section" title="Installing LXC on CentOS with yum"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Installing LXC on CentOS with yum</h2></div></div></div><p>CentOS 7 currently provides LXC version 1.0.8 in their upstream repositories. The following instructions should work on RHEL 7 and CentOS 7:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the main package and distribution templates:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# cat /etc/redhat-release</strong></span>
<span class="strong"><strong>CentOS Linux release 7.2.1511 (Core)</strong></span>
<span class="strong"><strong>root@centos:~# yum install -y lxc lxc-templates</strong></span>
<span class="strong"><strong>root@centos:~#</strong></span>
</pre></li><li class="listitem">Check the installed package versions:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# rpm -qa | grep lxc</strong></span>
<span class="strong"><strong>lua-lxc-1.0.8-1.el7.x86_64</strong></span>
<span class="strong"><strong>lxc-templates-1.0.8-1.el7.x86_64</strong></span>
<span class="strong"><strong>lxc-libs-1.0.8-1.el7.x86_64</strong></span>
<span class="strong"><strong>lxc-1.0.8-1.el7.x86_64</strong></span>
<span class="strong"><strong>root@centos:~#</strong></span>
</pre></li></ol></div></div><div class="section" title="Installing LXC on CentOS from source"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Installing LXC on CentOS from source</h2></div></div></div><p>To install the latest version of LXC, we need to download it from GitHub and compile it, similar to what we did on Ubuntu:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the build utilities, <code class="literal">git</code>, and various dependencies:<pre class="programlisting">
<span class="strong"><strong>root@centos:# cd /usr/src</strong></span>
<span class="strong"><strong>root@centos:/usr/src# yum install -y libcap-devel libcgroup &#13;
      bridge-utils git</strong></span>
<span class="strong"><strong>root@centos:/usr/src# yum groupinstall "Development tools"</strong></span>
<span class="strong"><strong>root@centos:/usr/src#</strong></span>
</pre></li><li class="listitem">Next, clone the repository:<pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src# git clone https://github.com/lxc/lxc.git</strong></span>
<span class="strong"><strong>root@centos:/usr/src# cd lxc/</strong></span>
<span class="strong"><strong>root@centos:/usr/src/lxc#</strong></span>
</pre></li><li class="listitem">Generate the config file:<pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src/lxc# ./autogen.sh</strong></span>
<span class="strong"><strong>root@centos:/usr/src#</strong></span>
</pre></li><li class="listitem">Prepare the software for compilation:<pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src/lxc# ./configure</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>----------------------------</strong></span>
<span class="strong"><strong>Environment:</strong></span>
<span class="strong"><strong>   - compiler: gcc</strong></span>
<span class="strong"><strong>   - distribution: centos</strong></span>
<span class="strong"><strong>   - init script type(s): sysvinit</strong></span>
<span class="strong"><strong>   - rpath: no</strong></span>
<span class="strong"><strong>   - GnuTLS: no</strong></span>
<span class="strong"><strong>   - Bash integration: yes</strong></span>
<span class="strong"><strong>Security features:</strong></span>
<span class="strong"><strong>   - Apparmor: no</strong></span>
<span class="strong"><strong>   - Linux capabilities: yes</strong></span>
<span class="strong"><strong>   - seccomp: no</strong></span>
<span class="strong"><strong>   - SELinux: no</strong></span>
<span class="strong"><strong>   - cgmanager: no</strong></span>
<span class="strong"><strong>Bindings:</strong></span>
<span class="strong"><strong>   - lua: no</strong></span>
<span class="strong"><strong>   - python3: no</strong></span>
<span class="strong"><strong>Documentation:</strong></span>
<span class="strong"><strong>   - examples: yes</strong></span>
<span class="strong"><strong>   - API documentation: yes</strong></span>
<span class="strong"><strong>   - user documentation: no</strong></span>
<span class="strong"><strong>Debugging:</strong></span>
<span class="strong"><strong>   - tests: no</strong></span>
<span class="strong"><strong>   - mutex debugging: no</strong></span>
<span class="strong"><strong>Paths:</strong></span>
<span class="strong"><strong>Logs in configpath: no</strong></span>
<span class="strong"><strong>root@centos:/usr/src/lxc#</strong></span>
</pre></li><li class="listitem">Compile and install the binaries, libraries, and distribution templates:<pre class="programlisting">
<span class="strong"><strong>      root@centos:/usr/src/lxc# make &amp;&amp; make install</strong></span>
</pre></li><li class="listitem">Copy the libraries to where the binaries are expecting them:<pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src/lxc# cp /usr/local/lib/liblxc.so* &#13;
      /usr/lib64/</strong></span>
</pre></li><li class="listitem">Finally, to check the version that was compiled and installed, execute the following code:<pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src/lxc# lxc-create --version</strong></span>
<span class="strong"><strong>2.0.0</strong></span>
<span class="strong"><strong>root@centos:/usr/src/lxc#</strong></span>
</pre><p>CentOS 7 ships with <code class="literal">systemd</code> as its init system. To start the LXC service, run the following:</p><pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src/lxc# systemctl start lxc.service</strong></span>
<span class="strong"><strong>root@centos:/usr/src/lxc# systemctl status lxc.service</strong></span>
<span class="strong"><strong>   * lxc.service - LXC Container Initialization and Autoboot &#13;
      Code</strong></span>
<span class="strong"><strong>Loaded: loaded (/usr/lib/systemd/system/lxc.service; &#13;
      disabled; vendor preset: disabled)</strong></span>
<span class="strong"><strong>Active: active (exited) since Tue 2016-08-30 20:03:58 &#13;
      UTC; 6min ago</strong></span>
<span class="strong"><strong>Process: 10645 ExecStart=/usr/libexec/lxc/lxc-autostart-&#13;
      helper start (code=exited, status=0/SUCCESS)</strong></span>
<span class="strong"><strong>Process: 10638 ExecStartPre=/usr/libexec/lxc/lxc-devsetup &#13;
      (code=exited, status=0/SUCCESS)</strong></span>
<span class="strong"><strong>Main PID: 10645 (code=exited, status=0/SUCCESS)</strong></span>
<span class="strong"><strong>CGroup: /system.slice/lxc.service</strong></span>
<span class="strong"><strong>Aug 30 20:03:28 centos systemd[1]: Starting LXC Container &#13;
      Initialization and Autoboot Code...</strong></span>
<span class="strong"><strong>Aug 30 20:03:28 centos lxc-devsetup[10638]: Creating &#13;
      /dev/.lxc</strong></span>
<span class="strong"><strong>Aug 30 20:03:28 centos lxc-devsetup[10638]: /dev is devtmpfs</strong></span>
<span class="strong"><strong>Aug 30 20:03:28 centos lxc-devsetup[10638]: Creating &#13;
      /dev/.lxc/user</strong></span>
<span class="strong"><strong>Aug 30 20:03:58 centos lxc-autostart-helper[10645]: Starting &#13;
      LXC autoboot containers:  [  OK  ]</strong></span>
<span class="strong"><strong>Aug 30 20:03:58 nova systemd[1]: Started LXC Container &#13;
      Initialization and Autoboot Code.</strong></span>
<span class="strong"><strong>root@centos:/usr/src/lxc#</strong></span>
</pre><p>To ensure LXC was configured correctly during installation, run the following:</p><pre class="programlisting">
<span class="strong"><strong>root@centos:/usr/src/lxc# lxc-checkconfig</strong></span>
<span class="strong"><strong>Kernel configuration found at /boot/config-&#13;
      3.10.0-327.28.2.el7.x86_64</strong></span>
<span class="strong"><strong>--- Namespaces ---</strong></span>
<span class="strong"><strong>Namespaces: enabled</strong></span>
<span class="strong"><strong>Utsname namespace: enabled</strong></span>
<span class="strong"><strong>Ipc namespace: enabled</strong></span>
<span class="strong"><strong>Pid namespace: enabled</strong></span>
<span class="strong"><strong>User namespace: enabled</strong></span>
<span class="strong"><strong>Network namespace: enabled</strong></span>
<span class="strong"><strong>Multiple /dev/pts instances: enabled</strong></span>
<span class="strong"><strong>--- Control groups ---</strong></span>
<span class="strong"><strong>Cgroup: enabled</strong></span>
<span class="strong"><strong>Cgroup clone_children flag: enabled</strong></span>
<span class="strong"><strong>Cgroup device: enabled</strong></span>
<span class="strong"><strong>Cgroup sched: enabled</strong></span>
<span class="strong"><strong>Cgroup cpu account: enabled</strong></span>
<span class="strong"><strong>Cgroup memory controller: enabled</strong></span>
<span class="strong"><strong>Cgroup cpuset: enabled</strong></span>
<span class="strong"><strong>--- Misc ---</strong></span>
<span class="strong"><strong>Veth pair device: enabled</strong></span>
<span class="strong"><strong>Macvlan: enabled</strong></span>
<span class="strong"><strong>Vlan: enabled</strong></span>
<span class="strong"><strong>Bridges: enabled</strong></span>
<span class="strong"><strong>Advanced netfilter: enabled</strong></span>
<span class="strong"><strong>CONFIG_NF_NAT_IPV4: enabled</strong></span>
<span class="strong"><strong>CONFIG_NF_NAT_IPV6: enabled</strong></span>
<span class="strong"><strong>CONFIG_IP_NF_TARGET_MASQUERADE: enabled</strong></span>
<span class="strong"><strong>CONFIG_IP6_NF_TARGET_MASQUERADE: enabled</strong></span>
<span class="strong"><strong>CONFIG_NETFILTER_XT_TARGET_CHECKSUM: enabled</strong></span>
<span class="strong"><strong>--- Checkpoint/Restore ---</strong></span>
<span class="strong"><strong>checkpoint restore: enabled</strong></span>
<span class="strong"><strong>CONFIG_FHANDLE: enabled</strong></span>
<span class="strong"><strong>CONFIG_EVENTFD: enabled</strong></span>
<span class="strong"><strong>CONFIG_EPOLL: enabled</strong></span>
<span class="strong"><strong>CONFIG_UNIX_DIAG: enabled</strong></span>
<span class="strong"><strong>CONFIG_INET_DIAG: enabled</strong></span>
<span class="strong"><strong>CONFIG_PACKET_DIAG: enabled</strong></span>
<span class="strong"><strong>CONFIG_NETLINK_DIAG: enabled</strong></span>
<span class="strong"><strong>File capabilities: enabled</strong></span>
<span class="strong"><strong>   Note : Before booting a new kernel, you can check its </strong></span>
<span class="strong"><strong>      configuration:</strong></span>
<span class="strong"><strong>usage : CONFIG=/path/to/config /usr/bin/lxc-checkconfig</strong></span>
<span class="strong"><strong>root@centos:/usr/src/lxc#</strong></span>
</pre></li></ol></div></div><div class="section" title="LXC directory installation layout"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>LXC directory installation layout</h2></div></div></div><p>The following table shows the directory layout of LXC that is created after package and source installation. The directories vary depending on the distribution and installation method:</p><div class="informaltable"><table border="1"><colgroup><col/><col/><col/><col/></colgroup><tbody><tr><td>
<p><span class="strong"><strong>Ubuntu package</strong></span></p>
</td><td>
<p><span class="strong"><strong>CentOS package</strong></span></p>
</td><td>
<p><span class="strong"><strong>Source installation</strong></span></p>
</td><td>
<p><span class="strong"><strong>Description</strong></span></p>
</td></tr><tr><td>
<p><code class="literal">/usr/share/lxc</code></p>
</td><td>
<p><code class="literal">/usr/share/</code><code class="literal"> lxc</code></p>
</td><td>
<p><code class="literal">/usr/local/share/</code><code class="literal"> lxc</code></p>
</td><td>
<p>LXC base directory</p>
</td></tr><tr><td>
<p><code class="literal">/usr/share/lxc/</code><code class="literal"> config</code></p>
</td><td>
<p><code class="literal">/usr/share/lxc/</code><code class="literal"> config</code></p>
</td><td>
<p><code class="literal">/usr/local/share/lxc/</code><code class="literal"> config</code></p>
</td><td>
<p>Collection of distribution-based LXC configuration files</p>
</td></tr><tr><td>
<p><code class="literal">/usr/share/lxc/</code><code class="literal"> templates</code></p>
</td><td>
<p><code class="literal">/usr/share/lxc/</code><code class="literal"> templates</code></p>
</td><td>
<p><code class="literal">/usr/local/share/lxc/</code><code class="literal"> template</code>s</p>
</td><td>
<p>Collection of container template scripts</p>
</td></tr><tr><td>
<p><code class="literal">/usr/bin</code></p>
</td><td>
<p><code class="literal">/usr/bin</code></p>
</td><td>
<p><code class="literal">/usr/local/bin</code></p>
</td><td>
<p>Location for most LXC binaries</p>
</td></tr><tr><td>
<p><code class="literal">/usr/lib/x86_64-linux-gnu</code></p>
</td><td>
<p><code class="literal">/usr/lib64</code></p>
</td><td>
<p><code class="literal">/usr/local/lib</code></p>
</td><td>
<p>Location of <code class="literal">liblxc</code> libraries</p>
</td></tr><tr><td>
<p><code class="literal">/etc/lxc</code></p>
</td><td>
<p><code class="literal">/etc/lxc</code></p>
</td><td>
<p><code class="literal">/usr/local/etc/</code><code class="literal"> lxc</code></p>
</td><td>
<p>Location of default LXC config files</p>
</td></tr><tr><td>
<p><code class="literal">/var/lib/</code><code class="literal"> lxc/</code></p>
</td><td>
<p><code class="literal">/var/lib/</code><code class="literal"> lxc/</code></p>
</td><td>
<p><code class="literal">/usr/local/var/</code><code class="literal"> lib/lxc/</code></p>
</td><td>
<p>Location of the root filesystem and config for created containers</p>
</td></tr><tr><td>
<p><code class="literal">/var/log/lxc</code></p>
</td><td>
<p><code class="literal">/var/log/lxc</code></p>
</td><td>
<p><code class="literal">/usr/local/var/</code><code class="literal"> log/lxc</code></p>
</td><td>
<p>LXC log files</p>
</td></tr></tbody></table></div><p>We will explore most of the directories while building, starting, and terminating LXC containers.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip8"/>Tip</h3><p>You can change the default installation path when building LXC from source by passing arguments to the configuration script such as <code class="literal">configure --prefix</code>.</p></div></div></div></div></div>
<div class="section" title="Building and manipulating LXC containers"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Building and manipulating LXC containers</h1></div></div></div><p>Managing the container life cycle with the provided userspace tools is quite convenient compared to manually creating namespaces and applying resource limits with cgroups. In essence, this is exactly what the LXC tools do: creation and manipulation of the namespaces and cgroups we saw in <a class="link" href="ch02.html" title="Chapter 2. Installing and Running LXC on Linux Systems"><span>Chapter 1</span></a>, <span class="emphasis"><em>Introduction to Linux Containers</em></span>. The LXC tooling implements functions defined in the <code class="literal">liblxc</code> API, as we'll see in <a class="link" href="ch04.html" title="Chapter 4. LXC Code Integration with Python"><span>Chapter 4</span></a>, <span class="emphasis"><em>LXC Code Integration with Python</em></span>.</p><p>LXC comes packaged with various templates for building root filesystems for different Linux distributions. We can use them to create a variety of container flavors. For example, running a Debian container on a CentOS host. We also have the option of building our own root filesystem with tools such as <code class="literal">debootstrap</code> and <code class="literal">yum</code>, which we will explore shortly.</p><div class="section" title="Building our first container"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Building our first container</h2></div></div></div><p>We can create our first container using a template. The <code class="literal">lxc-download</code> file, like the rest of the templates in the <code class="literal">templates</code> directory, is a script written in bash:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# ls -la /usr/share/lxc/templates/</strong></span>
<span class="strong"><strong>drwxr-xr-x 2 root root  4096 Aug 29 20:03 .</strong></span>
<span class="strong"><strong>drwxr-xr-x 6 root root  4096 Aug 29 19:58 ..</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 10557 Nov 18  2015 lxc-alpine</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 13534 Nov 18  2015 lxc-altlinux</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 10556 Nov 18  2015 lxc-archlinux</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root  9878 Nov 18  2015 lxc-busybox</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 29149 Nov 18  2015 lxc-centos</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 10486 Nov 18  2015 lxc-cirros</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 17354 Nov 18  2015 lxc-debian</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 17757 Nov 18  2015 lxc-download</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 49319 Nov 18  2015 lxc-fedora</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 28253 Nov 18  2015 lxc-gentoo</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 13962 Nov 18  2015 lxc-openmandriva</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 14046 Nov 18  2015 lxc-opensuse</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 35540 Nov 18  2015 lxc-oracle</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 11868 Nov 18  2015 lxc-plamo</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root  6851 Nov 18  2015 lxc-sshd</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 23494 Nov 18  2015 lxc-ubuntu</strong></span>
<span class="strong"><strong>-rwxr-xr-x 1 root root 11349 Nov 18  2015 lxc-ubuntu-cloud</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>If you examine the scripts closely, you'll notice that most of them create the <code class="literal">chroot</code> environments, where packages and various configuration files are then installed to create the root filesystem for the selected distribution.</p><p>Let's start by building a container using the <code class="literal">lxc-download</code> template, which will ask for the distribution, release, and architecture, then use the appropriate template to create the filesystem and configuration for us:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-create -t download -n c1</strong></span>
<span class="strong"><strong>Setting up the GPG keyring</strong></span>
<span class="strong"><strong>Downloading the image index</strong></span>
<span class="strong"><strong>---</strong></span>
<span class="strong"><strong>DIST       RELEASE    ARCH       VARIANT    BUILD</strong></span>
<span class="strong"><strong>---</strong></span>
<span class="strong"><strong>centos    6          amd64      default    20160831_02:16</strong></span>
<span class="strong"><strong>centos    6          i386       default    20160831_02:16</strong></span>
<span class="strong"><strong>centos    7          amd64      default    20160831_02:16</strong></span>
<span class="strong"><strong>debian    jessie     amd64      default    20160830_22:42</strong></span>
<span class="strong"><strong>debian    jessie     arm64      default    20160824_22:42</strong></span>
<span class="strong"><strong>debian    jessie     armel      default    20160830_22:42</strong></span>
<span class="strong"><strong>... </strong></span>
<span class="strong"><strong>ubuntu    trusty     amd64      default    20160831_03:49</strong></span>
<span class="strong"><strong>ubuntu    trusty     arm64      default    20160831_07:50</strong></span>
<span class="strong"><strong>ubuntu    yakkety    s390x      default    20160831_03:49</strong></span>
<span class="strong"><strong>---</strong></span>
<span class="strong"><strong>Distribution: ubuntu</strong></span>
<span class="strong"><strong>Release: trusty</strong></span>
<span class="strong"><strong>Architecture: amd64</strong></span>
<span class="strong"><strong>Unpacking the rootfs</strong></span>
<span class="strong"><strong>---</strong></span>
<span class="strong"><strong>You just created an Ubuntu container (release=trusty, arch=amd64, variant=default)</strong></span>
<span class="strong"><strong>To enable sshd, run: apt-get install openssh-server</strong></span>
<span class="strong"><strong>For security reason, container images ship without user accounts</strong></span>
<span class="strong"><strong>and without a root password.</strong></span>
<span class="strong"><strong>Use lxc-attach or chroot directly into the rootfs to set a root password</strong></span>
<span class="strong"><strong>or &#13;
create user accounts.</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>Let's list all containers:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-ls -f</strong></span>
<span class="strong"><strong>NAME                  STATE    IPV4  IPV6  AUTOSTART</strong></span>
<span class="strong"><strong>----------------------------------------------------</strong></span>
<span class="strong"><strong>c1                    STOPPED  -     -     NO</strong></span>
<span class="strong"><strong>root@nova-perf:~#</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip9"/>Tip</h3><p>Depending on the version of LXC, some of the command options might be different. Read the manual page for each of the tools if you encounter errors.</p></div></div><p>Our container is currently not running; let's start it in the background and increase the log level to <code class="literal">DEBUG</code>:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-start -n c1 -d -l DEBUG</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>On some distributions, LXC does not create the host bridge when building the first container, which results in an error. If this happens, you can create it by running the <code class="literal">brctl addbr virbr0</code> command.</p></div></div><p>Execute the following command to list all containers:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-ls -f&#13;
NAME                  STATE    IPV4        IPV6  AUTOSTART&#13;
----------------------------------------------------------&#13;
c1                    RUNNING  10.0.3.190  -     NO&#13;
root@ubuntu:~#&#13;
</strong></span>
</pre><p>To obtain more information about the container run the following:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-info -n c1</strong></span>
<span class="strong"><strong>Name:           c1</strong></span>
<span class="strong"><strong>State:          RUNNING</strong></span>
<span class="strong"><strong>PID:            29364</strong></span>
<span class="strong"><strong>IP:             10.0.3.190</strong></span>
<span class="strong"><strong>CPU use:        1.46 seconds</strong></span>
<span class="strong"><strong>BlkIO use:      112.00 KiB</strong></span>
<span class="strong"><strong>Memory use:     6.34 MiB</strong></span>
<span class="strong"><strong>KMem use:       0 bytes</strong></span>
<span class="strong"><strong>Link:           vethVRD8T2</strong></span>
<span class="strong"><strong> TX bytes:      4.28 KiB</strong></span>
<span class="strong"><strong> RX bytes:      4.43 KiB</strong></span>
<span class="strong"><strong> Total bytes:   8.70 KiB</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>The new container is now connected to the host bridge <code class="literal">lxcbr0</code>:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# brctl show</strong></span>
<span class="strong"><strong>bridge name        bridge id              STP enabled        interfaces</strong></span>
<span class="strong"><strong>lxcbr0         8000.fea50feb48ac          no             vethVRD8T2&#13;</strong></span>
<span class="strong"><strong>root@ubuntu:~# ip a s lxcbr0</strong></span>
<span class="strong"><strong>4: lxcbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</strong></span>
<span class="strong"><strong>link/ether fe:a5:0f:eb:48:ac brd ff:ff:ff:ff:ff:ff</strong></span>
<span class="strong"><strong>inet 10.0.3.1/24 brd 10.0.3.255 scope global lxcbr0</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever</strong></span>
<span class="strong"><strong>inet6 fe80::465:64ff:fe49:5fb5/64 scope link</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever&#13;</strong></span>
<span class="strong"><strong>root@ubuntu:~# ip a s vethVRD8T2</strong></span>
<span class="strong"><strong>8: vethVRD8T2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master lxcbr0 state UP group default qlen 1000</strong></span>
<span class="strong"><strong>link/ether fe:a5:0f:eb:48:ac brd ff:ff:ff:ff:ff:ff</strong></span>
<span class="strong"><strong>inet6 fe80::fca5:fff:feeb:48ac/64 scope link</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>Using the download template and not specifying any network settings, the container obtains its IP address from a <code class="literal">dnsmasq</code> server that runs on a private network, <code class="literal">10.0.3.0/24</code> in this case. The host allows the container to connect to the rest of the network and the Internet using NAT rules in <code class="literal">iptables</code>:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# iptables -L -n -t nat</strong></span>
<span class="strong"><strong>Chain PREROUTING (policy ACCEPT)</strong></span>
<span class="strong"><strong>target     prot opt source               destination</strong></span>
<span class="strong"><strong>Chain INPUT (policy ACCEPT)</strong></span>
<span class="strong"><strong>target     prot opt source               destination</strong></span>
<span class="strong"><strong>Chain OUTPUT (policy ACCEPT)</strong></span>
<span class="strong"><strong>target     prot opt source               destination</strong></span>
<span class="strong"><strong>Chain POSTROUTING (policy ACCEPT)</strong></span>
<span class="strong"><strong>target     prot opt source               destination</strong></span>
<span class="strong"><strong>MASQUERADE  all  --  10.0.3.0/24         !10.0.3.0/24</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>Other containers connected to the bridge will have access to each other and to the host, as long as they are all connected to the same bridge and are not tagged with different VLAN IDs.</p><p>Let's see what the process tree looks like after starting the container:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# ps axfww</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>1552 ?        S      0:00 dnsmasq -u lxc-dnsmasq --strict-order --bind-interfaces --pid-file=/run/lxc/dnsmasq.pid --conf-file= --listen-address 10.0.3.1 --dhcp-range 10.0.3.2,10.0.3.254 --dhcp-lease-max=253 --dhcp-no-override --except-interface=lo --interface=lxcbr0 --dhcp-leasefile=/var/lib/misc/dnsmasq.lxcbr0.leases --dhcp-authoritative</strong></span>
<span class="strong"><strong>29356 ?        Ss     0:00 lxc-start -n c1 -d -l DEBUG</strong></span>
<span class="strong"><strong>29364 ?        Ss     0:00  \_ /sbin/init</strong></span>
<span class="strong"><strong>29588 ?        S      0:00      \_ upstart-udev-bridge --daemon</strong></span>
<span class="strong"><strong>29597 ?        Ss     0:00      \_ /lib/systemd/systemd-udevd --daemon</strong></span>
<span class="strong"><strong>29667 ?        Ssl    0:00      \_ rsyslogd</strong></span>
<span class="strong"><strong>29688 ?        S      0:00      \_ upstart-file-bridge --daemon</strong></span>
<span class="strong"><strong>29690 ?        S      0:00      \_ upstart-socket-bridge --daemon</strong></span>
<span class="strong"><strong>29705 ?        Ss     0:00      \_ dhclient -1 -v -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases eth0</strong></span>
<span class="strong"><strong>29775 pts/6    Ss+    0:00      \_ /sbin/getty -8 38400 tty4</strong></span>
<span class="strong"><strong>29777 pts/1    Ss+    0:00      \_ /sbin/getty -8 38400 tty2</strong></span>
<span class="strong"><strong>29778 pts/5    Ss+    0:00      \_ /sbin/getty -8 38400 tty3</strong></span>
<span class="strong"><strong>29787 ?        Ss     0:00      \_ cron</strong></span>
<span class="strong"><strong>29827 pts/7    Ss+    0:00      \_ /sbin/getty -8 38400 console</strong></span>
<span class="strong"><strong>29829 pts/0    Ss+    0:00      \_ /sbin/getty -8 38400 tty1</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>Notice the new <code class="literal">init</code> child process that was cloned from the lxc-start command. This is PID <code class="literal">1</code> in the actual container.</p><p>Next, let's run <code class="literal">attach</code> with the container, list all processes, and network interfaces, and check connectivity:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-attach -n c1</strong></span>
<span class="strong"><strong>root@c1:~# ps axfw</strong></span>
<span class="strong"><strong>PID TTY      STAT   TIME COMMAND</strong></span>
<span class="strong"><strong>1 ?        Ss     0:00 /sbin/init</strong></span>
<span class="strong"><strong>176 ?        S      0:00 upstart-udev-bridge --daemon</strong></span>
<span class="strong"><strong>185 ?        Ss     0:00 /lib/systemd/systemd-udevd --daemon</strong></span>
<span class="strong"><strong>255 ?        Ssl    0:00 rsyslogd</strong></span>
<span class="strong"><strong>276 ?        S      0:00 upstart-file-bridge --daemon</strong></span>
<span class="strong"><strong>278 ?        S      0:00 upstart-socket-bridge --daemon</strong></span>
<span class="strong"><strong>293 ?        Ss     0:00 dhclient -1 -v -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases eth0</strong></span>
<span class="strong"><strong>363 lxc/tty4 Ss+    0:00 /sbin/getty -8 38400 tty4</strong></span>
<span class="strong"><strong>365 lxc/tty2 Ss+    0:00 /sbin/getty -8 38400 tty2</strong></span>
<span class="strong"><strong>366 lxc/tty3 Ss+    0:00 /sbin/getty -8 38400 tty3</strong></span>
<span class="strong"><strong>375 ?        Ss     0:00 cron</strong></span>
<span class="strong"><strong>415 lxc/console Ss+   0:00 /sbin/getty -8 38400 console</strong></span>
<span class="strong"><strong>417 lxc/tty1 Ss+    0:00 /sbin/getty -8 38400 tty1</strong></span>
<span class="strong"><strong>458 ?        S      0:00 /bin/bash</strong></span>
<span class="strong"><strong>468 ?        R+     0:00 ps ax&#13;</strong></span>
<span class="strong"><strong>root@c1:~# ip a s</strong></span>
<span class="strong"><strong>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default</strong></span>
<span class="strong"><strong>link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</strong></span>
<span class="strong"><strong>inet 127.0.0.1/8 scope host lo</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever</strong></span>
<span class="strong"><strong>inet6 ::1/128 scope host</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever</strong></span>
<span class="strong"><strong>7: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</strong></span>
<span class="strong"><strong>link/ether 00:16:3e:b2:34:8a brd ff:ff:ff:ff:ff:ff</strong></span>
<span class="strong"><strong>inet 10.0.3.190/24 brd 10.0.3.255 scope global eth0</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever</strong></span>
<span class="strong"><strong>inet6 fe80::216:3eff:feb2:348a/64 scope link</strong></span>
<span class="strong"><strong>valid_lft forever preferred_lft forever&#13;</strong></span>
<span class="strong"><strong>root@c1:~# ping -c 3 google.com</strong></span>
<span class="strong"><strong>PING google.com (216.58.192.238) 56(84) bytes of data.</strong></span>
<span class="strong"><strong>64 bytes from ord30s26-in-f14.1e100.net (216.58.192.238): icmp_seq=1 ttl=52 time=1.77 ms</strong></span>
<span class="strong"><strong>64 bytes from ord30s26-in-f14.1e100.net (216.58.192.238): icmp_seq=2 ttl=52 time=1.58 ms</strong></span>
<span class="strong"><strong>64 bytes from ord30s26-in-f14.1e100.net (216.58.192.238): icmp_seq=3 ttl=52 time=1.75 ms</strong></span>
<span class="strong"><strong>--- google.com ping statistics ---</strong></span>
<span class="strong"><strong>3 packets transmitted, 3 received, 0% packet loss, time 2003ms</strong></span>
<span class="strong"><strong>rtt min/avg/max/mdev = 1.584/1.705/1.779/0.092 ms&#13;</strong></span>
<span class="strong"><strong>root@c1:~# exit</strong></span>
<span class="strong"><strong>exit</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>On some distributions such as CentOS, or if installed from source, the <code class="literal">dnsmasq</code> server is not configured and started by default. You can either install it and configure it manually, or configure the container with an IP address and a default gateway instead, as I'll demonstrate later in this chapter.</p></div></div><p>Notice how the hostname changed on the terminal once we attached to the container. This is an example of how LXC uses the UTS namespaces, as we saw in <a class="link" href="ch01.html" title="Chapter 1. Introduction to Linux Containers"><span>Chapter 1</span></a>, <span class="emphasis"><em>Introduction to Linux Containers</em></span>.</p><p>Let's examine the directory that was created after building the <code class="literal">c1</code> container:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# ls -la /var/lib/lxc/c1/</strong></span>
<span class="strong"><strong>total 16</strong></span>
<span class="strong"><strong>drwxrwx---  3 root root 4096 Aug 31 20:40 .</strong></span>
<span class="strong"><strong>drwx------  3 root root 4096 Aug 31 21:01 ..</strong></span>
<span class="strong"><strong>-rw-r--r--  1 root root  516 Aug 31 20:40 config</strong></span>
<span class="strong"><strong>drwxr-xr-x 21 root root 4096 Aug 31 21:00 rootfs</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>The <code class="literal">rootfs</code> directory looks like a regular Linux filesystem. You can manipulate the container directly by making changes to the files there, or using <code class="literal">chroot</code>.</p><p>To demonstrate this, let's change the root password of the <code class="literal">c1</code> container not by attaching to it, but by <span class="emphasis"><em>chrooting</em></span> to its <code class="literal">rootfs</code>:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# cd /var/lib/lxc/c1/</strong></span>
<span class="strong"><strong>root@ubuntu:/var/lib/lxc/c1# chroot rootfs</strong></span>
<span class="strong"><strong>root@ubuntu:/# ls -al</strong></span>
<span class="strong"><strong>total 84</strong></span>
<span class="strong"><strong>drwxr-xr-x 21 root root 4096 Aug 31 21:00 .</strong></span>
<span class="strong"><strong>drwxr-xr-x 21 root root 4096 Aug 31 21:00 ..</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Aug 29 07:33 bin</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Apr 10  2014 boot</strong></span>
<span class="strong"><strong>drwxr-xr-x  4 root root 4096 Aug 31 21:00 dev</strong></span>
<span class="strong"><strong>drwxr-xr-x 68 root root 4096 Aug 31 22:12 etc</strong></span>
<span class="strong"><strong>drwxr-xr-x  3 root root 4096 Aug 29 07:33 home</strong></span>
<span class="strong"><strong>drwxr-xr-x 12 root root 4096 Aug 29 07:33 lib</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Aug 29 07:32 lib64</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Aug 29 07:31 media</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Apr 10  2014 mnt</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Aug 29 07:31 opt</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Apr 10  2014 proc</strong></span>
<span class="strong"><strong>drwx------  2 root root 4096 Aug 31 22:12 root</strong></span>
<span class="strong"><strong>drwxr-xr-x  8 root root 4096 Aug 31 20:54 run</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Aug 29 07:33 sbin</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Aug 29 07:31 srv</strong></span>
<span class="strong"><strong>drwxr-xr-x  2 root root 4096 Mar 13  2014 sys</strong></span>
<span class="strong"><strong>drwxrwxrwt  2 root root 4096 Aug 31 22:12 tmp</strong></span>
<span class="strong"><strong>drwxr-xr-x 10 root root 4096 Aug 29 07:31 usr</strong></span>
<span class="strong"><strong>drwxr-xr-x 11 root root 4096 Aug 29 07:31 var</strong></span>
<span class="strong"><strong>root@ubuntu:/# passwd</strong></span>
<span class="strong"><strong>Enter new UNIX password:</strong></span>
<span class="strong"><strong>Retype new UNIX password:</strong></span>
<span class="strong"><strong>passwd: password updated successfully&#13;</strong></span>
<span class="strong"><strong>root@ubuntu:/# exit</strong></span>
<span class="strong"><strong>exit</strong></span>
<span class="strong"><strong>root@ubuntu:/var/lib/lxc/c1#</strong></span>
</pre><p>Notice how the path changed on the console when we used <code class="literal">chroot</code> and after exiting the jailed environment.</p><p>To test the root password, let's install <span class="strong"><strong>Secure Shell</strong></span> (<span class="strong"><strong>SSH</strong></span>) server in the container by first attaching to it and then using <code class="literal">ssh</code> to connect:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-attach -n c1</strong></span>
<span class="strong"><strong>root@c1:~# apt-get update&amp;&amp;apt-get install -y openssh-server</strong></span>
<span class="strong"><strong>root@c1:~# sed -i 's/without-password/yes/g' /etc/ssh/sshd_config</strong></span>
<span class="strong"><strong>root@c1:~#service ssh restart</strong></span>
<span class="strong"><strong>root@c1:/# exit</strong></span>
<span class="strong"><strong>exit&#13;</strong></span>
<span class="strong"><strong>root@ubuntu:/var/lib/lxc/c1# ssh 10.0.3.190</strong></span>
<span class="strong"><strong>root@10.0.3.190's password:</strong></span>
<span class="strong"><strong>Welcome to Ubuntu 14.04.5 LTS (GNU/Linux 3.13.0-91-generic x86_64)</strong></span>
<span class="strong"><strong>* Documentation:  https://help.ubuntu.com/</strong></span>
<span class="strong"><strong>Last login: Wed Aug 31 22:25:39 2016 from 10.0.3.1</strong></span>
<span class="strong"><strong>root@c1:~# exit</strong></span>
<span class="strong"><strong>logout</strong></span>
<span class="strong"><strong>Connection to 10.0.3.190 closed.</strong></span>
<span class="strong"><strong>root@ubuntu:/var/lib/lxc/c1#</strong></span>
</pre><p>We were able to <code class="literal">ssh</code> to the container and use the root password that was manually set earlier.</p></div><div class="section" title="Making custom containers with debootstrap on Ubuntu"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Making custom containers with debootstrap on Ubuntu</h2></div></div></div><p>Using the provided distribution template scripts and config files is the fastest way to provision LXC. However, having full control of how the root filesystem is laid out - what packages, block devices, and network settings should be present - requires a more manual approach.</p><p>For this, we can use the <code class="literal">debootstrap</code> utility to create the <code class="literal">rootfs</code> of the container, and then manually create the config file that will describe the properties of the containers. This works on Ubuntu and RHEL/CentOS distributions and it provides a way to run Debian and Ubuntu containers on both RHEL/CentOS and Debian/Ubuntu systems.</p><p>Let's start by installing <code class="literal">debootstrap</code>, if not already installed. On Ubuntu, run the following command:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# apt-get install -y debootstrap</strong></span>
</pre><p>Similarly, on CentOS, run the following command:</p><pre class="programlisting">
<span class="strong"><strong>root@centos:~# yum install -y debootstrap</strong></span>
</pre><p>To create a filesystem for the stable Debian release, we can provide the following arguments:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# debootstrap --arch=amd64 --include="openssh-server vim" stable ~/container http://httpredir.debian.org/debian/</strong></span>
<span class="strong"><strong>W: Cannot check Release signature; keyring file not available /usr/share/keyrings/debian-archive-keyring.gpg</strong></span>
<span class="strong"><strong>I: Retrieving Release</strong></span>
<span class="strong"><strong>I: Retrieving Packages</strong></span>
<span class="strong"><strong>I: Validating Packages</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>I: Configuring libc-bin...</strong></span>
<span class="strong"><strong>I: Configuring systemd...</strong></span>
<span class="strong"><strong>I: Base system installed successfully.</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>We specified the architecture, what packages to be installed, the release of the OS, and the location where the <code class="literal">rootfs</code> will be created, in this example, in <code class="literal">~/container</code>.</p><p>Next, we'll need a <code class="literal">config</code> file for the container. There are many available options for specifying various LXC attributes. Let's start with a somewhat simple configuration:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# vim ~/config</strong></span>
<span class="strong"><strong>lxc.devttydir = lxc</strong></span>
<span class="strong"><strong>lxc.pts = 1024</strong></span>
<span class="strong"><strong>lxc.tty = 4</strong></span>
<span class="strong"><strong>lxc.pivotdir = lxc_putold</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.deny = a</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c *:* m</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = b *:* m</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:3 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:5 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:7 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 5:0 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 5:1 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 5:2 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:8 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:9 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 136:* rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 10:229 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 254:0 rm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 10:200 rwm</strong></span>
<span class="strong"><strong>lxc.mount.auto = cgroup:mixed proc:mixed sys:mixed</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/fs/fuse/connections sys/fs/fuse/connections none bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/kernel/debug sys/kernel/debug none bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/kernel/security sys/kernel/security none bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/fs/pstore sys/fs/pstore none bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = mqueue dev/mqueue mqueue rw,relatime,create=dir,optional 0 0</strong></span>
<span class="strong"><strong># Container specific configuration</strong></span>
<span class="strong"><strong>lxc.arch = x86_64</strong></span>
<span class="strong"><strong>lxc.rootfs = /root/container</strong></span>
<span class="strong"><strong>lxc.rootfs.backend = dir</strong></span>
<span class="strong"><strong>lxc.utsname = manual_container</strong></span>
<span class="strong"><strong># Network configuration</strong></span>
<span class="strong"><strong>lxc.network.type = veth</strong></span>
<span class="strong"><strong>lxc.network.link = lxcbr0</strong></span>
<span class="strong"><strong>lxc.network.flags = up</strong></span>
<span class="strong"><strong>lxc.network.hwaddr = 00:16:3e:e4:68:91</strong></span>
<span class="strong"><strong>lxc.network.ipv4 = 10.0.3.151/24 10.0.3.255</strong></span>
<span class="strong"><strong>lxc.network.ipv4.gateway = 10.0.3.1</strong></span>
<span class="strong"><strong># Limit the container memory to 512MB</strong></span>
<span class="strong"><strong>lxc.cgroup.memory.limit_in_bytes = 536870912</strong></span>
</pre><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>The preceding configuration was tested on LXC 2.0 and might be incompatible with versions on the 1.0 branch.</p></div></div><p>The following table provides a brief summary of the most important options we are using:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>
<p><span class="strong"><strong>Option</strong></span></p>
</td><td>
<p><span class="strong"><strong>Description</strong></span></p>
</td></tr><tr><td>
<p><code class="literal">lxc.devttydir</code></p>
</td><td>
<p>The console devices location in <code class="literal">/dev/</code></p>
</td></tr><tr><td>
<p><code class="literal">lxc.tty</code></p>
</td><td>
<p>The number of TTY to make available to the container</p>
</td></tr><tr><td>
<p><code class="literal">lxc.cgroup.devices.allow</code></p>
</td><td>
<p>The list of devices to allow in the container</p>
</td></tr><tr><td>
<p><code class="literal">lxc.mount</code></p>
</td><td>
<p>The devices to be mounted</p>
</td></tr><tr><td>
<p><code class="literal">lxc.arch</code></p>
</td><td>
<p>The architecture of the container</p>
</td></tr><tr><td>
<p><code class="literal">lxc.rootfs</code></p>
</td><td>
<p>The location of the root filesystem</p>
</td></tr><tr><td>
<p><code class="literal">lxc.rootfs.backend</code></p>
</td><td>
<p>The type of the backend store</p>
</td></tr><tr><td>
<p><code class="literal">lxc.utsname</code></p>
</td><td>
<p>The hostname of the container</p>
</td></tr><tr><td>
<p><code class="literal">lxc.network.type</code></p>
</td><td>
<p>The type of network virtualization</p>
</td></tr><tr><td>
<p><code class="literal">lxc.network.link</code></p>
</td><td>
<p>The name of the host bridge the container will connect to</p>
</td></tr><tr><td>
<p><code class="literal">lxc.network.flags</code></p>
</td><td>
<p>To bring the network interface up</p>
</td></tr><tr><td>
<p><code class="literal">lxc.network.hwaddr</code></p>
</td><td>
<p>The MAC address of the network interface</p>
</td></tr><tr><td>
<p><code class="literal">lxc.network.ipv4</code></p>
</td><td>
<p>The IP address of the network interface if not using DHCP</p>
</td></tr><tr><td>
<p><code class="literal">lxc.network.ipv4.gateway</code></p>
</td><td>
<p>The default gateway inside the container</p>
</td></tr><tr><td>
<p><code class="literal">lxc.cgroup</code></p>
</td><td>
<p>Set cgroup parameters, such as <code class="literal">memory</code>, <code class="literal">cpu</code>, and <code class="literal">blkio</code></p>
</td></tr></tbody></table></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>For more information about all of the available configuration options refer to the <code class="literal">lxc.container.conf</code> man page.</p></div></div><p>With the configuration set, let's create the container:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-create --name manual_container -t none -B dir --dir ~/container -f ~/config</strong></span>
</pre><p>Notice that we did not specify the template this time and provided the <code class="literal">rootfs</code> that was created previously with <code class="literal">debootstrap</code>.</p><p>Let's start the container by setting the log to <code class="literal">DEBUG</code> and redirect it to a file in case we need to troubleshoot errors:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-start -n manual_container -l DEBUG -o container.log</strong></span>
<span class="strong"><strong>root@ubuntu:~# lxc-ls -f</strong></span>
<span class="strong"><strong>NAME             STATE   AUTOSTART GROUPS IPV4       IPV6</strong></span>
<span class="strong"><strong>manual_container RUNNING 0         -      10.0.3.151 -&#13;</strong></span>
<span class="strong"><strong>root@ubuntu:~# lxc-info -n manual_container</strong></span>
<span class="strong"><strong>Name:           manual_container</strong></span>
<span class="strong"><strong>State:          RUNNING</strong></span>
<span class="strong"><strong>PID:            4283</strong></span>
<span class="strong"><strong>IP:             10.0.3.151</strong></span>
<span class="strong"><strong>CPU use:        0.21 seconds</strong></span>
<span class="strong"><strong>BlkIO use:      0 bytes</strong></span>
<span class="strong"><strong>Memory use:     11.75 MiB</strong></span>
<span class="strong"><strong>KMem use:       0 bytes</strong></span>
<span class="strong"><strong>Link:           vethU29DXE</strong></span>
<span class="strong"><strong>TX bytes:      690 bytes</strong></span>
<span class="strong"><strong>RX bytes:      840 bytes</strong></span>
<span class="strong"><strong>Total bytes:   1.49 KiB</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre><p>To test, let's run <code class="literal">attach</code> with it:</p><pre class="programlisting">
<span class="strong"><strong>root@ubuntu:~# lxc-attach -n manual_container</strong></span>
<span class="strong"><strong>[root@manual_container ~]# exit</strong></span>
<span class="strong"><strong>exit</strong></span>
<span class="strong"><strong>root@ubuntu:~#</strong></span>
</pre></div><div class="section" title="Making custom containers with yum on CentOS"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec20"/>Making custom containers with yum on CentOS</h2></div></div></div><p>On CentOS 7, we can use the <code class="literal">debootstrap</code> utility to create Debian-based and Ubuntu-based root filesystems and build containers in the same way as described in the previous section.</p><p>However, to build RHEL, Fedora, or CentOS containers, we'll need to use tools such as <code class="literal">rpm</code>, <code class="literal">yumdownloader</code>, and <code class="literal">yum</code>. Let's look at a slightly more complicated example that builds a CentOS <code class="literal">rootfs</code> that the new container will use:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, create the directory that will contain the root filesystem:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# mkdir container</strong></span>
</pre></li><li class="listitem">After making the <code class="literal">container</code> directory, we need to create and initialize the <code class="literal">rpm</code> package database:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# rpm --root /root/container -initdb</strong></span>
<span class="strong"><strong>root@centos:~# ls -la container/var/lib/rpm/</strong></span>
<span class="strong"><strong>total 108</strong></span>
<span class="strong"><strong>drwxr-xr-x. 2 root root  4096 Sep  1 19:13 .</strong></span>
<span class="strong"><strong>drwxr-xr-x. 3 root root    16 Sep  1 19:13 ..</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Basenames</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Conflictname</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root     0 Sep  1 19:13 .dbenv.lock</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Dirnames</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Group</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Installtid</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Name</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Obsoletename</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root 12288 Sep  1 19:13 Packages</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Providename</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Requirename</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root     0 Sep  1 19:13 .rpm.lock</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Sha1header</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Sigmd5</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root  8192 Sep  1 19:13 Triggername</strong></span>
<span class="strong"><strong>root@centos:~#</strong></span>
</pre></li><li class="listitem">Now that the database is initialized, we can download the release files for the CentOS distribution. If you'd rather build a Fedora container, you can replace the <code class="literal">centos-release</code> with <code class="literal">fedora-release</code> on the command line. The release files contain the <code class="literal">yum</code> repositories and other important files that <code class="literal">yum</code> and <code class="literal">rpm</code> use:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# yumdownloader --destdir=/tmp centos-release</strong></span>
<span class="strong"><strong>Loaded plugins: fastestmirror</strong></span>
<span class="strong"><strong>Loading mirror speeds from cached hostfile</strong></span>
<span class="strong"><strong>* base: mirrors.evowise.com</strong></span>
<span class="strong"><strong>  * extras: mirror.netdepot.com</strong></span>
<span class="strong"><strong>  * updates: mirror.symnds.com</strong></span>
<span class="strong"><strong>centos-release-7-2.1511.el7.centos.2.10.x86_64.rpm   &#13;
      | 23 kB  00:00:00</strong></span>
<span class="strong"><strong>root@centos:~# ls -la /tmp/centos-release&#13;
      -7-2.1511.el7.centos.2.10.x86_64.rpm</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 root root 23516 Dec  9  2015 /tmp/centos-release-&#13;
      7-2.1511.el7.centos.2.10.x86_64.rpm</strong></span>
<span class="strong"><strong>root@centos:~# </strong></span>
</pre></li><li class="listitem">Next, install the release files from the <code class="literal">rpm</code> package in the <code class="literal">root</code> directory of the <code class="literal">container:</code><pre class="programlisting">
<span class="strong"><strong>root@centos:~# rpm --root /root/container -ivh --nodeps &#13;
      /tmp/centos-release-7-2.1511.el7.centos.2.10.x86_64.rpm</strong></span>
<span class="strong"><strong>warning: /tmp/centos-release-7-2.1511.el7.centos.2.10.x86_64.rpm: &#13;
      Header V3 &#13;
      RSA/SHA256 Signature, key ID f4a80eb5: NOKEY</strong></span>
<span class="strong"><strong>Preparing...    &#13;
      ################################# [100%]</strong></span>
<span class="strong"><strong>Updating / installing...</strong></span>
<span class="strong"><strong>     1:centos-release-7-&#13;
      2.1511.el7.cento#################################[100%]</strong></span>
<span class="strong"><strong>      root@centos:~# ls -la container/</strong></span>
<span class="strong"><strong>total 8</strong></span>
<span class="strong"><strong>drwxr-xr-x. 5 root root   36 Sep  1 19:19 .</strong></span>
<span class="strong"><strong>dr-xr-x---. 4 root root 4096 Sep  1 19:13 ..</strong></span>
<span class="strong"><strong>drwxr-xr-x. 6 root root 4096 Sep  1 19:19 etc</strong></span>
<span class="strong"><strong>drwxr-xr-x. 4 root root   28 Sep  1 19:19 usr</strong></span>
<span class="strong"><strong>drwxr-xr-x. 3 root root   16 Sep  1 19:13 var</strong></span>
<span class="strong"><strong>root@centos:~#</strong></span>
</pre><p>From the preceding output, we can see that the <code class="literal">container</code> filesystem is starting to shape up. It currently contains all the necessary files to use the package manager and install the rest of the system files.</p></li><li class="listitem">Now, it's time to install a minimal CentOS distribution in <code class="literal">rootfs</code>; this is similar to what <code class="literal">debootstrap</code> does for Debian and Ubuntu:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# yum --installroot=/root/container -y group install &#13;
      "Minimal install"</strong></span>
<span class="strong"><strong>Loaded plugins: fastestmirror</strong></span>
<span class="strong"><strong>There is no installed groups file.</strong></span>
<span class="strong"><strong>Maybe run: yum groups mark convert (see man yum)</strong></span>
<span class="strong"><strong>Determining fastest mirrors</strong></span>
<span class="strong"><strong>  * base: centos.aol.com</strong></span>
<span class="strong"><strong>  * extras: mirror.lug.udel.edu</strong></span>
<span class="strong"><strong>  * updates: mirror.symnds.com</strong></span>
<span class="strong"><strong>Resolving Dependencies</strong></span>
<span class="strong"><strong>--&gt; Running transaction check</strong></span>
<span class="strong"><strong>---&gt; Package NetworkManager.x86_64 1:1.0.6-30.el7_2 will be installed</strong></span>
<span class="strong"><strong>--&gt; Processing Dependency: ppp = 2.4.5 for package: 1:NetworkManager-&#13;
      1.0.6-30.el7_2.x86_64</strong></span>
<span class="strong"><strong>--&gt; Processing Dependency: NetworkManager-libnm(x86-64) = &#13;
      1:1.0.6-30.el7_2 for &#13;
      package: 1:NetworkManager-1.0.6-30.el7_2.x86_64</strong></span>
<span class="strong"><strong>--&gt; Processing Dependency: wpa_supplicant &gt;= 1:1.1 for &#13;
      package: 1:NetworkManager-&#13;
      1.0.6-30.el7_2.x86_64</strong></span>
<span class="strong"><strong>--&gt; Processing Dependency: libnl3 &gt;= 3.2.21-7 for &#13;
      package: 1:NetworkManager-&#13;
      1.0.6-30.el7_2.x86_64</strong></span>
<span class="strong"><strong>--&gt; Processing Dependency: glib2 &gt;= 2.32.0 for &#13;
      package: 1:NetworkManager-&#13;
      1.0.6-30.el7_2.x86_64</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Complete!</strong></span>
<span class="strong"><strong>root@centos:~# </strong></span>
</pre></li><li class="listitem">Now the <code class="literal">~/container</code> directory contains the complete root filesystem for CentOS 7 distribution:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# ls -la container/</strong></span>
<span class="strong"><strong>total 32</strong></span>
<span class="strong"><strong>dr-xr-xr-x. 17 root root 4096 Sep  1 19:20 .</strong></span>
<span class="strong"><strong>dr-xr-x---.  4 root root 4096 Sep  1 19:13 ..</strong></span>
<span class="strong"><strong>lrwxrwxrwx.  1 root root    7 Sep  1 19:20 bin -&gt; usr/bin</strong></span>
<span class="strong"><strong>dr-xr-xr-x.  3 root root   43 Sep  1 19:21 boot</strong></span>
<span class="strong"><strong>drwxr-xr-x.  2 root root   17 Sep  1 19:21 dev</strong></span>
<span class="strong"><strong>drwxr-xr-x. 74 root root 8192 Sep  1 19:21 etc</strong></span>
<span class="strong"><strong>drwxr-xr-x.  2 root root    6 Aug 12  2015 home</strong></span>
<span class="strong"><strong>lrwxrwxrwx.  1 root root    7 Sep  1 19:20 lib -&gt; usr/lib</strong></span>
<span class="strong"><strong>lrwxrwxrwx.  1 root root    9 Sep  1 19:20 lib64 -&gt; usr/lib64</strong></span>
<span class="strong"><strong>drwxr-xr-x.  2 root root    6 Aug 12  2015 media</strong></span>
<span class="strong"><strong>drwxr-xr-x.  2 root root    6 Aug 12  2015 mnt</strong></span>
<span class="strong"><strong>drwxr-xr-x.  2 root root    6 Aug 12  2015 opt</strong></span>
<span class="strong"><strong>dr-xr-xr-x.  2 root root    6 Aug 12  2015 proc</strong></span>
<span class="strong"><strong>dr-xr-x---.  2 root root   86 Sep  1 19:21 root</strong></span>
<span class="strong"><strong>drwxr-xr-x. 16 root root 4096 Sep  1 19:21 run</strong></span>
<span class="strong"><strong>lrwxrwxrwx.  1 root root    8 Sep  1 19:20 sbin -&gt; usr/sbin</strong></span>
<span class="strong"><strong>drwxr-xr-x.  2 root root    6 Aug 12  2015 srv</strong></span>
<span class="strong"><strong>dr-xr-xr-x.  2 root root    6 Aug 12  2015 sys</strong></span>
<span class="strong"><strong>drwxrwxrwt.  7 root root   88 Sep  1 19:21 tmp</strong></span>
<span class="strong"><strong>drwxr-xr-x. 13 root root 4096 Sep  1 19:20 usr</strong></span>
<span class="strong"><strong>drwxr-xr-x. 19 root root 4096 Sep  1 19:21 var</strong></span>
<span class="strong"><strong>root@centos:~#</strong></span>
</pre><p>If you'd like to install more packages or make changes before the container is built, you can <code class="literal">chroot</code> to <code class="literal">~/containers</code> and perform the work as usual.</p></li><li class="listitem">Next, make the bridge, if it does not already exist, and write the container configuration file:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# brct addbr lxcbr0</strong></span>
<span class="strong"><strong>root@centos:~# brct show</strong></span>
<span class="strong"><strong>bridge name    bridge id          STP enabled       interfaces</strong></span>
<span class="strong"><strong>lxcbr0         8000.000000000000          no&#13;</strong></span>
<span class="strong"><strong>root@centos:~# vim config</strong></span>
<span class="strong"><strong>lxc.devttydir = lxc</strong></span>
<span class="strong"><strong>lxc.pts = 1024</strong></span>
<span class="strong"><strong>lxc.tty = 4</strong></span>
<span class="strong"><strong>lxc.pivotdir = lxc_putold</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.deny = a</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c *:* m</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = b *:* m</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:3 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:5 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:7 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 5:0 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 5:1 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 5:2 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:8 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 1:9 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 136:* rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 10:229 rwm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 254:0 rm</strong></span>
<span class="strong"><strong>lxc.cgroup.devices.allow = c 10:200 rwm</strong></span>
<span class="strong"><strong>lxc.mount.auto = cgroup:mixed proc:mixed sys:mixed</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/fs/fuse/connections sys/fs/fuse/connections &#13;
      none bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/kernel/debug sys/kernel/debug none &#13;
      bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/kernel/security sys/kernel/security none &#13;
      bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = /sys/fs/pstore sys/fs/pstore none bind,optional 0 0</strong></span>
<span class="strong"><strong>lxc.mount.entry = mqueue dev/mqueue mqueue &#13;
      rw,relatime,create=dir,optional 0 0</strong></span>
<span class="strong"><strong># Container specific configuration</strong></span>
<span class="strong"><strong>lxc.arch = x86_64</strong></span>
<span class="strong"><strong>lxc.rootfs = /root/container</strong></span>
<span class="strong"><strong>lxc.rootfs.backend = dir</strong></span>
<span class="strong"><strong>lxc.utsname = c1</strong></span>
<span class="strong"><strong># Network configuration</strong></span>
<span class="strong"><strong>lxc.network.type = veth</strong></span>
<span class="strong"><strong>lxc.network.link = lxcbr0</strong></span>
<span class="strong"><strong>lxc.network.flags = up</strong></span>
<span class="strong"><strong>lxc.network.hwaddr = 00:16:3e:e4:68:92</strong></span>
<span class="strong"><strong>lxc.network.ipv4 = 10.0.3.152/24 10.0.3.255</strong></span>
<span class="strong"><strong>lxc.network.ipv4.gateway = 10.0.3.1</strong></span>
</pre></li><li class="listitem">With <code class="literal">rootfs</code> and <code class="literal">config</code> in place, let's create and start the container:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# lxc-create --name c1 -t none -B dir --dir &#13;
      ~/container -f ~/config</strong></span>
<span class="strong"><strong>root@centos:~# lxc-ls -f</strong></span>
<span class="strong"><strong>NAME STATE   AUTOSTART GROUPS IPV4       IPV6</strong></span>
<span class="strong"><strong>c1   RUNNING 0         -      10.0.3.151 -</strong></span>
<span class="strong"><strong>root@centos:~#</strong></span>
</pre></li><li class="listitem">Finally, we can run <code class="literal">attach</code> with it, as usual:<pre class="programlisting">
<span class="strong"><strong>root@centos:~# lxc-attach -n c1</strong></span>
<span class="strong"><strong>[root@c1 ~]# exit</strong></span>
<span class="strong"><strong>exit</strong></span>
<span class="strong"><strong>root@centos:~# </strong></span>
</pre></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Summary</h1></div></div></div><p>LXC provides a toolset that makes it quite easy and convenient to build, start, and manipulate containers. Using the included templates and configuration files further simplifies this process. In this chapter, we saw practical examples on how to install, configure, and start LXC on Ubuntu and CentOS distributions. You learned how to create container root filesystems and how to write simple configuration files.</p><p>In the next chapter, we'll have a look at how to configure system resources in LXC and explore alternative ways of working with LXC, by utilizing the <code class="literal">libvrit</code> toolkit and libraries.</p></div></body></html>