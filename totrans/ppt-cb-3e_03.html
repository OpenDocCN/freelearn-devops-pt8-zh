<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Writing Better Manifests"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Writing Better Manifests</h1></div></div></div><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Measuring programming progress by lines of code is like measuring aircraft building progress by weight."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Bill Gates</em></span></span></td></tr></table></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using arrays of resources</li><li class="listitem" style="list-style-type: disc">Using resource defaults</li><li class="listitem" style="list-style-type: disc">Using defined types</li><li class="listitem" style="list-style-type: disc">Using tags</li><li class="listitem" style="list-style-type: disc">Using run stages</li><li class="listitem" style="list-style-type: disc">Using roles and profiles</li><li class="listitem" style="list-style-type: disc">Passing parameters to classes</li><li class="listitem" style="list-style-type: disc">Passing parameters from Hiera</li><li class="listitem" style="list-style-type: disc">Writing reusable, cross-platform manifests</li><li class="listitem" style="list-style-type: disc">Getting information about the environment</li><li class="listitem" style="list-style-type: disc">Importing dynamic information</li><li class="listitem" style="list-style-type: disc">Passing arguments to shell commands</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec45"/>Introduction</h1></div></div></div><p>Your Puppet manifests are the living documentation for your entire infrastructure. Keeping them tidy and well organized is a great way to make it easier to maintain and understand. Puppet gives you a number of tools to do this, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Arrays</li><li class="listitem" style="list-style-type: disc">Defaults</li><li class="listitem" style="list-style-type: disc">Defined types</li><li class="listitem" style="list-style-type: disc">Dependencies</li><li class="listitem" style="list-style-type: disc">Class parameters</li></ul></div><p>We'll see how to use all of these and more. As you read through the chapter, try out the examples and look through your own manifests to see where these features might help you simplify and improve your Puppet code.</p></div></div>
<div class="section" title="Using arrays of resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec46"/>Using arrays of resources</h1></div></div></div><p>Anything that you<a id="id243" class="indexterm"/> can do to a resource, you can do to an array of resources. Use this idea to <a id="id244" class="indexterm"/>refactor your manifests to make them shorter and clearer.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec117"/>How to do it…</h2></div></div></div><p>Here are the steps to refactor using arrays of resources:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Identify a class in your manifest where you have several instances of the same kind of resource, for example, packages:<div class="informalexample"><pre class="programlisting">  package { 'sudo' : ensure =&gt; installed }
  package { 'unzip' : ensure =&gt; installed }
  package { 'locate' : ensure =&gt; installed }
  package { 'lsof' : ensure =&gt; installed }
  package { 'cron' : ensure =&gt; installed }
  package { 'rubygems' : ensure =&gt; installed }</pre></div></li><li class="listitem">Group them together and replace them with a single package resource using an array:<div class="informalexample"><pre class="programlisting">  package
  {
    [ 'cron',
    'locate',
    'lsof',
    'rubygems',
    'sudo',
    'unzip' ]:
    ensure =&gt; installed,
  }</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec118"/>How it works…</h2></div></div></div><p>Most of Puppet's<a id="id245" class="indexterm"/> resource types can accept an array instead of a single name, and <a id="id246" class="indexterm"/>will create one instance for each of the elements in the array. All the parameters you provide for the resource (for example, <code class="literal">ensure =&gt; installed</code>) will be assigned to each of the new resource instances. This shorthand will only work when all the resources have the same attributes.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec119"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Iterating over multiple items</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Puppet Language and Style">Chapter 1</a>, <span class="emphasis"><em>Puppet Language and Style</em></span></li></ul></div></div></div>
<div class="section" title="Using resource defaults"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec47"/>Using resource defaults</h1></div></div></div><p>A Puppet module is a group of related resources, usually grouped to configure a specific service. Within a module, you may define multiple resources; resource defaults allow you to specify the default attribute values for a resource. In this example, we'll show you how to specify a resource default for the <code class="literal">File</code> type.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec120"/>How to do it...</h2></div></div></div><p>To show you how to use <a id="id247" class="indexterm"/>resource defaults, we'll create an apache module. Within this module we will specify that the default owner and group are the <code class="literal">apache</code> user as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an apache module and create a resource default for the <code class="literal">File</code> type:<div class="informalexample"><pre class="programlisting">  class apache {
    File {
      owner =&gt; 'apache',
      group =&gt; 'apache',
      mode =&gt; 0644,
    }
  }</pre></div></li><li class="listitem">Create html files within the <code class="literal">/var/www/html</code> directory:<div class="informalexample"><pre class="programlisting">  file {'/var/www/html/index.html':
    content =&gt; "&lt;html&gt;&lt;body&gt;&lt;h1&gt;&lt;a
      href='cookbook.html'&gt;Cookbook!
      &lt;/a&gt;&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\n",
  }
  file {'/var/www/html/cookbook.html':
    content =&gt;
      "&lt;html&gt;&lt;body&gt;&lt;h2&gt;PacktPub&lt;/h2&gt;&lt;/body&gt;&lt;/html&gt;\n",
  }
</pre></div></li><li class="listitem">Add this class to your default node definition, or use <code class="literal">puppet apply</code> to apply the module to your node. I will use the method we configured in the previous chapter, pushing our code to the Git repository and using a Git hook to have the code deployed <a id="id248" class="indexterm"/>to the Puppet master as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ git pull origin production</strong></span>
<span class="strong"><strong>From git.example.com:repos/puppet</strong></span>
<span class="strong"><strong> * branch            production -&gt; FETCH_HEAD</strong></span>
<span class="strong"><strong>Already up-to-date.</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ cd modules</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet/modules $ mkdir -p apache/manifests</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet/modules $ vim apache/manifests/init.pp</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet/modules $ cd ..</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ vim manifests/site.pp </strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ git status</strong></span>
<span class="strong"><strong>On branch production</strong></span>
<span class="strong"><strong>Changes not staged for commit:</strong></span>
<span class="strong"><strong>modified:   manifests/site.pp</strong></span>
<span class="strong"><strong>Untracked files:</strong></span>
<span class="strong"><strong>modules/apache/</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ git add manifests/site.pp modules/apache</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ git commit -m 'adding apache module'</strong></span>
<span class="strong"><strong>[production d639a86] adding apache module</strong></span>
<span class="strong"><strong> 2 files changed, 14 insertions(+)</strong></span>
<span class="strong"><strong> create mode 100644 modules/apache/manifests/init.pp</strong></span>
<span class="strong"><strong>t@mylaptop ~/puppet $ git push origin production</strong></span>
<span class="strong"><strong>Counting objects: 13, done.</strong></span>
<span class="strong"><strong>Delta compression using up to 4 threads.</strong></span>
<span class="strong"><strong>Compressing objects: 100% (6/6), done.</strong></span>
<span class="strong"><strong>Writing objects: 100% (8/8), 885 bytes | 0 bytes/s, done.</strong></span>
<span class="strong"><strong>Total 8 (delta 0), reused 0 (delta 0)</strong></span>
<span class="strong"><strong>remote: To puppet@puppet.example.com:/etc/puppet/environments/puppet.git</strong></span>
<span class="strong"><strong>remote:    832f6a9..d639a86  production -&gt; production</strong></span>
<span class="strong"><strong>remote: Already on 'production'</strong></span>
<span class="strong"><strong>remote: From /etc/puppet/environments/puppet</strong></span>
<span class="strong"><strong>remote:    832f6a9..d639a86  production -&gt; origin/production</strong></span>
<span class="strong"><strong>remote: Updating 832f6a9..d639a86</strong></span>
<span class="strong"><strong>remote: Fast-forward</strong></span>
<span class="strong"><strong>remote:  manifests/site.pp                |    1 +</strong></span>
<span class="strong"><strong>remote:  modules/apache/manifests/init.pp |   13 +++++++++++++</strong></span>
<span class="strong"><strong>remote:  2 files changed, 14 insertions(+)</strong></span>
<span class="strong"><strong>remote:  create mode 100644 modules/apache/manifests/init.pp</strong></span>
<span class="strong"><strong>To git@git.example.com:repos/puppet.git</strong></span>
<span class="strong"><strong>   832f6a9..d639a86  production -&gt; production</strong></span>
</pre></div></li><li class="listitem">Apply the <a id="id249" class="indexterm"/>module to a node or run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Notice: /Stage[main]/Apache/File[/var/www/html/cookbook.html]/ensure: defined content as '{md5}493473fb5bde778ca93d034900348c5d'</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Apache/File[/var/www/html/index.html]/ensure: defined content as '{md5}184f22c181c5632b86ebf9a0370685b3'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 2.00 seconds</strong></span>
<span class="strong"><strong>[root@hiera-test ~]# ls -l /var/www/html</strong></span>
<span class="strong"><strong>total 8</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 apache apache 44 Sep 15 12:00 cookbook.html</strong></span>
<span class="strong"><strong>-rw-r--r--. 1 apache apache 73 Sep 15 12:00 index.html</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec121"/>How it works...</h2></div></div></div><p>The resource default we defined specifies the owner, group, and mode for all file resources within this class (also known as within this scope). Unless you specifically override a resource default, the value for an attribute will be taken from the default.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec122"/>There's more...</h2></div></div></div><p>You can specify resource defaults for any<a id="id250" class="indexterm"/> resource type. You can also specify<a id="id251" class="indexterm"/> resource defaults in <code class="literal">site.pp</code>. I find it useful to specify the default action for <code class="literal">Package</code> and <code class="literal">Service</code> resources as follows:</p><div class="informalexample"><pre class="programlisting">  Package { ensure =&gt; 'installed' }
  Service {
    hasrestart =&gt; true,
    enable     =&gt; true,
    ensure     =&gt; true,
  }</pre></div><p>With these defaults, whenever you specify a package, the package will be installed. Whenever you specify a service, the service will be started and enabled to run at boot. These are the usual reasons you specify packages and services, most of the time these defaults will do what you prefer and your code will be cleaner. When you need to disable a service, simply<a id="id252" class="indexterm"/> override the <a id="id253" class="indexterm"/>defaults.</p></div></div>
<div class="section" title="Using defined types"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec48"/>Using defined types</h1></div></div></div><p>In the previous example, we saw <a id="id254" class="indexterm"/>how to reduce redundant code by grouping identical resources into arrays. However, this technique is limited to resources where all the parameters are the same. When you have a set of resources that have some parameters in common, you need to use a defined type to group them together.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec123"/>How to do it…</h2></div></div></div><p>The following steps will show you how to create a definition:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code to your manifest:<div class="informalexample"><pre class="programlisting">  define tmpfile() {
    file { "/tmp/${name}": content =&gt; "Hello, world\n",
    }
  }
  tmpfile { ['a', 'b', 'c']: }</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@hiera-test ~]# vim tmp.pp</strong></span>
<span class="strong"><strong>[root@hiera-test ~]# puppet apply tmp.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for hiera-test.example.com in environment production in 0.11 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Tmpfile[a]/File[/tmp/a]/ensure: defined content as '{md5}a7966bf58e23583c9a5a4059383ff850'</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Tmpfile[b]/File[/tmp/b]/ensure: defined content as '{md5}a7966bf58e23583c9a5a4059383ff850'</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Tmpfile[c]/File[/tmp/c]/ensure: defined content as '{md5}a7966bf58e23583c9a5a4059383ff850'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.09 seconds</strong></span>
<span class="strong"><strong>[root@hiera-test ~]# cat /tmp/{a,b,c}</strong></span>
<span class="strong"><strong>Hello, world</strong></span>
<span class="strong"><strong>Hello, world</strong></span>
<span class="strong"><strong>Hello, world</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec124"/>How it works…</h2></div></div></div><p>You can think of a defined <a id="id255" class="indexterm"/>type (introduced with the <code class="literal">define</code> keyword) as a cookie-cutter. It describes a pattern that Puppet can use to create lots of similar resources. Any time you declare a <code class="literal">tmpfile</code> instance in your manifest, Puppet will insert all the resources contained in the <code class="literal">tmpfile</code> definition.</p><p>In our example, the definition of <code class="literal">tmpfile</code> contains a single <code class="literal">file</code> resource whose content is <code class="literal">Hello, world\n</code> and whose path is <code class="literal">/tmp/${name}</code>. If you declared an instance of <code class="literal">tmpfile</code> with the name <code class="literal">foo</code>:</p><div class="informalexample"><pre class="programlisting">tmpfile { 'foo': }</pre></div><p>Puppet will create a file with the path <code class="literal">/tmp/foo</code>. In other words, <code class="literal">${name}</code> in the definition will be replaced by the <code class="literal">name</code> of any actual instance that Puppet is asked to create. It's almost as though we created a new kind of resource: <code class="literal">tmpfile</code>, which has one parameter—its <code class="literal">name</code>.</p><p>Just like with regular resources, we don't have to pass just one title; as in the preceding example, we can provide an array of titles and Puppet will create as many resources as required.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>A word on name, the namevar: Every resource you create must have a unique name, the namevar.  This is different than the title, which is how puppet refers to the resource internally (although they are often the same).</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec125"/>There's more…</h2></div></div></div><p>In the example, we created a definition where the only parameter that varies between instances is the <code class="literal">name</code> parameter. But we can add whatever parameters we want, so long as we declare them in the definition in parentheses after the <code class="literal">name</code> parameter, as follows:</p><div class="informalexample"><pre class="programlisting">  define tmpfile($greeting) {
    file { "/tmp/${name}": content =&gt; $greeting,
    }
  }</pre></div><p>Next, pass values to them when we declare an instance of the resource:</p><div class="informalexample"><pre class="programlisting">  tmpfile{ 'foo':
    greeting =&gt; "Good Morning\n",
  }</pre></div><p>You can declare multiple parameters as a comma-separated list:</p><div class="informalexample"><pre class="programlisting">  define webapp($domain,$path,$platform) {
    ...
  }
  webapp { 'mywizzoapp':
    domain   =&gt; 'mywizzoapp.com',
    path     =&gt; '/var/www/apps/mywizzoapp',
    platform =&gt; 'Rails',
  }</pre></div><p>You can also declare default values for any parameters that aren't supplied, thus making them optional:</p><div class="informalexample"><pre class="programlisting">  define tmpfile($greeting,$mode='0644') {
    ...
  }</pre></div><p>This is a powerful technique <a id="id256" class="indexterm"/>for abstracting out everything that's common to certain resources, and keeping it in one place so that you <span class="emphasis"><em>don't repeat yourself</em></span>. In the preceding example, there might be many individual resources contained within <code class="literal">webapp</code>: packages, config files, source code checkouts, virtual hosts, and so on. But all of them are the same for every instance of <code class="literal">webapp</code> except the parameters we provide. These might be referenced in a template, for example, to set the domain for a virtual host.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec126"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Passing parameters to classes</em></span> recipe, in this chapter</li></ul></div></div></div>
<div class="section" title="Using tags"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec49"/>Using tags</h1></div></div></div><p>Sometimes one Puppet class needs to know about another or at least to know whether or not it's present. For example, a class that manages the firewall may need to know whether or not the node is a web server.</p><p>Puppet's<a id="id257" class="indexterm"/> <code class="literal">tagged</code> function <a id="id258" class="indexterm"/>will tell you whether a named class or resource is present in the catalog for this node. You can also apply arbitrary tags to a node or class and check for the presence of these tags. Tags are another metaparameter, similar to <code class="literal">require</code> and <code class="literal">notify</code> we introduced in <a class="link" href="ch01.html" title="Chapter 1. Puppet Language and Style">Chapter 1</a>, <span class="emphasis"><em>Puppet Language and Style</em></span>. Metaparameters are used in the compilation of the Puppet catalog but are not an attribute of the resource to which they are attached.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec127"/>How to do it...</h2></div></div></div><p>To help you find out if you're running on a particular node or class of nodes all nodes are automatically tagged with the node name and the names of any classes they include. Here's an example that shows you how to use <code class="literal">tagged</code> to get this information:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code to your <code class="literal">site.pp</code> file (replacing <code class="literal">cookbook</code> with your machine's <code class="literal">hostname</code>):<div class="informalexample"><pre class="programlisting">  node 'cookbook' {
    if tagged('cookbook') {
      notify { 'tagged cookbook': }
    }
  }</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@cookbook:~# puppet agent -vt</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1410848350'</strong></span>
<span class="strong"><strong>Notice: tagged cookbook</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 1.00 seconds</strong></span>
</pre></div><p>Nodes are <a id="id259" class="indexterm"/>also automatically tagged with the names of all the classes they include in addition to several other automatic tags. You can use <code class="literal">tagged</code> to find out what classes are included on the node.</p><p>You're not just limited to checking the tags automatically applied by Puppet. You can also add your own. To set an arbitrary tag on a node, use the <code class="literal">tag</code> function, as in the following example:</p></li><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">  node 'cookbook' {
    tag('tagging')
    class {'tag_test': }
  }</pre></div></li><li class="listitem">Add a <code class="literal">tag_test</code> module with the following <code class="literal">init.pp</code> (or be lazy and add the following definition to your <code class="literal">site.pp</code>):<div class="informalexample"><pre class="programlisting">  class tag_test {
    if tagged('tagging') {
      notify { 'containing node/class was tagged.': }
    }
  }</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@cookbook:~# puppet agent -vt</strong></span>
<span class="strong"><strong>Info: Caching catalog for cookbook</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1410851300'</strong></span>
<span class="strong"><strong>Notice: containing node/class was tagged.</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.22 seconds</strong></span>
</pre></div></li><li class="listitem">You can also use tags to determine which parts of the manifest to apply. If you use the <code class="literal">--tags</code> option on the Puppet command line, Puppet will apply only those classes or resources tagged with the specific tags you include. For example, we can define our <code class="literal">cookbook</code> class with two classes:<div class="informalexample"><pre class="programlisting">  node cookbook {
    class {'first_class': }
    class {'second_class': }
  }
  class first_class {
    notify { 'First Class': }
  }
  class second_class {
    notify {'Second Class': }
  }</pre></div></li><li class="listitem">Now when we run <code class="literal">puppet agent</code> on the <code class="literal">cookbook</code> node, we see both notifies:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@cookbook:~# puppet agent -t</strong></span>
<span class="strong"><strong>Notice: Second Class</strong></span>
<span class="strong"><strong>Notice: First Class</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.22 seconds</strong></span>
</pre></div></li><li class="listitem">Now apply<a id="id260" class="indexterm"/> the <code class="literal">first_class</code> and <code class="literal">add --tags</code> function to the command line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@cookbook:~# puppet agent -t --tags first_class</strong></span>
<span class="strong"><strong>Notice: First Class</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.07 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec128"/>There's more…</h2></div></div></div><p>You can use tags to create a collection of resources, and then make the collection a dependency for some other resource. For example, say some service depends on a config file that is built from a number of file snippets, as in the following example:</p><div class="informalexample"><pre class="programlisting">  class firewall::service {
    service { 'firewall': ... 
    }
    File &lt;| tag == 'firewall-snippet' |&gt; ~&gt; Service['firewall'] 
  }
  class myapp { 
    file { '/etc/firewall.d/myapp.conf': tag =&gt; 'firewall-snippet', ... 
    } 
  }</pre></div><p>Here, we've specified that the <code class="literal">firewall</code> service should be notified if any file resource tagged <code class="literal">firewall-snippet</code> is updated. All we need to do to add a <code class="literal">firewall</code> config snippet for any particular application or service is to tag it <code class="literal">firewall-snippet</code>, and Puppet will do the rest.</p><p>Although we could <a id="id261" class="indexterm"/>add a <code class="literal">notify =&gt; Service["firewall"]</code> function to each snippet resource if our definition of the <code class="literal">firewall</code> service were ever to change, we would have to hunt down and update all the snippets accordingly. The tag lets us encapsulate the logic in one place, making future maintenance and refactoring much easier.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>What's <code class="literal">&lt;| tag == 'firewall-snippet' |&gt; syntax</code>? This is called a resource collector, and it's <a id="id262" class="indexterm"/>a way of specifying a group of resources by searching for some piece of data about them; in this case, the value of a tag. You can find out more about resource collectors and the <code class="literal">&lt;| |&gt;</code> operator (sometimes known as the spaceship operator) on the Puppet Labs <a id="id263" class="indexterm"/>website: <a class="ulink" href="http://docs.puppetlabs.com/puppet/3/reference/lang_collectors.html">http://docs.puppetlabs.com/puppet/3/reference/lang_collectors.html</a>.</p></div></div></div></div>
<div class="section" title="Using run stages"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec50"/>Using run stages</h1></div></div></div><p>A common requirement is to apply a certain group of resources before other groups (for example, installing a package repository or a custom Ruby version), or after others (for example, deploying an application once its dependencies are installed). Puppet's run stages feature allows you to do this.</p><p>By default, all <a id="id264" class="indexterm"/>resources in your manifest are applied in a single stage named <code class="literal">main</code>. If you need a resource to be applied before all others, you can assign it to a new run stage that is specified to come before <code class="literal">main</code>. Similarly, you could define a run stage that comes after <code class="literal">main</code>. In fact, you can define as many run stages as you need and tell Puppet which order they should be applied in.</p><p>In this example, we'll use stages to ensure one class is applied first and another last.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec129"/>How to do it…</h2></div></div></div><p>Here are the steps to create an example of using run <code class="literal">stages</code>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the file <code class="literal">modules/admin/manifests/stages.pp</code> with the following contents:<div class="informalexample"><pre class="programlisting">  class admin::stages {
    stage { 'first': before =&gt; Stage['main'] }
    stage { 'last': require =&gt; Stage['main'] }
    class me_first {
      notify { 'This will be done first': }
    }
    class me_last {
      notify { 'This will be done last': }
    }
    class { 'me_first':
      stage =&gt; 'first',
    }
    class { 'me_last':
      stage =&gt; 'last',
    }
  }</pre></div></li><li class="listitem">Modify your <code class="literal">site.pp</code> file as follows:<div class="informalexample"><pre class="programlisting">  node 'cookbook' {
    class {'first_class': }
    class {'second_class': }
    include admin::stages
  }</pre></div></li><li class="listitem">Run<a id="id265" class="indexterm"/> Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>root@cookbook:~# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1411019225'</strong></span>
<span class="strong"><strong>Notice: This will be done first</strong></span>
<span class="strong"><strong>Notice: Second Class</strong></span>
<span class="strong"><strong>Notice: First Class</strong></span>
<span class="strong"><strong>Notice: This will be done last</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.43 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec130"/>How it works…</h2></div></div></div><p>Let's examine this code in detail to see what's happening. First, we declare the run stages <code class="literal">first</code> and <code class="literal">last</code>, as follows:</p><div class="informalexample"><pre class="programlisting">  stage { 'first': before =&gt; Stage['main'] }
  stage { 'last': require =&gt; Stage['main'] }</pre></div><p>For the <code class="literal">first</code> stage, we've specified that it should come before <code class="literal">main</code>. That is, every resource marked as being in the <code class="literal">first</code> stage will be applied before any resource in the <code class="literal">main</code> stage (the default stage).</p><p>The <code class="literal">last</code> stage requires the <code class="literal">main</code> stage, so no resource in the <code class="literal">last</code> stage can be applied until after every resource in the <code class="literal">main</code> stage.</p><p>We then declare some classes that we'll later assign to these run stages:</p><div class="informalexample"><pre class="programlisting">  class me_first {
    notify { 'This will be done first': }
  }
  class me_last {
    notify { 'This will be done last': }
  }</pre></div><p>We can now put it<a id="id266" class="indexterm"/> all together and include these classes on the node, specifying the run stages for each as we do so:</p><div class="informalexample"><pre class="programlisting">  class { 'me_first': stage =&gt; 'first',
  }
  class { 'me_last': stage =&gt; 'last',
  }</pre></div><p>Note that in the <code class="literal">class</code> declarations for <code class="literal">me_first</code> and <code class="literal">me_last</code>, we didn't have to specify that they take a <code class="literal">stage</code> parameter. The <code class="literal">stage</code> parameter is another metaparameter, which means it can be applied to any class or resource without having to be explicitly declared. When we ran <code class="literal">puppet agent</code> on our Puppet node, the notify from the <code class="literal">me_first</code> class was applied before the notifies from <code class="literal">first_class</code> and <code class="literal">second_class</code>. The notify from <code class="literal">me_last</code> was applied after the <code class="literal">main</code> stage, so it comes after the two notifies from <code class="literal">first_class</code> and <code class="literal">second_class</code>. If you run <code class="literal">puppet agent</code> multiple times, you will see that the notifies from <code class="literal">first_class</code> and <code class="literal">second_class</code> may not always appear in the same order but the <code class="literal">me_first</code> class will always come first and the <code class="literal">me_last</code> class will always come last.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec131"/>There's more…</h2></div></div></div><p>You can define as many run stages as you like, and set up any ordering for them. This can greatly simplify a complicated manifest that would otherwise require lots of explicit dependencies between resources. Beware of accidentally introducing dependency cycles, though; when you assign something to a run stage you're automatically making it dependent on everything in prior stages.</p><p>You may like to define your stages in the <code class="literal">site.pp</code> file instead, so that at the top level of the manifest, it's easy to see what stages are available.</p><p>
<span class="emphasis"><em>Gary Larizza</em></span> has written a helpful introduction to using run stages, with <a id="id267" class="indexterm"/>some real-world examples, on his website:</p><p>
<a class="ulink" href="http://garylarizza.com/blog/2011/03/11/using-run-stages-with-puppet/">http://garylarizza.com/blog/2011/03/11/using-run-stages-with-puppet/</a>
</p><p>A caveat: many <a id="id268" class="indexterm"/>people don't like to use run stages, feeling that Puppet already provides sufficient resource ordering control, and that using run stages indiscriminately can make your code very hard to follow. The use of run stages should be kept to a minimum wherever possible. There are a few key examples where the use of stages creates less complexity. The most notable is when a resource modifies the system used to install packages on the system. It helps to have a package management stage that comes before the main stage. When packages are defined in the <code class="literal">main</code> (default) stage, your manifests can count on the updated package management configuration information being present. For instance, for a Yum-based system, you would create a <code class="literal">yumrepos</code> stage that comes before <code class="literal">main</code>. You can specify this dependency using chaining arrows as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">  stage {'yumrepos': }
  Stage['yumrepos'] -&gt; Stage['main']</pre></div><p>We can then create a class that creates a Yum repository (<code class="literal">yumrepo</code>) resource and assign it to the <code class="literal">yumrepos</code> stage as follows:</p><div class="informalexample"><pre class="programlisting">  class {'yums': stage =&gt; 'yumrepos',
  }
  class yums {
    notify {'always before the rest': }
    yumrepo {'testrepo': baseurl =&gt; 'file:///var/yum', ensure  =&gt; 'present',
    }
  }</pre></div><p>For Apt-based systems, the same example would be a stage where Apt sources are defined. The key with stages is to keep their definitions in your <code class="literal">site.pp</code> file where they are highly visible and to only use them sparingly where you can guarantee that you will not introduce dependency cycles.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec132"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using tags</em></span> recipe, in this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Drawing dependency graphs</em></span> recipe in <a class="link" href="ch10.html" title="Chapter 10. Monitoring, Reporting, and Troubleshooting">Chapter 10</a>, <span class="emphasis"><em>Monitoring, Reporting, and Troubleshooting</em></span></li></ul></div></div></div>
<div class="section" title="Using roles and profiles"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec51"/>Using roles and profiles</h1></div></div></div><p>Well organized<a id="id269" class="indexterm"/> Puppet manifests are easy to read; the purpose of a module should be evident in its <a id="id270" class="indexterm"/>name. The purpose of a node should be defined in a single class. This single class should include all classes that are required to perform that purpose. Craig Dunn wrote a post about such a classification system, which he <a id="id271" class="indexterm"/>dubbed "roles and profiles" (<a class="ulink" href="http://www.craigdunn.org/2012/05/239/">http://www.craigdunn.org/2012/05/239/</a>). In this model, roles are the single purpose of a node, a node may only have one role, a role may contain more than one profile, and a profile contains all the resources related to a single service. In this example, we will create a web server role that uses several profiles.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec133"/>How to do it…</h2></div></div></div><p>We'll create two modules to store our roles and profiles. Roles will contain one or more profiles. Each role or profile will be defined as a subclass, such as <code class="literal">profile::base</code>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Decide on a naming strategy for your roles and profiles. In our example, we will create two modules, <code class="literal">roles</code> and <code class="literal">profiles</code> that will contain our roles and profiles respectively:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ puppet module generate thomas-profiles</strong></span>
<span class="strong"><strong>$ ln -s thomas-profiles profiles</strong></span>
<span class="strong"><strong>$ puppet module generate thomas-roles</strong></span>
<span class="strong"><strong>$ ln -s thomas-roles roles</strong></span>
</pre></div></li><li class="listitem">Begin defining the constituent parts of our <code class="literal">webserver</code> role as profiles. To keep this example simple, we will create two profiles. First, a <code class="literal">base</code> profile to include our basic server configuration classes. Second, an <code class="literal">apache</code> class to install and configure the apache web server (<code class="literal">httpd</code>) as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vim profiles/manifests/base.pp</strong></span>
<span class="strong"><strong>class profiles::base {</strong></span>
<span class="strong"><strong>  include base</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>$ vim profiles/manifests/apache.pp</strong></span>
<span class="strong"><strong>class profiles::apache {</strong></span>
<span class="strong"><strong>  $apache = $::osfamily ? {</strong></span>
<span class="strong"><strong>    'RedHat' =&gt; 'httpd',</strong></span>
<span class="strong"><strong>    'Debian' =&gt; 'apache2',</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  service { "$apache":</strong></span>
<span class="strong"><strong>    enable =&gt; true,</strong></span>
<span class="strong"><strong>    ensure =&gt; true,</strong></span>
<span class="strong"><strong>  }</strong></span>
<span class="strong"><strong>  package { "$apache":</strong></span>
<span class="strong"><strong>    ensure =&gt; 'installed',</strong></span>
<span class="strong"><strong>  }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li class="listitem">Define a <code class="literal">roles::webserver</code> class for our <code class="literal">webserver</code> role as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vim roles/manifests/webserver.pp</strong></span>
<span class="strong"><strong>class roles::webserver {</strong></span>
<span class="strong"><strong>  include profiles::apache</strong></span>
<span class="strong"><strong>  include profiles::base</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li class="listitem">Apply the <code class="literal">roles::webserver</code> class to a node. In a centralized installation, you would use either an <span class="strong"><strong>External Node Classifier</strong></span> (<span class="strong"><strong>ENC</strong></span>)<a id="id272" class="indexterm"/> to apply the class to the node, or you would use Hiera to define the role:<div class="informalexample"><pre class="programlisting">  node 'webtest' {
    include roles::webserver
  }</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec134"/>How it works…</h2></div></div></div><p>Breaking <a id="id273" class="indexterm"/>down the parts of the web server configuration into different profiles <a id="id274" class="indexterm"/>allows us to apply those parts independently. We created a base profile that we can expand to include all the resources we would like applied to all nodes. Our <code class="literal">roles::webserver</code> class simply includes the <code class="literal">base</code> and <code class="literal">apache</code> classes.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec135"/>There's more…</h2></div></div></div><p>As we'll see in the next section, we can pass parameters to classes to alter how they work. In our <code class="literal">roles::webserver</code> class, we can use the class instantiation syntax instead of <code class="literal">include</code>, and override it with <code class="literal">parameters</code> in the classes. For instance, to pass a parameter to the <code class="literal">base</code> class, we would use:</p><div class="informalexample"><pre class="programlisting">  class {'profiles::base':
    parameter =&gt; 'newvalue'
  }</pre></div><p>where we previously used: </p><div class="informalexample"><pre class="programlisting">include profiles::base</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>In previous versions of this book, node and class inheritance were used to achieve a similar goal, code reuse. Node inheritance is deprecated in Puppet Version 3.7 and higher. Node and class inheritance should be avoided. Using roles and profiles achieves the same level of readability and is much easier to follow.</p></div></div></div></div>
<div class="section" title="Passing parameters to classes"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec52"/>Passing parameters to classes</h1></div></div></div><p>Sometimes it's very<a id="id275" class="indexterm"/> useful to parameterize some aspect of a class. For example, you <a id="id276" class="indexterm"/>might need to manage different versions of a <code class="literal">gem</code> package, and rather than making separate classes for each that differ only in the version number, you can pass in the version number as a parameter.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec136"/>How to do it…</h2></div></div></div><p>In this example, we'll create a definition that accepts parameters:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Declare the parameter as a part of the class definition:<div class="informalexample"><pre class="programlisting">  class eventmachine($version) {
    package { 'eventmachine': provider =&gt; gem, ensure   =&gt; $version,
    }
  }</pre></div></li><li class="listitem">Use the following syntax to include the class on a node:<div class="informalexample"><pre class="programlisting">  class { 'eventmachine':
    version =&gt; '1.0.3',
  }</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec137"/>How it works…</h2></div></div></div><p>The class definition <code class="literal">class eventmachine($version) {</code> is just like a normal class definition except it specifies that the class takes one parameter: <code class="literal">$version</code>. Inside the class, we've defined a <code class="literal">package</code> resource:</p><div class="informalexample"><pre class="programlisting">  package { 'eventmachine':
    provider =&gt; gem,
    ensure   =&gt; $version,
  }
</pre></div><p>This is a <code class="literal">gem</code> package, and we're requesting to install version <code class="literal">$version</code>.</p><p>Include the class on a node, instead of the usual <code class="literal">include</code> syntax:</p><div class="informalexample"><pre class="programlisting">include eventmachine</pre></div><p>On doing so, there will be a <code class="literal">class</code> statement:</p><div class="informalexample"><pre class="programlisting">  class { 'eventmachine':
    version =&gt; '1.0.3',
  }
</pre></div><p>This has the <a id="id277" class="indexterm"/>same effect<a id="id278" class="indexterm"/> but also sets a value for the parameter as <code class="literal">version</code>.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec138"/>There's more…</h2></div></div></div><p>You can specify multiple parameters for a class as:</p><div class="informalexample"><pre class="programlisting">  class mysql($package, $socket, $port) {</pre></div><p>Then supply them in the same way:</p><div class="informalexample"><pre class="programlisting">  class { 'mysql':
    package =&gt; 'percona-server-server-5.5',
    socket  =&gt; '/var/run/mysqld/mysqld.sock',
    port    =&gt; '3306',
  }
</pre></div><div class="section" title="Specifying default values"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec29"/>Specifying default values</h3></div></div></div><p>You can also give default values for some of your<a id="id279" class="indexterm"/> parameters. When you <a id="id280" class="indexterm"/>include the class without setting a parameter, the default value will be used. For instance, if we created a <code class="literal">mysql</code> class with three parameters, we could provide default values for any or all of the parameters as shown in the code snippet:</p><div class="informalexample"><pre class="programlisting">class mysql($package, $socket, $port='3306') {</pre></div><p>or all:</p><div class="informalexample"><pre class="programlisting">  class mysql(
    package = percona-server-server-5.5",
    socket  = '/var/run/mysqld/mysqld.sock',
    port    = '3306') {
</pre></div><p>Defaults allow you to use a default value and override that default where you need it.</p><p>Unlike a definition, only one instance of a parameterized class can exist on a node. So where you need to have several different instances of the resource, use <code class="literal">define</code> instead.</p></div></div></div>
<div class="section" title="Passing parameters from Hiera"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec53"/>Passing parameters from Hiera</h1></div></div></div><p>Like the parameter <code class="literal">defaults</code> we<a id="id281" class="indexterm"/> introduced in the previous chapter, Hiera may be used to <a id="id282" class="indexterm"/>provide default values to classes. This feature requires Puppet Version 3 and higher.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec139"/>Getting ready</h2></div></div></div><p>Install and configure <code class="literal">hiera</code> as we did in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span>. Create a global or common <code class="literal">yaml</code> file; this will serve as the default for all values.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec140"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a class with parameters and no default values:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~/puppet $ mkdir -p modules/mysql/manifests t@mylaptop ~/puppet $ vim modules/mysql/manifests/init.pp</strong></span>
<span class="strong"><strong>class mysql ( $port, $socket, $package ) {</strong></span>
<span class="strong"><strong>  notify {"Port: $port Socket: $socket Package: $package": }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li class="listitem">Update your common <code class="literal">.yaml</code> file in Hiera with the default values for the <code class="literal">mysql</code> class:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>---</strong></span>
<span class="strong"><strong>mysql::port: 3306</strong></span>
<span class="strong"><strong>mysql::package: 'mysql-server'</strong></span>
<span class="strong"><strong>mysql::socket: '/var/lib/mysql/mysql.sock'</strong></span>
</pre></div><p>Apply the class to a node, you can add the mysql class to your default node for now.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>node default {</strong></span>
<span class="strong"><strong>  class {'mysql': }</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li class="listitem">Run <code class="literal">puppet agent</code> and verify the output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@hiera-test ~]# puppet agent -t</strong></span>
<span class="strong"><strong>Info: Caching catalog for hiera-test.example.com</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1411182251'</strong></span>
<span class="strong"><strong>Notice: Port: 3306 Socket: /var/lib/mysql/mysql.sock Package: mysql-server</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Mysql/Notify[Port: 3306 Socket: /var/lib/mysql/mysql.sock Package: mysql-server]/message: defined 'message' as 'Port: 3306 Socket: /var/lib/mysql/mysql.sock Package: mysql-server'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 1.75 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec141"/>How it works...</h2></div></div></div><p>When we instantiate the <code class="literal">mysql</code> class in our manifest, we provided no values for any of the attributes. Puppet knows to look for a value in Hiera that matches <code class="literal">class_name::parameter_name:</code> or <code class="literal">::class_name::parameter_name:</code>.</p><p>When Puppet finds a <a id="id283" class="indexterm"/>value, it uses it as the parameter for the class. If<a id="id284" class="indexterm"/> Puppet fails to find a value in Hiera and no default is defined, a catalog failure will result in the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Error: Could not retrieve catalog from remote server: Error 400 on SERVER: Must pass package to Class[Mysql] at /etc/puppet/environments/production/manifests/site.pp:6 on node hiera-test.example.com</strong></span>
</pre></div><p>This error indicates that Puppet would like a value for the parameter <code class="literal">package</code>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec142"/>There's more...</h2></div></div></div><p>You can define a Hiera hierarchy and supply different values for parameters based on facts. You could, for instance, have <code class="literal">%{::osfamily}</code> in your hierarchy and have different <code class="literal">yaml</code> files based on the <code class="literal">osfamily</code> parameter (RedHat, Suse, and Debian).</p></div></div>
<div class="section" title="Writing reusable, cross-platform manifests"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec54"/>Writing reusable, cross-platform manifests</h1></div></div></div><p>Every system administrator <a id="id285" class="indexterm"/>dreams of a unified, homogeneous infrastructure <a id="id286" class="indexterm"/>of identical machines all running the same version of the same OS. As in other areas of life, however, the reality is often messy and doesn't conform to the plan.</p><p>You are probably responsible for a bunch of assorted servers of varying age and architecture running different kernels from different OS distributions, often scattered across different data centers and ISPs.</p><p>This situation should strike terror into the hearts of the sysadmins of the SSH in a <code class="literal">for</code> loop persuasion, because executing the same commands on every server can have different, unpredictable, and even dangerous results.</p><p>We should certainly strive to bring older servers up to date and get working as far as possible on a single reference platform to make administration simpler, cheaper, and more reliable. But until we get there, Puppet makes coping with heterogeneous environments slightly easier.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec143"/>How to do it…</h2></div></div></div><p>Here are some examples of how to make your manifests more portable:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Where you need to apply the same manifest to servers with different OS distributions, the main differences will probably be the names of packages and services, and the location of config files. Try to capture all these differences into a single class by using selectors to set global variables:<div class="informalexample"><pre class="programlisting">  $ssh_service = $::operatingsystem? { /Ubuntu|Debian/ =&gt; 'ssh', default         =&gt; 'sshd',
  }</pre></div><p>You needn't worry about the differences in any other part of the manifest; when you refer to something, use the variable with confidence that it will point to the right thing in each environment:</p><div class="informalexample"><pre class="programlisting">  service { $ssh_service: ensure =&gt; running,
  }</pre></div></li><li class="listitem">Often we need to cope with mixed architectures; this can affect the paths to shared libraries, and also may require different versions of packages. Again, try to encapsulate all the required settings in a single architecture class that sets global variables:<div class="informalexample"><pre class="programlisting">  $libdir = $::architecture ? {
    /amd64|x86_64/   =&gt; '/usr/lib64', default =&gt; '/usr/lib',
  }</pre></div><p>Then you can use <a id="id287" class="indexterm"/>these wherever an<a id="id288" class="indexterm"/> architecture-dependent value is required in your manifests or even in templates:</p><div class="informalexample"><pre class="programlisting">; php.ini
[PHP]
; Directory in which the loadable extensions (modules) reside.
extension_dir = &lt;%= @libdir %&gt;/php/modules</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec144"/>How it works...</h2></div></div></div><p>The advantage of this approach (which could be called top-down) is that you only need to make your choices once. The alternative, bottom-up approach would be to have a selector or <code class="literal">case</code> statement everywhere a setting is used:</p><div class="informalexample"><pre class="programlisting">  service { $::operatingsystem? {
    /Ubuntu|Debian/ =&gt; 'ssh', default         =&gt; 'sshd' }: ensure =&gt; running,
  }</pre></div><p>This not only results in lots of <a id="id289" class="indexterm"/>duplication, but makes the code harder to read. And <a id="id290" class="indexterm"/>when a new operating system is added to the mix, you'll need to make changes throughout the whole manifest, instead of just in one place.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec145"/>There's more…</h2></div></div></div><p>If you are writing a module for <a id="id291" class="indexterm"/>public distribution (for example, on Puppet Forge), making your module as cross-platform as possible will make it more valuable to the community. As far as you can, test it on many different distributions, platforms, and architectures, and add the appropriate variables so that it works everywhere.</p><p>If you use a public module and adapt it to your own environment, consider updating the public version with your changes if you think they might be helpful to other people.</p><p>Even if you are not thinking of publishing a module, bear in mind that it may be in production use for a long time and may have to adapt to many changes in the environment. If it's designed to cope with this from the start, it'll make life easier for you or whoever ends up maintaining your code.</p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Always code as if the guy who ends up maintaining your code will be a violent psychopath who knows where you live."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Dave Carhart</em></span></span></td></tr></table></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec146"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using public modules</em></span> recipe in <a class="link" href="ch07.html" title="Chapter 7. Managing Applications">Chapter 7</a>, <span class="emphasis"><em>Managing Applications</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Configuring Hiera</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span></li></ul></div></div></div>
<div class="section" title="Getting information about the environment"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec55"/>Getting information about the environment</h1></div></div></div><p>Often in a Puppet manifest, you need to<a id="id292" class="indexterm"/> know some local information about the machine you're on. Facter is the tool that accompanies Puppet to provide a standard way of getting information (facts) from the environment about things such as these:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Operating system</li><li class="listitem" style="list-style-type: disc">Memory size</li><li class="listitem" style="list-style-type: disc">Architecture</li><li class="listitem" style="list-style-type: disc">Processor count</li></ul></div><p>To see a complete list of the facts available on your system, run:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo facter</strong></span>
<span class="strong"><strong>architecture =&gt; amd64</strong></span>
<span class="strong"><strong>augeasversion =&gt; 0.10.0</strong></span>
<span class="strong"><strong>domain =&gt; compute-1.internal</strong></span>
<span class="strong"><strong>ec2_ami_id =&gt; ami-137bcf7a</strong></span>
<span class="strong"><strong>ec2_ami_launch_index =&gt; 0</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>While it can be handy to get this information from the command line, the real power of Facter lies in being able to access these facts in your Puppet manifests.</p></div></div><p>Some modules define their<a id="id293" class="indexterm"/> own facts; to see any facts that have been defined locally, add the <code class="literal">-p (pluginsync)</code> option to facter as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo facter -p</strong></span>
</pre></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec147"/>How to do it…</h2></div></div></div><p>Here's an example of using Facter facts in a manifest:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Reference a Facter fact in your manifest like any other variable. Facts are global variables in Puppet, so they should be prefixed with a double colon (<code class="literal">::</code>), as in the following code snippet:<div class="informalexample"><pre class="programlisting">notify { "This is $::operatingsystem version $::operatingsystemrelease, on $::architecture architecture, kernel version $::kernelversion": }</pre></div></li><li class="listitem">When Puppet runs, it will fill in the appropriate values for the current node:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@hiera-test ~]# puppet agent -t</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Info: Applying configuration version '1411275985'Notice: This is RedHat version 6.5, on x86_64 architecture, kernel version 2.6.32</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.40 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec148"/>How it works…</h2></div></div></div><p>Facter provides a standard <a id="id294" class="indexterm"/>way for manifests to get information about the nodes to which they are applied. When you refer to a fact in a manifest, Puppet will query Facter to get the current value and insert it into the manifest. Facter facts are top scope variables.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>Always refer to facts with leading double colons to ensure that you are using the fact and not a local variable:</p><p>
<code class="literal">$::hostname</code> NOT <code class="literal">$hostname</code>
</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec149"/>There's more…</h2></div></div></div><p>You can also use facts in <a id="id295" class="indexterm"/>ERB templates. For example, you might want to <a id="id296" class="indexterm"/>insert the node's hostname into a file, or change a configuration setting for an application based on the memory size of the node. When you use fact names in templates, remember that they don't need a dollar sign because this is Ruby, not Puppet:</p><div class="informalexample"><pre class="programlisting">$KLogPath &lt;%= case @kernelversion when '2.6.31' then
'/var/run/rsyslog/kmsg' else '/proc/kmsg' end %&gt;
</pre></div><p>When referring to facts, use the <code class="literal">@</code> syntax. Variables that are defined at the same scope as the function call to template can also be referenced with the <code class="literal">@</code> syntax. Out of scope variables should use the <code class="literal">scope</code> function. For example, to reference the <code class="literal">mysql::port</code> variable we defined earlier in the <code class="literal">mysql</code> modules, use the following:</p><div class="informalexample"><pre class="programlisting">MySQL Port = &lt;%= scope['::mysql::port'] %&gt;</pre></div><p>Applying this template results in the following file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[root@hiera-test ~]# puppet agent -t</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Info: Caching catalog for hiera-test.example.com</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Erb/File[/tmp/template-test]/ensure: defined content as '{md5}96edacaf9747093f73084252c7ca7e67'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.41 seconds [root@hiera-test ~]# cat /tmp/template-test</strong></span>
<span class="strong"><strong>MySQL Port = 3306</strong></span>
</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec150"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating custom facts</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span></li></ul></div></div></div>
<div class="section" title="Importing dynamic information"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec56"/>Importing dynamic information</h1></div></div></div><p>Even though some <a id="id297" class="indexterm"/>system administrators like to wall themselves off from the rest of the office using piles of old printers, we all need to exchange information with other departments from time to time. For example, you may want to insert data into your Puppet manifests that is derived from some outside source. The generate function is ideal for this. Functions are executed on the machine compiling the catalog (the master for centralized deployments); an example like that shown here will only work in a masterless configuration.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec151"/>Getting ready</h2></div></div></div><p>Follow these steps to prepare to run the example:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the script <code class="literal">/usr/local/bin/message.rb</code> with the following contents:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>#!/usr/bin/env ruby</strong></span>
<span class="strong"><strong>puts "This runs on the master if you are centralized"</strong></span>
</pre></div></li><li class="listitem">Make the script executable:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo chmod a+x /usr/local/bin/message.rb</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec152"/>How to do it…</h2></div></div></div><p>This example calls the external script we created previously and gets its output:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a <code class="literal">message.pp</code> manifest containing the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$message = generate('/usr/local/bin/message.rb')</strong></span>
<span class="strong"><strong>notify { $message: }</strong></span>
</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ puppet apply message.pp </strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Notify[This runs on the master if you are centralized</strong></span>
<span class="strong"><strong>]/message: defined 'message' as 'This runs on the master if you are centralized</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec153"/>How it works…</h2></div></div></div><p>The <code class="literal">generate</code> function runs the specified script or program and returns the result, in this case, a cheerful message from Ruby.</p><p>This isn't terribly useful as it stands but you get the idea. Anything a script can do, print, fetch, or calculate, for example, the results of a database query, can be brought into your manifest using <code class="literal">generate</code>. You can also, of course, run standard UNIX utilities such as <code class="literal">cat</code> and <code class="literal">grep</code>.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec154"/>There's more…</h2></div></div></div><p>If you need to pass<a id="id298" class="indexterm"/> arguments to the executable called by generate, add them as extra arguments to the function call:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$message = generate('/bin/cat', '/etc/motd')</strong></span>
</pre></div><p>Puppet will try to protect you from malicious shell calls by restricting the characters you can use in a call to generate, so shell pipes and redirection aren't allowed, for example. The simplest and safest thing to do is to put all your logic into a script and then call that script.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec155"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating custom facts</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Configuring Hiera</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span></li></ul></div></div></div>
<div class="section" title="Passing arguments to shell commands"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec57"/>Passing arguments to shell commands</h1></div></div></div><p>If you want to insert values into a<a id="id299" class="indexterm"/> command line (to be run by an <code class="literal">exec</code> resource, for example), they <a id="id300" class="indexterm"/>often need to be quoted, especially if they contain spaces. The <code class="literal">shellquote</code> function<a id="id301" class="indexterm"/> will take any number of arguments, including arrays, and quote each of the arguments and return them all as a space-separated string that you can pass to commands.</p><p>In this example, we would like to set up an <code class="literal">exec</code> resource that will rename a file; but both the source and the target name contain spaces, so they need to be correctly quoted in the command line.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec156"/>How to do it…</h2></div></div></div><p>Here's an example of using the <code class="literal">shellquote</code> function:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a <code class="literal">shellquote.pp</code> manifest with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$source = 'Hello Jerry'</strong></span>
<span class="strong"><strong>$target = 'Hello... Newman'</strong></span>
<span class="strong"><strong>$argstring = shellquote($source, $target)</strong></span>
<span class="strong"><strong>$command = "/bin/mv ${argstring}"</strong></span>
<span class="strong"><strong>notify { $command: }</strong></span>
</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ puppet apply shellquote.pp </strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Notice: /bin/mv "Hello Jerry" "Hello... Newman"</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Notify[/bin/mv "Hello Jerry" "Hello... Newman"]/message: defined 'message' as '/bin/mv "Hello Jerry" "Hello... Newman"'</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec157"/>How it works…</h2></div></div></div><p>First we define the <code class="literal">$source</code> and <code class="literal">$target</code> variables, which are the two filenames we want to use in the command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$source = 'Hello Jerry'</strong></span>
<span class="strong"><strong>$target = 'Hello... Newman'</strong></span>
</pre></div><p>Then we call <code class="literal">shellquote</code> to<a id="id302" class="indexterm"/> concatenate these variables into a <a id="id303" class="indexterm"/>quoted, space-separated string as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$argstring = shellquote($source, $target)</strong></span>
</pre></div><p>Then we put together the final command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$command = "/bin/mv ${argstring}"</strong></span>
</pre></div><p>The result will be:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/bin/mv "Hello Jerry" "Hello... Newman"</strong></span>
</pre></div><p>This command line can now be run with an exec resource. What would happen if we didn't use <code class="literal">shellquote</code>?</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$source = 'Hello Jerry'</strong></span>
<span class="strong"><strong>$target = 'Hello... Newman'</strong></span>
<span class="strong"><strong>$command = "/bin/mv ${source} ${target}"</strong></span>
<span class="strong"><strong>notify { $command: }</strong></span>

<span class="strong"><strong>Notice: /bin/mv Hello Jerry Hello... Newman</strong></span>
</pre></div><p>This won't work because <code class="literal">mv</code> expects space-separated arguments, so it will interpret this as a request to move three files <code class="literal">Hello</code>, <code class="literal">Jerry</code>, and <code class="literal">Hello...</code> into a directory named <code class="literal">Newman</code>, which probably isn't what we want.</p></div></div></body></html>