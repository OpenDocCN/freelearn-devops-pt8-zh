- en: Networking
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Building a secure network
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating a NAT gateway
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Canary deployment via DNS
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hosting a domain
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Routing based on location with failover
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Network logging and troubleshooting
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Networking is a foundational component of using other AWS services such as EC2,
    RDS, and others. Using constructs such as VPCs and NAT gateways gives you the
    capability and confidence to secure your resources at a networking level. At a
    DNS level, Route 53 provides connectivity to your users in a responsive and fault-tolerant
    way that ensures the best performance in a variety of scenarios.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: Building a secure network
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this recipe, we''re going to build a secure network (VPC) in AWS. This network
    will consist of two public and private subnets split across two Availability Zones.
    It will also allow inbound connections to the public subnets for the following:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: SSH (port `22`)
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: HTTP (port `80`)
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: HTTPS (port `443`)
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/image_07_001.png)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
- en: Building a secure network
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-17
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Before we proceed, you''re going to need to know the names of at least two
    Availability Zones in the region we''re deploying to. The recipes in this book
    will typically deploy to `us-east-`, so to get things moving you can just use
    the following:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: '`us-east-1a`'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`us-east-1b`'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When you create an AWS account, your zones are randomly allocated. This means
    that `us-east-1a` in your account isn't necessarily the same data center as `us-east-1a`
    in my account.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-22
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Go ahead and create a new CloudFormation template for our VPC. Just a heads-up:
    this will be one of the larger templates that we''ll create in this book:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: 'The first two `Parameters` correspond to the Availability Zones we discussed
    previously. We don''t provide any default values for these parameters, to maintain
    region portability:'
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The shell of our VPC has now been created. At this point, it''s not connected
    to the Internet, so it''s not entirely useful to us. We need to add an Internet
    gateway and attach it to our VPC. Go ahead and do that, as follows:'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The remaining `Parameters` define the IP address ranges for the following:'
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The entire VPC
  id: totrans-29
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: The public subnets (A and B)
  id: totrans-30
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: The private subnets (A and B)
  id: totrans-31
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The default values we provide for the subnets will allocate 512 IP addresses
    to each subnet:'
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: AWS reserves a small number of IP addresses in your IP space for AWS-specific
    services. The VPC DNS server is one such example of this. It's usually located
    at the second (`*.2`) IP address in the block allocated to your VPC.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Now we can start to define `Resources`. We''ll start by defining the VPC itself,
    as well as the two public and two private subnets inside it:'
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'We need to create a couple of route tables. The first one we''ll focus on is
    the public route table. We''ll assign this route table to the two public subnets
    we''ve created. This route table will have just one route in it, which will direct
    all Internet-bound traffic to the Internet gateway we created in the previous
    step:'
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'We''ll create the private route table in a similar fashion. Since the private
    subnet is isolated from the Internet, we won''t add a route to the Internet gateway.
    Note that if you were to follow the NAT gateway recipe in this book, it will require
    a route table as an input parameter—this is the route table you want to add NAT
    routes to:'
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们将以类似的方式创建私有路由表。由于私有子网与互联网隔离，我们不会添加通往互联网网关的路由。请注意，如果你按照本书中的 NAT 网关配方操作，它将需要一个路由表作为输入参数——这是你想要为
    NAT 路由添加的路由表：
- en: '[PRE5]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'We can now focus on the security aspects of our network. Let''s focus on the
    public subnets. These are the subnets you''ll add your load balancers to; you''ll
    also add things such as bastion boxes and NAT gateways. So we need to add a **Network
    ACL** (**NACL**) with several entries:'
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们可以关注网络的安全方面了。让我们集中注意公有子网。这些子网将用于添加负载均衡器；你还将添加堡垒主机和 NAT 网关等内容。因此，我们需要添加一个
    **网络 ACL**（**NACL**），并包含多个条目：
- en: Allow outbound traffic to all ports. Outbound access is unrestricted from hosts
    in our public subnets.
  id: totrans-42
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许向所有端口发送出站流量。我们公有子网中的主机可以无限制地进行出站访问。
- en: Allow inbound traffic to ephemeral ports (above `1024`). This ensures that packets
    returned to us from our outbound connections are not dropped.
  id: totrans-43
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许对临时端口（大于 `1024`）的入站流量。这确保了从我们的出站连接返回的包不会被丢弃。
- en: 'Allow inbound access to low port numbers for SSH, HTTP, and HTTPS (`22`, `80`,
    and `443`):'
  id: totrans-44
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许向低端口号提供入站访问，支持 SSH、HTTP 和 HTTPS（`22`、`80` 和 `443`）：
- en: '[PRE6]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'We need to do the same for our private subnets. These subnets are somewhat
    easier to deal with. They should *only* be allowed to talk to hosts within our
    VPC, so we just need to add some NACLs allowing inbound and outbound traffic to
    our VPCs IP range:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们也需要对私有子网做同样的事情。这些子网相对容易处理。它们应该 *仅* 允许与我们 VPC 内的主机通信，因此我们只需要添加一些 NACL，允许向我们的
    VPC IP 范围发送入站和出站流量：
- en: '[PRE7]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Finally, we''ll add some `Outputs` to our template. These outputs are usually
    candidates for feeding into other templates or components of automation:'
  id: totrans-48
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，我们将向模板中添加一些 `Outputs`。这些输出通常是作为其他模板或自动化组件的输入：
- en: '[PRE8]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'You can go ahead and create your VPC in the web console or via the CLI using
    the following command:'
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你可以通过 Web 控制台或使用以下命令通过 CLI 创建 VPC：
- en: '[PRE9]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: How it works...
  id: totrans-52
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的……
- en: When you run this template, AWS will go ahead and create an isolated, secure
    network just for you. While it contains a number of resources and concepts which
    will be familiar to network administrators, it's essentially an empty shell, which
    you can now go ahead and populate.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 当你运行这个模板时，AWS 将为你创建一个隔离的、安全的网络。尽管它包含许多网络管理员熟悉的资源和概念，但它本质上是一个空壳，你现在可以开始填充它。
- en: For example, each VPC contains a virtual router. You can't see it and you can't
    log into it to perform any special configuration, but you can customize its behavior
    by modifying the route tables in this template.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，每个 VPC 都包含一个虚拟路由器。你看不见它，也无法登录到它进行任何特殊配置，但你可以通过修改此模板中的路由表来定制它的行为。
- en: The NACLs we've deployed are not stateful and should *not* be considered a substitution
    for security groups. NACLs are *complementary* to security groups, which are stateful
    and frankly much easier to change and manage than NACLs. While the NACLs in our
    recipe allow everywhere (`0.0.0.0/0`) to make inbound connections to port `22`,
    for example, you'll want to use security groups to lock this down to a specific
    IP range (your corporate data center, for example).
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 我们部署的 NACL 是无状态的，*不*应视为安全组的替代品。NACL 是对安全组的 *补充*，安全组是有状态的，实际上比 NACL 更容易更改和管理。虽然我们配方中的
    NACL 允许所有地方（`0.0.0.0/0`）连接到端口 `22`，但你可能希望使用安全组将其限制为特定的 IP 范围（例如，你的公司数据中心）。
- en: There's more...
  id: totrans-56
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多……
- en: 'Actually, there''s a *lot* more. Despite the amount of code in this recipe,
    we''ve really only covered the basics of what''s possible with VPCs and networking
    in AWS. Here are some of the main VPC topics you''ll encounter as you progress
    with your VPC usage:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 事实上，实际上还有 *很多* 内容。尽管本配方中有大量的代码，但我们真正只涉及了 VPC 和 AWS 网络中可能的基础内容。以下是你在使用 VPC 时将遇到的一些主要
    VPC 主题：
- en: '**Direct Connect**: This is a method of connecting your DC to your VPC using
    a private, dedicated pipe. Doing this often provides better network performance,
    and may also be cheaper than a VPN connection over the Internet.'
  id: totrans-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Direct Connect**：这是一种通过专用的、独立的通道将你的 DC 连接到 VPC 的方法。这样做通常可以提供更好的网络性能，并且可能比通过互联网的
    VPN 连接更便宜。'
- en: '**Virtual Private Gateway** (**VPN**): You can configure your VPC to connect
    to your corporate DC over the Internet via VPN. This requires that you run supported
    VPN hardware in your DC.'
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**虚拟专用网关**（**VPN**）：你可以配置你的 VPC 通过 VPN 连接到企业数据中心。这需要你在数据中心运行支持的 VPN 硬件。'
- en: IPv6 support was added recently. We've left it out to keep things simple.
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: IPv6 支持最近已添加。我们为简化起见没有包含它。
- en: '**VPC endpoints**: This feature exposes AWS endpoints inside your VPC so that
    you don''t have to route traffic over public Internet to consume them. Only S3
    is supported at the time of writing.'
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**VPC 端点**：此功能在你的 VPC 内暴露 AWS 端点，这样你就无需通过公共互联网路由流量来访问它们。写作时只支持 S3。'
- en: '**VPC peering**: You can peer a VPC to one or more VPCs so that (unencrypted)
    traffic can flow between them. The IP ranges must not clash and, while the peering
    is free, you will still need to pay for traffic between VPCs. Transitive peering
    isn''t supported, so if you need traffic to traverse VPCs you''ll require a VPN/routing
    appliance of some kind. Cross-account VPC peering is supported (we use this feature
    quite often), but cross-region peering isn''t yet available.'
  id: totrans-62
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**VPC 对等连接**：你可以将一个 VPC 与一个或多个 VPC 进行对等连接，以便（未加密的）流量可以在它们之间流动。IP 范围不能冲突，虽然对等连接是免费的，但你仍然需要为
    VPC 之间的流量付费。不支持传递对等连接，因此如果需要流量穿越多个 VPC，你将需要 VPN/路由设备。支持跨账户的 VPC 对等连接（我们经常使用此功能），但跨区域对等连接尚不可用。'
- en: '**VPC sizing**:'
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**VPC 尺寸**：'
- en: 'IPv4: You can deploy networks between sizes /28 and /16.'
  id: totrans-64
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: IPv4：你可以部署介于 /28 和 /16 之间的网络。
- en: 'IPv6: Your VPCs will be fixed in size at /56.'
  id: totrans-65
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: IPv6：你的 VPC 的大小将固定为 /56。
- en: Once your VPC has been deployed you can't change its size. If you run out of
    IP space, your only option is to deploy a larger VPC and migrate everything (ouch!),
    or you can perhaps mitigate your problem with VPC peering.
  id: totrans-66
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一旦你的 VPC 部署完成，你无法更改其大小。如果 IP 空间用尽，你唯一的选择是部署一个更大的 VPC 并迁移所有内容（哎！），或者你可以通过 VPC
    对等连接来缓解这个问题。
- en: '**VPC flow-logs**: You will want to enable VPC flow-logs in order to monitor
    traffic and do any kind of network debugging.'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**VPC 流日志**：你需要启用 VPC 流日志，以便监控流量并进行任何形式的网络调试。'
- en: Multicast traffic isn't supported.
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 不支持多播流量。
- en: Subnets must reside in a single availability zone; they can't span Availability
    Zones.
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 子网必须位于单一的可用区内；它们不能跨越可用区。
- en: '**Elastic Load Balancers** (**ELBs**) can scale out to use a lot of private
    IP addresses if you are sending a large amount of traffic through them. Keep this
    in mind when you''re sizing your subnets.'
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**弹性负载均衡器**（**ELBs**）如果你通过它们发送大量流量，可以扩展使用大量私有 IP 地址。设计子网时请记住这一点。'
- en: The number of VPCs you can deploy is limited to five per region, per account.
    You can request to increase this limit if necessary. Internet gateways have the
    same limit, and increasing one limit increases the other.
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每个账户每个区域可部署的 VPC 数量限制为五个。如果有必要，你可以申请增加此限制。互联网网关也有相同的限制，增加一个限制会增加另一个限制。
- en: 'The *default* VPC:'
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*默认* VPC：'
- en: First and foremost, the default VPC is created automatically for you when you
    create your account. It has some different properties and behaviors to the VPCs
    you create for yourself.
  id: totrans-73
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 首先，默认 VPC 会在你创建账户时自动创建。它具有一些与您自己创建的 VPC 不同的属性和行为。
- en: If you try to launch an EC2 instance without specifying a subnet ID, AWS will
    attempt to launch it in your default VPC.
  id: totrans-74
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果你在启动 EC2 实例时没有指定子网 ID，AWS 会尝试将其启动在默认 VPC 中。
- en: It consists of only public subnets. These subnets are configured to provide
    a public IP address to all instances by default.
  id: totrans-75
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它只包含公共子网。这些子网默认配置为为所有实例提供公共 IP 地址。
- en: It's possible to delete the default VPC in a region. If you do this by mistake,
    or have simply decided that you'd like to undo this action, you'll need to log
    a support ticket with AWS to have them create a new one for you.
  id: totrans-76
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 可以删除区域中的默认 VPC。如果你不小心删除了它，或者决定撤销此操作，你需要向 AWS 提交支持票，要求他们为你创建一个新的 VPC。
- en: See also...
  id: totrans-77
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 另见...
- en: The *Creating a NAT gateway* recipe
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*创建 NAT 网关* 配方'
- en: Creating a NAT gateway
  id: totrans-79
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建 NAT 网关
- en: Unless required, your instances should not be publicly exposed to the Internet.
    When your instances are on the Internet, you have to assume they will be attacked
    at some stage.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 除非有特殊需求，否则你的实例不应该直接暴露给互联网。当你的实例连接到互联网时，你必须假设它们在某个阶段会受到攻击。
- en: This means most of your workloads should run on instances in private subnets.
    Private subnets are those that are not connected directly to the Internet.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 这意味着大多数工作负载应该在私有子网中的实例上运行。私有子网是那些没有直接连接到互联网的子网。
- en: In order to give your private instances access to the Internet, you use **network
    address translation** (**NAT**). A NAT gateway allows your instances to initiate
    a connection *to* the Internet, without allowing connections *from* the Internet.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让你的私有实例访问互联网，你需要使用**网络地址转换**（**NAT**）。NAT网关允许你的实例发起到互联网的连接，但不允许互联网发起连接。
- en: Getting ready
  id: totrans-83
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'For this recipe, you must have the following existing resources:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个方案，你必须拥有以下现有资源：
- en: A VPC with an **Internet gateway** (**IGW**)
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个带**互联网网关**（**IGW**）的VPC
- en: A public subnet
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个公共子网
- en: A private subnet route table
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个私有子网路由表
- en: You will need the IDs for the public subnet and private subnet route table.
    Both of these resources should be in the same AZ.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 你将需要公共子网和私有子网路由表的ID。这两个资源应该位于同一可用区（AZ）。
- en: How to do it...
  id: totrans-89
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'Start with the usual CloudFormation template version and description:'
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从常规的CloudFormation模板版本和描述开始：
- en: '[PRE10]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'The template must take the following required parameters:'
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 模板必须包含以下必需的参数：
- en: '[PRE11]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'In the `Resources` section, define an **Elastic IP** (**EIP**) that will be
    assigned to the NAT gateway:'
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`Resources`部分，定义一个将分配给NAT网关的**弹性IP**（**EIP**）：
- en: '[PRE12]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Create the NAT gateway resource, assigning it the EIP you just defined in the
    public subnet:'
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建NAT网关资源，并将你刚才在公共子网中定义的EIP分配给它：
- en: '[PRE13]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Finally, define the route to the NAT gateway and associate it with the private
    subnet''s route table:'
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，定义到NAT网关的路由，并将其与私有子网的路由表关联：
- en: '[PRE14]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Save the template with a known filename; for example, `07-nat-gateway.yaml`.
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将模板保存为已知文件名，例如`07-nat-gateway.yaml`。
- en: 'Launch the template with the following CLI command:'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下CLI命令启动模板：
- en: '[PRE15]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: How it works...
  id: totrans-103
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的……
- en: 'The parameters required for this recipe are as follows:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 该方案所需的参数如下：
- en: A public subnet ID
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个公共子网ID
- en: A private subnet route table ID
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个私有子网路由表ID
- en: The public subnet ID is needed to host the NAT gateway, which must have Internet
    access. The private subnet route table will be updated with a route to the NAT
    gateway.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 需要公共子网ID来托管NAT网关，NAT网关必须具有互联网访问权限。私有子网的路由表将会更新，添加到NAT网关的路由。
- en: Using the AWS NAT gateway service means that AWS takes care of hosting and securing
    the service for you. The service will be hosted redundantly in a single AZ.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 使用AWS NAT网关服务意味着AWS为你托管并保护该服务。该服务将冗余地托管在单个可用区（AZ）中。
- en: You can use this recipe multiple times to deploy NAT gateways in each of your
    private subnets. Just make sure the public subnet and the private subnet are in
    the same AZ.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以多次使用这个方案，在每个私有子网中部署NAT网关。只需确保公共子网和私有子网位于同一可用区（AZ）。
- en: In the unlikely (but possible) event of an AZ outage, you should deploy a NAT
    gateway per subnet. This means that if one NAT gateway goes offline, instances
    in the other AZ can continue to access the Internet as normal. You are deploying
    your application in multiple subnets, aren't you?
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 在可用区（AZ）出现故障的情况下（虽然不常见，但有可能发生），你应该在每个子网中部署一个NAT网关。这意味着如果一个NAT网关下线，另一个可用区的实例可以继续正常访问互联网。你是在多个子网中部署应用程序，对吧？
- en: This recipe will only work if you have created your own private subnets, as
    the default subnets in a new AWS account are all *public*. Instances in a public
    subnet have direct access to the Internet (via an IGW), so they do not need a
    NAT gateway.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 这个方案只有在你创建了自己的私有子网时才有效，因为新AWS账户中的默认子网都是*公共*的。公共子网中的实例可以直接访问互联网（通过IGW），因此不需要NAT网关。
- en: See also
  id: totrans-112
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 另见
- en: The *Building a secure network* recipe
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*构建安全网络*方案'
- en: Canary deployment via DNS
  id: totrans-114
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 通过DNS进行金丝雀部署
- en: Canary deployment is a popular deployment method in the cloud. It allows you
    to deploy new versions of your resources alongside your old resources, gradually
    and selectively directing parts of your traffic to the new resource.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 金丝雀部署是一种在云中流行的部署方法。它允许你将资源的新版本与旧版本并行部署，逐步并有选择性地将部分流量引导到新的资源。
- en: By directing a small portion of your traffic to your new resources, you can
    get valuable real-world data and metrics. This means you don't need to engage
    in a *big bang* deployment—where you switch over all of your traffic at once.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 通过将一小部分流量引导到新的资源，你可以获取有价值的真实世界数据和指标。这意味着你不需要进行*大爆炸*部署——即一次性切换所有流量。
- en: It also gives you more flexibility in terms of troubleshooting and monitoring;
    if you see errors for your new resources, you can redirect the traffic back to
    your old resources while you investigate.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 它还为你提供了更多的故障排除和监控的灵活性；如果你看到新资源出现错误，你可以将流量重定向回旧资源，直到问题调查完毕。
- en: In this recipe, we will create the resources necessary to do a DNS-based canary
    deployment, and cut traffic from one resource to another (that is, old to new).
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个操作步骤中，我们将创建进行基于DNS的金丝雀部署所需的资源，并将流量从一个资源切换到另一个资源（即，从旧资源到新资源）。
- en: Getting ready
  id: totrans-119
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'This recipe requires a few things to be in place:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 这个操作步骤需要一些准备工作：
- en: A Route 53 hosted zone for your domain suffix
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为你的域名后缀设置一个Route 53托管区
- en: Existing DNS records for your *old* and *new* resources/endpoints
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 现有的DNS记录针对你的*旧*和*新*资源/终端节点
- en: How to do it...
  id: totrans-123
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'In a new file, define the template version and description:'
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在一个新文件中，定义模板版本和描述：
- en: '[PRE16]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Start the `Parameters` section and the required parameters:'
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 开始`Parameters`部分和所需的参数：
- en: '[PRE17]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Include the optional parameters (such as those with defaults) in the `Parameters`
    section:'
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`Parameters`部分包括可选参数（例如具有默认值的参数）：
- en: '[PRE18]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Start the `Resources` section of the template, and define your record set group:'
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 开始模板的`Resources`部分，定义你的记录集组：
- en: '[PRE19]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Save the template with a known filename; for example, `07-canary-deployments.yaml`.
  id: totrans-132
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存模板并给它一个已知的文件名；例如，`07-canary-deployments.yaml`。
- en: 'Launch the template with the following CLI command:'
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下CLI命令启动模板：
- en: '[PRE20]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'When ready, update the stack to change (just) the domain weighting with the
    following CLI command:'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 准备好后，使用以下CLI命令更新堆栈，仅更改域名的权重：
- en: '[PRE21]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: How it works...
  id: totrans-137
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: This template focuses on utilizing the features of a Route 53 record set group,
    and the most useful properties have been parameterized.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 本模板专注于利用Route 53记录集组的特性，并且最有用的属性已被参数化。
- en: The value for your `DomainName` parameter will be created as multiple `CNAME`
    records in your hosted zone (as set in `HostedZoneName`), one for each of your
    resources, old and new.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 你的`DomainName`参数的值将作为多个`CNAME`记录在你的托管区中创建（如在`HostedZoneName`中设置），每个资源都有一个，包括旧资源和新资源。
- en: The `OldResource` and `NewResource` parameters represent the target domain names
    that the incoming requests will be shared between.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: '`OldResource`和`NewResource`参数表示将会在这些目标域名之间分配传入请求。'
- en: Once the stack is deployed, you will be able to go to your domain name and see
    your *old* resource. By default, this template will send all traffic to the old
    resource endpoint.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦堆栈部署完成，你可以访问你的域名并看到你的*旧*资源。默认情况下，此模板将所有流量发送到旧资源终端节点。
- en: Once you've verified the setup is working correctly, you can start to deploy
    by updating the stack to send *some* of your requests to the new resource.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你验证了设置正确工作，你可以开始部署，通过更新堆栈将*部分*请求发送到新资源。
- en: Changing the resource record set's weightings via the CLI is quite involved,
    as it requires passing a complex JSON object as an argument. It is much simpler
    and safer to simply update the existing CloudFormation stack you deployed, changing
    just the weighting parameters that are already present.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 通过CLI更改资源记录集的权重相当复杂，因为这需要将一个复杂的JSON对象作为参数传递。更简单也更安全的方法是直接更新你已经部署的CloudFormation堆栈，只更改已存在的权重参数。
- en: With the `update-stack` command, the new weightings will be propagated to your
    record set group members (without interruption) and the new distribution of traffic
    will start taking effect.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`update-stack`命令，新的权重将传播到你的记录集组成员（不中断），并且新的流量分配将开始生效。
- en: For the parameters without default values, you must explicitly tell CloudFormation
    to use the previous values, as well as the template body supplied previously.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 对于没有默认值的参数，你必须明确告诉CloudFormation使用之前的值，以及先前提供的模板主体。
- en: Remember that the distribution will be determined by the target's weight divided
    by the total weight value of all targets. This means you can easily *turn off*
    a target by setting its weight to `0`, regardless of the other weight values.
    In this recipe, we have used `0` and `1` as simple values to illustrate the impact,
    but you can (and should) use more fine-grained parameters.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，流量分配将由目标的权重与所有目标的总权重之比来决定。这意味着你可以轻松地通过将目标的权重设置为`0`来*关闭*一个目标，而不管其他目标的权重值。在这个操作步骤中，我们使用了`0`和`1`作为简单的值来说明影响，但你可以（并且应该）使用更细粒度的参数。
- en: Hosting a domain
  id: totrans-147
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 域名托管
- en: 'In this recipe, we''ll show you how to host a domain in Route 53 and add some
    records to it:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 在本食谱中，我们将向你展示如何在Route 53中托管域名，并添加一些记录：
- en: '![](img/B06236_07_02.png)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B06236_07_02.png)'
- en: Hosting a domain
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 托管一个域名
- en: Getting ready
  id: totrans-151
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: You technically don't need to have registered a domain name in order to proceed
    with this recipe, but it sure helps if you have a real domain that you can use.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 从技术上讲，你不需要先注册域名就可以继续进行此食谱，但如果你有一个实际的域名可用，那会更有帮助。
- en: How to do it...
  id: totrans-153
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Create a new CloudFormation template and add the following `Parameter` to it:'
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新的CloudFormation模板，并向其中添加以下`Parameter`：
- en: '[PRE22]'
  id: totrans-155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Next we need to add a `HostedZone` resource to our template, as follows:'
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们需要在模板中添加一个`HostedZone`资源，如下所示：
- en: '[PRE23]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'You''re now ready to go ahead and create your hosted zone in Route 53\. You
    can do so via the CloudFormation web console, or use the following CLI command:'
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在你已经准备好在Route 53中创建你的托管区域。你可以通过CloudFormation Web控制台进行创建，或者使用以下CLI命令：
- en: '[PRE24]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: How it works...
  id: totrans-160
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: This will create a hosted zone in Route 53\. Once the stack has finished creating,
    go and find it in the web console. You'll see that there are a number of name
    servers associated with it. These are the name servers to use if you wish to proceed
    with delegating your domain name to AWS's Route 53 servers using your domain name
    registrar's control panel.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 这将创建一个Route 53中的托管区域。一旦堆栈创建完成，去Web控制台查找它。你会看到有多个名称服务器与之关联。如果你希望通过域名注册商的控制面板将域名委派给AWS的Route
    53服务器，这些就是要使用的名称服务器。
- en: There's more...
  id: totrans-162
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'A hosted zone with no DNS records will be of limited use to you. Here are some
    examples of records that you may wish to add to your template:'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 一个没有DNS记录的托管区域对你来说用途有限。以下是一些你可能想要添加到模板中的记录示例：
- en: '[PRE25]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Some items of note:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 注意事项：
- en: For the priority in `MX` records, add the number at the start of the record
    followed by a space.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 对于`MX`记录中的优先级，添加记录开头的数字，后跟一个空格。
- en: For `TXT` records such as `spf` entries, which are typically required to be
    quoted, you can surround double quotes with single quotes.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 对于像`TXT`记录中的`spf`条目，通常需要加引号，你可以用单引号将双引号括起来。
- en: 'Here''s how they look in the Route 53 web console:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 它们在Route 53 Web控制台中的样子如下：
- en: '![](img/B06236_07_03-1.png)'
  id: totrans-169
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B06236_07_03-1.png)'
- en: Hosting a domain
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 托管一个域名
- en: See also...
  id: totrans-171
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 另见...
- en: The *Hosting a static website* recipe in [Chapter 3](3061e8a1-9092-4f75-931a-8c4da66160b7.xhtml),
    *Storage and Content Delivery*
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第3章](3061e8a1-9092-4f75-931a-8c4da66160b7.xhtml)中的*托管静态网站*食谱，*存储和内容分发*'
- en: Routing based on location with failover
  id: totrans-173
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 基于位置的路由与故障切换
- en: 'In this recipe, we''re going to show you two Route 53 routing policies:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 在本食谱中，我们将展示两种Route 53路由策略：
- en: Geolocation routing
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 地理位置路由
- en: Failover routing
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 故障切换路由
- en: In fact, we're actually going to combine these two policies together. A perusal
    of the AWS documentation might lead you to believe that this isn't particularly
    common practice, but understand that by combining routing policies, you can do
    great things for your performance and availability.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，我们将这两种策略结合起来。浏览AWS文档可能会让你认为这不是一种特别常见的做法，但请理解，通过结合路由策略，你可以为性能和可用性做出很大的改进。
- en: Getting ready
  id: totrans-178
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: Given that we're demonstrating a failover task, you'll want to set up two ELBs
    before we proceed. We're going to assume you're doing this in different regions,
    but this isn't strictly necessary. These ELBs will need to accept HTTP connections
    (on port `80` of course) and have at least one instance attached to them (which
    is passing its health check and serving content).
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 鉴于我们正在演示故障切换任务，你需要在继续之前设置两个ELB。我们假设你正在不同的区域中进行操作，但这并非严格必要。这些ELB需要接受HTTP连接（当然是端口`80`），并且至少需要有一个实例附加在上面（该实例通过健康检查并正在提供内容）。
- en: The *Creating security groups* recipe in [Chapter 4](beece917-78ff-43b8-934b-706eca5968f9.xhtml),
    *Using AWS Compute* deployed in two different regions, should fit the bill nicely.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '[第4章](beece917-78ff-43b8-934b-706eca5968f9.xhtml)中的*创建安全组*食谱，*使用AWS计算*在两个不同的区域部署，应该正合适。'
- en: You'll also need a domain name that you'd like to create as a new hosted zone
    in Route 53\. You technically don't need to delegate this domain to Route 53 from
    your registrar, so you can complete this recipe with any domain you choose. Just
    remember that using a real domain you can delegate to Route 53, which will save
    you messing with your localhost's file or DNS setup in order to test this recipe.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 你还需要一个你想要创建为Route 53中新的托管区域的域名。技术上讲，你不需要将这个域名从注册商委派到Route 53，所以你可以使用任何你选择的域名来完成这个食谱。只要记住，使用一个真实的域名，你可以将其委派给Route
    53，这样就不需要在本地主机文件或DNS设置中进行繁琐的操作来测试这个食谱。
- en: 'In summary, you''ll need the following:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 总结一下，你需要以下内容：
- en: The DNS names for both ELBs
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两个ELB的DNS名称
- en: The hosted zone IDs for both ELBs
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两个ELB的托管区域ID
- en: A domain name of your choosing
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你选择的域名
- en: How to do it...
  id: totrans-186
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'Go ahead and create a new CloudFormation template. We''ll add some `Parameters`
    for the items we''ve mentioned previously:'
  id: totrans-187
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 继续创建一个新的CloudFormation模板。我们将为之前提到的项目添加一些`Parameters`：
- en: '[PRE26]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'The first `Resource` we want is the `HostedZone` resource for our domain name.
    Add it to your template as follows:'
  id: totrans-189
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们想要的第一个`Resource`是我们域名的`HostedZone`资源。将其添加到你的模板中，如下所示：
- en: '[PRE27]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'In order to have failover happen automatically, we''re going to need to set
    up some health checks. We want health checks on the ELBs in both regions:'
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了让故障转移自动发生，我们需要设置一些健康检查。我们希望在两个区域的ELB上进行健康检查：
- en: '[PRE28]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'We''re now going to create four record sets for your domain:'
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们现在将为你的域名创建四个记录集：
- en: '`a.<your-domain>-PRIMARY`'
  id: totrans-194
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`a.<your-domain>-PRIMARY`'
- en: '`b.<your-domain>-PRIMARY`'
  id: totrans-195
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`b.<your-domain>-PRIMARY`'
- en: '`a.<your-domain>-SECONDARY` (failover to `b`)'
  id: totrans-196
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`a.<your-domain>-SECONDARY`（故障转移到`b`）'
- en: '`b.<your-domain>-SECONDARY` (failover to `a`)'
  id: totrans-197
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`b.<your-domain>-SECONDARY`（故障转移到`a`）'
- en: These records correspond to ELB A and ELB B (or *site* A and B, if that term
    makes more sense to you), and they will allow each region to fail over to the
    other if the health check fails.
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这些记录对应于ELB A和ELB B（或者如果你更喜欢用*站点* A和B），它们将允许每个区域在健康检查失败时故障转移到另一个区域。
- en: 'Let''s start with the primary records for both ELBs:'
  id: totrans-199
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们从两个ELB的主要记录开始：
- en: '[PRE29]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'Now add the secondary (failover) records:'
  id: totrans-201
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在添加次要（故障转移）记录：
- en: '[PRE30]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Now we''re going to add the root/apex record for our domain. For the purposes
    of this recipe, we''re going to send requests originating from North America to
    region/ELB A, and requests from the rest of the world to region/ELB B:'
  id: totrans-203
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们将添加我们域名的根/apex记录。为了这个食谱的目的，我们将把来自北美的请求发送到区域/ELB A，把来自全球其他地区的请求发送到区域/ELB
    B：
- en: '[PRE31]'
  id: totrans-204
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'That''s it! You can now run this CloudFormation template in the AWS web console
    or via the CLI, as follows:'
  id: totrans-205
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 就是这样！现在你可以在AWS网页控制台或通过CLI运行这个CloudFormation模板，如下所示：
- en: '[PRE32]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: How it works...
  id: totrans-207
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的…
- en: 'We''ve effectively constructed a small decision tree, as follows:'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 我们有效地构建了一个小型决策树，如下所示：
- en: '![](img/image_07_004.png)'
  id: totrans-209
  prefs: []
  type: TYPE_IMG
  zh: '![](img/image_07_004.png)'
- en: Route 53 flow
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: Route 53流量
- en: In order to test this for yourself, you'll need to have some way of performing
    DNS responses from other regions. In the following screenshots, we have provisioned
    a machine using AWS workspaces in North America (left), while our actual location
    is in Australia (right).
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 为了自己测试，你需要能够从其他区域执行DNS响应。在接下来的截图中，我们通过AWS工作空间在北美（左侧）配置了一台机器，而我们实际的位置在澳大利亚（右侧）。
- en: Normal operation (geolocation routing)
  id: totrans-212
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 正常操作（地理位置路由）
- en: 'Under normal operation, our North American user (left) will connect to region
    A, which, for practical reasons, we''ve deployed in `us-east-1`, although it could
    be in any region. Our Australian user (right) will connect to region B, which
    is the region we''ve designated as being for the *rest of the world*. Again, for
    practical reasons, we deployed this site to the `ap-southeast-2` region:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 在正常操作下，我们的北美用户（左侧）将连接到区域A，为了实际原因，我们已将其部署在`us-east-1`，尽管它可以在任何区域。我们的澳大利亚用户（右侧）将连接到区域B，这是我们指定为*全球其他地区*的区域。同样，出于实际考虑，我们将该站点部署到了`ap-southeast-2`区域：
- en: '![](img/image_07_005.png)'
  id: totrans-214
  prefs: []
  type: TYPE_IMG
  zh: '![](img/image_07_005.png)'
- en: 'Left: Region A served to North American user. Right: Region B served to Australian
    user.'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 左侧：区域A为北美用户提供服务。右侧：区域B为澳大利亚用户提供服务。
- en: Region A failure
  id: totrans-216
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 区域A故障
- en: 'To simulate a failure of region A, we''ll simply stop the web server, which
    is attached to the ELB as follows:'
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 为了模拟区域A的故障，我们将简单地停止附加到ELB的Web服务器，如下所示：
- en: '[PRE33]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'After a short period, the web console will show that the health check for region
    A is failing:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 短暂的时间后，Web控制台会显示区域A的健康检查失败：
- en: '![](img/B06236_07_06.png)'
  id: totrans-220
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B06236_07_06.png)'
- en: Region A failing health check
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 区域A健康检查失败
- en: 'Our North American user (left) now sees region B instead:'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的北美用户（左）现在看到的是区域 B 的内容：
- en: '![](img/image_07_007.png)'
  id: totrans-223
  prefs: []
  type: TYPE_IMG
  zh: '![](img/image_07_007.png)'
- en: 'Left: Region B served to North American users due to failover. Right: Region
    B served to Australian users as normal.'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 左：由于故障转移，区域 B 为北美用户提供服务。右：区域 B 正常为澳大利亚用户提供服务。
- en: Region B failure
  id: totrans-225
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 区域 B 故障
- en: 'We''ll now flip the script and simulate the same scenario in region B. This
    time, the web server in this region is stopped, but the server in region A is
    healthy:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在会翻转脚本，模拟在区域 B 中发生相同的场景。这次，区域 B 中的 Web 服务器已停止，但区域 A 中的服务器是健康的：
- en: '![](img/B06236_07_08.png)'
  id: totrans-227
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B06236_07_08.png)'
- en: Region B failing health check
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 区域 B 健康检查失败
- en: 'Region A content will now be shown to both North American users and those designated
    as the *rest of the world* (including Australia):'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 区域 A 的内容现在将同时展示给北美用户和那些被指定为*世界其他地区*（包括澳大利亚）的用户：
- en: '![](img/image_07_009.png)'
  id: totrans-230
  prefs: []
  type: TYPE_IMG
  zh: '![](img/image_07_009.png)'
- en: 'Left: Region A served to North American users as normal. Right: Region A served
    to Australian users due to failover.'
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 左：区域 A 正常为北美用户提供服务。右：区域 A 由于故障转移为澳大利亚用户提供服务。
- en: There's more...
  id: totrans-232
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多…
- en: 'Route 53 offers a couple of other useful routing policies, so you should have
    a think about which best suits you:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: Route 53 提供了其他几个有用的路由策略，因此你应该思考哪种最适合你：
- en: '**Latency-based routing**: This policy makes the Route 53 DNS servers respond
    to you with IP addresses that provide the lowest latency. This will not necessarily
    be the endpoint geographically closest to you.'
  id: totrans-234
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**基于延迟的路由**：该策略使 Route 53 DNS 服务器以提供最低延迟的 IP 地址响应你。这不一定是地理位置上最接近你的端点。'
- en: '**Weighted routing**: This allows you to divvy up your traffic between endpoints
    based on a weighting system. You might have a 50/50 split between two regions,
    or you may elect to have a 90/10 ratio instead.'
  id: totrans-235
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**加权路由**：这允许你根据加权系统将流量分配到不同的端点。你可以在两个区域之间进行 50/50 的分配，或者选择 90/10 的比例。'
- en: See also...
  id: totrans-236
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 另见…
- en: The *Hosting a static website* recipe in [Chapter 3](3061e8a1-9092-4f75-931a-8c4da66160b7.xhtml), *Storage
    and Content Delivery*
  id: totrans-237
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第3章](3061e8a1-9092-4f75-931a-8c4da66160b7.xhtml)中的*托管静态网站*方案，*存储与内容交付*'
- en: The *Creating security groups* recipe in [Chapter 4](beece917-78ff-43b8-934b-706eca5968f9.xhtml),
    *Using AWS Compute*
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第4章](beece917-78ff-43b8-934b-706eca5968f9.xhtml)中的*创建安全组*方案，*使用 AWS 计算*'
- en: Network logging and troubleshooting
  id: totrans-239
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 网络日志记录与故障排除
- en: One of the benefits of using virtualized infrastructure is that you can get
    a level of introspection that is difficult or costly with physical hardware. Being
    able to quickly switch on logging at a network-device level is an extremely useful
    feature, especially when getting used to the interactions between VPCs, subnets,
    NACLs, routing, and security groups.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 使用虚拟化基础设施的一个好处是，你可以获得一种在物理硬件中难以或昂贵实现的内部视图。能够快速启用网络设备级别的日志记录是一个非常有用的功能，尤其是在熟悉
    VPC、子网、NACL、路由和安全组之间的交互时。
- en: In this recipe, we will turn on logging for our network resources. You could
    do this all the time, to give yourself another layer for monitoring and auditing,
    or you could selectively enable it during troubleshooting, saving yourself any
    additional datastorage charges.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个方案中，我们将启用网络资源的日志记录。你可以一直这样做，为自己提供一个额外的监控和审计层，或者在故障排除时选择性地启用它，节省额外的存储费用。
- en: Getting ready
  id: totrans-242
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 正在准备中
- en: For this recipe, you must have a VPC to log activity on.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个方案，你必须有一个 VPC 用于记录活动。
- en: How to do it...
  id: totrans-244
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'Start by defining the template version and description:'
  id: totrans-245
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从定义模板版本和描述开始：
- en: '[PRE34]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'Define the `Parameters` for the template. In this case, it is just the `VpcId`
    to turn logging on for:'
  id: totrans-247
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定义模板的 `Parameters`。在本例中，它只是启用日志记录的 `VpcId`：
- en: '[PRE35]'
  id: totrans-248
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Create the `Resources` section of the template and define the log group to
    use to send our flow-logs to:'
  id: totrans-249
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建模板的 `Resources` 部分，并定义用来发送流日志的日志组：
- en: '[PRE36]'
  id: totrans-250
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Next we define the IAM role that will give the flow-logs service permission
    to write the logs:'
  id: totrans-251
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们定义将授予流日志服务写入日志权限的 IAM 角色：
- en: '[PRE37]'
  id: totrans-252
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'Finally, we define the flow-log itself:'
  id: totrans-253
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，我们定义流日志本身：
- en: '[PRE38]'
  id: totrans-254
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: Save the template, and give it a known filename such as `07-flow-logs.yaml`.
  id: totrans-255
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保存模板，并为其命名一个已知的文件名，如 `07-flow-logs.yaml`。
- en: 'Create the flow-logs and associated resources by creating the template with
    the following command:'
  id: totrans-256
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令创建模板，创建流日志及相关资源：
- en: '[PRE39]'
  id: totrans-257
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: Once launched (and assuming you have network activity), you will be able to
    see your flow-log in the CloudWatch logs console.
  id: totrans-258
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动后（假设你有网络活动），你将能够在 CloudWatch 日志控制台中看到你的流日志。
- en: How it works...
  id: totrans-259
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理…
- en: The only parameter required for this template is the VPC ID to target. We specifically
    target a VPC to turn on flow-logging for, because it gives us the most *bang for
    buck*. While you can enable flow-logs for subnets and **Elastic Network Interfaces**
    (**ENIs**) individually, if you enable them on a VPC you get flow-logs for all
    the networking resources contained in that VPC—which includes subnets and ENIs.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
- en: In the resources section, we start by explicitly defining the log group to *hold*
    the flow-logs. If you don't create the log group yourself (and specify it in your
    flow-log resource configuration), a log group will be created for you. This means
    that you will still be able to use flow-logs, but the log group won't be managed
    by CloudFormation and will have to be maintained (for example, deleted) manually.
    We have also set a **deletion policy** of *delete* for our log group. This means
    it will be deleted if the CloudFormation stack is deleted, which is fine for a
    demonstration such as this. If using in a *real* environment (such as production),
    remove the `DeletionPolicy` property and its value.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
- en: By default, CloudWatch log groups are *not* deleted when the stack that created
    them is deleted. This lets you retain any important logs, but it can incur an
    ongoing cost.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
- en: Next we define the IAM role to use. Via the `AssumeRolePropertyDocument` value,
    we give the AWS flow-logs service permission to assume this role. Without this
    access, the flow-logs service cannot access the account. In the `Policies` property,
    we give the role permission to create and update log groups and streams.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
- en: Finally, now that we have created the dependent resources, we define the flow-log
    resource itself. You don't need to define the resources in order of dependencies,
    but it is usually easier to read if you do. In the resource, we also define a
    `DependsOn` relationship to the log group we defined earlier, so that the log
    group is ready to receive the flow-logs when it is created.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
- en: The final step is to launch the template you have created, passing the VPC ID
    as parameter. As this template creates an IAM role to allow the VPC service to
    send logs to CloudWatch logs, the command to create the stack must be given the
    `CAPABILITY_IAM` flag to signify that you are aware of the potential impact of
    launching this template.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  id: totrans-266
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Turning on logging is just the start of the troubleshooting process. There are
    a few other things you should be aware of when using flow-logs.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
- en: Log format
  id: totrans-268
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Once logging is enabled, you can view the logs in the CloudWatch logs console.
    Here is a summary of the type of information you will see in the flow-log (in
    order):'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
- en: The VPC flow-logs version
  id: totrans-270
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The AWS account ID
  id: totrans-271
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The ID of the network interface
  id: totrans-272
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The source IPv4 or IPv6 address
  id: totrans-273
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The destination IPv4 or IPv6 address
  id: totrans-274
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The source port of the traffic
  id: totrans-275
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The destination port of the traffic
  id: totrans-276
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The IANA protocol number of the traffic
  id: totrans-277
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The number of packets transferred
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The number of bytes transferred
  id: totrans-279
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The start time of the capture window (in Unix seconds)
  id: totrans-280
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The end time of the capture window (in Unix seconds)
  id: totrans-281
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The action associated with the traffic; for example, `ACCEPT` or `REJECT`
  id: totrans-282
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The logging status of the flow-log; for example, `OK`, `NODATA`, or `SKIPDATA`
  id: totrans-283
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To identify the protocol, check the protocol number field against the IANA protocol
    numbers list at [http://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml](http://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml).
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
- en: Updates
  id: totrans-285
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: You cannot update the configuration of an existing flow-log; you must delete
    it and recreate it if you want to change any settings associated. This is another
    reason why it is good to explicitly create and manage the associated log group.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
- en: Omissions
  id: totrans-287
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Some traffic is not captured by the flow-logs service, as follows:'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
- en: Traffic to the Amazon DNS server (`x.x.x.2` in your allocated range)
  id: totrans-289
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Traffic for Amazon Windows license activation (obviously only applicable to
    Windows instances)
  id: totrans-290
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Traffic to and from the instance metadata service (that is, IP address `169.254.169.254`)
  id: totrans-291
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: DHCP traffic
  id: totrans-292
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Traffic to the reserved VPC IP address for the default VPC router (`x.x.x.1`
    in your allocated range)
  id: totrans-293
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: See also
  id: totrans-294
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The *Building a secure network* recipe
  id: totrans-295
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
