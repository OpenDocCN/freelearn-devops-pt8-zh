<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;7.&#xA0;Cinder &#x2013; OpenStack Block Storage" id="2PKKS1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07" class="calibre1"/>Chapter 7. Cinder – OpenStack Block Storage</h1></div></div></div><p class="calibre10">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Configuring Cinder volume services</li><li class="listitem">Creating volumes</li><li class="listitem">Attaching volumes to an instance</li><li class="listitem">Detaching volumes from an instance</li><li class="listitem">Deleting volumes</li><li class="listitem">Working with volume snapshots</li><li class="listitem">Configuring volume types</li><li class="listitem">Enabling volume encryption</li><li class="listitem">Configuring volume Quality of Service (QoS)</li><li class="listitem">Resetting volume state</li></ul></div></div>

<div class="book" title="Chapter&#xA0;7.&#xA0;Cinder &#x2013; OpenStack Block Storage" id="2PKKS1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch07lvl1sec91" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre10">When a basic compute instance is launched, where the instance data resides on the compute host's disks for the duration of the running instance, the data written to it is not persistent after termination—meaning that any data saved on the disk will be lost when a user requests to destroy that instance. There is a solution for this in OpenStack. <span class="strong"><strong class="calibre2">Volumes</strong></span> are persistent storage that you can attach to your running OpenStack Compute instances; the best analogy is that of a USB drive that you can attach to an instance. Like USB drives, you can only attach instances to one computer at a time.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip60" class="calibre1"/>Tip</h3><p class="calibre10">There is currently an experimental feature that allows you to attach a volume to multiple instances. We do not cover it here nor recommend its usage at this time.</p></div><p class="calibre10">The OpenStack Block Storage project code name Cinder provides the interfaces and automation that allows the connection of storage volumes to OpenStack Compute instances. OpenStack Block Storage is very similar to Amazon <span class="strong"><strong class="calibre2">Elastic Block Storage</strong></span> (<span class="strong"><strong class="calibre2">EBS</strong></span>)—the primary difference is in how volumes are presented to the running instances. Under OpenStack Compute, one method is to dedicate a server to this purpose so that volumes that can easily be managed using an iSCSI exposes the LVM volume group, specifically named <code class="email">cinder-volumes</code>. This is then presented over iSCSI through an OpenStack service called <code class="email">cinder-volume</code>. The users of OpenStack interact with this service through the Cinder API. In our environment, the Cinder API service runs on the three controller servers that are then usually exposed behind a load balancer. The recipes in this chapter are shown using this same method, whereby Cinder volumes are provided by LVM and iSCSI. However, Cinder supports a wide variety of third-party storage providers by both commercial vendors and the <span class="strong"><strong class="calibre2">Open Source Software</strong></span> (<span class="strong"><strong class="calibre2">OSS</strong></span>) community—for example, a very popular backend provider for Cinder (instead of having a single server run the <code class="email">cinder-volume</code> service) is <span class="strong"><strong class="calibre2">Ceph</strong></span>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip61" class="calibre1"/>Tip</h3><p class="calibre10">The terms OpenStack Block Storage and Cinder will be used interchangeably in this chapter.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring Cinder volume services"><div class="book" id="2QJ5E2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec92" class="calibre1"/>Configuring Cinder volume services</h1></div></div></div><p class="calibre10">In this <a id="id428" class="calibre1"/>recipe, we will use Openstack-Ansible to deploy the Cinder service. We assume that your environment has been deployed using the recipes described in <a class="calibre1" title="Chapter 1. Installing OpenStack with Ansible" href="part0014_split_000.html#DB7S2-189e69df43a248268db97cde1b1a8e47">Chapter 1</a>, <span class="strong"><em class="calibre18">Installing OpenStack with Ansible</em></span>.</p></div>

<div class="book" title="Configuring Cinder volume services">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec279" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To use Cinder volumes with LVM and iSCSI, you will need a host (or hosts) running Ubuntu 16.04. Additionally, you will need to ensure the volume hosts are manageable by your Openstack-Ansible deployment host.</p><p class="calibre10">The following is required:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">Access to the <code class="email">openstack-ansible</code> deployment host</li><li class="listitem">A dedicated server to provide Cinder volumes to instances:<div class="book"><ul class="itemizedlist1"><li class="listitem">An LVM volume group, specifically named <code class="email">cinder-volumes</code></li><li class="listitem">An IP address accessible from the deployment host</li></ul></div></li></ul></div><p class="calibre10">If you are using the lab environment that accompanies this book, <code class="email">cinder-volume</code> is deployed to a host with the following details:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">cinder-volume</code> API service host IP: <code class="email">172.29.236.10</code></li><li class="listitem"><code class="email">cinder-volume</code> service host IP: OpenStack management calls over <code class="email">172.29.236.100</code> and storage traffic over <code class="email">172.29.244.100</code></li></ul></div></div></div>

<div class="book" title="Configuring Cinder volume services">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec280" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre10">To deploy the <code class="email">cinder-volume</code> service, first we will create a YAML file to describe how to deploy Cinder. Then we will use <code class="email">openstack-ansible</code> to deploy the appropriate services.</p><p class="calibre10">To configure <a id="id429" class="calibre1"/>a Cinder LVM host that runs the <code class="email">cinder-volume</code> service, perform the following steps on the deployment host:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, edit the <code class="email">/etc/openstack_deploy/openstack_user_config.yml</code> file to add the following lines, noting that we are using both the address of the API and storage networks:<div class="informalexample"><pre class="programlisting">---
storage-infra_hosts:
  controller-01:
    ip: 172.29.236.10

storage_hosts:
  cinder-volume:
    ip: 172.29.236.100
    container_vars:
      cinder_backends:
        limit_container_types: cinder_volume
        lvm:
          volume_group: cinder-volumes
          volume_driver: cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_backend_name: LVM_iSCSI
          iscsi_ip_address: "172.29.244.100"</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip62" class="calibre1"/>Tip</h3><p class="calibre10">More nodes can be added to the <code class="email">storage-infra_hosts</code> section to match your environment. Note that we refer to the <code class="email">storage_hosts</code> and <code class="email">storage-infra_hosts</code> IPs from the container network (<code class="email">172.29.236</code>), and we will present the actual iSCSI volume to an instance over the storage network (<code class="email">172.29.244</code>).</p></div></li><li class="listitem" value="2">Now edit the <code class="email">/etc/openstack_deploy/user_variables.yml</code> file to contain the following lines. The defaults for an OpenStack-Ansible deployment are shown here; so edit to suit your environment if necessary:<div class="informalexample"><pre class="programlisting">## Cinder iscsi
cinder_iscsi_helper: tgtadm
cinder_iscsi_iotype: fileio
cinder_iscsi_num_targets: 100
cinder_iscsi_port: 3260</pre></div></li><li class="listitem" value="3">When using LVM, as we are here, we must tell OpenStack-Ansible to <span class="strong"><em class="calibre18">not</em></span> deploy the service onto a container (by setting <code class="email">is_metal: true</code>). Ensure that the <code class="email">/etc/openstack_deploy/env.d/cinder.yml</code> file has the following contents:<div class="informalexample"><pre class="programlisting">---
container_skel:
  cinder_volumes_container:
    properties:
      is_metal: true</pre></div></li><li class="listitem" value="4">As we <a id="id430" class="calibre1"/>are specifically choosing to install Cinder with the <code class="email">LVMVolumeDriver</code> service as part of this example, we must ensure that the host (or hosts) that has been set as running the <code class="email">cinder-volume</code> service, has a <span class="strong"><strong class="calibre2">volume group</strong></span> created, named very specifically <code class="email">cinder-volumes</code>, <span class="strong"><em class="calibre18">before</em></span> we deploy Cinder. Carry out the following steps to create this important volume group. The following example simply assumes that there is an extra disk, at <code class="email">/dev/sdb</code>, that we will use for this purpose:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">pvcreate /dev/sdb</strong></span>
<span class="strong"><strong class="calibre2">vgcreate cinder-volumes /dev/sdb</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Physical volume "/dev/sdb1" successfully created</strong></span>
<span class="strong"><strong class="calibre2">Volume group "cinder-volumes" successfully created</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip63" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Tip</strong></span>: The creation of a <code class="email">cinder-volumes</code> logical <span class="strong"><strong class="calibre2">Volume Group</strong></span> (<span class="strong"><strong class="calibre2">VG</strong></span>) is only required to be created because we are choosing the <code class="email">volume_driver</code> type of <code class="email">cinder.volume.drivers.lvm.LVMVolumeDriver</code>. Other backends are available to Cinder that do not require this step to be performed.</p></div></li><li class="listitem" value="5">We can now deploy our Cinder service with the <code class="email">openstack-ansible</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd /opt/openstack-ansible/playbooks</strong></span>
<span class="strong"><strong class="calibre2">openstack-ansible os-cinder-install.yml</strong></span>
</pre></div><p class="calibre22">Note that the Ansible output has been omitted here. On success, Ansible will report that the installation has been successful or will present you information about which step failed.</p><div class="note" title="Note"><h3 class="title2"><a id="tip64" class="calibre1"/>Tip</h3><p class="calibre10">Did you use more than one <code class="email">storage-infra_hosts</code>? These are the Cinder API servers. As these run behind a load balancer, ensure that you have updated your load balancer VIPs with the IP addresses of these new nodes. The Cinder service runs on port <code class="email">8776</code>. If you are running HAProxy that was installed using OpenStack-Ansible, you must also run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack-ansible haproxy-install.yml</strong></span>
</pre></div></div></li><li class="listitem" value="6">Verify <a id="id431" class="calibre1"/>that the Cinder services are running with the following checks from an OpenStack client or one of the utility containers from one of the controller nodes, as shown here:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">lxc-attach --name $(lxc-ls -1 | grep util)</strong></span>
<span class="strong"><strong class="calibre2">source openrc</strong></span>
<span class="strong"><strong class="calibre2">cinder service-list</strong></span>
</pre></div><p class="calibre22">This will give back an output like the following:</p><div class="mediaobject"><img src="../images/00130.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Configuring Cinder volume services">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec281" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">In order <a id="id432" class="calibre1"/>for us to use a host as a <code class="email">cinder-volume</code> server, we first needed to ensure that the logical volume group (LVM VG) named <code class="email">cinder-volumes</code> has been created.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip65" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Tip</strong></span>: You are able to rename the volume group to something other than <code class="email">cinder-volumes</code>; however, there are very few reasons to do so. If you do require this, ensure that the <code class="email">volume_group:</code> parameter in <code class="email">/etc/openstack_deploy/openstack_user_config.yml</code> matches your LVM Volume Group name that you create.</p></div><p class="calibre10">Once that has been done, we will configure our OpenStack-Ansible deployment to specify our <code class="email">cinder-volume</code> server (as denoted by the <code class="email">storage_hosts</code> section) and the servers that run the API service (as denoted by the <code class="email">storage-infra_hosts</code> section). We will then use <code class="email">openstack-ansible</code> to deploy the packages onto the controller hosts and our nominated <a id="id433" class="calibre1"/>Cinder volume server.</p><p class="calibre10">Note that if you are using multiple networks or VLAN segments, to configure your OpenStack-Ansible deployment accordingly. The storage network presented in this book should be used for this iSCSI traffic (that is to say, when a volume attaches to an instance), and it is separate from the container network that is reserved for API traffic and interservice traffic.</p><p class="calibre10">In our example, <code class="email">cinder-volume</code> uses iSCSI as the mechanism for attaching a volume to an instance; <code class="email">openstack-ansible</code> then installs the packages that are required to run iSCSI targets.</p><p class="calibre10">OpenStack-Ansible provides the additional benefit of deploying any changes required to support Cinder. This includes creating the service within Keystone and configuring Nova to support volume backends.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating volumes" id="2RHM01-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec93" class="calibre1"/>Creating volumes</h1></div></div></div><p class="calibre10">Now that <a id="id434" class="calibre1"/>we have created a Cinder volume service, we can now create volumes for use by our instances. We do this under our client environment using the Python-OpenStack client with the <code class="email">python-cinderclient</code> library; so we are creating volumes specific to our project (tenant).</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip66" class="calibre1"/>Tip</h3><p class="calibre10">Refer to <a class="calibre1" title="Chapter 2. The OpenStack Client" href="part0024_split_000.html#MSDG1-189e69df43a248268db97cde1b1a8e47">Chapter 2</a>, <span class="strong"><em class="calibre18">The OpenStack Client</em></span>, for more information on installing and configuring the OpenStack client.</p></div></div>

<div class="book" title="Creating volumes" id="2RHM01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec282" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To create a volume, the following is required:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command line client</li><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The desired <span class="strong"><em class="calibre18">name</em></span> for the volume</li><li class="listitem">The desired <span class="strong"><em class="calibre18">size</em></span> in GiB for the volume</li></ul></div><p class="calibre10">For our example, these are the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Volume name: <code class="email">cookbook.volume</code></li><li class="listitem">Size: 10 GiB</li></ul></div></div></div>

<div class="book" title="Creating volumes" id="2RHM01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec283" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre10">Carry out <a id="id435" class="calibre1"/>the following steps to create a volume:</p><p class="calibre10">We simply create the volume that we will attach to our instance with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --size 10</strong></span>
<span class="strong"><strong class="calibre2">    --description "Cookbook Volume"</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.volume</strong></span>
</pre></div><p class="calibre10">On completion, the command returns the following output:</p><div class="mediaobject"><img src="../images/00131.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Creating volumes" id="2RHM01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec284" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Creating volumes is very straightforward. Using the <code class="email">openstack</code> client, we supply the <code class="email">volume</code> context and the <code class="email">create</code> action with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --size size_GiB</strong></span>
<span class="strong"><strong class="calibre2">    --description "meaningful description"</strong></span>
<span class="strong"><strong class="calibre2">    volume_name</strong></span>
</pre></div><p class="calibre10">Here, <code class="email">volume_name</code> can be any arbitrary name with no spaces.</p><p class="calibre10">As we are <a id="id436" class="calibre1"/>using a server that runs the <code class="email">cinder-volume</code> service, we can see the actual LVM volumes on <code class="email">cinder-volumes</code>, using the usual LVM tools, as follows (ensure that you are logged in as <code class="email">root</code> on the server we specified as storage host):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">lvdisplay cinder-volumes</strong></span>

<span class="strong"><strong class="calibre2">  --- Logical volume ---</strong></span>
<span class="strong"><strong class="calibre2">  LV Path                /dev/cinder-volumes/volume-bb7a7d2c-8069-4924-a18e-8fb398584a5d</strong></span>
<span class="strong"><strong class="calibre2">  LV Name                volume-bb7a7d2c-8069-4924-a18e-8fb398584a5d</strong></span>
<span class="strong"><strong class="calibre2">  VG Name                cinder-volumes</strong></span>
<span class="strong"><strong class="calibre2">  LV UUID                XqZY27-Ei32-EEdC-3UtE-MR6e-2EKw-XCvIGt</strong></span>
<span class="strong"><strong class="calibre2">  LV Write Access        read/write</strong></span>
<span class="strong"><strong class="calibre2">  LV Creation host, time cinder-volume, 2017-09-22 20:25:17 +0000</strong></span>
<span class="strong"><strong class="calibre2">  LV Status              available</strong></span>
<span class="strong"><strong class="calibre2">  # open                 0</strong></span>
<span class="strong"><strong class="calibre2">  LV Size                10.00 GiB</strong></span>
<span class="strong"><strong class="calibre2">  Current LE             2560</strong></span>
<span class="strong"><strong class="calibre2">  Segments               1</strong></span>
<span class="strong"><strong class="calibre2">  Allocation             inherit</strong></span>
<span class="strong"><strong class="calibre2">  Read ahead sectors     auto</strong></span>
<span class="strong"><strong class="calibre2">  - currently set to     256</strong></span>
<span class="strong"><strong class="calibre2">  Block device        </strong></span>
<span class="strong"><strong class="calibre2">   252:2</strong></span>
</pre></div></div></div>

<div class="book" title="Creating volumes" id="2RHM01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch07lvl2sec285" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre10">By default, Cinder volumes operate like a physical disk, insofar as they can only be attached to one instance at a time. However, for workloads that require a disk be shared between instances, you can pass the <code class="email">--multi-attach</code> flag when creating the volume to enable the volume to be attached to more than once instance:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --multi-attach</strong></span>
<span class="strong"><strong class="calibre2">    --description "description"</strong></span>
<span class="strong"><strong class="calibre2">    --size size_GiB</strong></span>
<span class="strong"><strong class="calibre2">    volume_name</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip67" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">A word of warning</strong></span>
</p><p class="calibre10">This feature is quite new and considered experimental for production environments, and is not a replacement for a shared storage service such as NFS. NFS supports locking that allows multiple clients to read and write to the same mount point. Multi-attach block storage does not support locking. Therefore, a valid use case could be a scenario where a master/slave service is employed and where the data should only be written to by only one instance at a time, but there is a benefit to having the data immediately available on failover.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Attaching volumes to an instance"><div class="book" id="2SG6I2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec94" class="calibre1"/>Attaching volumes to an instance</h1></div></div></div><p class="calibre10">Now that <a id="id437" class="calibre1"/>we have a usable volume, we can attach it to any instance. We'll do this using the <code class="email">openstack server volume add</code> command.</p></div>

<div class="book" title="Attaching volumes to an instance">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec286" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To attach a volume to an instance, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the <span class="strong"><em class="calibre18">volume</em></span> to attach</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the <span class="strong"><em class="calibre18">instance</em></span> to attach the volume to</li></ul></div><p class="calibre10">For our example, these values are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Volume: <code class="email">cookbook.volume</code></li><li class="listitem">Instance: <code class="email">cookbook.test</code></li></ul></div></div></div>

<div class="book" title="Attaching volumes to an instance">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec287" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre10">Carry out the following steps to attach a volume to an instance using the <code class="email">openstack</code> client:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, let's list running instances to get the ID of our instance:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list -c Name -c ID -f table</strong></span>
</pre></div><p class="calibre22">An example showing our running instance called <code class="email">cookbook.test</code> is shown here:</p><div class="mediaobject"><img src="../images/00132.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Now list <a id="id438" class="calibre1"/>the available volumes to get the ID of our volume:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list</strong></span>
</pre></div><p class="calibre22">This shows the information we need about our volume:</p><div class="mediaobject"><img src="../images/00133.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Using the <span class="strong"><em class="calibre18">instance</em></span> and <span class="strong"><em class="calibre18">volume</em></span> name or IDs, we'll attach the volume to the instance as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server add volume</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.test</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.volume</strong></span>
<span class="strong"><strong class="calibre2">    --device /dev/vdc</strong></span>
</pre></div><p class="calibre22">This command produces no output when successful.</p><p class="calibre22">Note that the <code class="email">--device</code> option is not always honored, depending on the operating system and image type. Always check which device the target instance operating system assigns to the new volume before performing any actions on it.</p><div class="note" title="Note"><h3 class="title2"><a id="tip68" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Tip</strong></span>: Volume or server names do not have to be unique in OpenStack; where volume and server names are not unique, replace the names with the IDs assigned instead. In the preceding example, this would achieve the same goal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server add volume</strong></span>
<span class="strong"><strong class="calibre2">    90654098-477f-417f-b102-453c0f1f9119</strong></span>
<span class="strong"><strong class="calibre2">    daeddd6c-908a-4ea8-8632-d93d198c2621</strong></span>
<span class="strong"><strong class="calibre2">    --device /dev/vdb</strong></span>
</pre></div></div></li><li class="listitem" value="4">Now we will perform actions inside our running instance. Log in to the instance and verify that the volume is now attached:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">lsblk</strong></span>
</pre></div><p class="calibre22">This will list the block devices available to our instance. Here we can see that our volume, attached as <code class="email">/dev/vdb</code>, is available but not mounted:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</strong></span>
<span class="strong"><strong class="calibre2">sr0     11:0    1  558K  0 rom</strong></span>
<span class="strong"><strong class="calibre2">vda    253:0    0  2.2G  0 disk</strong></span>
<span class="strong"><strong class="calibre2">`-vda1 253:1    0  2.2G  0 part /</strong></span>
<span class="strong"><strong class="calibre2">vdb    253:16    0  10G   0 disk</strong></span>
</pre></div></li><li class="listitem" value="5">We should see <code class="email">10G</code> of space available for use by the running instance. As this is a new <a id="id439" class="calibre1"/>volume, this is like adding a fresh disk to a system. We need to format it for use and then mount it as part of your filesystem:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo mkfs.ext4 /dev/vdb</strong></span>
<span class="strong"><strong class="calibre2">sudo mkdir /mnt1</strong></span>
<span class="strong"><strong class="calibre2">sudo mount /dev/vdb /mnt1</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip69" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Tip</strong></span>: Volumes created with Cinder are persistent storage volumes; formatting the volume (disk) is only required once. Should you need to re-attach this data volume to another instance in the future, do not reformat this drive!</p></div></li><li class="listitem" value="6">We should now see the newly attached disk available at <code class="email">/mnt1</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">df -h</strong></span>
</pre></div><p class="calibre22">This will show output like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Filesystem Size Used Avail Use% Mounted on</strong></span>
<span class="strong"><strong class="calibre2">udev       238M 0    238M  0%   /dev</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      49M  1.8M 48M   4%   /run</strong></span>
<span class="strong"><strong class="calibre2">/dev/vda1  2.1G 843M 1.3G  41%  /</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      245M 0    245M  0%   /dev/shm</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      5.0M 0    5.0M  0%   /run/lock</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      245M 0    245M  0%   /sys/fs/cgroup</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      49M  0    49M   0%   /run/user/1000</strong></span>
<span class="strong"><strong class="calibre2">/dev/vdb    9.8G 23M  9.2G   1%   /mnt1</strong></span>
</pre></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Attaching volumes to an instance">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec288" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Attaching a <span class="strong"><em class="calibre18">new</em></span> Cinder volume is very much like plugging in an unformatted USB stick into your own computer. When it needs to first be used, it must be formatted for use.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip70" class="calibre1"/>Tip</h3><p class="calibre10">On subsequent uses of this disk (when connecting to other instances in the future), you wouldn't need to perform this formatting step.</p></div><p class="calibre10">Under <a id="id440" class="calibre1"/>the <code class="email">openstack</code> client, the <code class="email">server add volume</code> option takes the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server add volume</strong></span>
<span class="strong"><strong class="calibre2">    instance_ID</strong></span>
<span class="strong"><strong class="calibre2">    volume_ID</strong></span>
<span class="strong"><strong class="calibre2">    --device /dev/device_ID</strong></span>
</pre></div><p class="calibre10">
<code class="email">instance_ID</code> is the ID returned from <code class="email">openstack server list</code> for the instance that we want to attach the volume to.</p><p class="calibre10">
<code class="email">volume_ID</code> is the ID of the volume returned from <code class="email">openstack volume list</code>.</p><p class="calibre10">
<code class="email">device_ID</code> is the device that will be created on our instance that we use to mount the volume. Remember that this parameter can sometimes be ignored; so, see this as a hint to pass to a running instance only.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Detaching volumes from an instance" id="2TEN41-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec95" class="calibre1"/>Detaching volumes from an instance</h1></div></div></div><p class="calibre10">Ordinarily, Cinder volumes can only be attached to one instance at a time. Thus, you need to <a id="id441" class="calibre1"/>detach it from one instance before attaching it to another. To detach a volume, we will use another OpenStack client command called <code class="email">openstack server remove volume</code>.</p></div>

<div class="book" title="Detaching volumes from an instance" id="2TEN41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec289" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To detach a volume from an instance, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The name or ID of the <span class="strong"><em class="calibre18">volume</em></span> to detach</li><li class="listitem">The name or ID of the <span class="strong"><em class="calibre18">instance</em></span> to detach the volume from</li></ul></div><p class="calibre10">For our example, these values are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Volume: <code class="email">cookbook.volume</code></li><li class="listitem">Instance: <code class="email">cookbook.test</code></li><li class="listitem">Mount point: <code class="email">/mnt1</code></li></ul></div></div></div>

<div class="book" title="Detaching volumes from an instance" id="2TEN41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec290" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre10">Carry out <a id="id442" class="calibre1"/>the following steps to detach a volume to an instance using the <code class="email">openstack</code> client:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">List running instances to get the ID of our instance:<div class="mediaobject"><img src="../images/00134.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">List the volumes that are available and <code class="email">in-use</code> in our environment:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following. Note that the information provided shows you if a volume is in use and what instance it is attached to:</p><div class="mediaobject"><img src="../images/00135.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">We now need to perform actions inside the running instance. Connect to this instance and verify that the volume is mounted:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">df -h</strong></span>
</pre></div><p class="calibre22">This will show an output like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Filesystem Size Used Avail Use% Mounted on</strong></span>
<span class="strong"><strong class="calibre2">udev       238M 0    238M  0%   /dev</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      49M  1.8M 48M   4%   /run</strong></span>
<span class="strong"><strong class="calibre2">/dev/vda1  2.1G 843M 1.3G  41%  /</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      245M 0    245M  0%   /dev/shm</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      5.0M 0    5.0M  0%   /run/lock</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      245M 0    245M  0%   /sys/fs/cgroup</strong></span>
<span class="strong"><strong class="calibre2">tmpfs      49M  0    49M   0%   /run/user/1000</strong></span>
<span class="strong"><strong class="calibre2">/dev/vdb    9.8G 23M  9.2G   1%   /mnt1</strong></span>
</pre></div></li><li class="listitem" value="4">Now unmount the <code class="email">/mnt1</code> volume:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo umount /mnt1</strong></span>
</pre></div><p class="calibre22">(Verify that it has been unmounted by running <code class="email">df -h</code> again).</p></li><li class="listitem" value="5">Exit the guest, and back on our OpenStack client, detach the volume from the instance with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server remove volume cookbook.test c</strong></span>
<span class="strong"><strong class="calibre2">ookbook.volume</strong></span>
</pre></div></li><li class="listitem" value="6">This command doesn't produce any output on success, so view the volume list again to verify that the volume has been detached from the <code class="email">cookbook.test</code> instance:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list</strong></span>
</pre></div><p class="calibre22">This shows the volume is available and not attached to any instance:</p><div class="mediaobject"><img src="../images/00136.jpeg" alt="How to do it..." class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Detaching volumes from an instance" id="2TEN41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec291" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Detaching <a id="id443" class="calibre1"/>a Cinder volume from an instance is similar to the steps you would take when removing a USB stick from a computer. First, we need to unmount it from the instance so the operating system doesn't complain about an unexpected removal of some storage. Next under the <code class="email">openstack</code> client, the <code class="email">server remove volume</code> option takes the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server remove volume instance_name_or_id volume_name_or_id</strong></span>
</pre></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting volumes" id="2UD7M1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec96" class="calibre1"/>Deleting volumes</h1></div></div></div><p class="calibre10">At some <a id="id444" class="calibre1"/>point, you will no longer need the volumes you have created. To remove the volumes from the system permanently, so they are no longer available, we simply pull out another tool from the OpenStack client, the <code class="email">volume delete</code> option.</p></div>

<div class="book" title="Deleting volumes" id="2UD7M1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec292" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To delete a volume, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The name or ID of the <span class="strong"><em class="calibre18">volume</em></span> to delete</li></ul></div><p class="calibre10">For our example, these values are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Volume: <code class="email">cookbook.volume</code></li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip71" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Warning</strong></span>: This will remove the volume and any data stored on it, so ensure that this is the correct action you want to perform before continuing.</p><p class="calibre10">You can only delete a volume that isn't currently attached to an instance.</p></div></div></div>

<div class="book" title="Deleting volumes" id="2UD7M1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec293" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To delete a volume using the OpenStack client, carry out the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we list the volumes available to identify the volume we want to delete, with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list</strong></span>
</pre></div><p class="calibre22">This shows that the volume is available and not attached to any instance:</p><div class="mediaobject"><img src="../images/00137.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">We will now use the volume name or ID to delete this from the system, with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume delete cookbook.volume</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip72" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output when successful.</p><p class="calibre10">As with attaching and detaching volumes, an ID or name can be used. Best practice is to use the ID to avoid any discrepancies and delete the wrong volume.</p></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Deleting volumes" id="2UD7M1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec294" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">How the <a id="id445" class="calibre1"/>actual volume is deleted depends largely on the Cinder volume driver. In the <span class="strong"><em class="calibre18">Configuring Cinder volume services</em></span> recipe of this chapter, we used <code class="email">cinder.volume.drivers.lvm.LVMVolumeDriver</code>. In this case, deleting images removes the LVM volume from use within our system.</p></div></div>

<div class="book" title="Deleting volumes" id="2UD7M1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch07lvl2sec295" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre10">OpenStack Cinder volumes can be snapshotted, in which case, the <code class="email">openstack volume delete</code> command will produce an error message like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Invalid volume: Volume status must be available or error or error_restoring or error_extending or error_managing and must not be migrating, attached, belong to a group, have snapshots or be disassociated from snapshots after volume transfer. (HTTP 400) (Request-ID: req-2b82e7fc-0cb4-403f-8dd8-35d99a0f6c6c)</strong></span>
</pre></div><p class="calibre10">To delete a volume, and all of its snapshots, pass the <code class="email">--purge</code> flag to the <code class="email">openstack volume delete</code> command.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip73" class="calibre1"/>Tip</h3><p class="calibre10">Be careful with this. It is a one-way operation, and <code class="email">openstack volume delete</code> does not prompt for confirmation. Additionally, the command produces no output when successful.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Working with volume snapshots" id="2VBO81-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec97" class="calibre1"/>Working with volume snapshots</h1></div></div></div><p class="calibre10">Cinder <a id="id446" class="calibre1"/>volume <span class="strong"><strong class="calibre2">snapshots</strong></span> provide a way to nondisruptively copy a volume; allowing for in-situ volume backups to be taken. It also enables <a id="id447" class="calibre1"/>more advanced backup features and provides the ability to boot an instance from a given snapshot or from a point in time.</p><p class="calibre10">In this section, we will show you how to create a snapshot, mount a volume based off a snapshot, refresh a snapshot, and delete a given snapshot.</p></div>

<div class="book" title="Working with volume snapshots" id="2VBO81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec296" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To work with Cinder volume snapshots, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The name or ID of the <span class="strong"><em class="calibre18">volume</em></span> to delete</li></ul></div></div></div>

<div class="book" title="Working with volume snapshots" id="2VBO81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec297" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To create <a id="id448" class="calibre1"/>a snapshot, the volume must be first detached from an instance:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list your current volumes:<div class="mediaobject"><img src="../images/00138.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><div class="note" title="Note"><h3 class="title2"><a id="tip74" class="calibre1"/>Tip</h3><p class="calibre10">If the volume you wish to snapshot has a status of <code class="email">in-use</code>, you will need to detach it using the instructions in the <span class="strong"><em class="calibre18">Detaching volumes from an instance</em></span> recipe earlier in this chapter.</p></div></li><li class="listitem" value="2">As our volume is the correct state of <code class="email">available</code>, we will proceed to create a snapshot of the volume using the <code class="email">openstack volume snapshot create</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume snapshot create</strong></span>
<span class="strong"><strong class="calibre2">    --volume cookbook.volume</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.snapshot</strong></span>
</pre></div><p class="calibre22">This will produce an output like the following, showing a state of <code class="email">creating</code>:</p><div class="mediaobject"><img src="../images/00139.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Once the snapshot is complete, you can reattach the original volume using the <span class="strong"><em class="calibre18">Attaching volumes to an instance</em></span> recipe, in this chapter and continue operations.</li><li class="listitem" value="4">If using <a id="id449" class="calibre1"/>snapshots as part of an ongoing test / validation process, or part of a backup scheme, you may want to update the snapshot with fresh data. To do this, we use the <code class="email">cinder snapshot-reset-state</code>, which produces no output if successful:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume snapshot list -c ID -c Name -c Status -f table</strong></span>
<span class="strong"><strong class="calibre2">cinder snapshot-reset-state cookbook.snapshot</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip75" class="calibre1"/>Tip</h3><p class="calibre10">Note the use of the <code class="email">cinder</code> command-line tool, as opposed to <code class="email">openstack</code>.</p></div></li><li class="listitem" value="5">You are unable to use a snapshot directly; to use a snapshot as a volume to attach to an instance, you first need to create a new volume based off this snapshot. To do this, carry out the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --snapshot cookbook.snapshot</strong></span>
<span class="strong"><strong class="calibre2">    newcookbook.volume</strong></span>
</pre></div><p class="calibre22">This will produce the following output. Note <code class="email">snapshot_id</code> that was used and the fact that we didn't specify a size:</p><div class="mediaobject"><img src="../images/00140.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="6">We can <a id="id450" class="calibre1"/>confirm that our new cookbook volume, based off the snapshot, is now available by viewing the volume list again:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list –c Name –c ID –c Status –f table</strong></span>
</pre></div><p class="calibre22">This produces a list of our volumes and their state:</p><div class="mediaobject"><img src="../images/00141.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="7">Finally, you will want to delete snapshots at some point. To do this, use the <code class="email">openstack volume snapshot delete</code> command as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume snapshot delete cookbook.snapshot</strong></span>
</pre></div><p class="calibre22">Confirm with <code class="email">openstack volume snapshot list</code> the list the remaining snapshots available.</p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Working with volume snapshots" id="2VBO81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec298" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Cinder volume <a id="id451" class="calibre1"/>snapshots provide a flexible way to clone volumes for snapshot type backups, attaching to other instances, and more. The <code class="email">cinder snapshot</code> commands we used here, specifically <code class="email">openstack volume snapshot create</code>, <code class="email">openstack volume snapshot list</code>, <code class="email">cinder snapshot-reset-state</code>, and <code class="email">openstack volume snapshot delete</code>, instruct <code class="email">cinder</code> to work with the storage driver to perform snapshot specific actions—create, list, update, and delete, respectively. The specific implementation of snapshot depends on the underlying driver.</p><p class="calibre10">Also note that you cannot use a snapshot directly with an instance. You must first create a new volume based on the snapshot of your choice. This has the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --snapshot snapshot_name_or_id</strong></span>
<span class="strong"><strong class="calibre2">    new_volume_name</strong></span>
</pre></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring volume types" id="30A8Q1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec98" class="calibre1"/>Configuring volume types</h1></div></div></div><p class="calibre10">Volume types <a id="id452" class="calibre1"/>in Cinder are a label or identifier that is selected during volume creation. Typically, volume types correspond with some attribute of the volumes, for example, <code class="email">SSD</code>, <code class="email">High IOPS</code>, and <code class="email">Encrypted</code>. We will use this with the next recipe to define further features of our Cinder service.</p></div>

<div class="book" title="Configuring volume types" id="30A8Q1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec299" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To create a volume type, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment (you must be an administrator)</li><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The name of the volume type to create. For our example, we will create the <code class="email">"High IOPS"</code> volume type as a contrived example type that would refer to a block storage device dedicated to High IOPS.</li></ul></div></div></div>

<div class="book" title="Configuring volume types" id="30A8Q1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec300" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">We will use the <code class="email">openstack volume type</code> command to operate on Cinder volume types. To create <a id="id453" class="calibre1"/>a volume type, use the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the existing volume types:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume type list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following. Here we have the default set when we installed our LVM service:</p><div class="mediaobject"><img src="../images/00142.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Create the new volume type:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume type create</strong></span>
<span class="strong"><strong class="calibre2">    --description "The High IOPS volume type is QOS applied to 500 IOPS"</strong></span>
<span class="strong"><strong class="calibre2">    "High IOPS"</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00143.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Confirm that the new volume type is available by displaying the list of volume types:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume type list</strong></span>
</pre></div><p class="calibre22">This will now bring back our additional volume type:</p><div class="mediaobject"><img src="../images/00144.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">To use <a id="id454" class="calibre1"/>this new type when creating a volume, we will use the <code class="email">--type</code> flag as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --size 10</strong></span>
<span class="strong"><strong class="calibre2">    --type "High IOPS"</strong></span>
<span class="strong"><strong class="calibre2">    --description "High IOPS Volume"</strong></span>
<span class="strong"><strong class="calibre2">    highiops.volume</strong></span>
</pre></div></li><li class="listitem" value="5">We will verify the type in the output:<div class="mediaobject"><img src="../images/00145.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Configuring volume types" id="30A8Q1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec301" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">openstack volume type create</code> command has only one mandatory parameter, <code class="email">name</code>. The <code class="email">name</code> parameter allows users to define different volume types or identifiers. While typically <a id="id455" class="calibre1"/>based on some attribute of the storage, such as department, storage backend, or QOS level, as these are labels, as long as they're well understood, the name can be arbitrary.</p><p class="calibre10">Additionally, the <code class="email">--description</code> flag can be used to provide more detail on the volume type. The <code class="email">--private</code> flag allows you to restrict visibility from the public. The <code class="email">--project</code> flag allows the selective sharing of a private volume type with other named projects.</p><p class="calibre10">We will then take advantage of these types (with further configuration of Cinder to specify that a type of storage, which is associated with a particular volume type) by issuing the <code class="email">--type</code> flag to the <code class="email">volume create</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --size size_GiB</strong></span>
<span class="strong"><strong class="calibre2">    --description "meaningful description"</strong></span>
<span class="strong"><strong class="calibre2">    --type "Type"</strong></span>
<span class="strong"><strong class="calibre2">    volume_name</strong></span>
</pre></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Enabling volume encryption" id="318PC1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec99" class="calibre1"/>Enabling volume encryption</h1></div></div></div><p class="calibre10">Cinder <a id="id456" class="calibre1"/>can <a id="id457" class="calibre1"/>manage the <span class="strong"><strong class="calibre2">encryption</strong></span> of volumes, and it happens transparent to the guest. Encryption is enabled on a <span class="strong"><em class="calibre18">volume type</em></span> level.</p></div>

<div class="book" title="Enabling volume encryption" id="318PC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec302" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">Encryption can be enabled either when creating a new volume type or added to an existing volume type that has no volumes in use. To enable volume encryption, you will need the <a id="id458" class="calibre1"/>following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The name of the <span class="strong"><em class="calibre18">volume type</em></span></li><li class="listitem">Name of the <span class="strong"><em class="calibre18">encryption provider</em></span></li><li class="listitem">Encryption control location</li><li class="listitem">Encryption key size</li><li class="listitem">Encryption cipher</li></ul></div><p class="calibre10">For our example, these will be as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Name: <code class="email">Cookbook Encrypted Volumes</code></li><li class="listitem">Encryption provider: <code class="email">nova.volume.encryptors.luks.LuksEncryptor</code></li><li class="listitem">Encryption control location: <code class="email">front-end</code></li><li class="listitem">Encryption key size: <code class="email">256</code></li><li class="listitem">Encryption cipher: <code class="email">aes-xts-plain64</code></li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note33" class="calibre1"/>Note</h3><p class="calibre10">The encryption-specific values you choose will be based on what is available in your particular environment. A detailed discussion of these values is beyond the scope of this book.</p></div></div></div>

<div class="book" title="Enabling volume encryption" id="318PC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec303" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To enable volume encryption as a new volume type, the following command is used:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume type create</strong></span>
<span class="strong"><strong class="calibre2">    --description "LUKS Encrypted volumes"</strong></span>
<span class="strong"><strong class="calibre2">    --encryption-provider nova.volume.encryptors.luks.LuksEncryptor</strong></span>
<span class="strong"><strong class="calibre2">    --encryption-control-location front-end</strong></span>
<span class="strong"><strong class="calibre2">    --encryption-key-size 256</strong></span>
<span class="strong"><strong class="calibre2">    --encryption-cipher aes-xts-plain64</strong></span>
<span class="strong"><strong class="calibre2">    "Encrypted"</strong></span>
</pre></div><p class="calibre10">We would then use this <code class="email">"Encrypted"</code> volume type when creating a volume as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume create</strong></span>
<span class="strong"><strong class="calibre2">    --size 1</strong></span>
<span class="strong"><strong class="calibre2">    --type "Encrypted"</strong></span>
<span class="strong"><strong class="calibre2">    --description "An encrypted volume"</strong></span>
<span class="strong"><strong class="calibre2">    encrypted.volume</strong></span>
</pre></div></div></div>

<div class="book" title="Enabling volume encryption" id="318PC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec304" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Volumes <a id="id459" class="calibre1"/>are configured as a volume type, and thus, additional parameters are passed to <code class="email">openstack volume type create</code>:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">--encryption-provider</code> flag let's Cinder know which provider will perform the encryption. As with storage backends, there are a number of providers available. Refer to the OpenStack documentation for a current list.</li><li class="listitem">The <code class="email">--encryption-control-location</code> parameter tells Cinder where the encryption will be handled. In our case, <code class="email">front-end</code> means that Nova will be handling the encryption.</li><li class="listitem">Next, the <code class="email">--encryption-key-size</code> parameter specifies the size of the key used. <code class="email">256</code> was selected for the example as to not crush lab performance. The encryption provider and cipher you choose will provide specific recommendations.</li><li class="listitem">Finally, <code class="email">--encryption-cipher</code> specifies which cipher to use. You can use <code class="email">cryptsetup benchmark</code> to get a list of available options and an idea as to how they will perform.</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring volume Quality of Service (QoS)" id="3279U1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec100" class="calibre1"/>Configuring volume Quality of Service (QoS)</h1></div></div></div><p class="calibre10">Another <a id="id460" class="calibre1"/>feature provided by Cinder is <a id="id461" class="calibre1"/>the ability to define and manage classes of service for volumes. Like volume encryption, <span class="strong"><strong class="calibre2">Quality of Service</strong></span> (<span class="strong"><strong class="calibre2">QoS</strong></span>) in Cinder is configured by volume type. By default, you can define values for minimum, maximum, and burst IOPS.</p></div>

<div class="book" title="Configuring volume Quality of Service (QoS)" id="3279U1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec305" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To configure volume QoS, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment (you need to be an administrator)</li><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The name or ID of the <span class="strong"><em class="calibre18">volume type</em></span></li><li class="listitem">The <span class="strong"><em class="calibre18">consumer</em></span> of the QoS policy</li><li class="listitem">Values for the following:<div class="book"><ul class="itemizedlist1"><li class="listitem">Minimum IOPS</li><li class="listitem">Maximum IOPS</li><li class="listitem">Burst IOPS</li></ul></div><div class="note" title="Note"><h3 class="title2"><a id="note34" class="calibre1"/>Note</h3><p class="calibre10">Only one of the three (min, max, and burst) needs to be provided to define a minimal QoS policy.</p></div></li></ul></div><p class="calibre10">For our example, these will be as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Name: <code class="email">High IOPS</code></li><li class="listitem">Consumer: <code class="email">both</code></li><li class="listitem">Maximum IOPS: <code class="email">500</code></li></ul></div></div></div>

<div class="book" title="Configuring volume Quality of Service (QoS)" id="3279U1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec306" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">For Cinder <a id="id462" class="calibre1"/>volumes to use QoS, an administrator needs to perform two steps: first, define the specification, and second, to associate the specification with a volume type.</p><p class="calibre10">To create and assign a QoS specification, use the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the existing QoS specifications:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume qos list --print-empty</strong></span>
</pre></div><p class="calibre22">We currently don't have any QoS defined:</p><div class="mediaobject"><img src="../images/00146.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Define a new QoS specification with the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume qos create</strong></span>
<span class="strong"><strong class="calibre2">    --consumer both</strong></span>
<span class="strong"><strong class="calibre2">    --property maxIOPS=500</strong></span>
<span class="strong"><strong class="calibre2">    "High IOPS"</strong></span>
</pre></div><p class="calibre22">This will bring back the following output:</p><div class="mediaobject"><img src="../images/00147.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Confirm our QoS specification was created by listing the QoS available:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume qos list -c Name -c Consumer -c Properties -f table</strong></span>
</pre></div><p class="calibre22">This will bring back the following output:</p><div class="mediaobject"><img src="../images/00148.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">We now associate the policy to a volume type as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume qos associate "High IOPS" "High IOPS"</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note35" class="calibre1"/>Note</h3><p class="calibre10">This command produces no output when successful.</p></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Configuring volume Quality of Service (QoS)" id="3279U1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec307" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">QoS specifications are defined within Cinder using the <code class="email">openstack volume qos</code> set of commands. When creating a QoS specification, you can specify where QoS is applied as well as <a id="id463" class="calibre1"/>the value to set it at. Currently, you can specify a static set of minimum, maximum, and burst IOPS, and a scaling set of IOPS.</p><p class="calibre10">The static values break down as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Minimum IOPS</strong></span>: This is the number of IOPs <span class="strong"><em class="calibre18">guaranteed</em></span> to a volume</li><li class="listitem"><span class="strong"><strong class="calibre2">Maximum</strong></span>: This is the ceiling for IOPS on a volume</li><li class="listitem"><span class="strong"><strong class="calibre2">Burst IOPS</strong></span>: This is the maximum IOPS over a short period</li></ul></div><p class="calibre10">Scaling IOPs then, define the amount to change the static values for each additional gigabyte of volume size.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Resetting volume state" id="335QG1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec101" class="calibre1"/>Resetting volume state</h1></div></div></div><p class="calibre10">During the <a id="id464" class="calibre1"/>ongoing operation of your OpenStack cloud, you will occasionally encounter trouble where a Cinder volume will get stuck in an odd state. During the course of writing this chapter, the authors had a number of volumes getting stuck in the <code class="email">attaching</code> status, after an instance failed to boot from them. This looks like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list -c Name -c Status -f table</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00149.jpeg" alt="Resetting volume state" class="calibre16"/></div><p class="calibre17"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note36" class="calibre1"/>Note</h3><p class="calibre10">The cause of this was some fat-fingered typing while creating the boot from volume section!</p></div></div>

<div class="book" title="Resetting volume state" id="335QG1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec308" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To reset <a id="id465" class="calibre1"/>the status on a Cinder volume, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An <code class="email">openrc</code> file with appropriate credentials for the environment</li><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">cinder</code> command-line client</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the volume</li></ul></div><p class="calibre10">For the example that follows, we will be resetting the following volumes to available:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">cookbook.boot.volume</code></li><li class="listitem"><code class="email">cookbook.volume.boot.test</code></li></ul></div></div></div>

<div class="book" title="Resetting volume state" id="335QG1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec309" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">Resetting the status of a Cinder volume is done with the <code class="email">cinder</code> command. Here the <code class="email">openstack</code> set of commands covers most operations you will commonly need to do, and the <code class="email">cinder</code> command provides additional admin functionality, such as <code class="email">reset-state</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip76" class="calibre1"/>Tip</h3><p class="calibre10">As the <code class="email">reset-state</code> command only manipulates the database without regard to the actual status, it should be used with care.</p></div><p class="calibre10">To reset the status of a Cinder volume, carry out the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list your Cinder volumes and statuses<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list -c Name -c Status -f table</strong></span>
</pre></div><p class="calibre22">This will bring back a list of the volumes OpenStack knows about:</p><div class="mediaobject"><img src="../images/00149.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Use the <code class="email">cinder</code> client to reset the state of the volumes:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cinder reset-state 23e1e006-a753-403c</strong></span>
<span class="strong"><strong class="calibre2">-ad8f-27e98444f71e --state available</strong></span>
<span class="strong"><strong class="calibre2">cinder reset-state e934c45f-6e2f-431f-8457-7e84f6cee876 --state available</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note37" class="calibre1"/>Note</h3><p class="calibre10">When successful, this command produces no output.</p></div></li><li class="listitem" value="3">Confirm <a id="id466" class="calibre1"/>the new status:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack volume list -c Name -c Status -f table</strong></span>
</pre></div><p class="calibre22">This will show that the state has been reset to <code class="email">available</code>:</p><div class="mediaobject"><img src="../images/00150.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Resetting volume state" id="335QG1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec310" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">cinder reset-state</code> command operates directly on the <code class="email">cinder</code> database, regardless of the actual status of the volume. The <code class="email">--state</code> flag we used allows us to change the status of a volume that might be stuck in a particular state. There are two additional flags that allow you to change the attachment status and migration status, respectively:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cinder help reset-state</strong></span>
<span class="strong"><strong class="calibre2">usage: cinder reset-state</strong></span>
<span class="strong"><strong class="calibre2">    [--type ]</strong></span>
<span class="strong"><strong class="calibre2">    [--state ]</strong></span>
<span class="strong"><strong class="calibre2">    [--attach-status ]</strong></span>
<span class="strong"><strong class="calibre2">    [--reset-migration-status]</strong></span>
<span class="strong"><strong class="calibre2">    [ ...]</strong></span>
</pre></div><p class="calibre10">This tool <a id="id467" class="calibre1"/>explicitly updates the entity state in the <code class="email">cinder</code> database. Being a database change only, this has no impact on the true state of the entity and may not match the actual state. This can render an entity unusable in the case of changing to the <code class="email">available</code> state.</p></div></div></body></html>