<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Understanding Encryption Key Management Strategies</h1>
                </header>
            
            <article>
                
<p>In this chapter, you'll learn to use the three different key deployment models to address different compliance requirements and understand what role the Azure Key Vault service plays in this. We'll discuss the three Azure Rights Management Services flows for a better understanding of how keys are used in the complete <strong>Azure Information Protection</strong> (<strong>AIP</strong>) solution to address the correct implementation and to help you troubleshooting the solution. This chapter will be divided into the following sections:</p>
<ul>
<li>Azure Information Protection key basics:
<ul>
<li>Key deployment models</li>
<li>What is a <strong>hardware security module</strong> (<strong>HSM</strong>)?</li>
<li>What is the Azure Key Vault? </li>
</ul>
</li>
<li>How Azure RMS works under the hood:
<ul>
<li>Algorithms and key lengths</li>
<li>User environment-initialization flow</li>
<li>Content protection flow</li>
<li>Content consumption flow</li>
</ul>
</li>
</ul>
<p>Let's start with the AIP key basics!</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Information Protection key basics</h1>
                </header>
            
            <article>
                
<p>The Azure <strong>Rights Management Service</strong> (<strong>RMS</strong>) is part of the AIP solution of Microsoft. The Rights Management web service provides protection functionality, including administration, account certification, and licensing. Certification refers to the account certification and activation activities performed by Azure RMS. Each user must acquire a set of certificates and associated keys to be able to participate. Licensing refers to the set of operations by which Azure RMS grants access to protected content to authorized users. The Azure RMS service grants a use license (usage rights) for each document to authorized users.</p>
<div class="packt_quote packt_infobox">The Azure RMS service exposes <strong>Simple Object Access Protocol</strong> (<strong>SOAP</strong>) interfaces that are used by clients to interact with Azure RMS</div>
<p>The Azure Rights Management web service also uses rights management templates, which specify a predefined set of rights and conditions that can be applied to protect content. In AIP, the rights-management templates are associated with labels. To support other classification solutions, rights-management templates can also be configured without the association of a label. We already dived into these topics in <a href="bf7343f1-51f5-4e33-a9a6-e6e682e58071.xhtml">Chapter 13</a>, <em>Identifying and Detecting Sensitive Data</em>.</p>
<div class="packt_quote packt_infobox">The web service provides by default the needed high availability with a <strong>Service Level Agreement</strong> (<strong>SLA</strong>) of 99.9% uptime. </div>
<p>Azure RMS is an Azure service that provides information protection by using encryption to help secure documents, files, emails, and other content.</p>
<p>By default, AIP and the rights-management part generate the tenant key and manage most aspects of the tenant key life cycle. This is the simplest option with the lowest administrative overhead. In most cases, organizations with no additional or special security requirements will use this deployment model. They just sign up for AIP and the key-management process is handled by Microsoft.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Alternatively, organizations might want to have complete control over their tenant key due to security or compliance requirements. For this reason, Microsoft provides a separate deployment model called <strong>bring your own key</strong> (<strong>BYOK</strong>). Typical customers are based in the insurance or health sector. In this deployment model, customers can create hardware- or software-based keys. Hardware-based keys will be created on an HSM, which is the recommended option, and will be securely transferred to and stored in Azure Key Vault. AIP will be configured to use customer keys. Many large organizations already have the hardware, software, and processes in place to manage their key material—this is typical on HSM. Most of them prefer to extend the HSM infrastructure to the cloud.</p>
<p>The third deployment model is called <strong>hold your own key</strong> (<strong>HYOK</strong>). This model requires an isolated on-premise <strong>Active Directory Rights Management Service</strong> (<strong>AD RMS</strong>) instance to be installed on a Windows Server. The AD RMS instance will work with a different private key to protect secret data. Protection using this AD RMS instance is based on labels. AD RMS, by default, doesn't provide any labeling capabilities.</p>
<p>Choosing between the different models is driven by your organization's compliance requirements, which are as follows:</p>
<ul>
<li>Contracts with your customers with a specific requirement for cryptography and audit</li>
<li>Industry, corporate, and regulation requirements</li>
<li>Data-sovereignty laws, which bring place regulations and key placement</li>
<li>Data classification, which defines what sensitive data can't be stored in the cloud</li>
</ul>
<p class="mce-root"/>
<p>The following diagram shows the three deployment models:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/54409845-b171-443d-a501-b43f301227e5.png" width="959" height="665"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure RMS deployment models</div>
<p>Within the following licenses, you can use the three deployment models:</p>
<table style="border-collapse: collapse;width: 100%;height: 0px" border="1">
<tbody>
<tr>
<td><strong>Scenario</strong></td>
<td class="CDPAlignCenter CDPAlign"><strong>Office 365 E3 or higher</strong></td>
<td class="CDPAlignCenter CDPAlign"><strong>AIP P1 or EMS E3/M365 E3</strong></td>
<td class="CDPAlignCenter CDPAlign"><strong>AIP P2 or EMS E5/M365 E3</strong></td>
</tr>
<tr>
<td>Microsoft-managed</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
<tr>
<td>BYOK</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
<tr>
<td>HYOK</td>
<td class="CDPAlignCenter CDPAlign"/>
<td class="CDPAlignCenter CDPAlign"/>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
</tbody>
</table>
<p>There is also an option to use service encryption with a customer key in Office 365 to provide and control the encryption keys for your at-rest Office 365 data at the application level.</p>
<p>The following tenant key actions are available:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong>Action</strong></td>
<td class="CDPAlignCenter CDPAlign"><strong>Microsoft-managed</strong></td>
<td class="CDPAlignCenter CDPAlign"><strong>Customer-managed</strong></td>
</tr>
<tr>
<td>Revoke</td>
<td class="CDPAlignCenter CDPAlign"/>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
<tr>
<td>Rekey</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
<tr>
<td>Back up and recover</td>
<td class="CDPAlignCenter CDPAlign"/>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
<tr>
<td>Export</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign"/>
</tr>
<tr>
<td>Breach response</td>
<td class="CDPAlignCenter CDPAlign">X</td>
<td class="CDPAlignCenter CDPAlign">X</td>
</tr>
</tbody>
</table>
<div class="packt_tip">To find out more about service encryption with Customer Key for Office 365, visit <a href="https://bit.ly/2SxCJW5">https://bit.ly/2SxCJW5</a>.</div>
<p>Also shown in the preceding diagram are the three keys that matter in the main protection flow:</p>
<ul>
<li><strong>Red</strong>: The tenant private key (asymmetric), which is used for the decryption of the publishing license</li>
<li><strong>Orange</strong>: The tenant public key (asymmetric), which is used for the encryption of the publishing license</li>
<li><strong>Green</strong>: The document-specific key (symmetric), which is used for encryption/decryption of the content</li>
</ul>
<p>To understand this better, check out the main functionality of the <strong>Rights Management Services</strong> in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2d0e9279-5e7b-4e06-b1fb-c6f64f11f34d.png" style="width:33.75em;height:22.25em;" width="726" height="478"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure RMS basic functionality</div>
<p>The process starts with protecting information and ends with consuming it with the applied permissions from the data owner or the classification level:</p>
<ol>
<li class="mce-root">The document will be created, labeled, and protected with RMS<span>—</span>for this, we need to be authenticated against the rights-management service</li>
<li class="mce-root">The label-associated rights and the key material will be requested transparently <span>from</span> the user</li>
<li class="mce-root">The key material will be received transparently by the user</li>
<li class="mce-root">The document will be protected with the chosen rights</li>
<li class="mce-root">The document will be distributed to the required recipients</li>
<li class="mce-root"><span>T</span>he document will be received from the recipient, so the recipient needs to be authenticated against the Rights Management Service by Single-Sign-On or Single Login</li>
<li class="mce-root">The key material and the usage rights will be requested transparent to the recipient</li>
<li class="mce-root">The key material will be received, and the recipient can access the information with the appropriated rights, otherwise the user will get an access denied message</li>
</ol>
<div class="packt_tip">Be sure to plan your key deployment carefully.</div>
<p><span>Next, we will discuss the Microsoft-managed key-deployment model.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Microsoft-managed keys</h1>
                </header>
            
            <article>
                
<p>If AIP gets activated, a new tenant key be generated, stored, and managed by the Azure Information Protection services. In this default case, the key type is referred to as a Microsoft-managed key. The following diagram shows the deployment model:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9961f090-c6f5-4336-8200-20143c5d59d1.png" style="width:47.75em;height:13.25em;" width="697" height="193"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Microsoft Services key model</div>
<p>You should use this deployment model if Microsoft's security and controls are adequate for your organization. This model is available by default and doesn't need any additional subscription or configuration. There are also no special plans needed for capacity, performance, or scale. For most organizations, this is the best option. The deployment model has the following features:</p>
<ul>
<li>Completely-managed tenant private key</li>
<li>Tenant private key is encrypted at rest and handled as customer data</li>
<li>Default key length is 2,048 bit RSA</li>
</ul>
<p>Now, we will verify the <kbd>Microsoft-managed</kbd> key that's used by our tenant with the following cmdlets:</p>
<pre><strong># Installing the AADRM module to administer Azure RMS</strong><br/><strong>Install-Module -Name AADRM</strong><br/><strong># Connecting to Azure RMS with global administrator rights</strong><br/><strong>Connect-AadrmService</strong><br/><strong># Listing the Azure RMS keys</strong><br/><strong>Get-AadrmKeys</strong></pre>
<p>The following screenshot shows the expected result of a freshly-activated tenant:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7c255bd4-0a0b-4840-806b-faf635afe55a.png" style="width:28.92em;height:12.17em;" width="590" height="248"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Actual RMS key information</div>
<p>Another important factor is where your Azure RMS service is provisioned for choosing an Azure Key Vault location in a BYOK-deployment for latency reasons. We can gather this information with the following cmdlet:</p>
<pre><strong>Get-AadrmConfiguration</strong></pre>
<p>In our case, the Azure RMS tenant is provisioned in Europe, which we can see in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8bf78a30-8b1a-4bb1-8038-a42184208f5d.png" width="1475" height="611"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure RMS actual configuration overview</div>
<p>Next, we will take a deeper look into the BYOK deployment model.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Bring your own key</h1>
                </header>
            
            <article>
                
<p>If you use Azure Key Vault to store key, which indicates that you use the BYOK deployment, you can import keys from your on-premises HSM or generate keys inside the <strong>Azure Key Vault</strong> that are stored in an HSM. Keys never leave the HSM boundaries. </p>
<div class="mce-root packt_tip packt_infobox">At the time of writing, Microsoft provides a public preview using dedicated HSMs. You can find more information at <a href="https://bit.ly/2KFnJT7">https://bit.ly/2KFnJT7</a>.</div>
<p>You should use the <strong>BYOK</strong> deployment model if you need to fulfill additional compliance requirements, such as data residency or specific cryptographic regulations. The following diagram shows the architecture of the deployment:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/419b751c-c4fb-4b44-8bf6-3e96cb205085.png" width="951" height="285"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Bring your own key model</div>
<p>The following key facts are related to BYOK:</p>
<ul>
<li>Azure Information Protection doesn't have visibility over the private key; there is a clear separation of duties with the usage of <strong>Azure Key Vault</strong></li>
<li>Cryptographic operations are done completely within Azure Key Vault</li>
<li>The tenant private key is stored in Azure Key Vault</li>
</ul>
<p> With the configuration part, we'll take a closer look at HSMs and the Azure Key Vault. We'll configure our Azure-Key-Vault-based key and change to the BYOK deployment.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">What is an HSM?</h1>
                </header>
            
            <article>
                
<p>HSMs are physical devices that provide a hardened, tamper-resistant environment to manage and securely store digital keys used in Azure RMS and other applications. HSMs provide organizations with the ability to securely manage their private keys on-premises. The following diagram, provided by Thales, shows the BYOK-integration scenario:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/278c4371-22ea-47e9-8051-aebd1fe62542.png" width="1539" height="826"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Thales HSM integration</div>
<p>The following table provides a summary of the benefits of implementing a <strong>Thales</strong> HSM in the Azure RMS deployment:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong>Secure key storage</strong></td>
<td>HSMs provide a tamper-resistant environment for the storage of private keys. All Thales HSMs are certified to meet the highest security standards.</td>
</tr>
<tr>
<td><strong>Compliance</strong></td>
<td>HSMs are FIPS 140-2 Level 3 Standard, which is the most widely accepted benchmark for hardware security in both enterprise and government environments.</td>
</tr>
<tr>
<td><strong>Extensibility</strong></td>
<td>Using a Thales HSM for key storage allows the Azure RMS environment to be extensible to on-premises for future migrations.</td>
</tr>
</tbody>
</table>
<p> </p>
<p>You can also use Gemalto HSMs for this scenario. You can find an example at <a href="https://bit.ly/2GW3t1d">https://bit.ly/2GW3t1d</a>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">What is the Azure Key Vault?</h1>
                </header>
            
            <article>
                
<p>Azure Key Vault can be best described as a Key Management Service that is based on FIPS 140-2 validated HSMs, which also provides secrets and certificate-management services. Azure Key Vault is used for Azure RMS BYOK deployments. The service itself provides the following capabilities:</p>
<ul>
<li>Centralized secret management</li>
<li>Compliance through Software/Hardware HSM protection</li>
<li>Read/Write management over REST API/SDK/PowerShell and CLI</li>
<li>Access and usage monitoring</li>
<li>Automated distribution, logging inspection, and deployments</li>
<li>Throttling and Versioning</li>
<li>SLA 99.9% and 6 persistent copies (3 copies same region/3 additional copies secondary region)</li>
</ul>
<p>For Azure RMS and BYOK, you need to use the P1 Premium option to import your keys from on-premises or create keys directly in Azure Key Vault. The term BYOK is used both times. For <span>production</span> environments, we recommend using an on-premises HSM, and you can work through the following source to configure your environment: <a href="https://bit.ly/2wma4Yl">https://bit.ly/2wma4Yl</a>.</p>
<p>For demonstration purposes, we are using keys that were generated in Azure Key Vault, because we don't think you want to invest many thousands of dollars into your personal HSM.</p>
<p>Perform the following steps to test the BYOK deployment in your demo environment:</p>
<ol>
<li>Open <a href="https://portal.azure.com">https://portal.azure.com</a> as a global administrator, choose <span class="packt_screen">Key Vaults</span>, and click <span class="packt_screen">Create key vault</span>:</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign"><img src="Images/da90872a-1a67-4eea-ac16-170218a972e0.png" width="1561" height="757"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Key Vault creation</div>
<ol start="2">
<li>Fill in the following information:
<ul>
<li>Use the <span class="packt_screen">Premium Pricing Tier</span></li>
<li>Use the <span class="packt_screen">Location</span> near your service to avoid network-latency issues</li>
<li>Leave the access policy and the <span class="packt_screen">Virtual Network Access</span> defaults for now:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/c352eb16-6bed-43e7-8377-4074ea134e21.png" style="width:18.75em;height:32.58em;" width="467" height="812"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Key Vault properties</div>
<ol start="3">
<li>Generate the key using the <span class="packt_screen">Generate/Import</span> option:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/c0963dae-1e9e-4b6e-bb17-e10aa3655aee.png" style="width:42.83em;height:15.83em;" width="1335" height="493"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Key creation process</div>
<ol start="4">
<li>Use the following options:
<ul>
<li><span class="packt_screen">Key Type RSA-HSM</span> with a key size of <span class="packt_screen">2048</span> bit</li>
<li>Copy the <span class="packt_screen">Key Identifier</span> to a notepad for later:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/684f2f09-db3c-44a7-a284-b47eb8d2b0e1.png" style="width:39.00em;height:41.17em;" width="721" height="762"/><br/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Key properties</div>
<ol start="5">
<li>Add the <span class="packt_screen">Microsoft Rights Management Services</span> principal to your access policy:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4db5ecbe-4627-429e-9f87-db3c50828dba.png" style="width:43.75em;height:31.42em;" width="774" height="556"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Service Principal assignment</div>
<ol start="6">
<li>Assign the following minimal permissions:
<ul>
<li><span class="packt_screen">Key Management Operations</span>: <span class="packt_screen">Get</span> and <span class="packt_screen">List</span></li>
<li><span class="packt_screen">Cryptographic Operations</span>: <span class="packt_screen">Decrypt</span> and <span class="packt_screen">Sign</span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/e20b30bf-7940-4c3a-b531-9b3171c1b539.png" style="width:20.75em;height:32.08em;" width="356" height="550"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Permission assignment</div>
<ol start="7">
<li>Optionally, you can limit the access to your vault by using a new feature set—a firewall in front:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f10df736-5afd-4ec9-8f55-f184db6ade95.png" width="1273" height="564"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Key Vault firewall options</div>
<ol start="8">
<li>Configure the <kbd>Azure RMS</kbd> service to use our freshly-created key:</li>
</ol>
<pre style="padding-left: 90px"><strong># Connecting to Azure RMS with global administrator rights</strong><br/><strong>Connect-AadrmService</strong><br/><br/><strong># Configure Azure RMS to use the key from our key vault</strong><br/><strong>Use-AadrmKeyVaultKey -KeyVaultKeyUrl "&lt;Your Key Identifier from the notepad&gt;" -FriendlyName FirstBYOKKey -Verbose</strong></pre>
<p style="padding-left: 60px">The output of the preceding command will look as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/76d1a0b0-b8bf-4aaf-a2b6-5b43cc1b0c7b.png" width="1904" height="220"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Change key usage to the newly created one</div>
<p style="padding-left: 60px">Set the key to the <kbd>Active</kbd> state:</p>
<pre style="padding-left: 90px" class="mce-root"><strong># View the new key with the "Archived state"</strong><br/><strong>Get-AadrmKeys</strong><br/><br/><strong># Next we set the key to the "Active" state</strong><br/><strong>Set-AAdrmKeyProperties -KeyIdentifier "&lt;Your Key Identifier&gt;" -Active $true</strong></pre>
<p class="mce-root"/>
<p style="padding-left: 60px"><span>The output of the preceding command will look as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d6cc9724-e938-4e0e-b719-9df5abd1b922.png" width="1245" height="199"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Activating the key</div>
<ol start="9">
<li>Your Azure Key Vault stored key is in use:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d26a3710-65c4-4f57-b045-a2a3a21a25ba.png" width="1925" height="497"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Actual used keys overview</div>
<ol start="10">
<li>You can change back to the <kbd>Microsoft-managed key</kbd> with the following command:</li>
</ol>
<pre style="padding-left: 90px"><strong># Next we set the Microsoft-managed key to the "Active" state</strong><br/><strong>Set-AAdrmKeyProperties -KeyIdentifier "&lt;Your Microsoft-managed Key Identifier&gt;" -Active $true</strong></pre>
<p>Now that we know about HSMs, Azure Key Vault, and how to configure a BYOK deployment, we'll jump into the HYOK deployment model in the next section.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Hold your own key</h1>
                </header>
            
            <article>
                
<p>HYOK uses an isolated on-premises AD RMS instance that provides the RMS templates based on the second different private key that's driven by an AIP label. This deployment model should be chosen for high security and compliance requirements.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Most of the time, this us used for data that can't be stored on a public cloud. This sensitive data needs to be stored and protected on-premises. Keep in mind that HYOK-protected data is typically between 3 to 5% of an organization's protected data. The following diagram shows the deployment model:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ff76c651-8232-49a3-b1a5-ff21edc231f4.png" style="width:50.25em;height:38.25em;" width="799" height="608"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Hold your own key model</div>
<p>The following limitations/benefits are available by design:</p>
<ul>
<li>External sharing configuration isn't available through the <span class="packt_screen">Azure Information Protection</span> service</li>
<li>External sharing is only possible in a controlled manner with known and named partners</li>
<li>Office 365 services cannot provide indexing or search capabilities; Exchange Online transport rules and Office 365 DLP can't decrypt the content and inspect it</li>
<li>Sharing and the access logs aren't disclosed to anyone</li>
<li>Data remains encrypted always, inaccessible even to Microsoft services</li>
</ul>
<p>To use the on-premises AD RMS infrastructure in your AIP labels, you need to choose the <span class="packt_screen">HYOK (AD RMS)</span> option in the protection options. You can choose between two options:</p>
<ul>
<li><span class="packt_screen">Set AD RMS template details</span> (template GUID and licensing URL)</li>
<li><span class="packt_screen">Set user-defined permissions (Preview)</span></li>
</ul>
<p>The following screenshot shows the template-based approach:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/366df71f-23dc-4b35-8651-3d10ecda6d0f.png" style="width:42.00em;height:31.83em;" width="720" height="546"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">HYOK template configuration in a label</div>
<p>To configure the HYOK deployment in your demo environment, we'll need to add an additional virtual machine to your existing domain to install and configure AD RMS.</p>
<p class="mce-root"/>
<div class="packt_quote packt_tip"><span class="packt_screen">Keep in mind that the following configuration is just for proof-of-concept or demo purposes</span>:
<ul>
<li>For production environments, we recommend that you use a SQL Server for AD RMS</li>
<li>Use the identity federation option to support external sharing if needed</li>
<li>Use a dedicated administrative account</li>
<li>Publish the service endpoints through a firewall or reverse proxy</li>
</ul>
</div>
<p>With the following steps, we start the configuration of a local AD RMS infrastructure:</p>
<ol>
<li>Create a Windows Server 2016/2019 Server virtual machine like the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4be0d6b5-c129-4bee-89b3-60acca7e23bf.png" width="1039" height="530"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">VM creation to hold the AD RMS service</div>
<ol start="2">
<li>Create a CNAME entry in your public DNS configuration—in our example, this is it's <kbd>rms.inovitdemos.ch CNAME inodemosrms01.westeurope.cloudapp.azure.com</kbd>.</li>
</ol>
<p class="mce-root"/>
<ol start="3">
<li>Open the virtual machine directly for <span class="packt_screen">HTTPS</span> (PoC/Demo):</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0eb7cb33-87a7-4a07-a596-8dba8c84036a.png" width="1561" height="275"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Firewall configuration to accept HTTPS traffic on the VM</div>
<ol start="4">
<li>You need a public SSL certificate at least with the RMS cluster URL included:
<ul>
<li>We use a wildcard certificate—<kbd>*.inovitdemos.ch</kbd></li>
</ul>
</li>
</ol>
<div class="packt_quote packt_tip">Be sure that you join your virtual machine to your domain and install the certificate into the local machine store! For demo purposes, you can also run with an HTTP configuration.</div>
<ol start="5">
<li>Prepare the Active Directory objects as a domain administrator on the domain controller for the configuration.</li>
<li class="mce-root">Create the RMS cluster service account:</li>
</ol>
<pre style="padding-left: 90px"><strong>New-ADUser -Name "svcrmscluster" -SamAccountName svcrmscluster -UserPrincipalName svcrmscluster@inovitdemos.ch -path "OU=Users,OU=AIP,OU=Managed Service Objects,DC=inovitdemos,DC=ch" -AccountPassword (ConvertTo-SecureString "MIA@me1976ch" -AsPlainText -Force) -EmailAddress "svcrmscluster@inovitdemos.ch" -Enabled $True</strong></pre>
<ol start="7">
<li>Create the RMS superusers group and apply an email address to recover protected data:</li>
</ol>
<pre style="padding-left: 90px"><strong>New-ADGroup -Name "AIP RMS Super Users" -SamAccountName "AIP RMS Super Users" -GroupCategory Security -GroupScope Global -DisplayName "AIP RMS Super Users" -Path "OU=Groups,OU=AIP,OU=Managed Service Objects,DC=inovitdemos,DC=ch" -Description "AIP RMS Super Users"</strong></pre>
<ol start="8">
<li>Create a test group such as <kbd>Executives</kbd>, for the RMS template and configure an email address—fill in the group with the users you want to test:</li>
</ol>
<pre style="padding-left: 90px">New-ADGroup -Name "Executives" -SamAccountName "Executives" -GroupCategory Security -GroupScope Global -DisplayName "Executives" -Path "OU=Groups,OU=Managed Business Objects,DC=inovitdemos,DC=ch" -Description "Executives"</pre>
<ol start="9">
<li>Create an internal DNS entry for your RMS endpoints:</li>
</ol>
<pre style="padding-left: 90px"><strong>Add-DnsServerResourceRecord -ZoneName "inovitdemos.ch" -A -Name "rms" -IPv4Address "10.0.0.11"</strong></pre>
<ol start="10">
<li>Log in as a domain administrator to the new server that's hosting the AD RMS server.</li>
<li>Open the server manager and add the <span class="packt_screen">Active Directory Rights Management Services</span>:
<ul>
<li>Click <span class="packt_screen">Add Features</span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/edc065c6-2efb-451c-85b6-6b674f69e576.png" width="972" height="557"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">AD RMS role installation</div>
<p class="mce-root"/>
<ol start="12">
<li>Leave all the defaults as is and click <span class="packt_screen">Next</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d8021a23-bbd9-4812-a20e-13771e6ff174.png" width="783" height="557"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Role service installation</div>
<ol start="13">
<li>Configure AD RMS by clicking <span class="packt_screen">Next</span> on the welcome screen.</li>
<li>Create the RMS cluster ("cluster" is a specific term in AD RMS that indicates that you can have more than one RMS server—it doesn't mean a Windows Server cluster):</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ec0277ca-ba87-4457-99ae-75fe4eedcf05.png" width="759" height="557"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">RMS cluster creation process</div>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="15">
<li>Choose the database deployment—for production environments, use a dedicated SQL server:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/25547208-8dec-4746-90ad-981c0e887b96.png" width="757" height="555"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Database configuration for the AD RMS cluster</div>
<ol start="16">
<li>Configure the service account we created previously, that is, <kbd>svcrmscluster@inovitdemos.ch</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/38bfb0f8-6cf7-4255-987f-b418bebcb330.png" width="761" height="557"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Service account usage for AD RMS</div>
<ol start="17">
<li>Configure the following options, as follows:
<ul>
<li><span class="packt_screen">Cryptographic Mode</span>: Mode 2</li>
<li><span class="packt_screen">Cluster Key Storage</span>: Use AD RMS</li>
<li><span class="packt_screen">Cluster Key Password</span>: Choose your cluster key word like <kbd>455A#aasdd+!</kbd></li>
<li><span class="packt_screen">Cluster Web Site</span>: Use the default website</li>
</ul>
</li>
</ol>
<p class="mce-root"/>
<ol start="18">
<li>Configure the cluster address:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/06306972-cb8c-40e4-af96-f1286e2353e4.png" width="759" height="558"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">AD RMS Cluster address configuration</div>
<div class="packt_tip">If you don't want to use HTTPS, change to HTTP for PoC/Demo purposes.</div>
<ol start="19">
<li>Choose your certificate if you configured HTTPS in the previous step.</li>
</ol>
<ol start="20">
<li>Give your Licensor Certificate a name. We recommend using the organization name, such as <kbd>INOVITDEMOS</kbd>.</li>
<li>Don't register the SCP. I<span>f you're already on an existing infrastructure, you must change the option to not use an SCP.</span></li>
<li>We've almost finished the configuration of our AD RMS instance. We need to log out and log in again to complete the configuration:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9d418f1a-406f-49d7-9d40-6172c2cb2fe9.png" width="759" height="555"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">AD RMS Installation result overview</div>
<ol start="23">
<li>Configure the last options by opening the AD RMS management console.</li>
<li>Open <span class="packt_screen">Properties</span> and configure the <span class="packt_screen">Extranet URLs</span>, like the <span class="packt_screen">Intranet URLs</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/764dc3ab-bf1d-4823-87c9-315f22d9bc5b.png" style="width:32.75em;height:39.08em;" width="418" height="499"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring AD RMS Extranet URLs</div>
<p class="mce-root"/>
<ol start="25">
<li>Configure the AD RMS <span class="packt_screen">Super User Group</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/56941b59-7fb1-4e6c-9bb6-e20d96e8348c.png" style="width:34.00em;height:39.08em;" width="418" height="481"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Providing the AD RMS Super User group</div>
<p class="mce-root"/>
<ol start="26">
<li>Open the registry editor to set the <span class="packt_screen">GICURL REG_SZ</span> entry—<kbd>http or https rms cluster name /_wmcs/certification/certification.asmx</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/04f1ada6-a04a-42dd-82ab-42aba642e96b.png" width="1372" height="257"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Setting the HYOK registry keys</div>
<ol start="27">
<li>Configure the RMS Template for HYOK:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3c698b72-f1af-4807-9494-11c9c9a1f0a9.png" width="683" height="410"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">HYOK RMS template settings</div>
<ol start="28">
<li>Define some example rights and the group you created previously to test its functionality:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/da75aade-9e73-4295-9e82-c2b7e47b5645.png" width="685" height="540"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Assignment of the executive's group</div>
<ol start="29">
<li>Finish the configuration and open a PowerShell to gather the related information so that you can configure the Azure Information Protection label.</li>
</ol>
<ol start="30">
<li>Run the following commands to get the RMS template GUID:</li>
</ol>
<pre style="padding-left: 90px"><strong>Import-Module AdRmsAdmin</strong><br/><strong>New-PSDrive -Name AdrmsCluster -PSProvider AdRmsAdmin -Root https://localhost</strong><br/><strong>Get-ChildItem -Path AdRmsCluster:\RightsPolicyTemplate</strong></pre>
<ol start="31">
<li>Log into <a href="https://portal.azure.com">https://portal.azure.com</a> to configure a new sub-label to test the HYOK configuration—add a new sub-label under <span class="packt_screen">Highly Confidential</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/233bb822-fa4f-48ac-b258-304f2ff1602b.png" width="1023" height="622"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">AIP Global Policy overview</div>
<ol start="32">
<li>Configure the label so:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/788bb88f-b896-4c00-9a6d-25b5a606712d.png" style="width:43.00em;height:32.58em;" width="720" height="546"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring the HYOK label</div>
<ol start="33">
<li>Enable the new sub-label for the global policy, which the test users will be able to choose:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/cbad3039-14b8-48b6-808d-ffda148a6f71.png" style="width:29.25em;height:41.42em;" width="519" height="735"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Adding the label to the global policy</div>
<ol start="34">
<li>Open one of the Azure-Information-Protection-enabled internal domain-joined test clients from <a href="bf7343f1-51f5-4e33-a9a6-e6e682e58071.xhtml"/><a href="bf7343f1-51f5-4e33-a9a6-e6e682e58071.xhtml">Chapter 13</a>, <em><span>Identifying and Detecting Sensitive Data</span></em>.</li>
</ol>
<ol start="35">
<li>Create a new document and choose the <span class="packt_screen">HYOK</span> label. Save the document and you should get the following message the first time you use the new label:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/754a42a5-c62f-4729-9edc-f3a0174d708a.png" style="width:44.67em;height:23.25em;" width="596" height="310"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">First-time use message for the local RMS template</div>
<ol start="36">
<li>The document should be protected with the HYOK RMS template permissions:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/bc14993e-71a9-4ac5-b567-73366ad96c21.png" style="width:29.75em;height:6.42em;" width="411" height="89"/></p>
<div class="mce-root packt_figref CDPAlignCenter CDPAlign">HYOK protected document</div>
<p>You've successfully implemented an HYOK deployment in your test environment. Now that we've had a complete walk-through for all three deployment methods, we'll take a closer look at the Azure RMS functionality itself.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How Azure RMS works under the hood</h1>
                </header>
            
            <article>
                
<p>It's quite important to how RMS works it delivers the data protection service of the complete Azure Information Protection solution. First of all, the protected data will never be transferred to the Azure Information Protection or Rights Management service itself. Basically, the data is encrypted at the application level and includes a policy that defines who is authorized and which usage rights are applied for these users. Keep in mind that group memberships are cached for three hours. So, if you change permissions, remember this to avoid misinterpreted results. To get a better understanding of the three typical flows, let's explore the flows in this section. But first, we'll look at the algorithms and key lengths used by Azure RMS.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Algorithms and key lengths</h1>
                </header>
            
            <article>
                
<p>Azure RMS uses the following cryptographic controls in the different usage scenarios. The following table gives you the needed information if you get asked in a project or workshop:</p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong>Cryptographic controls</strong></td>
<td><strong>Azure RMS usage</strong></td>
</tr>
<tr>
<td><strong>Algorithm</strong>: AES <strong>Key length</strong>: 128/256 bits</td>
<td>
<p>Documentation protection</p>
<p><strong>Used by</strong>:</p>
<ul>
<li>Azure Information Protection client</li>
<li>Rights Management sharing application</li>
</ul>
</td>
</tr>
<tr>
<td>
<p><span><strong>Algorithm</strong></span>: R<span>SA</span></p>
<p><strong>Key length</strong>: 2,048 bits/*1,024 bits</p>
<p> </p>
</td>
<td>
<p>Key protection</p>
<ul>
<li>Migration from AD RMS running Cryptographic Mode 1</li>
<li>Migration with AD RMS and Exchange Online usage</li>
<li>Archived keys (on-premises) before the migration</li>
<li>BYOK supports 1024/2048 bits - recommended: 2,048 bits</li>
</ul>
</td>
</tr>
<tr>
<td>SHA-256</td>
<td>Certificate-signing</td>
</tr>
</tbody>
</table>
<p> </p>
<p>Now that we have a clear picture of the cryptographic controls, we can go further into the first use flow, or user environment-initialization.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">User environment-initialization flow</h1>
                </header>
            
            <article>
                
<p>The user environment-initialization is also called the bootstrapping process. The process starts when the Azure Information Protection client is installed on the client and a user opens an Office application, for example. It runs if a user consumes protected content or protects a newly-created document.</p>
<p>Keep in mind that if the user moves to another machine or another user uses the same machine, the process always runs the first time it's used.</p>
<p>During this process, many things happen in the background, and if the user is provided by Single-Sign-On in a federated environment, they don't recognize the steps overall. After a successful authentication to the RMS service, the three main certificates will be received:</p>
<ul>
<li>The <span class="packt_screen">Security Processor Certificat</span><span class="packt_screen">e</span> (<span class="packt_screen">SPC</span>)</li>
<li>The <span class="packt_screen">Client Licensor Certificate</span> (<span class="packt_screen">CLC</span>)</li>
<li>The <span class="packt_screen">Rights Account Certificate</span> (<strong><span class="packt_screen">RAC</span></strong>), formerly known as <span class="packt_screen">Group Identity Certificate</span> (<span class="packt_screen">GIC</span>)</li>
</ul>
<p>These are all valid for 31 days and authenticate the user to the Azure Active Directory.</p>
<p>Also, the Rights Management templates from the organization will be received.</p>
<p>The following diagram shows the main components during this process:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/41f1e112-fb62-472b-8600-81588cdf84d7.png" width="1021" height="533"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Main components and actors on the bootstrapping process</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Many other things happen during this process. If you need more details about the bootstrap process, you can find them at <a href="https://bit.ly/2FbcxNt">https://bit.ly/2FbcxNt</a> and <a href="https://bit.ly/2RxtcRR">https://bit.ly/2RxtcRR</a>.</p>
<p>Here are some other helpful sources:</p>
<ul>
<li><strong>AIP Client Admin Guide</strong>: <a href="https://bit.ly/2Txpoxr">https://bit.ly/2Txpoxr</a></li>
<li><strong><em>Th</em>e Evolution of AD RMS to Azure Information Protection Part 6 by Matt Felton</strong>: <a href="https://bit.ly/2AwGR1Q">https://bit.ly/2AwGR1Q</a></li>
<li><strong>Logging and analyzing usage</strong>:<a href="https://bit.ly/2RdJ3Wf"> https://bit.ly/2RdJ3Wf</a></li>
</ul>
<p>Next, we'll look into the content-protection flow.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Content-protection flow</h1>
                </header>
            
            <article>
                
<p>The next is the content-protection flow, which is that happens if a user protects a document or email. The RMS client creates a random content key and encrypts the document using an AES symmetric-encryption algorithm. The flow is shown in full in the following diagram. Let's highlight just a few points:</p>
<ul>
<li>The main attribute to identify users or groups is the <kbd>ProxyAddresses</kbd> attribute; always keep old email addresses to be able to use older protected content</li>
<li>If the <kbd>ProxyAddresses</kbd> are empty, <kbd>UserPrincipalName</kbd> will be used instead</li>
<li>The RMS client uses the organization's key to encrypt the policy and the content key</li>
<li>The RMS client signs the policy with the user's certificate</li>
<li>The protection level stays always with the content</li>
</ul>
<p class="mce-root"/>
<p>In the following diagram, you can see the content-protection flow:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4e9d2804-7323-4934-8e21-8a6c840b9e7d.png" width="1049" height="753"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Content-protection flow</span></div>
<p>Next, we will jump into the content-consumption flow.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Content-consumption flow</h1>
                </header>
            
            <article>
                
<p>Content consumption happens if a user tries to open an RMS-protected document or email. The process always starts by requesting access to the Azure Rights Management service. Let's highlight the most important points:</p>
<ul>
<li>The authenticated user sends the document policy and the user's certificates to the Azure Rights Management service</li>
<li>The policy will be decrypted and evaluated by the service</li>
</ul>
<p class="mce-root"/>
<ul>
<li>The service builds the rights for every user identification through the <kbd>ProxyAddresses</kbd> or <kbd>UserPrincipalName</kbd> attribute</li>
<li>The content key gets extracted from the decrypted policy; the key will be encrypted with the user's public key</li>
<li>The encrypted use license contains the re-encrypted content key</li>
<li>The RMS client decrypts the encrypted use license with its own private key</li>
<li>The RMS client decrypts the documents body and the rights list will be enforced by the application</li>
</ul>
<p>The following view shows the content-consumption flow:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5e60023f-96e8-486e-984d-850718e7fc5d.png" width="1019" height="731"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Content-consumption flow</span></div>
<p>With this flow, we've finished our journey through the Azure RMS flows. Well done!</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you received all the necessary information to map your requirements to the correct key-deployment model. We looked at the pros and cons of using HYOK. With the provided configuration examples, we gathered practical experience, which you can now share or use in your next project or workshop. We learned about the main Azure RMS flows, which are helpful in understanding how Azure RMS works under the hood. You can use this knowledge to support deployments or troubleshoot common issues because many errors happen on the environment-initialization (bootstrapping) process or in the deployment.</p>
<p>In the next chapter, we'll finish configuring the example Azure Information Protection solution, and then you'll be fully prepared for your journey with this nice technology.</p>


            </article>

            
        </section>
    </div>



  </body></html>