<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;4.&#xA0;Neutron &#x2013; OpenStack Networking" id="1DOR01-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04" class="calibre1"/>Chapter 4. Neutron – OpenStack Networking</h1></div></div></div><p class="calibre10">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Introduction to OpenStack networking</li><li class="listitem">Managing networks, subnets, and ports</li><li class="listitem">Creating provider networks</li><li class="listitem">Creating tenant networks</li><li class="listitem">Creating ports</li><li class="listitem">Updating network attributes</li><li class="listitem">Deleting ports</li><li class="listitem">Deleting networks</li><li class="listitem">Managing routers and floating IPs</li><li class="listitem">Attaching networks to routers</li><li class="listitem">Creating and assigning floating IPs</li><li class="listitem">Deleting routers</li><li class="listitem">Managing security groups</li><li class="listitem">Managing load balancers</li></ul></div></div>

<div class="book" title="Chapter&#xA0;4.&#xA0;Neutron &#x2013; OpenStack Networking" id="1DOR01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Introduction to OpenStack networking"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch04lvl1sec45" class="calibre1"/>Introduction to OpenStack networking</h1></div></div></div><p class="calibre10">Networking in <a id="id193" class="calibre1"/>OpenStack is provided by a project that goes by the name of Neutron. Neutron is an API-driven system that manages physical and virtual networking resources in an OpenStack cloud. Operators and users can leverage the Neutron API to build rich network architectures that best suit the requirements of their applications.</p><p class="calibre10">Neutron utilizes a pluggable and extensible architecture that allows developers to write robust drivers that implement and configure virtual and physical network resources, including switches, routers, firewalls, and load balancers. Neutron is composed of an API server and various agents that are responsible for implementing the virtual network architected by users. The following diagram demonstrates how the Neutron API server interacts with various plugins and agents to construct networking in the cloud:</p><div class="mediaobject"><img src="../images/00036.jpeg" alt="Introduction to OpenStack networking" class="calibre16"/><div class="caption"><p class="calibre21">Figure 4.1</p></div></div><p class="calibre17"> </p><p class="calibre10">The figure <a id="id194" class="calibre1"/>demonstrates the interaction between the Neutron API service, Neutron plugins and drivers, and services such as L2 and L3 agents in a stock OpenStack-based cloud. As network actions are performed via the API or agents, Neutron publishes messages to a queue that are consumed and implemented by the agents.</p><p class="calibre10">This chapter will cover many common networking-related tasks, but will not go far into the details of any given topic. For an introduction to the fundamentals of Neutron networking, refer to <span class="strong"><em class="calibre18">OpenStack Networking Essentials</em></span>, <span class="strong"><em class="calibre18">Packt Publishing</em></span>, 2016. For a more in-depth look at Neutron features, including the core functionality of switching and routing, load balancing, VPN, and more, refer to <span class="strong"><em class="calibre18">Learning OpenStack Networking, Second Edition</em></span>, <span class="strong"><em class="calibre18">Packt Publishing</em></span>, 2015.</p></div></div>
<div class="book" title="Managing networks, subnets, and ports" id="1ENBI1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec46" class="calibre1"/>Managing networks, subnets, and ports</h1></div></div></div><p class="calibre10">Networks, subnets, and ports make up the foundation of Neutron's logical network architecture. A network describes a layer 2 segment, and is typically used to define a boundary <a id="id195" class="calibre1"/>such as a VLAN. A subnet is an IPv4 or IPv6 address block that is associated with the network. Networks can be <a id="id196" class="calibre1"/>associated with one or more subnets. Lastly, a port represents a switch port on a logical switch that spans the entire cloud. A port <a id="id197" class="calibre1"/>object contains information about the device it is associated with, including its MAC addresses, IP addresses, and device ID. A device could be a virtual machine instance interface, a virtual router interface, or some other device that will be connected to the virtual network.</p><p class="calibre10">Network <a id="id198" class="calibre1"/>objects in OpenStack have many attributes that describe how that network connects the physical and virtual infrastructures. The following table describes a few of these details:</p><div class="informalexample"><table border="1" class="blockquote1"><colgroup class="calibre25"><col class="calibre26"/><col class="calibre26"/></colgroup><thead class="calibre27"><tr class="calibre28"><th valign="bottom" class="calibre29">
<p class="calibre13">
<code class="literal">Attribute</code>
</p>
</th><th valign="bottom" class="calibre29">
<p class="calibre13">
<code class="literal">Description</code>
</p>
</th></tr></thead><tbody class="calibre30"><tr class="calibre28"><td valign="top" class="calibre12">
<p class="calibre13">
<code class="literal">provider:physical_network</code>
</p>
</td><td valign="top" class="calibre12">
<p class="calibre13">This describes the physical interface used for this network. The label here is an alias for interfaces such as <code class="literal">eth0</code> and <code class="literal">bond1</code>. The alias is referred to as a <span><strong class="calibre31">provider label</strong></span> and is configured in the respective plugin and agent configuration files. This is used primarily by the <code class="literal">flat</code> and <code class="literal">vlan</code> type networks.</p>
</td></tr><tr class="calibre28"><td valign="top" class="calibre12">
<p class="calibre13">
<code class="literal">provider:segmentation_id</code>
</p>
</td><td valign="top" class="calibre12">
<p class="calibre13">This describes the segment ID, such as VLAN ID or VXLAN VNI. It may not be used for all network types.</p>
</td></tr><tr class="calibre28"><td valign="top" class="calibre12">
<p class="calibre13">
<code class="literal">provider:network_type</code>
</p>
</td><td valign="top" class="calibre12">
<p class="calibre13">This describes the network type, such as Flat, VLAN, VXLAN, and GRE.</p>
</td></tr><tr class="calibre28"><td valign="top" class="calibre12">
<p class="calibre13">
<code class="literal">router:external</code>
</p>
</td><td valign="top" class="calibre12">
<p class="calibre13">Boolean (true or false) is used to determine if the network is eligible for use as a floating IP pool.</p>
</td></tr></tbody></table></div><p class="calibre10">The role of the user creating a network determines which attributes can be specified by that user at network creation. An administrative user can specify details such as the physical network or segmentation ID when creating a network. Regular users must rely on Neutron to automatically provision the network based on details set in Neutron configuration files, including a pool of segmentation IDs per physical network from which to choose from. Networks that are created specifically to connect virtual devices to the physical network infrastructure are often referred to as <span class="strong"><strong class="calibre2">provider networks</strong></span>, since their <a id="id199" class="calibre1"/>attributes are deliberately set based on the environment or data center in which they reside. Provider networks are typically <a id="id200" class="calibre1"/>shared across projects or tenants and often provide connectivity to upstream devices that can facilitate routing in and out <a id="id201" class="calibre1"/>of the environment. Networks that are created by regular users are referred to as <span class="strong"><strong class="calibre2">tenant networks</strong></span>, and are typically only used <a id="id202" class="calibre1"/>by the project or tenant that created them. In most cases, tenant networks must be connected to virtual routers, which are in turn connected to provider <a id="id203" class="calibre1"/>networks, and can provide connectivity in and out of connected tenant networks. In the following sections, we will look at common tasks involving those resources.</p></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating provider networks"><div class="book" id="1FLS42-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec47" class="calibre1"/>Creating provider networks</h1></div></div></div><p class="calibre10">When creating <a id="id204" class="calibre1"/>a provider network in OpenStack, one must provide attributes that describe how the network is connected to the physical infrastructure. These attributes include the network type, network interface used by the server, and the segmentation ID of the network. Typically, provider networks are only created and managed by users with administrator-level permissions. Provider networks can be shared or private, and they can also be used as floating IP networks when connected to Neutron routers when the network's <code class="email">router:external</code> attribute has been set to <code class="email">True</code>.</p></div>

<div class="book" title="Creating provider networks">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec102" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When creating a provider network, you must be authenticated as an administrator. You will need the following details, at a minimum, for the network:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name</li><li class="listitem">Provider label</li><li class="listitem">Network type</li><li class="listitem">Segmentation ID</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name: <code class="email">COOKBOOK_PROVIDER_NET</code></li><li class="listitem">Provider label: <code class="email">vlan</code></li><li class="listitem">Network type: <code class="email">vlan</code></li><li class="listitem">Segmentation ID: <code class="email">200</code></li></ul></div><p class="calibre10">You will need the following details, at a minimum, for the corresponding subnet:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Subnet name</li><li class="listitem">Network name or ID</li><li class="listitem">Subnet range (CIDR)</li></ul></div><p class="calibre10">For our <a id="id205" class="calibre1"/>example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Subnet name: <code class="email">COOKBOOK_PROVIDER_SUBNET</code></li><li class="listitem">Network name or ID: <code class="email">COOKBOOK_PROVIDER_NET</code></li><li class="listitem">Subnet range (CIDR): <code class="email">192.168.200.0/24</code></li></ul></div></div></div>

<div class="book" title="Creating provider networks">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec103" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to create a provider network with the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create the network:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network create COOKBOOK_PROVIDER_NET \</strong></span>
<span class="strong"><strong class="calibre2">--provider-network-type vlan \</strong></span>
<span class="strong"><strong class="calibre2">--provider-physical-network vlan \</strong></span>
<span class="strong"><strong class="calibre2">--provider-segment 200</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00037.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Create <a id="id206" class="calibre1"/>the subnet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack subnet create COOKBOOK_PROVIDER_SUBNET \</strong></span>
<span class="strong"><strong class="calibre2">--network COOKBOOK_PROVIDER_NET \</strong></span>
<span class="strong"><strong class="calibre2">--subnet-range 192.168.200.0/24</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00038.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Creating provider networks">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec104" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Provider <a id="id207" class="calibre1"/>networks are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network create NETWORK_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--provider-network-type NETWORK_TYPE \</strong></span>
<span class="strong"><strong class="calibre2">--provider-physical-network PROVIDER_LABEL \</strong></span>
<span class="strong"><strong class="calibre2">--provider-segment SEGMENTATION_ID \</strong></span>
<span class="strong"><strong class="calibre2">[--external | --internal]</strong></span>
</pre></div><p class="calibre10">Creating a network creates a logical layer 2 segment, whose details are used to construct virtual network connections within the Cloud that connect virtual machines and other virtual network objects to the physical infrastructure.</p><p class="calibre10">The <code class="email">provider-network-type</code> parameter defines the type of network. Options include <code class="email">vlan</code>, <code class="email">vxlan</code>, <code class="email">gre</code>, <code class="email">flat</code>, <code class="email">geneve</code>, and <code class="email">local</code>, and these must be supported by the configured network driver.</p><p class="calibre10">The <code class="email">provider-physical-network</code> parameter defines the interface used for the network. In <a id="id208" class="calibre1"/>Neutron, interfaces are not referenced directly, but are mapped to a <span class="strong"><strong class="calibre2">provider label</strong></span>. In an OpenStack-Ansible deployment, the default provider label is <code class="email">vlan</code> and maps to a physical interface such as <code class="email">bond1</code> or <code class="email">eth1</code>.</p><p class="calibre10">The <code class="email">provider-segment</code> parameter defines the layer 2 segmentation ID used by the network. For the <code class="email">vlan</code> network types, the segmentation ID is VLAN ID. For the <code class="email">vxlan</code> network types, the segmentation ID is VXLAN VNI. Segmentation IDs may not be used by <a id="id209" class="calibre1"/>all network types, and if not specified, may be automatically assigned by Neutron if required.</p><p class="calibre10">When specified, the <code class="email">--external</code> option qualifies a network as a gateway network for a router. The network will serve as a floating IP network for attached instances. Networks are considered <span class="strong"><em class="calibre18">internal</em></span> by default.</p><p class="calibre10">There are other optional network parameters that can be discovered using the <code class="email">--help</code> flag shown here:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network create --help</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip19" class="calibre1"/>Tip</h3><p class="calibre10">The <code class="email">--help</code> flag can be appended to most commands within the OpenStack command-line utility, and will be helpful when constructing commands throughout this chapter.</p></div><p class="calibre10">Subnets are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack subnet create SUBNET_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--network NETWORK_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--subnet-range SUBNET_RANGE</strong></span>
</pre></div><p class="calibre10">Creating a subnet creates a logical layer 3 routing domain, whose details are used to provide IP services to virtual machines and other virtual network objects. The <code class="email">network</code> parameter maps the subnet to a layer 2 network defined in OpenStack. The <code class="email">subnet-range</code> parameter defines the L3 address range used by the subnet and is written in CIDR notation. More than one subnet can be associated with a network, which is often the case when all addresses in a particular subnet have been consumed. While logically separated, multiple subnets in a network are all part of the same layer 2 broadcast domain.</p><p class="calibre10">When a <a id="id210" class="calibre1"/>network and subnet are created in OpenStack, and DHCP is enabled, a corresponding network namespace is created on one or more nodes running the DHCP agent. The namespace can be identified using the <code class="email">ip netns</code> command shown as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># ip netns list</strong></span>
<span class="strong"><strong class="calibre2">...</strong></span>
<span class="strong"><strong class="calibre2">qdhcp-c881ce20-1649-4f03-bea7-40da536e21b2</strong></span>
<span class="strong"><strong class="calibre2">...</strong></span>
</pre></div><p class="calibre10">A DHCP namespace has a prefix of <code class="email">qdhcp-</code> and a suffix that corresponds to the network ID.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note09" class="calibre1"/>Note</h3><p class="calibre10">The <code class="email">ip netns</code> command must be run by the <code class="email">root</code> user or a user with <code class="email">sudo</code> permissions.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating tenant networks" id="1GKCM1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec48" class="calibre1"/>Creating tenant networks</h1></div></div></div><p class="calibre10">When a tenant <a id="id211" class="calibre1"/>network is created in OpenStack, provider attributes that describe how the network is connected to the physical infrastructure are automatically determined by Neutron based on settings hard-coded in configuration files. Typically, tenant networks are created and managed by users within a particular project and are not shared with other projects.</p></div>

<div class="book" title="Creating tenant networks" id="1GKCM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec105" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the network:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name</li></ul></div><p class="calibre10">For our example, the following network name will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name: <code class="email">COOKBOOK_TENANT_NET_1</code></li></ul></div><p class="calibre10">You will need the following details, at a minimum, for the corresponding subnet:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Subnet name</li><li class="listitem">Network name or ID</li><li class="listitem">Subnet range (CIDR)</li></ul></div><p class="calibre10">For our <a id="id212" class="calibre1"/>example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Subnet name: <code class="email">COOKBOOK_TENANT_SUBNET_1</code></li><li class="listitem">Network name or ID: <code class="email">COOKBOOK_TENANT_NET_1</code></li><li class="listitem">Subnet range (CIDR): <code class="email">172.16.200.0/24</code></li></ul></div></div></div>

<div class="book" title="Creating tenant networks" id="1GKCM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec106" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the <code class="email">openstack</code> client installed on our system, we are now able to create a tenant network with the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create the network:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network create COOKBOOK_TENANT_NET_1</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00039.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><div class="note" title="Note"><h3 class="title2"><a id="note10" class="calibre1"/>Note</h3><p class="calibre10">As a non-admin user, certain network attributes may not be visible.</p></div></li><li class="listitem" value="2">Create <a id="id213" class="calibre1"/>the subnet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack subnet create COOKBOOK_TENANT_SUBNET_1 \</strong></span>
<span class="strong"><strong class="calibre2">--network COOKBOOK_TENANT_NET_1 \</strong></span>
<span class="strong"><strong class="calibre2">--subnet-range 172.16.200.0/24</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00040.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Creating tenant networks" id="1GKCM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec107" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Tenant <a id="id214" class="calibre1"/>networks are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network create NETWORK_NAME</strong></span>
</pre></div><p class="calibre10">When <a id="id215" class="calibre1"/>created as a non-admin user, a network's provider attributes are automatically determined by Neutron based on settings defined in the respective network plugin configuration files. Tenant networks are associated with the project that created them, and by default, are not visible or usable by other projects.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip20" class="calibre1"/>Tip</h3><p class="calibre10">Neutron <span class="strong"><strong class="calibre2">role-based access control</strong></span> (<span class="strong"><strong class="calibre2">RBAC</strong></span>) can be used to share networks with other projects if desired. More information on using RBAC in the Pike release of OpenStack can be found at the following website:</p><p class="calibre10">
<a class="calibre1" href="https://docs.openstack.org/neutron/pike/admin/config-rbac.html">https://docs.openstack.org/neutron/pike/admin/config-rbac.html</a>
</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating ports" id="1HIT81-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec49" class="calibre1"/>Creating ports</h1></div></div></div><p class="calibre10">Ports in <a id="id216" class="calibre1"/>OpenStack can be created using the <code class="email">openstack port create</code> command. Ports are automatically created by OpenStack upon server creation or can be created and attached to instances at a later time. Users may also create ports as a method of reserving IP addresses for later use or to avoid certain addresses from being allocated by OpenStack at all.</p></div>

<div class="book" title="Creating ports" id="1HIT81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec108" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the port:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name or ID</li><li class="listitem">Port name</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name: <code class="email">COOKBOOK_TENANT_NET_1</code></li><li class="listitem">Port name: <code class="email">COOKBOOK_TEST_PORT_1</code></li></ul></div></div></div>

<div class="book" title="Creating ports" id="1HIT81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec109" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to create a port with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port create COOKBOOK_TEST_PORT_1 \</strong></span>
<span class="strong"><strong class="calibre2">--network COOKBOOK_TENANT_NET_1</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00041.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Creating ports" id="1HIT81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec110" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When a <a id="id217" class="calibre1"/>port is created in OpenStack and associated with an instance or other virtual network device, it is bound to a Neutron agent on the respective node <a id="id218" class="calibre1"/>hosting the instance or device. Using details provided <a id="id219" class="calibre1"/>by the port, OpenStack services may construct a <span class="strong"><strong class="calibre2">virtual machine interface</strong></span> (<span class="strong"><strong class="calibre2">vif</strong></span>) or <span class="strong"><strong class="calibre2">virtual ethernet interface</strong></span> (<span class="strong"><strong class="calibre2">veth</strong></span>) on the host for use with a virtual machine, network namespace, or more depending on the application.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Updating network attributes" id="1IHDQ1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec50" class="calibre1"/>Updating network attributes</h1></div></div></div><p class="calibre10">Network <a id="id220" class="calibre1"/>attributes can be updated using the <code class="email">openstack network set</code> and <code class="email">openstack network unset</code> commands.</p></div>

<div class="book" title="Updating network attributes" id="1IHDQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec111" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When updating a network, ensure that you are authenticated as an administrator or are the owner of the network. You will need the following details:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name or ID</li><li class="listitem">Attribute to update</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name: <code class="email">COOKBOOK_PROVIDER_NET</code></li><li class="listitem">Attribute to update: <code class="email">router:external</code></li></ul></div></div></div>

<div class="book" title="Updating network attributes" id="1IHDQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec112" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to update the network with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network set COOKBOOK_PROVIDER_NET --external</strong></span>
</pre></div><p class="calibre10">No output is returned.</p></div></div>

<div class="book" title="Updating network attributes" id="1IHDQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec113" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Networks are updated with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network set NETWORK \</strong></span>
<span class="strong"><strong class="calibre2">[--share | --no-share] \</strong></span>
<span class="strong"><strong class="calibre2">[--description &lt;description&gt;] \</strong></span>
<span class="strong"><strong class="calibre2">[--external | --internal] </strong></span>

<span class="strong"><strong class="calibre2">openstack network unset [--tag &lt;tag&gt; | --all-tag] NETWORK</strong></span>
</pre></div><p class="calibre10">The <code class="email">share</code> and <code class="email">no-share</code> parameters dictate whether the network can be shared among projects or is limited to the owner of the network.</p><p class="calibre10">The <code class="email">description</code> parameter allows users to provide a useful description of the network.</p><p class="calibre10">When specified, the <code class="email">--external</code> option qualifies a network as a gateway network for a router. The network will serve as a floating IP network for attached instances. Networks are considered <a id="id221" class="calibre1"/>internal by default.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note11" class="calibre1"/>Note</h3><p class="calibre10">Not all network plugins support updating certain network attributes for existing networks. If a change is required, the network may need to be deleted and recreated.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting ports" id="1JFUC1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec51" class="calibre1"/>Deleting ports</h1></div></div></div><p class="calibre10">Ports in <a id="id222" class="calibre1"/>OpenStack can be deleted with the <code class="email">openstack port delete</code> command. OpenStack automatically deletes ports it creates, such as when a server or floating IP is created, but may not delete ports created by users and associated with instances at a later time.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note12" class="calibre1"/>Note</h3><p class="calibre10">Deleting ports associated with active instances may cause the instance to crash or can cause unexpected behavior in the instance.</p></div></div>

<div class="book" title="Deleting ports" id="1JFUC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec114" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When deleting a port, ensure that you are authenticated as an administrator or are the owner of the port. You will need the following details:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Port name or ID</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Port name: COOKBOOK_TEST_PORT_1</li></ul></div></div></div>

<div class="book" title="Deleting ports" id="1JFUC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec115" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to delete a port with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port delete COOKBOOK_TEST_PORT_1</strong></span>
</pre></div><p class="calibre10">No output is returned.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting networks" id="1KEEU1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec52" class="calibre1"/>Deleting networks</h1></div></div></div><p class="calibre10">Deleting a <a id="id223" class="calibre1"/>network in OpenStack is as easy as invoking the <code class="email">openstack network delete</code> command. Neutron will delete any automatically-created ports associated with the network, like the ones created by/for the DHCP or router namespaces, and will return any automatically-assigned segmentation IDs to the respective pool for allocation to another network.</p></div>

<div class="book" title="Deleting networks" id="1KEEU1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec116" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When deleting a network in OpenStack, ensure that all associated user-created ports have been deleted. This may require deleting instances, detaching and deleting ports from instances, or detaching and deleting ports from routers. When deleting a network, the following information will be necessary:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network name or ID</li></ul></div></div></div>

<div class="book" title="Deleting networks" id="1KEEU1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec117" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are able now to delete a network with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network delete COOKBOOK_TENANT_NETWORK_3</strong></span>
</pre></div><p class="calibre10">No output is returned.</p></div></div>

<div class="book" title="Deleting networks" id="1KEEU1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec118" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When invoked, the <code class="email">openstack network delete</code> command will instruct Neutron to delete the specified network and any associated subnet(s), as long as all user-managed ports have been deleted. In a reference architecture, the layer 2 agents are responsible for deleting the respective virtual bridges and interfaces configured on the hosts, and all records of the network are purged from the OpenStack database.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note13" class="calibre1"/>Note</h3><p class="calibre10">Neutron does not maintain network information in the database once those objects have been deleted. Requests against the OpenStack API may be logged, but using third-party tools or proxies is highly recommended if an audit trail is required.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Managing routers and floating IPs"><div class="book" id="1LCVG2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec53" class="calibre1"/>Managing routers and floating IPs</h1></div></div></div><p class="calibre10">A <span class="strong"><strong class="calibre2">router</strong></span> in <a id="id224" class="calibre1"/>OpenStack represents a virtual routing device that provides routing capabilities to directly connected networks. To provide end-to-end connectivity <a id="id225" class="calibre1"/>to a virtual machine, a router must be connected to an external provider network and the tenant network where the instance resides. Typically, routers <a id="id226" class="calibre1"/>are created and managed by individual projects. By default, external provider networks are shared and available for use by all projects. The following diagram represents an external provider network owned by the <code class="email">ADMIN</code> project and utilized by three other projects:</p><div class="mediaobject"><img src="../images/00042.jpeg" alt="Managing routers and floating IPs" class="calibre16"/><div class="caption"><p class="calibre21">Figure 4.2</p></div></div><p class="calibre17"> </p><p class="calibre10">In <span class="strong"><em class="calibre18">Figure 4.2</em></span>, three projects have routers connected to an external provider network. The external provider network not only provides connectivity to the routers and the networks behind <a id="id227" class="calibre1"/>them, but also provides a network from which floating IPs can be derived. Floating IPs provide 1-to-1 address translations that allow external clients <a id="id228" class="calibre1"/>to connect directly to instances.</p></div>

<div class="book" title="Managing routers and floating IPs">
<div class="book" title="Creating routers"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec119" class="calibre1"/>Creating routers</h2></div></div></div><p class="calibre10">Routers in <a id="id229" class="calibre1"/>OpenStack can be created using the <code class="email">openstack router create</code> command. By default, routers are considered <span class="strong"><em class="calibre18">internal</em></span> and can route only <a id="id230" class="calibre1"/>between directly-connected tenant networks. An <span class="strong"><em class="calibre18">external</em></span> router, on the other hand, is capable of routing to an external gateway and can provide <span class="strong"><strong class="calibre2">network address translation</strong></span> (<span class="strong"><strong class="calibre2">NAT</strong></span>) services to connected networks.</p><p class="calibre10">There are <a id="id231" class="calibre1"/>three types of routers that can be created in an OpenStack reference architecture:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Standalone</li><li class="listitem"><span class="strong"><strong class="calibre2">Highly-Available</strong></span> (<span class="strong"><strong class="calibre2">H</strong></span>A)</li><li class="listitem">Distributed (DVR)</li></ul></div><p class="calibre10">Standalone routers do not provide any level of resiliency, while highly available routers implement VRRP to provide redundancy should one or more Neutron nodes fail. Distributed virtual routers reside on compute nodes rather than on centralized network nodes, and provide higher performance than their counterparts for east/west traffic, or traffic between instances in different networks, since that traffic is forwarded between compute nodes without having to traverse a network node.</p><p class="calibre10">For non-admin users, the type of router that is created with the <code class="email">openstack router create</code> command is determined automatically by settings defined in Neutron configuration files. Only users with administrator-level permissions can specify router types when creating routers.</p></div></div>

<div class="book" title="Managing routers and floating IPs">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec120" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the router:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Router name</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Router name: <code class="email">COOKBOOK_ROUTER_STANDALONE</code></li><li class="listitem">Router name: <code class="email">COOKBOOK_ROUTER_HA</code></li><li class="listitem">Router name: <code class="email">COOKBOOK_ROUTER_DVR</code></li></ul></div><p class="calibre10">You will <a id="id232" class="calibre1"/>need the following details, at a minimum, for networks attached to the router:</p><div class="book"><ul class="itemizedlist"><li class="listitem">External provider network name or ID</li><li class="listitem">Tenant subnet name or ID</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">External provider network name: <code class="email">COOKBOOK_PROVIDER_NET</code></li><li class="listitem">Tenant subnet name: <code class="email">COOKBOOK_TENANT_SUBNET</code></li></ul></div></div></div>

<div class="book" title="Managing routers and floating IPs">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec121" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the <code class="email">openstack</code> client installed on our system, we are now able to create a router with the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create the standalone router:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router create COOKBOOK_ROUTER_STANDALONE</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00043.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Create <a id="id233" class="calibre1"/>an HA router:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router create COOKBOOK_ROUTER_HA --ha</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00044.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Create <a id="id234" class="calibre1"/>a distributed router:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router create COOKBOOK_ROUTER_DVR --distributed</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00045.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Managing routers and floating IPs">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec122" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When <span class="strong"><em class="calibre18">any</em></span> router is created in OpenStack using the native routing services, a corresponding network namespace is created on one or more nodes running the <code class="email">neutron-l3-agent</code> service. The namespace can be identified using the <code class="email">ip netns</code> command shown here:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># ip netns list</strong></span>
<span class="strong"><strong class="calibre2">...</strong></span>
<span class="strong"><strong class="calibre2">qrouter-058ea6a3-ca86-46f8-80c8-d63bbc195212</strong></span>
<span class="strong"><strong class="calibre2">...</strong></span>
</pre></div><p class="calibre10">A router <a id="id235" class="calibre1"/>namespace has a prefix of <code class="email">qrouter-</code> and a suffix that corresponds to the router ID. In environments where distributed virtual routers are configured, other namespaces needed to facilitate proper networking may exist, such as the <code class="email">fip-</code> and <code class="email">snat-</code> namespaces.</p><p class="calibre10">By default, a non-admin user cannot specify the type of router being created. The router type is automatically determined by Neutron based on the layer 3 agent configuration file. The author recommends HA or distributed virtual routers, where possible, to limit the impact <a id="id236" class="calibre1"/>of failure for physical nodes hosting virtual routers.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note14" class="calibre1"/>Note</h3><p class="calibre10">Cloud operators can modify Neutron configuration files to change default behaviors. The <code class="email">policy.json</code> file used by the Neutron API service can be modified to allow users and roles to perform actions usually reserved for administrators. Refer to community documentation for guidelines and caveats related to modifications to the <code class="email">policy.json</code> files.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Attaching networks to routers" id="1MBG21-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec54" class="calibre1"/>Attaching networks to routers</h1></div></div></div><p class="calibre10">Routers in <a id="id237" class="calibre1"/>OpenStack can connect to a single external <a id="id238" class="calibre1"/>provider network and one or more tenant networks, as shown in the following diagram:</p><div class="mediaobject"><img src="../images/00046.jpeg" alt="Attaching networks to routers" class="calibre16"/><div class="caption"><p class="calibre21">Figure 4.3</p></div></div><p class="calibre17"> </p><p class="calibre10">In <span class="strong"><em class="calibre18">Figure 4.3</em></span>, an external provider network provides external connectivity, while tenant networks <a id="id239" class="calibre1"/>provide connectivity to virtual machines and <a id="id240" class="calibre1"/>other virtual network devices within a project. The router's job is to facilitate end-to-end connectivity using routes and sometimes the NAT via floating IPs.</p><p class="calibre10">The commands necessary to attach a network to a router may vary based on network and need:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Attaching a router to an external network:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router set --external-gateway &lt;network&gt; &lt;router&gt;</strong></span>
</pre></div></li><li class="listitem">Attaching a router to a tenant network using subnet ID or name:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router add subnet &lt;router&gt; &lt;subnet&gt;</strong></span>
</pre></div></li><li class="listitem">Attaching a router to a tenant network using a specific port ID or name:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router add port &lt;router&gt; &lt;port&gt;</strong></span>
</pre></div></li></ul></div></div>

<div class="book" title="Attaching networks to routers" id="1MBG21-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec123" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When attaching a router to a network, the following information will be necessary:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Router name or ID</li><li class="listitem">Network name or ID, or Subnet name or ID, or Port name or ID</li></ul></div><p class="calibre10">Remember, when attaching a router to an external provider network, the network's <code class="email">router:external</code> attribute must be set to <code class="email">External</code> or <code class="email">True</code>.</p></div></div>

<div class="book" title="Attaching networks to routers" id="1MBG21-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec124" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To attach <a id="id241" class="calibre1"/>a network to a router in OpenStack, follow <a id="id242" class="calibre1"/>these steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Attach the router to the external provider network <code class="email">COOKBOOK_PROVIDER_NET</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router set --external-gateway COOKBOOK_PROVIDER_NET COOKBOOK_ROUTER_STANDALONE</strong></span>
</pre></div><p class="calibre22">No output is provided.</p></li><li class="listitem" value="2">Attach the router to the <code class="email">COOKBOOK_TENANT_SUBNET</code> subnet using the subnet name:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router add subnet COOKBOOK_ROUTER_STANDALONE COOKBOOK_TENANT_SUBNET_1</strong></span>
</pre></div><p class="calibre22">No output is provided.</p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Attaching networks to routers" id="1MBG21-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec125" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When routers are attached to external provider networks, the router is assigned an IP address from the pool of addresses available for allocation from the network. The router is also configured with a default gateway that corresponds to the specified gateway for the respective provider subnet.</p><p class="calibre10">When a <a id="id243" class="calibre1"/>router is attached to a tenant network, the router becomes the gateway for the attached network and all instances within it. It is assigned the IP address specified as the gateway for the respective tenant subnet.</p><p class="calibre10">Ports attached to routers can be listed using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port list --router ROUTER_NAME_OR_ID</strong></span>
</pre></div><p class="calibre10">In this <a id="id244" class="calibre1"/>example, the following ports and corresponding subnets have been attached to the router:</p><div class="mediaobject"><img src="../images/00047.jpeg" alt="How it works..." class="calibre16"/></div><p class="calibre17"> </p><p class="calibre10">Using the <code class="email">ip netns exec</code> command, coupled with the name of the respective router namespace, we can see the router has two attached interfaces, <code class="email">qg-ed006ed1-b8</code> and <code class="email">qr-c69005cb-aa</code>:</p><div class="mediaobject"><img src="../images/00048.jpeg" alt="How it works..." class="calibre16"/></div><p class="calibre17"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note15" class="calibre1"/>Note</h3><p class="calibre10">The names of the interfaces in the router namespace correspond to the first 10 characters of the respective port ID. External, or gateway-side, interfaces are prefixed with <code class="email">qg-</code>, while internal, or router-side, interfaces are prefixed with <code class="email">qr-</code>. The naming scheme dates back to when the Neutron project was known as Quantum.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating and assigning floating IPs" id="1NA0K1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec55" class="calibre1"/>Creating and assigning floating IPs</h1></div></div></div><p class="calibre10">Floating <a id="id245" class="calibre1"/>IPs in OpenStack are static IPv4 addresses that are mapped to instances behind Neutron routers and provide direct inbound connectivity to those <a id="id246" class="calibre1"/>instances. Floating IPs can be used in a similar fashion to Elastic IPs in Amazon Web Services, where users can quickly remap an IP address from one instance to another in the event of failure. The heart of this functionality is network address translation. A floating IP is usually considered an <span class="strong"><em class="calibre18">external</em></span> address that is mapped to the <span class="strong"><em class="calibre18">internal</em></span> address configured on an instance. The NAT is implemented on the Neutron router connected to the instance's network. Floating IPs offer connectivity to instances that would otherwise be isolated behind a Neutron router on a non-routable network.</p></div>

<div class="book" title="Creating and assigning floating IPs" id="1NA0K1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec126" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">Recall that instances are connected to ports that reflect the connected network and associated IP address. When creating a floating IP, the following information is required:</p><div class="book"><ul class="itemizedlist"><li class="listitem">External network name or ID</li></ul></div><p class="calibre10">When assigning a floating IP to a port, the following is necessary:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Floating IP ID</li><li class="listitem">Internal port name or ID</li></ul></div><p class="calibre10">For this example, create a new port in the existing tenant network named <code class="email">COOKBOOK_TEST_PORT_2</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port create COOKBOOK_TEST_PORT_2 \</strong></span>
<span class="strong"><strong class="calibre2">--network COOKBOOK_TENANT_NET_1</strong></span>
</pre></div></div></div>

<div class="book" title="Creating and assigning floating IPs" id="1NA0K1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec127" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To create a floating IP in OpenStack, issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack floating ip create --port COOKBOOK_TEST_PORT_2 COOKBOOK_PROVIDER_NET</strong></span>
</pre></div><p class="calibre10">The <a id="id247" class="calibre1"/>output will resemble the following:</p><div class="mediaobject"><img src="../images/00049.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Creating and assigning floating IPs" id="1NA0K1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec128" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Floating <a id="id248" class="calibre1"/>IPs are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack floating ip create EXTERNAL_NETWORK_NAME_OR_ID \</strong></span>
<span class="strong"><strong class="calibre2">[--port PORT_NAME_OR_ID]</strong></span>
</pre></div><p class="calibre10">Floating IPs can then be associated with a port, using the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack floating ip associate FLOATING_IP_NAME_OR_ID \</strong></span>
<span class="strong"><strong class="calibre2">PORT_NAME_OR_ID</strong></span>
</pre></div><p class="calibre10">When a floating IP is associated with a port, Neutron uses the port information to determine which router to configure the NAT on. Once the NAT is in place, connections to the floating IP will be translated to the internal IP and forwarded to the respective instance. Responses from the instance will be forwarded to the router, translated from the internal to the floating IP, and routed back out to the origin.</p><p class="calibre10">In our example, the instance's port is associated with the <code class="email">COOKBOOK_TENANT_NET</code> network, which in turn is connected to the <code class="email">COOKBOOK_ROUTER_STANDALONE</code> router. Within <a id="id249" class="calibre1"/>the respective <code class="email">qrouter</code> network namespace, we can <a id="id250" class="calibre1"/>see the source and destination NATs applied using <code class="email">iptables</code>:</p><div class="mediaobject"><img src="../images/00050.jpeg" alt="How it works…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting routers" id="1O8H61-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec56" class="calibre1"/>Deleting routers</h1></div></div></div><p class="calibre10">Routers in <a id="id251" class="calibre1"/>OpenStack can be deleted using the <code class="email">openstack router delete</code> command. Before a router can be deleted, all subnets/ports attached to the router must be detached. This will cause a disruption of traffic for any instance connected to a network behind the router. Subnets can be detached using the <code class="email">openstack router remove subnet</code> or <code class="email">openstack router remove port</code> commands.</p></div>

<div class="book" title="Deleting routers" id="1O8H61-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec129" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When deleting a router, the following information will be necessary:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Router name or ID</li></ul></div></div></div>

<div class="book" title="Deleting routers" id="1O8H61-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec130" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To delete a router in OpenStack, issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack router delete COOKBOOK_ROUTER_DVR</strong></span>
</pre></div><p class="calibre10">No output is given. However, the operation can be verified using the <code class="email">openstack router list</code> command:</p><div class="mediaobject"><img src="../images/00051.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p><p class="calibre10">Deleted <a id="id252" class="calibre1"/>routers will no longer appear in the list.</p></div></div>

<div class="book" title="Deleting routers" id="1O8H61-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec131" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When invoked, the <code class="email">openstack router delete</code> command will instruct Neutron to delete the specified router and associated resources. In a reference architecture, the layer 3 agents are responsible for deleting the respective network namespace(s) and virtual interfaces configured on the hosts, and all records of the router are purged from the OpenStack database.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Managing security groups"><div class="book" id="1P71O2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec57" class="calibre1"/>Managing security groups</h1></div></div></div><p class="calibre10">In OpenStack, a security <a id="id253" class="calibre1"/>group describes a grouping of ports of similar security requirements. Security group rules are associated with security groups, and provide ingress and egress filtering capabilities to the group. Security group rules can reference other groups or remote networks using CIDR notation. The actual filtering takes place on the compute node at the "port" level, and may be implemented using iptables or as openflow rules depending on the firewall driver that is configured on a given <a id="id254" class="calibre1"/>node. Newly created projects each contain a security group named <code class="email">default</code> that allows egress, or outbound, communication only. Ingress, or inbound, communication is denied.</p></div>

<div class="book" title="Managing security groups">
<div class="book" title="Creating security groups"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec132" class="calibre1"/>Creating security groups</h2></div></div></div><p class="calibre10">Security <a id="id255" class="calibre1"/>groups in OpenStack can be created using the <code class="email">openstack security group create</code> command. Security groups are project-owned objects and cannot be shared or referenced by other projects.</p></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec133" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When creating a security group, each port associated with the group will inherit the rules applied to the group. You will need the following details, at a minimum, for the group:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Security group name</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Security group name: <code class="email">COOKBOOK_SG_WEB</code></li></ul></div></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec134" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to create a security group with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack security group create COOKBOOK_SG_WEB</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00052.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec135" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Security groups are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack security group create SECURITY_GROUP_NAME</strong></span>
</pre></div><p class="calibre10">When a security group is created, OpenStack applies a default set of rules to the group that allows a port to communicate outbound (egress) over IPv4 and IPv6. By default, all inbound <a id="id256" class="calibre1"/>traffic is denied.</p><p class="calibre10">Creating a security group is only the first step in providing filtering to instances. The next steps, namely creating security group rules and applying security groups to ports, will be discussed in the following sections.</p></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="Creating security group rules"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch04lvl2sec136" class="calibre1"/>Creating security group rules</h2></div></div></div><p class="calibre10">Security <a id="id257" class="calibre1"/>group rules in OpenStack can be created using the <code class="email">openstack security group rule create</code> command. A security group rule provides information on filtering at a layer 3 and layer 4 level, which includes IP addresses and destination ports.</p></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch04lvl2sec137" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When creating a security group rule, remember that each port associated with the group will inherit the rules applied to the group. Therefore, it is important to limit the rules to only those needed to provide the desired access to the associated group. You will need the following details, at a minimum, for the rule:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Security group name</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Security group name: <code class="email">COOKBOOK_SG_WEB</code></li><li class="listitem">Destination port: <code class="email">80</code></li><li class="listitem">Protocol: TCP</li><li class="listitem">Direction: Ingress</li><li class="listitem">Source: All Addresses</li></ul></div></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch04lvl2sec138" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to create a security group rule with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack security group rule create COOKBOOK_SG_WEB \</strong></span>
<span class="strong"><strong class="calibre2">--dst-port 80 \</strong></span>
<span class="strong"><strong class="calibre2">--protocol tcp \</strong></span>
<span class="strong"><strong class="calibre2">--ingress \</strong></span>
<span class="strong"><strong class="calibre2">--remote-ip 0.0.0.0/0</strong></span>
</pre></div><p class="calibre10">The output <a id="id258" class="calibre1"/>will resemble the following:</p><div class="mediaobject"><img src="../images/00053.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_8"><a id="ch04lvl2sec139" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Security groups are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">openstack security group rule create SECURITY_GROUP_NAME \
[--remote-ip &lt;ip-address&gt; | --remote-group &lt;group&gt;] \
[--dst-port &lt;port-range&gt;] \
[--icmp-type &lt;icmp-type&gt;] \
[--icmp-code &lt;icmp-code&gt;] \
[--protocol &lt;protocol&gt;] \
[--ingress | --egress] \
[--ethertype &lt;ethertype&gt;]</pre></div><p class="calibre10">Security group rules provide details to OpenStack that are used by Neutron agents to implement traffic filters on individual ports on compute nodes. In our environment, these rules are <a id="id259" class="calibre1"/>implemented as iptables rules.</p><p class="calibre10">Creating a security group rule without providing any additional filtering information may result in a rule that allows ingress access from <span class="strong"><em class="calibre18">all</em></span> source addresses. OpenStack assumes certain defaults when details are not specified, so it is important to verify the provided output to ensure the proper filtering is in place.</p></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="Applying security groups to instances"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_9"><a id="ch04lvl2sec140" class="calibre1"/>Applying security groups to instances</h2></div></div></div><p class="calibre10">Security <a id="id260" class="calibre1"/>groups are typically applied to instances upon boot, using the <code class="email">openstack server create</code> command, but they can also be applied to individual ports, using the <code class="email">openstack network port create</code> or <code class="email">set</code> commands. When applied at boot, each listed security group is applied to each port associated with the instance. As a result, unnecessary rules may be applied to each interface that could result in a security risk or regression in performance of the underlying Neutron agent responsible for applying the rules. When applied to individual ports, users can ensure that if an instance is multihomed, the respective port has only the necessary rules needed to provide access to that interface.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note16" class="calibre1"/>Note</h3><p class="calibre10">The term multihomed refers to an instance that is connected to multiple networks via different interfaces.</p></div></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_10"><a id="ch04lvl2sec141" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When applying security groups to instances at boot, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Security group name or ID</li></ul></div><p class="calibre10">When applying security groups to individual ports, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Port name or ID</li><li class="listitem">Security group name or ID</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Port name: <code class="email">COOKBOOK_TEST_PORT_1</code></li><li class="listitem">Security group name: <code class="email">COOKBOOK_SG_WEB</code></li><li class="listitem">Instance name: <code class="email">COOKBOOK_INSTANCE_WEB</code></li><li class="listitem">Instance flavor: <code class="email">COOKBOOK_FLAVOR_TINY</code></li><li class="listitem">Instance image: <code class="email">COOKBOOK_IMAGE_CIRROS</code></li><li class="listitem">Network name: <code class="email">COOKBOOK_TENANT_NET_1</code></li></ul></div></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_11"><a id="ch04lvl2sec142" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the <code class="email">openstack</code> client installed on our system we are able to apply security groups with <a id="id261" class="calibre1"/>the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create an instance and supply the security group at boot:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server create COOKBOOK_INSTANCE_WEB \</strong></span>
<span class="strong"><strong class="calibre2">--flavor COOKBOOK_FLAVOR_TINY \</strong></span>
<span class="strong"><strong class="calibre2">--image COOKBOOK_IMAGE_CIRROS \</strong></span>
<span class="strong"><strong class="calibre2">--nic net-id=COOKBOOK_TENANT_NET_1 \</strong></span>
<span class="strong"><strong class="calibre2">--security-group COOKBOOK_SG_WEB</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note17" class="calibre1"/>Note</h3><p class="calibre10">Use flavors and images that are appropriate for your environment, or those that may have been created in <a class="calibre1" title="Chapter 5. Nova – OpenStack Compute" href="part0062_split_000.html#1R42S1-189e69df43a248268db97cde1b1a8e47">Chapter 5</a>, <span class="strong"><em class="calibre18">Nova – OpenStack Compute</em></span> and <a class="calibre1" title="Chapter 6. Glance – OpenStack Image Service" href="part0087_split_000.html#2IV0U1-189e69df43a248268db97cde1b1a8e47">Chapter 6</a>, <span class="strong"><em class="calibre18">Glance – OpenStack Image Service</em></span>.</p></div><p class="calibre22">Alternatively, security groups can be applied during port creation or to existing ports. With the OpenStack client installed on our system we are able to apply security groups with the following stes.</p></li><li class="listitem" value="2">Apply a security group to a new port:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port create COOKBOOK_TEST_PORT_3 \</strong></span>
<span class="strong"><strong class="calibre2">--network COOKBOOK_TENANT_NET_1 \</strong></span>
<span class="strong"><strong class="calibre2">--security-group COOKBOOK_SG_WEB</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00054.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Apply the <a id="id262" class="calibre1"/>security group to an existing port:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port set COOKBOOK_TEST_PORT_2 \</strong></span>
<span class="strong"><strong class="calibre2">--security-group COOKBOOK_SG_WEB</strong></span>
</pre></div><p class="calibre22">No output is returned. However, the change can be confirmed by querying the security groups applied to the port using the <code class="email">openstack port show</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port show COOKBOOK_TEST_PORT_2 -c security_group_ids</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00055.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Managing security groups">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_12"><a id="ch04lvl2sec143" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Security <a id="id263" class="calibre1"/>groups can be applied to instances at boot, ports at creation, or to existing ports. Neutron plugin agents on compute nodes are responsible for applying the respective filtering rules to the port on the host. Multiple security groups can be applied to a port in all scenarios.</p><p class="calibre10">Security groups can be applied at boot with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server create INSTANCE_NAME \</strong></span>
<span class="strong"><strong class="calibre2">...</strong></span>
<span class="strong"><strong class="calibre2">--security-group SECURITY_GROUP_NAME</strong></span>
</pre></div><p class="calibre10">Security groups can also be applied to new ports with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port create PORT_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--network NETWORK_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--security-group SECURITY_GROUP_NAME </strong></span>
</pre></div><p class="calibre10">Lastly, security groups can be applied to existing ports with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack port set PORT_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--security-group SECURITY_GROUP_NAME</strong></span>
</pre></div><p class="calibre10">Ports are bound to Neutron plugin agents that reside on hosts within the environment. For example, ports belonging to instances are bound to the agent on the respective compute node where the instance lives. This agent is responsible for setting up the virtual networking for the port. When a security group is applied to a port, the Neutron agent where the port is bound implements the filtering rules on the host. Other agents throughout the environment are notified that the group has changed and are updated accordingly.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Managing load balancers"><div class="book" id="1Q5IA2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec58" class="calibre1"/>Managing load balancers</h1></div></div></div><p class="calibre10">Neutron <a id="id264" class="calibre1"/>includes a service known as <span class="strong"><strong class="calibre2">Load Balancing as-a-Service</strong></span> (<span class="strong"><strong class="calibre2">LBaaS</strong></span>), which provides users with the ability to create load balancers that balance <a id="id265" class="calibre1"/>traffic to applications deployed across instances in the cloud. In a reference architecture, Neutron relies on an open source load balancing package known as HAProxy to provide the load balancing functionality. Much like the Neutron L3 agent handles virtual routers and the DHCP agent handles virtual DHCP servers, the Neutron LBaaS agent handles the construction and configuration of virtual load balancers upon request.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note18" class="calibre1"/>Note</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">LBaaS</strong></span> should not be confused with another load balancing project known as Octavia. Both provide similar load balancing functions, but only LBaaS is covered here.</p></div><p class="calibre10">There are three major components to a load balancer in OpenStack:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Pool members</li><li class="listitem">Pools</li><li class="listitem">Listeners</li></ul></div><p class="calibre10">A <span class="strong"><strong class="calibre2">pool member</strong></span> describes a layer 4 object that is composed of the IP address and port of a service <a id="id266" class="calibre1"/>residing on an instance. For example, a pool member might be a web server with a configured address of <code class="email">10.30.0.2</code> listening on TCP port <code class="email">80</code>.</p><p class="calibre10">A <span class="strong"><strong class="calibre2">pool</strong></span> is a <a id="id267" class="calibre1"/>group of pool members serving identical content.</p><p class="calibre10">A <span class="strong"><strong class="calibre2">listener</strong></span> is an <a id="id268" class="calibre1"/>object that represents a <span class="strong"><strong class="calibre2">virtual IP</strong></span> (<span class="strong"><strong class="calibre2">VIP</strong></span>) and port that is listening on the load balancer itself. Traffic to the virtual IP will be balanced <a id="id269" class="calibre1"/>among the members of the associated pool.</p><p class="calibre10">Additional components, such as health monitors and L7 policies, help extend the usefulness and functionality of a load balancer, but are not required.</p><p class="calibre10">The workflow for creating a functioning load balancer is as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Create a load balancer object</li><li class="listitem">Create and associate listener</li><li class="listitem">Create and associate a pool</li><li class="listitem">Create and associate pool member(s)</li><li class="listitem">Create and associate health monitor(s) (optional)</li></ul></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Creating load balancers"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec144" class="calibre1"/>Creating load balancers</h2></div></div></div><p class="calibre10">As of <a id="id270" class="calibre1"/>the Pike release of OpenStack, load balancer-related commands are not available in the OpenStack client. Instead, the <code class="email">neutron</code> client should be used. Load balancers in OpenStack can be created using the <code class="email">neutron lbaas-loadbalancer-create</code> command.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec145" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the load balancer:</p><div class="book"><ul class="itemizedlist"><li class="listitem">VIP subnet</li></ul></div><p class="calibre10">A name is also recommended. For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Name: <code class="email">COOKBOOK_LOADBALANCER_1</code></li><li class="listitem">VIP subnet: <code class="email">COOKBOOK_TENANT_SUBNET_1</code></li></ul></div></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec146" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the Neutron client installed on our system, we are now able to create a load balancer object with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-loadbalancer-create COOKBOOK_TENANT_SUBNET_1 \</strong></span>
<span class="strong"><strong class="calibre2">--name COOKBOOK_LOADBALANCER_1</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00056.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec147" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Load <a id="id271" class="calibre1"/>balancers are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-loadbalancer-create VIP_SUBNET \</strong></span>
<span class="strong"><strong class="calibre2">[--name NAME]</strong></span>
</pre></div><p class="calibre10">When a load balancer is created, OpenStack assigns an IP address known as a virtual IP. The VIP will be used by clients to access the load-balanced application. Creating a load balancer object is only the first step in load balancing traffic to instances. The next steps, creating a listener, pool, and health monitor will be discussed in the following sections.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Creating pools"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch04lvl2sec148" class="calibre1"/>Creating pools</h2></div></div></div><p class="calibre10">Pools that are <a id="id272" class="calibre1"/>associated with load balancers are objects that represent a collection of instances that receive traffic sent to the VIP. Load balancing pools in OpenStack can be created using the <code class="email">neutron lbaas-pool-create</code> command.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch04lvl2sec149" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the pool:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Balancing algorithm</li><li class="listitem">Protocol</li><li class="listitem">Load balancer or listener</li></ul></div><p class="calibre10">A name is also recommended. For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Name: <code class="email">COOKBOOK_POOL_1</code></li><li class="listitem">Balancing algorithm: <code class="email">ROUND_ROBIN</code></li><li class="listitem">Protocol: <code class="email">HTTP</code></li><li class="listitem">Load balancer: <code class="email">COOKBOOK_LOADBALANCER_1</code></li></ul></div><p class="calibre10">A load <a id="id273" class="calibre1"/>balancer can be associated with multiple listeners, which in turn can be associated with their own respective pool. A common scenario for this type of set up would be a load balancer with a listener on port <code class="email">80</code> and another on port <code class="email">443</code>, each with their respective backend pool.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch04lvl2sec150" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the Neutron client installed on our system, we are now able to create a load balancer pool with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-pool-create --lb-algorithm ROUND_ROBIN \</strong></span>
<span class="strong"><strong class="calibre2">--protocol HTTP \</strong></span>
<span class="strong"><strong class="calibre2">--loadbalancer COOKBOOK_LOADBALANCER_1 \</strong></span>
<span class="strong"><strong class="calibre2">--name COOKBOOK_POOL_1 </strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00057.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_8"><a id="ch04lvl2sec151" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Load <a id="id274" class="calibre1"/>balancer pools are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-pool-create [--name NAME] \</strong></span>
<span class="strong"><strong class="calibre2">--lb-algorithm {ROUND_ROBIN,LEAST_CONNECTIONS,SOURCE_IP} \</strong></span>
<span class="strong"><strong class="calibre2">[--listener LISTENER | --loadbalancer LOADBALANCER] \</strong></span>
<span class="strong"><strong class="calibre2">--protocol {HTTP,HTTPS,TCP}</strong></span>
</pre></div><p class="calibre10">Other load-balancing objects, such as members and monitors, reference pools and cannot be created without being applied to one at that time.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Creating members"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_9"><a id="ch04lvl2sec152" class="calibre1"/>Creating members</h2></div></div></div><p class="calibre10">Members <a id="id275" class="calibre1"/>are associated with pools, and are objects that represent a backend application listening on a particular IP and port. Pool members in OpenStack can be created using the <code class="email">neutron lbaas-member-create</code> command.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_10"><a id="ch04lvl2sec153" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the member:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Subnet name</li><li class="listitem">IP address</li><li class="listitem">Port</li><li class="listitem">Pool name</li></ul></div><p class="calibre10">A name is also recommended. For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Name: <code class="email">COOKBOOK_MEMBER_1</code></li><li class="listitem">Subnet name: <code class="email">COOKBOOK_TENANT_SUBNET_1</code></li><li class="listitem">IP Address: <code class="email">172.16.200.11</code> (Corresponds to <code class="email">COOKBOOK_TEST_PORT_2</code>)</li><li class="listitem">Port: <code class="email">80</code></li><li class="listitem">Pool name: <code class="email">COOKBOOK_POOL_1</code></li></ul></div><p class="calibre10">A member <a id="id276" class="calibre1"/>can only be associated with a single pool. However, the same IP address and application port combination can be used for multiple members.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_11"><a id="ch04lvl2sec154" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the Neutron client installed on our system we are able to create a pool member with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-member-create --name COOKBOOK_MEMBER_1 \</strong></span>
<span class="strong"><strong class="calibre2">--subnet COOKBOOK_TENANT_SUBNET_1 \</strong></span>
<span class="strong"><strong class="calibre2">--address 172.16.200.11 \</strong></span>
<span class="strong"><strong class="calibre2">--protocol-port 80 \</strong></span>
<span class="strong"><strong class="calibre2">COOKBOOK_POOL_1 </strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00058.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_12"><a id="ch04lvl2sec155" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Pool <a id="id277" class="calibre1"/>members are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-member-create [--name NAME] \</strong></span>
<span class="strong"><strong class="calibre2">--subnet SUBNET --address ADDRESS \</strong></span>
<span class="strong"><strong class="calibre2">--protocol-port PROTOCOL_PORT \</strong></span>
<span class="strong"><strong class="calibre2">POOL</strong></span>
</pre></div></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Creating listeners"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_13"><a id="ch04lvl2sec156" class="calibre1"/>Creating listeners</h2></div></div></div><p class="calibre10">Listeners <a id="id278" class="calibre1"/>are associated with load balancer objects, and they describe the relationship between the load balancer VIP and the port a service is listening on. Clients send traffic to the listener address and port, which is then proxied and sent to one member within pool of servers. Each listener can be configured to send traffic to a different pool. Listeners in OpenStack can be created using the <code class="email">neutron lbaas-listener-create</code> command.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_14"><a id="ch04lvl2sec157" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, for the listener:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Load balancer name</li><li class="listitem">Protocol</li><li class="listitem">Port</li></ul></div><p class="calibre10">A name and default pool are also recommended. For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Name: <code class="email">COOKBOOK_LISTENER_1</code></li><li class="listitem">Load balancer name: <code class="email">COOKBOOK_LOADBALANCER_1</code></li><li class="listitem">Protocol: <code class="email">HTTP</code></li><li class="listitem">Port: <code class="email">80</code></li><li class="listitem">Default pool: <code class="email">COOKBOOK_POOL_1</code></li></ul></div></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_15"><a id="ch04lvl2sec158" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the <a id="id279" class="calibre1"/>Neutron client installed on our system, we are now able to create a listener with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-listener-create --name COOKBOOK_LISTENER_1 \</strong></span>
<span class="strong"><strong class="calibre2">--loadbalancer COOKBOOK_LOADBALANCER_1 \</strong></span>
<span class="strong"><strong class="calibre2">--protocol HTTP \</strong></span>
<span class="strong"><strong class="calibre2">--protocol-port 80 \</strong></span>
<span class="strong"><strong class="calibre2">--default-pool COOKBOOK_POOL_1</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00059.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_16"><a id="ch04lvl2sec159" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Listeners <a id="id280" class="calibre1"/>are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">neutron lbaas-listener-create [--name NAME] \</strong></span>
<span class="strong"><strong class="calibre2">--loadbalancer LOADBALANCER \</strong></span>
<span class="strong"><strong class="calibre2">--protocol {TCP,HTTP,HTTPS,TERMINATED_HTTPS} \</strong></span>
<span class="strong"><strong class="calibre2">--protocol-port PORT \</strong></span>
<span class="strong"><strong class="calibre2">[--default-pool DEFAULT_POOL]</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip21" class="calibre1"/>Tip</h3><p class="calibre10">Access to the listener may be restricted by applying a security group to the respective port of the load balancer address. Use the <code class="email">openstack port set</code> command described earlier in this chapter to apply a security group to the listener's port.</p></div></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Verifying connectivity"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_17"><a id="ch04lvl2sec160" class="calibre1"/>Verifying connectivity</h2></div></div></div><p class="calibre10">Once the <a id="id281" class="calibre1"/>workflow has been completed and the application on the pool members has been started, connectivity to the load balancer VIP can be verified using a web browser or the <code class="email">curl</code> command from a client that can reach the VIP. In this example, a web server is running on the pool member configured in a previous section. We will be connecting from the <code class="email">qlbaas</code> namespace associated with the load balancer, but you can also connect from the <code class="email">qdhcp</code> namespace associated with the network from which the VIP address was sourced.</p></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_18"><a id="ch04lvl2sec161" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">You will need the following details, at a minimum, to test connectivity</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network ID or Load balancer ID</li><li class="listitem">VIP address and port</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Load Balancer ID: <code class="email">aa599cee-b49f-44f1-a0fd-51fa69ebf6db</code> (<code class="email">COOKBOOK_LOADBALANCER_1</code>)</li><li class="listitem">VIP address and port: <code class="email">172.16.200.14:80</code></li></ul></div></div></div>

<div class="book" title="Managing load balancers">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_19"><a id="ch04lvl2sec162" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">From within the Neutron agent container, connectivity to the VIP can be confirmed using <code class="email">curl</code> within the <code class="email">qdhcp</code> or <code class="email">qlbaas</code> namespace:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># ip netns exec qlbaas-aa599cee</strong></span>
<span class="strong"><strong class="calibre2">-b49f-44f1-a0fd-51fa69ebf6db \</strong></span>
<span class="strong"><strong class="calibre2">curl http://172.16.200.14:80</strong></span>
</pre></div><p class="calibre10">The output <a id="id282" class="calibre1"/>will resemble the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Hello Cookbook Readers!</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note19" class="calibre1"/>Note</h3><p class="calibre10">You may need to install the <code class="email">curl</code> utility for the command to work. In the Neutron agent container, this can be accomplished by running <code class="email">apt install curl</code>. The configuration of the web server on the pool member is beyond the scope of this book.</p></div><p class="calibre10">To provide access to the load balancer virtual IP from outside networks, it may be necessary to map a floating IP to the virtual IP. Instructions provided earlier in this chapter can assist with that task.</p></div></div></body></html>