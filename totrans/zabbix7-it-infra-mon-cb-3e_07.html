<html><head></head><body>
<div id="_idContainer467" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-224"><a id="_idTextAnchor1318" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-225" class="calibre5"><a id="_idTextAnchor1319" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.2.1">Using Discovery for  Automatic Creation</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">This chapter is going to be all about making sure that you as a Zabbix administrator are doing as little work as possible on host and item creation. </span><span class="kobospan" id="kobo.3.2">We are going to learn how to perform (or perfect, maybe) automatic host, item trigger, and graph creation. </span><span class="kobospan" id="kobo.3.3">Check out the recipes featured here to see just what we are going </span><span><span class="kobospan" id="kobo.4.1">to discover.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, we will first learn how to set up Zabbix network discovery with Zabbix agent</span><a id="_idIndexMarker516" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.6.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.7.1">Simple Network Management Protocol</span></strong><span class="kobospan" id="kobo.8.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.9.1">SNMP</span></strong><span class="kobospan" id="kobo.10.1">). </span><span class="kobospan" id="kobo.10.2">We will then set up active agent autoregistration. </span><span class="kobospan" id="kobo.10.3">Later, we will also cover the automatic creation of Windows performance counters, </span><strong class="bold"><span class="kobospan" id="kobo.11.1">Java Management Extensions</span></strong><span class="kobospan" id="kobo.12.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.13.1">JMX</span></strong><span class="kobospan" id="kobo.14.1">), and</span><a id="_idIndexMarker517" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.15.1"> SNMP items </span><a id="_idIndexMarker518" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.16.1">using </span><strong class="bold"><span class="kobospan" id="kobo.17.1">low-level </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.18.1">discovery</span></strong></span><span><span class="kobospan" id="kobo.19.1"> (</span></span><span><strong class="bold"><span class="kobospan" id="kobo.20.1">LLD</span></strong></span><span><span class="kobospan" id="kobo.21.1">).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.22.1">In this chapter, we will cover the </span><span><span class="kobospan" id="kobo.23.1">following recipes:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.24.1">Setting up Zabbix agent </span><span><span class="kobospan" id="kobo.25.1">host discovery</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.26.1">Working with Zabbix SNMP </span><span><span class="kobospan" id="kobo.27.1">network discovery</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.28.1">Automating host creation with active </span><span><span class="kobospan" id="kobo.29.1">agent autoregistration</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.30.1">Using Windows performance </span><span><span class="kobospan" id="kobo.31.1">counter discovery</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.32.1">Discovering </span><span><span class="kobospan" id="kobo.33.1">JMX objects</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.34.1">Setting up Zabbix SNMP discovery the </span><span><span class="kobospan" id="kobo.35.1">new way</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.36.1">Creating hosts with LLD and </span><span><span class="kobospan" id="kobo.37.1">custom JS</span><a id="_idTextAnchor1320" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1321" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.38.1">ON</span></span></li>
</ul>
<h1 id="_idParaDest-226" class="calibre5"><a id="_idTextAnchor1322" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.39.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.40.1">As this chapter is all about host and item discovery, besides our Zabbix server, we will need one new Linux host and a Windows host. </span><span class="kobospan" id="kobo.40.2">Both these hosts will need Zabbix agent 2 installed, but not configured </span><span><span class="kobospan" id="kobo.41.1">just yet.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.42.1">Furthermore, we are going to need our JMX host, as configured in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.43.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.44.1">, </span><em class="italic"><span class="kobospan" id="kobo.45.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.46.1">, and a new host with SNMP set up. </span><span class="kobospan" id="kobo.46.2">To learn more about setting up an SNMP-monitored host, check out the </span><em class="italic"><span class="kobospan" id="kobo.47.1">Working with SNMP monitoring the old way</span></em><span class="kobospan" id="kobo.48.1"> recipe in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.49.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.50.1">, </span><em class="italic"><span class="kobospan" id="kobo.51.1">Setting Up </span></em><span><em class="italic"><span class="kobospan" id="kobo.52.1">Zabbix Monitorin</span><a id="_idTextAnchor1323" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1324" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.53.1">g</span></em></span><span><span class="kobospan" id="kobo.54.1">.</span></span></p>
<h1 id="_idParaDest-227" class="calibre5"><a id="_idTextAnchor1325" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.55.1">Setting up Zabbix agent network discovery</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.56.1">A lot of Zabbix </span><a id="_idIndexMarker519" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.57.1">administrators use Zabbix agent extensively and thus spend a lot of time creat</span><a id="_idTextAnchor1326" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.58.1">ing Zabbix agent hosts by hand. </span><span class="kobospan" id="kobo.58.2">Maybe they don’t know how to set up Zabbix agent discovery, maybe they didn’t have time to set it up yet, or maybe they just prefer it this way. </span><span class="kobospan" id="kobo.58.3">If you are ready to get started with Zabbix agent discovery, in this recipe we will learn just how easy it is to set </span><span><span class="kobospan" id="kobo.59.1">it </span><a id="_idTextAnchor1327" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1328" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.60.1">up.</span></span></p>
<h2 id="_idParaDest-228" class="calibre7"><a id="_idTextAnchor1329" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.61.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.62.1">Besides our Zabbix server, in this chapter’s introduction, I mentioned that we will need two (empty) hosts with Zabbix agent 2 installed: one Windows host and one Linux host. </span><span class="kobospan" id="kobo.62.2">If you don’t know how to install Zabbix agent 2, check out </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.63.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.64.1">, </span><em class="italic"><span class="kobospan" id="kobo.65.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.66.1">, or </span><a id="_idTextAnchor1330" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.67.1">see the Zabbix documentation </span><span><span class="kobospan" id="kobo.68.1">at </span></span><a href="https://www.zabbix.com/documentation/current/en/manual/concepts/agent2" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.69.1">https://www.zabbix.com/documentation/current/en/manual/concepts/agent2</span></span></a><span><span class="kobospan" id="kobo.70.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.71.1">Let’s give the servers the </span><span><span class="kobospan" id="kobo.72.1">following hostnames:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><strong class="source-inline1"><span class="kobospan" id="kobo.73.1">lar-book-disc-lnx</span></strong><span class="kobospan" id="kobo.74.1">: For the Linux host (use Zabbix </span><span><span class="kobospan" id="kobo.75.1">agent 2)</span></span></li>
<li class="calibre15"><strong class="source-inline1"><span class="kobospan" id="kobo.76.1">lar-book-disc-win</span></strong><span class="kobospan" id="kobo.77.1">: For the Windows host (use Zabbix </span><span><span class="kobospan" id="kobo.78.1">agent</span><a id="_idTextAnchor1331" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1332" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.79.1"> 2)</span></span></li>
</ul>
<h2 id="_idParaDest-229" class="calibre7"><a id="_idTextAnchor1333" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.80.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.81.1">Follow </span><span><span class="kobospan" id="kobo.82.1">these steps:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.83.1">Let’s get started by logging in to our </span><strong class="source-inline1"><span class="kobospan" id="kobo.84.1">lar-book-disc-lnx</span></strong><span class="kobospan" id="kobo.85.1"> Linux host and editing the </span><span><span class="kobospan" id="kobo.86.1">following file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.87.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.88.1">Now, make sure your Zabbix agent 2 configuration file contains at least the </span><span><span class="kobospan" id="kobo.89.1">following line:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.90.1">
Hostname=lar-book-disc-lnx</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.91.1">For your Windows Zabbix agent, it’s important to do the same. </span><span class="kobospan" id="kobo.91.2">Edit the </span><span><span class="kobospan" id="kobo.92.1">following file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.93.1">
C:\Program Files\Zabbix Agent 2\zabbix_agent2.conf</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.94.1">Now, change</span><a id="_idIndexMarker520" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.95.1"> the hostname by editing the </span><span><span class="kobospan" id="kobo.96.1">following line:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.97.1">
Hostname=lar-book-disc-win</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.98.1">Next up, in our Zabbix frontend, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.99.1">Data collection</span></strong><span class="kobospan" id="kobo.100.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.101.1">Discovery</span></strong><span class="kobospan" id="kobo.102.1">, and on </span><a id="_idTextAnchor1334" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.103.1">this page, we click on </span><strong class="bold"><span class="kobospan" id="kobo.104.1">Create discovery rule</span></strong><span class="kobospan" id="kobo.105.1"> to create a rule with the </span><span><span class="kobospan" id="kobo.106.1">following settin</span><a id="_idTextAnchor1335" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.107.1">gs:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer395">
<span class="kobospan" id="kobo.108.1"><img alt="Figure 7.1 – Discovery rules page for Zabbix agent hosts" src="image/B19803_07_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.109.1">Figure 7.1 – Discovery rules page for Zabbix agent hosts</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.110.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.111.1">We are using an update interval of </span><strong class="source-inline1"><span class="kobospan" id="kobo.112.1">5</span></strong><span class="kobospan" id="kobo.113.1"> minutes in this example. </span><span class="kobospan" id="kobo.113.2">As this might take up a lot of resources on your server, make sure to adjust this value for your production environment. </span><span class="kobospan" id="kobo.113.3">For example, one hour might be a better production value to make sure we put less load onto our Zabbix processes. </span><span class="kobospan" id="kobo.113.4">Depending on the size of the IP range we are scanning and how fast you want to discover things, we can adjust </span><span><span class="kobospan" id="kobo.114.1">this value.</span></span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.115.1">Cl</span><a id="_idTextAnchor1336" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.116.1">ick the blue </span><strong class="bold"><span class="kobospan" id="kobo.117.1">Add</span></strong><span class="kobospan" id="kobo.118.1"> button to </span><span><span class="kobospan" id="kobo.119.1">move on.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.120.1">After setting up the discovery rule, we will also need to set up an action to actually create</span><a id="_idIndexMarker521" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.121.1"> the host with the right template. </span><span class="kobospan" id="kobo.121.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.122.1">Alerts</span></strong><span class="kobospan" id="kobo.123.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.124.1">Actions</span></strong><span class="kobospan" id="kobo.125.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.126.1">Discovery acti</span><a id="_idTextAnchor1337" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.127.1">ons</span></strong></span><span><span class="kobospan" id="kobo.128.1">:</span></span></li>
</ol>
<p class="calibre3"> </p>
<div class="calibre2">
<div class="img---figure" id="_idContainer396">
<span class="kobospan" id="kobo.129.1"><img alt="Figure 7.2 – Alerts | Actions | Discovery actions" src="image/B19803_07_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.130.1">Figure 7.2 – Alerts | Actions | Discovery actions</span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.131.1">Here, we will click the </span><strong class="bold"><span class="kobospan" id="kobo.132.1">Create action</span></strong><span class="kobospan" id="kobo.133.1"> button in the top-right corner and fill out the next page with the </span><span><span class="kobospan" id="kobo.134.1">following informatio</span><a id="_idTextAnchor1338" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.135.1">n:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer397">
<span class="kobospan" id="kobo.136.1"><img alt="Figure 7.3 – The discovery action creation page for Zabbix agent hosts" src="image/B19803_07_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.137.1">Figure 7.3 – The discovery action creation page for Zabbix agent hosts</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.138.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.139.1">When creating Zabbix actions, it’s important to keep the order of creation for </span><strong class="bold"><span class="kobospan" id="kobo.140.1">Conditions</span></strong><span class="kobospan" id="kobo.141.1"> in mind. </span><span class="kobospan" id="kobo.141.2">The labels seen in the preceding screenshot will be added in order of creation. </span><span class="kobospan" id="kobo.141.3">This means that it’s easier to keep track of your Zabbix actions if you keep the order of creation the same for </span><span><span class="kobospan" id="kobo.142.1">all actions.</span></span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.143.1">Ne</span><a id="_idTextAnchor1339" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.144.1">xt up, click</span><a id="_idIndexMarker522" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.145.1"> the </span><strong class="bold"><span class="kobospan" id="kobo.146.1">Operations</span></strong><span class="kobospan" id="kobo.147.1"> tab. </span><span class="kobospan" id="kobo.147.2">This is where we will add </span><span><span class="kobospan" id="kobo.148.1">the followin</span><a id="_idTextAnchor1340" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.149.1">g:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer398">
<span class="kobospan" id="kobo.150.1"><img alt="Figure 7.4 – The Operations page for Zabbix agent hosts" src="image/B19803_07_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.151.1">Figure 7.4 – The Operations page for Zabbix agent hosts</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.152.1">That’s it for the Linux agent. </span><span class="kobospan" id="kobo.152.2">Click the blue </span><strong class="bold"><span class="kobospan" id="kobo.153.1">Add</span></strong><span class="kobospan" id="kobo.154.1"> button, and let’s continue with our Windows </span><span><span class="kobospan" id="kobo.155.1">discovery rule.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.156.1">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.157.1">Data collection</span></strong><span class="kobospan" id="kobo.158.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.159.1">Host groups</span></strong><span class="kobospan" id="kobo.160.1">. </span><span class="kobospan" id="kobo.160.2">Create a host group for our Windows hosts by clicking </span><strong class="bold"><span class="kobospan" id="kobo.161.1">Create host group</span></strong><span class="kobospan" id="kobo.162.1"> in the top-right corner and filling out the </span><span><span class="kobospan" id="kobo.163.1">group name</span><a id="_idTextAnchor1341" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.164.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer399">
<span class="kobospan" id="kobo.165.1"><img alt="Figure 7.5 – The Create host group page for Windows server hosts" src="image/B19803_07_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.166.1">Figure 7.5 – The Create host group page for Windows server hosts</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.167.1">Clic</span><a id="_idTextAnchor1342" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.168.1">k the blue </span><strong class="bold"><span class="kobospan" id="kobo.169.1">Add</span></strong><span class="kobospan" id="kobo.170.1"> button and navigate to </span><strong class="bold"><span class="kobospan" id="kobo.171.1">Alerts</span></strong><span class="kobospan" id="kobo.172.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.173.1">Actions</span></strong></span><span><span class="kobospan" id="kobo.174.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.175.1">Go to </span><strong class="bold"><span class="kobospan" id="kobo.176.1">Discovery actions</span></strong><span class="kobospan" id="kobo.177.1"> again and click </span><strong class="bold"><span class="kobospan" id="kobo.178.1">Create action</span></strong><span class="kobospan" id="kobo.179.1">. </span><span class="kobospan" id="kobo.179.2">We will fill out the same thing</span><a id="_idIndexMarker523" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.180.1"> but for our Windows hosts </span><span><span class="kobospan" id="kobo.181.1">this time</span><a id="_idTextAnchor1343" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.182.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer400">
<span class="kobospan" id="kobo.183.1"><img alt="Figure 7.6 – Discovery action creation page for Windows Zabbix agents" src="image/B19803_07_06.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.184.1">Figure 7.6 – Discovery action creation page for Windows Zabbix agents</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.185.1">Before clicking </span><strong class="bold"><span class="kobospan" id="kobo.186.1">Add</span></strong><span class="kobospan" id="kobo.187.1">, let’s also fill out the </span><strong class="bold"><span class="kobospan" id="kobo.188.1">Operations</span></strong><span class="kobospan" id="kobo.189.1"> page with the operations shown in the </span><span><span class="kobospan" id="kobo.190.1">following screenshot:</span></span><a id="_idTextAnchor1344" class="pcalibre calibre6 pcalibre1"/></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer401">
<span class="kobospan" id="kobo.191.1"><img alt="Figure 7.7 – The Operations page for Windows Zabbix agents" src="image/B19803_07_07.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.192.1">Figure 7.7 – The Operations page for Windows Zabbix agents</span></p>
<ol class="calibre16">
<li value="15" class="calibre15"><span class="kobospan" id="kobo.193.1">Now, we</span><a id="_idTextAnchor1345" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.194.1"> can</span><a id="_idIndexMarker524" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.195.1"> click the blue </span><strong class="bold"><span class="kobospan" id="kobo.196.1">Add</span></strong><span class="kobospan" id="kobo.197.1"> button, and our second discovery action </span><span><span class="kobospan" id="kobo.198.1">is present.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.199.1">Move on to </span><strong class="bold"><span class="kobospan" id="kobo.200.1">Monitoring</span></strong><span class="kobospan" id="kobo.201.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.202.1">Discovery</span></strong><span class="kobospan" id="kobo.203.1">. </span><span class="kobospan" id="kobo.203.2">This is where we can see whether and when our hosts </span><span><span class="kobospan" id="kobo.204.1">are discovered:</span></span><a id="_idTextAnchor1346" class="pcalibre calibre6 pcalibre1"/></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer402">
<span class="kobospan" id="kobo.205.1"><img alt="Figure 7.8 – The Monitoring | Discovery page" src="image/B19803_07_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.206.1">Figure 7.8 – The Monitoring | Discovery page</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.207.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.208.1">Use the </span><strong class="bold"><span class="kobospan" id="kobo.209.1">Monitoring</span></strong><span class="kobospan" id="kobo.210.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.211.1">Discovery</span></strong><span class="kobospan" id="kobo.212.1"> page to keep a close eye on the hosts you expect to show up in your Zabbix setup. </span><span class="kobospan" id="kobo.212.2">It’s very useful to track new hosts coming in and see which Zabbix discovery rule was used to create </span><span><span class="kobospan" id="kobo.213.1">the host.</span></span><a id="_idTextAnchor1347" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1348" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-230" class="calibre7"><a id="_idTextAnchor1349" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.214.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.215.1">Network</span><a id="_idIndexMarker525" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.216.1"> discover</span><a id="_idTextAnchor1350" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.217.1">y might not be very hard to set up initially, but there are loads of options to configure. </span><span class="kobospan" id="kobo.217.2">For this example, we chose to use the </span><strong class="source-inline"><span class="kobospan" id="kobo.218.1">agent.hostname</span></strong><span class="kobospan" id="kobo.219.1"> key as our check. </span><span class="kobospan" id="kobo.219.2">We create the Zabbix hostname based on what’s configured in the Zabbix agent </span><span><span class="kobospan" id="kobo.220.1">configuration file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.221.1">What happens is that Zabbix network discovery finds our hosts and performs our check. </span><span class="kobospan" id="kobo.221.2">In this case, the check is </span><em class="italic"><span class="kobospan" id="kobo.222.1">What is the hostname used by Zabbix agent?</span></em><span class="kobospan" id="kobo.223.1"> This information, plus our IP address, is then triggering the action. </span><span class="kobospan" id="kobo.223.2">Our action then performs our </span><span><span class="kobospan" id="kobo.224.1">configured checks:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.225.1">Does the hostname contain </span><strong class="source-inline1"><span class="kobospan" id="kobo.226.1">lnx</span></strong> <span><span class="kobospan" id="kobo.227.1">or </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.228.1">win</span></strong></span><span><span class="kobospan" id="kobo.229.1">?</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.230.1">Is the discovery </span><span><span class="kobospan" id="kobo.231.1">status </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.232.1">UP</span></strong></span><span><span class="kobospan" id="kobo.233.1">?</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.234.1">Is the service type </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.235.1">Zabbix Agent</span></strong></span><span><span class="kobospan" id="kobo.236.1">?</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.237.1">If all of those checks are true, our action will then create our newly discovered host with </span><span><span class="kobospan" id="kobo.238.1">the following:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.239.1">Our configured host group plus the default </span><strong class="source-inline1"><span class="kobospan" id="kobo.240.1">Discovered hosts</span></strong> <span><span class="kobospan" id="kobo.241.1">host group</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.242.1">Our template as configured in </span><span><span class="kobospan" id="kobo.243.1">our action</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.244.1">We will end up with</span><a id="_idIndexMarker526" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.245.1"> two newly created hosts, with all the </span><span><span class="kobospan" id="kobo.246.1">right settings</span><a id="_idTextAnchor1351" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.247.1">:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer403">
<span class="kobospan" id="kobo.248.1"><img alt="Figure 7.9 – The Data collection | Hosts page with our new hosts, Windows and Linu﻿﻿x" src="image/B19803_07_09.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.249.1">Figure 7.9 – The Data collection | Hosts page with our new hosts, Windows and Linu</span><a id="_idTextAnchor1352" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1353" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.250.1">x</span></p>
<h2 id="_idParaDest-231" class="calibre7"><a id="_idTextAnchor1354" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.251.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.252.1">Creating the host by using the configuration file settings isn’t always the right way to go, but it’s a solid start to working with </span><span><span class="kobospan" id="kobo.253.1">network discovery.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.254.1">If you want a more flexible environment where you don’t have to even touch the Zabbix agent configuration </span><a id="_idIndexMarker527" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.255.1">file, then you might want to use different checks on the discovery rule. </span><span class="kobospan" id="kobo.255.2">Check o</span><a id="_idTextAnchor1355" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.256.1">ut which keys we can use to build different discovery rules in the Zabbix documentation </span><span><span class="kobospan" id="kobo.257.1">at </span></span><a href="https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/zabbix_agent" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.258.1">https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/zabbix_agent</span></span></a><span><span class="kobospan" id="kobo.259.1">.</span></span></p>
<h1 id="_idParaDest-232" class="calibre5"><a id="_idTextAnchor1356" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.260.1">Working with Zabbix SNMP network discovery</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.261.1">If you wo</span><a id="_idTextAnchor1357" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.262.1">rk</span><a id="_idIndexMarker528" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.263.1"> with a lot of SNMP devices but don’t always want to set up monitoring manually, network discovery is the way to go. </span><span class="kobospan" id="kobo.263.2">Zabbix network discovery uses the same functionality as Zabbix agent discovery but with a different </span><span><span class="kobospan" id="kobo.264.1">configuration approa</span><a id="_idTextAnchor1358" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1359" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.265.1">ch.</span></span></p>
<h2 id="_idParaDest-233" class="calibre7"><a id="_idTextAnchor1360" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.266.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.267.1">To get started with network discovery, we are going to need a host that we can monitor with SNMP. </span><span class="kobospan" id="kobo.267.2">If you don’t know how to set up a host such as this, check out the </span><em class="italic"><span class="kobospan" id="kobo.268.1">Working with SNMP monitoring the old way</span></em><span class="kobospan" id="kobo.269.1"> recipe in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.270.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.271.1">, </span><em class="italic"><span class="kobospan" id="kobo.272.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.273.1">. </span><span class="kobospan" id="kobo.273.2">We’ll also need our </span><span><span class="kobospan" id="kobo.274.1">Zabbix serv</span><a id="_idTextAnchor1361" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1362" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.275.1">er.</span></span></p>
<h2 id="_idParaDest-234" class="calibre7"><a id="_idTextAnchor1363" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.276.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.277.1">Follow </span><span><span class="kobospan" id="kobo.278.1">these steps:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.279.1">First, log in to your new SNMP-monitored host and change the hostname to </span><span><span class="kobospan" id="kobo.280.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.281.1">hostnamectl set-hostname lar-book-disc-snmp</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.282.1">exec bash</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.283.1">Then, restart the SNMP daemon using the </span><span><span class="kobospan" id="kobo.284.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.285.1">systemctl restart snmpd</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.286.1">Now, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.287.1">Data collection</span></strong><span class="kobospan" id="kobo.288.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.289.1">Discovery</span></strong><span class="kobospan" id="kobo.290.1"> and click on </span><strong class="bold"><span class="kobospan" id="kobo.291.1">Create discovery rule</span></strong><span class="kobospan" id="kobo.292.1"> in</span><a id="_idIndexMarker529" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.293.1"> the </span><span><span class="kobospan" id="kobo.294.1">top-right corner.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.295.1">We</span><a id="_idTextAnchor1364" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.296.1"> are going to create a new SNMP discovery rule, with an SNMP </span><strong class="bold"><span class="kobospan" id="kobo.297.1">object identifier</span></strong><span class="kobospan" id="kobo.298.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.299.1">OID</span></strong><span class="kobospan" id="kobo.300.1">) check </span><a id="_idIndexMarker530" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.301.1">type. </span><span class="kobospan" id="kobo.301.2">Fill out the </span><strong class="bold"><span class="kobospan" id="kobo.302.1">Name</span></strong><span class="kobospan" id="kobo.303.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.304.1">IP range</span></strong><span class="kobospan" id="kobo.305.1"> fields first, </span><span><span class="kobospan" id="kobo.306.1">like t</span><a id="_idTextAnchor1365" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.307.1">his:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer404">
<span class="kobospan" id="kobo.308.1"><img alt="Figure 7.10 – Data collection | Discovery, discovery rule creation page for SNMPv2" src="image/B19803_07_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.309.1">Figure 7.10 – Data collection | Discovery, discovery rule creation page for SNMPv2</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><a id="_idTextAnchor1366" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.310.1">Make sure to fill out your own IP range in the </span><strong class="bold"><span class="kobospan" id="kobo.311.1">IP </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.312.1">range</span></strong></span><span><span class="kobospan" id="kobo.313.1"> field.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.314.1">Now, we are going to create our SNMP check. </span><span class="kobospan" id="kobo.314.2">Click on </span><strong class="bold"><span class="kobospan" id="kobo.315.1">Add</span></strong><span class="kobospan" id="kobo.316.1"> next to </span><strong class="bold"><span class="kobospan" id="kobo.317.1">Checks</span></strong><span class="kobospan" id="kobo.318.1">, and you’ll see </span><a id="_idIndexMarker531" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.319.1">the following </span><span><span class="kobospan" id="kobo.320.1">pop-up scr</span><a id="_idTextAnchor1367" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.321.1">een:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer405">
<span class="kobospan" id="kobo.322.1"><img alt="Figure 7.11 – Data collection | Discovery, discovery check creation pop-up window" src="image/B19803_07_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.323.1">Figure 7.11 – Data collection | Discovery, discovery check creation pop-up window</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.324.1">We want </span><strong class="bold"><span class="kobospan" id="kobo.325.1">Check type</span></strong><span class="kobospan" id="kobo.326.1"> to be </span><strong class="bold"><span class="kobospan" id="kobo.327.1">SNMPv2 agent</span></strong><span class="kobospan" id="kobo.328.1"> and we want to fill it with our commu</span><a id="_idTextAnchor1368" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.329.1">nity and a useful OID, which in this case will be the OID for the system name. </span><span class="kobospan" id="kobo.329.2">Fill it out </span><span><span class="kobospan" id="kobo.330.1">like th</span><a id="_idTextAnchor1369" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.331.1">is:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer406">
<span class="kobospan" id="kobo.332.1"><img alt="Figure 7.12 – Data collection | Discovery, discovery check creation pop-up window filled with an SNMPv2 check" src="image/B19803_07_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.333.1">Figure 7.12 – Data collection | Discovery, discovery check creation pop-up window filled with an SNMPv2 check</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.334.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.335.1">Please note that our check type is </span><em class="italic"><span class="kobospan" id="kobo.336.1">not</span></em><span class="kobospan" id="kobo.337.1"> SNMP version independent. </span><span class="kobospan" id="kobo.337.2">We have three SNMP versions and thus three different check types to choose from, unlike our new SNMP interface selection on the Zabbix 7 </span><span><span class="kobospan" id="kobo.338.1">host screen.</span></span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.339.1">After</span><a id="_idIndexMarker532" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.340.1"> clicking </span><strong class="bold"><span class="kobospan" id="kobo.341.1">Add</span></strong><span class="kobospan" id="kobo.342.1"> again, fill out the rest of the page, </span><span><span class="kobospan" id="kobo.343.1">as follo</span><a id="_idTextAnchor1370" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.344.1">ws:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer407">
<span class="kobospan" id="kobo.345.1"><img alt="Figure 7.13 – The Data collection | Discovery page for SNMPv2 agents" src="image/B19803_07_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.346.1">Figure 7.13 – The Data collection | Discovery page for SNMPv2 agents</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.347.1">Last, </span><a id="_idTextAnchor1371" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.348.1">but not</span><a id="_idIndexMarker533" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.349.1"> least, click the </span><strong class="bold"><span class="kobospan" id="kobo.350.1">Add</span></strong><span class="kobospan" id="kobo.351.1"> button at the bottom of the page. </span><span class="kobospan" id="kobo.351.2">This concludes creating our Zabbix </span><span><span class="kobospan" id="kobo.352.1">discovery rule.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.353.1">We will also need an action for creating our hosts from the discovery rule. </span><span class="kobospan" id="kobo.353.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.354.1">Alerts</span></strong><span class="kobospan" id="kobo.355.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.356.1">Actions</span></strong><span class="kobospan" id="kobo.357.1">, and after using the dropdown to select </span><strong class="bold"><span class="kobospan" id="kobo.358.1">Discovery actions</span></strong><span class="kobospan" id="kobo.359.1">, click on </span><span><strong class="bold"><span class="kobospan" id="kobo.360.1">Create action</span></strong></span><span><span class="kobospan" id="kobo.361.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.362.1">We will fill out the page with the </span><span><span class="kobospan" id="kobo.363.1">following informati</span><a id="_idTextAnchor1372" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.364.1">on:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer408">
<span class="kobospan" id="kobo.365.1"><img alt="Figure 7.14 – Alerts | Actions, action creation page for SNMPv2 agents" src="image/B19803_07_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.366.1">Figure 7.14 – Alerts | Actions, action creation page for SNMPv2 agents</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.367.1">Bef</span><a id="_idTextAnchor1373" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.368.1">ore</span><a id="_idIndexMarker534" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.369.1"> clicking </span><strong class="bold"><span class="kobospan" id="kobo.370.1">Add</span></strong><span class="kobospan" id="kobo.371.1">, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.372.1">Operations</span></strong><span class="kobospan" id="kobo.373.1"> and fill out this page with the </span><span><span class="kobospan" id="kobo.374.1">following detai</span><a id="_idTextAnchor1374" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.375.1">ls:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer409">
<span class="kobospan" id="kobo.376.1"><img alt="Figure 7.15 – Alerts | Actions, the action creation Operations tab for SNMPv2 agents" src="image/B19803_07_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.377.1">Figure 7.15 – Alerts | Actions, the action creation Operations tab for SNMPv2 agents</span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.378.1">Now, click </span><strong class="bold"><span class="kobospan" id="kobo.379.1">Add</span></strong><span class="kobospan" id="kobo.380.1"> and navigate to </span><strong class="bold"><span class="kobospan" id="kobo.381.1">Monitoring</span></strong><span class="kobospan" id="kobo.382.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.383.1">Discovery</span></strong><span class="kobospan" id="kobo.384.1"> to see whether our host </span><span><span class="kobospan" id="kobo.385.1">gets create</span><a id="_idTextAnchor1375" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.386.1">d:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer410">
<span class="kobospan" id="kobo.387.1"><img alt="Figure 7.16 – The Monitoring | Discovery page for SNMPv2 agen﻿﻿ts" src="image/B19803_07_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.388.1">Figure 7.16 – The Monitoring | Discovery page for SNMPv2 agen</span><a id="_idTextAnchor1376" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1377" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.389.1">ts</span></p>
<h2 id="_idParaDest-235" class="calibre7"><a id="_idTextAnchor1378" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.390.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.391.1">In this recipe, we’ve </span><a id="_idIndexMarker535" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.392.1">created another discovery rule, but this time for SNMP. </span><span class="kobospan" id="kobo.392.2">As you’ve noticed, the principle remains the same, but the application is a </span><span><span class="kobospan" id="kobo.393.1">bit different.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.394.1">When</span><a id="_idTextAnchor1379" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.395.1"> we created this Zabbix discovery rule, we gave it two checks instead of the one check we did in the previous recipe. </span><span class="kobospan" id="kobo.395.2">We created one check on the </span><strong class="source-inline"><span class="kobospan" id="kobo.396.1">.1.3.6.1.2.1.1.5.0</span></strong><span class="kobospan" id="kobo.397.1"> SNMP OID to retrieve the hostname of the device through SNMP. </span><span class="kobospan" id="kobo.397.2">We then put the hostname retrieved from the system into Zabbix as the Zabbix hostname of </span><span><span class="kobospan" id="kobo.398.1">the system.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.399.1">We also created a check on the </span><strong class="source-inline"><span class="kobospan" id="kobo.400.1">.1.3.6.1.2.1.25.1.4.0</span></strong><span class="kobospan" id="kobo.401.1"> SNMP OID. </span><span class="kobospan" id="kobo.401.2">This check will retrieve the following string, </span><span><span class="kobospan" id="kobo.402.1">if present:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.403.1">
"BOOT_IMAGE=(hd0,gpt2)/vmlinuz-4.18.0-193.6.3.el8_2.x86_64 root=/dev/mapper/cl-root ro crashkernel=auto resume=/dev/mapper/cl-swa"</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.404.1">If the string is present, it means that the boot image is Linux on this host. </span><span class="kobospan" id="kobo.404.2">This is a perfect example of how we can retrieve multiple OIDs to do multiple checks in our Zabbix discovery rules. </span><span class="kobospan" id="kobo.404.3">If we’d been monitoring a networking device, for instance, we could have picked an OID to see whether it was a Cisco or a Juniper device. </span><span class="kobospan" id="kobo.404.4">We would replace </span><strong class="source-inline"><span class="kobospan" id="kobo.405.1">.1.3.6.1.2.1.25.1.4.0</span></strong><span class="kobospan" id="kobo.406.1"> with any OID and poll it. </span><span class="kobospan" id="kobo.406.2">Then, we would create our action based on what </span><a id="_idIndexMarker536" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.407.1">we received (Juniper or Cisco) and add our </span><span><span class="kobospan" id="kobo.408.1">templates accordingly.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.409.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.410.1">General knowledge of SNMP structure is very important when creating Zabbix discovery rules. </span><span class="kobospan" id="kobo.410.2">We want to make sure we use the right SNMP OIDs as checks. </span><span class="kobospan" id="kobo.410.3">Make sure to do your research well, utilize SNMP walks, and plan out what OIDs you want to use to discover SNMP agents. </span><span class="kobospan" id="kobo.410.4">This way, you’ll end up with a solid </span><span><span class="kobospan" id="kobo.411.1">monitoring infrastruct</span><a id="_idTextAnchor1380" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1381" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.412.1">ure.</span></span></p>
<h1 id="_idParaDest-236" class="calibre5"><a id="_idTextAnchor1382" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.413.1">Automating host creation with active agent autoregistration</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.414.1">Using disco</span><a id="_idTextAnchor1383" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.415.1">very </span><a id="_idIndexMarker537" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.416.1">to set up your </span><a id="_idIndexMarker538" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.417.1">Zabbix agents is a very useful method to automate your host creation. </span><span class="kobospan" id="kobo.417.2">But what if we want to be even more upfront with our environment and automate further? </span><span class="kobospan" id="kobo.417.3">That’s when we use a </span><a id="_idTextAnchor1384" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.418.1">Zabbix feature called </span><strong class="bold"><span class="kobospan" id="kobo.419.1">active </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.420.1">agent autoregistr</span><a id="_idTextAnchor1385" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1386" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.421.1">ation</span></strong></span><span><span class="kobospan" id="kobo.422.1">.</span></span></p>
<h2 id="_idParaDest-237" class="calibre7"><a id="_idTextAnchor1387" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.423.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.424.1">For this recipe, we will need a new Linux host. </span><span class="kobospan" id="kobo.424.2">We will call this host </span><strong class="source-inline"><span class="kobospan" id="kobo.425.1">lar-book-lnx-agent-auto</span></strong><span class="kobospan" id="kobo.426.1">. </span><span class="kobospan" id="kobo.426.2">Make sure to install Zabbix agent 2 on this host. </span><span class="kobospan" id="kobo.426.3">Besides this new host, we’ll also need our </span><span><span class="kobospan" id="kobo.427.1">Zabbix s</span><a id="_idTextAnchor1388" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1389" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.428.1">erver.</span></span></p>
<h2 id="_idParaDest-238" class="calibre7"><a id="_idTextAnchor1390" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.429.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.430.1">Let’s start by logging in to our new </span><strong class="source-inline1"><span class="kobospan" id="kobo.431.1">lar-book-lnx-agent-auto</span></strong><span class="kobospan" id="kobo.432.1"> host and changing the </span><span><span class="kobospan" id="kobo.433.1">following file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.434.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.435.1">We will then edit the following line in the file. </span><span class="kobospan" id="kobo.435.2">Make sure to enter your Zabbix server IP on </span><span><span class="kobospan" id="kobo.436.1">this line:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.437.1">
ServerActive=10.16.16.152</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.438.1">We can also change the following line in the file if we want to set our hostname in the </span><span><span class="kobospan" id="kobo.439.1">file manually:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.440.1">
Hostname=lar-book—lnx-agent-auto</span></pre><p class="calibre3"><span class="kobospan" id="kobo.441.1">This is not a requirement though, as Zabbix agent will use the system hostname if it is not </span><span><span class="kobospan" id="kobo.442.1">filled out.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.443.1">Next up, we will navigate to our Zabbix frontend, where we’ll go to </span><strong class="bold"><span class="kobospan" id="kobo.444.1">Alerts</span></strong><span class="kobospan" id="kobo.445.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.446.1">Actions</span></strong></span><span><span class="kobospan" id="kobo.447.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.448.1">Use the drop-down </span><a id="_idIndexMarker539" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.449.1">menu</span><a id="_idIndexMarker540" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.450.1"> to go to </span><strong class="bold"><span class="kobospan" id="kobo.451.1">Autoregistration actions</span></strong><span class="kobospan" id="kobo.452.1">, as in the </span><span><span class="kobospan" id="kobo.453.1">following scre</span><a id="_idTextAnchor1391" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.454.1">enshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer411">
<span class="kobospan" id="kobo.455.1"><img alt="Figure 7.17 – The Alerts | Actions page drop-down menu" src="image/B19803_07_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.456.1">Figure 7.17 – The Alerts | Actions page drop-down menu</span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><a id="_idTextAnchor1392" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.457.1">Now, we will click the blue </span><strong class="bold"><span class="kobospan" id="kobo.458.1">Create action</span></strong><span class="kobospan" id="kobo.459.1"> button in the top-right corner to create a </span><span><span class="kobospan" id="kobo.460.1">new action.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.461.1">Fill out the </span><strong class="bold"><span class="kobospan" id="kobo.462.1">Name</span></strong><span class="kobospan" id="kobo.463.1"> field and then click on the </span><strong class="bold"><span class="kobospan" id="kobo.464.1">Add</span></strong> <span><span class="kobospan" id="kobo.465.1">text</span><a id="_idTextAnchor1393" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.466.1"> link:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer412">
<span class="kobospan" id="kobo.467.1"><img alt="Figure 7.18 – Alerts | Actions, create new action page" src="image/B19803_07_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.468.1">Figure 7.18 – Alerts | Actions, create new action page</span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.469.1">We can set </span><a id="_idIndexMarker541" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.470.1">up a</span><a id="_idIndexMarker542" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.471.1"> condition here to only register hosts with a certain hostname. </span><span class="kobospan" id="kobo.471.2">Let’s do this by filling out the window </span><span><span class="kobospan" id="kobo.472.1">lik</span><a id="_idTextAnchor1394" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.473.1">e this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer413">
<span class="kobospan" id="kobo.474.1"><img alt="Figure 7.19 – Create action | New condition for the lar-book-lnx host" src="image/B19803_07_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.475.1">Figure 7.19 – Create action | New condition for the lar-book-lnx host</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.476.1">Yo</span><a id="_idTextAnchor1395" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.477.1">ur page should now look </span><span><span class="kobospan" id="kobo.478.1">like</span><a id="_idTextAnchor1396" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.479.1"> this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer414">
<span class="kobospan" id="kobo.480.1"><img alt="Figure 7.20 – The Create action page, filled with our information for the lar-book-lnx host" src="image/B19803_07_20.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.481.1">Figure 7.20 – The Create action page, filled with our information for the lar-book-lnx host</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.482.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.483.1">We can set up conditions for different types of hosts. </span><span class="kobospan" id="kobo.483.2">For instance, if we want to add Windows hosts, we set up a new action with a different hostname filter. </span><span class="kobospan" id="kobo.483.3">This way, it is easy to maintain the right groups and templates, even </span><span><span class="kobospan" id="kobo.484.1">with autoregistration.</span></span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.485.1">Before clicking</span><a id="_idIndexMarker543" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.486.1"> the </span><a id="_idIndexMarker544" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.487.1">blue </span><strong class="bold"><span class="kobospan" id="kobo.488.1">Add</span></strong><span class="kobospan" id="kobo.489.1"> button, let’s go to the </span><span><strong class="bold"><span class="kobospan" id="kobo.490.1">Operations</span></strong></span><span><span class="kobospan" id="kobo.491.1"> ta</span><a id="_idTextAnchor1397" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.492.1">b.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.493.1">Click on the </span><strong class="bold"><span class="kobospan" id="kobo.494.1">Add</span></strong><span class="kobospan" id="kobo.495.1"> text link, and you will see the </span><span><span class="kobospan" id="kobo.496.1">following </span><a id="_idTextAnchor1398" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.497.1">window:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer415">
<span class="kobospan" id="kobo.498.1"><img alt="Figure 7.21 – The Send message operation for the lar-book-lnx host" src="image/B19803_07_21.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.499.1">Figure 7.21 – The Send message operation for the lar-book-lnx host</span></p>
<ol class="calibre16">
<li value="11" class="calibre15"><span class="kobospan" id="kobo.500.1">Create an action </span><a id="_idIndexMarker545" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.501.1">to</span><a id="_idIndexMarker546" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.502.1"> add the host to the </span><strong class="bold"><span class="kobospan" id="kobo.503.1">Linux servers</span></strong> <span><span class="kobospan" id="kobo.504.1">hos</span><a id="_idTextAnchor1399" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.505.1">t group:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer416">
<span class="kobospan" id="kobo.506.1"><img alt="Figure 7.22 – The Add to host group operation creatio﻿n" src="image/B19803_07_22.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.507.1">Figure 7.22 – The Add to host group operation creatio</span><a id="_idTextAnchor1400" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.508.1">n</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.509.1">Create an action to add the host to the </span><strong class="bold"><span class="kobospan" id="kobo.510.1">Linux by Zabbix agent </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.511.1">active</span></strong></span><span><span class="kobospan" id="kobo.512.1"> te</span><a id="_idTextAnchor1401" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.513.1">mplate:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer417">
<span class="kobospan" id="kobo.514.1"><img alt="Figure 7.23 – The Link to template operation creation" src="image/B19803_07_23.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.515.1">Figure 7.23 – The Link to template operation creation</span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.516.1">Your </span><a id="_idIndexMarker547" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.517.1">finalized </span><strong class="bold"><span class="kobospan" id="kobo.518.1">Operations</span></strong><span class="kobospan" id="kobo.519.1"> page </span><a id="_idIndexMarker548" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.520.1">should now look like this, and we can click the blue </span><span><strong class="bold"><span class="kobospan" id="kobo.521.1">Add</span><a id="_idTextAnchor1402" class="pcalibre calibre6 pcalibre1"/></strong></span><span><span class="kobospan" id="kobo.522.1"> button:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer418">
<span class="kobospan" id="kobo.523.1"><img alt="Figure 7.24 – The Operations page, filled with our information" src="image/B19803_07_24.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.524.1">Figure 7.24 – The Operations page, filled with our information</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><a id="_idTextAnchor1403" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.525.1">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.526.1">Data collection</span></strong><span class="kobospan" id="kobo.527.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.528.1">Hosts</span></strong><span class="kobospan" id="kobo.529.1">, and we can see our new active </span><span><span class="kobospan" id="kobo.530.1">autoregistere</span><a id="_idTextAnchor1404" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.531.1">d host:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer419">
<span class="kobospan" id="kobo.532.1"><img alt="Figure 7.25 – The Data collection | Hosts page with host lar-book-lnx-age﻿﻿nt-auto" src="image/B19803_07_25.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.533.1">Figure 7.25 – The Data collection | Hosts page with host lar-book-lnx-age</span><a id="_idTextAnchor1405" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1406" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.534.1">nt-auto</span></p>
<h2 id="_idParaDest-239" class="calibre7"><span class="kobospan" id="kobo.535.1">How it works…</span><a id="_idTextAnchor1407" class="pcalibre calibre6 pcalibre1"/></h2>
<p class="calibre3"><span class="kobospan" id="kobo.536.1">Active agent autoregistration is a solid method to let a host register itself. </span><span class="kobospan" id="kobo.536.2">Once the </span><strong class="source-inline"><span class="kobospan" id="kobo.537.1">ServerActive=</span></strong><span class="kobospan" id="kobo.538.1"> line is set up with the Zabbix server or proxy IP, the host agent will start requesting configuration data from the Zabbix server or Proxy. </span><span class="kobospan" id="kobo.538.2">The Zabbix server will receive these</span><a id="_idIndexMarker549" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.539.1"> requests, and </span><a id="_idIndexMarker550" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.540.1">if there is an action set up in Zabbix (as we just did in this recipe), the host autoregisters </span><span><span class="kobospan" id="kobo.541.1">to</span><a id="_idTextAnchor1408" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.542.1"> Zabbix:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer420">
<span class="kobospan" id="kobo.543.1"><img alt="Figure 7.26 – Host autoregistration proces﻿s" src="image/B19803_07_26.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.544.1">Figure 7.26 – Host autoregistration proces</span><a id="_idTextAnchor1409" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.545.1">s</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.546.1">We can do a bunch of cool automation with this functionality. </span><span class="kobospan" id="kobo.546.2">We could create a script to fill up our Zabbix agent configuration file with the right </span><strong class="source-inline"><span class="kobospan" id="kobo.547.1">ServerActive=</span></strong><span class="kobospan" id="kobo.548.1"> line on our hosts in a certain </span><span><span class="kobospan" id="kobo.549.1">IP pool.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.550.1">It would also be super easy to set up new hosts with Ansible. </span><span class="kobospan" id="kobo.550.2">We can automate the Zabbix agent installation with Ansible and we can add the </span><strong class="source-inline"><span class="kobospan" id="kobo.551.1">ServerActive=</span></strong><span class="kobospan" id="kobo.552.1"> line in the </span><strong class="source-inline"><span class="kobospan" id="kobo.553.1">/etc/zabbix/zabbix_agent2.conf</span></strong><span class="kobospan" id="kobo.554.1"> file using Ansible as well. </span><span class="kobospan" id="kobo.554.2">Our Zabbix server autoregistration action will take care of the rest </span><span><span class="kobospan" id="kobo.555.1">from here.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.556.1">Zabbix agent autoregistration is a perfect way to get a zero-touch monitoring environment that’s always up to date with our latest </span><span><span class="kobospan" id="kobo.557.1">ne</span><a id="_idTextAnchor1410" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1411" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.558.1">w hosts.</span></span></p>
<h2 id="_idParaDest-240" class="calibre7"><a id="_idTextAnchor1412" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.559.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.560.1">Not every company uses hostnames that reflect the machine’s OS or other attributes. </span><span class="kobospan" id="kobo.560.2">This is when Zabbix </span><strong class="source-inline"><span class="kobospan" id="kobo.561.1">HostMetadata</span></strong><span class="kobospan" id="kobo.562.1"> can come in very useful. </span><span class="kobospan" id="kobo.562.2">We can add this field to the active Zabbix agent configuration to reflect the attributes of </span><span><span class="kobospan" id="kobo.563.1">the machine.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.564.1">Afterward</span><a id="_idTextAnchor1413" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.565.1">, we can use </span><strong class="source-inline"><span class="kobospan" id="kobo.566.1">HostMetadata</span></strong><span class="kobospan" id="kobo.567.1"> in our Zabbix discovery action to do the same kind of filtering we did on </span><span><span class="kobospan" id="kobo.568.1">the hostname.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.569.1">We also have the </span><strong class="source-inline"><span class="kobospan" id="kobo.570.1">HostInterface</span></strong><span class="kobospan" id="kobo.571.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.572.1">HostInterfaceItem</span></strong><span class="kobospan" id="kobo.573.1"> parameters in the Zabbix agent configuration file, which are used for autoregistration. </span><span class="kobospan" id="kobo.573.2">The host will use the specified IP or DNS name as its Zabbix agent interface IP or DNS, as seen in the Zabbix fron</span><a id="_idTextAnchor1414" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.574.1">tend. </span><span class="kobospan" id="kobo.574.2">We</span><a id="_idIndexMarker551" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.575.1"> can</span><a id="_idIndexMarker552" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.576.1"> also use this functionality to enable passive agent monitoring while using autoregistration to create </span><span><span class="kobospan" id="kobo.577.1">the h</span><a id="_idTextAnchor1415" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.578.1">ost.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.579.1">Check out this link for </span><span><span class="kobospan" id="kobo.580.1">more information:</span></span></p>
<p class="calibre3"><a href="https://www.zabbix.com/documentation/current/manual/discovery/auto_registration#using_hos﻿﻿t_metadata" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.581.1">https://www.zabbix.com/documentation/current/manual/discovery/auto_registration#using_hos</span><span id="_idTextAnchor1416"/><span id="_idTextAnchor1417"/><span class="kobospan" id="kobo.582.1">t_metadata</span></span></a></p>
<h1 id="_idParaDest-241" class="calibre5"><a id="_idTextAnchor1418" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.583.1">Using Windows performance counter discovery</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.584.1">In Zabbi</span><a id="_idTextAnchor1419" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.585.1">x 7, it is possible </span><a id="_idIndexMarker553" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.586.1">to discover Windows performance counters. </span><span class="kobospan" id="kobo.586.2">In this recipe, we will go over the process of discovering Windows performance counters to use in </span><span><span class="kobospan" id="kobo.587.1">our environments.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.588.1">Discovering Windows performance counters might seem to be a little tricky at first, as it uses both Windows- and Zabbix-specific concepts. </span><span class="kobospan" id="kobo.588.2">However, once we finish this recipe, you’ll know exactly how to</span><a id="_idTextAnchor1420" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1421" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.589.1"> set </span><span><span class="kobospan" id="kobo.590.1">it up.</span></span></p>
<h2 id="_idParaDest-242" class="calibre7"><a id="_idTextAnchor1422" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.591.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.592.1">In this chapter, we added the </span><strong class="source-inline"><span class="kobospan" id="kobo.593.1">lar-book-disc-win</span></strong><span class="kobospan" id="kobo.594.1"> host to our setup, which is the host used in our Zabbix agent discovery process. </span><span class="kobospan" id="kobo.594.2">We can reuse this host to discover Windows performance </span><span><span class="kobospan" id="kobo.595.1">counters easily.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.596.1">Of course, we’ll also need our </span><span><span class="kobospan" id="kobo.597.1">Zab</span><a id="_idTextAnchor1423" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1424" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.598.1">bix server.</span></span></p>
<h2 id="_idParaDest-243" class="calibre7"><a id="_idTextAnchor1425" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.599.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.600.1">Let’s start by navigating to </span><strong class="bold"><span class="kobospan" id="kobo.601.1">Data collection</span></strong><span class="kobospan" id="kobo.602.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.603.1">Templates</span></strong><span class="kobospan" id="kobo.604.1"> and creating a new template by clicking </span><strong class="bold"><span class="kobospan" id="kobo.605.1">Create template</span></strong><span class="kobospan" id="kobo.606.1"> in the </span><span><span class="kobospan" id="kobo.607.1">top-right corner.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.608.1">Create the </span><span><span class="kobospan" id="kobo.609.1">following</span><a id="_idTextAnchor1426" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.610.1"> template:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer421">
<span class="kobospan" id="kobo.611.1"><img alt="Figure 7.27 – The Windows performance by Zabbix agent template creatio﻿n" src="image/B19803_07_27.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.612.1">Figure 7.27 – The Windows performance by Zabbix agent template creatio</span><a id="_idTextAnchor1427" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.613.1">n</span></p>
<ol class="calibre16">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.614.1">Click on the</span><a id="_idIndexMarker554" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.615.1"> blue </span><strong class="bold"><span class="kobospan" id="kobo.616.1">Add</span></strong><span class="kobospan" id="kobo.617.1"> button, which will bring you back to </span><strong class="bold"><span class="kobospan" id="kobo.618.1">Data collection</span></strong><span class="kobospan" id="kobo.619.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.620.1">Templates</span></strong><span class="kobospan" id="kobo.621.1">. </span><span class="kobospan" id="kobo.621.2">Select the </span><span><span class="kobospan" id="kobo.622.1">new template.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.623.1">Now, before continuing with our template, navigate to your Windows frontend and </span><span><span class="kobospan" id="kobo.624.1">open </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.625.1">pe</span><a id="_idTextAnchor1428" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.626.1">rfmon.exe</span></strong></span><span><span class="kobospan" id="kobo.627.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer422">
<span class="kobospan" id="kobo.628.1"><img alt="Figure 7.28 – Windows search bar – perfmon.exe" src="image/B19803_07_28.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.629.1">Figure 7.28 – Windows search bar – perfmon.exe</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.630.1">Doing so will </span><a id="_idIndexMarker555" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.631.1">open the </span><span><span class="kobospan" id="kobo.632.1">followi</span><a id="_idTextAnchor1429" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.633.1">ng window:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer423">
<span class="kobospan" id="kobo.634.1"><img alt="Figure 7.29 – Windows perfmon﻿.exe" src="image/B19803_07_29.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.635.1">Figure 7.29 – Windows perfmon</span><a id="_idTextAnchor1430" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.636.1">.exe</span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.637.1">Let’s click </span><a id="_idIndexMarker556" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.638.1">on </span><strong class="source-inline1"><span class="kobospan" id="kobo.639.1">Performance Monitor</span></strong><span class="kobospan" id="kobo.640.1"> and then on the green </span><strong class="bold"><span class="kobospan" id="kobo.641.1">+</span></strong><span class="kobospan" id="kobo.642.1"> icon. </span><span class="kobospan" id="kobo.642.2">This will show you all the available Windows </span><span><span class="kobospan" id="kobo.643.1">performance counters.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.644.1">Let’s start by using the </span><span><strong class="bold"><span class="kobospan" id="kobo.645.1">Processor</span></strong></span><span><span class="kobospan" id="kobo.646.1"> counter.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.647.1">Go back to the </span><strong class="bold"><span class="kobospan" id="kobo.648.1">Data collection</span></strong><span class="kobospan" id="kobo.649.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.650.1">Templates</span></strong><span class="kobospan" id="kobo.651.1"> page in Zabbix and edit our new </span><strong class="bold"><span class="kobospan" id="kobo.652.1">Windows performance by Zabbix </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.653.1">agent</span></strong></span><span><span class="kobospan" id="kobo.654.1"> template.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.655.1">When you are at the </span><strong class="bold"><span class="kobospan" id="kobo.656.1">Edit template</span></strong><span class="kobospan" id="kobo.657.1"> page, click on </span><strong class="bold"><span class="kobospan" id="kobo.658.1">Discovery rules</span></strong><span class="kobospan" id="kobo.659.1"> in the bar next to your </span><span><span class="kobospan" id="kobo.660.1">template </span><a id="_idTextAnchor1431" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.661.1">name.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.662.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.663.1">Create new discovery rule</span></strong><span class="kobospan" id="kobo.664.1"> in the top-right corner and add the </span><span><span class="kobospan" id="kobo.665.1">follo</span><a id="_idTextAnchor1432" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.666.1">wing rule:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer424">
<span class="kobospan" id="kobo.667.1"><img alt="Figure 7.30 – Create an LLD rule page – Discover counter Processor" src="image/B19803_07_30.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.668.1">Figure 7.30 – Create an LLD rule page – Discover counter Processor</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.669.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.670.1">We are using an update interval of </span><strong class="source-inline1"><span class="kobospan" id="kobo.671.1">1</span></strong><span class="kobospan" id="kobo.672.1"> minute in this example. </span><span class="kobospan" id="kobo.672.2">As this might take up a lot of resources on your server, make sure to adjust this value to your production environment. </span><span class="kobospan" id="kobo.672.3">For example, one hour is a much better </span><span><span class="kobospan" id="kobo.673.1">production value.</span></span></p>
<ol class="calibre16">
<li value="11" class="calibre15"><span class="kobospan" id="kobo.674.1">Click the </span><a id="_idIndexMarker557" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.675.1">blue </span><strong class="bold"><span class="kobospan" id="kobo.676.1">Add</span></strong><span class="kobospan" id="kobo.677.1"> button at the bottom and click our new </span><strong class="bold"><span class="kobospan" id="kobo.678.1">Discover counter Processor</span></strong> <span><span class="kobospan" id="kobo.679.1">discovery rule.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.680.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.681.1">Item prototypes</span></strong><span class="kobospan" id="kobo.682.1">, and in the top-right corner click on </span><strong class="bold"><span class="kobospan" id="kobo.683.1">Create item prototype</span></strong><span class="kobospan" id="kobo.684.1">. </span><span class="kobospan" id="kobo.684.2">We will then create the following </span><span><span class="kobospan" id="kobo.685.1">item </span><a id="_idTextAnchor1433" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.686.1">prototype:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer425">
<span class="kobospan" id="kobo.687.1"><img alt="Figure 7.31 – The CPU instance C1 time item prototype c﻿reation" src="image/B19803_07_31.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.688.1">Figure 7.31 – The CPU instance C1 time item prototype c</span><a id="_idTextAnchor1434" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.689.1">reation</span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.690.1">On </span><a id="_idIndexMarker558" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.691.1">the </span><strong class="bold"><span class="kobospan" id="kobo.692.1">Tags</span></strong><span class="kobospan" id="kobo.693.1"> tab, do not forget to add some new tags </span><span><span class="kobospan" id="kobo.694.1">a</span><a id="_idTextAnchor1435" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.695.1">s follows:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer426">
<span class="kobospan" id="kobo.696.1"><img alt="Figure 7.32 – The Tags tab" src="image/B19803_07_32.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.697.1">Figure 7.32 – The Tags tab</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.698.1">Save the new </span><strong class="bold"><span class="kobospan" id="kobo.699.1">Item prototype</span></strong><span class="kobospan" id="kobo.700.1">, go to </span><strong class="bold"><span class="kobospan" id="kobo.701.1">Data collection</span></strong><span class="kobospan" id="kobo.702.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.703.1">Hosts</span></strong><span class="kobospan" id="kobo.704.1">, and click </span><span><span class="kobospan" id="kobo.705.1">on </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.706.1">lar-book-disc-win</span></strong></span><span><span class="kobospan" id="kobo.707.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.708.1">Add our </span><strong class="bold"><span class="kobospan" id="kobo.709.1">Windows performance by Zabbix </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.710.1">agent</span></strong></span><span> <a id="_idTextAnchor1436" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.711.1">template:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer427">
<span class="kobospan" id="kobo.712.1"><img alt="Figure 7.33 – Add Windows performance by Zabbix agent template to lar-book-disc-﻿win" src="image/B19803_07_33.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.713.1">Figure 7.33 – Add Windows performance by Zabbix agent template to lar-book-disc-</span><a id="_idTextAnchor1437" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.714.1">win</span></p>
<ol class="calibre16">
<li value="16" class="calibre15"><span class="kobospan" id="kobo.715.1">After clicking on</span><a id="_idIndexMarker559" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.716.1"> the blue </span><strong class="bold"><span class="kobospan" id="kobo.717.1">Update</span></strong><span class="kobospan" id="kobo.718.1"> button, we can navigate to </span><strong class="bold"><span class="kobospan" id="kobo.719.1">Monitoring</span></strong><span class="kobospan" id="kobo.720.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.721.1">Latest data</span></strong><span class="kobospan" id="kobo.722.1">. </span><span class="kobospan" id="kobo.722.2">Add the </span><span><span class="kobospan" id="kobo.723.1">following</span><a id="_idTextAnchor1438" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.724.1"> filters:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer428">
<span class="kobospan" id="kobo.725.1"><img alt="Figure 7.34 – Latest data filter on host lar-book-disc-win" src="image/B19803_07_34.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.726.1">Figure 7.34 – Latest data filter on host lar-book-disc-win</span></p>
<ol class="calibre16">
<li value="17" class="calibre15"><span class="kobospan" id="kobo.727.1">We can now see our three newly </span><span><span class="kobospan" id="kobo.728.1">create</span><a id="_idTextAnchor1439" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.729.1">d items:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer429">
<span class="kobospan" id="kobo.730.1"><img alt="Figure 7.35 – The Monitoring | Latest data page for our host lar-book-﻿﻿disc-win" src="image/B19803_07_35.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.731.1">Figure 7.35 – The Monitoring | Latest data page for our host lar-book-</span><a id="_idTextAnchor1440" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1441" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.732.1">disc-win</span></p>
<h2 id="_idParaDest-244" class="calibre7"><span class="kobospan" id="kobo.733.1">How it works…</span><a id="_idTextAnchor1442" class="pcalibre calibre6 pcalibre1"/></h2>
<p class="calibre3"><span class="kobospan" id="kobo.734.1">Windows</span><a id="_idIndexMarker560" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.735.1"> performance counters have been around for a long time and they are very important to anyone who</span><a id="_idTextAnchor1443" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.736.1"> wants to monitor Windows machines with Zabbix. </span><span class="kobospan" id="kobo.736.2">Using LLD in combination with Windows performance counters makes it a lot easier and more flexible to build solid </span><span><span class="kobospan" id="kobo.737.1">Windows monitoring.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.738.1">In this recipe, we created a very simple but effective Windows performance counter discovery rule by adding the discovery rule with the </span><strong class="source-inline"><span class="kobospan" id="kobo.739.1">perf_instance.discovery[Processor]</span></strong><span class="kobospan" id="kobo.740.1"> item key. </span><span class="kobospan" id="kobo.740.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.741.1">[Processor]</span></strong><span class="kobospan" id="kobo.742.1"> part of this item key directly correlates to the </span><strong class="source-inline"><span class="kobospan" id="kobo.743.1">perfmon.exe</span></strong><span class="kobospan" id="kobo.744.1"> window we saw. </span><span class="kobospan" id="kobo.744.2">If we look at the following screenshot, we already see </span><span><strong class="bold"><span class="kobospan" id="kobo.745.1">Processor</span><a id="_idTextAnchor1444" class="pcalibre calibre6 pcalibre1"/></strong></span><span><span class="kobospan" id="kobo.746.1"> listed:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer430">
<span class="kobospan" id="kobo.747.1"><img alt="Figure 7.36 – perfmon.exe | Add Counters – Processor" src="image/B19803_07_36.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.748.1">Figure 7.36 – perfmon.exe | Add Counters – Processor</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.749.1">When our discovery rule polls this item key, Zabbix agent will return the following value for </span><span><span class="kobospan" id="kobo.750.1">our host:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.751.1">
[
   {
      "{#INSTANCE}":"0"
   },
   {
      "{#INSTANCE}":"1"
   },
   {
      "{#INSTANCE}":"_Total"
   }
]</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.752.1">This value means that </span><a id="_idIndexMarker561" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.753.1">Zabbix will fill the </span><strong class="source-inline"><span class="kobospan" id="kobo.754.1">{#INSTANCE}</span></strong><span class="kobospan" id="kobo.755.1"> macro with </span><span><span class="kobospan" id="kobo.756.1">three values:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><strong class="source-inline1"><span class="kobospan" id="kobo.757.1">0</span></strong></li>
<li class="calibre15"><strong class="source-inline1"><span class="kobospan" id="kobo.758.1">1</span></strong></li>
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.759.1">_Tot</span><a id="_idTextAnchor1445" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.760.1">al</span></strong></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.761.1">We can then use these three values by using the </span><strong class="source-inline"><span class="kobospan" id="kobo.762.1">{#INSTANCE}</span></strong><span class="kobospan" id="kobo.763.1"> macro in </span><strong class="bold"><span class="kobospan" id="kobo.764.1">Item prototype</span></strong><span class="kobospan" id="kobo.765.1">, as we </span><span><span class="kobospan" id="kobo.766.1">d</span><a id="_idTextAnchor1446" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.767.1">id here:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer431">
<span class="kobospan" id="kobo.768.1"><img alt="Figure 7.37 – Our created item prototype, CPU C1 time" src="image/B19803_07_37.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.769.1">Figure 7.37 – Our created item prototype, CPU C1 time</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.770.1">It will then create three items with our macro values, with the right keys to monitor the second part of our counter – </span><strong class="source-inline"><span class="kobospan" id="kobo.771.1">% C1 time</span></strong><span class="kobospan" id="kobo.772.1">. </span><span class="kobospan" id="kobo.772.2">If you expand the window in your </span><strong class="source-inline"><span class="kobospan" id="kobo.773.1">perfmon.exe</span></strong><span class="kobospan" id="kobo.774.1"> file, you can see all the different counters we could add to our item prototypes to monitor more Windows </span><span><span class="kobospan" id="kobo.775.1">performance co</span><a id="_idTextAnchor1447" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.776.1">unters:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer432">
<span class="kobospan" id="kobo.777.1"><img alt="Figure 7.38 – Perfmon.exe | Add Counters – Processor e﻿﻿xpanded" src="image/B19803_07_38.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.778.1">Figure 7.38 – Perfmon.exe | Add Counters – Processor e</span><a id="_idTextAnchor1448" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1449" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.779.1">xpanded</span></p>
<h1 id="_idParaDest-245" class="calibre5"><a id="_idTextAnchor1450" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.780.1">Discovering JMX objects</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.781.1">In </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.782.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.783.1">, </span><em class="italic"><span class="kobospan" id="kobo.784.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.785.1">, we went over setting up JMX monitoring</span><a id="_idTextAnchor1451" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.786.1"> in the recipe </span><a id="_idIndexMarker562" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.787.1">titled </span><em class="italic"><span class="kobospan" id="kobo.788.1">Setting up JMX monitoring</span></em><span class="kobospan" id="kobo.789.1">. </span><span class="kobospan" id="kobo.789.2">What we didn’t cover yet though was discovering </span><span><span class="kobospan" id="kobo.790.1">JMX objects.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.791.1">In this recipe, we will go over how to set up JMX objects with LLD, and after you’ve finished this recipe, you’ll know just how to se</span><a id="_idTextAnchor1452" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1453" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.792.1">t </span><span><span class="kobospan" id="kobo.793.1">it up.</span></span></p>
<h2 id="_idParaDest-246" class="calibre7"><a id="_idTextAnchor1454" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.794.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.795.1">For this recipe, we will need the JMX host that you set up for the </span><em class="italic"><span class="kobospan" id="kobo.796.1">Setting up JMX monitoring</span></em><span class="kobospan" id="kobo.797.1"> recipe in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.798.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.799.1">, </span><em class="italic"><span class="kobospan" id="kobo.800.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.801.1">. </span><span class="kobospan" id="kobo.801.2">Make sure to finish that recipe before working on </span><span><span class="kobospan" id="kobo.802.1">this one.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.803.1">We will also need our Zabbix server with our Zabbix JMX host </span><span><span class="kobospan" id="kobo.804.1">titled </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.805.1">lar-b</span><a id="_idTextAnchor1455" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1456" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.806.1">ook-jmx</span></strong></span><span><span class="kobospan" id="kobo.807.1">.</span></span></p>
<h2 id="_idParaDest-247" class="calibre7"><a id="_idTextAnchor1457" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.808.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.809.1">Let’s start this recipe off by logging in to our Zabbix frontend and navigating to </span><strong class="bold"><span class="kobospan" id="kobo.810.1">Data collection</span></strong><span class="kobospan" id="kobo.811.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.812.1">Templates</span></strong></span><span><span class="kobospan" id="kobo.813.1">.</span></span></li>
<li class="calibre15"><a id="_idTextAnchor1458" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.814.1">Create a new template by clicking on </span><strong class="bold"><span class="kobospan" id="kobo.815.1">Create template</span></strong><span class="kobospan" id="kobo.816.1"> in the top-right corner. </span><span class="kobospan" id="kobo.816.2">Fill in the </span><span><span class="kobospan" id="kobo.817.1">following </span><a id="_idTextAnchor1459" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.818.1">fields:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer433">
<span class="kobospan" id="kobo.819.1"><img alt="Figure 7.39 – The App Apache Tomcat JMX discovery template creation" src="image/B19803_07_39.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.820.1">Figure 7.39 – The App Apache Tomcat JMX discovery template creation</span></p>
<ol class="calibre16">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.821.1">After clicking the </span><a id="_idIndexMarker563" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.822.1">blue </span><strong class="bold"><span class="kobospan" id="kobo.823.1">Add</span></strong><span class="kobospan" id="kobo.824.1"> button, you will be taken back to </span><strong class="bold"><span class="kobospan" id="kobo.825.1">Data collection</span></strong><span class="kobospan" id="kobo.826.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.827.1">Templates</span></strong><span class="kobospan" id="kobo.828.1">. </span><span class="kobospan" id="kobo.828.2">Click on your new </span><strong class="bold"><span class="kobospan" id="kobo.829.1">App Apache Tomcat JMX </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.830.1">discovery</span></strong></span><span><span class="kobospan" id="kobo.831.1"> template.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.832.1">We will now add our JMX discovery rule. </span><span class="kobospan" id="kobo.832.2">Click on </span><strong class="bold"><span class="kobospan" id="kobo.833.1">Discovery rules</span></strong><span class="kobospan" id="kobo.834.1"> next to our </span><span><span class="kobospan" id="kobo.835.1">template name.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.836.1">Now, click on </span><strong class="bold"><span class="kobospan" id="kobo.837.1">Create discovery rule</span></strong><span class="kobospan" id="kobo.838.1"> and fill in the </span><span><span class="kobospan" id="kobo.839.1">following </span><a id="_idTextAnchor1460" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.840.1">fields:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer434">
<span class="kobospan" id="kobo.841.1"><img alt="Figure 7.40 – The Discover JMX object MemoryPool discovery rule creation" src="image/B19803_07_40.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.842.1">Figure 7.40 – The Discover JMX object MemoryPool discovery rule creation</span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.843.1">C</span><a id="_idTextAnchor1461" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.844.1">lick on the</span><a id="_idIndexMarker564" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.845.1"> blue </span><strong class="bold"><span class="kobospan" id="kobo.846.1">Add</span></strong><span class="kobospan" id="kobo.847.1"> button at the bottom of the page. </span><span class="kobospan" id="kobo.847.2">Then, click on </span><strong class="bold"><span class="kobospan" id="kobo.848.1">Item prototypes</span></strong><span class="kobospan" id="kobo.849.1"> next to your newly created </span><strong class="bold"><span class="kobospan" id="kobo.850.1">Discover JMX object MemoryPool</span></strong> <span><span class="kobospan" id="kobo.851.1">discovery rule.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.852.1">We will now click on the </span><strong class="bold"><span class="kobospan" id="kobo.853.1">Create item prototype</span></strong><span class="kobospan" id="kobo.854.1"> button in the top-right corner and create the following </span><span><span class="kobospan" id="kobo.855.1">item pro</span><a id="_idTextAnchor1462" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.856.1">totype:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer435">
<span class="kobospan" id="kobo.857.1"><img alt="Figure 7.41 – The Item prototype creation page – MemoryPool Memory type" src="image/B19803_07_41.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.858.1">Figure 7.41 – The Item prototype creation page – MemoryPool Memory type</span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.859.1">Als</span><a id="_idTextAnchor1463" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.860.1">o, make </span><a id="_idIndexMarker565" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.861.1">sure that on the </span><strong class="bold"><span class="kobospan" id="kobo.862.1">Tags</span></strong><span class="kobospan" id="kobo.863.1"> tab, you add a new tag with the name of </span><strong class="source-inline1"><span class="kobospan" id="kobo.864.1">component</span></strong><span class="kobospan" id="kobo.865.1"> and a value of </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.866.1">memor</span><a id="_idTextAnchor1464" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.867.1">y pool</span></strong></span><span><span class="kobospan" id="kobo.868.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer436">
<span class="kobospan" id="kobo.869.1"><img alt="Figure 7.42 – The Tags tab – the MemoryPool Memory type" src="image/B19803_07_42.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.870.1">Figure 7.42 – The Tags tab – the MemoryPool Memory type</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.871.1">Let’s click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.872.1">Add</span></strong><span class="kobospan" id="kobo.873.1"> button and </span><span><span class="kobospan" id="kobo.874.1">move on.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.875.1">Go to </span><strong class="bold"><span class="kobospan" id="kobo.876.1">Data collection</span></strong><span class="kobospan" id="kobo.877.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.878.1">Hosts</span></strong><span class="kobospan" id="kobo.879.1"> and click on </span><strong class="source-inline1"><span class="kobospan" id="kobo.880.1">lar-book-jmx</span></strong><span class="kobospan" id="kobo.881.1">. </span><span class="kobospan" id="kobo.881.2">We will add our template to </span><span><span class="kobospan" id="kobo.882.1">this host.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.883.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.884.1">Templates</span></strong><span class="kobospan" id="kobo.885.1"> and add the template, </span><span><span class="kobospan" id="kobo.886.1">like</span><a id="_idTextAnchor1465" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.887.1"> this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer437">
<span class="kobospan" id="kobo.888.1"><img alt="Figure 7.43 – Data collection | Host – add a template to the lar-book-jmx host" src="image/B19803_07_43.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.889.1">Figure 7.43 – Data collection | Host – add a template to the lar-book-jmx host</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.890.1">Cl</span><a id="_idTextAnchor1466" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.891.1">ick on the blue </span><span><strong class="bold"><span class="kobospan" id="kobo.892.1">Update</span></strong></span><span><span class="kobospan" id="kobo.893.1"> button.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.894.1">When we </span><a id="_idIndexMarker566" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.895.1">navigate to </span><strong class="bold"><span class="kobospan" id="kobo.896.1">Monitoring</span></strong><span class="kobospan" id="kobo.897.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.898.1">Latest data</span></strong><span class="kobospan" id="kobo.899.1"> now, we will select </span><strong class="source-inline1"><span class="kobospan" id="kobo.900.1">lar-book-jmx</span></strong><span class="kobospan" id="kobo.901.1"> for </span><strong class="bold"><span class="kobospan" id="kobo.902.1">Hosts</span></strong><span class="kobospan" id="kobo.903.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.904.1">component</span></strong><span class="kobospan" id="kobo.905.1"> for </span><strong class="bold"><span class="kobospan" id="kobo.906.1">Tags</span></strong><span class="kobospan" id="kobo.907.1"> with </span><strong class="source-inline1"><span class="kobospan" id="kobo.908.1">memory pool</span></strong><span class="kobospan" id="kobo.909.1"> as its value, </span><span><span class="kobospan" id="kobo.910.1">like</span><a id="_idTextAnchor1467" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.911.1"> this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer438">
<span class="kobospan" id="kobo.912.1"><img alt="Figure 7.44 – The Monitoring | Latest data page filters – the lar-book-jmx host" src="image/B19803_07_44.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.913.1">Figure 7.44 – The Monitoring | Latest data page filters – the lar-book-jmx host</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.914.1">We will then see the </span><span><span class="kobospan" id="kobo.915.1">following res</span><a id="_idTextAnchor1468" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.916.1">ults:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer439">
<span class="kobospan" id="kobo.917.1"><img alt="Figure 7.45 – The Monitoring | Latest data page for the lar-book-jmx host with our re﻿﻿sults" src="image/B19803_07_45.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.918.1">Figure 7.45 – The Monitoring | Latest data page for the lar-book-jmx host with our re</span><a id="_idTextAnchor1469" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1470" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.919.1">sults</span></p>
<h2 id="_idParaDest-248" class="calibre7"><a id="_idTextAnchor1471" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.920.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.921.1">Monitoring JMX </span><a id="_idIndexMarker567" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.922.1">applications can be quite daunting at first, as there is a lot of work to figu</span><a id="_idTextAnchor1472" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.923.1">re out while building your own LLD rules. </span><span class="kobospan" id="kobo.923.2">But now that you’ve built your first LLD rule for JMX, there is a clear structure </span><span><span class="kobospan" id="kobo.924.1">in it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.925.1">First, for our discovery rule, we’ve picked the </span><span><span class="kobospan" id="kobo.926.1">item key:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.927.1">
jmx.discovery[beans,"*:type=MemoryPool,name=*"]</span></pre> <p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.928.1">MemoryPool</span></strong><span class="kobospan" id="kobo.929.1"> is w</span><a id="_idTextAnchor1473" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.930.1">hat we </span><a id="_idIndexMarker568" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.931.1">call an </span><strong class="bold"><span class="kobospan" id="kobo.932.1">MBean</span></strong><span class="kobospan" id="kobo.933.1"> in Java. </span><span class="kobospan" id="kobo.933.2">We poll this MBean object for several JMX objects and fill the </span><span><span class="kobospan" id="kobo.934.1">macros accordingly.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.935.1">We picked the </span><strong class="source-inline"><span class="kobospan" id="kobo.936.1">name=*</span></strong><span class="kobospan" id="kobo.937.1"> object to fill the </span><strong class="source-inline"><span class="kobospan" id="kobo.938.1">{#JMXNAME}</span></strong><span class="kobospan" id="kobo.939.1"> macro in this discovery rule. </span><span class="kobospan" id="kobo.939.2">Our macro is then used in our item prototype to create </span><span><span class="kobospan" id="kobo.940.1">our items.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.941.1">Our items are then created, </span><span><span class="kobospan" id="kobo.942.1">like</span><a id="_idTextAnchor1474" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.943.1"> this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer440">
<span class="kobospan" id="kobo.944.1"><img alt="Figure 7.46 – Items on our JMX-monitored host" src="image/B19803_07_46.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.945.1">Figure 7.46 – Items on our JMX-monitored host</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.946.1">If we look at the keys of the items, we can see that we poll the </span><strong class="source-inline"><span class="kobospan" id="kobo.947.1">Type</span></strong><span class="kobospan" id="kobo.948.1"> JMX attribute on every </span><strong class="source-inline"><span class="kobospan" id="kobo.949.1">MemoryPool</span></strong><span class="kobospan" id="kobo.950.1"> with </span><span><span class="kobospan" id="kobo.951.1">different names.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.952.1">That’s how we create JMX LLD rules </span><span><span class="kobospan" id="kobo.953.1">with</span><a id="_idTextAnchor1475" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1476" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.954.1"> ease.</span></span></p>
<h2 id="_idParaDest-249" class="calibre7"><a id="_idTextAnchor1477" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.955.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.956.1">If y</span><a id="_idTextAnchor1478" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.957.1">ou are not familiar with MBeans, then make sure to check out the Java documentation. </span><span class="kobospan" id="kobo.957.2">This will explain to you a lot about what MBeans are and how they can be used for monitoring JMX </span><span><span class="kobospan" id="kobo.958.1">attributes: </span></span><a href="https://docs.oracle.com/javase/tutorial/jmx/mbeans/index.html" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.959.1">https://docs.oracle.com/javase/tutorial/jmx/mbeans/index.html</span></span></a><span><span class="kobospan" id="kobo.960.1">.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.961.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.962.1">Before </span><a id="_idTextAnchor1479" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.963.1">diving deeper into using JMX object discovery, dive deeper into the preceding JMX object documentation. </span><span class="kobospan" id="kobo.963.2">There’s a lot of information in it and it will greatly improve your skills in creating these </span><span><span class="kobospan" id="kobo.964.1">LLD rules.</span></span></p>
<h2 id="_idParaDest-250" class="calibre7"><a id="_idTextAnchor1480" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.965.1">Setting up Zabbix SNMP LLD the new way</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.966.1">Zabbix 6.4 introduced an</span><a id="_idIndexMarker569" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.967.1"> overhaul to using SNMP in our Zabbix environments. </span><span class="kobospan" id="kobo.967.2">Although the old way is still available (and explained in this book) as an option, it might be better to use the new way to build your SNMP monitoring as it will actually use the </span><strong class="source-inline"><span class="kobospan" id="kobo.968.1">GetBulk</span></strong><span class="kobospan" id="kobo.969.1"> requests. </span><span class="kobospan" id="kobo.969.2">This makes SNMP monitoring a lot more efficient and less strenuous on the SNMP device we are collecting </span><span><span class="kobospan" id="kobo.970.1">data from.</span></span></p>
<h2 id="_idParaDest-251" class="calibre7"><a id="_idTextAnchor1481" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.971.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.972.1">Before starting with the recipe, please make sure to read </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.973.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.974.1">, </span><em class="italic"><span class="kobospan" id="kobo.975.1">Setting Up SNMP Monitoring the New Way</span></em><span class="kobospan" id="kobo.976.1">, first. </span><span class="kobospan" id="kobo.976.2">We will need the knowledge from that chapter to set up SNMP LLD discovery as well as we will use some hosts and items from that chapter. </span><span class="kobospan" id="kobo.976.3">Make sure you have </span><span><span class="kobospan" id="kobo.977.1">the following:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.978.1">Your </span><span><span class="kobospan" id="kobo.979.1">Zabbix environment</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.980.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.981.1">lar-book-snmp_bulk</span></strong><span class="kobospan" id="kobo.982.1"> host as set up in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.983.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.984.1">, </span><em class="italic"><span class="kobospan" id="kobo.985.1">Setting Up </span></em><span><em class="italic"><span class="kobospan" id="kobo.986.1">Zabbix Monitoring</span></em></span></li>
</ul>
<h2 id="_idParaDest-252" class="calibre7"><a id="_idTextAnchor1482" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.987.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.988.1">As we have already set up the SNMP server to start monitoring in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.989.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.990.1">, </span><em class="italic"><span class="kobospan" id="kobo.991.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.992.1">, we can start immediately on the frontend. </span><span class="kobospan" id="kobo.992.2">In </span><a href="B19803_05.xhtml#_idTextAnchor809" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.993.1">Chapter 5</span></em></span></a><span class="kobospan" id="kobo.994.1">, </span><em class="italic"><span class="kobospan" id="kobo.995.1">Building your own Structured Templates</span></em><span class="kobospan" id="kobo.996.1">, we also learned about creating templates for all our monitoring, so let’s start by doing that. </span><span class="kobospan" id="kobo.996.2">Follow </span><span><span class="kobospan" id="kobo.997.1">these steps:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.998.1">In the Zabbix frontend, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.999.1">Data collection</span></strong><span class="kobospan" id="kobo.1000.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1001.1">Templates</span></strong><span class="kobospan" id="kobo.1002.1"> and click on </span><strong class="bold"><span class="kobospan" id="kobo.1003.1">Create template</span></strong><span class="kobospan" id="kobo.1004.1"> in the top-right corner. </span><span class="kobospan" id="kobo.1004.2">We will create a new template </span><span><span class="kobospan" id="kobo.1005.1">as follows.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer441">
<span class="kobospan" id="kobo.1006.1"><img alt="Figure 7.47 – The BOOK Linux by SNMP template" src="image/B19803_07_47.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1007.1">Figure 7.47 – The BOOK Linux by SNMP template</span></p>
<ol class="calibre16">
<li value="2" class="calibre15"><span class="kobospan" id="kobo.1008.1">Also, make sure to switch to the </span><strong class="bold"><span class="kobospan" id="kobo.1009.1">Tags</span></strong><span class="kobospan" id="kobo.1010.1"> tab to add some tags according to the new </span><span><span class="kobospan" id="kobo.1011.1">tag policy:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer442">
<span class="kobospan" id="kobo.1012.1"><img alt="Figure 7.48 – Template BOOK Linux by SNMP Macros tab" src="image/B19803_07_48.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1013.1">Figure 7.48 – Template BOOK Linux by SNMP Macros tab</span></p>
<ol class="calibre16">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.1014.1">At the bottom </span><a id="_idIndexMarker570" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1015.1">of the window, click on the big </span><strong class="bold"><span class="kobospan" id="kobo.1016.1">Add</span></strong><span class="kobospan" id="kobo.1017.1"> button to finish setting up this </span><span><span class="kobospan" id="kobo.1018.1">new template.</span></span><p class="calibre3"><span class="kobospan" id="kobo.1019.1">We already created a value mapping and some items on the </span><strong class="source-inline"><span class="kobospan" id="kobo.1020.1">lar-book-snmp_bulk</span></strong><span class="kobospan" id="kobo.1021.1"> host we set up earlier. </span><span class="kobospan" id="kobo.1021.2">Let’s start by using the mass update functionally to copy the value mapping to our </span><span><span class="kobospan" id="kobo.1022.1">new template.</span></span></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.1023.1">Select your template in the list with the checkbox and click on the big </span><strong class="bold"><span class="kobospan" id="kobo.1024.1">Mass update</span></strong><span class="kobospan" id="kobo.1025.1"> button at the bottom of </span><span><span class="kobospan" id="kobo.1026.1">the window.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer443">
<span class="kobospan" id="kobo.1027.1"><img alt="Figure 7.49 – Mass update" src="image/B19803_07_49.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1028.1">Figure 7.49 – Mass update</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.1029.1">At </span><strong class="bold"><span class="kobospan" id="kobo.1030.1">Mass update</span></strong><span class="kobospan" id="kobo.1031.1">, switch to the </span><strong class="bold"><span class="kobospan" id="kobo.1032.1">Value mapping</span></strong><span class="kobospan" id="kobo.1033.1"> tab, check the box, and click on the small dotted underlined </span><strong class="bold"><span class="kobospan" id="kobo.1034.1">Add from </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.1035.1">host</span></strong></span><span><span class="kobospan" id="kobo.1036.1"> button.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1037.1">Find your </span><strong class="source-inline1"><span class="kobospan" id="kobo.1038.1">lar-book-snmp_bulk</span></strong><span class="kobospan" id="kobo.1039.1"> host and select </span><strong class="bold"><span class="kobospan" id="kobo.1040.1">Interface Up/Down</span></strong><span class="kobospan" id="kobo.1041.1"> from the list. </span><span class="kobospan" id="kobo.1041.2">It should look </span><span><span class="kobospan" id="kobo.1042.1">like this.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer444">
<span class="kobospan" id="kobo.1043.1"><img alt="Figure 7.50 – Mass update – add value mapping from the host" src="image/B19803_07_50.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1044.1">Figure 7.50 – Mass update – add value mapping from the host</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.1045.1">You can now </span><a id="_idIndexMarker571" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1046.1">press the big </span><strong class="bold"><span class="kobospan" id="kobo.1047.1">Update</span></strong><span class="kobospan" id="kobo.1048.1"> button at the bottom of the window to add this </span><span><span class="kobospan" id="kobo.1049.1">value mapping.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1050.1">Now, let’s copy over our existing items from the template. </span><span class="kobospan" id="kobo.1050.2">Go to </span><strong class="bold"><span class="kobospan" id="kobo.1051.1">Data collection</span></strong><span class="kobospan" id="kobo.1052.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1053.1">Hosts</span></strong><span class="kobospan" id="kobo.1054.1"> and go to </span><strong class="bold"><span class="kobospan" id="kobo.1055.1">Items</span></strong><span class="kobospan" id="kobo.1056.1"> for </span><strong class="source-inline1"><span class="kobospan" id="kobo.1057.1">lar-book-snmp_bulk</span></strong><span class="kobospan" id="kobo.1058.1">. </span><span class="kobospan" id="kobo.1058.2">Select the two items we created earlier and click on </span><strong class="bold"><span class="kobospan" id="kobo.1059.1">Copy</span></strong><span class="kobospan" id="kobo.1060.1"> at the bottom of </span><span><span class="kobospan" id="kobo.1061.1">the window.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer445">
<span class="kobospan" id="kobo.1062.1"><img alt="Figure 7.51 – The lar-book-snmp_bulk items to copy" src="image/B19803_07_51.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1063.1">Figure 7.51 – The lar-book-snmp_bulk items to copy</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.1064.1">Set </span><strong class="bold"><span class="kobospan" id="kobo.1065.1">Target type</span></strong><span class="kobospan" id="kobo.1066.1"> to </span><strong class="bold"><span class="kobospan" id="kobo.1067.1">Templates</span></strong><span class="kobospan" id="kobo.1068.1"> and type in </span><strong class="source-inline1"><span class="kobospan" id="kobo.1069.1">BOOK Linux by SNMP</span></strong><span class="kobospan" id="kobo.1070.1">. </span><span class="kobospan" id="kobo.1070.2">Select it and then </span><span><span class="kobospan" id="kobo.1071.1">press </span></span><span><strong class="bold"><span class="kobospan" id="kobo.1072.1">Copy</span></strong></span><span><span class="kobospan" id="kobo.1073.1">.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer446">
<span class="kobospan" id="kobo.1074.1"><img alt="Figure 7.52 – The lar-book-snmp_bulk items copy window" src="image/B19803_07_52.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1075.1">Figure 7.52 – The lar-book-snmp_bulk items copy window</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.1076.1">Now, go back to </span><strong class="bold"><span class="kobospan" id="kobo.1077.1">Data collection</span></strong><span class="kobospan" id="kobo.1078.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1079.1">Templates</span></strong><span class="kobospan" id="kobo.1080.1"> and click on </span><strong class="bold"><span class="kobospan" id="kobo.1081.1">Discovery</span></strong><span class="kobospan" id="kobo.1082.1"> for your </span><strong class="bold"><span class="kobospan" id="kobo.1083.1">BOOK Linux by </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.1084.1">SNMP</span></strong></span><span><span class="kobospan" id="kobo.1085.1"> template.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1086.1">In the top-right corner, click on the </span><strong class="bold"><span class="kobospan" id="kobo.1087.1">Create discovery rule</span></strong><span class="kobospan" id="kobo.1088.1"> button. </span><span class="kobospan" id="kobo.1088.2">We will create the</span><a id="_idIndexMarker572" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1089.1"> following LLD </span><span><span class="kobospan" id="kobo.1090.1">rule here.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer447">
<span class="kobospan" id="kobo.1091.1"><img alt="Figure 7.53 – Discovery rule" src="image/B19803_07_53.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1092.1">Figure 7.53 – Discovery rule</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1093.1">We will make the LLD rule of the </span><strong class="bold"><span class="kobospan" id="kobo.1094.1">Dependent item</span></strong><span class="kobospan" id="kobo.1095.1"> type to make sure we use the data collected in bulk earlier on the </span><strong class="bold"><span class="kobospan" id="kobo.1096.1">SNMP interfaces bulk</span></strong><span class="kobospan" id="kobo.1097.1"> item. </span><span class="kobospan" id="kobo.1097.2">However, all LLD data has to be presented in the JSON data format, so let’s make sure to convert the </span><span><span class="kobospan" id="kobo.1098.1">data first.</span></span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.1099.1">Switch to the </span><strong class="bold"><span class="kobospan" id="kobo.1100.1">Preprocessing</span></strong><span class="kobospan" id="kobo.1101.1"> tab and add </span><span><span class="kobospan" id="kobo.1102.1">the following.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer448">
<span class="kobospan" id="kobo.1103.1"><img alt="Figure 7.54 – Preprocessing" src="image/B19803_07_54.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1104.1">Figure 7.54 – Preprocessing</span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.1105.1">Now, press the big </span><strong class="bold"><span class="kobospan" id="kobo.1106.1">Add</span></strong><span class="kobospan" id="kobo.1107.1"> button at the bottom of the window to add the LLD rule. </span><span class="kobospan" id="kobo.1107.2">Then, go to </span><strong class="bold"><span class="kobospan" id="kobo.1108.1">Item prototypes</span></strong><span class="kobospan" id="kobo.1109.1"> to add our first item in an </span><span><span class="kobospan" id="kobo.1110.1">automated manner.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1111.1">In the top-right corner, press </span><strong class="bold"><span class="kobospan" id="kobo.1112.1">Create item prototype</span></strong><span class="kobospan" id="kobo.1113.1"> and create the following </span><span><span class="kobospan" id="kobo.1114.1">item prototype:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer449">
<span class="kobospan" id="kobo.1115.1"><img alt="Figure 7.55 – Item prototype" src="image/B19803_07_55.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1116.1">Figure 7.55 – Item prototype</span></p>
<ol class="calibre16">
<li value="15" class="calibre15"><span class="kobospan" id="kobo.1117.1">Don’t forget</span><a id="_idIndexMarker573" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1118.1"> to add your tags at the </span><strong class="bold"><span class="kobospan" id="kobo.1119.1">Tags</span></strong><span class="kobospan" id="kobo.1120.1"> tab before adding the </span><span><span class="kobospan" id="kobo.1121.1">item prototype:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer450">
<span class="kobospan" id="kobo.1122.1"><img alt="Figure 7.56 – Item tags" src="image/B19803_07_56.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1123.1">Figure 7.56 – Item tags</span></p>
<ol class="calibre16">
<li value="16" class="calibre15"><span class="kobospan" id="kobo.1124.1">We will need a preprocessing step to extract the right information as well, so let’s add that too by going to the </span><span><strong class="bold"><span class="kobospan" id="kobo.1125.1">Preprocessing</span></strong></span><span><span class="kobospan" id="kobo.1126.1"> tab:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer451">
<span class="kobospan" id="kobo.1127.1"><img alt="Figure 7.57 – Preprocessing" src="image/B19803_07_57.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1128.1">Figure 7.57 – Preprocessing</span></p>
<ol class="calibre16">
<li value="17" class="calibre15"><span class="kobospan" id="kobo.1129.1">Now, press </span><a id="_idIndexMarker574" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1130.1">the big </span><strong class="bold"><span class="kobospan" id="kobo.1131.1">Add</span></strong><span class="kobospan" id="kobo.1132.1"> button at the bottom of the page to finish setting up this new </span><span><span class="kobospan" id="kobo.1133.1">item prototype.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1134.1">We aren’t using the template on our host yet, so let’s navigate to </span><strong class="bold"><span class="kobospan" id="kobo.1135.1">Data collection</span></strong><span class="kobospan" id="kobo.1136.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1137.1">Hosts</span></strong><span class="kobospan" id="kobo.1138.1"> and click on our </span><strong class="source-inline1"><span class="kobospan" id="kobo.1139.1">lar-book-snmp_bulk</span></strong><span class="kobospan" id="kobo.1140.1"> host. </span><span class="kobospan" id="kobo.1140.2">Then, add </span><span><span class="kobospan" id="kobo.1141.1">the template.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer452">
<span class="kobospan" id="kobo.1142.1"><img alt="Figure 7.58 – Adding the BOOK Linux by SNMP template to lar-book-snmp_bulk" src="image/B19803_07_58.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1143.1">Figure 7.58 – Adding the BOOK Linux by SNMP template to lar-book-snmp_bulk</span></p>
<ol class="calibre16">
<li value="19" class="calibre15"><span class="kobospan" id="kobo.1144.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.1145.1">Update</span></strong><span class="kobospan" id="kobo.1146.1"> at the bottom of the window to add </span><span><span class="kobospan" id="kobo.1147.1">the template.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1148.1">The LLD rule should now be added and executed. </span><span class="kobospan" id="kobo.1148.2">Let’s see whether the items are created by navigating to </span><strong class="bold"><span class="kobospan" id="kobo.1149.1">Monitoring</span></strong><span class="kobospan" id="kobo.1150.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1151.1">Latest data</span></strong><span class="kobospan" id="kobo.1152.1"> and filtering on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1153.1">lar-book-snmp_bulk</span></strong><span class="kobospan" id="kobo.1154.1"> host. </span><span class="kobospan" id="kobo.1154.2">Please keep in mind it can take around one minute for</span><a id="_idIndexMarker575" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1155.1"> the item to show up and another minute for it to </span><span><span class="kobospan" id="kobo.1156.1">collect data.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer453">
<span class="kobospan" id="kobo.1157.1"><img alt="Figure 7.59 – lar-book-snmp_bulk – latest data after LLD rule" src="image/B19803_07_59.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1158.1">Figure 7.59 – lar-book-snmp_bulk – latest data after LLD rule</span></p>
<h2 id="_idParaDest-253" class="calibre7"><a id="_idTextAnchor1483" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1159.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1160.1">So, how does this new LLD discovery work? </span><span class="kobospan" id="kobo.1160.2">As you might have noticed, we are still using the same item as we used in </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.1161.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.1162.1">, </span><em class="italic"><span class="kobospan" id="kobo.1163.1">Setting Up Zabbix Monitoring</span></em><span class="kobospan" id="kobo.1164.1">. </span><span class="kobospan" id="kobo.1164.2">The values are for everything under OID </span><strong class="source-inline"><span class="kobospan" id="kobo.1165.1">.1.3.6.1.2.1.2.2.1</span></strong><span class="kobospan" id="kobo.1166.1"> are being collected in bulk still. </span><span class="kobospan" id="kobo.1166.2">As a remember of the bulk metric collection, let’s have another look at </span><span><span class="kobospan" id="kobo.1167.1">the data:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer454">
<span class="kobospan" id="kobo.1168.1"><img alt="Figure 7.60 – The lar-book-snmp_bulk raw bulk metrics" src="image/B19803_07_60.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1169.1">Figure 7.60 – The lar-book-snmp_bulk raw bulk metrics</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1170.1">We have all the data we need right there in the SNMP walk item. </span><span class="kobospan" id="kobo.1170.2">All of the items and discovery rules we then added afterward are using that data and parsing it internally using the Zabbix server (or proxy) </span><span><span class="kobospan" id="kobo.1171.1">preprocessing processes.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1172.1">In the case of LLD, we have to add the SNMP walk to JSON preprocessing step, as you can see in </span><span><em class="italic"><span class="kobospan" id="kobo.1173.1">Figure 7</span></em></span><em class="italic"><span class="kobospan" id="kobo.1174.1">.54</span></em><span class="kobospan" id="kobo.1175.1">, which is what will convert the normal SNMP walk data to a JSON data format. </span><span class="kobospan" id="kobo.1175.2">It</span><a id="_idIndexMarker576" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1176.1"> will look like </span><span><span class="kobospan" id="kobo.1177.1">this afterward:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer455">
<span class="kobospan" id="kobo.1178.1"><img alt="Figure 7.61 – The lar-book-snmp_bulk raw bulk metrics converted to JSON" src="image/B19803_07_61.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1179.1">Figure 7.61 – The lar-book-snmp_bulk raw bulk metrics converted to JSON</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1180.1">It collects the values we want by finding the OID </span><strong class="source-inline"><span class="kobospan" id="kobo.1181.1">.1.3.6.1.2.1.2.2.1.2</span></strong><span class="kobospan" id="kobo.1182.1"> and adding its values to the </span><strong class="source-inline"><span class="kobospan" id="kobo.1183.1">{#IFDESCR}</span></strong><span class="kobospan" id="kobo.1184.1"> discovery macro. </span><span class="kobospan" id="kobo.1184.2">It also retains the SNMP index and it’s it to the </span><strong class="source-inline"><span class="kobospan" id="kobo.1185.1">{#</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.1186.1">SNMPINDEX}</span></strong></span><span><span class="kobospan" id="kobo.1187.1"> macro.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1188.1">Now, all that’s left to do is set up our item prototypes and use the same raw SNMP walk item to extract data with the preprocessing step SNMP walk value as we see in </span><span><em class="italic"><span class="kobospan" id="kobo.1189.1">Figure 7</span></em></span><em class="italic"><span class="kobospan" id="kobo.1190.1">.57</span></em><span class="kobospan" id="kobo.1191.1">. </span><span class="kobospan" id="kobo.1191.2">We also have to make sure it’s unique for each item, so we add the </span><strong class="source-inline"><span class="kobospan" id="kobo.1192.1">{#SNMPINDEX}</span></strong><span class="kobospan" id="kobo.1193.1"> macro to find the correct value for every item that will </span><span><span class="kobospan" id="kobo.1194.1">be created.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1195.1">Just like that, we did a single SNMP </span><strong class="source-inline"><span class="kobospan" id="kobo.1196.1">GetBulk</span></strong><span class="kobospan" id="kobo.1197.1"> call in the </span><strong class="bold"><span class="kobospan" id="kobo.1198.1">SNMP interfaces bulk</span></strong><span class="kobospan" id="kobo.1199.1"> item and used the power of Zabbix-dependent items and preprocessing to split it </span><span><span class="kobospan" id="kobo.1200.1">up further.</span></span></p>
<h1 id="_idParaDest-254" class="calibre5"><a id="_idTextAnchor1484" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1201.1">Creating hosts with LLD and custom JSON</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1202.1">Creating hosts</span><a id="_idIndexMarker577" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1203.1"> from LLD works the same as creating anything else from</span><a id="_idIndexMarker578" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1204.1"> LLD rules. </span><span class="kobospan" id="kobo.1204.2">We will simply feed our Zabbix installation with a compatible JSON formatted dataset and use that data to create new hosts. </span><span class="kobospan" id="kobo.1204.3">However, starting with Zabbix 6.2, something has changed. </span><span class="kobospan" id="kobo.1204.4">Hosts created by LLD are now customizable after creation, so, let’s have a look at how to do it and how </span><span><span class="kobospan" id="kobo.1205.1">it works.</span></span></p>
<h2 id="_idParaDest-255" class="calibre7"><a id="_idTextAnchor1485" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1206.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1207.1">For this recipe, we are going to need two things: any Zabbix 7 installation and a compatible JSON-formatted dataset containing hosts and their data. </span><span class="kobospan" id="kobo.1207.2">Some good default template examples to create hosts from LLD are </span><span><span class="kobospan" id="kobo.1208.1">as follows:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.1209.1">VMware host </span><span><span class="kobospan" id="kobo.1210.1">and hypervisors</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.1211.1">Kubernetes</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1212.1">Azure </span><span><span class="kobospan" id="kobo.1213.1">and AWS</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1214.1">For the example, however, we will be using a custom dataset, which you can find on GitHub </span><span><span class="kobospan" id="kobo.1215.1">here: </span></span><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/blob/main/chapter07/lldhosts.json" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.1216.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/blob/main/chapter07/lldhosts.json</span></span></a><span><span class="kobospan" id="kobo.1217.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1218.1">It’s also important to have a basic understanding of Zabbix sender, dependent items, and preprocessing. </span><span class="kobospan" id="kobo.1218.2">I recommend reading the following recipes from </span><a href="B19803_03_split_000.xhtml#_idTextAnchor306" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.1219.1">Chapter 3</span></em></span></a><span class="kobospan" id="kobo.1220.1">, </span><em class="italic"><span class="kobospan" id="kobo.1221.1">Setting Up Zabbix </span></em><span><em class="italic"><span class="kobospan" id="kobo.1222.1">Monitoring</span></em></span><span><span class="kobospan" id="kobo.1223.1">, first:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><em class="italic"><span class="kobospan" id="kobo.1224.1">Creating Zabbix simple checks and the </span></em><span><em class="italic"><span class="kobospan" id="kobo.1225.1">Zabbix trapper</span></em></span></li>
<li class="calibre15"><em class="italic"><span class="kobospan" id="kobo.1226.1">Working with calculated and </span></em><span><em class="italic"><span class="kobospan" id="kobo.1227.1">dependent items</span></em></span></li>
<li class="calibre15"><em class="italic"><span class="kobospan" id="kobo.1228.1">Using Zabbix preprocessing to alter </span></em><span><em class="italic"><span class="kobospan" id="kobo.1229.1">item values</span></em></span></li>
</ul>
<h2 id="_idParaDest-256" class="calibre7"><a id="_idTextAnchor1486" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1230.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1231.1">Let’s get started on building this new LLD rule with a custom JSON dataset. </span><span class="kobospan" id="kobo.1231.2">To do that, we will first need to build a JSON file or get it from some of our own data sources. </span><span class="kobospan" id="kobo.1231.3">We have one prepared </span><span><span class="kobospan" id="kobo.1232.1">for you:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.1233.1">First, let’s have a look at the JSON file </span><span><span class="kobospan" id="kobo.1234.1">located here:</span></span><p class="calibre3"><a href="https://raw.githubusercontent.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/main/chapter07/lldhosts.json" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.1235.1">https://raw.githubusercontent.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/main/chapter07/lldhosts.json</span></span></a></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.1236.1">Next up, let’s log in to the Zabbix server CLI and make sure we have our Zabbix sender application installed. </span><span class="kobospan" id="kobo.1236.2">We are going to use this to send the file to our </span><span><span class="kobospan" id="kobo.1237.1">Zabbix environment:</span></span><p class="calibre3"><span class="kobospan" id="kobo.1238.1">For RHEL-bas</span><a id="_idTextAnchor1487" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1239.1">ed systems, use </span><span><span class="kobospan" id="kobo.1240.1">the following:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1241.1">dnf install zabbix-sender</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.1242.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.1243.1">the following:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.1244.1">apt install zabbix-sender</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1245.1">Let’s set </span><a id="_idIndexMarker579" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1246.1">up</span><a id="_idIndexMarker580" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1247.1"> the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1248.1">zabbix-sender</span></strong><span class="kobospan" id="kobo.1249.1"> application to send this JSON file to our system every minute. </span><span class="kobospan" id="kobo.1249.2">We will use a CronJob to make things easy </span><span><span class="kobospan" id="kobo.1250.1">for now:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1251.1">crontab -e</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1252.1">Add the following to the </span><span><span class="kobospan" id="kobo.1253.1">CronJob file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.1254.1">
* * * * * zabbix_sender -z 127.0.0.1 -s lar-lldhost-creation -k lldhosts.raw -o '[{"vmname":"lar-lld-host1","vmip":"10.16.16.200","vmlocation":"Amsterdam"},{"vmname":"lar-lld-host2","vmip":"10.16.16.201","vmlocation":"London"},{"vmname":"lar-lld-host3","vmip":"10.16.16.202","vmlocation":"Chicago"},{"vmname":"lar-lld-host4","vmip":"10.16.16.203","vmlocation":"Tirana"}]' &gt;/dev/null 2&gt;&amp;1</span></pre><p class="calibre3"><span class="kobospan" id="kobo.1255.1">The preceding is just the CronJob + Zabbix sender command built up </span><span><span class="kobospan" id="kobo.1256.1">as follows:</span></span></p><pre class="source-code"><span class="kobospan1" id="kobo.1257.1">* * * * *
zabbix_sender -z 127.0.0.1 -s lar-lldhost-creation -k lldhosts.raw -o
FILE CONTENT FROM GITHUB
&gt;/dev/null 2&gt;&amp;1</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1258.1">Now, let’s switch to our Zabbix frontend where we will add a host to receive the JSON </span><span><span class="kobospan" id="kobo.1259.1">file from.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1260.1">To add the host, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.1261.1">Data collection</span></strong><span class="kobospan" id="kobo.1262.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1263.1">Hosts</span></strong><span class="kobospan" id="kobo.1264.1"> and click on the </span><strong class="bold"><span class="kobospan" id="kobo.1265.1">Create host</span></strong><span class="kobospan" id="kobo.1266.1"> button in the top-right corner. </span><span class="kobospan" id="kobo.1266.2">Add the </span><span><span class="kobospan" id="kobo.1267.1">following host:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer456">
<span class="kobospan" id="kobo.1268.1"><img alt="Figure 7.62 – The Zabbix host creation window for the lar-lldhost-creation host" src="image/B19803_07_62.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1269.1">Figure 7.62 – The Zabbix host creation window for the lar-lldhost-creation host</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.1270.1">Click on </span><a id="_idIndexMarker581" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1271.1">the </span><strong class="bold"><span class="kobospan" id="kobo.1272.1">Add</span></strong><span class="kobospan" id="kobo.1273.1"> button</span><a id="_idIndexMarker582" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1274.1"> at the bottom of the window to finish creating this host. </span><span class="kobospan" id="kobo.1274.2">You will be brought back to </span><strong class="bold"><span class="kobospan" id="kobo.1275.1">Data collection</span></strong><span class="kobospan" id="kobo.1276.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.1277.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.1278.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1279.1">On this page, click on </span><strong class="bold"><span class="kobospan" id="kobo.1280.1">Items</span></strong><span class="kobospan" id="kobo.1281.1"> next to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1282.1">lar-lldhost-creation</span></strong><span class="kobospan" id="kobo.1283.1"> host we just created. </span><span class="kobospan" id="kobo.1283.2">In the top-right corner, click on </span><strong class="bold"><span class="kobospan" id="kobo.1284.1">Create item</span></strong><span class="kobospan" id="kobo.1285.1"> and create the </span><span><span class="kobospan" id="kobo.1286.1">following item:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer457">
<span class="kobospan" id="kobo.1287.1"><img alt="Figure 7.63 – The Zabbix item creation page for the lar-lldhost-creation host" src="image/B19803_07_63.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1288.1">Figure 7.63 – The Zabbix item creation page for the lar-lldhost-creation host</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.1289.1">Make sure to also add a tag to </span><span><span class="kobospan" id="kobo.1290.1">the item:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer458">
<span class="kobospan" id="kobo.1291.1"><img alt="Figure 7.64 – The Zabbix tag creation page for the lldhosts.raw item" src="image/B19803_07_64.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1292.1">Figure 7.64 – The Zabbix tag creation page for the lldhosts.raw item</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.1293.1">Now, press the big </span><strong class="bold"><span class="kobospan" id="kobo.1294.1">Add</span></strong><span class="kobospan" id="kobo.1295.1"> button at the bottom of the page. </span><span class="kobospan" id="kobo.1295.2">After the Zabbix server reloads its configuration cache, we should see data coming into this item within a minute </span><span><span class="kobospan" id="kobo.1296.1">or two.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1297.1">Meanwhile, we can start building the LLD rule. </span><span class="kobospan" id="kobo.1297.2">While still on the host edit page, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.1298.1">Discovery rules</span></strong><span class="kobospan" id="kobo.1299.1">. </span><span class="kobospan" id="kobo.1299.2">Click on </span><strong class="bold"><span class="kobospan" id="kobo.1300.1">Create discovery rule</span></strong><span class="kobospan" id="kobo.1301.1"> in the top-right corner. </span><span class="kobospan" id="kobo.1301.2">We</span><a id="_idIndexMarker583" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1302.1"> will </span><a id="_idIndexMarker584" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1303.1">add </span><span><span class="kobospan" id="kobo.1304.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer459">
<span class="kobospan" id="kobo.1305.1"><img alt="Figure 7.65 – The Zabbix LLD rule creation page for hosts.from.json" src="image/B19803_07_65.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1306.1">Figure 7.65 – The Zabbix LLD rule creation page for hosts.from.json</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.1307.1">Next, click on </span><strong class="bold"><span class="kobospan" id="kobo.1308.1">LLD macros</span></strong><span class="kobospan" id="kobo.1309.1">, and let’s define some macros to use from </span><span><span class="kobospan" id="kobo.1310.1">the file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.1311.1">
   {
      "vmname":"lar-lld-host1",
      "vmip":"10.16.16.200",
      "vmlocation":"Amsterdam"
   }</span></pre><p class="calibre3"><span class="kobospan" id="kobo.1312.1">We are going to use JSONPath to convert the preceding blocks of data to </span><span><span class="kobospan" id="kobo.1313.1">the following:</span></span></p><pre class="source-code"><span class="kobospan1" id="kobo.1314.1">   {
      "{#VMNAME}":"lar-lld-host1",
      "{#VMIP}":"10.16.16.200",
      "{#VMLOCATION}":"Amsterdam"
   }</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.1315.1">To do so, switch to</span><a id="_idIndexMarker585" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1316.1"> the </span><a id="_idIndexMarker586" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1317.1">tab called </span><strong class="bold"><span class="kobospan" id="kobo.1318.1">LLD macros</span></strong><span class="kobospan" id="kobo.1319.1"> and define </span><span><span class="kobospan" id="kobo.1320.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer460">
<span class="kobospan" id="kobo.1321.1"><img alt="Figure 7.66 – The Zabbix LLD macros tab for the hosts.from.json LLD rule" src="image/B19803_07_66.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1322.1">Figure 7.66 – The Zabbix LLD macros tab for the hosts.from.json LLD rule</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.1323.1">Now, we can click on the big </span><strong class="bold"><span class="kobospan" id="kobo.1324.1">Add</span></strong><span class="kobospan" id="kobo.1325.1"> button at the bottom of this page and the LLD rule </span><span><span class="kobospan" id="kobo.1326.1">is created.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1327.1">To do something with the LLD rule, however, we will have to create a new host prototype. </span><span class="kobospan" id="kobo.1327.2">To do so, click on </span><strong class="bold"><span class="kobospan" id="kobo.1328.1">Host prototypes</span></strong><span class="kobospan" id="kobo.1329.1"> and then </span><strong class="bold"><span class="kobospan" id="kobo.1330.1">Create host prototype</span></strong><span class="kobospan" id="kobo.1331.1"> in the top-right corner. </span><span class="kobospan" id="kobo.1331.2">We will add </span><span><span class="kobospan" id="kobo.1332.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer461">
<span class="kobospan" id="kobo.1333.1"><img alt="Figure 7.67 – The Zabbix LLD host prototype creation page" src="image/B19803_07_67.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1334.1">Figure 7.67 – The Zabbix LLD host prototype creation page</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1335.1">As you can see, we use our macros to create the name of the </span><strong class="bold"><span class="kobospan" id="kobo.1336.1">virtual machine</span></strong><span class="kobospan" id="kobo.1337.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.1338.1">VM</span></strong><span class="kobospan" id="kobo.1339.1">) as well</span><a id="_idIndexMarker587" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1340.1"> as make a unique </span><span><span class="kobospan" id="kobo.1341.1">host group.</span></span></p>
<ol class="calibre16">
<li value="16" class="calibre15"><span class="kobospan" id="kobo.1342.1">We will also </span><a id="_idIndexMarker588" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1343.1">define</span><a id="_idIndexMarker589" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1344.1"> an interface using our macro, by switching interface to </span><strong class="bold"><span class="kobospan" id="kobo.1345.1">Custom</span></strong><span class="kobospan" id="kobo.1346.1">, pressing the small underlined </span><strong class="bold"><span class="kobospan" id="kobo.1347.1">Add</span></strong><span class="kobospan" id="kobo.1348.1"> button, and adding </span><span><span class="kobospan" id="kobo.1349.1">the following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer462">
<span class="kobospan" id="kobo.1350.1"><img alt="Figure 7.68 – The Zabbix LLD host prototype creation page with a custom interface" src="image/B19803_07_68.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1351.1">Figure 7.68 – The Zabbix LLD host prototype creation page with a custom interface</span></p>
<ol class="calibre16">
<li value="17" class="calibre15"><span class="kobospan" id="kobo.1352.1">You can now press the big </span><strong class="bold"><span class="kobospan" id="kobo.1353.1">Add</span></strong><span class="kobospan" id="kobo.1354.1"> button at the bottom of the page. </span><span class="kobospan" id="kobo.1354.2">This will add the </span><span><span class="kobospan" id="kobo.1355.1">host prototype.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.1356.1">Now, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.1357.1">Data collection</span></strong><span class="kobospan" id="kobo.1358.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.1359.1">Hosts</span></strong><span class="kobospan" id="kobo.1360.1"> where, after waiting for a few minutes, we should see our </span><span><span class="kobospan" id="kobo.1361.1">new hosts:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer463">
<span class="kobospan" id="kobo.1362.1"><img alt="Figure 7.69 – Zabbix hosts created from LLD" src="image/B19803_07_69.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1363.1">Figure 7.69 – Zabbix hosts created from LLD</span></p>
<h2 id="_idParaDest-257" class="calibre7"><a id="_idTextAnchor1488" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1364.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1365.1">LLD is an extensive topic in the Zabbix world and, as such, it can become quite complicated. </span><span class="kobospan" id="kobo.1365.2">As we saw, we used a completely custom JSON file in </span><span><span class="kobospan" id="kobo.1366.1">this recipe.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1367.1">Before we dive</span><a id="_idIndexMarker590" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1368.1"> deeper</span><a id="_idIndexMarker591" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1369.1"> into what the results are, keep in mind that custom JSON can be created from anywhere. </span><span class="kobospan" id="kobo.1369.2">This could be a custom (Python, Perl, PowerShell) script, some API checks, or anything else. </span><span class="kobospan" id="kobo.1369.3">Also, sometimes, JSON is already provided by the Zabbix environment itself. </span><span class="kobospan" id="kobo.1369.4">As long as we follow the following format (with or without macros straight in the file), anything can be parsed to Zabbix </span><span><span class="kobospan" id="kobo.1370.1">LLD rules:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1371.1">
[
   {
      "vmname":"lar-lld-host1",
      "vmip":"10.16.16.200",
      "vmlocation":"Amsterdam"
   },
   {
      "vmname":"lar-lld-host2",
      "vmip":"10.16.16.201",
      "vmlocation":"London"
   },
   {
      "vmname":"lar-lld-host3",
      "vmip":"10.16.16.202",
      "vmlocation":"Chicago"
   },
   {
      "vmname":"lar-lld-host4",
      "vmip":"10.16.16.203",
      "vmlocation":"Tirana"
   }
]</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1372.1">Check out the following link for </span><span><span class="kobospan" id="kobo.1373.1">more examples:</span></span></p>
<p class="calibre3"><a href="https://www.zabbix.com/documentation/current/en/manual/discovery/low_level_discovery" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.1374.1">https://www.zabbix.com/documentation/current/en/manual/discovery/low_level_discovery</span></span></a></p>
<p class="calibre3"><span class="kobospan" id="kobo.1375.1">Now, what did we actually create with the preceding JSON file? </span><span class="kobospan" id="kobo.1375.2">Well, we used the </span><strong class="source-inline"><span class="kobospan" id="kobo.1376.1">vmname</span></strong><span class="kobospan" id="kobo.1377.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.1378.1">vmip</span></strong><span class="kobospan" id="kobo.1379.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.1380.1">vmlocation</span></strong><span class="kobospan" id="kobo.1381.1"> JSON keys and their values to create some custom hosts, fully </span><a id="_idIndexMarker592" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1382.1">automated. </span><span class="kobospan" id="kobo.1382.2">To</span><a id="_idIndexMarker593" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1383.1"> do that first, we have to use </span><strong class="bold"><span class="kobospan" id="kobo.1384.1">JSONPath</span></strong><span class="kobospan" id="kobo.1385.1"> to parse the JSON keys to the LLD macros every LLD </span><span><span class="kobospan" id="kobo.1386.1">rule needs:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer464">
<span class="kobospan" id="kobo.1387.1"><img alt="Figure 7.70 – JSONPath usage to convert keys to LLD macros" src="image/B19803_07_70.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1388.1">Figure 7.70 – JSONPath usage to convert keys to LLD macros</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1389.1">This converts </span><strong class="source-inline"><span class="kobospan" id="kobo.1390.1">vmip</span></strong><span class="kobospan" id="kobo.1391.1"> to </span><strong class="source-inline"><span class="kobospan" id="kobo.1392.1">{#VMIP}</span></strong><span class="kobospan" id="kobo.1393.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.1394.1">vmlocation</span></strong><span class="kobospan" id="kobo.1395.1"> to </span><strong class="source-inline"><span class="kobospan" id="kobo.1396.1">{#VMLOCATION}</span></strong><span class="kobospan" id="kobo.1397.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.1398.1">vmname</span></strong><span class="kobospan" id="kobo.1399.1"> to </span><strong class="source-inline"><span class="kobospan" id="kobo.1400.1">{#VMNAME}</span></strong><span class="kobospan" id="kobo.1401.1">. </span><strong class="bold"><span class="kobospan" id="kobo.1402.1">JSONPath</span></strong><span class="kobospan" id="kobo.1403.1"> is searching for the keys and Zabbix is converting them to macros </span><span><span class="kobospan" id="kobo.1404.1">for us.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1405.1">We then use these macros in the LLD host prototype to define what the values are going to be for </span><span><span class="kobospan" id="kobo.1406.1">each host:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer465">
<span class="kobospan" id="kobo.1407.1"><img alt="Figure 7.71 – Our LLD macros in use" src="image/B19803_07_71.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1408.1">Figure 7.71 – Our LLD macros in use</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1409.1">The result will be that our hosts are created with the </span><span><span class="kobospan" id="kobo.1410.1">correct settings:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer466">
<span class="kobospan" id="kobo.1411.1"><img alt="Figure 7.72 – lar-lld-host4 created by our LLD rule" src="image/B19803_07_72.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1412.1">Figure 7.72 – lar-lld-host4 created by our LLD rule</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1413.1">As you can see, our </span><a id="_idIndexMarker594" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1414.1">hostname is filled in, as is the custom host</span><a id="_idIndexMarker595" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1415.1"> group. </span><span class="kobospan" id="kobo.1415.2">We also have an interface defined with the correct IP. </span><span class="kobospan" id="kobo.1415.3">We will now use that IP on the interface to start monitoring Zabbix agent on the host with the template that we hooked up to </span><span><span class="kobospan" id="kobo.1416.1">the host.</span></span></p>
<h2 id="_idParaDest-258" class="calibre7"><a id="_idTextAnchor1489" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1417.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1418.1">But wait – there’s more! </span><span class="kobospan" id="kobo.1418.2">Starting from Zabbix 6.2, host prototypes are actually practically useful, by introducing some major changes. </span><span class="kobospan" id="kobo.1418.3">It is now possible to fully customize the host settings such as macros, tags, and </span><span><span class="kobospan" id="kobo.1419.1">even templates.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1420.1">This means that even though a host is created from a prototype, we can still customize our monitoring. </span><span class="kobospan" id="kobo.1420.2">For example, if you discover your VMs in VMware, we could customize the LLD rule to also automatically start monitoring with the Zabbix agent. </span><span class="kobospan" id="kobo.1420.3">If you then want to override some macros for the host, to change, let’s say, a trigger threshold, you </span><span><span class="kobospan" id="kobo.1421.1">actually can.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1422.1">Do keep in mind, though, that </span><a id="_idIndexMarker596" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1423.1">if you remove the host or LLD rule that </span><a id="_idIndexMarker597" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1424.1">discovered the hosts, all the discovered hosts will also be removed. </span><span class="kobospan" id="kobo.1424.2">Be careful with removing things and always have backups at </span><span><span class="kobospan" id="kobo.1425.1">the ready!</span></span></p>
</div>
</body></html>