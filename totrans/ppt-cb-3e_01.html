<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Puppet Language and Style"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Puppet Language and Style</h1></div></div></div><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Computer language design is just like a stroll in the park. Jurassic Park, that is."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Larry Wall</em></span></span></td></tr></table></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Adding a resource to a node</li><li class="listitem" style="list-style-type: disc">Using <span class="strong"><strong>Facter</strong></span> to describe a node</li><li class="listitem" style="list-style-type: disc">Installing a package before starting a service</li><li class="listitem" style="list-style-type: disc">Installing, configuring, and starting a service</li><li class="listitem" style="list-style-type: disc">Using community <span class="strong"><strong>Puppet</strong></span> style</li><li class="listitem" style="list-style-type: disc">Creating a manifest</li><li class="listitem" style="list-style-type: disc">Checking your manifests with Puppet-lint</li><li class="listitem" style="list-style-type: disc">Using modules</li><li class="listitem" style="list-style-type: disc">Using standard naming conventions</li><li class="listitem" style="list-style-type: disc">Using inline templates</li><li class="listitem" style="list-style-type: disc">Iterating over multiple items</li><li class="listitem" style="list-style-type: disc">Writing powerful conditional statements</li><li class="listitem" style="list-style-type: disc">Using regular expressions in if statements</li><li class="listitem" style="list-style-type: disc">Using selectors and case statements</li><li class="listitem" style="list-style-type: disc">Using the in operator</li><li class="listitem" style="list-style-type: disc">Using regular expression substitutions</li><li class="listitem" style="list-style-type: disc">Using the future parser</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Introduction</h1></div></div></div><p>In this chapter, we'll start with the basics of Puppet syntax and show you how some of the syntactic sugar in Puppet is used. We'll then move on to how Puppet deals with dependencies and how to make Puppet do the work for you.</p><p>We'll look at how to organize and structure your code into modules following community conventions, so that other people will find it easy to read and maintain your code. I'll also show you some powerful features of Puppet language, which will let you write concise, yet expressive manifests.</p></div></div>
<div class="section" title="Adding a resource to a node"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Adding a resource to a node</h1></div></div></div><p>This recipe will <a id="id0" class="indexterm"/>introduce the language and show you the basics of writing Puppet <a id="id1" class="indexterm"/>code. A beginner may wish to reference <span class="emphasis"><em>Puppet 3: Beginner's Guide</em></span>, <span class="emphasis"><em>John Arundel</em></span>, <span class="emphasis"><em>Packt Publishing</em></span> in addition to this section. Puppet code files are called <a id="id2" class="indexterm"/>manifests; manifests declare resources. A resource<a id="id3" class="indexterm"/> in Puppet may be a type, class, or node. A type<a id="id4" class="indexterm"/> is something like a file or package or anything that has a type declared in the language. The current list of standard types is available on puppetlabs website <a id="id5" class="indexterm"/>at <a class="ulink" href="https://docs.puppetlabs.com/references/latest/type.html">https://docs.puppetlabs.com/references/latest/type.html</a>. I find myself referencing this site very often. You may define your own types, either using a mechanism, similar to a subroutine, named <a id="id6" class="indexterm"/>
<span class="strong"><strong>defined types</strong></span>, or you can extend the language using a custom type. Types are the heart of the language; they describe the things that make up a node (node is the word Puppet uses for client computers/devices). Puppet uses resources to describe the state of a node; for example, we will declare the following package resource for a node using a site manifest (<code class="literal">site.pp</code>).</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>How to do it...</h2></div></div></div><p>Create a <code class="literal">site.pp</code> file and place the following code in it:</p><div class="informalexample"><pre class="programlisting">  node default {
    package { 'httpd':
      ensure =&gt; 'installed'
    }
  }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>How it works...</h2></div></div></div><p>This manifest will ensure that any node, on which this manifest is applied, will install a package called <code class="literal">'httpd'</code>. The <code class="literal">default</code> keyword<a id="id7" class="indexterm"/> is a wildcard to Puppet; it applies anything within the node default definition to any node. When Puppet applies the manifest to a node, it uses a <span class="strong"><strong>Resource Abstraction Layer</strong></span> (<span class="strong"><strong>RAL</strong></span>)<a id="id8" class="indexterm"/> to translate the package type into the package management system of the target node. What this means is that we can use the same manifest to install the<a id="id9" class="indexterm"/> <code class="literal">httpd</code> package on any system for which Puppet has a <a id="id10" class="indexterm"/>
<span class="strong"><strong>Provider</strong></span> for the package type. Providers are the pieces of code that do the real work of applying a manifest. When the previous code is applied to a node running on a YUM-based distribution, the YUM provider will be used to install the <code class="literal">httpd</code> RPM <a id="id11" class="indexterm"/>packages. When the same code is applied to a node running <a id="id12" class="indexterm"/>on an<a id="id13" class="indexterm"/> <span class="strong"><strong>APT</strong></span>-based distribution, the APT provider will be used to install the <code class="literal">httpd</code> DEB package (which may not exist, most debian-based systems call this package <code class="literal">apache2</code>; we'll deal with this sort of naming problem later).</p></div></div>
<div class="section" title="Using Facter to describe a node"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Using Facter to describe a node</h1></div></div></div><p>Facter<a id="id14" class="indexterm"/> is a separate utility upon which Puppet depends. It is the system used by Puppet to gather information about the target system (node); <code class="literal">facter</code> calls the nuggets of information facts. You may run <code class="literal">facter</code> from the command line to obtain real-time information from the system.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use <code class="literal">facter</code> to find <a id="id15" class="indexterm"/>the current uptime of the system, the <a id="id16" class="indexterm"/>uptime fact:<div class="informalexample"><pre class="programlisting">t@cookbook ~$ facter uptime
0:12 hours</pre></div></li><li class="listitem">Compare this with the output of the Linux uptime command:<div class="informalexample"><pre class="programlisting">t@cookbook ~$ uptime
 01:18:52 up 12 min,  1 user,  load average: 0.00, 0.00, 0.00</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>How it works...</h2></div></div></div><p>When <code class="literal">facter</code> is installed (as a dependency for puppet), several fact definitions are installed by default. You can reference each of these facts by name from the command line.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>There's more...</h2></div></div></div><p>Running <code class="literal">facter</code> without any arguments causes <code class="literal">facter</code> to print all the facts known about the system. We will see in later chapters that <code class="literal">facter</code> can be extended with your own custom facts. All facts are available for you to use as variables; variables are discussed in the next section.</p><div class="section" title="Variables"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Variables</h3></div></div></div><p>Variables<a id="id17" class="indexterm"/> in Puppet are marked with a dollar sign ($) character. When using variables within a manifest, it is preferred to enclose the variable within braces <code class="literal">"${myvariable}"</code> instead of <code class="literal">"$myvariable"</code>. All of the facts from <code class="literal">facter</code> can be referenced as top scope variables (we will discuss scope in the next section). For example, the <span class="strong"><strong>fully qualified domain name</strong></span> (<span class="strong"><strong>FQDN</strong></span>)<a id="id18" class="indexterm"/> of the node may be referenced by <code class="literal">"${::fqdn}"</code>. Variables can only contain alphabetic characters, numerals, and the underscore character (<code class="literal">_</code>). As a matter of style, variables should start with an alphabetic character. Never use dashes in variable names.</p></div><div class="section" title="Scope"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Scope</h3></div></div></div><p>In the variable example explained in the <span class="emphasis"><em>There's more…</em></span> section, the fully qualified domain name was referred to as <code class="literal">${::fqdn}</code> rather than <code class="literal">${fqdn}</code>; the double colons are how Puppet differentiates <a id="id19" class="indexterm"/>scope. The highest level scope, top scope or global, is referred to by two colons (<code class="literal">::</code>) at the beginning of a variable identifier. To reduce namespace collisions, always use fully scoped variable identifiers in your manifests. For a Unix user, think of top scope variables as the <code class="literal">/</code> (root) level. You can refer to variables using the double colon syntax similar to how you would refer to a directory by its full path. For the developer, you can think of top scope variables as global variables; however, unlike global variables, you must always refer to them with the double colon notation to guarantee that a local variable isn't obscuring the top scope variable.</p></div></div></div>
<div class="section" title="Installing a package before starting a service"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Installing a package before starting a service</h1></div></div></div><p>To show how <a id="id20" class="indexterm"/>ordering works, we'll create a manifest that <a id="id21" class="indexterm"/>installs <code class="literal">httpd</code> and then ensures the <code class="literal">httpd</code> package service is running.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We start by creating a manifest that defines the service:<div class="informalexample"><pre class="programlisting">  service {'httpd':
    ensure  =&gt; running,
    require =&gt; Package['httpd'],
  }</pre></div></li><li class="listitem">The service definition references a package resource named <code class="literal">httpd</code>; we now need to define that resource:<div class="informalexample"><pre class="programlisting">  package {'httpd':
    ensure =&gt; 'installed',
  }</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>How it works...</h2></div></div></div><p>In this example, the <a id="id22" class="indexterm"/>package will be installed before the service is <a id="id23" class="indexterm"/>started. Using <code class="literal">require</code> within the definition of the <code class="literal">httpd</code> service ensures that the package is installed first, regardless of the order within the manifest file.</p><div class="section" title="Capitalization"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Capitalization</h3></div></div></div><p>Capitalization<a id="id24" class="indexterm"/> is important in Puppet. In our previous example, we created a package named <code class="literal">httpd</code>. If we wanted to refer to this package later, we would capitalize its type (<code class="literal">package</code>) as follows:</p><div class="informalexample"><pre class="programlisting">Package['httpd']</pre></div><p>To refer to a class, for example, the <code class="literal">something::somewhere</code> class, which has already been included/defined in your manifest, you can reference it with the full path as follows:</p><div class="informalexample"><pre class="programlisting">Class['something::somewhere']</pre></div><p>When you have a defined type, for example the following defined type:</p><div class="informalexample"><pre class="programlisting">example::thing {'one':} </pre></div><p>The preceding resource may be referenced later as follows:</p><div class="informalexample"><pre class="programlisting">Example::Thing['one']</pre></div><p>Knowing how to reference previously defined resources is necessary for the next section on metaparameters and ordering.</p></div><div class="section" title="Learning metaparameters and ordering"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Learning metaparameters and ordering</h3></div></div></div><p>All the manifests that will be<a id="id25" class="indexterm"/> used to define a node are compiled into a catalog. A catalog is the<a id="id26" class="indexterm"/> code that will be applied to configure a node. It is important to remember that manifests are not applied to nodes sequentially. There is no inherent order to the application of manifests. With this in mind, in the previous <code class="literal">httpd</code> example, what if we wanted to ensure that the <code class="literal">httpd</code> process started after the <code class="literal">httpd</code> package was installed?</p><p>We couldn't rely on the <code class="literal">httpd</code> service coming after the <code class="literal">httpd</code> package in the manifests. What we have to do is use metaparameters to tell Puppet the order in which we want resources applied to the node. Metaparameters are parameters that can be applied to any resource and are not specific to any one resource type. They are used for catalog compilation and as hints to Puppet but not to define anything about the resource to which they are attached. When dealing with ordering, there are four metaparameters used:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">before</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">require</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">notify</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">subscribe</code></li></ul></div><p>The <code class="literal">before</code> <a id="id27" class="indexterm"/>and <code class="literal">require</code> <a id="id28" class="indexterm"/>metaparameters specify a<a id="id29" class="indexterm"/> direct <a id="id30" class="indexterm"/>ordering; <code class="literal">notify</code> implies <code class="literal">before</code> and <code class="literal">subscribe</code> implies <code class="literal">require</code>. The <code class="literal">notify</code> metaparameter is <a id="id31" class="indexterm"/>only <a id="id32" class="indexterm"/>applicable to services; what notify does is tell a service to restart after the notifying resource has been applied to the node (this is most often a package or file resource). In the case of files, once the file is created on the node, a notify parameter will restart any services mentioned. The <code class="literal">subscribe</code> metaparameter<a id="id33" class="indexterm"/> has the <a id="id34" class="indexterm"/>same effect but is defined on the service; the service will subscribe to the file.</p></div><div class="section" title="Trifecta"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Trifecta</h3></div></div></div><p>The relationship between package and service previously mentioned is an important and powerful paradigm of Puppet. Adding one more resource-type file into the fold, creates what puppeteers refer to as the<a id="id35" class="indexterm"/> <span class="strong"><strong>trifecta</strong></span>. Almost all system administration tasks revolve around these three resource types. As a system administrator, you install a package, configure the package with files, and then start the service.</p><div class="mediaobject"><img src="graphics/B03643_01_01.jpg" alt="Trifecta"/><div class="caption"><p>Diagram of Trifecta (Files require package for directory, service requires files and package)</p></div></div></div><div class="section" title="Idempotency"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Idempotency</h3></div></div></div><p>A key concept of Puppet is that the state of the system when a catalog is applied to a node cannot affect the outcome of Puppet run. In other words, at the end of Puppet run (if the run was successful), the system will be in a known state and any further application of the catalog will result in a system that is in the same state. This property of Puppet is known as idempotency. <span class="strong"><strong>Idempotency</strong></span><a id="id36" class="indexterm"/> is the property that no matter how many times you do something, it remains in the same state as the first time you did it. For instance, if you had a light switch and you gave the instruction to turn it on, the light would turn on. If you gave the instruction again, the light would remain on.</p></div></div></div>
<div class="section" title="Installing, configuring, and starting a service"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Installing, configuring, and starting a service</h1></div></div></div><p>There are many examples of this pattern online. In our simple example, we will create an Apache configuration file under <code class="literal">/etc/httpd/conf.d/cookbook.conf</code>. The <code class="literal">/etc/httpd/conf.d</code> directory will not exist until the <code class="literal">httpd</code> package is installed. After this file is created, we would want <code class="literal">httpd</code> to restart to notice the change; we can achieve this with a notify parameter.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>How to do it...</h2></div></div></div><p>We will need the same<a id="id37" class="indexterm"/> definitions <a id="id38" class="indexterm"/>as our last example; we need the package and service <a id="id39" class="indexterm"/>installed. We now need two more things. We need the <a id="id40" class="indexterm"/>configuration file and index page (<code class="literal">index.html</code>) created. For this, we follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">As in the previous example, we ensure the service is running and specify that the service requires the <code class="literal">httpd</code> package:<div class="informalexample"><pre class="programlisting">  service {'httpd':
    ensure =&gt; running,
    require =&gt; Package['httpd'],
  }</pre></div></li><li class="listitem">We then define the package as follows:<div class="informalexample"><pre class="programlisting">  package {'httpd':
    ensure =&gt; installed,
  }</pre></div></li><li class="listitem">Now, we <a id="id41" class="indexterm"/>create the <code class="literal">/etc/httpd/conf.d/cookbook.conf</code> configuration file; the <code class="literal">/etc/httpd/conf.d</code> directory<a id="id42" class="indexterm"/> will not exist until the <code class="literal">httpd</code> package is <a id="id43" class="indexterm"/>installed. The <code class="literal">require</code> metaparameter tells Puppet that this <a id="id44" class="indexterm"/>file requires the <code class="literal">httpd</code> package to be installed before it is created:<div class="informalexample"><pre class="programlisting">  file {'/etc/httpd/conf.d/cookbook.conf':
    content =&gt; "&lt;VirtualHost *:80&gt;\nServernamecookbook\nDocumentRoot/var/www/cookbook\n&lt;/VirtualHost&gt;\n",
    require =&gt; Package['httpd'],
    notify =&gt; Service['httpd'],
  }</pre></div></li><li class="listitem">We then go on to create an <code class="literal">index.html</code> file for our virtual host in <code class="literal">/var/www/cookbook</code>. This directory won't exist yet, so we need to create this as well, using the following code:<div class="informalexample"><pre class="programlisting">  file {'/var/www/cookbook':
    ensure =&gt; directory,
  }
  file {'/var/www/cookbook/index.html':
    content =&gt; "&lt;html&gt;&lt;h1&gt;Hello World!&lt;/h1&gt;&lt;/html&gt;\n",
    require =&gt; File['/var/www/cookbook'],
  }</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>How it works…</h2></div></div></div><p>The <code class="literal">require</code> attribute to the file resources tell Puppet that we need the <code class="literal">/var/www/cookbook</code> directory created before we can create the <code class="literal">index.html</code> file. The important concept to remember is that we cannot assume anything about the target system (node). We need to define everything on which the target depends. Anytime you create a file in a manifest, you have to ensure that the directory containing that file exists. Anytime you specify that a service should be running, you have to ensure that the package providing that service is installed.</p><p>In this example, using metaparameters, we can be confident that no matter what state the node is in before running Puppet, after Puppet runs, the following will be true:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">httpd</code> will be running</li><li class="listitem" style="list-style-type: disc">The <code class="literal">VirtualHost</code> <a id="id45" class="indexterm"/>configuration file will exist</li><li class="listitem" style="list-style-type: disc"><code class="literal">httpd</code> will restart and<a id="id46" class="indexterm"/> be aware of the <code class="literal">VirtualHost</code> file</li><li class="listitem" style="list-style-type: disc">The <code class="literal">DocumentRoot</code> directory <a id="id47" class="indexterm"/>will exist</li><li class="listitem" style="list-style-type: disc">An <code class="literal">index.html</code> file will exist in <a id="id48" class="indexterm"/>the <code class="literal">DocumentRoot</code> directory</li></ul></div></div></div>
<div class="section" title="Using community Puppet style"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Using community Puppet style</h1></div></div></div><p>If other people need to read or<a id="id49" class="indexterm"/> maintain your manifests, or if you want to share code with the community, it's a good idea to follow the existing style conventions as closely as possible. These govern such aspects of your code as layout, spacing, quoting, alignment, and variable references, and the official puppetlabs<a id="id50" class="indexterm"/> recommendations on style are available at <a class="ulink" href="http://docs.puppetlabs.com/guides/style_guide.html">http://docs.puppetlabs.com/guides/style_guide.html</a>.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>How to do it…</h2></div></div></div><p>In this section, I'll show you a few of the more important examples and how to make sure that your code is style compliant.</p><div class="section" title="Indentation"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>Indentation</h3></div></div></div><p>Indent your manifests using <a id="id51" class="indexterm"/>two spaces (not tabs), as follows:</p><div class="informalexample"><pre class="programlisting">service {'httpd':
  ensure  =&gt; running,
}</pre></div></div><div class="section" title="Quoting"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec08"/>Quoting</h3></div></div></div><p>Always quote your <a id="id52" class="indexterm"/>resource names, as follows:</p><div class="informalexample"><pre class="programlisting">package { 'exim4':</pre></div><p>We cannot do this as follows though:</p><div class="informalexample"><pre class="programlisting">package { exim4:</pre></div><p>Use single quotes for all strings, except when:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The string contains variable references such as <code class="literal">"${::fqdn}"</code></li><li class="listitem" style="list-style-type: disc">The string contains character escape sequences such as <code class="literal">"\n"</code></li></ul></div><p>Consider the following code:</p><div class="informalexample"><pre class="programlisting">file { '/etc/motd':
  content =&gt; "Welcome to ${::fqdn}\n"
}</pre></div><p>Puppet doesn't process variable references or escape sequences unless they're inside double quotes.</p><p>Always quote parameter values that are not reserved words in Puppet. For example, the following values are not reserved words:</p><div class="informalexample"><pre class="programlisting">name =&gt; 'Nucky Thompson',
mode =&gt; '0700',
owner =&gt; 'deploy',</pre></div><p>However, these values are <a id="id53" class="indexterm"/>reserved words and therefore not quoted:</p><div class="informalexample"><pre class="programlisting">ensure =&gt; installed,
enable =&gt; true,
ensure =&gt; running,</pre></div></div><div class="section" title="False"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec09"/>False</h3></div></div></div><p>There is only one thing in Puppet that is false, that is, the word <code class="literal">false</code> without any quotes. The string <code class="literal">"false"</code> evaluates to <code class="literal">true</code> and the string <code class="literal">"true"</code> also evaluates to true. Actually, everything besides the literal<a id="id54" class="indexterm"/> false evaluates to true (when treated as a Boolean):</p><div class="informalexample"><pre class="programlisting">if "false" {
  notify { 'True': }
}
if 'false' {
  notify { 'Also true': }
}
if false {
  notify { 'Not true': }
}</pre></div><p>When this code is run through <code class="literal">puppet apply</code>, the first two notifies are triggered. The final notify is not triggered; it is the only one that evaluates to <code class="literal">false</code>.</p></div><div class="section" title="Variables"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec10"/>Variables</h3></div></div></div><p>Always include curly <a id="id55" class="indexterm"/>braces (<code class="literal">{}</code>) around variable names when referring to them in strings, for example, as follows:</p><div class="informalexample"><pre class="programlisting">source =&gt; "puppet:///modules/webserver/${brand}.conf",</pre></div><p>Otherwise, Puppet's parser has to guess which characters should be a part of the variable name and which belong to the surrounding string. Curly braces make it explicit.</p></div><div class="section" title="Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec11"/>Parameters</h3></div></div></div><p>Always end lines that declare <a id="id56" class="indexterm"/>parameters with a comma, even if it is the last parameter:</p><div class="informalexample"><pre class="programlisting">service { 'memcached':
  ensure =&gt; running,
  enable =&gt; true,
}</pre></div><p>This is allowed by Puppet, and makes it easier if you want to add parameters later, or reorder the existing parameters.</p><p>When declaring a resource with a single parameter, make the declaration all on one line and with no trailing comma, as shown in the following snippet:</p><div class="informalexample"><pre class="programlisting">package { 'puppet': ensure =&gt; installed }</pre></div><p>Where there is more than one parameter, give each parameter its own line:</p><div class="informalexample"><pre class="programlisting">package { 'rake':
  ensure   =&gt; installed,
  provider =&gt; gem,
  require  =&gt; Package['rubygems'],
}</pre></div><p>To make the code easier to read, line up the parameter arrows in line with the longest parameter, as follows:</p><div class="informalexample"><pre class="programlisting">file { "/var/www/${app}/shared/config/rvmrc":
  owner   =&gt; 'deploy',
  group   =&gt; 'deploy',
  content =&gt; template('rails/rvmrc.erb'),
  require =&gt; File["/var/www/${app}/shared/config"],
}</pre></div><p>The arrows should be aligned per resource, but not across the whole file, otherwise it can make it difficult for you to cut and paste code from one file to another.</p></div><div class="section" title="Symlinks"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec12"/>Symlinks</h3></div></div></div><p>When declaring file <a id="id57" class="indexterm"/>resources which <a id="id58" class="indexterm"/>are symlinks, use <code class="literal">ensure =&gt; link</code> and set the target attribute, as follows:</p><div class="informalexample"><pre class="programlisting">file { '/etc/php5/cli/php.ini':
  ensure =&gt; link,
  target =&gt; '/etc/php.ini',
}</pre></div></div></div></div>
<div class="section" title="Creating a manifest"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Creating a manifest</h1></div></div></div><p>If you already have some <a id="id59" class="indexterm"/>Puppet code (known as a Puppet manifest), you can skip this section and go on to the next. If not, we'll see how to create and apply a simple manifest.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>How to do it...</h2></div></div></div><p>To create and apply a simple manifest, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, install Puppet locally on your machine or create a virtual machine and install Puppet on that machine. For <a id="id60" class="indexterm"/>YUM-based systems, use <a class="ulink" href="https://yum.puppetlabs.com/">https://yum.puppetlabs.com/</a> and for <a id="id61" class="indexterm"/>APT-based systems, use <a class="ulink" href="https://apt.puppetlabs.com/">https://apt.puppetlabs.com/</a>. You may also use gem to install Puppet. For our examples, we'll install Puppet using gem on a Debian Wheezy system (hostname: <code class="literal">cookbook</code>). To use gem, we need the <code class="literal">rubygems</code> package as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~$ sudo apt-get install rubygems</strong></span>
<span class="strong"><strong>Reading package lists... Done</strong></span>
<span class="strong"><strong>Building dependency tree        </strong></span>
<span class="strong"><strong>Reading state information... Done</strong></span>
<span class="strong"><strong>The following NEW packages will be installed:</strong></span>
<span class="strong"><strong>  rubygems</strong></span>
<span class="strong"><strong>0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.</strong></span>
<span class="strong"><strong>Need to get 0 B/597 kB of archives.</strong></span>
<span class="strong"><strong>After this operation, 3,844 kB of additional disk space will be used.</strong></span>
<span class="strong"><strong>Selecting previously unselected package rubygems.</strong></span>
<span class="strong"><strong>(Reading database ... 30390 files and directories currently installed.)</strong></span>
<span class="strong"><strong>Unpacking rubygems (from .../rubygems_1.8.24-1_all.deb) ...</strong></span>
<span class="strong"><strong>Processing triggers for man-db ...</strong></span>
<span class="strong"><strong>Setting up rubygems (1.8.24-1) ...</strong></span>
</pre></div></li><li class="listitem">Now, use <code class="literal">gem</code> to install Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook $ sudo gem install puppet</strong></span>
<span class="strong"><strong>Successfully installed hiera-1.3.4</strong></span>
<span class="strong"><strong>Fetching: facter-2.3.0.gem (100%)</strong></span>
<span class="strong"><strong>Successfully installed facter-2.3.0</strong></span>
<span class="strong"><strong>Fetching: puppet-3.7.3.gem (100%)</strong></span>
<span class="strong"><strong>Successfully installed puppet-3.7.3</strong></span>
<span class="strong"><strong>Installing ri documentation for hiera-1.3.4</strong></span>
<span class="strong"><strong>Installing ri documentation for facter-2.3.0</strong></span>
<span class="strong"><strong>Installing ri documentation for puppet-3.7.3</strong></span>
<span class="strong"><strong>Done installing documentation for hiera, facter, puppet after 239 seconds</strong></span>
</pre></div></li><li class="listitem">Three gems are<a id="id62" class="indexterm"/> installed. Now, with Puppet installed, we can create a directory to contain our Puppet code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~$ mkdir -p .puppet/manifests</strong></span>
<span class="strong"><strong>t@cookbook:~$ cd .puppet/manifests</strong></span>
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$</strong></span>
</pre></div></li><li class="listitem">Within your <code class="literal">manifests</code> directory, create the <code class="literal">site.pp</code> file with the following content:<div class="informalexample"><pre class="programlisting">  node default {
    file { '/tmp/hello':
      content =&gt; "Hello, world!\n",
    }
  }</pre></div></li><li class="listitem">Test your manifest with the <code class="literal">puppet apply</code> command. This will tell Puppet to read the manifest, compare it to the state of the machine, and make any necessary changes to that state:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply site.pp</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook in environment production in 0.14 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Node[default]/File[/tmp/hello]/ensure: defined content as '{md5}746308829575e17c3331bbcb00c0898b'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.04 seconds</strong></span>
</pre></div></li><li class="listitem">To see if Puppet did what we expected (create the <code class="literal">/tmp/hello</code> file with the <code class="literal">Hello, world</code>! content), run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/puppet/manifests$ cat /tmp/hello</strong></span>
<span class="strong"><strong>Hello, world!</strong></span>
<span class="strong"><strong> t@cookbook:~/puppet/manifests$</strong></span>
</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Note that creating the file in <code class="literal">/tmp</code> did not require special permissions. We did not run Puppet via <code class="literal">sudo</code>. Puppet need not be run through <code class="literal">sudo</code>; there are cases where running via an unprivileged user can be useful.</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>There's more…</h2></div></div></div><p>When several people <a id="id63" class="indexterm"/>are working on a code base, it's easy for style inconsistencies to creep in. Fortunately, there's a tool available which can automatically check your code for compliance with the style guide: <code class="literal">puppet-lint</code>. We'll see how to use this in the next section.</p></div></div>
<div class="section" title="Checking your manifests with Puppet-lint"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Checking your manifests with Puppet-lint</h1></div></div></div><p>The puppetlabs official style guide outlines a number of style conventions for Puppet code, some of which we've touched on in the preceding section. For example, according to the style guide, manifests:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Must use two-space soft tabs</li><li class="listitem" style="list-style-type: disc">Must not use literal tab characters</li><li class="listitem" style="list-style-type: disc">Must not contain trailing white space</li><li class="listitem" style="list-style-type: disc">Should not exceed an 80 character line width</li><li class="listitem" style="list-style-type: disc">Should align parameter arrows (<code class="literal">=&gt;</code>) within blocks</li></ul></div><p>Following the style guide will make sure that your Puppet code is easy to read and maintain, and if you're planning to release your code to the public, style compliance is essential.</p><p>The <code class="literal">puppet-lint</code> tool <a id="id64" class="indexterm"/>will automatically check your code against the style guide. The next section explains how to use it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>Getting ready</h2></div></div></div><p>Here's what you need to <a id="id65" class="indexterm"/>do to <a id="id66" class="indexterm"/>install Puppet-lint:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We'll install Puppet-lint using the gem provider because the gem version is much more up to date than the APT or RPM packages available. Create a <code class="literal">puppet-lint.pp</code> manifest as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">  package {'puppet-lint':
    ensure =&gt; 'installed',
    provider =&gt; 'gem',
  }</pre></div></li><li class="listitem">Run <code class="literal">puppet apply</code> on the <code class="literal">puppet-lint.pp</code> manifest, as shown in the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook ~$ puppet apply puppet-lint.pp Notice: Compiled catalog for node1.example.com in environment production in 0.42 seconds</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Package[puppet-lint]/ensure: created</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 2.96 seconds</strong></span>
<span class="strong"><strong>t@cookbook ~$ gem list puppet-lint *** LOCAL GEMS *** puppet-lint (1.0.1)</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>How to do it...</h2></div></div></div><p>Follow these<a id="id67" class="indexterm"/> steps to use Puppet-lint:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Choose a <a id="id68" class="indexterm"/>Puppet manifest file that you want to check with Puppet-lint, and run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook ~$ puppet-lint puppet-lint.pp </strong></span>
<span class="strong"><strong>WARNING: indentation of =&gt; is not properly aligned on line 2</strong></span>
<span class="strong"><strong>ERROR: trailing whitespace found on line 4</strong></span>
</pre></div></li><li class="listitem">As you can see, Puppet-lint found a number of problems with the manifest file. Correct the errors, save the file, and rerun Puppet-lint to check that all is well. If successful, you'll see no output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook ~$ puppet-lint puppet-lint.pp </strong></span>
<span class="strong"><strong>t@cookbook ~$</strong></span>
</pre></div></li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>There's more...</h2></div></div></div><p>You can find out more about <a id="id69" class="indexterm"/>Puppet-lint at <a class="ulink" href="https://github.com/rodjek/puppet-lint">https://github.com/rodjek/puppet-lint</a>.</p><p>Should you follow Puppet style guide and, by extension, keep your code lint-clean? It's up to you, but here are a couple of things to think about:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It makes sense to use some style conventions, especially when you're working collaboratively on code. Unless you and your colleagues can agree on standards for whitespace, tabs, quoting, alignment, and so on, your code will be messy and difficult to read or maintain.</li><li class="listitem" style="list-style-type: disc">If you're choosing a set of style conventions to follow, the logical choice would be that issued by puppetlabs and adopted by the community for use in public modules.</li></ul></div><p>Having said that, it's possible to tell Puppet-lint to ignore certain checks if you've chosen not to adopt them in your codebase. For example, if you don't want Puppet-lint to warn you about code lines exceeding 80 characters, you can run Puppet-lint with the following option:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook ~$ puppet-lint --no-80chars-check</strong></span>
</pre></div><p>Run <code class="literal">puppet-lint --help</code> to see the complete list of check configuration commands.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec22"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Automatic syntax checking with Git hooks</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Puppet Infrastructure">Chapter 2</a>, <span class="emphasis"><em>Puppet Infrastructure</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Testing your Puppet manifests with rspec-puppet</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span></li></ul></div></div></div>
<div class="section" title="Using modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Using modules</h1></div></div></div><p>One of the most important things you can do to make your Puppet manifests clearer and more maintainable is to organize them into modules.</p><p>Modules<a id="id70" class="indexterm"/> are self-contained bundles of Puppet code that include all the files necessary to implement a thing. Modules may contain flat files, templates, Puppet manifests, custom fact declarations, augeas lenses, and custom Puppet types and providers.</p><p>Separating things into modules makes it easier to reuse and share code; it's also the most logical way to organize your manifests. In this example, we'll create a module to manage memcached, a memory caching system commonly used with web applications.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec23"/>How to do it…</h2></div></div></div><p>Following are the steps to create an<a id="id71" class="indexterm"/> example module:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will use Puppet's module subcommand to create the directory structure for our new module:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~$ mkdir -p .puppet/modules</strong></span>
<span class="strong"><strong>t@cookbook:~$ cd .puppet/modules</strong></span>
<span class="strong"><strong>t@cookbook:~/.puppet/modules$ puppet module generate thomas-memcached</strong></span>
<span class="strong"><strong>We need to create a metadata.json file for this module.  Please answer the following questions; if the question is not applicable to this module, feel free to leave it blank. Puppet uses Semantic Versioning (semver.org) to version modules.What version is this module?  [0.1.0]</strong></span>
<span class="strong"><strong>--&gt; Who wrote this module?  [thomas]</strong></span>
<span class="strong"><strong>--&gt; What license does this module code fall under?  [Apache 2.0]</strong></span>
<span class="strong"><strong>--&gt; How would you describe this module in a single sentence?</strong></span>
<span class="strong"><strong>--&gt; A module to install memcached Where is this module's source code repository?</strong></span>
<span class="strong"><strong>--&gt; Where can others go to learn more about this module?</strong></span>
<span class="strong"><strong>--&gt; Where can others go to file issues about this module?</strong></span>
<span class="strong"><strong>--&gt; </strong></span>
<span class="strong"><strong>----------------------------------------</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "name": "thomas-memcached",</strong></span>
<span class="strong"><strong>  "version": "0.1.0",</strong></span>
<span class="strong"><strong>  "author": "thomas",</strong></span>
<span class="strong"><strong>  "summary": "A module to install memcached",</strong></span>
<span class="strong"><strong>  "license": "Apache 2.0",</strong></span>
<span class="strong"><strong>  "source": "",</strong></span>
<span class="strong"><strong>  "issues_url": null,</strong></span>
<span class="strong"><strong>  "project_page": null,</strong></span>
<span class="strong"><strong>  "dependencies": [</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "version_range": "&gt;= 1.0.0",</strong></span>
<span class="strong"><strong>      "name": "puppetlabs-stdlib"</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  ]</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>----------------------------------------</strong></span>
<span class="strong"><strong>About to generate this metadata; continue? [n/Y]</strong></span>
<span class="strong"><strong>--&gt; y</strong></span>
<span class="strong"><strong>Notice: Generating module at /home/thomas/.puppet/modules/thomas-memcached...</strong></span>
<span class="strong"><strong>Notice: Populating ERB templates...</strong></span>
<span class="strong"><strong>Finished; module generated in thomas-memcached.</strong></span>
<span class="strong"><strong>thomas-memcached/manifests</strong></span>
<span class="strong"><strong>thomas-memcached/manifests/init.pp</strong></span>
<span class="strong"><strong>thomas-memcached/spec</strong></span>
<span class="strong"><strong>thomas-memcached/spec/classes</strong></span>
<span class="strong"><strong>thomas-memcached/spec/classes/init_spec.rb</strong></span>
<span class="strong"><strong>thomas-memcached/spec/spec_helper.rb</strong></span>
<span class="strong"><strong>thomas-memcached/README.md</strong></span>
<span class="strong"><strong>thomas-memcached/metadata.json</strong></span>
<span class="strong"><strong>thomas-memcached/Rakefile</strong></span>
<span class="strong"><strong>thomas-memcached/tests</strong></span>
<span class="strong"><strong>thomas-memcached/tests/init.pp</strong></span>
</pre></div><p>This command creates the module directory and creates some empty files as starting points. To use the module, we'll create a symlink to the module name (memcached).</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/modules$ ln –s thomas-memcached memcached</strong></span>
</pre></div></li><li class="listitem">Now, edit <code class="literal">memcached/manifests/init.pp</code> and change the class definition at the end of the file to<a id="id72" class="indexterm"/> the following. Note that <code class="literal">puppet module generate</code> created many lines of comments; in a production module you would want to edit those default comments:<div class="informalexample"><pre class="programlisting">class memcached {
  package { 'memcached':
    ensure =&gt; installed,
  }

  file { '/etc/memcached.conf':
    source  =&gt; 'puppet:///modules/memcached/memcached.conf',
    owner   =&gt; 'root',
    group   =&gt; 'root',
    mode    =&gt; '0644',
    require =&gt; Package['memcached'],
  }
  service { 'memcached':
    ensure  =&gt; running,
    enable  =&gt; true,
    require =&gt; [Package['memcached'],
                File['/etc/memcached.conf']],
  }
}</pre></div></li><li class="listitem">Create the <code class="literal">modules/thomas-memcached/files</code> directory and then create a file named <code class="literal">memcached.conf</code> with the following contents:<div class="informalexample"><pre class="programlisting">-m 64
-p 11211
-u nobody
-l 127.0.0.1</pre></div></li><li class="listitem">Change your <code class="literal">site.pp</code> file to the following:<div class="informalexample"><pre class="programlisting">node default {
  include memcached
}</pre></div></li><li class="listitem">We would like this module <a id="id73" class="indexterm"/>to install memcached. We'll need to run Puppet with root privileges, and we'll use sudo for that. We'll need Puppet to be able to find the module in our home directory; we can specify this on the command line when we run Puppet as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">t@cookbook:~$ sudo puppet apply --modulepath=/home/thomas/.puppet/modules /home/thomas/.puppet/manifests/site.pp
Notice: Compiled catalog for cookbook.example.com in environment production in 0.33 seconds
Notice: /Stage[main]/Memcached/File[/etc/memcached.conf]/content: content changed '{md5}a977521922a151c959ac953712840803' to '{md5}9429eff3e3354c0be232a020bcf78f75'
Notice: Finished catalog run in 0.11 seconds</pre></div></li><li class="listitem">Check whether the new service is running:<div class="informalexample"><pre class="programlisting">t@cookbook:~$ sudo service memcached status
[ ok ] memcached is running.</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec24"/>How it works…</h2></div></div></div><p>When we created the module using Puppet's module generate command, we used the name <code class="literal">thomas-memcached</code>. The name before the hyphen is your username or your username on Puppet forge (an online repository of modules). Since we want Puppet to be able to find the module by the name <code class="literal">memcached</code>, we make a symbolic link between <code class="literal">thomas-memcached</code> and <code class="literal">memcached</code>.</p><p>Modules have a specific directory structure. Not all of these directories need to be present, but if they are, this is how they should be organized:</p><div class="informalexample"><pre class="programlisting">modules/
  └MODULE_NAME/  <span class="emphasis"><em>never use a dash (-) in a module name</em></span>
     └examples/ <span class="emphasis"><em>example usage of the module</em></span>
     └files/ <span class="emphasis"><em>flat files used by the module</em></span>
     └lib/
        └facter/ <span class="emphasis"><em>define new facts for facter</em></span>
        └puppet/
           └parser/
              └functions/ <span class="emphasis"><em>define a new puppet function, like sort() </em></span>
           └provider/ <span class="emphasis"><em>define a provider for a new or existing type</em></span>
           └util/ <span class="emphasis"><em>define helper functions (in ruby)</em></span>
           └type/ <span class="emphasis"><em>define a new type in puppet</em></span>
     └manifests/
        └init.pp  <span class="emphasis"><em>class MODULE_NAME { }</em></span>
     └spec/ rSpec <span class="emphasis"><em>tests</em></span>
     └templates/ <span class="emphasis"><em>erb template files used by the module</em></span>
</pre></div><p>All manifest <a id="id74" class="indexterm"/>files (those containing Puppet code) live in the manifests directory. In our example, the <code class="literal">memcached</code> class is defined in the <code class="literal">manifests/init.pp</code> file, which will be imported automatically.</p><p>Inside the <code class="literal">memcached</code> class, we refer to the <code class="literal">memcached.conf</code> file:</p><div class="informalexample"><pre class="programlisting">file { '/etc/memcached.conf':
  source =&gt; 'puppet:///modules/memcached/memcached.conf',
}</pre></div><p>The preceding <code class="literal">source</code> parameter tells Puppet to look for the file in:</p><p>
<code class="literal">MODULEPATH/   (/home/thomas/.puppet/modules)</code>
</p><p>
<code class="literal">  └memcached/</code>
</p><p>
<code class="literal">    └files/</code>
</p><p>
<code class="literal">      └memcached.conf</code>
</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec25"/>There's more…</h2></div></div></div><p>Learn to love modules because they'll make your Puppet life a lot easier. They're not complicated, however, practice and experience will help you judge when things should be grouped into modules, and how best to arrange your module structure. Modules can hold more than manifests and files as we'll see in the next two sections.</p><div class="section" title="Templates"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec13"/>Templates</h3></div></div></div><p>If you need to use a template<a id="id75" class="indexterm"/> as a part of the module, place it in the module's templates directory and refer to it as follows:</p><div class="informalexample"><pre class="programlisting">file { '/etc/memcached.conf':
  content =&gt; template('memcached/memcached.conf.erb'),
}</pre></div><p>Puppet will look for the file in:</p><div class="informalexample"><pre class="programlisting">MODULEPATH/memcached/templates/memcached.conf.erb</pre></div></div><div class="section" title="Facts, functions, types, and providers"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec14"/>Facts, functions, types, and providers</h3></div></div></div><p>Modules can also contain<a id="id76" class="indexterm"/> custom facts, <a id="id77" class="indexterm"/>custom functions, <a id="id78" class="indexterm"/>custom types, and <a id="id79" class="indexterm"/>providers.</p><p>For more information about these, refer to <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span>.</p></div></div><div class="section" title="Third-party modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec26"/>Third-party modules</h2></div></div></div><p>You can download modules provided by<a id="id80" class="indexterm"/> other people and use them in your own manifests just like the modules you create. For more on this, see Using Public Modules recipe in <a class="link" href="ch07.html" title="Chapter 7. Managing Applications">Chapter 7</a>, <span class="emphasis"><em>Managing Applications</em></span>.</p><div class="section" title="Module organization"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec15"/>Module organization</h3></div></div></div><p>For more details on how to<a id="id81" class="indexterm"/> organize your modules, see puppetlabs <a id="id82" class="indexterm"/>website:</p><p>
<a class="ulink" href="http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html">http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html</a>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec27"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating custom facts</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using public modules</em></span> recipe in <a class="link" href="ch07.html" title="Chapter 7. Managing Applications">Chapter 7</a>, <span class="emphasis"><em>Managing Applications</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating your own resource types</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating your own providers</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span></li></ul></div></div></div>
<div class="section" title="Using standard naming conventions"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec17"/>Using standard naming conventions</h1></div></div></div><p>Choosing appropriate <a id="id83" class="indexterm"/>and informative names for your modules and classes will be a big help when it comes to maintaining your code. This is even truer if other people need to read and work on your manifests.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec28"/>How to do it…</h2></div></div></div><p>Here are some tips on how to name things in your manifests:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Name modules after the software or service they manage, for example, <code class="literal">apache</code> or <code class="literal">haproxy</code>.</li><li class="listitem">Name classes within modules (subclasses) after the function or service they provide to the module, for example, <code class="literal">apache::vhosts</code> or <code class="literal">rails::dependencies</code>.</li><li class="listitem">If a class within a module disables the service provided by that module, name it <code class="literal">disabled</code>. For example, a class that disables Apache should be named <code class="literal">apache::disabled</code>.</li><li class="listitem">Create a roles and profiles hierarchy of modules. Each node should have a single role consisting of one or more profiles. Each profile module should configure a single service.</li><li class="listitem">The module that manages users should be named <code class="literal">user</code>.</li><li class="listitem">Within the user module, declare your virtual users within the class <code class="literal">user::virtual</code> (for more on virtual users and other resources, see the <span class="emphasis"><em>Using virtual resources</em></span> recipe in <a class="link" href="ch05.html" title="Chapter 5. Users and Virtual Resources">Chapter 5</a>, <span class="emphasis"><em>Users and Virtual Resources</em></span>).</li><li class="listitem">Within the user module, subclasses <a id="id84" class="indexterm"/>for particular groups of users should be named after the group, for example, <code class="literal">user::sysadmins</code> or <code class="literal">user::contractors</code>.</li><li class="listitem">When using Puppet to deploy the config files for different services, name the file after the service, but with a suffix indicating what kind of file it is, for example:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Apache init script: <code class="literal">apache.init</code></li><li class="listitem" style="list-style-type: disc">Logrotate config snippet for Rails: <code class="literal">rails.logrotate</code></li><li class="listitem" style="list-style-type: disc">Nginx vhost file for mywizzoapp: <code class="literal">mywizzoapp.vhost.nginx</code></li><li class="listitem" style="list-style-type: disc">MySQL config for standalone server: <code class="literal">standalone.mysql</code></li></ul></div></li><li class="listitem">If you need to deploy a different version of a file depending on the operating system release, for example, you can use a naming convention like the following:<div class="informalexample"><pre class="programlisting">memcached.lucid.conf
memcached.precise.conf</pre></div></li><li class="listitem">You can have Puppet automatically select the appropriate version as follows:<div class="informalexample"><pre class="programlisting">source = &gt; "puppet:///modules/memcached
  /memcached.${::lsbdistrelease}.conf",</pre></div></li><li class="listitem">If you need to manage, for example, different Ruby versions, name the class after the version it is responsible for, for example, <code class="literal">ruby192</code> or <code class="literal">ruby186</code>.</li></ol></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec29"/>There's more…</h2></div></div></div><p>Puppet community maintains a set of best practice guidelines<a id="id85" class="indexterm"/> for your Puppet infrastructure, which includes some hints on naming conventions:</p><p>
<a class="ulink" href="http://docs.puppetlabs.com/guides/best_practices.html">http://docs.puppetlabs.com/guides/best_practices.html</a>
</p><p>Some people prefer to include multiple classes on a node by using a comma-separated list, rather than separate <code class="literal">include</code> statements, for example:</p><div class="informalexample"><pre class="programlisting">  node 'server014' inherits 'server' {
    include mail::server, repo::gem, repo::apt, zabbix
  }</pre></div><p>This is a matter of style, but I prefer to use separate <code class="literal">include</code> statements, one on a line, because it makes it easier to copy and move around class inclusions between nodes without having to tidy up the commas and indentation every time.</p><p>I mentioned inheritance in a couple of the preceding examples; if you're not sure what this is, don't worry, I'll explain this in detail in the next chapter.</p></div></div>
<div class="section" title="Using inline templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec18"/>Using inline templates</h1></div></div></div><p>Templates are a powerful way of using <a id="id86" class="indexterm"/>
<span class="strong"><strong>Embedded Ruby</strong></span> (<span class="strong"><strong>ERB</strong></span>) to help build config files dynamically. You can also use ERB syntax directly without having to use a separate file by calling the <code class="literal">inline_template</code> function. ERB allows you to use conditional logic, iterate over arrays, and include variables.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec30"/>How to do it…</h2></div></div></div><p>Here's an example of<a id="id87" class="indexterm"/> how to use <code class="literal">inline_template</code>:</p><p>Pass your Ruby code to <code class="literal">inline_template</code> within Puppet manifest, as follows:</p><div class="informalexample"><pre class="programlisting">cron { 'chkrootkit':
  command =&gt; '/usr/sbin/chkrootkit &gt;
    /var/log/chkrootkit.log 2&gt;&amp;1',
  hour    =&gt; inline_template('&lt;%= @hostname.sum % 24 %&gt;'),
  minute  =&gt; '00',
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec31"/>How it works…</h2></div></div></div><p>Anything inside the string passed to <code class="literal">inline_template</code> is executed as if it were an ERB template. That is, anything inside the <code class="literal">&lt;%=</code> and <code class="literal">%&gt;</code> delimiters will be executed as Ruby code, and the rest will be treated as a string.</p><p>In this example, we use <code class="literal">inline_template</code> to compute a different hour for this cron resource (a scheduled job) for each machine, so that the same job does not run at the same time on all machines. For more on this technique, see the <span class="emphasis"><em>Distributing cron jobs efficiently</em></span> recipe in <a class="link" href="ch06.html" title="Chapter 6. Managing Resources and Files">Chapter 6</a>, <span class="emphasis"><em>Managing Resources and Files</em></span>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec32"/>There's more...</h2></div></div></div><p>In ERB code, whether<a id="id88" class="indexterm"/> inside a template file or an <code class="literal">inline_template</code> string, you can access your Puppet variables directly by name using an <code class="literal">@</code> prefix, if they are in the current scope or the top scope (facts):</p><div class="informalexample"><pre class="programlisting">&lt;%= @fqdn %&gt;</pre></div><p>To reference variables in another scope, use <code class="literal">scope.lookupvar</code>, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;%= "The value of something from otherclass is " + scope.lookupvar('otherclass::something') %&gt;</pre></div><p>You should use inline templates sparingly. If you really need to use some complicated logic in your manifest, consider using a custom function instead (see the <span class="emphasis"><em>Creating custom functions</em></span> recipe in <a class="link" href="ch09.html" title="Chapter 9. External Tools and the Puppet Ecosystem">Chapter 9</a>, <span class="emphasis"><em>External Tools and the Puppet Ecosystem</em></span>).</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec33"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using ERB templates</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Working with Files and Packages">Chapter 4</a>, <span class="emphasis"><em>Working with Files and Packages</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using array iteration in templates</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Working with Files and Packages">Chapter 4</a>, <span class="emphasis"><em>Working with Files and Packages</em></span></li></ul></div></div></div>
<div class="section" title="Iterating over multiple items"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec19"/>Iterating over multiple items</h1></div></div></div><p>Arrays are a powerful feature in<a id="id89" class="indexterm"/> Puppet; wherever you want to perform the same operation on a list of things, an array may be able to help. You can create an array just by putting its content in square brackets:</p><div class="informalexample"><pre class="programlisting">$lunch = [ 'franks', 'beans', 'mustard' ]</pre></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec34"/>How to do it…</h2></div></div></div><p>Here's a common example of how arrays are used:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code to your manifest:<div class="informalexample"><pre class="programlisting">$packages = [ 'ruby1.8-dev',
  'ruby1.8',
  'ri1.8',
  'rdoc1.8',
  'irb1.8',
  'libreadline-ruby1.8',
  'libruby1.8',
  'libopenssl-ruby' ]

package { $packages: ensure =&gt; installed }</pre></div></li><li class="listitem">Run Puppet and note that each package should now be installed.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec35"/>How it works…</h2></div></div></div><p>Where Puppet encounters an array as the name of a resource, it creates a resource for each element in the array. In the example, a new package resource is created for each of the packages in the <code class="literal">$packages</code> array, with the same parameters (<code class="literal">ensure =&gt; installed</code>). This is a very compact way to instantiate many similar resources.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec36"/>There's more…</h2></div></div></div><p>Although arrays will take you <a id="id90" class="indexterm"/>a long way with Puppet, it's also useful to know about an even more flexible data structure: the hash.</p><div class="section" title="Using hashes"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec16"/>Using hashes</h3></div></div></div><p>A hash is like an <a id="id91" class="indexterm"/>array, but each of the elements can be stored and looked up by name (referred to as the key), for example (<code class="literal">hash.pp</code>):</p><div class="informalexample"><pre class="programlisting">$interface = {
  'name' =&gt; 'eth0',
  'ip'   =&gt; '192.168.0.1',
  'mac'  =&gt; '52:54:00:4a:60:07' 
}
notify { "(${interface['ip']}) at ${interface['mac']} on ${interface['name']}": }</pre></div><p>When we run Puppet on this, we see the following notify in the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply hash.pp</strong></span>
<span class="strong"><strong>Notice: (192.168.0.1) at 52:54:00:4a:60:07 on etho</strong></span>
</pre></div><p>Hash values can be anything that you can assign to variables, strings, function calls, expressions, and even other hashes or arrays. Hashes are useful to store a bunch of information about a particular thing because by accessing each element of the hash using a key, we can quickly find the information for which we are looking.</p></div><div class="section" title="Creating arrays with the split function"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec17"/>Creating arrays with the split function</h3></div></div></div><p>You can declare literal <a id="id92" class="indexterm"/>arrays using square brackets, as <a id="id93" class="indexterm"/>follows:</p><div class="informalexample"><pre class="programlisting">define lunchprint() {
  notify { "Lunch included ${name}":}": }
}

$lunch = ['egg', 'beans', 'chips']
lunchprint { $lunch: }</pre></div><p>Now, when we run Puppet on the preceding code, we see the following notice messages in the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~ $ puppet apply lunchprint.pp </strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Notice: Lunch included chips</strong></span>
<span class="strong"><strong>Notice: Lunch included beans</strong></span>
<span class="strong"><strong>Notice: Lunch included egg</strong></span>
</pre></div><p>However, Puppet can <a id="id94" class="indexterm"/>also create arrays for you from strings, using<a id="id95" class="indexterm"/> the <code class="literal">split</code> function, as follows:</p><div class="informalexample"><pre class="programlisting">$menu = 'egg beans chips'
$items = split($menu, ' ')
lunchprint { $items: }</pre></div><p>Running <code class="literal">puppet apply</code> against this new manifest, we see the same messages in the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~ $ puppet apply lunchprint2.pp </strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>Notice: Lunch included chips</strong></span>
<span class="strong"><strong>Notice: Lunch included beans</strong></span>
<span class="strong"><strong>Notice: Lunch included egg.</strong></span>
</pre></div><p>Note that <code class="literal">split</code> takes two arguments: the first argument is the string to be split. The second argument is the character to split on; in this example, a single space. As Puppet works its way through the string, when it encounters a space, it will interpret it as the end of one item and the beginning of the next. So, given the string '<code class="literal">egg beans chips'</code>, this will be split into three items.</p><p>The character to split on can be any character or string:</p><div class="informalexample"><pre class="programlisting">$menu = 'egg and beans and chips'
$items = split($menu, ' and ')</pre></div><p>The character can also be a regular expression, for example, a set of alternatives separated by a <code class="literal">|</code> (pipe) character:</p><div class="informalexample"><pre class="programlisting">$lunch = 'egg:beans,chips'
$items = split($lunch, ':|,')</pre></div></div></div></div>
<div class="section" title="Writing powerful conditional statements"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec20"/>Writing powerful conditional statements</h1></div></div></div><p>Puppet's <code class="literal">if</code> statement <a id="id96" class="indexterm"/>allows you to change the manifest behavior based on the value of a variable or an expression. With it, you can apply different resources or parameter values depending on certain facts about the node, for example, the operating system, or the memory size.</p><p>You can also set variables within the manifest, which can change the behavior of included classes. For example, nodes in data center A might need to use different DNS servers than nodes in data center B, or you might need to include one set of classes for an Ubuntu system, and a different set for other systems.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec37"/>How to do it…</h2></div></div></div><p>Here's an example of a useful<a id="id97" class="indexterm"/> conditional statement. Add the following code to your manifest:</p><div class="informalexample"><pre class="programlisting">  if $::timezone == 'UTC' {
    notify { 'Universal Time Coordinated':}
  } else {
    notify { "$::timezone is not UTC": }
  }</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec38"/>How it works…</h2></div></div></div><p>Puppet treats whatever follows an <code class="literal">if</code> keyword as an expression and evaluates it. If the expression evaluates to true, Puppet will execute the code within the curly braces.</p><p>Optionally, you can add an else branch, which will be executed if the expression evaluates to false.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec39"/>There's more…</h2></div></div></div><p>Here are some more tips on using <code class="literal">if</code> statements.</p><div class="section" title="Elseif branches"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec18"/>Elseif branches</h3></div></div></div><p>You can add <a id="id98" class="indexterm"/>further tests <a id="id99" class="indexterm"/>using the <code class="literal">elseif</code> keyword, as follows:</p><div class="informalexample"><pre class="programlisting">if $::timezone == 'UTC' {
  notify { 'Universal Time Coordinated': }
} elseif $::timezone == 'GMT' {
  notify { 'Greenwich Mean Time': }
} else {
  notify { "$::timezone is not UTC": }
}</pre></div></div><div class="section" title="Comparisons"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec19"/>Comparisons</h3></div></div></div><p>You can check whether two values <a id="id100" class="indexterm"/>are equal using the <code class="literal">==</code> syntax, as in<a id="id101" class="indexterm"/> our example:</p><div class="informalexample"><pre class="programlisting">if $::timezone == 'UTC' {
  
}</pre></div><p>Alternatively, you can check whether they are not equal using <code class="literal">!=</code>:</p><div class="informalexample"><pre class="programlisting">if $::timezone != 'UTC' {
  …
}</pre></div><p>You can also compare<a id="id102" class="indexterm"/> numeric values using <code class="literal">&lt;</code> and <code class="literal">&gt;</code>:</p><div class="informalexample"><pre class="programlisting">if $::uptime_days &gt; 365 {
  notify { 'Time to upgrade your kernel!': }
}</pre></div><p>To test whether a value is greater (or less) than or equal to another value, use <code class="literal">&lt;=</code> or <code class="literal">&gt;=</code>:</p><div class="informalexample"><pre class="programlisting">if $::mtu_eth0 &lt;= 1500 {
  notify {"Not Jumbo Frames": }
}</pre></div></div><div class="section" title="Combining expressions"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec20"/>Combining expressions</h3></div></div></div><p>You can put together the <a id="id103" class="indexterm"/>kind of simple <a id="id104" class="indexterm"/>expressions described previously into more complex logical expressions, using <code class="literal">and</code>, <code class="literal">or</code>, and <code class="literal">not</code>:</p><div class="informalexample"><pre class="programlisting">if ($::uptime_days &gt; 365) and ($::kernel == 'Linux') {
  …
}

if ($role == 'webserver') and ( ($datacenter == 'A') or ($datacenter == 'B') ) {
  …
}</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec40"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using the in operator</em></span> recipe in this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using selectors and case statements</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using regular expressions in if statements"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec21"/>Using regular expressions in if statements</h1></div></div></div><p>Another kind of expression you can<a id="id105" class="indexterm"/> test in <code class="literal">if</code> statements and other <a id="id106" class="indexterm"/>conditionals is the regular expression. A regular expression is a powerful way to compare strings using pattern matching.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec41"/>How to do it…</h2></div></div></div><p>This is one example of using a regular expression in a conditional statement. Add the following to your manifest:</p><div class="informalexample"><pre class="programlisting">if $::architecture =~ /64/ {
  notify { '64Bit OS Installed': }
} else {
  notify { 'Upgrade to 64Bit': }
  fail('Not 64 Bit')
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec42"/>How it works…</h2></div></div></div><p>Puppet treats the text supplied <a id="id107" class="indexterm"/>between the forward slashes as a <a id="id108" class="indexterm"/>regular expression, specifying the text to be matched. If the match succeeds, the <code class="literal">if</code> expression will be true and so the code between the first set of curly braces will be executed. In this example, we used a regular expression because different distributions have different ideas on what to call <code class="literal">64bit</code>; some use <code class="literal">amd64</code>, while others use <code class="literal">x86_64</code>. The only thing we can count on is the presence of the number 64 within the fact. Some facts that have version numbers in them are treated as strings to Puppet. For instance, <code class="literal">$::facterversion</code>. On my test system, this is <code class="literal">2.0.1</code>, but when I try to compare that with <code class="literal">2</code>, Puppet fails to make the comparison:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Error: comparison of String with 2 failed at /home/thomas/.puppet/manifests/version.pp:1 on node cookbook.example.com</strong></span>
</pre></div><p>If you wanted instead to do something if the text does not match, use <code class="literal">!~</code> rather than <code class="literal">=~</code>:</p><div class="informalexample"><pre class="programlisting">if $::kernel !~ /Linux/ {
  notify { 'Not Linux, could be Windows, MacOS X, AIX, or ?': }
}</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec43"/>There's more…</h2></div></div></div><p>Regular expressions are very powerful, but can be difficult to understand and debug. If you find yourself using a regular expression so complex that you can't see at a glance what it does, think about simplifying your design to make it easier. However, one particularly useful feature of regular expressions is the ability to capture patterns.</p><div class="section" title="Capturing patterns"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec21"/>Capturing patterns</h3></div></div></div><p>You can not only match text using a <a id="id109" class="indexterm"/>regular expression, but also capture the matched text and store it in a variable:</p><div class="informalexample"><pre class="programlisting">$input = 'Puppet is better than manual configuration'
if $input =~ /(.*) is better than (.*)/ {
  notify { "You said '${0}'. Looks like you're comparing ${1}
    to ${2}!": }
}</pre></div><p>The preceding code produces this output:</p><p>
<span class="strong"><strong>You said 'Puppet is better than manual configuration'. Looks like you're comparing Puppet to manual configuration!</strong></span>
</p><p>The variable <code class="literal">$0</code> stores the <a id="id110" class="indexterm"/>whole matched text (assuming the overall match succeeded). If you put brackets around any part of the regular expression, it creates a group, and any matched groups will also be stored in variables. The first matched group will be <code class="literal">$1</code>, the second <code class="literal">$2</code>, and so on, as shown in the preceding example.</p></div><div class="section" title="Regular expression syntax"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec22"/>Regular expression syntax</h3></div></div></div><p>Puppet's regular<a id="id111" class="indexterm"/> expression syntax is the same as Ruby's, so resources that explain Ruby's regular expression syntax will also help you with Puppet. You can find a good introduction to Ruby's regular expression<a id="id112" class="indexterm"/> syntax at this website:</p><p>
<a class="ulink" href="http://www.tutorialspoint.com/ruby/ruby_regular_expressions.htm">http://www.tutorialspoint.com/ruby/ruby_regular_expressions.htm</a>.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec44"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to the <span class="emphasis"><em>Using regular expression substitutions</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using selectors and case statements"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec22"/>Using selectors and case statements</h1></div></div></div><p>Although you could write any conditional statement using <code class="literal">if</code>, Puppet provides a couple of extra forms to help you express conditionals more easily: the selector and the <code class="literal">case</code> statement.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec45"/>How to do it…</h2></div></div></div><p>Here are some<a id="id113" class="indexterm"/> examples of selector <a id="id114" class="indexterm"/>and <code class="literal">case</code> statements:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code to your manifest:<div class="informalexample"><pre class="programlisting">$systemtype = $::operatingsystem ? {
  'Ubuntu' =&gt; 'debianlike',
  'Debian' =&gt; 'debianlike',
  'RedHat' =&gt; 'redhatlike',
  'Fedora' =&gt; 'redhatlike',
  'CentOS' =&gt; 'redhatlike',
  default  =&gt; 'unknown',
}

notify { "You have a ${systemtype} system": }</pre></div></li><li class="listitem">Add the following code to your manifest:<div class="informalexample"><pre class="programlisting">class debianlike {
  notify { 'Special manifest for Debian-like systems': }
}

class redhatlike {
  notify { 'Special manifest for RedHat-like systems': }
}

case $::operatingsystem {
  'Ubuntu',
  'Debian': {
    include debianlike
  }
  'RedHat',
  'Fedora',
  'CentOS',
  'Springdale': {
    include redhatlike
  }
  default: {
    notify { "I don't know what kind of system you have!":
    }
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec46"/>How it works…</h2></div></div></div><p>Our example demonstrates both the selector and the <code class="literal">case</code> statement, so let's see in detail how each of them works.</p><div class="section" title="Selector"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec23"/>Selector</h3></div></div></div><p>In the first example, we <a id="id115" class="indexterm"/>used a selector (the <code class="literal">?</code> operator) to choose a value for the <code class="literal">$systemtype</code> variable depending on the value of <code class="literal">$::operatingsystem</code>. This is similar to the ternary operator in C or Ruby, but instead of choosing between two possible values, you can have as many values as you like.</p><p>Puppet will compare the value of <code class="literal">$::operatingsystem</code> to each of the possible values we have supplied in Ubuntu, Debian, and so on. These values could be regular expressions (for example, for a partial string match, or to use wildcards), but in our case, we have just used literal strings.</p><p>As soon as it finds a match, the selector expression returns whatever value is associated with the matching string. If the value of <code class="literal">$::operatingsystem</code> is Fedora, for example, the selector expression will return the <code class="literal">redhatlike</code> string and this will be assigned to the variable <code class="literal">$systemtype</code>.</p></div><div class="section" title="Case statement"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec24"/>Case statement</h3></div></div></div><p>Unlike selectors, the <code class="literal">case</code> statement does <a id="id116" class="indexterm"/>not return a value. <code class="literal">case</code> statements come in handy when you want to execute different code depending on the value of some expression. In our second example, we used the <code class="literal">case</code> statement to include either the <code class="literal">debianlike</code> or <code class="literal">redhatlike</code> class, depending on the value of <code class="literal">$::operatingsystem</code>.</p><p>Again, Puppet compares the value of <code class="literal">$::operatingsystem</code> to a list of potential matches. These could be regular expressions or strings, or as in our example, comma-separated lists of strings. When it finds a match, the associated code between curly braces is executed. So, if the value of <code class="literal">$::operatingsystem</code> is <code class="literal">Ubuntu</code>, then the code including <code class="literal">debianlike</code> will be executed.</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec47"/>There's more…</h2></div></div></div><p>Once you've got a grip of the basic use of selectors and <code class="literal">case</code> statements, you may find the following tips useful.</p><div class="section" title="Regular expressions"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec25"/>Regular expressions</h3></div></div></div><p>As with <code class="literal">if</code> statements, you can use<a id="id117" class="indexterm"/> regular expressions with selectors and <code class="literal">case</code> statements, and you can also capture the values of the matched groups and refer to them using <code class="literal">$1</code>, <code class="literal">$2</code>, and so on:</p><div class="informalexample"><pre class="programlisting">case $::lsbdistdescription {
  /Ubuntu (.+)/: {
    notify { "You have Ubuntu version ${1}": }
  }
  /CentOS (.+)/: {
    notify { "You have CentOS version ${1}": }
  }
  default: {}
}</pre></div></div><div class="section" title="Defaults"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec26"/>Defaults</h3></div></div></div><p>Both selectors <a id="id118" class="indexterm"/>and <code class="literal">case</code> statements let you specify a default value, which is chosen if none of the other options match (the style guide suggests you always have a default clause defined):</p><div class="informalexample"><pre class="programlisting">$lunch = 'Filet mignon.'
$lunchtype =  $lunch ? {
  /fries/ =&gt; 'unhealthy',
  /salad/ =&gt; 'healthy',
  default =&gt; 'unknown',
}

notify { "Your lunch was ${lunchtype}": }</pre></div><p>The output is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@mylaptop ~ $ puppet apply lunchtype.pp</strong></span>
<span class="strong"><strong>Notice: Your lunch was unknown</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Notify[Your lunch was unknown]/message: defined 'message' as 'Your lunch was unknown'</strong></span>
</pre></div><p>When the default action shouldn't normally occur, use the <code class="literal">fail()</code> function to halt the Puppet run.</p></div></div></div>
<div class="section" title="Using the in operator"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec23"/>Using the in operator</h1></div></div></div><p>The <code class="literal">in</code> operator tests <a id="id119" class="indexterm"/>whether one string contains another string. Here's an example:</p><div class="informalexample"><pre class="programlisting">if 'spring' in 'springfield'</pre></div><p>The preceding expression is true if the <code class="literal">spring</code> string is a substring of <code class="literal">springfield</code>, which it is. The <code class="literal">in</code> operator can also test for membership of arrays as follows:</p><div class="informalexample"><pre class="programlisting">if $crewmember in ['Frank', 'Dave', 'HAL' ]</pre></div><p>When <code class="literal">in</code> is used with a hash, it tests whether the string is a key of the hash:</p><div class="informalexample"><pre class="programlisting">$ifaces = { 'lo'   =&gt; '127.0.0.1', 
            'eth0' =&gt; '192.168.0.1' }
if 'eth0' in $ifaces {
  notify { "eth0 has address ${ifaces['eth0']}": }
}</pre></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec48"/>How to do it…</h2></div></div></div><p>The following steps will show you how to use the <code class="literal">in</code> operator:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code to your manifest:<div class="informalexample"><pre class="programlisting">if $::operatingsystem in [ 'Ubuntu', 'Debian' ] {
  notify { 'Debian-type operating system detected': }
} elseif $::operatingsystem in [ 'RedHat', 'Fedora', 'SuSE', 'CentOS' ] {
  notify { 'RedHat-type operating system detected': }
} else {
  notify { 'Some other operating system detected': }
}</pre></div></li><li class="listitem">Run <a id="id120" class="indexterm"/>Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply in.pp</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook.example.com in environment production in 0.03 seconds</strong></span>
<span class="strong"><strong>Notice: Debian-type operating system detected</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Notify[Debian-type operating system detected]/message: defined 'message' as 'Debian-type operating system detected'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.02 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec49"/>There's more…</h2></div></div></div><p>The value of an <code class="literal">in</code> expression is Boolean (true or false) so you can assign it to a variable:</p><div class="informalexample"><pre class="programlisting">$debianlike = $::operatingsystem in [ 'Debian', 'Ubuntu' ]

if $debianlike {
  notify { 'You are in a maze of twisty little packages, all alike': }
}</pre></div></div></div>
<div class="section" title="Using regular expression substitutions"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec24"/>Using regular expression substitutions</h1></div></div></div><p>Puppet's <code class="literal">regsubst</code> function <a id="id121" class="indexterm"/>provides an easy way to manipulate text, search and replace expressions within strings, or extract patterns from strings. We often need to do this with data obtained from a fact, for example, or from external programs.</p><p>In this example, we'll see how to use <code class="literal">regsubst</code> to extract the first three octets of an IPv4 address (the network part, assuming it's a <code class="literal">/24</code> class C address).</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec50"/>How to do it…</h2></div></div></div><p>Follow these steps to build the example:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following code to your manifest:<div class="informalexample"><pre class="programlisting">$class_c = regsubst($::ipaddress, '(.*)\..*', '\1.0')
notify { "The network part of ${::ipaddress} is ${class_c}": }</pre></div></li><li class="listitem">Run Puppet:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply ipaddress.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook.example.com in environment production in 0.02 seconds</strong></span>
<span class="strong"><strong>Notice: The network part of 192.168.122.148 is</strong></span>
<span class="strong"><strong>  192.168.122.0</strong></span>
<span class="strong"><strong>Notice: /Stage[main]/Main/Notify[The network part of 192.168.122.148 is</strong></span>
<span class="strong"><strong>  192.168.122.0]/message: defined 'message' as 'The network part of 192.168.122.148 is</strong></span>
<span class="strong"><strong>  192.168.122.0'</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.03 seconds</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec51"/>How it works…</h2></div></div></div><p>The <code class="literal">regsubst</code> function<a id="id122" class="indexterm"/> takes <a id="id123" class="indexterm"/>at least three parameters: source, pattern, and replacement. In our example, we specified the source string as <code class="literal">$::ipaddress</code>, which, on this machine, is as follows:</p><div class="informalexample"><pre class="programlisting">192.168.122.148</pre></div><p>We specify the <code class="literal">pattern</code> function as follows:</p><div class="informalexample"><pre class="programlisting">(.*)\..*</pre></div><p>We specify the <code class="literal">replacement</code> function as follows:</p><div class="informalexample"><pre class="programlisting">\1.0</pre></div><p>The pattern captures all of the string up to the last period (<code class="literal">\.</code>) in the <code class="literal">\1</code> variable. We then match on <code class="literal">.*</code>, which matches everything to the end of the string, so when we replace the string at the end with <code class="literal">\1.0</code>, we end up with only the network portion of the IP address, which evaluates to the following:</p><div class="informalexample"><pre class="programlisting">192.168.122.0</pre></div><p>We could have got the same result in other ways, of course, including the following:</p><div class="informalexample"><pre class="programlisting">$class_c = regsubst($::ipaddress, '\.\d+$', '.0')</pre></div><p>Here, we only match the last octet and replace it with <code class="literal">.0</code>, which achieves the same result without capturing.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec52"/>There's more…</h2></div></div></div><p>The <code class="literal">pattern</code> function can be any regular expression, using the same (Ruby) syntax as regular expressions in <code class="literal">if</code> statements.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec53"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Importing dynamic information</em></span> recipe in <a class="link" href="ch03.html" title="Chapter 3. Writing Better Manifests">Chapter 3</a>, <span class="emphasis"><em>Writing Better Manifests</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Getting information about the environment</em></span> recipe in <a class="link" href="ch03.html" title="Chapter 3. Writing Better Manifests">Chapter 3</a>, <span class="emphasis"><em>Writing Better Manifests</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using regular expressions in if statements</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using the future parser"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec25"/>Using the future parser</h1></div></div></div><p>Puppet language is evolving at <a id="id124" class="indexterm"/>the moment; many features that are expected to be included in the next major release (4) are available if you enable the future parser.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec54"/>Getting ready</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Ensure that the <code class="literal">rgen</code> gem is installed.</li><li class="listitem" style="list-style-type: disc">Set <code class="literal">parser = future</code> in the <code class="literal">[main]</code> section of your <code class="literal">puppet.conf</code>(<code class="literal">/etc/puppet/puppet.conf</code> for open source Puppet as <code class="literal">root,/etc/puppetlabs/puppet/puppet.conf</code> for Puppet <code class="literal">Enterprise, and~/.puppet/puppet.conf</code> for a non-root user running puppet).</li><li class="listitem" style="list-style-type: disc">To temporarily test with the future parser, use <code class="literal">--parser=future</code> on the command line.</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec55"/>How to do it...</h2></div></div></div><p>Many of the experimental features deal with how code is evaluated, for example, in an earlier example we compared the value of the <code class="literal">$::facterversion</code> fact with a number, but the value is treated as a string so the code fails to compile. Using the future parser, the value is converted and no error is reported as shown in the following command line output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply --parser=future version.pp </strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook.example.com in environment production in 0.36 seconds</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.03 seconds</strong></span>
</pre></div><div class="section" title="Appending to and concatenating arrays"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec27"/>Appending to and concatenating arrays</h3></div></div></div><p>You can concatenate <a id="id125" class="indexterm"/>arrays with the <code class="literal">+</code> operator or append them with the <code class="literal">&lt;&lt;</code> operator. In the <a id="id126" class="indexterm"/>following example, we use the ternary operator to assign a specific package name to the <code class="literal">$apache</code> variable. We then append that value to an array using the <code class="literal">&lt;&lt;</code> operator:</p><div class="informalexample"><pre class="programlisting">$apache = $::osfamily ? {
  'Debian' =&gt; 'apache2',
  'RedHat' =&gt; 'httpd'
} 
$packages = ['memcached'] &lt;&lt; $apache
package {$packages: ensure =&gt; installed}</pre></div><p>If we have two arrays, we can use the <code class="literal">+</code> operator to concatenate the two arrays. In this example, we define an array of system administrators (<code class="literal">$sysadmins</code>) and another array of application owners (<code class="literal">$appowners</code>). We can then concatenate the array and use it as an argument to our allowed users:</p><div class="informalexample"><pre class="programlisting">$sysadmins = [ 'thomas','john','josko' ]
$appowners = [ 'mike', 'patty', 'erin' ]
$users = $sysadmins + $appowners
notice ($users)</pre></div><p>When we apply this manifest, we see that the two arrays have been joined as shown in the following command line output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply --parser=future concat.pp Notice: [thomas, john, josko, mike, patty, erin]</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook.example.com in environment production in 0.36 seconds</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.03 seconds</strong></span>
<span class="strong"><strong>Merging Hashes</strong></span>
</pre></div><p>If we have two hashes, we can merge them using the same <code class="literal">+</code> operator we used for arrays. Consider our <code class="literal">$interfaces</code> hash from a previous example; we can add another interface to the hash:</p><div class="informalexample"><pre class="programlisting">$iface = {
  'name' =&gt; 'eth0',
  'ip'   =&gt; '192.168.0.1',
  'mac'  =&gt; '52:54:00:4a:60:07' 
}  + {'route' =&gt; '192.168.0.254'}
notice ($iface)</pre></div><p>When we apply this manifest, we see that the route attribute has been merged into the hash (your results may differ, the order in which the hash prints is unpredictable), as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply --parser=future hash2.pp</strong></span>
<span class="strong"><strong>Notice: {route =&gt; 192.168.0.254, name =&gt; eth0, ip =&gt; 192.168.0.1, mac =&gt; 52:54:00:4a:60:07}</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook.example.com in environment production in 0.36 seconds</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.03 seconds</strong></span>
</pre></div></div><div class="section" title="Lambda functions"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec28"/>Lambda functions</h3></div></div></div><p>Lambda functions <a id="id127" class="indexterm"/>are iterators applied to arrays or hashes. You iterate through the array or hash and apply an iterator function such as <code class="literal">each</code>, <code class="literal">map</code>, <code class="literal">filter</code>, <code class="literal">reduce</code>, or <code class="literal">slice</code> to each element of the array or key of the hash. Some of the lambda functions return a calculated array or value; others such as <code class="literal">each</code> only return the input array or hash.</p><p>Lambda functions such as <code class="literal">map</code> and <code class="literal">reduce</code> use temporary variables that are thrown away after the lambda has finished. Use of lambda functions is something best shown by example. In the next few sections, we will show an example usage of each of the lambda functions.</p><div class="section" title="Reduce"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec01"/>Reduce</h4></div></div></div><p>Reduce<a id="id128" class="indexterm"/> is used to reduce the array to a single value. This can be used to calculate<a id="id129" class="indexterm"/> the maximum or minimum of the array, or in this case, the sum of the elements of the array:</p><div class="informalexample"><pre class="programlisting">$count = [1,2,3,4,5]
$sum = reduce($count) | $total, $i | { $total + $i }
notice("Sum is $sum")</pre></div><p>This preceding code will compute the sum of the <code class="literal">$count</code> array and store it in the <code class="literal">$sum</code> variable, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>t@cookbook:~/.puppet/manifests$ puppet apply --parser future lambda.pp</strong></span>
<span class="strong"><strong>Notice: Sum is 15</strong></span>
<span class="strong"><strong>Notice: Compiled catalog for cookbook.example.com in environment production in 0.36 seconds</strong></span>
<span class="strong"><strong>Notice: Finished catalog run in 0.03 seconds</strong></span>
</pre></div></div><div class="section" title="Filter"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec02"/>Filter</h4></div></div></div><p>Filter is <a id="id130" class="indexterm"/>used<a id="id131" class="indexterm"/> to filter the array or hash based upon a test within the lambda function. For instance to filter our <code class="literal">$count</code> array as follows:</p><div class="informalexample"><pre class="programlisting">$filter = filter ($count) | $i | { $i &gt; 3 } notice("Filtered array is $filter")</pre></div><p>When we apply this manifest, we see that only elements 4 and 5 are in the result:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Notice: Filtered array is [4, 5]</strong></span>
</pre></div></div><div class="section" title="Map"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec03"/>Map</h4></div></div></div><p>Map<a id="id132" class="indexterm"/> is used to apply a function to each element of the array. For instance, if we <a id="id133" class="indexterm"/>wanted (for some unknown reason) to compute the square of all the elements of the array, we would use <code class="literal">map</code> as follows:</p><div class="informalexample"><pre class="programlisting">$map = map ($count) | $i | { $i * $i } notice("Square of array is $map")</pre></div><p>The result of applying this manifest is a new array with every element of the original array squared (multiplied by itself), as shown in the following command line output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Notice: Square of array is [1, 4, 9, 16, 25]</strong></span>
</pre></div></div><div class="section" title="Slice"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec04"/>Slice</h4></div></div></div><p>Slice is useful <a id="id134" class="indexterm"/>when you have related values stored in the same array in a <a id="id135" class="indexterm"/>sequential order. For instance, if we had the destination and port information for a firewall in an array, we could split them up into pairs and perform operations on those pairs:</p><div class="informalexample"><pre class="programlisting">$firewall_rules = ['192.168.0.1','80','192.168.0.10','443']
slice ($firewall_rules,2) |$ip, $port| { notice("Allow $ip on $port") }</pre></div><p>When applied, this manifest will produce the following notices:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Notice: Allow 192.168.0.1 on 80</strong></span>
<span class="strong"><strong>Notice: Allow 192.168.0.10 on 443</strong></span>
</pre></div><p>To make this a useful example, create a new firewall resource within the block of the slice instead of notice:</p><div class="informalexample"><pre class="programlisting">slice ($firewall_rules,2) |$ip, $port| { firewall {"$port from $ip": dport  =&gt; $port, source =&gt; "$ip", action =&gt; 'accept', }
}</pre></div></div><div class="section" title="Each"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec05"/>Each</h4></div></div></div><p>Each <a id="id136" class="indexterm"/>is used to<a id="id137" class="indexterm"/> iterate over the elements of the array but lacks the ability to capture the results like the other functions. Each is the simplest case where you simply wish to do something with each element of the array, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">each ($count) |$c| { notice($c) }</pre></div><p>As expected, this executes the <code class="literal">notice</code> for each element of the <code class="literal">$count</code> array, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Notice: 1</strong></span>
<span class="strong"><strong>Notice: 2</strong></span>
<span class="strong"><strong>Notice: 3</strong></span>
<span class="strong"><strong>Notice: 4</strong></span>
<span class="strong"><strong>Notice: 5</strong></span>
</pre></div></div><div class="section" title="Other features"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec06"/>Other features</h4></div></div></div><p>There are other new features of Puppet language available when using the future parser. Some increase readability or compactness of code. For more information, refer to the documentation on <a id="id138" class="indexterm"/>puppetlabs website at <a class="ulink" href="http://docs.puppetlabs.com/puppet/latest/reference/experiments_future.html">http://docs.puppetlabs.com/puppet/latest/reference/experiments_future.html</a>.</p></div></div></div></div></body></html>