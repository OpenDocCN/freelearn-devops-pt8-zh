<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">SQL in Azure - Azure SQL</h1>
                </header>
            
            <article>
                
<p>Microsoft SQL Server is one of the most popular databases and is often the core of many popular applications. Thanks to Azure, we can skip the whole cluster setup, installation, and maintenance by using Azure SQL—a cloud version of SQL Server with the same features available. Thanks to flexible pricing, we can select whichever option we want when it comes to both performance and available features. We don't have to worry about geo-replication and storing backups either—all these functionalities can be easily configured and automated in the cloud.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Differences between Microsoft SQL Server and Azure SQL</li>
<li>Working with Azure SQL in the Azure portal</li>
<li>Security features of Azure SQL</li>
<li>Scaling and monitor Azure SQL</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>To perform the exercises in this chapter, you will need:</p>
<ul>
<li>An Azure subscription</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Differences between Microsoft SQL Server and Azure SQL</h1>
                </header>
            
            <article>
                
<p><strong>Microsoft SQL Server</strong> is a well-known and widely used SQL database server that has gained much popularity and is considered a default choice for many projects ranging from very simple websites to enterprise-class services that handle high load and are considered critical for a business. As cloud technologies gain more and more popularity, the natural consequence of such a situation is the expectation that by moving an application to Azure, it is also possible to move its database. To meet such needs, Microsoft has developed Azure SQL<em> </em>Service—a PaaS version of Microsoft SQL Server that is managed and upgraded by their teams; the only things you are responsible for are configuration and data management. There is also one more offering from Azure called SQL Server VMs, which is one more option for using this database in the cloud. In this section, we will focus on the differences between these two offerings and try to identify different use cases for them.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure SQL fundamentals</h1>
                </header>
            
            <article>
                
<p>By using PaaS services in the cloud, you are shifting responsibilities a little bit:</p>
<ul>
<li>You are no longer the maintainer of the infrastructure</li>
<li>You are no longer responsible for different updates when software is considered</li>
<li>By signing SLA with you, your provider is responsible for making sure that a service is up and running</li>
</ul>
<p>Instead, you should focus on the following points:</p>
<ul>
<li>Properly configuring a service, so it meets your performance targets and legal requirements</li>
<li>Integrating different services and applications, so they reflect the best practices when it comes to communicating with a service</li>
<li>Implementing HA/DR scenarios, so an outage or disaster in one region does not impact your systems</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>
<p>By using Microsoft SQL Server, you are fully on your/leased machines, which you have to maintain and monitor. While such a case is valid in many scenarios (as there can be some legal requirements that disallow you from storing data outside your own data center or simply, for some reason, Azure does not provide you with the expected performance you seek), yet in many situations, having a PaaS instance of your SQL database is a big improvement. In fact, you are given a few different options when using this service:</p>
<ul>
<li>A single database with isolated resources</li>
<li>A pooled database in an elastic pool</li>
<li>Managed instance, which is the closest model when it comes to comparing it with on-premise SQL Server</li>
</ul>
<p>The important thing to know is that all new features and updates are deployed to SQL databases hosted within Azure. This gives you an advantage in comparison with traditional Microsoft SQL Server, as you are always up to date: you do not have to schedule updates on your servers on your own.</p>
<div class="packt_tip">The more servers and databases you have, the more complicated and difficult the process of updating them becomes. Take that into account when comparing these two offerings.</div>
<p>Another crucial thing when talking about Azure SQL<em> </em>is its purchasing model. Currently, you have two options:</p>
<ul>
<li><span><strong><span>DTU-based</span></strong></span><span>: A DTU is a mix of computing, memory, and I/O resources that are given to your database</span></li>
<li><strong>vCore-based</strong><span>: This one simply allows you to select all things on your own (including the number of vCores, the amount of memory, and storage performance)</span></li>
<li>
<p> </p>
</li>
</ul>
<p>You may wonder how a DTU reflects the actual hardware; there is a good article that tries to explain these metrics a little bit in the <em>Further reading</em><strong> </strong>section for this chapter.</p>
<div class="packt_tip">In most cases, using DTU as the metric is the better choice—very often it is hard to predict the exact hardware requirements for your application. Use the vCore-based model when you are an advanced SQL server user and know how many cores or memory you really need.</div>
<p>You may wonder, What are the scaling capabilities of Azure SQL<em> </em>Service? While of course you can assign more (or fewer) resources to your database, there are scenarios when this makes things much more complicated (or simply your application has different demands when it comes to database performance, and such a model simply will not work). To cover those situations, you are given the option to use elastic pools. The concept is pretty simple—normally you allocate resources to a single database:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/215e67c3-8b87-471c-a2fb-c381f4d57b89.png" style="width:12.33em;height:15.42em;" width="202" height="252"/></div>
<p>With elastic pools, you change the model a little bit and instead your pool has resources allocated, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/8a9f1c64-8fac-476d-bc59-39df5876e062.png" style="width:17.17em;height:14.92em;" width="288" height="250"/></p>
<p>What does that change? Well, this gives you much more flexibility; instead of hosting a huge single database (when it comes to resources allocated), you can easily scale it out, so it can share the load with other instances. What is more, it gives you better control when it comes to costs; you can scale your databases at the same time without the need to control what their individual needs are.</p>
<div class="packt_infobox">Scaling Azure SQL<em> </em>is an important topic that requires initially much attention—we will come back to it at the end of this chapter.</div>
<p>Besides performance and different scaling capabilities, Azure SQL<em> </em>gives you many additional features that are very important when considering it as storage for your data. Because an application without information stored in a database is, in most cases, useless, availability considerations are also very important here. Fortunately, Azure SQL<em> </em>has implemented many great features that make it a full-fledged storage option:</p>
<ul>
<li><strong>Automatic backups</strong>: In the on-premise world, configuring and managing backups is much more complicated, as it requires you to know the server configuration and find a place to store them. In Azure, things are greatly simplified by integrating automatic backups for Azure Storage for performance and reliability.</li>
<li><strong>Geo-replication</strong>: Even if a single region fails, you can still serve data for your customers. With Azure SQL,<em> </em>you can configure a secondary read region that will make sure you can stay online until an outage is resolved.</li>
<li><strong>Failover groups</strong>: Instead of implementing failover capabilities and logic on your own, you can rely on what Azure SQL<em> </em>currently provides. This makes creating globally distributed applications much easier as you care only about the configuration and not infrastructure.</li>
</ul>
<div class="packt_infobox">To know exactly what is different in Azure SQL<em> </em>in comparison with Microsoft SQL Server, you can refer to the following link : <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-features">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-features</a>.</div>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Advanced Azure SQL features</h1>
                </header>
            
            <article>
                
<p>Besides some basic functionalities that ensure Azure SQL<em> </em>is a full version of a relational database on which you can rely and build your system, there are plenty of additional features that make using this service real fun:</p>
<ul>
<li><strong>Automatic monitoring and tuning</strong>: How many times, after using a database for several months, have you ended up with a database full of outdated indexes, procedures, and functions? Azure SQL<em> </em>makes things much easier by actively monitoring how you use and maintain your database and advising you whenever an improvement is possible. I find this feature extremely helpful—nowadays, when development is especially rapid and focused on delivering new values to the market, it is really easy to get lost and lose track of what should be removed from a database. With the service recommendations for dropping indexes, schema improvements, and queries parameterization, I find my storage in much better shape for most of the time.</li>
<li><strong>Adaptive query processing</strong>: While this feature is also available for SQL Server, having it in Azure SQL<em> </em>is a great addition to other performance recommendations. Basically, when it is enabled, the server engine tries to find the best execution plan for your queries.</li>
<li><strong>Security and compliance features</strong>: It is really important to ensure that the data you store is secure and all vulnerabilities are detected as quickly as possible. In Azure SQL,<em> </em>you are given plenty of additional features that try to analyze your data in terms of sensitivity and compliance. There are in-built tools which search for any kind of anomalies and threats that could affect data integrity or lead to their leak. Additionally, Azure SQL<em> </em>is integrated with the Azure <strong>Active Directory</strong> (<strong>AD</strong>)<em> </em>and allows for <strong>multi-factor authentication</strong> (<strong>MFA</strong>)—this makes things such as auditing and authorization much easier without additional effort.</li>
</ul>
<div class="packt_infobox">The security features for Azure SQL<em> </em>will be described later in this chapter so you have the whole picture of this service's capabilities that matter.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">SQL Server on VMs</h1>
                </header>
            
            <article>
                
<p>If you do not want to go full PaaS, you can create a virtual machine with a SQL Server image already in-built. In that option, the performance of the service will rely on the performance of the VM—if you find the database running low on CPU or memory, the only thing you have to do is to scale up the machine. To create a VM in the portal, you have to search for a SQL Server running on an OS of your choice, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3594814b-b8c4-485f-a9fa-d050ee553bc1.png" width="906" height="379"/></p>
<p>As you can see, there are free SQL Server licenses available and what is more, newer versions can run on Linux machines. Once you select the image you are interested in, you can click on the <span class="packt_screen">Create</span><strong> </strong>button to begin the machine's configuration.</p>
<p class="mce-root"/>
<p>As you can see in the following screenshot, there are many fields which have to be filled in to be able to actually use the service:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/155147a0-85a0-43c8-aec8-fd4f17b8de8f.png" width="779" height="648"/></p>
<p>This is, of course, related to the IaaS model of that way of hosting SQL Server inside Azure. The configuration wizard will advise you about the default size of the VM and other parameters required for the machine. Once the configuration is completed, you will be able to connect to it either via RDP or a secured SSH tunnel.</p>
<div class="packt_tip">Remember to open the <kbd>1433</kbd> <span>port if you want to connect to SQL Server remotely.</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating and configuring Azure SQL</h1>
                </header>
            
            <article>
                
<p>After reading the beginning of this chapter, you should be able to sense how Azure SQL<em> </em>works and what it offers for you. While some theory is always a good thing, it is practice which creates the full picture and allows you to fully understand the topic. In this section, we will focus on creating and configuring Azure SQL<em> </em>in the portal and trying to identify all the afore mentioned features. You will also see how managing this PaaS service is different from the on-premise version, especially when it comes to using its features.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure SQL instance</h1>
                </header>
            
            <article>
                
<p>In the Azure portal, when you search for <kbd>Azure SQL</kbd>, you will see plenty of different options such as <span class="packt_screen">SQL Database</span>, <span class="packt_screen">SQL server (logical server),</span> or <span class="packt_screen">SQL Elastic database pool.</span> While they all allow you to create a database, the easiest way to get started with the service is to use<strong><span class="packt_screen"> SQL Database</span></strong>—this will require creating a server nonetheless. In the following screenshot, you can find a configuration for my server:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b8042750-0e51-4897-bd82-c59edca12788.png" style="width:18.33em;height:31.00em;" width="302" height="511"/></p>
<p>The following shows the configuration for my database:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f01983c7-8f69-4bba-85cf-b8ab5e3eb9aa.png" style="width:21.92em;height:36.58em;" width="362" height="607"/></p>
<p>The important thing here is to select the source—you have three options here:</p>
<ul>
<li><span class="packt_screen">Blank database</span>: In most cases this will be the first option you are interested in</li>
<li><span class="packt_screen">Sample</span>: I used it so I already have data inside my database</li>
<li><span class="packt_screen">Backup</span>: A great option if you want to provision a database from an available backup</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>
<p>For the <span class="packt_screen">Blank database</span><strong> </strong>option, you will also have the possibility to select a collation; in that dropdown, select the option that is correct for your data. We will also focus a little bit on the pricing configuration:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1731cfc8-9ddf-4d6c-9aa5-fe1c39f731ba.png" width="1116" height="523"/></p>
<p>As you can see, when using the DTU model, you have available three different tiers:</p>
<ul>
<li><span class="packt_screen">Basic</span>: For smaller workloads</li>
<li><span class="packt_screen">Standard</span>: This offers the best balance between cost and performance</li>
<li><span class="packt_screen">Premium</span>: For all workloads which require massive performance capabilities</li>
</ul>
<p class="mce-root"/>
<p>Depending on the tier, you will be offered either a fixed DTU amount (for <span class="packt_screen">Basic</span>) or you will have to select the amount you are interested in:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2456e246-2c66-4024-94e5-d622d4be616d.png" width="748" height="389"/></p>
<div class="packt_tip">The important thing here is the fact that most of your database costs are resources-allocated—remember to select the biggest database size you can (for example, in the Standard<strong> </strong>tier and with 400 DTU selected, there is no difference in the pricing between 100 MB and 250 GB).</div>
<p class="mce-root"/>
<p>Of course, you can also switch between a DTU-based model and vCores selection:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/9bf3db10-3cd1-4c2c-85ea-86b1d6136673.png" width="1111" height="584"/></div>
<p>When using vCores, selecting the <span class="packt_screen">Max data size</span><strong> </strong>does affect the pricing. What is more, here you have two different tiers available:</p>
<ul>
<li><span class="packt_screen">General Purpose</span>: The best choice for most common scenarios without specific needs when it comes to resiliency and traffic</li>
<li><span class="packt_screen">Business Critical</span>: This tier offers better performance and lower latency (and is significantly more expensive)</li>
</ul>
<p class="mce-root"/>
<p>When you are satisfied with your configuration, you can click on the <span class="packt_screen">Create</span><strong> </strong>button, so the provisioning process will start. When it is finished, you can access your resource by going to the <span class="packt_screen">Overview</span><strong> </strong>blade where basic info is available:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7e58e2d2-82d0-4081-bb9f-bf894aa5e4f1.png" width="1160" height="560"/></p>
<p>Now we will try to go through most of the features, so you will have a better understanding of how to work with this service.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure SQL features in the portal</h1>
                </header>
            
            <article>
                
<p>We will start with the <span class="packt_screen">Configure</span><strong> </strong>blade—when you click on it, you will see that it allows you to set both the tier and the pricing model of your database. This option is especially helpful when you want to improve the performance of your database; you can easily change the amount of DTU or vCores allocated for it, so it can work with queries much quicker.</p>
<div class="packt_infobox">As I mentioned before, configuring a single database will work for simpler scenarios, where you can easily monitor it and the performance requirements do not rapidly change. In all other cases, the better option is to use elastic pools.</div>
<p class="mce-root">When you go to the <span class="packt_screen">Geo-Replication</span><strong> </strong>blade, you will see a similar map to the one you saw when testing Azure Cosmos DB:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/db6fcc21-0bb2-4f2a-9c8b-51fd114222a0.png" width="993" height="708"/></div>
<p>From this screen, you can quickly create a secondary region, which allows you to perform a failover when you need it. To do so, click on the region you are interested in and that will display the <span class="packt_screen">Create secondary</span><strong> </strong>screen:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/cfda0160-901b-4a58-bed4-455216f39554.png" style="width:20.50em;height:35.25em;" width="297" height="511"/></p>
<p>You will have to once more create a server (if there are none already available inside a region) and the pricing tier (which of course can be different for a secondary). Additionally, from this blade, you can enable a failover group for your database—to do so, click on the following panel:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/87381cd7-54c1-400e-89d2-a8ed885adcdb.png" style="width:50.83em;height:3.50em;" width="697" height="48"/></p>
<p>By implementing a failover group, you can introduce an automatic failover for your database:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6abd4abb-de30-4c08-a25d-3e312ad18cde.png" style="width:21.42em;height:44.17em;" width="297" height="613"/></p>
<p>However, if you want to perform a forced failover, you can click on the secondary database, which will display a screen that allows that operation to be performed:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/901f610e-3677-4d25-a3c9-8b052bc75b95.png" style="width:16.58em;height:24.00em;" width="301" height="436"/></p>
<div class="packt_infobox">Remember that performing a failover can take some time to fully propagate—make sure you are ready for that.</div>
<p>When you proceed to the <span class="packt_screen">Connection strings</span><strong> </strong>blade, you will see a template for a connection string for different environments:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/bfa7bcec-a788-4508-ac4a-f6599c77c9da.png" style="width:52.75em;height:16.17em;" width="1084" height="332"/></div>
<p>You will also be able to download different drivers for <span class="packt_screen">ADO.NET</span>, <span class="packt_screen">JDBC</span>, <span class="packt_screen">ODBC</span>, or <span class="packt_screen">PHP</span>.</p>
<div class="packt_infobox">Remember that the service presents only a template for your connection string—you will have to set your username and password to make it work.</div>
<p>Currently, we are exploring SQL Database in Azure—let's check exactly what SQL Server looks like currently. You can find it by clicking on the server name<strong> </strong>on the <span class="packt_screen">Overview</span><strong> </strong>blade. Initially, the screen will look the same, but you will quickly realize that it offers many different features:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d89b59fa-d40e-4392-b377-4ddad5fda1b8.png" width="1211" height="707"/></div>
<p>Unfortunately, we will not able to go through all of the features, but I will try to describe most of them for you. When we look at the <span class="packt_screen">Settings</span><strong> </strong>section, we can see the following blades:</p>
<ul>
<li><span class="packt_screen">Failover groups</span>: As discussed previously, to introduce automatic failover you have to create a failover group. A group consists of a primary and secondary server, which have a defined failover policy and grace period—a setting which defines the time between outage detection and the actual failover.</li>
<li><span class="packt_screen">Manage Backups</span>: To configure backups for your server (for example – enable LTR) you can access this blade. It also displays all available backups.</li>
<li><span class="packt_screen">Active Directory admin</span>: It is possible to set an admin for your server using a user which is defined within your Active Directory users. Of course, you can set more than a single user for that—the trick is to use a group instead of an individual account.</li>
<li><span class="packt_screen">SQL databases</span>: To quickly access a database that is served by this particular server, use this blade.</li>
<li><span class="packt_screen">SQL elastic pools</span>: Similarly to SQL Databases, this blade displays available elastic pools. To create a new pool, go to the <span class="packt_screen">Overview</span><strong> </strong>blade and click on the <span class="packt_screen">+ New pool</span><strong> </strong>button.</li>
<li><span class="packt_screen">Deleted databases</span>: Even if a database is removed from a service, you will still have a chance to restore it. In such a scenario, consult that blade for all databases available to be restored.</li>
<li><span class="packt_screen">Import/Export history</span>: All import and export operations on your databases will be displayed here. This is a great auditing tool, so you will not miss a situation when somebody exported your data without notice.</li>
<li><span class="packt_screen">DTU quota</span>: If you are interested in seeing the quota for DTU/vCores for your server, you can access this blade.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Security</h1>
                </header>
            
            <article>
                
<p>When it comes to Azure SQL<em> </em>features, there are multiple different options you can use to make your solution secure. Things such as firewalls, full operation auditing, and data encryption are the common capabilities of this service and are available even for the Basic tier. In this section, we will focus on learning the afore mentioned capabilities, so your instance is secured and immune to most threats.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Firewall</h1>
                </header>
            
            <article>
                
<p>When browsing your SQL Database, you probably noticed the <span class="packt_screen">Set server firewall</span><strong> </strong>button that is available on the <span class="packt_screen">Overview</span><strong> </strong>blade:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b4d54771-0e24-49d0-875b-4331568d1214.png" width="666" height="83"/></p>
<p>This is the easiest way to set a firewall rule that allows traffic to Azure SQL.</p>
<div class="packt_infobox">In Azure SQL, initially all traffic is rejected—you have to whitelist all IPs of computers that should be allowed to communicate with the server.</div>
<p>Before we start configuring the firewall, you have to understand why we really need it. Here is what happens if I try to connect to my server using Microsoft SQL Server Management Studio:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/a6542c90-eff9-48bc-a508-def5927147b5.png" style="width:36.50em;height:26.08em;" width="470" height="336"/></div>
<p>As you can see, it automatically detects that my IP is not whitelisted, hence the server refuses to communicate with me. What we need here is to add a particular IP address, so the communication will be allowed.</p>
<div class="packt_tip">In fact, the only machines allowed to communicate by default with Azure SQL<em> </em>are those that are hosted within Azure. If you want to connect to the server from a local computer, you have to set up a firewall rule.</div>
<p>In the portal, you can add the rule by clicking on the <span class="packt_screen">Set server firewall</span><strong> </strong>button—it will display a screen, where you can explicitly set an IP address that should be able to communicate with the server:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/91bec3cc-ea73-4682-bcd2-f5c903db9a93.png" style="width:37.58em;height:37.08em;" width="571" height="563"/></div>
<p>From this screen, you can also prevent the Azure service from communicating with your instance of Azure SQL. Additionally, you can add a virtual network here—thanks to that feature, you can create the whole ecosystem with your applications and databases, so they are protected from accessing it with a very strict set of rules.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Advanced Threat Protection</h1>
                </header>
            
            <article>
                
<p><strong><span>Advanced Threat Protection</span></strong> (<strong>ATP</strong><span>) is an advanced feature of Azure SQL that by default is not enabled in the service. Currently, it allows for a free trial of 60 days, during which you can test whether this capability is for you. You can enable it using<strong><span class="packt_screen"> </span></strong></span>the <span><strong><span class="packt_screen">Advanced Threat Protection</span> </strong>blade:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6b1a105b-68cd-4c6f-9df0-a00f35620093.png" style="width:44.58em;height:35.33em;" width="642" height="509"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>As you can see, it consists of three separate features:</p>
<ul>
<li><span class="packt_screen">Data Discovery &amp; Classification</span>: For analyzing data in terms of sensitivity and legal classification (for example—GDPR requirements)</li>
<li><span class="packt_screen"><span>Vulnerability Assessment</span></span><span>: This checks your database for possible vulnerabilities using the best practices for SQL Server</span></li>
<li><span class="packt_screen">Threat Detection</span>: A feature which actively monitors your database for suspicious activities and logs them for you</li>
</ul>
<p>In the following, you can see how Azure SQL<em> </em>classifies example data:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5d542c0a-ad79-4cf2-951d-eede011ccd4a.png" width="805" height="520"/></p>
<p>It turns out that it automatically detected the information type and declares its sensitivity label. Then it displays a summary, which gives you the overall picture of the shape of the data stored in a database.</p>
<div class="packt_tip">This feature is a great tool for analyzing big databases for compliance with the new regulations—use it when in doubt as to whether you are storing some sensitive data.</div>
<p class="mce-root"/>
<p>When it comes to <span class="packt_screen">Vulnerability Assesment</span>, the following<span> </span><span>are the results of the example scans from my database:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d5da7dc0-7280-4abf-8285-607a4d562881.png" width="460" height="364"/></div>
<p>Once a scan is finished, you are given the result of a security check – it checks things such as data classification, whether auditing is enabled, or who can access data. If, for example, you have many users with a wide range of permissions assigned, there will be an alert raised for that. There are almost 50 rules checked during a scan, which is a great addition on top of all other security features.</p>
<div class="packt_tip">Even more security guides can be found in the relevant link in the <em>Further reading</em><strong> </strong>section.</div>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Auditing</h1>
                </header>
            
            <article>
                
<p>If you want to know exactly what happens inside your server, you have to enable auditing:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/cb671657-f490-4cf9-9e54-e085215afff0.png" width="810" height="571"/></p>
<p>This will log all operations within the selected storage (if, of course, you selected the <span class="packt_screen">Storage</span> option). Currently, there are three different options for storing auditing logs:</p>
<ul>
<li><span class="packt_screen">Storage</span></li>
<li><span class="packt_screen">Log Analytics (Preview)</span></li>
<li><span class="packt_screen">Event Hub <span>(Preview)</span></span></li>
</ul>
<p class="mce-root"/>
<p>While <span class="packt_screen">Storage</span> is a little bit of a static option, you can use the remaining two for more dynamic integrations (especially when using Azure Event Hub). Once auditing is enabled, you can see all logged operations as well when you click on the <span class="packt_screen">View audit logs</span><strong> </strong>button:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/91ba7367-9473-4104-9187-5f9621e5abf4.png" width="840" height="537"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Dynamic Data Masking</h1>
                </header>
            
            <article>
                
<p>Sometimes you want to allow somebody to read data inside a database, yet at the same time you do not want him or her to read more sensitive data (such as birth date, addresses, or surnames). In Azure SQL,<em> </em>there is a feature for that named <span class="packt_screen">Dynamic Data Maskin</span>g:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0de07043-4768-410f-8cd6-035a7c9251ab.png" width="872" height="599"/></p>
<p>There are two ways to add a mask—either use the recommendation or click on the <span class="packt_screen">+ Add Mask</span><strong> </strong>button to add it manually:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3b1de14c-c57a-402b-b18b-90f69b47b8c9.png" style="width:18.25em;height:27.00em;" width="295" height="437"/></p>
<p>What you will have to do select <span class="packt_screen">Schema</span>, <span class="packt_screen">Table</span>, <span class="packt_screen">Column</span>, and the <span class="packt_screen">Mask field format</span>—once you configure these and save the rule, users who are not administrators will see the masked values instead. The following shows the values for an admin:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/67982b94-b052-4ffc-bf57-d7fea3723322.png" style="width:48.25em;height:20.25em;" width="770" height="323"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The following shows the values for a user without admin rights:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/780566ac-f8f2-4f0d-b48b-9b254869c20b.png" width="774" height="321"/></p>
<p>As you can see, <kbd>LastName</kbd><strong> </strong>and <kbd>Email</kbd><strong> </strong>are masked for a non-admin user, as planned.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Scaling Azure SQL</h1>
                </header>
            
            <article>
                
<p>The required performance of your database may differ depending on the time and current state of your application. This is when scaling is all-important—you can adjust cost and available resources depending on the needs of your service. In Azure SQL,<em> </em>there are multiple different scenarios that you will consider: whether you use a single database or an elastic pool, whether you need to scale out reads, or whether you need all features available everywhere. In this short section, I will show you how to quickly proceed with your decision and where you can find scaling tools.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Single database</h1>
                </header>
            
            <article>
                
<p>As we mentioned previously, with a single database scaling is really simple—you just need to go to the <span class="packt_screen">Configure</span><strong> </strong>blade and select the new tier you are interested in. You can easily decide whether you need to scale a database up by watching its performance:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/61c51afb-81d1-4eba-a451-f6d6a4876e89.png" width="1397" height="687"/></p>
<p>If you see constant spikes or simply utilization of the database is becoming dangerously close to the maximum values, it is always a good decision to give it a few more DTUs or other resources.</p>
<div class="packt_tip">Remember, you can set alerts when utilization hits upper limits, so there are some ways to automate the process.</div>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Elastic pool</h1>
                </header>
            
            <article>
                
<p>With elastic pool enabled, things change a little bit—instead of operating on, for example, a DTU for a single database, you can select an elastic pool, which introduces a slightly different model of an elastic DTU:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b56616ee-2f0b-4018-aceb-33580235aa24.png" width="930" height="425"/></p>
<p>In that model, you scale your database using elastic pool configuration instead. For a single database, you will be able to only change the maximum data size available (which is also limited to the value set by the pool).</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Read scale-out</h1>
                </header>
            
            <article>
                
<p>Sometimes you only need to scale reads for your database. Such a situation occurs when you would rather serve content than modify it (for example, you have a very popular portal that is managed from a single place but is served globally). In Azure SQL,<em> </em>there is a possibility to scale out only a part of the service—the one responsible for managing reads for you. </p>
<div class="packt_infobox">Note that you need the Premium/Business Critical tier to get this feature working.</div>
<p class="mce-root"/>
<p>To enable read scale-out on your database, you can use the REST API:</p>
<pre>HTTP PUT https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{GroupName}/providers/Microsoft.Sql/servers/{ServerName}/databases/{DatabaseName}?api-version= 2014-04-01-preview<br/><br/>Body:<br/>{<br/>   "properties":<br/>   {<br/>      "readScale":"Enabled"<br/>   }<br/>}</pre>
<p>Alternatively, you can use PowerShell:</p>
<pre><strong>Set-AzureRmSqlDatabase -ResourceGroupName &lt;my-resource-group&gt; -ServerName &lt;my-server&gt; -DatabaseName &lt;my-database&gt; -ReadScale Disabled</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Sharding</h1>
                </header>
            
            <article>
                
<p>The last way to scale your database is to use sharding. As opposed to elastic pools, by using sharding you allocate individual resources to each of your databases. It is also one of the models for horizontal scaling (so you rather provision another database than scale up your existing one).</p>
<div class="packt_infobox">Note that you can use sharding also for elastic pools by using the Elastic Database split-merge tool: <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-elastic-scale-overview-split-and-merge">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-elastic-scale-overview-split-and-merge</a>.</div>
<p>In general, you will use sharding if you:</p>
<ul>
<li>Have too much data to be able to handle it with an individual instance</li>
<li>Want to load-balance requests</li>
<li>Want to geo-distribute your data</li>
</ul>
<p>The important thing here is the requirement that the data structure for each shard has to be the same. You can find the full documentation on sharding in Azure SQL<em> </em>in the <em>Further reading</em><strong> </strong>section for this chapter.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Monitoring and tuning</h1>
                </header>
            
            <article>
                
<p>The last item we cover in this chapter will be the monitoring and tuning of Azure SQL. Because databases are often the heart of many applications, it is crucial to have a quick way to diagnose any issues regarding performance or usage, and easily tweak things if needed. Azure SQL<em> </em>uses multiple different features that you can leverage to get insights from your instance.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Monitoring</h1>
                </header>
            
            <article>
                
<p>To monitor your SQL Database, you can use alerts, which should be familiar to you (assuming you have read the previous chapter, <span><a href="43da05ef-8416-4ff0-a983-b8a1665b2976.xhtml" target="_blank">Chapter 15</a>, <em>Using Application Insights to Monitor Your Applications</em></span><span>). You can access this functionality by clicking on the </span><span class="packt_screen">Alerts</span><strong> </strong><span>blade:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1d381f7c-4f73-458f-b7f9-c933d62d1fc3.png" style="width:45.50em;height:24.33em;" width="701" height="375"/></p>
<p>Here you have two types of alert available:</p>
<ul>
<li><span class="packt_screen">Add metric alert (classic)</span></li>
<li><span class="packt_screen">Add activity log alert</span></li>
</ul>
<p class="mce-root"/>
<p>The way they work is a little bit different—a metric alert<strong> </strong>is based on values such as CPU percentage, deadlocks, or total database size while an activity log alert<strong> </strong>is triggered<strong> </strong>whenever an event occurs. You can use them both simultaneously to cover the following things:</p>
<ul>
<li>Insufficient performance (metric)</li>
<li>Invalid queries (metric)</li>
<li>Configuration issues (metric)</li>
<li>Overall service health (metric)</li>
<li>Incoming maintenance activities (activity log)</li>
<li>Actual service issues (activity log)</li>
<li>Service health recommendations (activity log)</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Tuning</h1>
                </header>
            
            <article>
                
<p>There is a whole group of features, called <span class="packt_screen">Intelligent Performance</span>, which allow you to monitor and tune your SQL Database performance:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9b7e568c-040f-4f6d-b5c9-bd0b7970d603.png" style="width:13.92em;height:12.50em;" width="214" height="192"/></p>
<p>Let's check <span class="packt_screen">Performance recommendations</span><strong> </strong>for now:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/613aa4fb-558b-46b0-9c2f-227cc8ec1cec.png" style="width:60.17em;height:26.50em;" width="977" height="430"/></p>
<p>While initially this feature is empty, it displays different recommendations while working with Azure SQL<strong>.</strong><em><strong> </strong></em>The important thing here is that we can automate things—just click on the <span class="packt_screen">Automate</span><strong> </strong>button to display another screen where you can select what you are interested in:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2f271aeb-9e5a-479d-819a-e0c6252ae278.png" style="width:53.75em;height:31.33em;" width="879" height="513"/></p>
<p>This screen is, in fact, the <span class="packt_screen">Automatic tuning</span><strong> </strong>blade presented earlier. You can use it to automate things such as managing indexes or forcing a query plan.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>Azure SQL<em> </em>is a very complex and extended service that works in a similar way to its on-premise version, Microsoft SQL Server. While being a full PaaS Azure component, it still allows for many advanced operations such as sharding, multi-tenancy, AD integration or failover, and geo-replication. Besides being hosted within a cloud, you can still use it in the same way you would a standalone version of SQL Server. In the next chapter, we will cover the last PaaS service mentioned in this book, which is Azure Data Lake Storage.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>What is different in terms of update policy between Azure SQL<em> </em>and Microsoft SQL Server?</li>
<li>What is sharding?</li>
<li>You created a new SQL Database in Azure SQL, but the server refuses to connect to it. What could be the issue here?</li>
<li>What are the two available purchasing models for Azure SQL?</li>
<li>What is an elastic pool?</li>
<li>What is the difference between DTU and eDTU?</li>
<li>How can you mask a particular field in Azure SQL?</li>
<li>What audit log destinations are available?</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li>How to understand DTU: <a href="https://sqlperformance.com/2017/03/azure/what-the-heck-is-a-dtu">https://sqlperformance.com/2017/03/azure/what-the-heck-is-a-dtu</a></li>
<li>Performance recommendations: <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-advisor">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-advisor</a></li>
<li>Adaptive query processing:<strong> </strong><a href="https://docs.microsoft.com/pl-pl/sql/relational-databases/performance/adaptive-query-processing?view=sql-server-2017">https://docs.microsoft.com/pl-pl/sql/relational-databases/performance/adaptive-query-processing?view=sql-server-2017</a></li>
<li>Securing SQL Database: <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-security-overview">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-security-overview</a></li>
<li>Read scale-out:<strong> </strong><a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-read-scale-out">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-read-scale-out</a></li>
<li>Sharding:<strong> </strong><a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-elastic-scale-introduction">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-elastic-scale-introduction</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>