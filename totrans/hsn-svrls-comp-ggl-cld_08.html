<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Cloud Functions Labs</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we picked up some useful skills as we built an application to access si<span>gned URLs. One of the most common examples is building</span><span> </span><span>a website. So we will move on to expand our repertoire by creating a static website-based example database on Marvel Films. By the end of the chapter, you will understand how to enhance the various techniques presented earlier through rich code samples.</span></p>
<p>In our example, we will look at some tips on how to incorporate data and also take a first look at security in the context of service accounts. Beyond this, we will look at the main components of a static website and how this might potentially be enhanced.<br/>
The following topics will be covered in this chapter:</p>
<ul>
<li>Building a static website</li>
<li>Service account security</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>In order to complete the exercises in this chapter, you will require a Google Cloud project or a Qwiklabs account.</p>
<p class="mce-root">You can find the code files for this chapter in the GitHub repository for this book in the <kbd>ch06</kbd> <span>subdirectory </span>at <a href="https://github.com/PacktPublishing/Hands-on-Serverless-Computing-with-Google-Cloud/tree/master/ch06">https://github.com/PacktPublishing/Hands-on-Serverless-Computing-with-Google-Cloud/tree/master/ch06</a>.<a href="https://github.com/PacktPublishing/Hands-on-Serverless-Computing-with-Google-Cloud-Platform"/></p>
<div class="mce-root packt_infobox">While you are going through code snippets in the book, you will notice that, in a few instances, a few lines from the codes/outputs have been removed and replaced with ellipses (<kbd>...</kbd>). The use of ellipses serves to show <span>only </span>relevant code/output. The complete code is available on GitHub at the preceding link.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Building a static website</h1>
                </header>
            
            <article>
                
<p><span>In the following example, we will be building an application in which our now familiar function baseline code will consume an external data source (based on JSON) and output a view rendered against an HTML template.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Provisioning the environment</h1>
                </header>
            
            <article>
                
<p>We have seen this type of layout used previously in other Node.js applications (for example, <a href="4775f0c6-9325-4890-803a-e8feb14ee1d6.xhtml" target="_blank">Chapter 3</a>, <em>Introducing Lightweight Functions</em> and <a href="9431bfa5-ef43-4043-9779-d5b6d3fef36c.xhtml" target="_blank">Chapter 4</a>, <em>Developing Cloud Functions</em>), so in this chapter, the focus will be on building the code necessary to build our website.</p>
<p>To begin, follow these steps:</p>
<ol>
<li>Make a brand new directory in which to host our code.</li>
<li>Within the new directory, initialize the environment by performing <kbd>npm init --yes</kbd> at the command line to initialize our new development environment.</li>
<li>Complete the resulting <kbd>package.json</kbd> as per the following table: </li>
</ol>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td style="width: 19.6546%">
<p><strong>Field</strong></p>
</td>
<td class="CDPAlignLeft CDPAlign" style="width: 44.5393%">
<p><strong>Response</strong></p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Package name:</p>
</td>
<td style="width: 44.5393%">
<p><kbd>marvel-website</kbd></p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Version:</p>
</td>
<td style="width: 44.5393%">
<p>1.0.0</p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Description:</p>
</td>
<td style="width: 44.5393%">
<p>This is an example website built with Cloud Functions</p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Entry Point:</p>
</td>
<td style="width: 44.5393%">
<p><kbd>index.js</kbd></p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Test command:</p>
</td>
<td style="width: 44.5393%">
<p>blank</p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Git repository:</p>
</td>
<td style="width: 44.5393%">
<p>blank</p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Keywords:</p>
</td>
<td style="width: 44.5393%">
<p>blank</p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>Author:</p>
</td>
<td style="width: 44.5393%">
<p>Enter your name</p>
</td>
</tr>
<tr>
<td style="width: 19.6546%">
<p>License:</p>
</td>
<td style="width: 44.5393%">
<p>ISC</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p style="padding-left: 60px">As highlighted in <a href="9431bfa5-ef43-4043-9779-d5b6d3fef36c.xhtml" target="_blank">Chapter 4</a>, <em>Developing Cloud Functions</em> and <a href="633e9be2-53a4-483b-b6f2-844cd249cbd3.xhtml" target="_blank">Chapter 5</a>, <em>Exploring Functions as a Service</em>), to work locally we can use the <kbd>functions-framework</kbd> package. In addition, we will also need to install the <kbd>pug</kbd> package for the view template used to render HTML.</p>
<ol start="4">
<li>From the command line, install the necessary packages by issuing the following commands:</li>
</ol>
<pre style="padding-left: 60px"><strong><span>npm install @google-cloud/functions-framework<br/></span>npm install pug</strong></pre>
<ol start="5">
<li>Next, make a couple of new subdirectories to hold <kbd>views</kbd> and <kbd>data</kbd> in relation to the function:</li>
</ol>
<pre style="padding-left: 60px"><strong><span>mkdir data &amp;&amp; mkdir views</span></strong></pre>
<ol start="6">
<li>At this point, your directory structure should look similar to the following; that is, two files (<kbd>package.json</kbd> and <kbd>package-lock.json</kbd>) and three subdirectories (<kbd>data</kbd>, <kbd>views</kbd>, and <kbd>node_modules</kbd>):</li>
</ol>
<pre style="padding-left: 60px">.<br/>├── data<br/>├── node_modules<br/>├── package.json<br/>├── package-lock.json<br/>└── views</pre>
<p style="padding-left: 60px">Remember that, to use the Functions Framework within your application, you need to alter the <kbd>package.json</kbd> file to incorporate a <kbd>start</kbd> property.</p>
<ol start="7">
<li>Edit the <kbd>package.json</kbd> file and add a reference to the Functions Framework as outlined here:</li>
</ol>
<pre style="padding-left: 60px">  0 { <br/>  1   "name": "marvel-website", <br/>  2   "version": "1.0.0", <br/>  3   "description": "This is an example website built on Cloud Functions with Nodejs", <br/>  4   "main": "index.js", <br/>  5   "scripts": { <br/>  6    <strong> "start":"functions-framework --target=filmAPI",</strong> <br/>  7     "test": "echo \"Error: no test specified\" &amp;&amp; exit 1" <br/>  8   }, <br/>  9   "author": "Rich Rose", <br/> 10   "license": "ISC", <br/> 11   "dependencies": { <br/> 12     "@google-cloud/functions-framework": "^1.2.1", <br/> 13     "pug": "^2.0.4" <br/> 14   } <br/> 15 }</pre>
<p>The information highlighted in <em>line 6</em> shows the <span>necessary </span>startup command. Take note that the target entry point is called <kbd>filmAPI</kbd>, which means the exported function in our application will also need to match this signature. </p>
<p>Excellent! We have now created the basic structure of the application. Now we turn our attention to the data source that provides the information to be presented in our application.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a data source</h1>
                </header>
            
            <article>
                
<p>Turning our attention to the data directory, our next step is to create a <strong>JavaScript Object Notation</strong> (<strong>JSON</strong>) file to store our data. Using JSON is a quick and easy way to create an external data source, as follows:</p>
<ol start="1">
<li>Create a new file in the <kbd>data</kbd> subdirectory called <kbd>films.json</kbd>. This will hold our film information.</li>
<li>For the first film, add the content in the following table to it.</li>
</ol>
<p style="padding-left: 60px">To explain the schema used, let's examine the content of the text. The primary construct is an array in which we will create a number of placeholders for an object representing a film. The film object will expose several fields:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody style="padding-left: 60px">
<tr style="height: 35.9062px;padding-left: 60px">
<td style="width: 113px;height: 35.9062px;padding-left: 60px">
<p><strong>Field</strong></p>
</td>
<td style="width: 79px;height: 35.9062px;padding-left: 60px">
<p><strong>Type</strong></p>
</td>
<td style="width: 215px;height: 35.9062px;padding-left: 60px">
<p><strong>Comment</strong></p>
</td>
</tr>
<tr style="height: 32px;padding-left: 60px">
<td style="width: 113px;height: 32px;padding-left: 60px">
<p><kbd>title</kbd></p>
</td>
<td style="width: 79px;height: 32px;padding-left: 60px">
<p>String</p>
</td>
<td style="width: 215px;height: 32px;padding-left: 60px">
<p>Title of the film</p>
</td>
</tr>
<tr style="height: 32px;padding-left: 60px">
<td style="width: 113px;height: 32px;padding-left: 60px">
<p><kbd>director</kbd></p>
</td>
<td style="width: 79px;height: 32px;padding-left: 60px">
<p>String</p>
</td>
<td style="width: 215px;height: 32px;padding-left: 60px">
<p>Name of the film director</p>
</td>
</tr>
<tr style="height: 32px;padding-left: 60px">
<td style="width: 113px;height: 32px;padding-left: 60px">
<p><kbd>release</kbd></p>
</td>
<td style="width: 79px;height: 32px;padding-left: 60px">
<p>String</p>
</td>
<td style="width: 215px;height: 32px;padding-left: 60px">
<p>Release date of the film</p>
</td>
</tr>
<tr style="height: 32px;padding-left: 60px">
<td style="width: 113px;height: 32px;padding-left: 60px">
<p><kbd>description</kbd></p>
</td>
<td style="width: 79px;height: 32px;padding-left: 60px">
<p>String</p>
</td>
<td style="width: 215px;height: 32px;padding-left: 60px">
<p>General overview of the film plot</p>
</td>
</tr>
<tr style="height: 32px;padding-left: 60px">
<td style="width: 113px;height: 32px;padding-left: 60px">
<p><kbd>bgImage</kbd></p>
</td>
<td style="width: 79px;height: 32px;padding-left: 60px">
<p>String</p>
</td>
<td style="width: 215px;height: 32px;padding-left: 60px">
<p>URL for the film post</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p style="padding-left: 60px">Looking at the JSON file directly we can see how the data will be represented in the file:</p>
<div class="packt_tip packt_infobox">Note the comma at the end of the code block; this indicates we are going to add further content to the file. If we are not adding further content, no comma is added after the film object (see <em>The Avengers</em> object for comparison). </div>
<pre style="padding-left: 60px">{<br/>  "movies": [<br/>  {<br/>    "title": "Iron Man",<br/>    "director": "Jon Favreau",<br/>    "release": "2008",<br/>    "description": "Iron Man",<br/>    "bgImage": "https://upload.wikimedia.org/wikipedia/en/7/70/Ironmanposter.JPG"<br/>  }, </pre>
<ol start="3">
<li>Adding additional content such as <kbd>The Incredible Hulk</kbd> can be achieved by appending content at the end of the array record:</li>
</ol>
<pre style="padding-left: 60px">  {<br/>    "title": "The Incredible Hulk",<br/>    "director": "Louis Leterrier",<br/>    "release": "2008",<br/>    "description": "The Incredible Hulk",<br/>    "bgImage": "https://upload.wikimedia.org/wikipedia/en/8/88/The_Incredible_Hulk_poster.jpg"<br/>  },</pre>
<ol start="4">
<li> Add a new record for <kbd>Iron Man 2</kbd>:</li>
</ol>
<pre style="padding-left: 60px">  {<br/>    "title": "Iron Man 2",<br/>    "director": "Jon Favreau",<br/>    "release": "2010",<br/>    "description": "Iron Man 2",<br/>    "bgImage": "https://upload.wikimedia.org/wikipedia/en/e/ed/Iron_Man_2_poster.jpg"<br/>  },</pre>
<ol start="5">
<li> Add a new record based on <kbd>Thor</kbd>:</li>
</ol>
<pre style="padding-left: 60px">  {<br/>    "title": "Thor",<br/>    "director": "Kenneth Branagh",<br/>    "release": "2011",<br/>    "description": "Thor",<br/>    "bgImage": "https://upload.wikimedia.org/wikipedia/en/f/fc/Thor_poster.jpg"<br/>  },</pre>
<ol start="6">
<li>Add a new record for <kbd>Captain America</kbd>:</li>
</ol>
<pre style="padding-left: 60px">  {<br/>    "title": "Captain America: The First Avenger",<br/>    "director": "Joe Johnston",<br/>    "release": "2011",<br/>    "description": "Captain America: The First Avenger",<br/>    "bgImage": "https://upload.wikimedia.org/wikipedia/en/3/37/Captain_America_The_First_Avenger_poster.jpg"<br/>  },</pre>
<ol start="7">
<li>Finally, add a new record for <kbd>The Avengers</kbd>:</li>
</ol>
<pre style="padding-left: 60px"> {<br/>    "title": "The Avengers",<br/>    "director": "Joss Whedon",<br/>    "release": "2012",<br/>    "description": "Marvel's The Avengers",<br/>    "bgImage": "https://upload.wikimedia.org/wikipedia/en/f/f9/TheAvengers2012Poster.jpg"<br/>  }<br/>  ]<br/>}</pre>
<p>Based on the preceding code, we have created six new records to hold our data in an array. The intention is for the data to work as input for the Cloud Function we are about to create. In the real world, it is more likely that a database would suffice for this type of access. However, in this example, brevity is our friend, and so is JSON!</p>
<p class="mce-root">Now we have created a data source, we will need to implement an onscreen representation to illustrate the information to be displayed.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Designing a frontend</h1>
                </header>
            
            <article>
                
<p><span>Making a frontend in HTML should not present too much of a challenge as there are plenty of excellent examples available. In this section, we will take our schema and display it onscreen. The template to be used will be created in the <kbd>views</kbd> subdirectory and will feature in a new file named <kbd>index.pug</kbd> with the following content:</span></p>
<ul>
<li><span>Header definition</span></li>
<li><span>Card definition</span></li>
<li><span>Release definition</span></li>
<li><span>Description definition</span></li>
<li><span>Body definition</span></li>
</ul>
<p>From the preceding points, let's look into the contents of each section:</p>
<ol>
<li>The header definition uses standard HTML to incorporate style content. In the example, we create a new header style to alter both the font and alignment of text:</li>
</ol>
<pre style="padding-left: 60px">#message<br/>html<br/>  head<br/>    style.<br/>      .header {<br/>         text-align: center;<br/>         font-family: roboto;<br/>      }</pre>
<ol start="2">
<li>The <kbd>card</kbd> definition creates a new style that will visually look like an onscreen card:</li>
</ol>
<pre style="padding-left: 60px">      .card {<br/>         box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);<br/>         max-width: 600px;<br/>         margin: auto;<br/>         text-align: center;<br/>         font-family: roboto;<br/>      }</pre>
<ol start="3">
<li>The <kbd>release</kbd> definition creates color and font enhancements:</li>
</ol>
<pre style="padding-left: 60px">      .release {<br/>         color: grey;<br/>         font-size: 22px;<br/>      }</pre>
<ol start="4">
<li>The <kbd>description</kbd> definition creates enhancements with reference to the color, font size, and padding for any element associated with this style:</li>
</ol>
<pre style="padding-left: 60px">     .description {<br/>         color: black;<br/>         font-size: 18px;<br/>         padding: 8px;<br/>      }</pre>
<ol start="5">
<li>The <kbd>body</kbd> definition provides the main layout considerations for importing data via the Cloud Function: </li>
</ol>
<pre style="padding-left: 60px"> body<br/><br/>    div.header<br/>      H1 Functions Framework Example<br/>      H3 Google Cloud - Cloud Functions<br/>    div.card<br/>      img(src=items.bgImage style="width:100%")<br/>      h1 #{items.title}<br/>      div.release<br/>        h3 Released: #{items.release} &lt;br&gt;<br/>        h3 Director: #{items.director} &lt;br&gt;<br/>      div.description<br/>        p #{items.description}</pre>
<p>Let's break it down:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td>
<p><strong>Name</strong></p>
</td>
<td>
<p><strong>Type</strong></p>
</td>
<td>
<p><strong>Comment</strong></p>
</td>
</tr>
<tr>
<td>
<p>H1</p>
</td>
<td>
<p>Main heading</p>
</td>
<td>
<p>The page title</p>
</td>
</tr>
<tr>
<td>
<p>H3</p>
</td>
<td>
<p>Subheading</p>
</td>
<td>
<p>A subheading for the page</p>
</td>
</tr>
<tr>
<td>
<p>img</p>
</td>
<td>
<p>Image link</p>
</td>
<td>
<p>The URL link for the image</p>
</td>
</tr>
<tr>
<td>
<p>p</p>
</td>
<td>
<p>Paragraph</p>
</td>
<td>
<p class="mce-root">Description text</p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p>When creating a view, we are using information passed from the Cloud Function to populate the onscreen view. Specifically, we take the title, release date, director, and description from the schema information consumed from the JSON data file.</p>
<p>At this point in our example, we should now have the following directory structure, based on the files created in this example:</p>
<pre>├── data<br/>│ └── films.json<br/>├── node_modules<br/>├── package.json<br/>├── package-lock.json<br/>└── views<br/>    └── index.pug</pre>
<p>We have also created a data source based on a JSON file that holds information concerning films. The methods to add a new movie, remove a film, and alter information relating to a film should be self-evident, and the data file presents a convenient way to manage external data content. Also, the view is isolated from the primary function; thus, as a bonus, the presentation layer acts independently, making alteration easy. Finally, we need to create the service to perform integration between the data and view and generate an appropriate HTTP response.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Analyzing a Cloud Function</h1>
                </header>
            
            <article>
                
<p>The Cloud Function that we've defined doesn't have a significant amount of code associated with it. There are the following elements in our Cloud Function:</p>
<ul>
<li>Variable definitions</li>
<li>The private function</li>
<li>The public function</li>
</ul>
<p>To explain the various elements that we've outlined here, let's take a minute to explore each component in a bit more detail.</p>
<p>Variable definitions are as follows:</p>
<ul>
<li><strong>Line 1</strong>:<span> </span>The function starts with a declaration to include our temporary data store in which film information is stored. Again, this is an easy way to incorporate data into an application without needing additional infrastructure to be put in place. </li>
<li><strong>Line 2</strong>: Uses <kbd>pug</kbd> package dependencies and declares them for use within the function:</li>
</ul>
<pre style="padding-left: 60px">  0 // Define dependencies <br/>  1 var data = require('./data/films.json'); <br/>  2 var pug = require('pug'); </pre>
<p>The private function works as follows:</p>
<ul>
<li><strong>Line 6</strong>: Declares the view to be rendered based on the external view defined in the <kbd>index.pug</kbd> file</li>
<li><strong>Line 11</strong>: Creates the response object based on an HTTP status response code of 200 and an array value based on the item selected by the user when viewing the initial screen:</li>
</ul>
<pre style="padding-left: 60px">  3 <br/>  4 // Function: marvelFilm Detail <br/>  5 // Description: Show the information for the film selected <br/>  6 function filmDetail(req, res, movieRef) { <br/>  7   // Define the view to be displayed <br/>  8   const pugInputFile = pug.compileFile('views/index.pug'); <br/>  9 <br/> 10   // Create the HTML view <br/> 11   res.status(200).send(pugInputFile({ <br/> 12     // Pass data object [movies] to Pug <br/> 13     items : data.movies[movieRef] <br/> 14   })); <br/> 15 } </pre>
<p>The public function works as follows:</p>
<ul>
<li><span><strong>Line 31</strong>: A call to the <kbd>filmDetail</kbd> function passes the request, response, and data objects:</span></li>
</ul>
<pre style="padding-left: 60px"> 16 <br/> 17 // Entrypoint: marvelFilmAPI <br/> 18 // Description: This is the Cloud Function endpoint <br/> 19 exports.filmAPI= (req, res) =&gt; { <br/> 20   // Define the default view to be displayed <br/> 21   let filmNum = req.query.film || '00'; <br/> 22 <br/> 23   // Translate string to int <br/> 24   var movieRef = parseInt(filmNum, 10); <br/> 25 <br/> 26   // Simple validation <br/> 27   if (movieRef &gt; 5 || movieRef &lt; 0) <br/> 28     movieRef = 0; <br/> 29 <br/> 30   // Display the relevant film <br/> 31   filmDetail(req, res, movieRef); <br/> 32 }; </pre>
<p>When running the preceding application (that is, <kbd>npm start</kbd> from the command line), the details of the JSON filmography array will be displayed.</p>
<div class="packt_tip"><span>Note that query string URLs can be used to access information beyond the first film. An HTTP query mechanism like this can be useful when passing additional parameters to sub-components. In this instance, we use these parameters to select alternative pages to be displayed without having to amend the existing function code. </span></div>
<p>To select another film from the array of available films, use the URL query setting to access any film persisted in the film database, as demonstrated in the following table:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td style="width: 43.4324%">
<p><strong>Film</strong></p>
</td>
<td style="width: 55.9923%">
<p><strong>URL</strong></p>
</td>
</tr>
<tr>
<td style="width: 43.4324%"><span> 1. Iron Man</span></td>
<td style="width: 55.9923%">
<p><kbd>http://localhost:8080</kbd></p>
</td>
</tr>
<tr>
<td style="width: 43.4324%"><span> 2. The Incredible Hulk</span></td>
<td style="width: 55.9923%">
<p><kbd>http://localhost:8080/?film=1</kbd></p>
</td>
</tr>
<tr>
<td style="width: 43.4324%"><span> 3. Iron Man 2</span></td>
<td style="width: 55.9923%">
<p><kbd>http://localhost:8080/?film=2</kbd></p>
</td>
</tr>
<tr>
<td style="width: 43.4324%"><span> 4. Thor</span></td>
<td style="width: 55.9923%">
<p><kbd>http://localhost:8080/?film=3</kbd></p>
</td>
</tr>
<tr>
<td style="width: 43.4324%"><span> 5. Captain America: The First Avenger</span></td>
<td style="width: 55.9923%">
<p><kbd>http://localhost:8080/?film=4</kbd></p>
</td>
</tr>
<tr>
<td style="width: 43.4324%"><span> 6. The Avengers</span></td>
<td style="width: 55.9923%">
<p><kbd>http://localhost:8080/?film=5</kbd></p>
</td>
</tr>
</tbody>
</table>
<div class="packt_infobox"><br/>
If you are running this from cloud shell, take note that the URL will be different from that shown above. However, you are still able to append query settings, for example,<strong> </strong><kbd>https://mydomain-dot-devshell.appspot.com/?authuser=0&amp;environment_id=default&amp;film=2</kbd> to display the second film.</div>
<p>You will see different pages when presenting different query objects to the application.</p>
<p>This example shows how the GET HTTP verb can be extended through the use of querying parameters. It is this type of flexibility that has made HTTP such a widely adopted approach and outlines the strength of this protocol. Our working example demonstrates how to develop a simple web application using Cloud Functions. The example can, of course, extend to other more intricate use cases. I will leave it to your imagination to build the next big thing based on the accumulated knowledge gathered over the previous chapters.</p>
<p>We will now turn our attention to the crucial topic of Cloud Functions security. In the next section, we will discuss various security techniques that can be applied when working with Cloud Functions.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Service account security</h1>
                </header>
            
            <article>
                
<p>Finally, in this chapter, we will introduce the concept of least privilege with regard to <strong>Identity Access Management</strong> (<strong>IAM</strong>) and explain how to apply this to Cloud Functions. We will look at some approaches that can secure an application using Cloud Functions.</p>
<p>Later in this chapter, we will discuss service accounts; however, let's take an initial brief look at how to restrict the caller status of the Cloud Functions deployed. Cloud Functions use service accounts rather than a user account to manage services. In this respect, the service account takes on the role of the user without needing an actual human to be involved in the process.</p>
<p>Concerning the user account, each function deployed will be assigned a service account responsible for permissions. The service account is <span>created </span>either manually or automatically; in both instances, the role and permissions need to be defined. When a function deploys, the <kbd>cloudfunctions.invoker</kbd> <span>permission </span>is typically applied to the service account. This permission provides the service account with the ability to call/invoke Cloud Functions.</p>
<p>Besides this permission, the caller also needs to have the correct authentication for the function. If the default settings persist, then the <kbd>allUser/public</kbd> interface is bound to the service, meaning anyone can call the function. HTTP functions are <span>typically </span>deployed with the default <kbd>allUsers</kbd> policy binding, meaning that anyone can invoke the service. In doing this, it enables anyone to invoke our function by using the exposed endpoint. Open access presents a potential vulnerability for our application and needs a solution to mitigate this risk. If you wish to restrict access to the function, limit it to secure account access: for example, <kbd>allAuthenticated</kbd> or specific users denoted through their IAM account.</p>
<p>Despite a function being available for a shorter amount of time, Cloud Functions are still susceptible to security risks such as malicious code or denial of service.</p>
<div class="packt_infobox"><br/>
Note that, with regard to denial-of-service attacks, Cloud Functions sits behind the Google frontend that is used to mitigate and absorb many attacks on layer 4 and below, such as SYN floods, IP fragment floods, port exhaustion, and so on.</div>
<p>Many different types of vulnerability can be problematic for web-based services. The complexity of this subject means we are not able to provide more than a limited overview of the mitigations in play. There is seemingly an ever-increasing spectrum of potential vulnerabilities, for example, malicious code, denial-of-service attacks, or event resource bottlenecks.</p>
<p>The following section details some techniques to mitigate security concerns with Cloud Functions.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Economic limits</h1>
                </header>
            
            <article>
                
<p>As we are now aware, serverless provides the ability to achieve scalability across the Cloud Functions. However, it may be that a service integrated with Cloud Functions isn't able to cope at these types of level. It is possible to restrict the maximum number of instances available, should such a restriction be applicable within your application.</p>
<p>Applying restrictions against connectivity can ease the burden and prevent a service from experiencing flooding with more requests than can be successfully processed. A threshold setting the available number of instances means that the function can be limited at the point of deployment, as demonstrated in the following command:</p>
<pre><strong>gcloud beta functions deploy … \</strong><br/><strong>--max-instances 4</strong></pre>
<p>In the constrained scenario here, a queuing mechanism is enabled to ensure the constraint applied doesn't impede the processing of information to your service. Limiting the instance threshold is an excellent start to securing service calls. A different variant looks at how to obtain the credentials used to access resources.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Insecure credential storage</h1>
                </header>
            
            <article>
                
<p>Credential storage is an increasingly important topic<span> </span><span>when attempting to secure various services. Essential credentials (or keys), such as database username/password/publication credentials or secrets stored in code, require a solution that enables this information to be accessible only to authenticated components.</span></p>
<p>Many industry-based solutions will provide the necessary protections, including Google Cloud <strong>Key Management Service</strong> (<strong>KMS</strong>), which supports using Google- or customer-based keys. Also, general products such as HashiCorp Vault provide a similar level of protection for information to be stored securely.</p>
<p>So credentials offer better protection and allow services to be secured. When working with multiple integrated services, how do we manage the workflow to the level of security desired?</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Execution flow manipulation</h1>
                </header>
            
            <article>
                
<p><span>The execution flow essentially outlining how the function workflow for your application. In a scenario where you have multiple functions, there may be an information handoff between components in which they exchange information or provide access to a backend service such as a database.</span></p>
<p><span>In this situation, it would not be appropriate for any of the functions in this workflow to be intercepted or accept communications from unauthenticated external sources. To do so would diminish the integrity of the workflow. A situation like this presents a substantive security risk to the application (for example, tainted information).</span></p>
<p><span>To prevent this type of vulnerability, we can utilize least-privilege security settings to manage service accounts and establish a per-function authorization mechanism to validate calls. By default, all functions/apps/containers can share the same service identities and have a role assigned, such as project editor. However, identity management can also be set on a per-function basis to establish the least privilege. For Cloud Functions, append a service account to control the function at the point of deployment.</span></p>
<p><span>In the following diagram, a service account capable of invoking a Cloud Function is labeled <strong>Function A</strong>:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-829 image-border" src="assets/67bedd99-4abb-47f3-b779-f0db5a9740f1.png" style=""/></div>
<p><span>Service account deployment provides a public interface to our other services. We will also create a second service account for <strong>Function B</strong> to manage the backend; this service account will not have invoker privileges and will not be made public. Finally, <strong>Backend Services</strong> do not expose themselves to the public-facing internet. Besides this, they will also be accessible from Function B. An arrangement of this type is relatively common, for example, on a bastion host where the host is internet-facing and only the host has permission to connect with other machines in the estate.</span></p>
<p><span>According to Google, a service account is a special account that calls the Google API without the involvement of a user. These computer accounts are an incredibly useful feature and are defined with IAM permissions. We can create a new service account that will provide access to the function by using the following <kbd>gcloud</kbd> </span>command:</p>
<ol>
<li><span>Create a service account—<kbd>Function A</kbd>:</span></li>
</ol>
<pre style="padding-left: 60px"><strong><span>gcloud iam service-accounts create publicCloudFunction</span></strong></pre>
<ol start="2">
<li>Bind a role to the service account that will enable the latter to use the <kbd>invoker</kbd> role:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px"><strong>gcloud functions add-iam-policy-binding SaveData \</strong><br/><strong>--member='serviceAccount:publicCloudFunction@projectid.iam.gserviceaccount.com' \</strong><br/><strong>--role='roles/cloudfunctions.invoker'</strong></pre>
<p style="padding-left: 60px">The <kbd>cloudfunctions.invoker</kbd> role is required to initiate Cloud Functions, and we bind this permission to our new service account. By doing this, our service account can now call Cloud Functions.</p>
<p style="padding-left: 60px">Now that we have created a service account with the necessary permissions, we can deploy our function with the new service account by appending the name of the account.</p>
<ol start="3">
<li>Apply the new service account on deployment of the Cloud Function:</li>
</ol>
<pre style="padding-left: 60px"><strong>gcloud functions deploy …\</strong><br/><strong>--service-account account-privilege@projectid.iam.gserviceaccount.com</strong></pre>
<p style="padding-left: 60px">To complete our example, we will create a second service account associated with our second function. For this service account, we will not apply the <kbd>invoker</kbd> (<kbd>cloudfunctions.invoker</kbd>) role, thereby restricting who can initiate the function.</p>
<ol start="4">
<li>Create <span>a service account—<kbd>Function B</kbd>:</span></li>
</ol>
<pre style="padding-left: 60px"><strong><span>gcloud iam service-accounts create saveData</span></strong></pre>
<p style="padding-left: 60px">As we did with the first service account, we need to bind some permissions. In this instance, we are using Cloud SQL permissions. </p>
<ol start="5">
<li>Bind a role to the service account:</li>
</ol>
<pre style="padding-left: 60px"><strong>gcloud projects add-iam-policy-binding projectid \</strong><br/><strong>--member='serviceAccount:saveData@projectid.gserviceaccount.com' \</strong><br/><strong>--role='roles/cloudsql.client'</strong></pre>
<p style="padding-left: 60px">Finally, we can deploy the function with the recently created service account.</p>
<ol start="6">
<li>Apply the service account to the function being deployed:</li>
</ol>
<pre style="padding-left: 60px"><strong>gcloud functions deploy saveData \</strong><br/><strong>--service-account saveData@projectid.gserviceaccount.com</strong></pre>
<p>At this point, we have now made simple changes to our application that ensure that the function execution flow works to our advantage. <strong>Function A</strong> is our entry point function and provides a frontend for our application. <strong>Function B</strong> is now only accessible via <strong>Function A</strong>, which secures the execution flow from A to B. Also note that now the <strong>Backend Services</strong> is only available via <strong>Function B</strong>. With the changes specified in the preceding steps, we now have the following layout: </p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-830 image-border" src="assets/03d17991-0d41-4824-b24c-5052c989ee0e.png" style=""/></div>
<p>In the final area to be discussed, we'll look at security controls through policy controls. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">FunctionShield</h1>
                </header>
            
            <article>
                
<p>Google Cloud Functions also supports third-party solutions such as FunctionShield. With these solutions, strict security controls are employed that ensure the application of a policy to the functions deployed. Specifically, these protections apply to four distinct areas:</p>
<ul>
<li>The security policy allows the disabling of egress internet connectivity. Restriction of outbound traffic when not required by the service is a good practice to adopt, as most services will typically only require ingress/inbound traffic to be enabled.</li>
<li>As previously indicated, Cloud Functions are lightweight functions that are stateless. In this respect, local storage requirements, therefore, should be restricted where possible. FunctionShield can disable read/writes on the <kbd>/tmp</kbd> directory, typically used for intermediary storage requirements.</li>
<li>Thread execution for child processes should be minimized and restricted when not required by the function to be invoked. Being able to execute child processes presents a genuine security risk that is difficult to track and trace once initiated without the application of adequate protections.</li>
<li>Restrict access to the function's source code via the central console. Where the source code has some value or associate <strong>intellectual property</strong> (<strong>IP</strong>), this can be an extra safeguard that applies to the system source code to be deployed.</li>
</ul>
<p>The FunctionShield solution is a free product that can be deployed to multiple cloud providers, making it a flexible solution we can use to ensure the application of a standard policy within your serverless estate. No function code amendments are necessary to deploy this against your application. A proprietary, behavioral-based runtime establishes protection around the serverless environment. The observability of the cloud functions remains apparent and is available via the standard mechanism: Stackdriver on Google Cloud.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>With this chapter, we have concluded our foray into Cloud Functions on Google Cloud. The last couple of chapters have covered a lot of material on how to develop Cloud Functions. In the first example, we continued on our journey with Cloud Functions to explore how to construct a website based on an external view and data template. In this example, we picked up a couple of tips regarding code organization and dependency isolation.</p>
<p class="mce-root">On completion of the example, we have an easy-to-maintain website that utilizes Cloud Functions to provide a scalable basis for lightweight site access. We learned about the principle of least privilege and how this applies to Cloud Functions. We also learned some fundamental methods that are capable of securing our Cloud Functions by working with Google Cloud service accounts.</p>
<p class="mce-root">At this stage, you should be comfortable building both web applications and services integrated with Google APIs. There is more to learn that we unfortunately don't have the time or space to cover in this book. Cloud Build, GKE, databases, IoT, and third-party services are all possible avenues for further exploration. This concludes our tour of Cloud Functions on Google Cloud. In upcoming chapters, we will turn our attention to the latest iteration of serverless on Google Cloud: Cloud Run and Cloud GKE.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li style="font-weight: 400">What permission does a Cloud Function require to be invoked?</li>
<li style="font-weight: 400">What does Google KMS provide?</li>
<li style="font-weight: 400">What does the <kbd>allUsers</kbd> <span>permission </span>effectively mean?</li>
<li style="font-weight: 400">What does the <kbd>allAuthenticated</kbd> <span>permission e</span>ffectively mean? </li>
<li style="font-weight: 400">What parameter needs to be applied to limit the number of instances available to a Cloud Function?</li>
<li style="font-weight: 400">What command allows a role to be bound to a service account?</li>
<li style="font-weight: 400">What command is used to create a service account?</li>
<li style="font-weight: 400">What is a bastion host and why is it useful?</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li><span><strong>Google service accounts</strong>: <a href="https://cloud.google.com/iam/docs/service-accounts">https://cloud.google.com/iam/docs/service-accounts</a></span></li>
<li><span><strong>Least privilege for Cloud Functions using Cloud IAM</strong>: <a href="https://cloud.google.com/blog/products/application-development/least-privilege-for-cloud-functions-using-cloud-iam">https://cloud.google.com/blog/products/application-development/least-privilege-for-cloud-functions-using-cloud-iam</a></span></li>
<li><strong>Controlling Scaling Behavior</strong>: <a href="https://cloud.google.com/functions/docs/max-instances">https://cloud.google.com/functions/docs/max-instances</a></li>
<li><strong>Google Cloud Key Management Service</strong>: <a href="https://cloud.google.com/kms/">https://cloud.google.com/kms/</a></li>
</ul>


            </article>

            
        </section>
    </body></html>