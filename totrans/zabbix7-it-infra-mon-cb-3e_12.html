<html><head></head><body>
<div id="_idContainer658" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-375"><a id="_idTextAnchor2180" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-376" class="calibre5"><a id="_idTextAnchor2181" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.2.1">Advanced Zabbix Database Management</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">Whether you’ve been using Zabbix for a while or you are looking toward setting up your first production instance, database management is important right from the start. </span><span class="kobospan" id="kobo.3.2">A lot of the time, people set up their Zabbix database and don’t know yet that it will be a big database. </span><span class="kobospan" id="kobo.3.3">The Zabbix housekeeper just can’t keep up when your database grows beyond a certain size, and that’s when we need to look for </span><span><span class="kobospan" id="kobo.4.1">different options.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, we’ll look into keeping our Zabbix database from using up 100% disk space when the Zabbix housekeeper is not keeping up. </span><span class="kobospan" id="kobo.5.2">For MySQL users, we’ll look into using database partitioning to keep our database in check. </span><span class="kobospan" id="kobo.5.3">For PostgreSQL users, we’ll look toward the TimescaleDB support. </span><span class="kobospan" id="kobo.5.4">Last but not least, we’ll also check out how to secure our connection between the Zabbix server and </span><span><span class="kobospan" id="kobo.6.1">the database.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.7.1">We’ll do all this in the </span><span><span class="kobospan" id="kobo.8.1">following recipes:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.9.1">Setting up MySQL partitioning for your </span><span><span class="kobospan" id="kobo.10.1">Zabbix database</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.11.1">Using the PostgreSQL </span><span><span class="kobospan" id="kobo.12.1">TimescaleDB functionality</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.13.1">Securing your Zabbix </span><span><span class="kobospan" id="kobo.14.1">MySQL database</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.15.1">Without further ado, let’s get started on these recipes and learn all about managing </span><span><span class="kobospan" id="kobo.16.1">our database.</span></span></p>
<h1 id="_idParaDest-377" class="calibre5"><a id="_idTextAnchor2182" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2183" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.17.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.18.1">We are going to need some new servers for these recipes. </span><span class="kobospan" id="kobo.18.2">One Linux server needs to run Zabbix server 7 with MySQL (MariaDB) set up; we’ll call this host </span><strong class="source-inline"><span class="kobospan" id="kobo.19.1">lar-book-mysql- mgmt</span></strong><span class="kobospan" id="kobo.20.1">. </span><span class="kobospan" id="kobo.20.2">We will also need a Linux server running Zabbix server 7 with PostgreSQL, which we’ll </span><span><span class="kobospan" id="kobo.21.1">call </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.22.1">lar-book-postgresql-mgmt</span></strong></span><span><span class="kobospan" id="kobo.23.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.24.1">We’ll also need two servers for creating a secure Zabbix database setup. </span><span class="kobospan" id="kobo.24.2">One server will be running the MySQL (MariaDB) database; let’s call this server </span><strong class="source-inline"><span class="kobospan" id="kobo.25.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.26.1">. </span><span class="kobospan" id="kobo.26.2">Then, connecting externally to a Zabbix database, we’ll have our Zabbix server, which we’ll </span><span><span class="kobospan" id="kobo.27.1">call </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.28.1">lar-book-secure-zbx</span></strong></span><span><span class="kobospan" id="kobo.29.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.30.1">The code files can also be accessed in the GitHub </span><span><span class="kobospan" id="kobo.31.1">repository here:</span></span></p>
<p class="calibre3"><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter12" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.32.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter12</span></span></a></p>
<h1 id="_idParaDest-378" class="calibre5"><a id="_idTextAnchor2184" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2185" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.33.1">Setting up MySQL partitioning for your Zabbix database</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.34.1">When</span><a id="_idTextAnchor2186" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.35.1"> working </span><a id="_idIndexMarker954" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.36.1">with a MySQL database, the </span><a id="_idIndexMarker955" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.37.1">biggest issue we face is how MySQL stores its data by default. </span><span class="kobospan" id="kobo.37.2">There is no real order to th</span><a id="_idTextAnchor2187" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.38.1">e data that we can use if we want to drop large chunks of data. </span><span class="kobospan" id="kobo.38.2">MySQL partitioning solves this issue; let’s see how we can configure it to use for our </span><span><span class="kobospan" id="kobo.39.1">Zabbix database.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.40.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.41.1">Here at Opensource ICT Solutions, we have fixed the script to work with MySQL 8. </span><span class="kobospan" id="kobo.41.2">The script should work for </span><em class="italic"><span class="kobospan" id="kobo.42.1">any</span></em><span class="kobospan" id="kobo.43.1"> MySQL setup once more. </span><span class="kobospan" id="kobo.43.2">Check out the link for more </span><span><span class="kobospan" id="kobo.44.1">information: </span></span><a href="https://github.com/OpensourceICTSolutions/zabbix-mysql-partitioning-perl" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.45.1">https://github.com/OpensourceICTSolutions/zabbix-mysql-partitioning-perl</span></span></a><span><span><a id="_idTextAnchor2188" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2189" class="pcalibre calibre6 pcalibre1"/></span></span><span><span class="kobospan" id="kobo.46.1">.</span></span></p>
<h2 id="_idParaDest-379" class="calibre7"><a id="_idTextAnchor2190" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.47.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.48.1">For this recipe, we are going to need a running Zabbix server with a MySQL database. </span><span class="kobospan" id="kobo.48.2">I’ll be using MariaDB in my example, but any MySQL flavor should be about the same. </span><span class="kobospan" id="kobo.48.3">The Linux host I’ll be using is called </span><strong class="source-inline"><span class="kobospan" id="kobo.49.1">lar-book-mysql-mgmt</span></strong><span class="kobospan" id="kobo.50.1">, which already meets </span><span><span class="kobospan" id="kobo.51.1">the requirements.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.52.1">If you are running these steps in a production environment, make sure to create your database backups first as things can always </span><span><span class="kobospan" id="kobo.53.1">go wrong</span><a id="_idTextAnchor2191" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2192" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.54.1">.</span></span></p>
<h2 id="_idParaDest-380" class="calibre7"><a id="_idTextAnchor2193" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.55.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.56.1">First things first, let’s log in to our Linux CLI to execute </span><span><span class="kobospan" id="kobo.57.1">our commands.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.58.1">It’s a good idea to use TMUX because partitioning can take several days for big databases. </span><span class="kobospan" id="kobo.58.2">TMUX will keep the sessions open in the background, even if we lose the SSH connection. </span><span class="kobospan" id="kobo.58.3">If TMUX is not installed, install it first </span><span><span class="kobospan" id="kobo.59.1">before proceeding.</span></span><p class="calibre3"><span class="kobospan" id="kobo.60.1">The RHEL-based command is </span><span><span class="kobospan" id="kobo.61.1">as follows:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.62.1">dnf install tmux</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.63.1">The Ubuntu command is </span><span><span class="kobospan" id="kobo.64.1">as follows:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.65.1">apt install tmux</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.66.1">Open a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.67.1">tmux</span></strong><span class="kobospan" id="kobo.68.1"> session by issuing the </span><span><span class="kobospan" id="kobo.69.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.70.1">tmux</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.71.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.72.1">It’s not required to run partitioning in a </span><strong class="source-inline1"><span class="kobospan" id="kobo.73.1">tmux</span></strong><span class="kobospan" id="kobo.74.1"> window, but it’s definitely smart. </span><span class="kobospan" id="kobo.74.2">Partitioning a big database can take a long time. </span><span class="kobospan" id="kobo.74.3">You could move your database to another machine with ample resources (CPU, memory, and disk speed) to partition, or if that’s not a possibility stop the Zabbix server process for the duration of the </span><span><span class="kobospan" id="kobo.75.1">partitioning process.</span></span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.76.1">Now, let’s </span><a id="_idIndexMarker956" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.77.1">l</span><a id="_idTextAnchor2194" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.78.1">og in to the </span><a id="_idIndexMarker957" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.79.1">MySQL applica</span><a id="_idTextAnchor2195" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.80.1">tion as the root user with the </span><span><span class="kobospan" id="kobo.81.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.82.1">mysql -u root -p</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.83.1">Now, move to use the Zabbix database with the </span><span><span class="kobospan" id="kobo.84.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.85.1">USE zabbix;</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.86.1">We are going to need to partition some tables here, but to do this, we need to know the UNIX timestamp on </span><span><span class="kobospan" id="kobo.87.1">our tables:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.88.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM history;</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.89.1">You will receive an output </span><span><span class="kobospan" id="kobo.90.1">like thi</span><a id="_idTextAnchor2196" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.91.1">s:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer639">
<span class="kobospan" id="kobo.92.1"><img alt="Figure 12.1 – MySQL returning a timestamp on the table history" src="image/B19803_12_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.93.1">Figure 12.1 – MySQL returning a timestamp on the table history</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.94.1">This </span><a id="_idIndexMarker958" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.95.1">timestamp should </span><a id="_idIndexMarker959" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.96.1">be about the same for every single table we are going to partition. </span><span class="kobospan" id="kobo.96.2">V</span><a id="_idTextAnchor2197" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.97.1">erify this by ru</span><a id="_idTextAnchor2198" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.98.1">nning the same query for the remaining </span><span><span class="kobospan" id="kobo.99.1">history tables:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.100.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM 'history';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.101.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM 'history_uint';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.102.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM 'history_str';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.103.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM 'history_text';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.104.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM 'history_log';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.105.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM 'history_bin';</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.106.1">A table might return a different value or even no value at all. </span><span class="kobospan" id="kobo.106.2">We need to take this into account when creating our partitions. </span><span class="kobospan" id="kobo.106.3">A table showing </span><strong class="source-inline1"><span class="kobospan" id="kobo.107.1">NULL</span></strong><span class="kobospan" id="kobo.108.1"> has no data, but an earlier date means we need an </span><span><span class="kobospan" id="kobo.109.1">earlier partiti</span><a id="_idTextAnchor2199" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.110.1">on:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer640">
<span class="kobospan" id="kobo.111.1"><img alt="Figure 12.2 – MySQL returning a timestamp on the history_log table" src="image/B19803_12_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.112.1">Figure 12.2 – MySQL returning a timestamp on the history_log table</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.113.1">Let’s start with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.114.1">history</span></strong><span class="kobospan" id="kobo.115.1"> table. </span><span class="kobospan" id="kobo.115.2">We are going to partition this table by day, and we are going to do this up until the date it is today; for me, it is </span><strong class="source-inline1"><span class="kobospan" id="kobo.116.1">18-06-2023</span></strong><span class="kobospan" id="kobo.117.1">. </span><span class="kobospan" id="kobo.117.2">L</span><a id="_idTextAnchor2200" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.118.1">et’s prepare the follow</span><a id="_idTextAnchor2201" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.119.1">ing MySQL query (for example, in </span><span><span class="kobospan" id="kobo.120.1">a notepad):</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.121.1">ALTER TABLE history PARTITION BY RANGE ( clock)</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.122.1">(PARTITION p2023_06_11 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-12 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.123.1">PARTITION p2023_06_12 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-13 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.124.1">PARTITION p2023_06_13 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-14 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.125.1">PARTITION p2023_06_14 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-15 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.126.1">PARTITION p2023_06_15 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-16 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.127.1">PARTITION p2023_06_16 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-17 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.128.1">PARTITION p2023_06_17 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-18 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.129.1">PARTITION p2023_06_18 VALUES LESS THAN (UNIX_TIMESTAMP("2023-06-19 00:00:00")) ENGINE = InnoDB);</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.130.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.131.1">If we </span><a id="_idIndexMarker960" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.132.1">only have 7 days of history </span><a id="_idIndexMarker961" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.133.1">data, creating this list by hand is not that hard. </span><span class="kobospan" id="kobo.133.2">If we want to do it on a big existing database, it can be a big list to edit by hand. </span><span class="kobospan" id="kobo.133.3">It’s easy to create a big list using software such as Excel or by creating a </span><span><span class="kobospan" id="kobo.134.1">small script.</span></span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.135.1">Make sure that the oldest partition here matches the timestamp we collected in </span><em class="italic"><span class="kobospan" id="kobo.136.1">step 9</span></em><span class="kobospan" id="kobo.137.1">. </span><span class="kobospan" id="kobo.137.2">In my case, the oldest data was from June 11, 2023, so this is my oldest partition. </span><span class="kobospan" id="kobo.137.3">Also, make sure that your newest partition matches the date you are </span><span><span class="kobospan" id="kobo.138.1">partitioning on.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.139.1">Cop</span><a id="_idTextAnchor2202" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.140.1">y and </span><a id="_idIndexMarker962" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.141.1">paste the </span><a id="_idIndexMarker963" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.142.1">prepared MySQL query from </span><em class="italic"><span class="kobospan" id="kobo.143.1">step 9</span></em><span class="kobospan" id="kobo.144.1"> and press </span><em class="italic"><span class="kobospan" id="kobo.145.1">Enter</span></em><span class="kobospan" id="kobo.146.1">. </span><span class="kobospan" id="kobo.146.2">This might take a while, as your table might be quite large. </span><span class="kobospan" id="kobo.146.3">After you’re done, you will see </span><span><span class="kobospan" id="kobo.147.1">the foll</span><a id="_idTextAnchor2203" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.148.1">owing:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer641">
<span class="kobospan" id="kobo.149.1"><img alt="Figure 12.3 – MySQL returning a successful query result for the history table" src="image/B19803_12_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.150.1">Figure 12.3 – MySQL returning a successful query result for the history table</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><a id="_idTextAnchor2204" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.151.1">Do the same partitioning for the remaining history tables; make sure to use the other UNIX timestamps for the </span><span><span class="kobospan" id="kobo.152.1">earliest partition:</span></span><ul class="calibre17"><li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.153.1">history_uint</span></strong></span></li><li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.154.1">history_str</span></strong></span></li><li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.155.1">history_text</span></strong></span></li><li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.156.1">history_log</span></strong></span></li><li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.157.1">history_bin</span></strong></span></li></ul></li>
<li class="calibre15"><span class="kobospan" id="kobo.158.1">Once you’ve partitioned all the history tables, let’s partition the </span><strong class="source-inline1"><span class="kobospan" id="kobo.159.1">trends</span></strong><span class="kobospan" id="kobo.160.1"> tables. </span><span class="kobospan" id="kobo.160.2">We have two of these called </span><strong class="source-inline1"><span class="kobospan" id="kobo.161.1">trends</span></strong> <span><span class="kobospan" id="kobo.162.1">and </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.163.1">trends_uint</span></strong></span><span><span class="kobospan" id="kobo.164.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.165.1">We are going to check the timestamps again with </span><span><span class="kobospan" id="kobo.166.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.167.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM trends;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.168.1">SELECT FROM_UNIXTIME(MIN(clock)) FROM trends_uint;</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.169.1">For these tables, it’s important to focus on what the earliest month is. </span><span class="kobospan" id="kobo.169.2">For my tables, this is month 06 of the </span><span><span class="kobospan" id="kobo.170.1">year 2023.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.171.1">Now, let’s </span><a id="_idIndexMarker964" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.172.1">prepare and execute the partitioning for this table. </span><span class="kobospan" id="kobo.172.2">Let’s do two extra pa</span><a id="_idTextAnchor2205" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.173.1">rtitions starting </span><a id="_idIndexMarker965" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.174.1">from the earliest date seen in the timestamp in </span><span><em class="italic"><span class="kobospan" id="kobo.175.1">step 14</span></em></span><span><span class="kobospan" id="kobo.176.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.177.1">ALTER TABLE trends PARTITION BY RANGE ( clock)</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.178.1">(PARTITION p2023_06 VALUES LESS THAN (UNIX_TIMESTAMP("2023-07-01 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.179.1">PARTITION p2023_07 VALUES LESS THAN (UNIX_TIMESTAMP("2023-08-01 00:00:00")) ENGINE = InnoDB,</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.180.1">PARTITION p2023_08 VALUES LESS THAN (UNIX_TIMESTAMP("2023-09-01 00:00:00")) ENGINE = InnoDB);</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.181.1">A</span><a id="_idTextAnchor2206" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.182.1">gain, we partition from the earliest collected UNIX timestamp, up until the current month. </span><span class="kobospan" id="kobo.182.2">But there’s no harm in creating some new partitions for </span><span><span class="kobospan" id="kobo.183.1">futur</span><a id="_idTextAnchor2207" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.184.1">e data:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer642">
<span class="kobospan" id="kobo.185.1"><img alt="Figure 12.4 – MySQL returning a successful query result for the trends table" src="image/B19803_12_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.186.1">Figure 12.4 – MySQL returning a successful query result for the trends table</span></p>
<ol class="calibre16">
<li value="18" class="calibre15"><span class="kobospan" id="kobo.187.1">Do the same thing for the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.188.1">trends_uint</span></strong></span><span><span class="kobospan" id="kobo.189.1"> table.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.190.1">That concludes the actual partitioning of the database. </span><span class="kobospan" id="kobo.190.2">Let’s make sure our partitions remain managed. </span><span class="kobospan" id="kobo.190.3">On your Zabbix database Linux host, download the partitioning script with the </span><span><span class="kobospan" id="kobo.191.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.192.1">wget https://raw.githubusercontent.com/OpensourceICTSolutions/zabbix-mysql-partitioning-perl/main/mysql_zbx_part.pl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.193.1">If you can’t use </span><strong class="source-inline1"><span class="kobospan" id="kobo.194.1">wget</span></strong><span class="kobospan" id="kobo.195.1">, simply download the script from the following </span><span><span class="kobospan" id="kobo.196.1">link: </span></span><a href="https://github.com/OpensourceICTSolutions/zabbix-mysql-partitioning-perl/blob/main/mysql_zbx_part.pl" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.197.1">https://github.com/OpensourceICTSolutions/zabbix-mysql-partitioning-perl/blob/main/mysql_zbx_part.pl</span></span></a><span><span class="kobospan" id="kobo.198.1">.</span></span><p class="calibre3"><span class="kobospan" id="kobo.199.1">Alternatively, you can download the partitioning script using the Packt </span><span><span class="kobospan" id="kobo.200.1">GitHub here:</span></span></p><p class="calibre3"><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter12/mysql_zbx_part.pl" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.201.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter12/mysql_zbx_part.pl</span></span></a></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.202.1">Now</span><a id="_idTextAnchor2208" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.203.1">, create </span><a id="_idIndexMarker966" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.204.1">the dire</span><a id="_idTextAnchor2209" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.205.1">ctory </span><a id="_idIndexMarker967" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.206.1">and move the script to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.207.1">/usr/lib/zabbix/</span></strong><span class="kobospan" id="kobo.208.1"> folder with the </span><span><span class="kobospan" id="kobo.209.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.210.1">mkdir /usr/lib/zabbix/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.211.1">mv mysql_zbx_part.pl /usr/lib/zabbix/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.212.1">We are going to customize some details in the script. </span><span class="kobospan" id="kobo.212.2">Edit the script with </span><span><span class="kobospan" id="kobo.213.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.214.1">vim /usr/lib/zabbix/mysql_zbx_part.pl</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.215.1">We need to edit some text in the </span><span><span class="kobospan" id="kobo.216.1">followi</span><a id="_idTextAnchor2210" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.217.1">ng part:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer643">
<span class="kobospan" id="kobo.218.1"><img alt="Figure 12.5 – MySQL Zabbix partitioning script user parameters" src="image/B19803_12_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.219.1">Figure 12.5 – MySQL Zabbix partitioning script user parameters</span></p>
<ol class="calibre16">
<li value="23" class="calibre15"><span class="kobospan" id="kobo.220.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.221.1">$db_schema</span></strong><span class="kobospan" id="kobo.222.1"> to match your Zabbix </span><span><span class="kobospan" id="kobo.223.1">database name.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.224.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.225.1">$db_user_name</span></strong><span class="kobospan" id="kobo.226.1"> to match your Zabbix </span><span><span class="kobospan" id="kobo.227.1">database username.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.228.1">Edit </span><strong class="source-inline1"><span class="kobospan" id="kobo.229.1">$db_password</span></strong><span class="kobospan" id="kobo.230.1"> to match your Zabbix </span><span><span class="kobospan" id="kobo.231.1">database password.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.232.1">Now, at the </span><strong class="source-inline1"><span class="kobospan" id="kobo.233.1">$tables</span></strong><span class="kobospan" id="kobo.234.1"> variable, we are going to add some of the most important details. </span><span class="kobospan" id="kobo.234.2">This is where we’ll add how many days of history data we want</span><a id="_idTextAnchor2211" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.235.1"> to </span><a id="_idIndexMarker968" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.236.1">keep and how </span><a id="_idIndexMarker969" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.237.1">many months of trends data. </span><span class="kobospan" id="kobo.237.2">Add your values; the default settings keep 30 days of history data and 12 months of </span><span><span class="kobospan" id="kobo.238.1">trends data.</span></span></li>
<li class="calibre15"><a id="_idTextAnchor2212" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.239.1">Also, make sure to edit the </span><strong class="source-inline1"><span class="kobospan" id="kobo.240.1">my $curr_tz = Etc/UTC;</span></strong><span class="kobospan" id="kobo.241.1"> line to match your own time zone. </span><span class="kobospan" id="kobo.241.2">I will use Europe/Amsterdam, </span><span><span class="kobospan" id="kobo.242.1">for example.</span></span></li>
</ol>
<p class="callout-heading"><span class="kobospan" id="kobo.243.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.244.1">If you are using a version of Zabbix before 2.2 or a MySQL version before 5.6 or if you are running MySQL 8, then there are some extra lines of configuration that need to be commented and uncommented in the script. </span><span class="kobospan" id="kobo.244.2">If this applies to you, read the comments in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.245.1">mysql_zbx_part.pl</span></strong><span class="kobospan" id="kobo.246.1"> script file and edit it. </span><span class="kobospan" id="kobo.246.2">Additionally, check out the GitHub repo mentioned in the introduction of </span><span><span class="kobospan" id="kobo.247.1">this recipe.</span></span></p>
<ol class="calibre16">
<li value="28" class="calibre15"><span class="kobospan" id="kobo.248.1">Before executing the script, we are going to need to install some Perl dependencies. </span><span class="kobospan" id="kobo.248.2">On RHEL-based systems, we need </span><span><span class="kobospan" id="kobo.249.1">additional repositories.</span></span><p class="calibre3"><span class="kobospan" id="kobo.250.1">The RHEL8-based commands are </span><span><span class="kobospan" id="kobo.251.1">as follows:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.252.1">dnf config-manager --set-enabled powertools</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.253.1">For RHEL9-based systems, use </span><span><span class="kobospan" id="kobo.254.1">this command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.255.1">dnf config-manager --enable crb</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.256.1">Install the dependencies with the </span><span><span class="kobospan" id="kobo.257.1">following commands.</span></span><p class="calibre3"><span class="kobospan" id="kobo.258.1">The RHEL-based commands are </span><span><span class="kobospan" id="kobo.259.1">as follows:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.260.1">dnf update</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.261.1">dnf install perl-Sys-Syslog</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.262.1">dnf install perl-DateTime</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.263.1">dnf install perl-DBD-mysql</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.264.1">dnf install perl-DBI</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.265.1">The Ubuntu commands are </span><span><span class="kobospan" id="kobo.266.1">as follows:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.267.1">apt install liblogger-syslog-perl</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.268.1">apt install libdatetime-perl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.269.1">Make the </span><a id="_idIndexMarker970" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.270.1">script executable </span><a id="_idIndexMarker971" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.271.1">with the </span><span><span class="kobospan" id="kobo.272.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.273.1">chmod +x /usr/lib/zabbix/mysql_zbx_part.pl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.274.1">Then, this is the moment where we should be ready to execute the script to see whether it is working. </span><span class="kobospan" id="kobo.274.2">Let’s </span><span><span class="kobospan" id="kobo.275.1">execute it:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.276.1">/usr/lib/zabbix/mysql_zbx_part</span><a id="_idTextAnchor2213" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.277.1">.pl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.278.1">Once your script has finished running, let’s see whether it was successful with the </span><span><span class="kobospan" id="kobo.279.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.280.1">journalctl -t mysql_</span><a id="_idTextAnchor2214" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.281.1">zbx_part</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.282.1">You should see an output</span><a id="_idTextAnchor2215" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.283.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer644">
<span class="kobospan" id="kobo.284.1"><img alt="Figure 12.6 – MySQL Zabbix partitioning script results" src="image/B19803_12_07.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.285.1">Figure 12.6 – MySQL Zabbix partitioning script results</span></p>
<ol class="calibre16">
<li value="34" class="calibre15"><span class="kobospan" id="kobo.286.1">Now, execute </span><a id="_idIndexMarker972" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.287.1">the </span><span><span class="kobospan" id="kobo.288.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.289.1">crontab -e</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.290.1">To automate </span><a id="_idIndexMarker973" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.291.1">the execution of the script, add the following line to </span><span><span class="kobospan" id="kobo.292.1">the file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.293.1">55 22 * * * /usr/lib/zabbix/mysql_zbx_part.pl</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.294.1">The last thing we are going to need to do is to go to the Zabbix frontend. </span><span class="kobospan" id="kobo.294.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.295.1">Administration</span></strong><span class="kobospan" id="kobo.296.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.297.1">Housek</span><a id="_idTextAnchor2216" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.298.1">eeping</span></strong></span><span><span class="kobospan" id="kobo.299.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.300.1">As the script will take over database history and trend deletion, the housekeeping for the </span><strong class="bold"><span class="kobospan" id="kobo.301.1">History</span></strong><span class="kobospan" id="kobo.302.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.303.1">Trends</span></strong><span class="kobospan" id="kobo.304.1"> tables must be disabled. </span><span class="kobospan" id="kobo.304.2">It will look like </span><span><span class="kobospan" id="kobo.305.1">th</span><a id="_idTextAnchor2217" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.306.1">e following:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer645">
<span class="kobospan" id="kobo.307.1"><img alt="Figure 12.7 – Zabbix Administration | General | Housekeeping disabled for History an﻿d Trends" src="image/B19803_12_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.308.1">Figure 12.7 – Zabbix Administration | General | Housekeeping disabled for History an</span><a id="_idTextAnchor2218" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.309.1">d Trends</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.310.1">Th</span><a id="_idTextAnchor2219" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.311.1">at concludes our Zabbix database </span><span><span class="kobospan" id="kobo.312.1">partiti</span><a id="_idTextAnchor2220" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2221" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.313.1">oning setup.</span></span></p>
<h2 id="_idParaDest-381" class="calibre7"><span class="kobospan" id="kobo.314.1">How it wor</span><a id="_idTextAnchor2222" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.315.1">ks…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.316.1">Database partitioning seems like a daring task at first, but once you break it down into chunks, it is </span><a id="_idIndexMarker974" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.317.1">not that hard to do. </span><span class="kobospan" id="kobo.317.2">It is simply the process of breaking down our most important Zabbix database </span><a id="_idIndexMarker975" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.318.1">tables into time-based partitions. </span><span class="kobospan" id="kobo.318.2">Once these partitions are set up, we simply need to manage these tables with a script and </span><span><span class="kobospan" id="kobo.319.1">we’re ready.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.320.1">Look at the following figure, and let’s say today is </span><strong class="bold"><span class="kobospan" id="kobo.321.1">19-06-2023</span></strong><span class="kobospan" id="kobo.322.1">. </span><span class="kobospan" id="kobo.322.2">We have a lot of partitions managed by the script. </span><span class="kobospan" id="kobo.322.3">All of our </span><strong class="bold"><span class="kobospan" id="kobo.323.1">history</span></strong><span class="kobospan" id="kobo.324.1"> data today is going to be written to the partition for this day and all of our </span><strong class="bold"><span class="kobospan" id="kobo.325.1">trends</span></strong><span class="kobospan" id="kobo.326.1"> data is going to be written into the partition fo</span><a id="_idTextAnchor2223" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.327.1">r </span><span><span class="kobospan" id="kobo.328.1">this month:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer646">
<span class="kobospan" id="kobo.329.1"><img alt="Figure 12.8 – Zabbix partitioning illustration" src="image/B19803_12_09.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.330.1">Figure 12.8 – Zabbix partitioning illustration</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.331.1">The actual </span><a id="_idIndexMarker976" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.332.1">script does only two things. </span><span class="kobospan" id="kobo.332.2">It creates new partitions and it deletes </span><span><span class="kobospan" id="kobo.333.1">old partitions.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.334.1">For deleting </span><a id="_idIndexMarker977" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.335.1">partitions, once a partition reaches an age older than specified in the </span><strong class="source-inline"><span class="kobospan" id="kobo.336.1">$tables</span></strong><span class="kobospan" id="kobo.337.1"> variable, it drops the </span><span><span class="kobospan" id="kobo.338.1">entire partiti</span><a id="_idTextAnchor2224" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.339.1">on.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.340.1">For creating partitions, every time the script is run, it creates 10 partitions in the future starting from today, except, of course, when a partition </span><span><span class="kobospan" id="kobo.341.1">already exists.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.342.1">This is better than using the housekeeper for one clear reason. </span><span class="kobospan" id="kobo.342.2">It’s simply faster! </span><span class="kobospan" id="kobo.342.3">The Zabbix housekeeper goes through our database data line by line to check the UNIX timestamp and then it deletes that line when it reaches data older than specified. </span><span class="kobospan" id="kobo.342.4">This takes time and resources. </span><span class="kobospan" id="kobo.342.5">Dropping a partition, though, is </span><span><span class="kobospan" id="kobo.343.1">almost instant.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.344.1">One downside of partitioning a Zabbix database, though, is that we can no longer use the frontend item history and trend configuration. </span><span class="kobospan" id="kobo.344.2">This means we can’t specify different history and trends for different items; it’s </span><a id="_idTextAnchor2225" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2226" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.345.1">all </span><span><span class="kobospan" id="kobo.346.1">global now.</span></span></p>
<h2 id="_idParaDest-382" class="calibre7"><a id="_idTextAnchor2227" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.347.1">See also</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.348.1">When I first started using Zabbix, I did not have a book like this one. </span><span class="kobospan" id="kobo.348.2">Instead, I relied heavily on </span><a id="_idIndexMarker978" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.349.1">the resources available </span><a id="_idIndexMarker979" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.350.1">online and my own skillset. </span><span class="kobospan" id="kobo.350.2">There are loads of great guides for partitioning and other stuff available on the internet. </span><span class="kobospan" id="kobo.350.3">If something isn’t mentioned in this book, make sure to Google it and see if there’s something available online. </span><span class="kobospan" id="kobo.350.4">You might also want to check out some amazing books written by our Zabbix peers and, of course, if you’ve figured out something by yourself, s</span><a id="_idTextAnchor2228" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2229" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.351.1">haring </span><span><span class="kobospan" id="kobo.352.1">is caring!</span></span></p>
<h1 id="_idParaDest-383" class="calibre5"><span class="kobospan" id="kobo.353.1">Using the PostgreSQL TimescaleDB functional</span><a id="_idTextAnchor2230" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.354.1">ity</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.355.1">TimescaleDB is </span><a id="_idIndexMarker980" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.356.1">an open source relational PostgreSQL database extension </span><a id="_idIndexMarker981" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.357.1">for time-based series data. </span><span class="kobospan" id="kobo.357.2">Using Pos</span><a id="_idTextAnchor2231" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.358.1">tgreSQL TimescaleDB is a solid way to work around using the Zabbix housekeeper to manage your PostgreSQL database. </span><span class="kobospan" id="kobo.358.2">In this recipe, we will go over the installation of PostgreSQL TimescaleDB on a new server and how to set</span><a id="_idTextAnchor2232" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2233" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.359.1"> it up </span><span><span class="kobospan" id="kobo.360.1">with Zabbix.</span></span></p>
<h2 id="_idParaDest-384" class="calibre7"><a id="_idTextAnchor2234" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.361.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.362.1">We will need an empty Linux server. </span><span class="kobospan" id="kobo.362.2">I’ll be using my server called </span><span><strong class="source-inline"><span class="kobospan" id="kobo.363.1">lar-boo</span><a id="_idTextAnchor2235" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2236" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.364.1">k- postgresql-mgmt</span></strong></span><span><span class="kobospan" id="kobo.365.1">.</span></span></p>
<h2 id="_idParaDest-385" class="calibre7"><a id="_idTextAnchor2237" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.366.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.367.1">We have a bit of a different process for RHEL-based and Ubuntu systems, which is why we have split this </span><em class="italic"><span class="kobospan" id="kobo.368.1">How to do it…</span></em><span class="kobospan" id="kobo.369.1"> section in two. </span><span class="kobospan" id="kobo.369.2">We will start with </span><span><span class="kobospan" id="kobo.370.1">Ubuntu systems.</span></span></p>
<h3 class="calibre8"><span class="kobospan" id="kobo.371.1">Ubuntu instal</span><a id="_idTextAnchor2238" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.372.1">lation</span></h3>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.373.1">Let’s log </span><a id="_idIndexMarker982" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.374.1">in to o</span><a id="_idTextAnchor2239" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.375.1">ur </span><a id="_idIndexMarker983" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.376.1">Linux CLI and add the PostgreSQL repo with the </span><span><span class="kobospan" id="kobo.377.1">following commands:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.378.1">apt install gnupg postgresql-common apt-transport-https lsb-release wget</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.379.1">/usr/share/postgresql-common/pgdg/apt.postgresql.org.sh</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.380.1">Now, add the </span><span><span class="kobospan" id="kobo.381.1">TimescaleDB repository:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.382.1">echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" | sudo tee /etc/apt/sources.list.d/timescaledb.list</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.383.1">wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo apt-key add -</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.384.1">ap</span><a id="_idTextAnchor2240" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.385.1">t update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.386.1">Now, instal</span><a id="_idTextAnchor2241" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.387.1">l TimescaleDB with the </span><span><span class="kobospan" id="kobo.388.1">installation command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.389.1">apt install timescaledb-2-postgresql-15</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.390.1">Start and enable </span><span><span class="kobospan" id="kobo.391.1">PostgreSQL 12:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.392.1">systemctl enable postgresql</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.393.1">systemctl start postgresql</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.394.1">Now, continue with the </span><em class="italic"><span class="kobospan" id="kobo.395.1">TimescaleDB configuration</span></em><span class="kobospan" id="kobo.396.1"> section of </span><span><span class="kobospan" id="kobo.397.1">this recipe.</span></span></li>
</ol>
<h3 class="calibre8"><span class="kobospan" id="kobo.398.1">RHEL-based ins</span><a id="_idTextAnchor2242" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.399.1">tallation</span></h3>
<ol class="calibre16">
<li value="1" class="calibre15"><span class="kobospan" id="kobo.400.1">Let’s </span><a id="_idIndexMarker984" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.401.1">start by </span><a id="_idIndexMarker985" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.402.1">logging </span><a id="_idTextAnchor2243" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.403.1">in to our Linux CLI. </span><span class="kobospan" id="kobo.403.2">We will need PostgreSQL version 11 or higher. </span><span class="kobospan" id="kobo.403.3">Let’s install version 12; first, </span><span><span class="kobospan" id="kobo.404.1">disable AppStream:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.405.1">dnf -qy module disable postgresql</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.406.1">Add the </span><span><span class="kobospan" id="kobo.407.1">correct repository:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.408.1">dnf install https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.409.1">Then, </span><span><span class="kobospan" id="kobo.410.1">install PostgreSQL:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.411.1">dnf install postgresql15 postgresql15-server</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.412.1">Make </span><a id="_idIndexMarker986" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.413.1">sure to initialize </span><span><span class="kobospan" id="kobo.414.1">the database:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.415.1">/usr/pgsql-15/bin/postgresql-15-</span><a id="_idTextAnchor2244" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.416.1">setup initdb</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.417.1">Now, add </span><a id="_idIndexMarker987" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.418.1">the repo information to the file and </span><span><span class="kobospan" id="kobo.419.1">save it:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.420.1">tee /etc/yum.repos.d/timescale_timescaledb.repo &lt;&lt;EOL</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.421.1">[timescale_timescaledb]</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.422.1">name=timescale_timescaledb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.423.1">baseurl=https://packagecloud.io/timescale/timescaledb/el/$(rpm -E %{rhel})/\$basearch</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.424.1">repo_gpgcheck=1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.425.1">gpgcheck=0</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.426.1">enabled=1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.427.1">gpgkey=https://packagecloud.io/timescale/timescaledb/gpgkey</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.428.1">sslverify=1</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.429.1">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.430.1">metadata_expire=300</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.431.1">EOL</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.432.1">Install TimescaleDB with the </span><span><span class="kobospan" id="kobo.433.1">installation command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.434.1">dnf install timescaledb-2-postgresql-15</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.435.1">Now, continue with the </span><em class="italic"><span class="kobospan" id="kobo.436.1">TimescaleDB configuration</span></em><span class="kobospan" id="kobo.437.1"> section of </span><span><span class="kobospan" id="kobo.438.1">this recipe.</span></span></li>
</ol>
<h3 class="calibre8"><span class="kobospan" id="kobo.439.1">TimescaleDB configuration</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.440.1">In this </span><a id="_idIndexMarker988" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.441.1">section, we’ll go over how to set up TimescaleDB after finishing the installation process. </span><span class="kobospan" id="kobo.441.2">There’s a lot more to configure, so let’s check </span><span><span class="kobospan" id="kobo.442.1">it out:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.443.1">Let’s start by running the </span><span><span class="kobospan" id="kobo.444.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.445.1">timescaledb-tune</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.446.1">Sometimes this does not work, and you want to specify the PostgreSQL location </span><span><span class="kobospan" id="kobo.447.1">like this:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.448.1">timescaledb-tune --pg-config=/usr</span><a id="_idTextAnchor2245" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.449.1">/pgsql-15/bin/pg_config</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.450.1">Go through the steps and answer the questions with </span><strong class="source-inline1"><span class="kobospan" id="kobo.451.1">yes</span></strong><span class="kobospan" id="kobo.452.1"> or </span><strong class="source-inline1"><span class="kobospan" id="kobo.453.1">no</span></strong><span class="kobospan" id="kobo.454.1"> accordingly. </span><span class="kobospan" id="kobo.454.2">For a first-time setup, </span><strong class="source-inline1"><span class="kobospan" id="kobo.455.1">yes</span></strong><span class="kobospan" id="kobo.456.1"> for everything </span><span><span class="kobospan" id="kobo.457.1">is good.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.458.1">Now, </span><span><span class="kobospan" id="kobo.459.1">restart PostgreSQL:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.460.1">systemctl restart postgresql-15</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.461.1">If you haven’t already, download and install Zabbix with </span><span><span class="kobospan" id="kobo.462.1">the following.</span></span><p class="calibre3"><span class="kobospan" id="kobo.463.1">The RHEL-based commands are </span><span><span class="kobospan" id="kobo.464.1">as follows:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.465.1">rpm -Uvh https://repo.zabbix.com/zabbix/7.0/rhel/9/ x86_64/zabbix-release-7.0-1.el8.noarch.rpm</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.466.1">dnf clean all</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.467.1">dnf install zabbix-server-pgsql zabbix-web-pgsql zabbix-apache-conf zabbix-agent2</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.468.1">The Ubuntu commands are </span><span><span class="kobospan" id="kobo.469.1">as follows:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.470.1">wget https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.471.1">dpkg -i zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.472.1">apt update</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.473.1">apt install zabbix-server-pgsql zabbix-frontend-phpphp-pgsql zabbix-apache-conf zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.474.1">Create the initial database with </span><span><span class="kobospan" id="kobo.475.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.476.1">sudo -u postgres createuser --pwprompt zabbix</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.477.1">sudo -u postgres creat</span><a id="_idTextAnchor2246" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.478.1">edb -O zabbix zabbix</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.479.1">Import the </span><a id="_idIndexMarker989" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.480.1">database schema </span><span><span class="kobospan" id="kobo.481.1">for PostgreSQL:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.482.1">zcat /usr/share/doc/zabbix-server-pgsql*/create.sql.gz | sudo -u zabbix psql zabbix</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.483.1">Add the database password to the Zabbix configuration file by </span><span><span class="kobospan" id="kobo.484.1">editing it:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.485.1">vim /etc/zabbix/zabbix_server.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.486.1">Add the following lines, where </span><strong class="source-inline1"><span class="kobospan" id="kobo.487.1">password</span></strong><span class="kobospan" id="kobo.488.1"> is your password as set in </span><em class="italic"><span class="kobospan" id="kobo.489.1">step 6</span></em><span class="kobospan" id="kobo.490.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.491.1">DBHost</span></strong> <span><span class="kobospan" id="kobo.492.1">is empty:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.493.1">DBHost=</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.494.1">DBPassword=password</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.495.1">Now, enable the TimescaleDB extension with the </span><span><span class="kobospan" id="kobo.496.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.497.1">echo "CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;" | sudo -u postgres psql zabbix</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.498.1">Unpack the </span><strong class="source-inline1"><span class="kobospan" id="kobo.499.1">timescale.sql</span></strong><span class="kobospan" id="kobo.500.1"> script located in your Zabbix </span><span><span class="kobospan" id="kobo.501.1">share folder:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.502.1">gunzip /usr/share/doc/zabbix-sql-scripts/postgresql/timescaledb.sql.gz</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.503.1">Now, let’s </span><span><span class="kobospan" id="kobo.504.1">run </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.505.1">timescale.sql</span></strong></span><span><span class="kobospan" id="kobo.506.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.507.1">cat /usr/share/doc/zabbix-sql-scripts/postgresql/timescaledb.sql| sudo -u zabbix psql zabbix</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.508.1">We need to do one more thing before moving to the frontend. </span><span class="kobospan" id="kobo.508.2">We need to edit the </span><strong class="source-inline1"><span class="kobospan" id="kobo.509.1">pg_hba.conf</span></strong><span class="kobospan" id="kobo.510.1"> file to allow our Zabbix frontend to connect. </span><span class="kobospan" id="kobo.510.2">Edit the </span><span><span class="kobospan" id="kobo.511.1">following file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.512.1">vim /var/lib/pgsql/15/data/pg_hba.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.513.1">Make sure </span><a id="_idIndexMarker990" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.514.1">the following lines match in your file; they need to end </span><span><span class="kobospan" id="kobo.515.1">with </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.516.1">md5</span></strong></span><span><span class="kobospan" id="kobo.517.1">:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.518.1"># "local" is for Unix domain socket connections only</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.519.1">local all all</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.520.1">scram-sha256</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.521.1"># IPv4 local connections:</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.522.1">host all  all  127.0.0.1/32</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.523.1">md5</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.524.1"># IPv6 local connections:</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.525.1">host all  all  ::1</span><a id="_idTextAnchor2247" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.526.1">/128</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.527.1">scram-sha256</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.528.1">Now, start Zabbix and finish the frontend setup using the </span><span><span class="kobospan" id="kobo.529.1">following commands:</span></span><p class="calibre3"><span class="kobospan" id="kobo.530.1">On </span><span><span class="kobospan" id="kobo.531.1">RHEL-based systems:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.532.1">systemctl restart zabbix-server zabbix-agent2 httpd php-fpm</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.533.1">systemctl enable zabbix-server zabbix-agent2 httpd php-fpm</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.534.1">On </span><span><span class="kobospan" id="kobo.535.1">Ubuntu systems:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.536.1">systemctl restart zabbix-server zabbix-agent2 apache2 php-fpm</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.537.1">systemctl enable zabbix-server zabbix-agent2 apache2 php-fpm</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.538.1">Once we navigate to the frontend and we’ve logged in to our setup, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.539.1">Administratio</span><a id="_idTextAnchor2248" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.540.1">n</span></strong><span class="kobospan" id="kobo.541.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.542.1">Housekeeping</span></strong></span><span><span class="kobospan" id="kobo.543.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.544.1">We can </span><a id="_idIndexMarker991" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.545.1">now edit the following parameters to match our preferences, and TimescaleDB will take care of maintainin</span><a id="_idTextAnchor2249" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.546.1">g the data </span><span><span class="kobospan" id="kobo.547.1">retention period:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer647">
<span class="kobospan" id="kobo.548.1"><img alt="Figure 12.9 – Zabbix Administration | Housekeeping, ﻿﻿TimescaleDB-specific op﻿tions" src="image/B19803_12_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.549.1">Figure 12.9 – Zabbix Administration | Housekeeping, </span><a id="_idTextAnchor2250" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2251" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.550.1">TimescaleDB-specific op</span><a id="_idTextAnchor2252" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.551.1">tions</span></p>
<h2 id="_idParaDest-386" class="calibre7"><a id="_idTextAnchor2253" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.552.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.553.1">Using </span><a id="_idIndexMarker992" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.554.1">the TimescaleDB functionality with your Zabbix setup is a solid integration with your PostgreSQL database. </span><span class="kobospan" id="kobo.554.2">The extension is supported by Zabbix, and you can expect it to only get better in the </span><span><span class="kobospan" id="kobo.555.1">near future.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.556.1">Now, how TimescaleDB works is by dividing up your PostgreSQL hypertable into time-based chunks. </span><span class="kobospan" id="kobo.556.2">If we look at the following figure</span><a id="_idTextAnchor2254" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.557.1">, we can see how </span><span><span class="kobospan" id="kobo.558.1">that looks:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer648">
<span class="kobospan" id="kobo.559.1"><img alt="Figure 12.10 – TimescaleDB hypertable chunks diagram" src="image/B19803_12_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.560.1">Figure 12.10 – TimescaleDB hypertable chunks diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.561.1">These time-based chunks are a lot faster to drop from the database than using the Zabbix </span><a id="_idIndexMarker993" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.562.1">housekeeper. </span><span class="kobospan" id="kobo.562.2">The Zabbix housekeeper goes through our database data line by line to check the UNIX timestamp, and then it drops the line when it reaches data that is older than specified. </span><span class="kobospan" id="kobo.562.3">This takes time and resources. </span><span class="kobospan" id="kobo.562.4">Dropping a chunk, though, is </span><span><span class="kobospan" id="kobo.563.1">almost</span><a id="_idTextAnchor2255" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.564.1"> instantaneous.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.565.1">Another great thing about using TimescaleDB with a Zabbix database is that we can still use the frontend item history and trend configuration. </span><span class="kobospan" id="kobo.565.2">On top of that, TimescaleDB can compress our data, to keep </span><span><span class="kobospan" id="kobo.566.1">databases smaller.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.567.1">The downside is that we can’t specify different history and trends for differen</span><a id="_idTextAnchor2256" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2257" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.568.1">t items; it’s all </span><span><span class="kobospan" id="kobo.569.1">global now.</span></span></p>
<h2 id="_idParaDest-387" class="calibre7"><a id="_idTextAnchor2258" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.570.1">See also</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.571.1">This recipe details the installation of PostgreSQL TimescaleDB. </span><span class="kobospan" id="kobo.571.2">As this process is constantly </span><a id="_idIndexMarker994" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.572.1">changing, you might need to include some new information from the official Timesc</span><a id="_idTextAnchor2259" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.573.1">aleDB documentation. </span><span class="kobospan" id="kobo.573.2">Check out their </span><span><span class="kobospan" id="kobo.574.1">documentation here:</span></span></p>
<p class="calibre3"><a href="https://docs.timescale.com/latest/getting-started/installation/rhel-centos/installation-yum" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.575.1">https://docs.timescale.com/latest/getting-started/installatio</span><span id="_idTextAnchor2260"/><span id="_idTextAnchor2261"/><span class="kobospan" id="kobo.576.1">n/rhel-centos/installation-yum</span></span></a></p>
<h1 id="_idParaDest-388" class="calibre5"><span class="kobospan" id="kobo.577.1">Securing your Zabbi</span><a id="_idTextAnchor2262" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.578.1">x MySQL database</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.579.1">Another great added feature for the Zabbix server is the ability to encrypt data between the database </span><a id="_idIndexMarker995" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.580.1">and Zabbix components. </span><span class="kobospan" id="kobo.580.2">This is particularly </span><a id="_idIndexMarker996" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.581.1">useful when you are running a split database and the Zabbix server over the network. </span><span class="kobospan" id="kobo.581.2">A </span><strong class="bold"><span class="kobospan" id="kobo.582.1">Ma</span><a id="_idTextAnchor2263" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.583.1">n-in-the-Middle</span></strong><span class="kobospan" id="kobo.584.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.585.1">MITM</span></strong><span class="kobospan" id="kobo.586.1">) attack or other attacks can be executed on the network to gain access to your </span><span><span class="kobospan" id="kobo.587.1">monitoring data.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.588.1">In this recipe, we’ll set up MySQL encryption between Zabbix co</span><a id="_idTextAnchor2264" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.589.1">mponents and the database t</span><a id="_idTextAnchor2265" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2266" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.590.1">o add another layer </span><span><span class="kobospan" id="kobo.591.1">of sec</span><a id="_idTextAnchor2267" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.592.1">urity.</span></span></p>
<h2 id="_idParaDest-389" class="calibre7"><a id="_idTextAnchor2268" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.593.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.594.1">We are going to need a Zabbix setup that uses an external database. </span><span class="kobospan" id="kobo.594.2">I’ll be using the Linux </span><strong class="source-inline"><span class="kobospan" id="kobo.595.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.596.1"> and </span><span><strong class="source-inline"><span class="kobospan" id="kobo.597.1">lar-book-secure-zbx</span></strong></span><span><span class="kobospan" id="kobo.598.1"> hosts.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.599.1">The new server called </span><strong class="source-inline"><span class="kobospan" id="kobo.600.1">lar-book-secure-zbx</span></strong><span class="kobospan" id="kobo.601.1"> will be used to connect externally to the </span><strong class="source-inline"><span class="kobospan" id="kobo.602.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.603.1"> database server. </span><span class="kobospan" id="kobo.603.2">The database servers won’t run our Zabbix server; this process will run </span><span><span class="kobospan" id="kobo.604.1">on </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.605.1">lar-book-secure-zbx</span></strong></span><span><span class="kobospan" id="kobo.606.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.607.1">Make sure that MariaDB is already installed on the </span><strong class="source-inline"><span class="kobospan" id="kobo.608.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.609.1"> host and that you are running a recent supported version that is able to use encryption. </span><span class="kobospan" id="kobo.609.2">If you don’t know how to upgrade your database, check out the recipe named </span><em class="italic"><span class="kobospan" id="kobo.610.1">Upgrading Zabbix database from older MariaDB versions to MariaDB 10.5</span></em><span class="kobospan" id="kobo.611.1"> in </span><a href="B19803_11.xhtml#_idTextAnchor2025" class="pcalibre calibre6 pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.612.1">Chapter 11</span></em></span></a><span class="kobospan" id="kobo.613.1">, </span><em class="italic"><span class="kobospan" id="kobo.614.1">Maintaining Your Zabbix Setup</span></em><span class="kobospan" id="kobo.615.1">, or</span><a id="_idTextAnchor2269" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2270" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.616.1"> check the </span><span><span class="kobospan" id="kobo.617.1">documentation online.</span></span></p>
<h2 id="_idParaDest-390" class="calibre7"><a id="_idTextAnchor2271" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.618.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.619.1">Make sure your host files on both hosts from the </span><em class="italic"><span class="kobospan" id="kobo.620.1">Getting ready</span></em><span class="kobospan" id="kobo.621.1"> section contain the hostname and IP for your Linux hosts and edit the file with </span><span><span class="kobospan" id="kobo.622.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.623.1">vim /etc/hosts</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.624.1">Then, fill in the file with your hostnames and IPs. </span><span class="kobospan" id="kobo.624.2">It will look </span><span><span class="kobospan" id="kobo.625.1">like this:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.626.1">10.16.16.170 lar-book-secure-db</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.627.1">10.16.16.171 lar-book-secure-zbx</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.628.1">On the </span><strong class="source-inline1"><span class="kobospan" id="kobo.629.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.630.1"> MySQL server, if you haven’t already, create the Zabbix database by logging in </span><span><span class="kobospan" id="kobo.631.1">to MySQL:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.632.1">mysql -u root -p</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.633.1">Then, issue the following command to create </span><span><span class="kobospan" id="kobo.634.1">the database:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.635.1">create database zabbix character set utf8mb4</span><a id="_idTextAnchor2272" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.636.1"> collate utf8mb4_ bin;</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.637.1">Also, make sure to cr</span><a id="_idTextAnchor2273" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.638.1">eate a user that will be able to access the database securely. </span><span class="kobospan" id="kobo.638.2">Make </span><a id="_idIndexMarker997" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.639.1">sure the IP matches the IP from the Zabbix server (and one for the Zabbix frontend if they </span><span><span class="kobospan" id="kobo.640.1">are separate):</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.641.1">create user 'zabbix'@'10.16.16.171' identified BY 'password';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.642.1">grant all privileges on zabbix.* to 'zabbix'@'10.16.16.171';</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.643.1">flush privileges;</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.644.1">Quit MySQL and then make sure to run the secure </span><strong class="source-inline1"><span class="kobospan" id="kobo.645.1">mysql</span></strong><span class="kobospan" id="kobo.646.1"> script with </span><span><span class="kobospan" id="kobo.647.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.648.1">mariadb_secure_installation</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.649.1">Log in to </span><strong class="source-inline1"><span class="kobospan" id="kobo.650.1">lar-book-secure-zbx</span></strong><span class="kobospan" id="kobo.651.1"> and install the Zabbix server repo with the </span><span><span class="kobospan" id="kobo.652.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.653.1">rpm -Uvh https://repo.zabbix.com/zabbix/7.0/rhel/9/x86_64/zabbix-release-7.0-1.el8.noarch.rpm</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.654.1">dnf clean all</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.655.1">Let’s add the MariaDB repository on </span><span><span class="kobospan" id="kobo.656.1">our server:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.657.1">wget https://downloads.mariadb.com/MariaDB/mariadb_repo_setup</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.658.1">chmod +x mariadb_repo_setup</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.659.1">./mariadb_repo_setup</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.660.1">Then, install the Zabbix server and its </span><span><span class="kobospan" id="kobo.661.1">required components.</span></span><p class="calibre3"><span class="kobospan" id="kobo.662.1">Use the following </span><span><span class="kobospan" id="kobo.663.1">RHEL-based command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.664.1">dnf install zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf zabbix-agent2 zabbix-sql-scripts mariadb-client</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.665.1">Use the following </span><span><span class="kobospan" id="kobo.666.1">Ubuntu command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.667.1">apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabb</span><a id="_idTextAnchor2274" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.668.1">ix-agent2 mariadb-client</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.669.1">From the </span><a id="_idIndexMarker998" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.670.1">Z</span><a id="_idTextAnchor2275" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.671.1">abbix server, connect to the remote database server and import the database schema and default data with the </span><span><span class="kobospan" id="kobo.672.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.673.1">zcat /usr/share/doc/zabbix-sql-scripts/mysql/server.sql.gz | mysql -h 10.16.16.170 -uzabbix -p zabbix</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.674.1">Now we are going to open the file called </span><strong class="source-inline1"><span class="kobospan" id="kobo.675.1">openssl.cnf</span></strong><span class="kobospan" id="kobo.676.1"> and edit it by issuing the </span><span><span class="kobospan" id="kobo.677.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.678.1">vim /etc/pki/tls/openssl.cnf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.679.1">In this file, we need to edit the </span><span><span class="kobospan" id="kobo.680.1">following lines:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.681.1">countryName_default = XX</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.682.1">stateOrProvinceName_default = Default Province</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.683.1">localityName_default = Default City</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.684.1">0.organizationName_default = Default Company Ltd</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.685.1">organizationalUnitName_default.=</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.686.1">It will look</span><a id="_idTextAnchor2276" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.687.1"> like this filled </span><span><span class="kobospan" id="kobo.688.1">out completely:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer649">
<span class="kobospan" id="kobo.689.1"><img alt="Figure 12.11 – OpenSSL config file ﻿with our personal defaults" src="image/B19803_12_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.690.1">Figure 12.11 – OpenSSL config file </span><a id="_idTextAnchor2277" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.691.1">with our personal defaults</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.692.1">We can </span><a id="_idIndexMarker999" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.693.1">also see </span><span><span class="kobospan" id="kobo.694.1">this line:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.695.1">dir = /etc/pki/CA    # </span><a id="_idTextAnchor2278" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.696.1">Where everything is kept</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.697.1">This means the default directory is </span><strong class="source-inline1"><span class="kobospan" id="kobo.698.1">/etc/pki/CA</span></strong><span class="kobospan" id="kobo.699.1">; if yours is different, act accordingly. </span><span class="kobospan" id="kobo.699.2">Close the file by saving, </span><span><span class="kobospan" id="kobo.700.1">and continue.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.701.1">Let’s create a new folder for our private certificates using the </span><span><span class="kobospan" id="kobo.702.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.703.1">mkdir -p /etc/pki/CA/private</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.704.1">Now, let’s create our key pair in the new folder. </span><span class="kobospan" id="kobo.704.2">Issue the </span><span><span class="kobospan" id="kobo.705.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.706.1">openssl req -new -x509 -keyout /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650 -newkey rsa:4096</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.707.1">You wil</span><a id="_idTextAnchor2279" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.708.1">l be prompted for a </span><span><span class="kobospan" id="kobo.709.1">password now:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer650">
<span class="kobospan" id="kobo.710.1"><img alt="Figure 12.12 – Certificate generation respons﻿e asking for a password" src="image/B19803_12_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.711.1">Figure 12.12 – Certificate generation respons</span><a id="_idTextAnchor2280" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.712.1">e asking for a password</span></p>
<ol class="calibre16">
<li value="19" class="calibre15"><span class="kobospan" id="kobo.713.1">You might </span><a id="_idIndexMarker1000" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.714.1">also be</span><a id="_idTextAnchor2281" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.715.1"> prompted to enter some information about your company. </span><span class="kobospan" id="kobo.715.2">It will use the default we filled in earlier, so you can just press </span><em class="italic"><span class="kobospan" id="kobo.716.1">Enter</span></em><span class="kobospan" id="kobo.717.1"> up until </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.718.1">Common Name</span></strong></span><span><span class="kobospan" id="kobo.719.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.720.1">Fill in </span><strong class="source-inline1"><span class="kobospan" id="kobo.721.1">Root CA</span></strong><span class="kobospan" id="kobo.722.1"> for </span><strong class="source-inline1"><span class="kobospan" id="kobo.723.1">Common Name</span></strong><span class="kobospan" id="kobo.724.1"> and </span><a id="_idTextAnchor2282" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.725.1">add your email address </span><span><span class="kobospan" id="kobo.726.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer651">
<span class="kobospan" id="kobo.727.1"><img alt="Figure 12.13 – Certificate generation response asking for information, Root CA" src="image/B19803_12_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.728.1">Figure 12.13 – Certificate generation response asking for information, Root CA</span></p>
<ol class="calibre16">
<li value="21" class="calibre15"><span class="kobospan" id="kobo.729.1">Next up is creating the actual signed certificates that our Zabbix server will use. </span><span class="kobospan" id="kobo.729.2">Let’s make sure that OpenSSL has the right files to keep track of </span><span><span class="kobospan" id="kobo.730.1">signed certificates:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.731.1">touch /etc/pki/CA/index.txt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.732.1">echo 01 &gt; /etc/pki/CA/serial</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.733.1">Then, create the folders to keep our </span><span><span class="kobospan" id="kobo.734.1">certificates in:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.735.1">mkdir /etc/pki/CA/unsigned</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.736.1">mkdir /etc/pki/CA/newcerts</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.737.1">m</span><a id="_idTextAnchor2283" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.738.1">kdir /etc/pki/CA/certs</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.739.1">Now, let’s create our certificate signing request for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.740.1">lar-book-secure-zbx</span></strong><span class="kobospan" id="kobo.741.1"> Zabbix server with the </span><span><span class="kobospan" id="kobo.742.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.743.1">openssl req -nodes -new -keyout /etc/pki/CA/private/zbx-srv_key.pem -out /etc/pki/CA/unsigned/zbx-srv_re</span><a id="_idTextAnchor2284" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.744.1">q.pem -newkey rsa:2048</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.745.1">You will be prompted to add a password and your company information again. </span><span class="kobospan" id="kobo.745.2">Use the </span><a id="_idIndexMarker1001" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.746.1">default up until </span><strong class="source-inline1"><span class="kobospan" id="kobo.747.1">Common Name</span></strong><span class="kobospan" id="kobo.748.1">. </span><span class="kobospan" id="kobo.748.2">We will fill out our </span><strong class="source-inline1"><span class="kobospan" id="kobo.749.1">Common Name</span></strong><span class="kobospan" id="kobo.750.1">, which will be the server hostname, and we’ll</span><a id="_idTextAnchor2285" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.751.1"> add our email address </span><span><span class="kobospan" id="kobo.752.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer652">
<span class="kobospan" id="kobo.753.1"><img alt="Figure 12.14 – Certificate generation response asking for information, lar-book-secure-zbx" src="image/B19803_12_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.754.1">Figure 12.14 – Certificate generation response asking for information, lar-book-secure-zbx</span></p>
<ol class="calibre16">
<li value="25" class="calibre15"><span class="kobospan" id="kobo.755.1">Let’s do the same for our </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.756.1">lar-book-secure-db</span></strong></span><span><span class="kobospan" id="kobo.757.1"> server:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.758.1">openssl req -nodes -new -keyout /etc/pki/CA/private/mysql-srv_key.pem -out /etc/pki/CA/unsigned/mysql-srv_req.pem -newkey rsa:2048</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.759.1">T</span><a id="_idTextAnchor2286" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.760.1">he response will look </span><span><span class="kobospan" id="kobo.761.1">like this:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer653">
<span class="kobospan" id="kobo.762.1"><img alt="Figure 12.15 – Certificate generation response asking for information, lar-book-secure-db" src="image/Image96555.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.763.1">Figure 12.15 – Certificate generation response asking for information, lar-book-secure-db</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.764.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.765.1">Our certificates need to be created without a password; otherwise, our MariaDB and Zabbix applications won’t be able to use them. </span><span class="kobospan" id="kobo.765.2">Make sure to spec</span><a id="_idTextAnchor2287" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.766.1">ify the </span><strong class="source-inline1"><span class="kobospan" id="kobo.767.1">-</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.768.1">nodes</span></strong></span><span><span class="kobospan" id="kobo.769.1"> option.</span></span></p>
<ol class="calibre16">
<li value="26" class="calibre15"><span class="kobospan" id="kobo.770.1">Now, sign the certifi</span><a id="_idTextAnchor2288" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.771.1">cate for </span><strong class="source-inline1"><span class="kobospan" id="kobo.772.1">lar-book-secure-zbx</span></strong><span class="kobospan" id="kobo.773.1"> with the </span><span><span class="kobospan" id="kobo.774.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.775.1">openssl ca -policy policy_anything -days 365 -out /etc/pki/CA/certs/zbx-srv_crt.pem -infiles /etc/pki/CA/unsigned/zbx-srv_req.pem</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.776.1">You will be </span><a id="_idIndexMarker1002" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.777.1">prompted with the question </span><strong class="source-inline1"><span class="kobospan" id="kobo.778.1">Sign the certificate? </span><span class="kobospan" id="kobo.778.2">[y/n]</span></strong><span class="kobospan" id="kobo.779.1">. </span><span class="kobospan" id="kobo.779.2">Answer this and all the following questions </span><span><span class="kobospan" id="kobo.780.1">with </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.781.1">Y</span></strong></span><span><span class="kobospan" id="kobo.782.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.783.1">Now, let’s do the same thing for the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.784.1">lar-book-secure-db</span></strong></span><span><span class="kobospan" id="kobo.785.1"> certificate:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.786.1">openssl ca -policy policy_anything -days 365 -out/etc/ pki/CA/certs/mysql-srv_crt.pem -infiles/etc/pki/CA/ unsigned/mysql-srv_req.pem</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.787.1">Let’s log in to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.788.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.789.1"> MySQL server and create a directory for our newly </span><span><span class="kobospan" id="kobo.790.1">created certificates:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.791.1">mkdir /etc/my.cnf.d/certificates/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.792.1">Add the right permissions to </span><span><span class="kobospan" id="kobo.793.1">the folder:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.794.1">chown -R mysql. </span><span class="kobospan1" id="kobo.794.2">/etc/my.cnf.d/certificates/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.795.1">Now, back on the new </span><strong class="source-inline1"><span class="kobospan" id="kobo.796.1">lar-book-secure-zbx</span></strong><span class="kobospan" id="kobo.797.1"> Zabbix server, copy over the files to the database server with the </span><span><span class="kobospan" id="kobo.798.1">following commands:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.799.1">scp /etc/pki/CA/private/mysql-srv_key.pem root@10.16.16.170:/etc/my.cnf.d/certificates/mysql-srv.key</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.800.1">scp /etc/pki/CA/certs/mysql-srv_crt.pem root@10.16.16.170:/etc/my.cnf.d/certificates/mysql-srv.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.801.1">scp /etc/pki/CA/cacert.pem root@10.16.16.170:/etc/my.cnf.d</span><a id="_idTextAnchor2289" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.802.1">/certificates/cacert.crt</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.803.1">Now, back on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.804.1">lar</span><a id="_idTextAnchor2290" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.805.1">-book-secure-db</span></strong><span class="kobospan" id="kobo.806.1"> MySQL server, add the right permissions to </span><span><span class="kobospan" id="kobo.807.1">the files:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.808.1">chown -R mysql:mysql /etc/my.cnf.d/certificates/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.809.1">chmod 400 /etc/my.cnf.d/certificates/mysql-srv.key</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.810.1">chmod 444 /etc/my.cnf.d/certificates/mysql-srv.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.811.1">chmod 444 /etc/my.cnf.d/certificates/cacert.crt</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.812.1">Edit the </span><a id="_idIndexMarker1003" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.813.1">MariaDB configuration file with the </span><span><span class="kobospan" id="kobo.814.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.815.1">vim /etc/my.cnf.d/server.cnf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.816.1">Add the following lines to the configuration file under the </span><strong class="source-inline1"><span class="kobospan" id="kobo.817.1">[</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.818.1">mysqld]</span></strong></span><span><span class="kobospan" id="kobo.819.1"> block:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.820.1">bind-address=lar-book-secure-db</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.821.1">ssl-ca=/etc/my.cnf.d/certificates/cacert.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.822.1">ssl-cert=/etc/my.cnf.d/certificates/mysql-srv.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.823.1">ssl-key=/etc/my.cnf.d/certificates/mysql-srv.key</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.824.1">Log in to MySQL with the </span><span><span class="kobospan" id="kobo.825.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.826.1">mysql -u root -p</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.827.1">Make sure our Zabbix MySQL user requires SSL encryption with </span><span><span class="kobospan" id="kobo.828.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.829.1">alter user 'zabbix'@'10.16.16.152' require ssl;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.830.1">flush privileges;</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.831.1">Make sure the IP matches the IP from the Zabbix server (and one for the Zabbix frontend, if they are separated), just like we did in </span><span><em class="italic"><span class="kobospan" id="kobo.832.1">step 2</span></em></span><span><span class="kobospan" id="kobo.833.1">.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.834.1">Quit out of the MariaDB CLI and then restart MariaDB with the </span><span><span class="kobospan" id="kobo.835.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><a id="_idTextAnchor2291" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.836.1">systemctl restart mariadb</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.837.1">Now, back on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.838.1">lar-book-secure-zbx</span></strong><span class="kobospan" id="kobo.839.1"> Zabbix server, create a new folder for </span><span><span class="kobospan" id="kobo.840.1">our certificates:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.841.1">mkdi</span><a id="_idTextAnchor2292" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.842.1">r -p /var/lib/zabbix/ssl/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.843.1">Copy the certificates over to this folder with </span><span><span class="kobospan" id="kobo.844.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.845.1">cp /etc/pki/CA/cacert.pem /var/lib/zabbix/ssl/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.846.1">cp /etc/pki/CA/certs/zbx-srv_crt.pem/var/lib/zabbix/ssl/zbx-srv.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.847.1">cp /etc/pki/CA/private/zbx-srv_key.pem/var/lib/zabbix/ssl/zbx-srv.key</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.848.1">Edit the </span><a id="_idIndexMarker1004" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.849.1">Zabbix server configuration file to use </span><span><span class="kobospan" id="kobo.850.1">these certificates:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.851.1">vim /etc/zabbix/zabbix_server.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.852.1">Make sure the following lines match our </span><strong class="source-inline1"><span class="kobospan" id="kobo.853.1">lar-book-secure-db</span></strong><span class="kobospan" id="kobo.854.1"> database </span><span><span class="kobospan" id="kobo.855.1">server’s setup:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.856.1">DBHost=lar-book-secure-db</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.857.1">DBName=zabbix</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.858.1">DBUser=zabbix</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.859.1">DBPassword=password</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.860.1">Now, make sure our SSL-related configuration matches our </span><span><span class="kobospan" id="kobo.861.1">new files:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.862.1">DBTLSConnect=verify_full</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.863.1">DBTLSCAFile=/var/lib/zabbix/ssl/cacert.pem</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.864.1">DBTLSCertFile=/var/lib/zabbix/ssl/zbx-srv.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.865.1">DBTLSKeyFile=/var/l</span><a id="_idTextAnchor2293" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.866.1">ib/zabbix/ssl/zbx-srv.key</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.867.1">Also, make sure to add the right permissions to the </span><span><span class="kobospan" id="kobo.868.1">SSL-related files:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.869.1">chown -R zabbix:zabbix /var/lib/zabbix/ssl/</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.870.1">chmod 400 /var/lib/zabbix/ssl/zbx-srv.key</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.871.1">chmod 444 /var/lib/zabbix/ssl/zbx-srv.crt</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.872.1">chmod 444 /var/</span><a id="_idTextAnchor2294" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.873.1">lib/zabbix/ssl/cacert.pem</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.874.1">Start and </span><a id="_idIndexMarker1005" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.875.1">enable the Zabbix server with the </span><span><span class="kobospan" id="kobo.876.1">following commands:</span></span><ul class="calibre17"><li class="calibre15"><span><span class="kobospan" id="kobo.877.1">RHEL-based systems:</span></span></li><li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.878.1">systemctl restart zabbix-server zabbix-agent2 </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.879.1">httpd php-fpm</span></strong></span></li><li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.880.1">systemctl enable zabbix-server zabbix-agent2 </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.881.1">httpd php-fpm</span></strong></span></li><li class="calibre15"><span><span class="kobospan" id="kobo.882.1">Ubuntu systems:</span></span></li><li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.883.1">systemctl restart zabbix-server zabbix-agent2 </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.884.1">apache2 php-fpm</span></strong></span></li><li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.885.1">systemctl enable zabbix-server zabbix-agent2 </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.886.1">apache2 php-fpm</span></strong></span></li></ul></li>
<li class="calibre15"><span class="kobospan" id="kobo.887.1">Then, navigate to the Zabbix frontend and fill in the right information, as</span><a id="_idTextAnchor2295" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.888.1"> shown in the </span><span><span class="kobospan" id="kobo.889.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer654">
<span class="kobospan" id="kobo.890.1"><img alt="Figure 12.16 – Zabbix frontend c﻿onfiguration, database step" src="image/B19803_12_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.891.1">Figure 12.16 – Zabbix frontend c</span><a id="_idTextAnchor2296" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.892.1">onfiguration, database step</span></p>
<ol class="calibre16">
<li value="46" class="calibre15"><span class="kobospan" id="kobo.893.1">When we </span><a id="_idIndexMarker1006" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.894.1">clic</span><a id="_idTextAnchor2297" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.895.1">k </span><strong class="bold"><span class="kobospan" id="kobo.896.1">Next step</span></strong><span class="kobospan" id="kobo.897.1">, we need</span><a id="_idTextAnchor2298" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.898.1"> to fill out some </span><span><span class="kobospan" id="kobo.899.1">more information:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer655">
<span class="kobospan" id="kobo.900.1"><img alt="Figure 12.17 – Zabbix frontend configuration, server details step" src="image/B19803_12_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.901.1">Figure 12.17 – Zabbix frontend configuration, server details step</span></p>
<ol class="calibre16">
<li value="47" class="calibre15"><span class="kobospan" id="kobo.902.1">Then, after clicking </span><strong class="bold"><span class="kobospan" id="kobo.903.1">Next step</span></strong><span class="kobospan" id="kobo.904.1">, </span><strong class="bold"><span class="kobospan" id="kobo.905.1">Next step</span></strong><span class="kobospan" id="kobo.906.1">, and </span><strong class="bold"><span class="kobospan" id="kobo.907.1">Finish</span></strong><span class="kobospan" id="kobo.908.1">, the frontend sh</span><a id="_idTextAnchor2299" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2300" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.909.1">ould now be configured </span><span><span class="kobospan" id="kobo.910.1">and working.</span></span></li>
</ol>
<h2 id="_idParaDest-391" class="calibre7"><a id="_idTextAnchor2301" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.911.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.912.1">This was </span><a id="_idIndexMarker1007" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.913.1">quite a long recipe, so let’s break it </span><span><span class="kobospan" id="kobo.914.1">down quickly:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.915.1">In </span><em class="italic"><span class="kobospan" id="kobo.916.1">steps 1</span></em><span class="kobospan" id="kobo.917.1"> through </span><em class="italic"><span class="kobospan" id="kobo.918.1">9</span></em><span class="kobospan" id="kobo.919.1">, we prepared </span><span><span class="kobospan" id="kobo.920.1">our servers</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.921.1">In </span><em class="italic"><span class="kobospan" id="kobo.922.1">steps 10</span></em><span class="kobospan" id="kobo.923.1"> through </span><em class="italic"><span class="kobospan" id="kobo.924.1">37</span></em><span class="kobospan" id="kobo.925.1">, we executed everything needed to create </span><span><span class="kobospan" id="kobo.926.1">our certificates</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.927.1">In </span><em class="italic"><span class="kobospan" id="kobo.928.1">steps 38</span></em><span class="kobospan" id="kobo.929.1"> through </span><em class="italic"><span class="kobospan" id="kobo.930.1">47</span></em><span class="kobospan" id="kobo.931.1">, we set up our </span><a id="_idTextAnchor2302" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.932.1">Zabbix frontend </span><span><span class="kobospan" id="kobo.933.1">for encryption</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.934.1">Going thro</span><a id="_idTextAnchor2303" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.935.1">ugh all these steps, setting up your Zabbix database securely can seem like quite a daunting task, and it can be. </span><span class="kobospan" id="kobo.935.2">Certificates, login procedures, loads of settings, and more can all add up to become very complicated, which is why I’d always recommend diving deeper into encryption methods before trying to set this </span><span><span class="kobospan" id="kobo.936.1">up yourself.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.937.1">If your setup </span><a id="_idIndexMarker1008" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.938.1">requires encryption, though, this recipe is a solid starting point for your first-time setup. </span><span class="kobospan" id="kobo.938.2">It works very well in an internal setting, as we are using </span><span><span class="kobospan" id="kobo.939.1">private certificates.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.940.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.941.1">Make sure to renew your SSL certificates, as they are only valid for however long we defined. </span><span class="kobospan" id="kobo.941.2">In this case, it’s 365 days, so we will renew them every year. </span><span class="kobospan" id="kobo.941.3">It’s also a good plan to monitor the expiry date of the certificate and create an alert in Zabbix </span><span><span class="kobospan" id="kobo.942.1">for it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.943.1">All Zabbix components, except for communication between the Zabbix server and Zabbix frontend, can be encrypted</span><a id="_idTextAnchor2304" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.944.1">, as shown in the </span><span><span class="kobospan" id="kobo.945.1">following diagram:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer656">
<span class="kobospan" id="kobo.946.1"><img alt="Figure 12.18 – Zabbix encryption scheme possibilities" src="image/B19803_12_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.947.1">Figure 12.18 – Zabbix encryption scheme possibilities</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.948.1">We’ve set </span><a id="_idIndexMarker1009" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.949.1">up encryption between </span><span><span class="kobospan" id="kobo.950.1">the following:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.951.1">The Zabbix server </span><span><span class="kobospan" id="kobo.952.1">and MariaDB</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.953.1">The Zabbix frontend </span><span><span class="kobospan" id="kobo.954.1">and MariaDB</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.955.1">This means that when our Zabbix server or frontend requests or writes data to our database, it will be encrypted. </span><span class="kobospan" id="kobo.955.2">Because our Zabbix applications are running on a different server than our Zabbix database, this might be important. </span><span class="kobospan" id="kobo.955.3">For exam</span><a id="_idTextAnchor2305" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.956.1">ple, our setup might look </span><span><span class="kobospan" id="kobo.957.1">like this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer657">
<span class="kobospan" id="kobo.958.1"><img alt="Figure 12.19 – Zabbix setup with an externa﻿l network diagram" src="image/B19803_12_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.959.1">Figure 12.19 – Zabbix setup with an externa</span><a id="_idTextAnchor2306" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.960.1">l network diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.961.1">Let’s say the cloud is called </span><strong class="bold"><span class="kobospan" id="kobo.962.1">Some company</span></strong><span class="kobospan" id="kobo.963.1"> in a network that isn’t managed by us. </span><span class="kobospan" id="kobo.963.2">There are several switches and routers in this network that are used for numerous clients with their own VLANs. </span><span class="kobospan" id="kobo.963.3">If one of these devices gets compromised somehow, all of our Zabbix data could be seen </span><span><span class="kobospan" id="kobo.964.1">by others.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.965.1">Even if the </span><a id="_idIndexMarker1010" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.966.1">network equipment is ours, there might still be a compromised device in the network and our data can be seen. </span><span class="kobospan" id="kobo.966.2">This is why you might want to add encryption, to add that extra layer of security. </span><span class="kobospan" id="kobo.966.3">Whether it’s breaches in other companies and their network that you want to secure against or whether it’s against your own breaches, securing your database as we did in this recipe might just save you from leaking all </span><span><span class="kobospan" id="kobo.967.1">that data.</span></span></p>
</div>
</body></html>