<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;5.&#xA0;Using PostgreSQL with OpenShift Applications"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Using PostgreSQL with OpenShift Applications</h1></div></div></div><p class="calibre6">This chapter presents a number of recipes that show you how to get started with the OpenShift PostgreSQL database cartridge. You will learn how to add and manage the PostgreSQL cartridge, how to take backups of a PostgreSQL database, how to list and install PostgreSQL extensions, and how to use the EnterpriseDB PostgreSQL Cloud Database service with OpenShift applications. The specific recipes within this chapter are:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Adding the PostgreSQL cartridge to your application</li><li class="listitem">Accessing the PostgreSQL cartridge from your local machine</li><li class="listitem">Connecting to the PostgreSQL cartridge using pgAdmin from your local machine</li><li class="listitem">Updating the PostgreSQL max_connections setting</li><li class="listitem">Using the .psqlrc configuration file to configure the OpenShift application psql shell</li><li class="listitem">Performing scheduled PostgreSQL database backups</li><li class="listitem">Using EnterpriseDB PostgreSQL Cloud Database with OpenShift</li><li class="listitem">Installing PostgreSQL extensions</li></ul></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Using PostgreSQL with OpenShift Applications">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec64" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre6">PostgreSQL<a id="id420" class="calibre1"/> is a popular, open source relational database used by many web applications around the world. OpenShift supports a stock standard, security hardened version of PostgreSQL database. As you are using standard versions of databases, you are not locked inside OpenShift and can easily port your data if required.</p><p class="calibre6">This chapter will use the PHP 5.4 application we created in <a class="calibre1" title="Chapter 3. Creating and Managing Applications" href="part0041_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Creating and Managing Applications</em></span>. If you do not have any OpenShift application running, you can create a new OpenShift application by running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app myapp php-5.4</strong></span>
</pre></div><p class="calibre6">You can also use third-party database services, such as EnterpriseDB Cloud Database<a id="id421" class="calibre1"/>, if running your database in OpenShift is not possible or you have already invested in third-party services. Another reason why you might like to use a third-party database service is that the OpenShift PostgreSQL cartridge is not scalable. So, for applications where you need horizontally scalable and highly available PostgreSQL service, you can use a third-party provider, such as EnterpriseDB, with your application.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding the PostgreSQL cartridge to your application"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec65" class="calibre1"/>Adding the PostgreSQL cartridge to your application</h1></div></div></div><p class="calibre6">At the time of writing <a id="id422" class="calibre1"/>this book, OpenShift supports two<a id="id423" class="calibre1"/> versions of the PostgreSQL database. You can view all the supported PostgreSQL versions by running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridges|grep postgresql</strong></span>
<span class="strong"><strong class="calibre7">postgresql-8.4      PostgreSQL 8.4                          addon</strong></span>
<span class="strong"><strong class="calibre7">postgresql-9.2      PostgreSQL 9.2                          addon</strong></span>
</pre></div><p class="calibre6">In this recipe, you will learn how to add the PostgreSQL 9.2 cartridge to your OpenShift application.</p></div>

<div class="book" title="Adding the PostgreSQL cartridge to your application">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec254" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need the rhc command-line client installed on your machine. Please refer to the <span class="strong"><em class="calibre10">Installing the OpenShift rhc command-line client</em></span> recipe in <a class="calibre1" title="Chapter 1. Getting Started with OpenShift" href="part0014_split_000.html#page">Chapter 1</a>, <span class="strong"><em class="calibre10">Getting Started with OpenShift</em></span>, for details. Also, we will use the application created in the <span class="strong"><em class="calibre10">Creating an OpenShift application using the rhc command-line client</em></span> recipe in <a class="calibre1" title="Chapter 3. Creating and Managing Applications" href="part0041_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Creating and Managing Applications</em></span>.</p></div></div>

<div class="book" title="Adding the PostgreSQL cartridge to your application">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec255" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">To install the PostgreSQL 9.2 cartridge to the <code class="email">myapp</code> application, open a new command-line terminal, change the directory to the <code class="email">myapp</code> directory location, and then execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc add-cartridge --app myapp -c postgresql-9.2</strong></span>
</pre></div><p class="calibre6">This will install a new instance of PostgreSQL server on your application gear. The <code class="email">-c</code> option is used to specify the cartridge name, and the <code class="email">--app</code> option is used to specify the application name. The <code class="email">--app</code> option is not required if you are running the command within the application directory. The <code class="email">-c</code> option is required, but you can get away from writing <code class="email">-c</code>, as the rhc command-line client is intelligent enough to infer that PostgreSQL 9.2 is the cartridge name. The command can be as simple as the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-add postgresql-9</strong></span>
</pre></div><p class="calibre6">You can view the cartridge details using the<a id="id424" class="calibre1"/> <code class="email">rhc show-cartridge</code> command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-show postgresql</strong></span>
<span class="strong"><strong class="calibre7">Using postgresql-9.2 (PostgreSQL 9.2) for 'postgresql'</strong></span>
<span class="strong"><strong class="calibre7">postgresql-9.2 (PostgreSQL 9.2)</strong></span>
<span class="strong"><strong class="calibre7">-------------------------------</strong></span>
<span class="strong"><strong class="calibre7">  Gears:          Located with php-5.4</strong></span>
<span class="strong"><strong class="calibre7">  Connection URL: postgresql://$OPENSHIFT_POSTGRESQL_DB_HOST:$OPENSHIFT_POSTGRESQL_DB_PORT</strong></span>
<span class="strong"><strong class="calibre7">  Database Name:  myapp</strong></span>
<span class="strong"><strong class="calibre7">  Password:       dPLehGi-UGQi</strong></span>
<span class="strong"><strong class="calibre7">  Username:       admin8awrwrc</strong></span>
</pre></div><p class="calibre6">You can stop the <a id="id425" class="calibre1"/>PostgreSQL server using the <code class="email">stop</code> <a id="id426" class="calibre1"/>command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-stop postgresql</strong></span>
</pre></div><p class="calibre6">You can restart the PostgreSQL server using the <code class="email">restart</code> command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-restart postgresql</strong></span>
</pre></div><p class="calibre6">If you want to remove the PostgreSQL server from your application, you can use the <code class="email">remove</code> command as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-remove postgresql –-confirm</strong></span>
</pre></div></div></div>

<div class="book" title="Adding the PostgreSQL cartridge to your application">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec256" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">When you<a id="id427" class="calibre1"/> run the <code class="email">rhc cartridge-add</code> command, rhc will make a HTTP POST request to the OpenShift server. The OpenShift server will receive the request and install a new instance of the PostgreSQL database on your application gear. After provisioning the PostgreSQL server, the rhc client will show the database details on the command-line terminal as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">Adding postgresql-9.2 to application 'myapp' ... done</strong></span>

<span class="strong"><strong class="calibre7">postgresql-9.2 (PostgreSQL 9.2)</strong></span>
<span class="strong"><strong class="calibre7">-------------------------------</strong></span>
<span class="strong"><strong class="calibre7">  Gears:          Located with php-5.4</strong></span>
<span class="strong"><strong class="calibre7">  Connection URL: postgresql://$OPENSHIFT_POSTGRESQL_DB_HOST:$OPENSHIFT_POSTGRESQL_DB_PORT</strong></span>
<span class="strong"><strong class="calibre7">  Database Name:  myapp</strong></span>
<span class="strong"><strong class="calibre7">  Password:       dPLehGi-UGQi</strong></span>
<span class="strong"><strong class="calibre7">  Username:       admin8awrwrc</strong></span>

<span class="strong"><strong class="calibre7">PostgreSQL 9.2 database added.  Please make note of these credentials:</strong></span>

<span class="strong"><strong class="calibre7">   Root User: admin8awrwrc</strong></span>
<span class="strong"><strong class="calibre7">   Root Password: dPLehGi-UGQi</strong></span>
<span class="strong"><strong class="calibre7">   Database Name: myapp</strong></span>

<span class="strong"><strong class="calibre7">Connection URL: postgresql://$OPENSHIFT_POSTGRESQL_DB_HOST:$OPENSHIFT_POSTGRESQL_DB_PORT</strong></span>
</pre></div><p class="calibre6">You can view the PostgreSQL installation by performing SSH into your application gear:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app myapp</strong></span>
</pre></div><p class="calibre6">Then, run<a id="id428" class="calibre1"/> the <code class="email">ls</code> command to view the gear directory<a id="id429" class="calibre1"/> structure, and you will see the <code class="email">postgresql</code> directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">[myapp-osbook.rhcloud.com 531069cd5973cad58c0000b6]\&gt; ls -p</strong></span>
<span class="strong"><strong class="calibre7">app-deployments/  app-root/  git/  php/  postgresql/</strong></span>
</pre></div><p class="calibre6">The <code class="email">postgresql</code> directory is the location of your PostgreSQL installation, and it is not shared with any other OpenShift application or user. It is only for your application, and only your application can access it.</p><p class="calibre6">You can also connect with your PostgreSQL server using the <code class="email">psql</code> command-line client:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">[myapp-osbook.rhcloud.com 531069cd5973cad58c0000b6]\&gt; psql</strong></span>
<span class="strong"><strong class="calibre7">psql (9.2.4)</strong></span>
<span class="strong"><strong class="calibre7">Type "help" for help.</strong></span>

<span class="strong"><strong class="calibre7">myapp=# </strong></span>
</pre></div><p class="calibre6">Now you can run SQL commands against your PostgreSQL server. To view all the databases, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">myapp=# \list</strong></span>
<span class="strong"><strong class="calibre7">                                    List of databases</strong></span>
<span class="strong"><strong class="calibre7">   Name    |    Owner     | Encoding |   Collate   |    Ctype    |   Access privileges   </strong></span>
<span class="strong"><strong class="calibre7">-----------+--------------+----------+-------------+-------------+-----------------------</strong></span>
<span class="strong"><strong class="calibre7"> myapp     | admin8awrwrc | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </strong></span>
<span class="strong"><strong class="calibre7"> postgres  | postgres     | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </strong></span>
<span class="strong"><strong class="calibre7"> template0 | postgres     | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +</strong></span>
<span class="strong"><strong class="calibre7">           |              |          |             |             | postgres=CTc/postgres</strong></span>
<span class="strong"><strong class="calibre7"> template1 | postgres     | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +</strong></span>
<span class="strong"><strong class="calibre7">           |              |          |             |             | postgres=CTc/postgres</strong></span>
<span class="strong"><strong class="calibre7">(4 rows)</strong></span>

<span class="strong"><strong class="calibre7">myapp=#</strong></span>
</pre></div><p class="calibre6">The <code class="email">myapp</code> database corresponds to your application database. You can use this database for your application or create a new database using the <code class="email">CREATE DATABASE</code> command. To view the uptime of your PostgreSQL server, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">myapp=# select date_trunc('minute',current_timestamp - pg_postmaster_start_time()) as "postgresql_uptime";</strong></span>
<span class="strong"><strong class="calibre7"> postgresql_uptime </strong></span>
<span class="strong"><strong class="calibre7">-------------------</strong></span>
<span class="strong"><strong class="calibre7"> 00:12:00</strong></span>
<span class="strong"><strong class="calibre7">(1 row)</strong></span>
</pre></div><p class="calibre6">The output<a id="id430" class="calibre1"/> shows that the PostgreSQL server<a id="id431" class="calibre1"/> has been up for the last 12 minutes.</p><p class="calibre6">You can view all the available PostgreSQL command-line utilities available on the gear by typing <code class="email">pg_</code> and pressing <span class="strong"><em class="calibre10">Tab</em></span>. The <span class="strong"><em class="calibre10">Tab</em></span> key enables the command-line completion functionality that allows the command-line program to automatically fill the rest of command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">[myapp-osbook.rhcloud.com 531069cd5973cad58c0000b6]\&gt; pg_</strong></span>
<span class="strong"><strong class="calibre7">pg_archivecleanup  pg_controldata     pg_dumpall         pg_resetxlog       pg_test_fsync      </strong></span>
<span class="strong"><strong class="calibre7">pg_basebackup      pg_ctl             pg_filedump        pg_restore         pg_test_timing     </strong></span>
<span class="strong"><strong class="calibre7">pg_config          pg_dump            pg_receivexlog     pg_standby</strong></span>
</pre></div></div></div>

<div class="book" title="Adding the PostgreSQL cartridge to your application">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec257" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">You can also add the<a id="id432" class="calibre1"/> PostgreSQL database<a id="id433" class="calibre1"/> from the OpenShift web console. Go to <a class="calibre1" href="https://openshift.redhat.com/app/console/applications">https://openshift.redhat.com/app/console/applications</a>, and click on the <code class="email">myapp</code> application for details. On the <code class="email">myapp</code> application details web page, you will see the option to add the PostgreSQL database, as shown in the following screenshot. Click on <span class="strong"><strong class="calibre7">Add PostgreSQL 9.2</strong></span> to add the PostgreSQL 9.2 cartridge.</p><div class="mediaobject"><img src="../images/00042.jpeg" alt="There's more…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Next, you will be <a id="id434" class="calibre1"/>directed to the page<a id="id435" class="calibre1"/> to add the PostgreSQL cartridge. Click on <span class="strong"><strong class="calibre7">Add Cartridge</strong></span> to add a PostgreSQL database to your application. Have a look at the following screenshot:</p><div class="mediaobject"><img src="../images/00043.jpeg" alt="There's more…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">After installing the <a id="id436" class="calibre1"/>PostgreSQL cartridge, you <a id="id437" class="calibre1"/>will be shown the PostgreSQL database details as follows:</p><div class="mediaobject"><img src="../images/00044.jpeg" alt="There's more…" class="calibre8"/></div><p class="calibre9"> </p></div></div>

<div class="book" title="Adding the PostgreSQL cartridge to your application">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec258" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Accessing the PostgreSQL cartridge from your local machine </em></span>recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Accessing the PostgreSQL cartridge from your local machine"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec66" class="calibre1"/>Accessing the PostgreSQL cartridge from your local machine</h1></div></div></div><p class="calibre6">In the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe, you learned how to access the PostgreSQL database by <a id="id438" class="calibre1"/>performing SSH into the <a id="id439" class="calibre1"/>application gear. In this recipe, you will learn how to connect with the PostgreSQL database from your local machine.</p></div>

<div class="book" title="Accessing the PostgreSQL cartridge from your local machine">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec259" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need an application with the PostgreSQL cartridge. Please refer to the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe in this chapter to learn how to install the PostgreSQL cartridge. Also, you will need the <code class="email">psql</code> command-line client on your machine. You can download the PostgreSQL server<a id="id440" class="calibre1"/> from the official website, <a class="calibre1" href="http://www.postgresql.org/download/">http://www.postgresql.org/download/</a>.</p></div></div>

<div class="book" title="Accessing the PostgreSQL cartridge from your local machine">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec260" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to access the PostgreSQL cartridge from your local machine:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal and change the directory to the <code class="email">myapp</code> application directory. Execute the following command to forward remote ports to the local machine:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc port-forward </strong></span>
<span class="strong"><strong class="calibre7">Checking available ports ... done</strong></span>
<span class="strong"><strong class="calibre7">Forwarding ports ...</strong></span>
<span class="strong"><strong class="calibre7">Address already in use - bind(2) while forwarding port 5432. Trying local port 5433</strong></span>

<span class="strong"><strong class="calibre7">To connect to a service running on OpenShift, use the Local address</strong></span>

<span class="strong"><strong class="calibre7">Service    Local               OpenShift</strong></span>
<span class="strong"><strong class="calibre7">---------- -------------- ---- -----------------</strong></span>
<span class="strong"><strong class="calibre7">httpd      127.0.0.1:8080  =&gt;  127.6.76.129:8080</strong></span>
<span class="strong"><strong class="calibre7">postgresql 127.0.0.1:5433  =&gt;  127.6.76.130:5432</strong></span>
</pre></div></li><li class="listitem" value="2">Connect to the <a id="id441" class="calibre1"/>PostgreSQL server<a id="id442" class="calibre1"/> from the local machine using the <code class="email">psql</code> command-line client as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ psql --host &lt;host&gt; --port &lt;port&gt; --username &lt;username&gt; myapp</strong></span>
</pre></div><p class="calibre14">Please replace <code class="email">&lt;username&gt;</code> with your PostgreSQL cartridge username and password. The host and port values can be found in the output of the <code class="email">rhc port-forward</code> command. As you can see in step 1, PostgreSQL is available on the <code class="email">127.0.0.1</code> host and port 5433. You can view the username and password by running the <code class="email">rhc show-app</code> or <code class="email">rhc cartridge-show postgresql</code> command.</p></li><li class="listitem" value="3">Once connected, you can run any valid SQL command. The <code class="email">\list</code> command shows the list of available databases:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">adminvtxt5s8@127.0.0.1:5433 myapp#\list</strong></span>
<span class="strong"><strong class="calibre7">                                    List of databases</strong></span>
<span class="strong"><strong class="calibre7">   Name    |    Owner     | Encoding |   Collate   |    Ctype    |   Access privileges   </strong></span>
<span class="strong"><strong class="calibre7">-----------+--------------+----------+-------------+-------------+-------</strong></span>
<span class="strong"><strong class="calibre7">----------------</strong></span>
<span class="strong"><strong class="calibre7"> myapp     | adminvtxt5s8 | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </strong></span>
<span class="strong"><strong class="calibre7"> postgres  | postgres     | UTF8     | en_US.UTF-8 | en_US.UTF-8 | </strong></span>
<span class="strong"><strong class="calibre7"> template0 | postgres     | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +</strong></span>
<span class="strong"><strong class="calibre7">           |              |          |             |             | postgres=CTc/postgres</strong></span>
<span class="strong"><strong class="calibre7"> template1 | postgres     | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +</strong></span>
<span class="strong"><strong class="calibre7">           |              |          |             |             | postgres=CTc/postgres</strong></span>
<span class="strong"><strong class="calibre7">(4 rows)</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Accessing the PostgreSQL cartridge from your local machine">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec261" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In step 1, you <a id="id443" class="calibre1"/>used the <code class="email">rhc port-forward</code> command to <a id="id444" class="calibre1"/>forward all the remote ports to the local machine. The <code class="email">rhc port-forward</code> command<a id="id445" class="calibre1"/> is a wrapper around the SSH port forwarding that makes a port on the remote machine available on your local machine. A port on the remote machine that would otherwise be unavailable to you can be used just as if it's on your local machine. The command returns the list of ports that you can connect from your local machine.</p><p class="calibre6">As you can see in step 1, the <code class="email">postgresql</code> process is available at port 5433 on the <code class="email">127.0.0.1</code> host.</p><p class="calibre6">In step 2, you connected to PostgreSQL from your local machine, passing in the username, password, host, and port of the database. After successful connection, you ran a SQL command in step 3.</p><p class="calibre6">To terminate port forwarding, just press <span class="strong"><em class="calibre10">Ctrl</em></span> + <span class="strong"><em class="calibre10">C</em></span> on the command-line terminal where the <code class="email">rhc port-forward</code> command is running.</p></div></div>

<div class="book" title="Accessing the PostgreSQL cartridge from your local machine">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec262" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Connecting to the PostgreSQL cartridge using pgAdmin from your local machine</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Connecting to the PostgreSQL cartridge using pgAdmin from your local machine"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec67" class="calibre1"/>Connecting to the PostgreSQL cartridge using pgAdmin from your local machine</h1></div></div></div><p class="calibre6">In the <span class="strong"><em class="calibre10">Accessing the PostgreSQL cartridge from your local machine</em></span> recipe, you learned how to connect to the PostgreSQL cartridge from the <code class="email">psql</code> command-line client from your local machine using port forwarding. In this recipe, you will learn how to connect to the PostgreSQL cartridge using pgAdmin from your local machine. pgAdmin is a comprehensive PostgreSQL database design and management system for Unix and Windows systems.</p></div>

<div class="book" title="Connecting to the PostgreSQL cartridge using pgAdmin from your local machine">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec263" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need an application with the PostgreSQL cartridge. Please refer to the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe in this chapter to learn how to add the PostgreSQL cartridge to your application. Also, you will need pgAdmin on your local machine. You can download<a id="id446" class="calibre1"/> pgAdmin from the official website, <a class="calibre1" href="http://www.pgadmin.org/download/">http://www.pgadmin.org/download/</a>.</p></div></div>

<div class="book" title="Connecting to the PostgreSQL cartridge using pgAdmin from your local machine">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec264" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to connect the <a id="id447" class="calibre1"/>PostgreSQL <a id="id448" class="calibre1"/>cartridge using the pgAdmin client:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal, and change the directory to the <code class="email">myapp</code> application directory. Execute the following command to forward remote ports to the local machine:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc port-forward --app myapp</strong></span>
</pre></div></li><li class="listitem" value="2">Start the pgAdmin application, and click on the socket icon to create a new connection.</li><li class="listitem" value="3">Set up a new connection by entering the PostgreSQL database details. You can get the username and password for the PostgreSQL cartridge using the <code class="email">rhc show-app</code> or <code class="email">rhc cartridge-show mysql</code> command. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00045.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="4">Connect to the <a id="id449" class="calibre1"/>PostgreSQL cartridge by <a id="id450" class="calibre1"/>clicking on the <span class="strong"><strong class="calibre7">OK</strong></span> button.</li><li class="listitem" value="5">You will see a connection listed in the left-hand side navigation pane, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00046.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="6">Next, open the SQL editor by first clicking on the <code class="email">myapp</code> database and then clicking on SQL icon. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00047.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="7">Run the following<a id="id451" class="calibre1"/> SQL query <a id="id452" class="calibre1"/>inside the SQL editor to check the database uptime:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">select date_trunc('minute',current_timestamp – pg_postmaster_start_time()) as "postgresql_uptime";</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Connecting to the PostgreSQL cartridge using pgAdmin from your local machine">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec265" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In step 1, you used the <code class="email">rhc port-forward</code> command<a id="id453" class="calibre1"/> to forward all the remote ports to the local machine. This <a id="id454" class="calibre1"/>makes it possible to connect to the <a id="id455" class="calibre1"/>PostgreSQL database running inside your application gear. Step 2 through step 6, you created a new PostgreSQL connection and connected with the PostgreSQL cartridge from within pgAdmin. In step 7, you executed a SQL query using the SQL editor to verify that the connection is getting data from the PostgreSQL cartridge installed in your <code class="email">myapp</code> application.</p></div></div>

<div class="book" title="Connecting to the PostgreSQL cartridge using pgAdmin from your local machine">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec266" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Accessing the PostgreSQL cartridge from your local machine</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Updating the PostgreSQL max_connections setting"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec68" class="calibre1"/>Updating the PostgreSQL max_connections setting</h1></div></div></div><p class="calibre6">The OpenShift PostgreSQL cartridge is configured to allow 100 client connections at the most. If the number of clients connected to the PostgreSQL server goes over this threshold, PostgreSQL will start giving the <code class="email">FATAL too many connections</code> error. In this recipe, you will learn how to update the PostgreSQL cartridge <code class="email">max_connections</code> setting.</p><p class="calibre6">The number of maximum connections is dictated by the <code class="email">max_connections</code> setting in the <code class="email">postgresql.conf</code> configuration file. OpenShift does not allow users to modify the <code class="email">postgresql.conf</code> configuration file. The recommended way to change the <code class="email">max_connections</code> setting is by setting an environment variable.</p></div>

<div class="book" title="Updating the PostgreSQL max_connections setting">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec267" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you<a id="id456" class="calibre1"/> will need an application with the PostgreSQL cartridge. Please refer to the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe in this chapter to learn how to install PostgreSQL cartridge.</p></div></div>

<div class="book" title="Updating the PostgreSQL max_connections setting">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec268" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to update the PostgreSQL <code class="email">max_connections</code> setting:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">To set the maximum connections to <code class="email">200</code>, open a command-line terminal and run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc env-set OPENSHIFT_POSTGRESQL_MAX_CONNECTIONS=200 --app myapp</strong></span>
</pre></div></li><li class="listitem" value="2">After setting the environment variable, you have to restart the PostgreSQL cartridge for changes to take effect as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-restart postgresql --app myapp</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Updating the PostgreSQL max_connections setting">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec269" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">PostgreSQL database<a id="id457" class="calibre1"/> maintains its configuration in a file called <code class="email">postgresql.conf</code> inside the <code class="email">conf</code> directory of your installation. The <code class="email">max_connections</code> configuration setting controls the maximum number of client connections allowed by the PostgreSQL server. You can view the <code class="email">max_connection</code> setting by running a query against your PostgreSQL database. To see <code class="email">max_connections</code> for your OpenShift PostgreSQL cartridge, SSH into the application gear, and run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">myapp=# show max_connections;</strong></span>
<span class="strong"><strong class="calibre7"> max_connections </strong></span>
<span class="strong"><strong class="calibre7">-----------------</strong></span>
<span class="strong"><strong class="calibre7"> 100</strong></span>
<span class="strong"><strong class="calibre7">(1 row)</strong></span>
</pre></div><p class="calibre6">OpenShift does not allow users to modify the <code class="email">postgresql.conf</code> file for security reasons. To allow users to modify the <code class="email">max_connections</code> setting, OpenShift provides an environment variable called <code class="email">OPENSHIFT_POSTGRESQL_MAX_CONNECTIONS</code>, which can be used to set the <code class="email">max_connections</code> system variable. In step 1, you set the <code class="email">OPENSHIFT_POSTGRESQL_MAX_CONNECTIONS</code> environment variable to <code class="email">200</code>. The PostgreSQL server will not read the new value unless you restart the database. So, in step 2, you restarted the database using the <code class="email">rhc cartridge-restart</code> command. To verify that <code class="email">max_connections</code> value is updated, you can run the SQL command again as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">myapp=# show max_connections;</strong></span>
<span class="strong"><strong class="calibre7"> max_connections </strong></span>
<span class="strong"><strong class="calibre7">-----------------</strong></span>
<span class="strong"><strong class="calibre7"> 200</strong></span>
<span class="strong"><strong class="calibre7">(1 row)</strong></span>
</pre></div></div></div>

<div class="book" title="Updating the PostgreSQL max_connections setting">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec270" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">The <code class="email">OPENSHIFT_POSTGRESQL_MAX_CONNECTIONS</code> variable<a id="id458" class="calibre1"/> is not the only configuration property supported by the PostgreSQL cartridge. You can set the following properties using environment <a id="id459" class="calibre1"/>variables. To learn about these settings, please refer to the following documentation: <a class="calibre1" href="https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server">https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server</a>.</p><div class="informalexample"><table border="1" class="calibre15"><colgroup class="calibre16"><col class="calibre17"/><col class="calibre17"/></colgroup><thead class="calibre18"><tr class="calibre19"><th valign="bottom" class="calibre20">
<p class="calibre21">Property</p>
</th><th valign="bottom" class="calibre20">
<p class="calibre21">Environment variable</p>
</th></tr></thead><tbody class="calibre22"><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">shared_buffers</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_SHARED_BUFFERS</code>
</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">datestyle</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_DATESTYLE</code>
</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">ssl</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_SSL_ENABLED</code>
</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">lc_messages</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_LOCALE</code>
</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">lc_monetary</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_LOCALE</code>
</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">lc_numeric</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_LOCALE</code>
</p>
</td></tr><tr class="calibre19"><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">lc_time</code>
</p>
</td><td valign="top" class="calibre23">
<p class="calibre21">
<code class="literal">OPENSHIFT_POSTGRESQL_LOCALE</code>
</p>
</td></tr></tbody></table></div></div></div>

<div class="book" title="Updating the PostgreSQL max_connections setting">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec271" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Using the .psqlrc configuration file to configure the OpenShift application psql shell</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Accessing the PostgreSQL cartridge from your local machine</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using the .psqlrc configuration file to configure the OpenShift application psql shell"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec69" class="calibre1"/>Using the .psqlrc configuration file to configure the OpenShift application psql shell</h1></div></div></div><p class="calibre6">PostgreSQL provides a startup file called <code class="email">.psqrc</code>, which determines the behavior of the <code class="email">psql</code> interactive command-line client. Just like <code class="email">bashrc</code>, the psql client utility attempts to read and execute commands from the system-wide psqlrc file and the user's <code class="email">~/.psqlrc</code> file before starting up. In this recipe, you will learn how you can use your own <code class="email">.psqlrc</code> configuration file to configure your OpenShift application psql shell.</p></div>

<div class="book" title="Using the .psqlrc configuration file to configure the OpenShift application psql shell">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec272" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you <a id="id460" class="calibre1"/>will need <a id="id461" class="calibre1"/>an application with the PostgreSQL cartridge. Please refer to the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe in this chapter to learn how to install the PostgreSQL cartridge. </p></div></div>

<div class="book" title="Using the .psqlrc configuration file to configure the OpenShift application psql shell">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec273" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to configure the psql shell:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Change the directory to <code class="email">myapp</code>, and then SSH into the application gear:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app myapp</strong></span>
</pre></div></li><li class="listitem" value="2">Create a new file in <code class="email">$OPENSHIFT_DATA_DIR</code> named <code class="email">.psqlrc</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">[myapp-osbook.rhcloud.com 531069cd5973cad58c0000b6]\&gt; touch $OPENSHIFT_DATA_DIR/.psqlrc</strong></span>
</pre></div></li><li class="listitem" value="3">Now let's configure the psql shell to store the history of commands you have entered so that you can run them again. This is achieved by setting the <code class="email">HISTFILE</code> location as shown in the following command. The <code class="email">:DBNAME</code> variable allows psql to store a different history for each database. We will also enable psql to print the time taken to execute each command. This is done using the <code class="email">\timing</code> option. To customize the psql shell, add the following content to the <code class="email">.psqrc</code> file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">\set HISTFILE ~/app-root/data/.psql_history- :DBNAME</strong></span>
<span class="strong"><strong class="calibre7">\timing on</strong></span>
</pre></div></li><li class="listitem" value="4">Log out of the <a id="id462" class="calibre1"/>SSH session and create a new environment variable <a id="id463" class="calibre1"/>named <code class="email">PSQLRC</code> to point to the new <code class="email">.psqlrc</code> file location:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc env-set PSQLRC&lt;OPENSHIFT_DATA_DIR&gt;data/.psqlrc</strong></span>
</pre></div><p class="calibre14">Please replace <code class="email">OPENSHIFT_DATA_DIR</code> with your <code class="email">OPENSHIFT_DATA_DIR</code> location. You can get the location by running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app myapp --command 'cd $OPENSHIFT_DATA_DIR &amp;&amp; pwd'</strong></span>
</pre></div></li><li class="listitem" value="5">SSH into the application gear again using the <code class="email">rhc ssh</code> command, and then run the <code class="email">psql</code> command. Run a query, and you will get the timing as well:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">adminvtxt5s8:myapp#SELECT pid, usename from pg_stat_activity;</strong></span>
<span class="strong"><strong class="calibre7">  pid   |   usename    </strong></span>
<span class="strong"><strong class="calibre7">--------+--------------</strong></span>
<span class="strong"><strong class="calibre7"> 354468 | adminvtx</strong></span>
<span class="strong"><strong class="calibre7">t5s8</strong></span>
<span class="strong"><strong class="calibre7">(1 row)</strong></span>

<span class="strong"><strong class="calibre7">Time: 85.372 ms</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Using the .psqlrc configuration file to configure the OpenShift application psql shell">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec274" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">When psql is launched, it looks for a file called <code class="email">psqlrc</code> and runs any command in the file to initialize the environment. On a *nix-based system, this file is called <code class="email">.psqlrc</code> and is usually located under the user's home directory. From step 1 through step 3, you created a new file, <code class="email">.psqlrc</code>, under <code class="email">$OPENSHIFT_DATA_DIR</code>. We added a couple of configurations to the <code class="email">.psqlrc</code> file. The first configuration makes sure that the SQL command history is stored in a file called <code class="email">.psql_history</code> under <code class="email">$OPENSHIFT_DATA_DIR</code>. The second configuration instructs psql to output the query execution time for each query.</p><p class="calibre6">In step 4, you created a new environment variable named <code class="email">PSQLRC</code> that points to the <code class="email">.psqlrc</code> location. Finally, in step 5, you logged in to the psql client and ran a query. After query execution, the <a id="id464" class="calibre1"/>psql client also <a id="id465" class="calibre1"/>showed the time taken to execute the query. As shown in the preceding command-line output, this query took approximately 86 ms.</p></div></div>

<div class="book" title="Using the .psqlrc configuration file to configure the OpenShift application psql shell">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec275" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Accessing the PostgreSQL cartridge from your local machine</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Performing scheduled PostgreSQL database backups"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec70" class="calibre1"/>Performing scheduled PostgreSQL database backups</h1></div></div></div><p class="calibre6">In this recipe, you will learn <a id="id466" class="calibre1"/>how to perform a scheduled backup of your PostgreSQL database and upload it to Amazon S3.</p></div>

<div class="book" title="Performing scheduled PostgreSQL database backups">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec276" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need an application with the PostgreSQL cartridge. Please refer to the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe in this chapter to learn how to add the PostgreSQL cartridge. Also, you need to have the Amazon AWS account. Go to <a class="calibre1" href="http://aws.amazon.com/">http://aws.amazon.com/</a>, and sign up for a new account if you don't already have one.</p></div></div>

<div class="book" title="Performing scheduled PostgreSQL database backups">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec277" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">The following are the steps to perform daily scheduled backup of your PostgreSQL database:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Go to <a class="calibre1" href="https://console.aws.amazon.com/s3/home">https://console.aws.amazon.com/s3/home</a>, and create a new bucket to store your database backups.</li><li class="listitem" value="2">Add the cron cartridge to your application by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc add-cartridge cron --app myapp</strong></span>
</pre></div></li><li class="listitem" value="3">SSH into the application gear, and download the <code class="email">s3-bash</code> utility in <code class="email">$OPENSHIFT_DATA_DIR</code>. Extract it to the <code class="email">s3-bash</code> directory. Have a look at the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app myapp</strong></span>
<span class="strong"><strong class="calibre7">$ cd $OPENSHIFT_DATA_DIR</strong></span>
<span class="strong"><strong class="calibre7">$ wget http://s3-bash.googlecode.com/files/s3-bash.0.02.tar.gz</strong></span>
<span class="strong"><strong class="calibre7">$ mkdir s3-bash</strong></span>
<span class="strong"><strong class="calibre7">$ tar -xf s3-bash.0.02.tar.gz -C s3-bash</strong></span>
</pre></div></li><li class="listitem" value="4">Create a new file named <code class="email">AWSSecretAccessKeyIdFile</code> in the <code class="email">$OPENSHIFT_DATA_DIR/s3-bash</code> directory, and store your Amazon secret access key to it. This is required by <code class="email">s3-bash</code> to communicate with Amazon S3.</li><li class="listitem" value="5">Create a script named <code class="email">database_backup.sh</code> on your local machine in <code class="email">.openshift/cron/minutely</code>, and add the following content to it:<div class="informalexample"><pre class="programlisting">#!/bin/bash
if [ `date +%H:%M` == "23:50" ]
then
    FILE_NAME=$(date +"%Y%m%d%H%M")
    pg_dump --username=$OPENSHIFT_POSTGRESQL_DB_USERNAME --no-password --host=$OPENSHIFT_POSTGRESQL_DB_HOST $BACKUP_DATABASE_NAME &gt; $OPENSHIFT_DATA_DIR/$FILE_NAME.sql
    echo "Took PostgreSQL Dump" &gt;&gt; $OPENSHIFT_CRON_DIR/log/backup.log
    $OPENSHIFT_DATA_DIR/s3-bash/s3-put -k $AWS_ACCESS_KEY_ID -s $OPENSHIFT_DATA_DIR/s3-bash/AWSSecretAccessKeyIdFile -T $OPENSHIFT_DATA_DIR/$FILE_NAME.sql /$AWS_S3_BUCKET/$FILE_NAME.sql
    echo "Uploaded dump to Amazon S3" &gt;&gt; $OPENSHIFT_CRON_DIR/log/backup.log
    rm -f $OPENSHIFT_DATA_DIR/$FILE_NAME.sql
fi</pre></div><p class="calibre14">The previous script will run every day at 23:50 and run the <code class="email">pg_dump</code> command to create the data dump file. The file is then transferred to Amazon S3 using the s3-bash API. Finally, after uploading the file, it deletes the SQL dump file from the application gear.</p></li><li class="listitem" value="6">Now, we have to <a id="id467" class="calibre1"/>set the environment variables so that our script can talk with Amazon S3 as shown in the following commands. If you are not sure how to access your security credentials<a id="id468" class="calibre1"/>, please refer to the documentation at <a class="calibre1" href="http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html">http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html</a>. Have a look at the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc env-set AWS_ACCESS_KEY_ID=&lt; Your Amazon ACCESS_KEY_ID&gt;</strong></span>
<span class="strong"><strong class="calibre7">$ rhc env-set BACKUP_DATABASE_NAME=&lt;Database you want to take backup off&gt;</strong></span>
<span class="strong"><strong class="calibre7">$ rhc env-set AWS_S3_BUCKET=&lt;Amazon S3 bucket name &gt;</strong></span>
</pre></div></li><li class="listitem" value="7">Commit the code, and push the code to the OpenShift gear. Every night at 23:50, a database backup would be done, and your backup would be uploaded to Amazon S3:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git commit –am "database backup script added"</strong></span>
<span class="strong"><strong class="calibre7">$ git push</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Performing scheduled PostgreSQL database backups">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec278" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In the previous<a id="id469" class="calibre1"/> steps, you enabled daily backups of your PostgreSQL database cartridge. The recipe used the cron cartridge to upload database dumps to Amazon S3.</p><p class="calibre6">In step 1, you created a new Amazon S3 bucket to store your PostgreSQL database backups. Amazon S3 is widely used to store static files and is an ideal choice for this job. Next, you added the cron cartridge to the application. The cron cartridge will be used to perform daily backups at a particular time.</p><p class="calibre6">Amazon S3 exposes its REST service that users can use to perform operations on S3 buckets. Amazon provides wrappers of many programming languages around its REST API to make it easy for developers to integrate with their application. As we wanted to keep this recipe language-agnostic, we used the Amazon S3 bash wrapper. Amazon does not officially support this wrapper, but it works very well. In step 3, you downloaded <code class="email">s3-bash</code> using <code class="email">wget</code>. The <code class="email">tar.gz</code> file was stored in <code class="email">$OPENSHIFT_DATA_DIR</code>. You then extracted <code class="email">tar.gz</code> to the <code class="email">s3-bash</code> directory.</p><p class="calibre6">Next, in step 4, you created a file named <code class="email">AWSSecretAccessKeyIdFile</code> to store the Amazon access key secret. The <code class="email">s3-bash</code> wrapper uses a file for the AWS Secret Access Key ID so that it does not appear in the list of running processes with ps.</p><p class="calibre6">In step 5, you created a bash script that will be executed every night at 23:50. The script first takes the database backup using the <code class="email">pg_dump</code> command and then uploads the file to Amazon S3. The filename is the current timestamp. Finally, after uploading the backup to S3, the script deletes the backup to save disk space.</p><p class="calibre6">In step 6, you created three environment variables required by the backup script. Finally, you committed the changes in step 7 and pushed them to the OpenShift application gear.</p></div></div>

<div class="book" title="Performing scheduled PostgreSQL database backups">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec279" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using EnterpriseDB PostgreSQL Cloud Database with OpenShift"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec71" class="calibre1"/>Using EnterpriseDB PostgreSQL Cloud Database with OpenShift</h1></div></div></div><p class="calibre6">In this recipe, you will <a id="id470" class="calibre1"/>learn<a id="id471" class="calibre1"/> how to use EnterpriseDB PostgreSQL Cloud Database with your OpenShift applications. You can also use the Amazon RDS PostgreSQL DB instance in the same way we used the Amazon RDS MySQL DB instance. EnterpriseDB Cloud Database allows you to set up a replicated, sharded, and highly available PostgreSQL cluster either on Amazon EC2 or the HP Cloud services. You can take periodic backups of your data and scale it horizontally without any administrative skills.</p></div>

<div class="book" title="Using EnterpriseDB PostgreSQL Cloud Database with OpenShift">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec280" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you<a id="id472" class="calibre1"/> will need an<a id="id473" class="calibre1"/> OpenShift application. Refer to the <span class="strong"><em class="calibre10">Creating an OpenShift application using the rhc command-line client</em></span> recipe in <a class="calibre1" title="Chapter 3. Creating and Managing Applications" href="part0041_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Creating and Managing Applications</em></span>, for more information.</p></div></div>

<div class="book" title="Using EnterpriseDB PostgreSQL Cloud Database with OpenShift">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec281" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to learn how to connect your OpenShift applications with the EnterpriseDB PostgreSQL database:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Go to <a class="calibre1" href="http://www.enterprisedb.com/cloud-database/amazon">http://www.enterprisedb.com/cloud-database/amazon</a>, and click on <span class="strong"><strong class="calibre7">Get Started Now</strong></span> in the free trial section.</li><li class="listitem" value="2">Next, you will be directed to the signup page. Enter the valid details, and click on the submit button.</li><li class="listitem" value="3">After successful signup, you will be redirected to the dashboard console as shown in the next screenshot. Here, you can launch a database cluster, see the resources you are consuming, or see the status update of the service. At the bottom of the dashboard, there are links to the tutorials and documentation about PostgreSQL CloudDB.</li><li class="listitem" value="4">Now, we will create our first DB cluster on EnterpriseDB Cloud by clicking on <span class="strong"><strong class="calibre7">Launch DB Cluster</strong></span>. This will open a pop up where you need to provide details of your cluster, as shown in the following screenshot. The details include the name of the cluster, PostgreSQL version, instance size of Amazon, number of nodes, and the master username and password.<div class="mediaobject"><img src="../images/00048.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="5">After entering <a id="id474" class="calibre1"/>cluster <a id="id475" class="calibre1"/>details, you can choose how many backups you want to keep and when you would like to take the backup. Use the default options.</li><li class="listitem" value="6">Finally, click on the <span class="strong"><strong class="calibre7">Launch</strong></span> button. This will initiate the process of creating a replicated DB cluster, as shown in the following screenshot. It will take a couple of minutes to launch the cluster, so please be patient. From the <span class="strong"><strong class="calibre7">Clusters</strong></span> tab, you can get information about the database clusters you own. In the <span class="strong"><strong class="calibre7">Details</strong></span> tab, you can see the address where master and replica are running.<div class="mediaobject"><img src="../images/00049.jpeg" alt="How to do it…" class="calibre8"/><div class="caption"><p class="calibre24">Creating a replicated DB cluster</p></div></div><p class="calibre12"> </p></li><li class="listitem" value="7">To connect to the EnterpriseDB PostgreSQL Cloud DB, SSH into the application gear, and use the <code class="email">psql</code> command to connect with Cloud DB. Every application gear has psql installed on it. The host address is the address of master that you can get from step 6.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ psql -h host_address.compute-1.amazonaws.com -p 9999 -U postgres -W postgres</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Using EnterpriseDB PostgreSQL Cloud Database with OpenShift">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec282" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">Step 1 through<a id="id476" class="calibre1"/> step 6 helped you create<a id="id477" class="calibre1"/> a new instance of EnterpriseDB PostgreSQL Cloud DB instance. You are required to provide details related to your DB instance, and EnterpriseDB will provision a PostgreSQL DB instance based on the details you entered. By step 6, you had a running PostgreSQL DB instance that you could connect from the outside world. You can connect it from your local machine or from your OpenShift application gear.</p><p class="calibre6">In step 7, you used the database details to connect to the EnterpriseDB PostgreSQL instance using the psql command-line client.</p></div></div>

<div class="book" title="Using EnterpriseDB PostgreSQL Cloud Database with OpenShift">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec283" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Installing PostgreSQL extensions"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec72" class="calibre1"/>Installing PostgreSQL extensions</h1></div></div></div><p class="calibre6">Extensions <a id="id478" class="calibre1"/>are <a id="id479" class="calibre1"/>add-ons that you can install in a PostgreSQL database to extend the functionality beyond the basic offering. You can find a list of PostgreSQL extensions available on the PostgreSQL Extension Network<a id="id480" class="calibre1"/> website, <a class="calibre1" href="http://www.pgxn.org/">http://www.pgxn.org/</a>. The OpenShift PostgreSQL cartridge comes in a bundle with a list of extensions. These extensions are not installed by default but are available to you if you need them. In this recipe, you will learn how to install an extension in your OpenShift PostgreSQL cartridge.</p></div>

<div class="book" title="Installing PostgreSQL extensions">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec284" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need an application with the PostgreSQL cartridge. Please refer to the <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe in this chapter to learn how to add the PostgreSQL cartridge to your application. </p></div></div>

<div class="book" title="Installing PostgreSQL extensions">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec285" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to install an extension:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a new command-line terminal, and SSH into the application gear using the <code class="email">rhc ssh</code> command. Once logged in, run the psql command-line utility to connect with the PostgreSQL cartridge.</li><li class="listitem" value="2">From inside the psql shell, run the following command to view all the available extensions:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7"># select * from pg_available_extensions;</strong></span>
</pre></div></li><li class="listitem" value="3">Next, install the <code class="email">fuzzystrmatch</code> extension by executing the following SQL command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7"># create extension fuzzystrmatch;</strong></span>
</pre></div></li><li class="listitem" value="4">You can view all the installed extensions by running the <code class="email">\dx</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">#\dx </strong></span>
<span class="strong"><strong class="calibre7">                                List of installed extensions</strong></span>
<span class="strong"><strong class="calibre7">     Name      | Version |   Schema   |                     Description                     </strong></span>
<span class="strong"><strong class="calibre7">---------------+---------+------------+-----------------------------------------------------</strong></span>
<span class="strong"><strong class="calibre7"> fuzzystrmatch | 1.0     | public     | determine similarities and distance between strings</strong></span>
<span class="strong"><strong class="calibre7"> plpgsql       | 1.0     | pg_catalog | PL/pgSQL procedural language</strong></span>
<span class="strong"><strong class="calibre7">(2 rows)</strong></span>
</pre></div></li><li class="listitem" value="5">You can remove the extension from your psql cartridge by running the following SQL command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7"># drop extension fuzzystrmatch;</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Installing PostgreSQL extensions">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec286" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">Every OpenShift<a id="id481" class="calibre1"/> PostgreSQL cartridge has access to a list of<a id="id482" class="calibre1"/> extensions. These extensions are not installed by default, as not all the applications need these extensions. To view all the available extensions, you can use the <code class="email">select * from pg_available_extensions</code> SQL command as shown in step 2. At the time of writing this book, the PostgreSQL cartridge is prepackaged with 51 extensions. These extensions can be installed by running the <code class="email">CREATE EXTENSION SQL</code> command as shown in step 2. The <code class="email">CREATE EXTENSION</code> command compiles and installs the extension. In step 3, you installed the <code class="email">fuzzystrmatch</code> extension. </p><p class="calibre6">The <code class="email">fuzzystrmatch</code> extension provides several functions to determine similarities and differences between strings. To view the details of the <code class="email">fuzzystrmatch</code> extension, you can run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">\dx+ fuzzystrmatch</strong></span>
<span class="strong"><strong class="calibre7">                    Objects in extension "fuzzystrmatch"</strong></span>
<span class="strong"><strong class="calibre7">                             Object Description                             </strong></span>
<span class="strong"><strong class="calibre7">----------------------------------------------------------------------------</strong></span>
<span class="strong"><strong class="calibre7"> function difference(text,text)</strong></span>
<span class="strong"><strong class="calibre7"> function dmetaphone_alt(text)</strong></span>
<span class="strong"><strong class="calibre7"> function dmetaphone(text)</strong></span>
<span class="strong"><strong class="calibre7"> function levenshtein_less_equal(text,text,integer)</strong></span>
<span class="strong"><strong class="calibre7"> function levenshtein_less_equal(text,text,integer,integer,integer,integer)</strong></span>
<span class="strong"><strong class="calibre7"> function levenshtein(text,text)</strong></span>
<span class="strong"><strong class="calibre7"> function levenshtein(text,text,integer,integer,integer)</strong></span>
<span class="strong"><strong class="calibre7"> function metaphone(text,integer)</strong></span>
<span class="strong"><strong class="calibre7"> function soundex(text)</strong></span>
<span class="strong"><strong class="calibre7"> function text_soundex(text)</strong></span>
<span class="strong"><strong class="calibre7">(10 rows)</strong></span>
<span class="strong"><strong class="calibre7">To find the levenshtein distance between Hello and Hallo, you can run command shown below.</strong></span>
<span class="strong"><strong class="calibre7">select levenshtein('Hello','Hallo');</strong></span>
<span class="strong"><strong class="calibre7"> levenshtein </strong></span>
<span class="strong"><strong class="calibre7">-------------</strong></span>
<span class="strong"><strong class="calibre7">           1</strong></span>
<span class="strong"><strong class="calibre7">(1 row)</strong></span>
</pre></div><p class="calibre6">You can drop an extension <a id="id483" class="calibre1"/>using the <code class="email">DROP EXTENSION</code> command.</p></div></div>

<div class="book" title="Installing PostgreSQL extensions">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec287" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding the PostgreSQL cartridge to your application</em></span> recipe</li></ul></div></div></div></body></html>