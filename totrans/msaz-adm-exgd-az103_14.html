<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Integrating On-Premise Networks with Azure Virtual Networks</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered the first part of the</span> <span><em>Deploying and Managing Virtual Networks</em></span><span> </span><span>objective</span><span>. We covered virtual networking in Azure, and we covered the basics of virtual networking and configured private and public IP addresses. We also covered VNet peering.</span></p>
<p>This chapter continues with this<em><span> </span></em>objective by covering how to integrate your on-premises network with an Azure virtual network. In this chapter, we are going to focus on VPN connections from your on-premises environment to Azure and from Azure to Azure as well. <span>You will learn how to </span>create an Azure VPN gateway, and you will learn how to configure a <strong>Site-to-Site</strong> (<strong>S2S</strong>) VPN using an on-premises server and the Azure VPN gateway. At the end of this chapter, we are going to look at a VNet-to-VNet connection and how this is similar to a <span>S2S VPN</span>.</p>
<p><span>The following topics will be covered in this chapter:</span></p>
<ul>
<li>Azure VPN gateway</li>
<li>Creating and configuring an Azure VPN gateway</li>
<li>Creating and configuring a S2S VPN</li>
<li>Verifying on-premises connectivity</li>
<li>VNet-to-VNet</li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p><span>This chapter uses Azure PowerShell for the examples:</span><span> <a href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0">https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0</a>.<a href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0"/></span></p>
<p class="mce-root">The source code for this chapter can be downloaded from the following GitHub link <a href="https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter10">https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter10</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Azure VPN gateway</h1>
                </header>
            
            <article>
                
<p>Azure VPN provides a secure gateway that can be used for sending encrypted traffic <span>over the internet,</span> between an Azure virtual network and an on-premises location. This gateway can be used for sending encrypted traffic between different Azure virtual networks and the Microsoft networks as well. </p>
<p>For each virtual network, you can only have one VPN gateway. You can, however, create multiple connections to the same VPN gateway. When creating multiple connections, all of the VPN tunnels will share the available gateway bandwidth.</p>
<p>A <strong>virtual network gateway</strong> is created with two or more virtual machines that are deployed in a<span> </span><span><strong>gateway subnet</strong>. This is a </span>specific subnet that is created for the VPN connection. The VMs that are deployed in the gateway subnet are created at the same time the virtual network gateway is created. The VMs are then configured to contain specific gateway services and routing tables to connect to the gateway in Azure. It is not possible to configure the <span>gateway services and routing tables</span> manually. </p>
<p>Azure VPN gateway offers the following pricing tiers:</p>
<ul>
<li><span><strong>Basic</strong>: This tier provides a maximum of 10 S2S/VNet-to-VNet tunnels and a </span>maximum<span> of 128 <strong>Point-to-Site</strong> (<strong>P2S</strong>) connections. The average bandwidth is 100 Mbps.</span></li>
<li><span><strong>VpnGw1</strong>: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and a </span>maximum<span> of 128 P2S connections. The average bandwidth is 650 Mbps.</span></li>
<li><span><strong>VpnGw2</strong>: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and a </span>maximum<span> of 128 P2S connections. The average bandwidth is 1 Gbps.</span></li>
<li><span><strong>VpnGw3</strong>: This tier </span>provides a<span> maximum of 30 S2S/VNet-to-VNet tunnels and a </span>maximum<span> of 128 P2S connections. The average bandwidth is 1.25 Gbps.</span></li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">S2S VPNs</h1>
                </header>
            
            <article>
                
<p>An S2S VPN <span>gateway connection is a connection over an IPsec/IKE (IKEv1 or IKEv2) VPN tunnel. These connections can be used for hybrid configurations and cross-premises configurations. It is designed to create a secure connection between a location and your virtual network over the internet. The location can be an office, for instance. Once the S2S VPN connection is configured, you can connect from every device from that location to Azure using the same VPN location. </span></p>
<p>An S2S connection requires a compatible VPN device located on-premises that has a public IP address assigned to it. It should not be located behind a NAT.</p>
<div class="packt_infobox">For more information about the compatible VPN devices, you can refer to the following documentation: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#s2s">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#s2s</a>.</div>
<p>The following diagram shows a S2S VPN connection from an on-premises environment to Azure:</p>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><img src="assets/1b2cc700-4bb7-475c-8350-a5dc721144d2.png"/><br/>
<br/>
S2S VPN<br/>
<br/></span></div>
<p>In the next section, we are going to look at <strong>multi-site VPNs</strong>.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Multi-site VPNs</h1>
                </header>
            
            <article>
                
<p>A multi-site VPN is a variation of the S2S connection. You use this type of connection for connecting to multiple on-premises sites from your virtual network gateway. It is required that multi-site connections use a route-based VPN type gateway. All connections through the gateway will share the available bandwidth. This is because each virtual network can only have one VPN gateway.</p>
<p>The following diagram shows a multi-site VPN connection from an on-premises environment to Azure:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/9034c6db-05bf-4ff6-8ec6-7d3d57d9a899.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Multi-site VPN</span></div>
<p><span>In the next section, we are going to look at the <strong>Point-to-Site</strong> (</span><strong>P2S</strong>)<span> VPN.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">P2S VPNs</h1>
                </header>
            
            <article>
                
<p>A P2S VPN gateway connection <span>is designed to create a secure connection between an individual client and your virtual network over the internet. It is established from the client computer and is useful for people who are working from different locations, such as from their home or from a hotel. PS2 VPN is also the best solution if you only have a few clients to connect to a virtual network. </span></p>
<p>A P2S connection does not require an on-premises, public-facing IP address such as S2S VPN connections do. You can use P2S connections together with S2S connections over the same VPN gateway. You need to make sure that the configuration requirements for both connections are compatible so that you can use<span> both connection </span><span>types over the same gateway</span><span>.</span></p>
<p>The following diagram shows a <span>P2S VPN connection from an on-premises environment to Azure:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/07bc981e-05d3-48d6-8d93-6fffc276abbe.png"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">P2S VPN</div>
<p><span>In the next section, we are going to look at <strong>ExpressRoute</strong></span><span>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">ExpressRoute</h1>
                </header>
            
            <article>
                
<p>ExpressRoute offers a private connection that is facilitated by a connectivity provider. ExpressRoute connections don't go over the public internet, but they use a more reliable connection. These types of connections offer lower latencies, higher security, and faster speeds than connections that go over the internet. You can use it to extend your on-premises networks to Azure and Office 365. Connections can be made from an any-to-any (IP VPN) network, a virtual cross-connection<span> </span><span>at a co-location facility, and </span>a point-to-point Ethernet network connection.</p>
<p>ExpressRoute uses a virtual network gateway, which is configured with a gateway type of<span> </span><kbd>ExpressRoute</kbd> instead of<span> </span><kbd>VPN</kbd>. By default, the traffic is not encrypted, but you can create a solution that encrypts the traffic that goes over the ExpressRoute circuit.</p>
<p><span>The following diagram shows an ExpressRoute</span><span> connection from an on-premises environment to Azure:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0f82ccc5-5296-4fec-9194-37e21669b988.png"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>ExpressRoute</span></div>
<p><span>Now that we have looked at the different types of VPN connections you can configure, we are now going to create and configure an Azure VPN gateway</span><span>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating and configuring an Azure VPN gateway</h1>
                </header>
            
            <article>
                
<p>In the upcoming sections, we are going to configure an Azure VPN gateway, configure a S2S VPN, and verify the connectivity between Azure and the on-premises environment.</p>
<p>We are going to use Windows Server<span> </span><span>2012 </span>with<span> <strong>Routing and </strong></span><strong>Remote Access Service</strong><span> </span>(<strong>RRAS</strong>) enabled on it to serve as the compatible VPN device that is installed on the on-premises environment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating and configuring the on-premises VPN device</h1>
                </header>
            
            <article>
                
<p>First, we are going to set up Windows Server 2012 and activate RRAS on it to set up the VPN. For this demonstration, I've created a virtual machine on my laptop with Windows Server 2012 R2 installed on it. To enable RRAS, perform the following steps:</p>
<div class="packt_tip">Make sure that the network adapter is set to<span> b</span>ridged mode. The VPN gateway in Azure can't connect to a VPN that is behind a NAT.</div>
<ol>
<li>Go to <span class="packt_screen"><strong>Server Manager</strong></span> | <span class="packt_screen"><strong>Manage</strong></span> | <span class="packt_screen"><strong>Add Roles and Features</strong></span><strong> </strong>to enable RRAS:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/00e075cc-c2f1-4081-a13b-5fd5170396dc.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Enabling RRAS on Windows Server 2012</div>
<ol start="2">
<li>Click <span class="packt_screen"><strong>Next</strong></span><span> </span>on the first screen of the<span> </span><strong><span class="packt_screen">Add Roles and Features Wizard</span></strong>. On the next screen, select<span> </span><strong><span class="packt_screen">Role-based or feature-based installation</span></strong><span> </span>and click <strong><span class="packt_screen">Next</span></strong>.<strong> </strong>Select the server and click <strong><span class="packt_screen">Next</span></strong>.<strong> </strong>On the<span> </span><span class="packt_screen"><strong>Server Roles</strong></span><span> </span>screen, select <strong><span class="packt_screen">Remote Access</span> </strong>and click <strong><span class="packt_screen">Next</span></strong>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/536d74eb-c863-478c-9f76-8b4af1be22ac.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Enabling Remote Access</span></div>
<ol start="3">
<li>On the <span class="packt_screen">Features</span> screen, we can click <span class="packt_screen"><strong>Next</strong></span><span> </span>immediately. On the <strong><span class="packt_screen">Remote Access</span></strong><span> </span>screen, click <strong><span class="packt_screen">Next</span></strong>:<strong><br/></strong></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0763a8e0-88d0-4448-9a44-2ca882c5e984.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Remote Access</span></div>
<ol start="4">
<li class="mce-root">On the<span> </span><strong><span class="packt_screen">Role Services</span></strong><span> </span>screen, select <strong><span class="packt_screen">DirectAccess and VPN (RAS)</span></strong>. A window will pop up asking you to add the required features. Click <strong><span class="packt_screen">Add features</span></strong><span> </span>and then click <strong><span class="packt_screen">Next</span></strong>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/22dabd18-d68c-4c1b-b541-6c2f29257ba8.png"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Role Services</span><strong><br/></strong></div>
<ol start="5">
<li>On the<span> </span><strong><span class="packt_screen">Web Server Role (IIS)</span></strong><span> </span>screen, click <span class="packt_screen">Next</span>.<strong> </strong>On the IIS role services screen, keep all of the default settings as they are and click <span class="packt_screen"><strong>Next</strong></span><span> </span>again. In the last screen, verify the settings and click the <strong><span class="packt_screen">Install </span></strong>button:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9a2a6cd9-da2c-478f-af3e-6191110e34f7.png"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">Confirmation</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The next step is to configure a VNet.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a virtual network</h1>
                </header>
            
            <article>
                
<p>Now that we've gone through the configuration of the on-premises VPN device, we are going to create a VNet. Therefore, perform the following steps:</p>
<ol>
<li>Navigate to the Azure portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li><a href="https://portal.azure.com/">Select <strong><span class="packt_screen">Create a resource</span></strong> and then select <span class="packt_screen"><strong>Networking</strong></span><span> </span>and the next <strong><span class="packt_screen">Virtual network</span></strong>.</a></li>
<li>In the <strong><span class="packt_screen">Create virtual network</span></strong><span> </span>blade, add the following values:
<ul>
<li><strong>Name</strong>: <kbd>PacktVPNVNet</kbd>.</li>
<li><strong>Address space</strong>: <kbd>172.17.0.0/16</kbd>.</li>
<li><strong>Resource group</strong>: Create a new resource group and name it <kbd><span>PacktVPNResourceGroup</span></kbd><span>.</span></li>
<li><strong>Location</strong>:<span> </span><strong>East US</strong>.</li>
<li><strong>Subnet</strong>:<span> </span><strong>Frontend</strong>.</li>
<li class="CDPAlignLeft CDPAlign"><strong>Address range</strong>: <kbd>172.17.0.0/24</kbd>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/02388ce9-017b-4f86-bf34-c0cdc629acff.png" style="width:19.83em;height:48.25em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating the VNet</div>
<ol start="4">
<li>Click <span class="packt_screen">Create</span><span> </span>to create the VNet.</li>
<li>Now we need to create a <strong><span class="packt_screen">Gateway subnet</span></strong> that contains the reserved IP addresses that are used by the virtual network gateway services. Open the VNet resource and under <strong><span class="packt_screen">Settings</span></strong>, click <span class="packt_screen">Subnets</span> and then click<span> </span><strong><span class="packt_screen">+ Gateway subnet</span></strong><span> </span>in the top menu:<strong><br/></strong></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/457d24b0-c3c9-47bb-bc57-9f0dd085c166.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Adding a gateway subnet</span></div>
<ol start="6">
<li>In the<span> </span><span class="packt_screen">Add subnet</span><span> </span>blade, adjust the address range to <kbd>172.17.255.0/27</kbd><span>:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/a8bc0e4b-03b3-42d1-a32e-e76fbc73f8cd.png" style="width:31.67em;height:24.67em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Adjusting the address range</span></div>
<ol start="7">
<li>Click <strong><span class="packt_screen">OK</span></strong>.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an Azure VPN gateway</h1>
                </header>
            
            <article>
                
<p>Now we are going to configure the Azure VPN gateway. Perform the following steps:</p>
<ol>
<li>Navigate to the Azure portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.<a href="https://portal.azure.com/"/></li>
<li>In the left menu, click<span> </span><strong><span class="packt_screen">Create a resource</span></strong><span> </span>and type <kbd>Virtual network gateway</kbd><span> </span>in the search box.</li>
<li>In the <strong><span class="packt_screen">Create virtual network gateway</span></strong>, add the following values:
<ul>
<li><strong>Name</strong>:<span> </span><kbd>PacktVnetGateway</kbd>.</li>
<li><strong>Gateway type</strong>: <span class="packt_screen">VPN</span>.</li>
<li><strong>VPN type</strong>: <span class="packt_screen">Route-based</span>.</li>
<li><strong>SKU</strong>:<span> </span><kbd>VpnGw1</kbd>.</li>
<li><strong>Location</strong>: <span class="packt_screen">East US</span>.</li>
<li><strong>Virtual network</strong>: Click<span> </span><span class="packt_screen"><strong>Virtual network/Choose a virtual</strong><span> </span><strong>network</strong></span>. Select<span> </span><kbd>PacktVPNVNet</kbd>.</li>
<li><strong>Public IP address</strong><span>:</span><span> In here, you set the public IP address that is associated with the VPN gateway. The Azure VPN gateway only supports </span><span><span>dynamically assigned IP addresses.</span></span></li>
</ul>
</li>
</ol>
<p style="padding-left: 120px"><span>However, once the IP address is associated with the VPN gateway, it will not change. The IP address will only change when the VPN gateway is recreated or deleted</span><span>. </span><span>Leave </span><strong><span class="packt_screen">Create new</span></strong><span> selected. Name the IP address </span><kbd>PacktVNetGWIP</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/cff60b07-a331-4c7e-bdbb-0df4b8cd5e01.png" style="width:27.50em;height:46.08em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Gateway settings</span></div>
<ol start="4">
<li> Click <span class="packt_screen"><strong>Create</strong><span> </span></span>to create<span> the Azure VPN gateway.</span></li>
<li> We need the public<span> IP address for the VPN gateway later in this demonstration, so go to the overview of the Azure VPN gateway when it has been created. In there, copy the public IP address to Notepad:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c2673e13-ec62-40df-9547-442d4e1c75a6.png"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Obtaining the public IP address</span></div>
<ol start="6">
<li>After the creation of the gateway, open the<span> </span><strong><span class="packt_screen">Overview</span></strong><span> </span>page of the VNet resource that we created earlier. The VPN gateway is displayed on the <span class="packt_screen">Overview</span> page:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/13a6606f-c768-4237-9f70-fd5791bbe4db.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>VPN gateway in VNet<br/></span></div>
<p>The Azure VPN gateway has been created, so we can now set up the S2S VPN connection with the on-premises environment.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating and configuring S2S VPN</h1>
                </header>
            
            <article>
                
<p>To create the S2S VPN, we are going to connect the VPN gateway with the on-premises environment we created earlier with RRAS enabled on it. This will serve as a compatible VPN device.</p>
<div class="packt_infobox">To be able to complete this step, we need the public IP address of the on-premises environment. I've used VMware for this demonstration and set it up in bridged mode. This way, the public IP address of your provider is used. You can check the public IP address using multiple tools, such as <a href="https://www.whatsmyip.org/">https://www.whatsmyip.org/</a>.</div>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the local network gateway</h1>
                </header>
            
            <article>
                
<p>First, we need to create the local network gateway. This refers to the on-premises location where we have Windows Server 2012 R2 installed with RRAS enabled.</p>
<p>To create the local network gateway, perform the following steps:</p>
<ol>
<li>Navigate to the Azure portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/.</a></li>
<li>In the left menu, click <strong><span class="packt_screen">Create<span> a </span>resource</span></strong><span> </span>and type<span> </span><kbd>Local network gateway</kbd><span> </span>in the search box. Select<span> </span><strong><span class="packt_screen">Local network gateway</span></strong><span> </span>from the list and create a new one.</li>
<li>In the <strong><span class="packt_screen">Create local network gateway</span></strong><span> </span>screen, add the following values:
<ul>
<li><strong>Name</strong>:<span> </span><kbd>PacktOnPremisesGateway</kbd>.</li>
<li><strong>IP address</strong>:<span> Here, you need to fill in the public IP address from the on-premises VPN device where Azure needs to connect to.</span></li>
<li><strong>Address space</strong>:<strong> </strong><kbd>82.173.0.0/16</kbd>. This represents the address ranges for the on-premises network. You can add multiple address ranges.</li>
<li><strong>Configure BGP settings</strong>:<span> D</span>on't select this.</li>
<li><strong>Subscription</strong>:<span> </span>Select the same subscription that was used for the previous examples.</li>
<li><strong>Resource group</strong>:<span> </span>Select the resource group that we already created, that is, <kbd>PacktVPNResourceGroup</kbd>.</li>
<li class="CDPAlignLeft CDPAlign"><strong>Location:</strong><span> Select the same location where the VNet resides, that is, <strong><span class="packt_screen">East US</span></strong></span>:</li>
</ul>
</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/68f14a99-d86f-4fba-8b1a-43d1fa18f3a1.png" style="width:21.75em;height:43.58em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Local network gateway settings<br/>
<br/></span></div>
<ol start="4">
<li>Click <strong><span class="packt_screen">Create</span></strong>.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring the on-premises VPN device</h1>
                </header>
            
            <article>
                
<p>As we described in the previous section, S2S connections require a compatible VPN device. We already configured this in the first step. Now we need to configure this to connect to the Azure VPN gateway. </p>
<p>To configure RRAS so that they can connect to Azure, we need the following artifacts:</p>
<ul>
<li><strong>Shared key</strong>: We are going to create a shared key that is used for connecting to the on-premises device.</li>
<li><strong>The public IP address of the Azure VPN gateway</strong>: This is the public IP address that we copied to Notepad in one of the previous steps.</li>
</ul>
<p>To create a new connection, perform the following steps:</p>
<ol>
<li class="CDPAlignLeft CDPAlign">Open the local gateway that we created previously and under <span class="packt_screen">Settings</span>, select <span class="packt_screen">Connection</span><span class="packt_screen">s</span>. Click the <span class="packt_screen"><strong>Add</strong></span><span> </span>button at the top of the screen:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c5ea17b5-9877-46b6-a0b6-25fcf5be9a8d.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Connections</div>
<ol start="2">
<li>In the <strong><span class="packt_screen">Add connection</span></strong><span> </span>blade, add the following values:
<ul>
<li><strong>Name</strong>:<span> </span><kbd>PacktVNetToSite</kbd>.</li>
<li><strong>Connection type</strong>:<strong> </strong><span class="packt_screen">Site-to-site (IPSec)</span>.</li>
<li><strong>Virtual network gateway</strong>:<span><span> Click <strong><span class="packt_screen">Choose a local network gateway</span></strong> and select <kbd>PacktVNetGateway</kbd>.</span></span></li>
<li><strong>Local network gateway</strong>:<span> This is a fixed value.</span></li>
<li class="CDPAlignLeft CDPAlign"><strong>Shared Key</strong>:<span> This value must be the same as for your local on-premises device. Fill this in with <kbd>Packt123</kbd>:<br/></span></li>
</ul>
</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/64db1ead-6234-406a-a4c5-ec764585f347.png" style="width:21.00em;height:45.67em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Add a connection<br/></span></div>
<ol start="3">
<li>Click <span class="packt_screen"><strong>OK</strong></span><span> </span>to create the connection.</li>
<li class="CDPAlignLeft CDPAlign">After creation, you can select the connection from the <strong><span class="packt_screen">Connections </span></strong>page. From there, you can download the configuration package that can be used to configure the on-premises VPN device. Click <strong><span class="packt_screen">Download configuration</span></strong><span> </span>from the top menu:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b67f01ba-66cb-4b72-b69a-a8203d72cd2f.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Downloading the configuration package</div>
<ol start="5">
<li>Since we are using RRAS, which is part of Windows Server, we need to select the following values:
<ul>
<li><strong>Device vendor</strong>: <span class="packt_screen">Generic Samples.</span></li>
<li><strong>Device family</strong>:<strong> </strong><span class="packt_screen"><span class="packt_screen">Device Parameters.</span></span></li>
<li class="CDPAlignLeft CDPAlign"><strong>Firmware version</strong>:<span> </span><span class="packt_screen">1.0</span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c27d841c-30bc-464c-ba81-83afc9ca2b6f.png"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">Downloading configuration</div>
<ol start="6">
<li>Click<span class="packt_screen"> <strong>Download configuration</strong></span>.</li>
<li>The configuration package consists of a text file with all the necessary configuration values in it.</li>
</ol>
<p>Switch over to the on-premises VM with Windows Server 2012 R2 on it and RRAS enabled. Perform the following steps on the VPN device with the Azure VPN gateway:</p>
<ol>
<li>Download the script from GitHub.<span> </span>This link is provided<span> under the <em>Technical requirements</em> section at the beginning of this</span><span> </span><span>chapter. </span>We are going to use this script to configure RRAS. We need to make some adjustments to the script so that we can add the Azure VPN gateway and local network addresses. You can use the IP address and the subnet address from the downloaded configuration file as input.</li>
</ol>
<ol start="2">
<li>The first part of the script gives some additional information about the script and creates the<span> </span><kbd>Invoke-WindowsApi</kbd><span> </span>function: </li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span># Windows Azure Virtual Network</span><br/><br/><span># This configuration template applies to Microsoft RRAS running on Windows Server 2012 R2.</span><br/><span># It configures an IPSec VPN tunnel connecting your on-premise VPN device with the Azure gateway.</span><br/><br/><span># !!! Please notice that we have the following restrictions in our support for RRAS:</span><br/><span># !!! 1. Only IKEv2 is currently supported</span><br/><span># !!! 2. Only route-based VPN configuration is supported.</span><br/><span># !!! 3. Admin privileges are required in order to run this script</span><br/><br/><span>Function Invoke-WindowsApi( </span><br/><span>    [string] $dllName, </span><br/><span>    [Type] $returnType, </span><br/><span>    [string] $methodName, </span><br/><span>    [Type[]] $parameterTypes, </span><br/><span>    [Object[]] $parameters </span><br/><span>    )</span></pre>
<ol start="3">
<li>In the next part, we are going to build the dynamic assembly and define the method:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span>{</span><br/><span>  ## Begin to build the dynamic assembly </span><br/><span>  $domain = [AppDomain]::CurrentDomain </span><br/><span>  $name = New-Object Reflection.AssemblyName 'PInvokeAssembly' </span><br/><span>  $assembly = $domain.DefineDynamicAssembly($name, 'Run') </span><br/><span>  $module = $assembly.DefineDynamicModule('PInvokeModule') </span><br/><span>  $type = $module.DefineType('PInvokeType', "Public,BeforeFieldInit") </span><br/><br/><span>  $inputParameters = @() </span><br/><br/><span>  for($counter = 1; $counter -le $parameterTypes.Length; $counter++) </span><br/><span>  { </span><br/><span>     $inputParameters += $parameters[$counter - 1] </span><br/><span>  } </span><br/><br/><span>  $method = $type.DefineMethod($methodName, 'Public,HideBySig,Static,PinvokeImpl',$returnType, $parameterTypes)</span></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="4">
<li>Next, we need to apply the<span> </span><kbd>P/Invoke</kbd><span> </span>constructor, thus creating the temporary type and invoking the method:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span> ## Apply the P/Invoke constructor </span><br/><span>  $ctor = [Runtime.InteropServices.DllImportAttribute].GetConstructor([string]) </span><br/><span>  $attr = New-Object Reflection.Emit.CustomAttributeBuilder $ctor, $dllName </span><br/><span>  $method.SetCustomAttribute($attr) </span><br/><br/><span>  ## Create the temporary type, and invoke the method. </span><br/><span>  $realType = $type.CreateType() </span><br/><br/><span>  $ret = $realType.InvokeMember($methodName, 'Public,Static,InvokeMethod', $null, $null, $inputParameters) </span><br/><br/><span>  return $ret</span><br/><span>}</span></pre>
<ol start="5">
<li>Then, we are going to prepare the parameter values and invoke the API:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span>Function Set-PrivateProfileString( </span><br/><span>    $file, </span><br/><span>    $category, </span><br/><span>    $key, </span><br/><span>    $value) </span><br/><span>{</span><br/><span>  ## Prepare the parameter types and parameter values for the Invoke-WindowsApi script </span><br/><span>  $parameterTypes = [string], [string], [string], [string] </span><br/><span>  $parameters = [string] $category, [string] $key, [string] $value, [string] $file </span><br/><br/><span>  ## Invoke the API </span><br/><span>  [void] (Invoke-WindowsApi "kernel32.dll" ([UInt32]) "WritePrivateProfileString" $parameterTypes $parameters)</span><br/><span>}</span></pre>
<ol start="6">
<li>Now we are going to install the RRAS role on the server:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span># Install RRAS role</span><br/><span>Import-Module ServerManager</span><br/><span>Install-WindowsFeature RemoteAccess -IncludeManagementTools</span><br/><span>Add-WindowsFeature -name Routing -IncludeManagementTools</span><br/><br/><span># !!! NOTE: A reboot of the machine might be required here after which the script can be executed again.</span></pre>
<ol start="7">
<li>As we can see, the S2S VPN is installed from here:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span># Install S2S VPN</span><br/><span>Import-Module RemoteAccess</span><br/><span>if ((Get-RemoteAccess).VpnS2SStatus -ne "Installed")</span><br/><span>{</span><br/><span>  Install-RemoteAccess -VpnType VpnS2S</span><br/><span>}</span></pre>
<ol start="8">
<li>Next, we need to add and configure it:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span># Add and configure S2S VPN interface</span><br/><br/><span>Add-VpnS2SInterface `</span><br/><span> -Protocol IKEv2 `</span><br/><span> -AuthenticationMethod PSKOnly `</span><br/><span> -NumberOfTries 3 `</span><br/><span> -ResponderAuthenticationMethod PSKOnly `</span><br/><span> -Name &lt;IP address of your Azure gateway&gt; `</span><br/><span> -Destination &lt;IP address of your Azure gateway&gt; `</span><br/><span> -IPv4Subnet @("&lt;IP range of your subnet in Azure&gt;:100") `</span><br/><span> -SharedSecret &lt;shared key&gt;</span><br/><br/><span>Set-VpnServerIPsecConfiguration `</span><br/><span> -EncryptionType MaximumEncryption</span><br/><br/><span>Set-VpnS2Sinterface `</span><br/><span> -Name &lt;IP address of your Azure gateway&gt; ` </span><br/><span> -InitiateConfigPayload $false ` </span><br/><span> -Force</span></pre>
<ol start="9">
<li>In the last part of the script, we are going to set the connection to be persistent, restart the RRAS server, and dial-in to the Azure gateway:</li>
</ol>
<pre style="padding-left: 90px" class="mce-root"><span># Set S2S VPN connection to be persistent by editing the router.pbk file (required admin privileges)</span><br/><span>Set-PrivateProfileString $env:windir\System32\RRAS\router.pbk "&lt;IP address of your Azure gateway&gt;" "IdleDisconnectSeconds" "0"</span><br/><span>Set-PrivateProfileString $env:windir\System32\RRAS\router.pbk "&lt;IP address of your Azure gateway&gt;" "RedialOnLinkFailure" "1"</span><br/><br/><span># Restart the RRAS service</span><br/><span>Restart-Service RemoteAccess</span><br/><br/><span># Dial-in to Azure gateway</span><br/><span>Connect-VpnS2SInterface ` </span><br/><span> -Name &lt;IP address of your Azure gateway&gt;</span></pre>
<div class="packt_infobox"><span>This script will also enable RRAS on your server. We did this manually in one of the first sections, so we have skipped this part.</span></div>
<p>We have finished configuring the on-premises VPN device. In the next section, we are going to verify on-premises connectivity.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Verifying on-premises connectivity</h1>
                </header>
            
            <article>
                
<p>There are two different ways to verify on-premises connectivity. You can do this using the RRAS console on-premises and in the Azure portal.</p>
<p>To verify the connection using the RRAS console, open Windows search and type <kbd>Remote Access Management</kbd>.<strong> </strong>Then, open the node that is displayed in the following screenshot. As you can see, RRAS is connected with the Azure VPN gateway:</p>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="assets/2fdd16bb-13e4-4977-bb78-4c8fa46c243d.png"/><br/>
<br/>
Verifying the connection in the RRAS console</div>
<p>To verify the connection from the Azure portal, perform the following steps:</p>
<ol>
<li>Navigate to the Azure portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.<a href="https://portal.azure.com/"/></li>
<li class="CDPAlignLeft CDPAlign">Open the <span><kbd>PAcktVnetGateway</kbd> resource and under </span><strong><span class="packt_screen">Settings</span></strong>, <span>select </span><span class="packt_screen">Connections</span>: </li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c2c5131d-2678-46c3-bef7-9d3e203e41d9.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Verifying the connection in the Azure portal</span></div>
<p><span>When you select <strong><span class="packt_screen">Connections</span></strong></span>, <span>you will be able to see that the <kbd>PacktVNetToSite</kbd> connection is connected, as shown in the preceding screenshot.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VNet-to-VNet</h1>
                </header>
            
            <article>
                
<p><span>Configuring a VNet-to-</span>VNet<span> connection is a simple way to connect VNets. Connecting a virtual network to another virtual network is similar to creating a S2S IPSec connection to an on-premises environment. Both the connection types use the Azure VPN gateway. The VPN gateway provides a secure tunnel IPsec/IKE and they communicate in the same way. The difference is in the way the local network gateway is configured.</span></p>
<p>When you create a VNet-to-VNet connection, the local network gateway address space is automatically created and populated. If you update the address space for one VNet, the other VNet automatically routes to the updated address space. This makes it faster and easier to create a VNet-to-VNet connection than a S2S connection.</p>
<div class="packt_tip">To create a VNet-to-VNet connection from the Azure portal, you can refer to the following tutorial: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal</a>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we covered the second part of the <em>Deploying and Managing Virtual Networks </em>objective, by covering how to create and configure an Azure VPN gateway, how to create and configure S2S VPNs, and how to verify on-premises connectivity with Azure.</span></p>
<p><span>In the next chapter, we will continue with the third part of of the <em>Deploying and Managing Virtual Networks </em><em> </em>objective by covering how to monitor and manage networking.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</span></p>
<ol>
<li>ExpressRoute traffic is encrypted by default:
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
<li>Your organization<span> </span><span>has a requirement for employees to connect from locations other than the office. Do you need to set up a </span>P2S VPN connection for this?<br/>
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>
<ol start="3">
<li>When you set up the on-premises VPN device for a S2S connection, your server isn't allowed to be behind a NAT:
<ul>
<li>Yes</li>
<li>No</li>
</ul>
</li>
</ol>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check out the following links for more information about the topics that were covered in this chapter:</span></p>
<ul>
<li><em>Azure VPN Gateway Documentation</em>: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/">https://docs.microsoft.com/en-us/azure/vpn-gateway/</a></li>
<li><em>About Point-to-Site VPN</em>: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about">https://docs.microsoft.com/en-us/azure/vpn-gateway/P2S-about</a></li>
<li><em>Create a Site-to-Site connection in the Azure portal</em>: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-S2S-resource-manager-portal</a></li>
<li><em>Create a VNet with a Site-to-Site VPN connection using PowerShell</em>: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-create-S2S-rm-powershell</a></li>
<li><em>Create a virtual network with a Site-to-Site VPN connection using CLI</em>: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-S2S-resource-manager-cli</a></li>
<li><em>ExpressRoute overview</em>: <a href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction">https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction</a></li>
<li><em>Create and modify an ExpressRoute circuit</em>: <a href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-circuit-portal-resource-manager">https://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-circuit-portal-resource-manager</a></li>
<li><em>Configure a VNet-to-VNet VPN gateway connection by using the Azure portal:</em> <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal</a></li>
</ul>


            </article>

            
        </section>
    </body></html>