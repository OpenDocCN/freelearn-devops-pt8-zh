<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating Identity Life Cycle Management in Azure</h1>
                </header>
            
            <article>
                
<p class="mce-root"><span>Handling the identity life cycle in cloud services is a highly requested topic; in particular, we are concerned about the handling of guest users in the Azure Active Directory, providing access to applications in the cloud and on-premise, including the sharing of information in a typical collaboration scenario. Precisely for this reason, we will discuss many use cases for handling guest users securely in your environment, and we will provide good usability for the users to access applications and data. We will also consider some helpful tools and services to automate your identity life cycle management. For sure, we can only provide a small footprint of ideas and references in this chapter, because there are many tasks and ideas to solve.</span></p>
<p class="mce-root"><span>The chapter will be organized into the following sections:</span></p>
<ul>
<li>Lab environment readiness</li>
<li>Handling the guest user life cycle</li>
<li>Azure services for automation</li>
</ul>
<p>We will be working practically on different topics, so we will need to prepare some prerequisites in our test environment.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Lab environment readiness</h1>
                </header>
            
            <article>
                
<p>For this chapter, we will need a configured second Azure AD with some test users inside. The users need to be licensed with Office 365 E3 or E5 licenses. The tenant and the associated public DNS configuration for the additional custom domain need to be done so that the users can send and receive emails. <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml">Chapter 1</a>, <em>Building and Managing Azure Active Directory</em>, provided you with the required technical references to be ready to use the lab configuration in this chapter. Testing the functionality with the Azure AD application proxy requires that you have finished the steps in <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml">Chapter 1</a>, <em>Building and Managing Azure Active Directory,</em> or in <a href="0cb2c20e-ca96-41ce-b555-24f63e63b9bf.xhtml" target="_blank">Chapter 9</a>, <em>Deploying Additional Applications on Azure AD</em>; specifically, the Kerberos application publishing. We will do the configuration to provide external access to on-premise applications for guest users on the <strong>YD1APP01</strong> virtual machine, as described in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/279ac108-878d-4a89-ada4-051cfdfc061e.png" width="1102" height="772"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Lab environment overview</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>In addition to the infrastructure requirements, we will introduce you to the test user sets for the different invitation flows, to get a better understanding of all of the related identity life cycle tasks. To be clear which user is based on which infrastructure, we have put the following small explanations in place:</p>
<ul>
<li><strong>Marie Lee</strong>: Create in a hybrid cloud Office 365 partner infrastructure/tenant (<kbd>inovit.ch</kbd>)</li>
<li><strong>Jochen Nickel</strong>: Test user in Google; if you don't have one, create one for your tests (Google)</li>
<li><strong>Jenny Green</strong>: Create in a cloud-only Office 365 partner environment (<kbd>yourdomain3.onmicrosoft.com/leano.ch</kbd>)</li>
<li><strong>Don Hall</strong>: Internal user and inviter of the <kbd>yourdomain1.onmicrosoft.com</kbd> tenant (<kbd>inovitdemos.ch</kbd>)</li>
<li><strong>Susi Delgado</strong>: Create an external email account (<kbd>identityplus.ch</kbd>) without Azure AD integration</li>
</ul>
<p>This is summarized in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1996 image-border" src="Images/eeb67fd8-e157-404e-83b5-d1e6a0835422.png" style="width:31.83em;height:21.58em;" width="623" height="423"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Test users for the different Azure B2B scenarios</div>
<p>Now that we have prepared our infrastructure and our test user setup, we can start to handle the guest user life cycle.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Handling the guest user life cycle</h1>
                </header>
            
            <article>
                
<p>In the following section, we will work through the different identity life cycle tasks for guest users. We will organize this section into specific use cases, as follows:</p>
<ul>
<li><strong>Use Case 1</strong>: Exploring the invitation process with different user types</li>
<li><strong>Use Case 2</strong>: Using the Azure AD B2B portal</li>
<li><strong>Use Case 3</strong>: Providing guest user access to on-premise apps</li>
</ul>
<p>Now, we will start with the first use case.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Use Case 1 – Exploring the invitation process with different user types</h1>
                </header>
            
            <article>
                
<p>In the following use case, we will explore the invitation process for different user types. We will use our global administrator to invite the following users:</p>
<ul>
<li>Maria Lee</li>
<li>Jochen Nickel</li>
<li>Jenny Green</li>
<li>Susi Delgado</li>
</ul>
<div class="packt_tip">The usernames need to be replaced with your names.</div>
<p>With the next steps, we will start the configuration:</p>
<ol>
<li>Open the Azure portal, <a href="https://portal.azure.com">https://portal.azure.com</a>, as the global administrator, and navigate to the Azure AD blade.</li>
<li>Navigate to <span class="packt_screen">Users</span> | <span class="packt_screen">All users</span>, as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1998 image-border" src="Images/0a8f53eb-84d5-47b0-936e-d4fbd0f44ebb.png" style="width:80.67em;height:19.92em;" width="1123" height="277"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Guest user creation process in Azure AD portal</div>
<ol start="3">
<li>Click on <span class="packt_screen">New guest user</span> and invite all of the four test guest users, and provide a short personal message, like <kbd>Welcome to the team!</kbd></li>
<li>You can also use a bulk import over a CSV file.</li>
<li>The basic structure of the file needs to be <span>as follows</span>:</li>
</ol>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 25.914%" class="CDPAlignCenter CDPAlign"><strong>Name</strong></td>
<td style="width: 10%" class="CDPAlignCenter CDPAlign"><strong>Invited User EmailAddress</strong></td>
</tr>
<tr>
<td style="width: 25.914%">
<p>Maria Lee</p>
</td>
<td style="width: 10%">maria.lee@inovit.ch</td>
</tr>
<tr>
<td style="width: 25.914%">
<p>Jochen Nickel</p>
</td>
<td style="width: 10%">jochen.nickel@gmail.com</td>
</tr>
<tr>
<td style="width: 25.914%">
<p>Jenny Green</p>
</td>
<td style="width: 10%">jenny.green@leano.ch</td>
</tr>
<tr>
<td style="width: 25.914%">
<p>Susi Delgado</p>
</td>
<td style="width: 10%">susi.delgado@identityplus.ch</td>
</tr>
</tbody>
</table>
<ol start="6">
<li>Afterward, you can run the following commands.</li>
<li>Connect to your Azure AD tenant<span>, as follows</span>:</li>
</ol>
<pre style="padding-left: 60px"><strong>Connect-AzureAD -TenantDomain "YOURDOMAIN1.onmicrosoft.com"</strong></pre>
<ol start="8">
<li>Execute the invitation<span>, as follows</span>:</li>
</ol>
<pre style="padding-left: 60px"><strong>$invitations = import-csv &lt;Path to your invitation CSV file&gt;</strong><br/><strong>$messageInfo = New-Object Microsoft.Open.MSGraph.Model.InvitedUserMessageInfo</strong><br/><strong>$messageInfo.customizedMessageBody = "<span>Welcome to the team!</span>"</strong><br/><strong>foreach ($email in $invitations) </strong><br/><strong> {New-AzureADMSInvitation `</strong><br/><strong> -InvitedUserEmailAddress $email.InvitedUserEmailAddress `</strong><br/><strong> -InvitedUserDisplayName $email.Name `</strong><br/><strong> -InviteRedirectUrl https://myapps.azure.com `</strong><br/><strong> -InvitedUserMessageInfo $messageInfo `</strong><br/><strong> -SendInvitationMessage $true</strong><br/><strong> }</strong></pre>
<p class="mce-root"/>
<ol start="9">
<li>Check the newly created guest users<span>, as follows</span>:</li>
</ol>
<pre style="padding-left: 60px"><strong>Get-AzureADUser -Filter "UserType eq 'Guest'"</strong></pre>
<ol start="10">
<li>Next, we will accept all of the invitations, in the following order:
<ul>
<li>Marie Lee</li>
<li>Jenny Green</li>
<li>Jochen Nickel</li>
<li>Susi Delgado</li>
</ul>
</li>
<li>Log in to every mailbox to accept the invitation (use a different browser or InPrivate sessions).</li>
<li>You should receive a message like this on every account:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2003 image-border" src="Images/903941e4-1c7b-46ce-93b2-ef9501a0e77d.png" style="width:37.92em;height:35.75em;" width="700" height="660"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD guest invitation message</div>
<ol start="13">
<li>Click on <span class="packt_screen">Get Started</span> as Maria, and you will be redirected to the consent of <kbd>YOURDOMAIN1.ONMICROSOFT.COM</kbd><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2006 image-border" src="Images/a351566c-6878-42a6-9309-7bb4db3b79dc.png" style="width:17.42em;height:23.58em;" width="377" height="509"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Permission consent</div>
<p style="padding-left: 60px"><span>This is the default behavior for Azure AD based users, and will be the same with <strong>Jenny Green</strong>.</span></p>
<ol start="14">
<li>Accept the permissions, and you will automatically <span>be </span>signed in to the access panel UI of <kbd>YOURDOMAIN1</kbd><span>, as follows</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2009 image-border" src="Images/f05d48fc-22e4-44bb-bd0a-86c14346ff9b.png" style="width:40.75em;height:14.42em;" width="1019" height="360"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Access Panel UI</div>
<p style="padding-left: 90px">With this process, you will have no preassigned applications and groups.</p>
<ol start="15">
<li>Log out and do the same for Jenny Green, and you will have the same behavior experience.</li>
<li>Next, you will do the same with your Gmail account; in my case, it's <kbd>jochen.nickel@gmail.com</kbd>.</li>
<li>You will notice that you are redirected to <a href="https://login.live.com">https://login.live.com</a>, and you need to log in with your Gmail account credentials<span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2012 image-border" src="Images/4b62445f-61ea-45d2-b491-5494add790df.png" style="width:39.58em;height:30.08em;" width="1054" height="801"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Login experience of the Gmail account to live.com</div>
<p style="padding-left: 90px">This is the typical behavior for Gmail and other federated identity providers to Azure AD.</p>
<ol start="18">
<li>The other steps are the same as for existing Azure AD users.</li>
<li>Log out and run the process for the external non-Azure AD email account (in my case, Susi Delgado<span>) as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2016 image-border" src="Images/1df23a10-749e-41e9-9d51-0ad988390ced.png" style="width:58.83em;height:25.42em;" width="1184" height="513"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Email account behavior for guest invites</div>
<ol start="20">
<li>You will notice that you need to create a Microsoft account, <span>as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2019 image-border" src="Images/cdcce209-6d67-445c-8bc1-d06d176ab320.png" style="width:20.83em;height:24.25em;" width="425" height="494"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Microsoft account setup</div>
<p style="padding-left: 60px" class="mce-root">This is the default behavior if the user doesn't exist in any Azure AD.</p>
<p style="padding-left: 60px" class="mce-root">You will see the following link in the address bar: <a href="https://invitations.microsoft.com/signup?tenant=7709ca2b-3be8-4d92-89d7-dc1e274b4d0e">https://invitations.microsoft.com/signup?tenant=7709ca2b-3be8-4d92-89d7-dc1e274b4d0e</a><a href="https://invitations.microsoft.com/signup?tenant=7709ca2b-3be8-4d92-89d7-dc1e274b4d0e"/></p>
<ol start="21">
<li>You will receive a verification email to your account.</li>
<li>Enter the <span class="packt_screen">verification code</span> and click on <span class="packt_screen">Finish</span><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2023 image-border" src="Images/8b945b12-78d0-4fd8-9e4f-dba123dbe465.png" style="width:23.17em;height:21.00em;" width="395" height="357"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Verification process</div>
<ol start="23">
<li>Accept the consent that appears. Technically, you are now the owner of your own Azure AD tenant.</li>
<li>You can verify this by opening the Azure portal, <a href="https://portal.azure.com">https://portal.azure.com</a>, and logging on as <span class="packt_screen">Susi Delgado</span>.</li>
<li>Navigate to the Azure AD blade and check the existing users<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2027 image-border" src="Images/c4702621-4ce1-4452-a00e-dbbc87924657.png" style="width:80.67em;height:18.17em;" width="941" height="213"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD user management</div>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="26">
<li>Check the custom domains, and you will find that your suffix is mentioned as <span class="packt_screen">Verified</span><span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2033 image-border" src="Images/2669c947-f19b-4a20-a426-4a352c08f295.png" style="width:70.42em;height:11.17em;" width="815" height="130"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Custom domain overview</div>
<p>With the following procedure, you can take over the Azure AD tenant <a href="https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/domains-admin-takeover">https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/domains-admin-takeover</a><a href="https://bit.ly/2R5wkQr">.</a></p>
<p>You will find all guest users with different source types, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2034 image-border" src="Images/3a6fe1a9-8b04-4d4e-9324-ba09f4a069bf.png" style="width:82.33em;height:18.25em;" width="1248" height="277"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD user management—Guest users only filter</div>
<p>To summarize the invitation process up to now: if a user has already managed in a partner Azure AD, there is no special behavior, except for accepting the invitation and the permission consent. A user from Gmail, or any other federated identity provider, will be treated on a special <kbd>live.com</kbd> directory. Furthermore, a user that doesn't already exist on any Azure AD will be created in an unmanaged Azure AD. Be aware that there is no automatic deprovisioning process, and the user will have to use an additional credential set.</p>
<p>With the following configuration switch, you can limit users to accessing the Azure portal. If you run an Azure AD Privileged Identity Management scenario, the following will be not the best option:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2037 image-border" src="Images/b6ffad54-1e7f-44e8-9bc6-cfd3927bb5cd.png" style="width:45.42em;height:11.83em;" width="842" height="220"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Option to restrict Azure AD Portal access</div>
<p>Furthermore, you should reconfigure the default settings for the external collaboration so that guests can't invite other guests, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2039 image-border" src="Images/e1a4868f-5b43-44a6-b0da-96ef5d2650b1.png" style="width:23.00em;height:28.25em;" width="398" height="489"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD guest user handling options</div>
<p>Another useful tip is how to convert a guest user to an internal member. This can be reached with the following cmdlets:</p>
<ol>
<li>Provide global administrator credentials<span>, as follows</span>:</li>
</ol>
<pre style="padding-left: 90px"><strong>Connect-AzureAD</strong></pre>
<ol start="2">
<li>Convert the user<span>, as follows</span>:</li>
</ol>
<pre style="padding-left: 90px"><strong>Get-AzureADUser -SearchString UserPrincipalName@YOURDOMAIN1.COM | Set-AzureADUser -UserType member</strong></pre>
<p>The next important point is to harden the <span class="packt_screen">All users</span> group, if enabled. To do this, take the following steps:</p>
<ol start="1">
<li>You will find the setting under the Azure AD blade | <span class="packt_screen">Groups</span> | <span class="packt_screen">General</span><span>, as shown in the following screenshot:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img style="font-size: 1em;width:77.08em;height:15.33em;" class="alignnone size-full wp-image-2044 image-border" src="Images/d882f77b-1108-4cef-82d9-df4268d9bd90.png" width="896" height="179"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">All users option</div>
<ol start="2">
<li>Do the following hardening configuration on the <span class="packt_screen">All users</span> group:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4613a692-679e-4cf6-b48b-772ce1d1c015.png" style="width:43.50em;height:15.67em;" width="627" height="226"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Dynamic group membership rule for the member user type</div>
<ol start="3">
<li>Build another group with dynamic group membership, like <span class="packt_screen">All Guest Users</span><span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2048 image-border" src="Images/fa633eee-ab8b-4361-b994-b6029fb5bbeb.png" style="width:20.17em;height:16.25em;" width="287" height="232"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Dynamic Group membership rule for guest users</div>
<ol start="4">
<li>You can also enable Azure <strong>multi-factor authentication</strong> (<strong>MFA</strong>) for all guest users to access the Azure portal, <a href="https://portal.microsoft.com">https://portal.microsoft.com</a>.</li>
<li>Navigate to <span class="packt_screen">Conditional Access</span> (Azure AD Premium P2).</li>
<li>Click on <span class="packt_screen">New policy</span><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2050 image-border" src="Images/0890ff06-6cd5-4073-9e6e-a2e8c2dce282.png" style="width:76.42em;height:25.83em;" width="893" height="302"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Conditional Access management policies for Salesforce</div>
<ol start="7">
<li>Define a name and choose <span class="packt_screen">All guest users</span><span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2051 image-border" src="Images/06379a10-d9b7-481b-925e-f438ee5846e5.png" style="width:37.08em;height:15.50em;" width="621" height="259"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Guest user selection</div>
<ol start="8">
<li>Choose the <span class="packt_screen">Microsoft Azure Management</span> application<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2066 image-border" src="Images/6aea908e-3610-4e98-bffe-9cb184050fde.png" style="width:63.67em;height:21.83em;" width="931" height="319"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Protection of the Azure Portal access</div>
<p class="mce-root"/>
<ol start="9">
<li>Under <span class="packt_screen">Access Control</span>, select <span class="packt_screen">Require multi-factor authentication</span><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2070 image-border" src="Images/2bf63fd1-92b3-473e-acfb-7d1f16f30e33.png" style="width:21.75em;height:12.25em;" width="310" height="174"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">MFA requirement</div>
<ol start="10">
<li>Enable the policy.</li>
<li>Test the functionality with one of your guest users.</li>
</ol>
<p>After working through the first processes, we can extend our solution with the Azure AD B2B portal, in order to provide more capabilities.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using the Azure AD B2B portal and use cases</h1>
                </header>
            
            <article>
                
<p>The invitation API provides a lot of capabilities to customize the onboarding workflow for guest users. You can include processes like self-signup, assigning a manager for guest users, an update to the user profile, and an automatic group or application assignment to the guest users. We will use the Microsoft sample project to demonstrate the different capabilities in your environment. You can find the sample project at <a href="https://github.com/Azure/active-directory-dotnet-graphapi-b2bportal-web">https://github.com/Azure/active-directory-dotnet-graphapi-b2bportal-web</a>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installation and configuration</h1>
                </header>
            
            <article>
                
<p>In the beginning, we need to provide two Azure Active Directory applications that will be used to delegate the correct permissions to the Azure B2B sample portal. <span>To do this, take the following steps:</span></p>
<ol>
<li>Navigate to your Azure portal, <a href="https://portal.azure.com">https://portal.azure.com</a>, and the Azure AD blade.</li>
</ol>
<ol start="2">
<li>Click on <span class="packt_screen">Properties</span> and copy the directory ID to a notepad, as follows:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2072 image-border" src="Images/5773ce23-ab7f-4988-9ab5-90615ccf5b73.png" style="width:53.92em;height:5.33em;" width="609" height="61"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Getting directory ID</div>
<ol start="3">
<li>Click on <span class="packt_screen">App registrations</span> and add a new app, like the following:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2121 image-border" src="Images/19d7c03d-3f88-4a17-bf87-9d266dd428c8.png" style="width:21.67em;height:13.58em;" width="286" height="179"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring app properties</div>
<ol start="4">
<li>Click on <span class="packt_screen">Settings</span> on the newly created app.</li>
<li>Navigate to <span class="packt_screen">Required permissions</span>.</li>
<li>Click on <span class="packt_screen">Add</span> and select the <span class="packt_screen">Microsoft Graph</span>.</li>
<li>Click on <span class="packt_screen">Select permissions</span> and enable the following permissions:
<ul>
<li>Application permissions:
<ul>
<li>Read and write directory data</li>
<li>Read and write all users' full profiles</li>
</ul>
</li>
<li>Delegated permissions:
<ul>
<li>Sign in and read user profile<span>, as follows</span>:</li>
</ul>
</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2076 image-border" src="Images/302d2d25-95da-4a97-ad88-19d941611329.png" style="width:80.58em;height:29.42em;" width="1321" height="483"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configuring required permissions</div>
<ol start="8">
<li>After you have added the <span class="packt_screen">Microsoft Graph</span> API and configured the permissions, click on <span class="packt_screen">Grant permissions</span><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2124 image-border" src="Images/3dfef32a-8f12-443b-8556-05fa0b4d9ec1.png" style="width:39.50em;height:14.67em;" width="573" height="213"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Permission granting procedure</div>
<ol start="9">
<li>Navigate to the <span class="packt_screen">Keys</span> section.</li>
<li>Provide a key description and choose expires in 2 years.</li>
</ol>
<ol start="11">
<li>Click on <span class="packt_screen">Save</span> and copy the key value to your notepad<span>, as follows</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2125 image-border" src="Images/c2319a5a-9e74-4a65-a546-52144d37858c.png" style="width:76.67em;height:32.92em;" width="860" height="370"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Key generation</div>
<ol start="12">
<li>Next, copy the <span class="packt_screen">Application ID</span> to your notepad<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2126 image-border" src="Images/e07b25e8-1c2a-4e2e-a830-753e35651d73.png" style="width:22.33em;height:8.75em;" width="325" height="128"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">App ID gathering</div>
<ol start="13">
<li>Now, we can create the second app for the pre-authentication.</li>
</ol>
<ol start="14">
<li>Use the following values:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/e87da190-8ecb-4c19-af66-2dd9cc3e35e6.png" style="width:21.25em;height:16.67em;" width="303" height="238"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Pre-auth app configuration</div>
<ol start="15">
<li>Under <span class="packt_screen">Settings</span> | <span class="packt_screen">Properties</span>, choose <span class="packt_screen">Multi-tenanted</span> as <span class="packt_screen">Yes</span>, as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2128 image-border" src="Images/6cc188db-6b77-4313-a1be-a98a05c0f80f.png" style="width:23.17em;height:11.00em;" width="290" height="138"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Multi-tenant option enabled</div>
<ol start="16">
<li>Click on <span class="packt_screen">Required permissions</span> and add the <span class="packt_screen">Microsoft Graph</span> API.</li>
<li>Assign the following permissions:
<ul>
<li>
<p><strong>Delegated permissions</strong>: Sign in and read user profile</p>
</li>
</ul>
</li>
<li>Don't forget to press the <span class="packt_screen">Grant permissio</span><span class="packt_screen">ns</span> button.</li>
<li>Next, we need to generate an app key, like we did for the first app.</li>
<li>Copy the key value to your notepad.</li>
<li>Copy the <span class="packt_screen">Application ID</span> to your notepad.</li>
</ol>
<ol start="22">
<li>Click on <span class="packt_screen">Manifest</span><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2129 image-border" src="Images/33a5e277-d38f-4fb0-b2be-890000b5cd35.png" style="width:39.00em;height:15.92em;" width="579" height="236"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">App manifest configuration options for advanced topics</div>
<ol start="23">
<li>We need to change the <span class="packt_screen">oauth2AllowImplicitFlow</span> value to <kbd>true</kbd><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2130 image-border" src="Images/6b8f05ca-7fe2-4365-b0b5-35b7c48f1e78.png" style="width:20.08em;height:7.25em;" width="323" height="116"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">OAuth flow option</div>
<ol start="24">
<li>Now, we can start to deploy our web application to Azure.</li>
<li>Click on <span class="packt_screen">Deploy to Azure</span><span>, as follows:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2135 image-border" src="Images/fdc4d78e-6c7d-403b-9125-35e3413fa540.png" style="width:33.33em;height:9.83em;" width="907" height="267"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Example of portal deployment to Azure</div>
<ol start="26">
<li>Use the values from your notepad and fill, them in as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/629eff8c-5db3-4efe-9f6f-ce0d02c6eb3a.png" width="1131" height="858"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2B portal deployment options</div>
<ol start="27">
<li>Wait until the deployment process is done.</li>
<li>Navigate to the <span class="packt_screen">App Service</span> section on the Azure portal.</li>
</ol>
<ol start="29">
<li>Copy the URL to your <span class="packt_screen">B2B Portal</span> application<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2137 image-border" src="Images/a6d9f07b-0850-4f56-b36e-9ac801568fd3.png" style="width:107.92em;height:24.25em;" width="1295" height="291"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">App deployment result</div>
<ol start="30">
<li>Edit each of your Azure AD apps and change the Homepage and Reply URL.</li>
</ol>
<p>All done. Now we can start to use the portal and build some example processes.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Usage of the portal</h1>
                </header>
            
            <article>
                
<p>The Azure AD B2B portal provides many processes to show the power of the invitation API. With the first touch on your brand new site, you need to log in and configure the basic parameters. To do this, take the following steps:</p>
<ol>
<li>Open your portal link and l<span>og in to the Azure AD B2B portal with your global administrator credentials, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2139 image-border" src="Images/90c6897a-a703-4319-bf0b-02b3ea7e2cf8.png" style="width:83.00em;height:14.33em;" width="1242" height="215"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2B Portal basic configuration</div>
<p class="mce-root"/>
<ol start="2">
<li>In the next configuration steps, you can configure the corporate identity of the web page, including the communication templates<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2144 image-border" src="Images/b825e111-a14d-466e-b097-5c1540940f2e.png" style="width:69.33em;height:46.50em;" width="1169" height="785"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2B example portal site configuration</div>
<ol start="3">
<li>Enter the site name and the inviting organization, including a short welcome message.</li>
<li>Enter the inviter email address and click on <span class="packt_screen">Save</span>.</li>
<li>Next, we will create three more user accounts in your partner Azure AD tenant, <kbd>yourdomain3.onmicrosoft.com</kbd> (<kbd>leano.ch</kbd>).</li>
</ol>
<ol start="6">
<li>Assign an <strong>Office 365 E3/E5</strong> license to provide a mailbox for the users.</li>
<li>Just name them as follows:
<ul>
<li><kbd>guest.user1@leano.ch</kbd></li>
<li><kbd><span>guest.user2@leano.ch</span></kbd></li>
<li><kbd><span>guest.user3@leano.ch</span></kbd></li>
</ul>
</li>
</ol>
<ol start="8">
<li>Now, we can see the capability of providing custom email templates for the invitation process.</li>
<li>Click on <span class="packt_screen">Admin</span> | <span class="packt_screen">Manage Mail Templates</span>, <span>as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2150 image-border" src="Images/1a2f12ed-53b8-4356-80fe-332acf0e1781.png" style="width:24.17em;height:11.83em;" width="422" height="207"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Admin options</div>
<ol start="10">
<li>A default template is already in place, as demonstrated in the following <span>screenshot</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2151 image-border" src="Images/7a93e974-ba8b-4256-a133-2676757ad9a4.png" style="width:94.67em;height:17.33em;" width="1136" height="208"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Invitation templates configuration</div>
<ol start="11">
<li>Click on <span class="packt_screen">+ New</span> to create an additional template<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2152 image-border" src="Images/23cdae9f-fe09-4303-bf76-e6ebbad06779.png" style="width:72.92em;height:27.67em;" width="946" height="360"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Custom mail templates configuration</div>
<ol start="12">
<li>If you want to use SMTP, your web app needs to have an SMTP server configured.</li>
<li>Click on <span class="packt_screen">Save</span>.</li>
<li>Next, we will see domain management.</li>
<li>In this section, you can configure the main process parts, which are as follows:
<ul>
<li>Defining pre-approved organizations.</li>
<li>Defining the user type, <strong>Guest</strong> or <strong>Member</strong>.</li>
<li>You can use the predefined mail templates, based on the organization.</li>
<li>You can put the invited user directly into the required group<span>, as follows</span>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2153 image-border" src="Images/eb1d6083-f059-480b-b548-5b9bffcc80b2.png" style="width:76.08em;height:40.58em;" width="1138" height="607"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Automatic group assignment and access management options</div>
<ol start="16">
<li>Type the <kbd>yourdomain3.onmicrosoft</kbd> (<kbd>leano.ch</kbd>) organization domain.</li>
<li>Assign the <span class="packt_screen">Kerberos Demo Application Access</span> group to the user.</li>
<li>You will notice that the application can check directly whether the organization is based on Azure AD<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2200 image-border" src="Images/05024f57-cbb9-42e7-82a6-c4823fadd621.png" style="width:18.75em;height:5.17em;" width="270" height="75"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Suffix verification against Azure AD list</div>
<ol start="19">
<li>Click on <span class="packt_screen">Save</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2154 image-border" src="Images/4f6dd474-b437-4c1e-ae0d-954cb10662f5.png" style="width:79.17em;height:14.50em;" width="1133" height="209"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Pre-approved domain configuration</div>
<ol start="20">
<li>Now, we can test the functionality with our first guest user.</li>
<li>Open the B2B portal<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2155 image-border" src="Images/f4677a3a-d3a6-45de-982f-b9347b333073.png" style="width:78.75em;height:31.25em;" width="1397" height="555"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2B example app sign-up page</div>
<ol start="22">
<li>Sign up with <kbd>guest.user1@leano.ch</kbd>, and click on <span class="packt_screen">Request Access</span>.</li>
<li>You will receive the following message to identify your request:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2156 image-border" src="Images/9db5e626-5775-4c54-a329-09d7af11e0c1.png" style="width:35.58em;height:7.83em;" width="747" height="164"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Sign up, including the request ID</div>
<ol start="24">
<li>Next, log in to the B2B portal as an administrator.</li>
<li>You will see the request from the user<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2157 image-border" src="Images/6a74187a-0af6-429e-9291-298c3ba972b7.png" style="width:71.50em;height:17.00em;" width="1137" height="271"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Guest approval process</div>
<ol start="26">
<li>The guest user has not yet been created in the organization.</li>
<li>Approve the request and save<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2158 image-border" src="Images/7b142681-4b19-4825-afff-cb1e1501c2e6.png" style="width:26.83em;height:3.25em;" width="434" height="53"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Request approval</div>
<ol start="28">
<li>Log in to <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a> as <span class="packt_screen">Guest</span> <span class="packt_screen">User1</span>.</li>
<li>You should get the notification about the invite, and you can perform the onboarding process.</li>
<li>If a user is invited but didn't accept the invitation, the guest user will be in the following state:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2159 image-border" src="Images/b0194425-e3b4-4bb3-8963-3757ee0226b3.png" style="width:33.33em;height:6.50em;" width="497" height="97"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">User type and state</div>
<ol start="31">
<li>The state will be changed after the user accepts.</li>
<li>The following should be the expected result.</li>
</ol>
<ol start="33">
<li>The user is assigned to the app group<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2160 image-border" src="Images/211c7abe-de04-48d1-82c9-6987d2ea3806.png" style="width:36.42em;height:17.58em;" width="566" height="274"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Group assignment</div>
<ol start="34">
<li>The user is a member of the organization. Click on his user icon in <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a><span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2161 image-border" src="Images/12240265-11ef-4cbc-a569-66ab56827831.png" style="width:16.75em;height:24.25em;" width="371" height="537"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Organization association</div>
<ol start="35">
<li>If you click on the wheel, you will be able to leave the organization (feature related to the General Data Protection Regulations GDPR), as shown in the following <span>screenshot</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2201 image-border" src="Images/1a73c80b-b676-45c1-9ccc-6efa681e7e10.png" style="width:37.25em;height:7.75em;" width="924" height="192"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Leave organization option</div>
<ol start="36">
<li>And, if you change the organization, the <span class="packt_screen">Kerberos Demo Web Site</span> application should appear, as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2202 image-border" src="Images/46a75375-6bba-4635-ad38-a145b914c7d4.png" style="width:35.08em;height:11.00em;" width="935" height="293"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Assigned applications on the Azure AD access panel UI</div>
<ol start="37">
<li>For now, if you click on the application, you will receive an error; we will handle this later in this chapter.</li>
<li>You will be a member of the following groups, when you click on <span class="packt_screen">Groups</span><span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2164 image-border" src="Images/2776a077-24da-49c5-b1c4-21183933d9a2.png" style="width:15.00em;height:10.17em;" width="390" height="264"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Group assignment self-service and overview</div>
<ol start="39">
<li>The next process that the B2B portal supports is auto-approval for organizations that you know.</li>
<li>If you decide to delegate the invitation process to an internal or external employee over the Azure AD portal or the B2B portal, you can use the Azure AD PIM AD <span class="packt_screen">Guest Inviter</span> role<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2165 image-border" src="Images/c6c2fc90-7439-4cee-8f34-08f75bcf521f.png" style="width:82.75em;height:19.25em;" width="1598" height="372"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Delegation of the guest inviter role</div>
<p>During this use case, you have seen the power of the invitation API. You can work around it and build your own scenarios.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Special considerations</h1>
                </header>
            
            <article>
                
<p>In this small section, we will take a look at some special parts of the B2B process. Let's start with the scenario that a user gets married and changes their name, including the email address and the <kbd>userPrincipalName</kbd>. Follow these steps:</p>
<ol>
<li>To view the result, we will do this for <kbd>guest.user1@leano.ch</kbd>.</li>
<li>Open <a href="https://portal.office.com">https://portal.office.com</a> on the <kbd>yourdomain3.onmicrosoft.com</kbd> tenant and select the user<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2166 image-border" src="Images/693e2a12-4b72-423a-99be-b6f97b3bb860.png" style="width:83.17em;height:18.50em;" width="1539" height="342"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Guest user modification options and results</div>
<ol start="3">
<li class="mce-root">Click on <span class="packt_screen">Manage user</span> and call him <kbd>jeff.barnes@leano.ch</kbd>.</li>
<li>Navigate to the <span class="packt_screen">Exchange Admin Center</span>, as follows:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2167 image-border" src="Images/fa713cd2-9c7a-4ecf-8db4-3fad09e43b8d.png" style="width:11.17em;height:15.92em;" width="236" height="335"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Exchange Admin center access</div>
<ol start="5">
<li>Navigate to <span class="packt_screen">Recipients</span> | <span class="packt_screen">Mailboxes.</span></li>
<li>Edit the <span class="packt_screen">Guest User1</span> new <span class="packt_screen">Jeff Barnes</span><span>, with the following expected result</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2168 image-border" src="Images/c5f9b8b1-0b1e-4e1f-9b8e-4bc80132f818.png" style="width:36.17em;height:24.58em;" width="710" height="482"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Email address change for the guest user</div>
<ol start="7">
<li>Go to the <span class="packt_screen">Email address</span>.</li>
<li>Change all of the following to <span class="packt_screen">Jeff Barnes</span><span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2184 image-border" src="Images/778ed0fc-06f4-4413-8c57-c2cd629cd86b.png" style="width:22.42em;height:12.08em;" width="316" height="170"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Changing the user attributes</div>
<ol start="9">
<li>Your user should now look like this in the Azure AD:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2185 image-border" src="Images/e6cf9ba0-f31c-4039-b935-ef665c63540d.png" style="width:101.42em;height:3.83em;" width="1217" height="46"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Result of changes</div>
<ol start="10">
<li>Next, we will test the behavior on <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a> with <span class="packt_screen">Jeff Barnes</span> (<span class="packt_screen">Guest User1</span>).</li>
<li>Your user should look like this:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2186 image-border" src="Images/ac99f22a-4341-4765-8991-295c3ab72025.png" style="width:17.67em;height:11.42em;" width="362" height="235"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Review of the changes in the Azure AD Access Panel UI</div>
<ol start="12">
<li>Now, change to the <kbd>INOVITDEMOS</kbd> organization.</li>
</ol>
<ol start="13">
<li>You should have the same experience as before, because the mapping in the background is done by a GUID.</li>
<li>However, you should notice, as in the following, that the user is still called <span class="packt_screen">Guest User1</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/de506cd4-d218-4a17-a0fb-9fda08c6eb35.png" style="width:27.42em;height:9.08em;" width="544" height="181"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Review of the changes in the Azure AD Access Panel UI (External org)</span></div>
<ol start="15">
<li>There is no synchronization job between the two organizations.</li>
<li>You can change the experience for the user by changing his information<span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2188 image-border" src="Images/c5ec93ae-8be4-41d3-83ee-742089009082.png" style="width:80.33em;height:13.42em;" width="1053" height="176"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Attribute change options</div>
<ol start="17">
<li>There are more things that you should note about guest users, as follows:
<ul>
<li>They can't get Exchange Online licenses</li>
<li>They can't change the tenant in Office 365 (for PIM enabled external supporters, for example)</li>
<li>You can't leave an organization if your sign in is blocked</li>
</ul>
</li>
</ol>
<p>You can read more about the special considerations at <a href="https://docs.microsoft.com/en-us/azure/active-directory/b2b/user-properties">https://docs.microsoft.com/en-us/azure/active-directory/b2b/user-properties</a>, including how you can use access reviews to manage the Azure AD B2B guest users.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">On-premise application access for guest users</h1>
                </header>
            
            <article>
                
<p>In this section, we will illustrate how you can provide on-premise application access for guest users. We have already published the Kerberos Demo Web App through the Azure AD Application Proxy, and you have seen the application in the Azure AD Access Panel UI as a guest user. </p>
<p><span class="fontstyle0">With the integration of the web application proxy and the Azure AD Application Proxy, you will receive the following features and capabilities:</span></p>
<ol>
<li><span class="fontstyle0">End user portal: The Azure Access panel at</span> <a href="https://myapps.microsoft.com"><span class="fontstyle2">https://myapps.microsoft.com</span></a><span class="fontstyle2">.</span><a href="https://myapps.microsoft.com"/></li>
<li><span class="fontstyle0">The Azure AD authentication capabilities are as follows:</span>
<ul>
<li><span class="fontstyle0">Usernames and passwords synced from on-premise AD DS</span></li>
<li><span class="fontstyle0">Federated login to on-premise or other federation servers</span></li>
<li><span class="fontstyle0">MFA</span></li>
<li><span class="fontstyle0">Customized login screen</span></li>
<li><span class="fontstyle0">Authorization based on the user or groups</span></li>
<li>SSO to Office 365, thousands of SaaS applications, and all <span class="fontstyle0">applications integrated with Azure AD.</span></li>
</ul>
</li>
<li>Reports, auditing, and security monitoring are based on big data and machine learning.</li>
<li>All HTTPS traffic is terminated in the cloud, blocking most HTTP-level attacks.</li>
<li>Unauthenticated traffic is filtered in the cloud, and will not arrive on-premise.</li>
<li>There are no incoming connections to the corporate network—<span class="fontstyle0">only outgoing </span>connections to the Azure AD application proxy service.</li>
<li>Internet-facing services are always up to date with the latest security patches and server upgrades.</li>
<li>There is login abnormality detection, reporting, and auditing by Azure AD.</li>
<li>Providing SSO experience from Azure AD to on-premise applications.</li>
<li>Connectors use the Azure AD token data to impersonate the end user to the backend applications using <strong><span class="fontstyle4">Kerberos Constrained Delegation</span></strong> <span class="fontstyle0">(</span><strong><span class="fontstyle4">KCD</span></strong><span class="fontstyle0">).</span></li>
<li>There is support for any application that uses <span class="fontstyle4"><strong>Integrated Windows Authentication</strong> </span>(<strong><span class="fontstyle4">IWA</span></strong><span class="fontstyle0">), such as SharePoint, Outlook Web Access, and Microsoft Dynamics CRM.</span></li>
</ol>
<ol start="12">
<li>There is no need to change the backend applications.</li>
<li>There is no need to install agents on backend applications.</li>
<li>There is no need to expose on-premise applications directly to the internet.</li>
</ol>
<p>The following diagram shows the architecture:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2189 image-border" src="Images/df4d5f64-fbb4-4cc2-82c7-67abdd2158f1.png" style="width:76.17em;height:44.17em;" width="1080" height="627"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Application Proxy architecture</div>
<p class="mce-root">In the case of guest user access, the Azure AD application proxy just checks that the <kbd>userPrincipalName</kbd> exists in the on-premise Active Directory.</p>
<p class="mce-root">To configure the access for guest users, we will use the following procedure:</p>
<ol>
<li>Log in to your Domain Controller <strong>YD1ADS01</strong> as a domain administrator.</li>
<li>Open a PowerShell and connect to your <kbd>Azure AD</kbd>, as follows:</li>
</ol>
<pre style="padding-left: 60px"><strong>Connect-AzureAD</strong></pre>
<ol start="3">
<li>Get all guest users<span>, as follows</span>:</li>
</ol>
<pre style="padding-left: 60px"><strong>Get-AzureADUser -Filter "UserType eq 'Guest'"</strong></pre>
<ol start="4">
<li>The following <span>screenshot </span>shows the output:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/482e44d1-67d0-479c-9038-699cb85fa483.png" width="1206" height="182"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">All guest users of the tenant</div>
<ol start="5">
<li>Now, we need to add the <kbd>UPN-suffix @yourdomain1.onmicrosoft.onmicrosoft.com</kbd> to the UPN suffixes of your Active Directory environment.</li>
<li>Use the <kbd>domain.msc</kbd> console for it; right-click on <span class="packt_screen">Active Directory Domains and Trust</span><span class="packt_screen">s</span> and choose <span class="packt_screen">Properties</span>.</li>
<li>Add your suffix<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2191 image-border" src="Images/1198793b-8e4f-4c58-92db-2243236c6a91.png" style="width:54.00em;height:23.92em;" width="630" height="279"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD suffix to UPN suffix assignment</div>
<ol start="8">
<li>Next, we need to create our guest user in our local Active Directory.</li>
<li>Open the console <kbd>dsa.msc</kbd> Active Directory Users and Computers.</li>
<li>Create an <span class="packt_screen">Organizational Unit</span> called <span class="packt_screen">Managed External Business Objects</span><span>, as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2192 image-border" src="Images/c19b5772-0731-49d9-9019-b1d43730a368.png" style="width:17.00em;height:18.08em;" width="274" height="291"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">External objects OU in Active Directory</div>
<ol start="11">
<li>Create the user, as follows:
<ul>
<li><kbd>jenny.green_leano.ch#EXT#</kbd></li>
<li><kbd>@181031inovitdemos.onmicrosoft.com</kbd></li>
<li><kbd>BG00001</kbd>:</li>
</ul>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2194 image-border" src="Images/2dd7fd95-c075-4351-a53c-39eca7747af1.png" style="width:27.67em;height:24.08em;" width="432" height="375"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">User properties</div>
<ol start="12">
<li>You don't need to remember the password, because it's not needed.</li>
<li>The Azure AD will authenticate the user.</li>
<li>Now, assign the user to the <strong>Kerberos Demo Web App Access</strong> group in the Azure AD<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2195 image-border" src="Images/21b6be32-fbc9-4ff1-a86a-3aa53eb6402b.png" style="width:77.42em;height:16.00em;" width="1155" height="239"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">App access group members</div>
<ol start="15">
<li>Now, you can test the solution with Jenny Green at <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a>.<a href="https://myapps.microsoft.com"/></li>
<li>Change the organization to <kbd>INOVITDEMOS</kbd>.</li>
<li>Click on the <span class="packt_screen">Kerberos</span> app.</li>
<li>You should see a successful login<span>, as follows</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2196 image-border" src="Images/908aa962-d4ab-4f21-a527-58ff8143b0de.png" style="width:76.00em;height:23.67em;" width="1292" height="403"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Kerberos example web page for guest users</div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>To automate and extend this solution, you can use Microsoft Identity Manager 2016 or the provided PowerShell solution. You can get information about this approach on Azure AD B2B collaboration with <strong>Microsoft Identity Manager </strong>(<strong>MIM</strong>) 2016 SP1, with Azure application proxy, at the following sources:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/microsoft-identity-manager-2016-graph-b2b-scenario#b2b-end-to-end-deployment-example-scenarios">https://docs.microsoft.com/en-us/microsoft-identity-manager/microsoft-identity-manager-2016-graph-b2b-scenario#b2b-end-to-end-deployment-example-scenarios</a></li>
<li><a href="https://bit.ly/2Cz0yWW">https://www.microsoft.com/en-us/download/details.aspx?id=51495</a></li>
</ul>
<p>In this section, we handled various use cases to provide an identity life cycle for guest users. In the next part, we will give some tips on how you can get more comfortable in your environment.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure services for automation</h1>
                </header>
            
            <article>
                
<p>This year, at Microsoft Ignite, Mark Wahl presented a new feature set. This feature set is called Azure AD Identity Governance, which is in private preview. I will give you an idea of the public information.</p>
<p>Identity is the control panel and merges user experience, business needs, and security requirements together. You need to ensure that the correct users get the right access to the correct and required resources at any time. Azure AD Identity Governance is the set of capabilities for this. They enable you to define access policies and monitor your identities. Microsoft is developing a complete suite of governance capabilities for Azure AD, including two powerful new features: <span class="packt_screen">Entitlement management</span> and <span class="packt_screen">My Access</span>.</p>
<p class="mce-root"/>
<p>Admins will be able to create policies for resources, such as groups, apps, and sites, with the upcoming entitlement management. It will provide the automated process of granting access to employees and partners. The <span class="packt_screen">My Access</span> portal gives employees and partners the possibility to request access to these entitlements, including access to request approvals, as shown in the following <span>screenshot</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2197 image-border" src="Images/1b240e3e-f09b-44b4-b7f7-907f9278d5f7.png" style="width:81.75em;height:35.00em;" width="1920" height="822"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure Identity Governance Entitlement management options</div>
<p>First, the resources must be specified and associated with the entitlement. In this example, you see two apps, one user group, and one SharePoint site. You can add more resources. As you can see in the following screenshot, roles are also included in this concept:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2198 image-border" src="Images/40813aee-2c45-44de-892f-4cb44ae70060.png" style="width:82.17em;height:26.08em;" width="1635" height="519"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Resource assignment for entitlements</div>
<p class="mce-root"/>
<p>With the new features, as shown <span>in the following screenshot,</span> you can define entitlement policies to drive your security requirements:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-2199 image-border" src="Images/da404752-f408-48c7-9f5f-0919724a37fc.png" style="width:81.17em;height:40.75em;" width="1631" height="819"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Entitlement policy options</div>
<p>Another fact that you should be aware of is the many different Azure features that provide you with the capabilities to drive your cloud-based identity and access management. We recommend reading the article at <a href="https://bit.ly/2u3LcZG">https://bit.ly/2u3LcZG</a>, regarding the following technologies:</p>
<ul>
<li>Microsoft Flow</li>
<li>Azure Logic Apps</li>
<li>Azure Functions</li>
<li>Azure App Service WebJobs</li>
</ul>
<p class="mce-root">There are already many examples in the community that show the power of these features; some of them are as follows:</p>
<ul>
<li>Martina Grom, with provisioning Office 365 groups with Azure functions: <a href="https://blog.atwork.at/post/2017/10/01/Provisioning-an-Office-365-group-with-an-approval-flow-and-Azure-functions-part-2">https://blog.atwork.at/post/2017/10/01/Provisioning-an-Office-365-group-with-an-approval-flow-and-Azure-functions-part-2</a></li>
<li>Asish Padhy, with the same topic: <a href="https://asishpadhy.com/2018/05/01/automation-and-creation-of-office-365-groups-using-flow-microsoft-graph-and-azure-function-part-1/">https://asishpadhy.com/2018/05/01/automation-and-creation-of-office-365-groups-using-flow-microsoft-graph-and-azure-function-part-1/</a></li>
</ul>
<ul>
<li>Microsoft Docs, with Microsoft Graph bindings for Azure Functions: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-microsoft-graph">https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-microsoft-graph</a></li>
<li>Microsoft, with an <span>introduction to Azure Functions: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview</a></span><a href="https://bit.ly/2RGJJDH"/></li>
</ul>
<p>We highly recommend trying to work with these technologies, because they will be the future of providing implementation to our customers.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>Working through this chapter, you saw how you can build a rich Azure B2B solution with an identity life cycle, including on-premise application access for guests. Furthermore, you also had an excellent introduction to the possible use cases and gaps. We also provided an overview of the upcoming Identity Governance features that Microsoft is developing, and the power that they will bring to the game; for example, there is a resource assignment based on roles and associated policies.</p>
<p>In the next chapter, we will deploy single-tenant and multi-tenant applications to your environment, and will provide an introduction to these concepts.</p>


            </article>

            
        </section>
    </div>



  </body></html>