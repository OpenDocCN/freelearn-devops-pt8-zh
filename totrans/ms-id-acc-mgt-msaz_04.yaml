- en: Exploring Advanced Synchronization Concepts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In current projects and workshops, we often see that administrators or consultants
    find handling the Azure AD Connect synchronization engine difficult, especially
    if the out-of-the-box functionality configured by the wizard doesn't work as expected
    in their scenarios. The chapter will give you all the needed knowledge so that
    you can handle basic and advanced synchronization requirements.
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, we'll discuss advanced synchronization concepts. We'll look
    into the synchronization rules and work with practical situations to provide you
    with the information and practical experience you need to solve common requests
    in your projects or solutions. Furthermore, we explain the declarative provisioning
    and expressions concept and use them directly in real-world examples. Another
    topic in this chapter is the connection to an additional untrusted Active Directory
    forest. Finally, we'll give you an idea of the special considerations you need
    to handle.
  prefs: []
  type: TYPE_NORMAL
- en: 'This chapter is organized into the following topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Understanding declarative provisioning and expressions
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Synchronization rules explained
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Special considerations in advanced synchronization concepts
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We will start with the steps to prepare our lab environment.
  prefs: []
  type: TYPE_NORMAL
- en: Preparing your lab environment
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To work through the guidance provided in this chapter, we need to arrange some
    preparation tasks. You need to provide an additional public DNS suffix (which in
    my case is `azureid.ch`) that represents `YOURDOMAIN2.COM`. We need to add this
    other domain as a custom domain in the first Azure AD tenant (`YOURDOMAIN1.ONMICROSOFT.COM`),
    which we used in [Chapter 2](c0918163-6616-4bdb-aa82-4a65f578d268.xhtml), *Understanding
    Identity Synchronization**:*
  prefs: []
  type: TYPE_NORMAL
- en: 'Use the following steps to start the configuration:'
  prefs: []
  type: TYPE_NORMAL
- en: Open the Azure Portal: [https://portal.azure.com.](https://portal.azure.com)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Navigate to the Azure AD blade.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click Custom domains.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click Add custom domain.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Use your additional domain name:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/8512cad3-370b-474d-bc20-8d6f1ec266b9.png)'
  prefs: []
  type: TYPE_IMG
- en: Adding a custom domain
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure your public DNS to represent the following verification entry:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/3e627533-2e35-4cb6-8997-9e829b0a91ff.png)'
  prefs: []
  type: TYPE_IMG
- en: Custom domain verification
  prefs: []
  type: TYPE_NORMAL
- en: Click Verify.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The following result is expected:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/6a2d0cd5-2ad9-4904-a690-5e35da8c3038.png)'
  prefs: []
  type: TYPE_IMG
- en: Verified domains overview
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows the complete lab environment we''ll use in this
    book:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/d225759d-93f9-4a85-9839-30377eb0178f.png)'
  prefs: []
  type: TYPE_IMG
- en: Lab environment overview
  prefs: []
  type: TYPE_NORMAL
- en: Furthermore, we need to configure a new Active Directory Forest that uses the
    new domain name. Use the preceding specifications to create the virtual machine
    to host the domain controller. Create the same organizational structure and users,
    just like you did for the first Active Directory forest that we used in the [Chapter
    2](c0918163-6616-4bdb-aa82-4a65f578d268.xhtml), *Understanding Identity Synchronization*.
    You'll find all the scripts in this book's code package. Don't worry—we'll do
    the configuration in this chapter to avoid errors in your lab. After preparing
    the lab environment, we can start working through this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: We are focusing on the synchronization process in this chapter to adopt the
    authentication parts you can use the resources from [Chapter 6](1f239a9c-c62a-4e40-ab58-ce78cd87e8be.xhtml),
    *Managing Authentication Protocols*, [Chapter 7](468509fa-856c-411d-abdb-e9a39c266750.xhtml), *Deploying
    Solutions on Azure AD and ADFS*, and [Chapter 8](efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml), *Using
    the Azure AD App Proxy and the Web Application Proxy*.
  prefs: []
  type: TYPE_NORMAL
- en: Understanding declarative provisioning and expressions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The easiest way to explain declarative provisioning is as follows: objects
    are processed from the source connected directory to the target source by evaluating
    how the objects and the associated attributes should be transformed. This is controlled
    by inbound rules from the connector space to the metaverse and outbound rules
    from the metaverse to the connector space. The following diagram gives you an
    overview of all of the components:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/5b481b4a-e626-42bb-8d68-482c634be89a.png)'
  prefs: []
  type: TYPE_IMG
- en: Declarative provisioning options and components overview
  prefs: []
  type: TYPE_NORMAL
- en: 'Declarative provisioning provides the following capabilities:'
  prefs: []
  type: TYPE_NORMAL
- en: The only way to configure the sync engine
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Functions to configure attribute flows
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Precedence is on SRs (not on Connectors)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: MV—deletion rules now use declarative provisioning
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduces parameters, such as `%Domain.Netbios%`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configured through PowerShell
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The attribute-flow expression language can be explained as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Written in **Visual Basic for Applications** (**VBA**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Stricter syntax:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Useful errors for easy troubleshooting
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Strongly-typed for different data types
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Evolved expressions:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`[attributename]`, `%parametername%`'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '`&H` (hexadecimal value)'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Constants—`CRLF`, `True`, `False`, `NULL`
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'It brings the following attribute flow operators into the game:'
  prefs: []
  type: TYPE_NORMAL
- en: '**String concatenate**: `&`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Mathematics**: `+`, `-`, `*`, `/`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Comparison**: `=`, `<`, `>`, `<>`, `<=`, `>=`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Evaluation order**: `( )`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Logical operator**: `&&` (and) `||` (or)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'It also provides a lot of functions for the attribute flow, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **Conversion** | `CBool``CDate``CGuid``ConvertFromBase64``ConvertToBase64``CNum``CRef``CStr``StringFromGuid``StringFromSid`
    | **Math** | `BitAnd``BitOr``RandomNum` |'
  prefs: []
  type: TYPE_TB
- en: '| **Date/time** | `DateAdd``DateFromNum``FormatDateTime``Now``NumFromDate`
    | **Multi-valued** | `Contains` `Count``Item``Join``RemoveDuplicates``Split` |'
  prefs: []
  type: TYPE_TB
- en: '| **Directory** | `DNComponent``DNComponentRev``EscapeDNComponent` | **Program
    flow** | `Error``IIF``Switch` |'
  prefs: []
  type: TYPE_TB
- en: '| **Inspection** | `IsBitSet``IsDate``IsEmpty``IsGuid``IsNull``IsNullOrEmpty``IsNumeric``IsPresent``IsString`
    | **Text** | `GUID``InStr``InStrRev``LCase ``Left``Len``LTrim``Mid``PadLeft ``PadRight ``PCase ``Replace ``ReplaceChars``Right``RTrim``Trim``UCase ``Word`
    |'
  prefs: []
  type: TYPE_TB
- en: In the following section, we'll explain these components in detail to provide
    you with a better understanding.
  prefs: []
  type: TYPE_NORMAL
- en: Synchronization rules explained
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Azure AD Connect uses an extra user interface in the Synchronization Rules
    Editor to manage the synchronization logic. In the following screenshot, you can
    see all of the synchronization rules have been created for your basic configuration.
    Every entry is one synchronization rule. In the Direction dropdown, you can choose
    between two different types: Inbound and Outbound. Practically, we say that the
    Inbound and Outbound synchronization is always viewed from the metaverse perspective.
    In my explanations, I''ll use the inbound synchronization rules because we will
    find the related information there.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following screenshot, we can see the connected Active Directory forest
    (`inovitdemos.ch`) and that it doesn''t have any services, such as Exchange or
    Skype for Business, and no synchronization rules have been created for these services:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/9438d5a8-9150-49f5-b76f-5a848a3837e9.png)'
  prefs: []
  type: TYPE_IMG
- en: Synchronization rules overview—Inbound
  prefs: []
  type: TYPE_NORMAL
- en: 'With the following steps, we will gather more information on the practical
    usage of the tool:'
  prefs: []
  type: TYPE_NORMAL
- en: View this configuration on your YD1ADS01.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on Start and navigate to Azure AD Connect.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Click on Synchronization Rules Editor:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c89b2e4e-e5b7-4ca4-a097-32212203dcd7.png)'
  prefs: []
  type: TYPE_IMG
- en: Start Menu—Synchronization Rules Editor
  prefs: []
  type: TYPE_NORMAL
- en: 'AAD Connect provides several default synchronization rules based on your configuration. The
    templates for these rules can be found under `C:\Program Files\Microsoft Azure
    AD Connect\SynchronizationRulesTemplates` and are XML-based:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8667ee0a-fa52-47cf-a4b6-203b36b6b9af.png)'
  prefs: []
  type: TYPE_IMG
- en: Synchronization rules templates overview
  prefs: []
  type: TYPE_NORMAL
- en: The screenshot of the Synchronization Rules Editor shows the different rules
    and their precedence.
  prefs: []
  type: TYPE_NORMAL
- en: Microsoft always generates the first rule with the number `100` and iterates over
    all connectors. They read the first item in that file (sorted by precedence).
    It has the name of a rule and the criteria for being added. Then, they generate
    the first rule with the number `100` and iterate over all connectors. If there
    are multiple connectors, the `whenCreated` date/time is used as the arbitrator.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following screenshot, we''ll take an in-depth look into a synchronization
    rule:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/deba353b-d27a-43b5-befb-0a3056ed38b2.png)'
  prefs: []
  type: TYPE_IMG
- en: Inbound synchronization rule details
  prefs: []
  type: TYPE_NORMAL
- en: Here, we'll find detailed information about the Connected System for which the
    rule applies. Further details are the object type in the metaverse and the connector
    space of the synchronization engine. As we can see in the preceding example, the
    object type in the connector space is called a user, which represents a user account
    in an Active Directory, for example. The Metaverse Object Type for a user is always
    a person. Under the Link Type, you can choose between Join, StickyJoin, and Provision.
    We already discussed the join and provision option in [Chapter 2](c0918163-6616-4bdb-aa82-4a65f578d268.xhtml),
    *Understanding Identity Synchronization*. The StickyJoin option can be used if
    the provisioning of a new object to the metaverse is prohibited. Furthermore,
    the rule is enabled for password synchronization.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following screenshot, we explore the Scoping filter capabilities. The
    following rule applies only if the user is enabled in the Active Directory. We
    use the userAccountControl attribute to identify the status of the user. This
    screenshot shows us that the value isn''t required to have the bit `2` not set.
    The value for an enabled user in Active Directory is `512`, and `514` for a disabled
    one:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/2d8dab24-4f30-4e0b-91f3-f82ccce63d6b.png)'
  prefs: []
  type: TYPE_IMG
- en: Scoping filter options
  prefs: []
  type: TYPE_NORMAL
- en: 'Within the Scoping filter, we can see that there are groups and clauses that
    can be nested. To apply a rule, all clauses inside a group need to be met. A rule
    has two types of logical operators: the logical OR operator that''s used between
    groups and the logical AND within a group.'
  prefs: []
  type: TYPE_NORMAL
- en: We'll take a closer look at the `Out to AAD—Group Join` rule, which is shown
    in the following screenshot. We can find an example of the different group types
    and how they get handled.
  prefs: []
  type: TYPE_NORMAL
- en: 'The rule shown in the following screenshot regulates how and which groups are
    provisioned to the Azure AD. Also, other attributes will be checked from the rule:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/1dcbf78c-344b-4bfd-b5a7-64332b495526.png)'
  prefs: []
  type: TYPE_IMG
- en: More Scoping filter options
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example, we look into the `In from AD—User Join rule`, where
    we find ms-DS-ConsistencyGuid and objectGuid handling for joining users from the
    connector space to the metaverse. Keep in mind that join rules will only be checked
    once. The link between the connector space and the metaverse object exists until
    the conditions in the synchronization rule will not be achieved. It''s important
    to know that the synchronization engine will show an error when multiple join
    rules want to be applied:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/f9563612-2cf0-4375-9e5a-ff41287fff69.png)'
  prefs: []
  type: TYPE_IMG
- en: Join rules example
  prefs: []
  type: TYPE_NORMAL
- en: For transformations types, such as constant, direct or expression can be used.
    If we use a constant flow, we can write a value directly into the chosen attribute.
    With a direct flow, the attribute from the source system will be used in the target
    attribute. With **Visual Basic for Applications** (**VBA**), we can develop extended
    configurations. The syntax for attributes is the square brackets, such as company
    or department, as shown in the following screenshot. Keep in mind that you need
    to work with case-sensitive functions and attribute names. You can also use nesting
    options in your rules.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following screenshot shows the transformations of the `In from AD—User
    common` rule:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/2f90a56e-4dd0-40e7-a8ff-253c94d10cda.png)'
  prefs: []
  type: TYPE_IMG
- en: Transformation rule example
  prefs: []
  type: TYPE_NORMAL
- en: 'We worked through individual synchronization rules. Sometimes, many synchronization
    rules are applied to one target attribute. The `sourceAnchor` in the following
    screenshot can be used as an example. There, you can see that two rules have been
    applied to the attribute. Now, precedence comes into the game and decides which
    rule will be used. View the following screenshots to follow the explanation:'
  prefs: []
  type: TYPE_NORMAL
- en: '`In from AD—User AccountEnabled`:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/0a571f62-d37a-4246-8ae2-d995a401d0cd.png)'
  prefs: []
  type: TYPE_IMG
- en: Expression example for AccountEnabled
  prefs: []
  type: TYPE_NORMAL
- en: '`In from AD—User Common`:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/e39fb761-ea30-46fd-8f68-77e3b0b6c386.png)'
  prefs: []
  type: TYPE_IMG
- en: Expression example sourceAnchor
  prefs: []
  type: TYPE_NORMAL
- en: In the case of `sourceAnchor`, an enabled account from the connected Active
    Directory will be populated to the Azure AD. If no enabled account is available
    in any connected Active Directory, the `In from AD—User Common` rule applies.
    The default behavior for multiple connected Active Directories is that the `In
    from AD—User Join` rule has the highest precedence. So, the system iterates through
    all connected Active Directories.
  prefs: []
  type: TYPE_NORMAL
- en: Now that we have introduced you to the concepts of declarative provisioning
    and synchronization rules, we'll configure some examples.
  prefs: []
  type: TYPE_NORMAL
- en: Special considerations in advanced synchronization concepts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we'll start using our knowledge in practical examples. First,
    we'll explore some essential functions that can be used out of the box. In some
    environments, you have the requirement that an organization has an **organizational
    unit** (**OU**) filter in place, where all users are included in this OU. But
    now that you need to filter out, this shouldn't be synchronized to the Azure AD.
    Furthermore, we'll integrate a second AD forest and use PowerShell to configure
    the synchronization rules.
  prefs: []
  type: TYPE_NORMAL
- en: Using standard filters to exclude users and groups
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this section, we''ll use the standard filtering options to exclude users
    and groups to be synchronized to the metaverse:'
  prefs: []
  type: TYPE_NORMAL
- en: Log in as domain administrator to your YD1ADS01.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open the Active Directory Users and Computers console (`dsa.msc`).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Be sure that you are in the advanced features view:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/8732c575-25d0-4e3f-a883-8e28a955e2e8.png)'
  prefs: []
  type: TYPE_IMG
- en: Active Directory Users and Computers—Advanced Features option
  prefs: []
  type: TYPE_NORMAL
- en: Choose one of your users and move to the Attribute Editor tab.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Edit the adminDescription attribute and enter `User_NoSync`, where `User_`
    is the important part:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/fc91ea9e-e48a-43cf-bbb9-0f68c3a8b6de.png)'
  prefs: []
  type: TYPE_IMG
- en: adminDescription filtering option
  prefs: []
  type: TYPE_NORMAL
- en: Save your settings and minimize the console.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open the Synchronization Rules Editor.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Edit the rule `In from AD - User Common`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on Scoping filter.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You''ll see a Scoping filter with the following clause:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'The following screenshot shows the configuration to filter users to synchronize
    to Azure AD by filling the `adminDescription` attribute:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/2543e3fc-4fc8-4398-a432-546462a82d91.png)'
  prefs: []
  type: TYPE_IMG
- en: Rule configuration to filter specific users
  prefs: []
  type: TYPE_NORMAL
- en: Click Cancel and minimize the synchronization rules editor.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open the Synchronization Service Manager.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on Connectors and start a delta import on your Active Directory connector.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You''ll get an update in the sync statistics:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c5441614-42b2-477b-9a10-d9e98ccc542f.png)'
  prefs: []
  type: TYPE_IMG
- en: Delta import synchronization statistics
  prefs: []
  type: TYPE_NORMAL
- en: Click on Updates.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You''ll notice add on your modified user account:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/791a8505-b55d-4802-9020-827d0470e5e7.png)'
  prefs: []
  type: TYPE_IMG
- en: adminDescription attribute flow
  prefs: []
  type: TYPE_NORMAL
- en: Click on Preview.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Choose Delta Synchronization.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Click Generate Preview:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/0d4f31d6-5bfe-4ddd-9360-870b9d8b3595.png)'
  prefs: []
  type: TYPE_IMG
- en: Synchronization preview options
  prefs: []
  type: TYPE_NORMAL
- en: 'You''ll see in the result that the Object Deletion Rule was satisfied:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/367cb67f-c54c-4ea3-ada9-dcd78a3bdded.png)'
  prefs: []
  type: TYPE_IMG
- en: Object deletion rule preview
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on Connector Deprovisioning:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/3e9bd5dc-714f-4c35-aa92-110c93e1e35f.png)'
  prefs: []
  type: TYPE_IMG
- en: Connector Deprovisioning preview
  prefs: []
  type: TYPE_NORMAL
- en: The object will be disconnected.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click Close.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click Preview.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Chose Delta synchronization.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Click Commit Preview:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/86dc303a-3f7b-4d38-882e-c84281f6ab33.png)'
  prefs: []
  type: TYPE_IMG
- en: Preview commitment option
  prefs: []
  type: TYPE_NORMAL
- en: 'Open a Metaverse Search:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/ac43bdd8-b0a3-4230-a251-a8dfadc2a90d.png)'
  prefs: []
  type: TYPE_IMG
- en: Metaverse search option
  prefs: []
  type: TYPE_NORMAL
- en: Click Search.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Aaron Painter no longer exists in the Metaverse.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run an Export on the Azure AD connector:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/d697a01a-5f8b-4d83-aa00-d058543afdba.png)'
  prefs: []
  type: TYPE_IMG
- en: Export run profile execution on Azure AD
  prefs: []
  type: TYPE_NORMAL
- en: You'll get a delete in the sync statistics.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Click Deletes:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/4255e4e7-7904-4690-bcb9-4b8df6fc37c1.png)'
  prefs: []
  type: TYPE_IMG
- en: Export Statistics on Azure AD
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on the object GUID:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/45f15b27-7fd1-46c8-a986-a3d7ced59954.png)'
  prefs: []
  type: TYPE_IMG
- en: Connector space validation
  prefs: []
  type: TYPE_NORMAL
- en: Your user will be deleted from the Azure AD.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You'll see Awaiting Export Confirmation.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run delta import on the Azure AD connector.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The object will be deleted in the connector space of the Azure AD connector:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/557f2c74-c994-49c0-89ed-806e5031042a.png)'
  prefs: []
  type: TYPE_IMG
- en: Deletion of the object in the connector space
  prefs: []
  type: TYPE_NORMAL
- en: Run delta sync on the Azure AD connector to finish the change.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open the connector space on the Azure AD connector. You won''t find the preceding
    `CN=`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c4c676cc-954c-47ba-9398-621fab4897ab.png)'
  prefs: []
  type: TYPE_IMG
- en: Connector space search and validation options
  prefs: []
  type: TYPE_NORMAL
- en: 'With this option, you''ve seen that you can filter objects in a filter OU by
    filling the adminDescription attribute with User_NoSync. The same procedure can
    be used to filter groups with `Group_NoSync`, for example. Here, you can find
    the specific `In from AD—Group Common` inbound rule, which is shown in the following
    screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/35772ed6-4700-4766-bc91-4ad29900509b.png)'
  prefs: []
  type: TYPE_IMG
- en: adminDescription usage for groups
  prefs: []
  type: TYPE_NORMAL
- en: In the next example, we'll build a custom rule.
  prefs: []
  type: TYPE_NORMAL
- en: Building a custom rule for filtering
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this example, we''ll build our own rule to filter by a specific department.
    You can use the following procedure in the Synchronization Rules Editor:'
  prefs: []
  type: TYPE_NORMAL
- en: Open the Synchronization Rules Editor.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on Add New Rule and select Inbound.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Configure the Description section:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/fb173fc2-32c5-41b3-90fc-6c85b20d1275.png)'
  prefs: []
  type: TYPE_IMG
- en: Inbound rule creation process
  prefs: []
  type: TYPE_NORMAL
- en: 'Build a Scoping filter:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'The configuration should look like this:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/86d24fcd-d080-4e5c-a290-1920dae3d3d3.png)'
  prefs: []
  type: TYPE_IMG
- en: Scope filtering by department attribute
  prefs: []
  type: TYPE_NORMAL
- en: Leave the Join rules.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Go to Transformations and create a transformation:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'This is shown in the following screenshot:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/b9f82382-29f6-4c97-b45f-5fa86026d9b8.png)'
  prefs: []
  type: TYPE_IMG
- en: Cloud filtering option
  prefs: []
  type: TYPE_NORMAL
- en: 'Save the rule and step through the following run profile steps in the synchronization
    manager:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Delta** **Import**: AD Connector'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Delta Sync**: AD Connector'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Export**: AAD Connector'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Delta Import**: AAD Connector'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Delta Sync**: AAD Connector'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Verify that the human resources users are deleted in your Azure AD.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: With the following example, you can block synchronizing the `thumbnailPhoto`
    with Azure AD. Furthermore, the configuration will also remove other uploaded
    `thumbnailPhotos`.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can use the following PowerShell to configure the scenario:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Connecting Azure AD Connect to the second forest
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that we've seen how the synchronization rules work, we can integrate an
    additional Active Directory forest to our configuration.
  prefs: []
  type: TYPE_NORMAL
- en: 'Perform the following steps and use the mentioned scripts to configure your
    environment:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Create the Demo Org Structure:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Create the Azure AD Connect AD Management Agent service account:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Create the **group managed service account** (**gMSA**) to run the AAD Connect:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: Set the following rights for the AD Management Agent account on the domain level.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Configure the permissions to configure AAD Connect `svcaadcadma`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Replicate Directory Changes
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Replicate Directory Changes All:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/f1bd4fed-5b49-47f0-9bdc-9780377bf0f6.png)'
  prefs: []
  type: TYPE_IMG
- en: Active Directory MA service account permissions
  prefs: []
  type: TYPE_NORMAL
- en: 'Enable the AD `Recycle Bin Feature`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'Create your test users with the following in detailed viewed script:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Import the Active Directory module:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'The script part auto-populates the currently used domain:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'Declare any variables:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'Import the CSV file:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Create users:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Create the email addresses from `userPrincipalName` with the following script:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a DNS forwarder to your other domain, because Active Directory trust
    has been established:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/f5c5b3e3-f8ee-4479-bfb0-25f7316ae2df.png)'
  prefs: []
  type: TYPE_IMG
- en: DNS configuration for additional forests
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the `ms-ds-consistencyGuid` permissions for the `svcaadcadma` service
    account:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Now that we''ve prepared our second Active Directory Forest, we can include
    it in our Azure AD Connect:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Open the Azure AD Configuration wizard on the YD1ADS01 server:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/d4cb4ee6-f653-4587-be93-8d58d7b60574.png)'
  prefs: []
  type: TYPE_IMG
- en: Start Menu–Azure AD Connect
  prefs: []
  type: TYPE_NORMAL
- en: 'Click Configure:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/595f64fc-5de8-4df7-b98d-5fe7dcc357e4.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure AD Connect configuration
  prefs: []
  type: TYPE_NORMAL
- en: 'Click Customize synchronization options:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/8f157f0b-6ffc-470d-add7-5c94e79d240a.png)'
  prefs: []
  type: TYPE_IMG
- en: Synchronization options customization
  prefs: []
  type: TYPE_NORMAL
- en: 'Connect to Azure AD with global administrator rights:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/2eb5d7ff-bf07-43dd-acf8-c47e5fb4219d.png)'
  prefs: []
  type: TYPE_IMG
- en: Providing global administrator credentials for Azure AD connection
  prefs: []
  type: TYPE_NORMAL
- en: 'Connect the second forest:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/f32be88c-eaba-4075-a268-ed6100a7007b.png)'
  prefs: []
  type: TYPE_IMG
- en: Connecting the additional AD forest
  prefs: []
  type: TYPE_NORMAL
- en: 'Use the service account in the other forest to connect:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/84d7704f-8765-4485-8d6f-b1070709de14.png)'
  prefs: []
  type: TYPE_IMG
- en: Using the AD Management Agent service account of the additional forest
  prefs: []
  type: TYPE_NORMAL
- en: 'You should get a second AD that''s valid in your list:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/844b6838-eb87-4f7d-919e-be8f60dabd7a.png)'
  prefs: []
  type: TYPE_IMG
- en: Valid connection overview
  prefs: []
  type: TYPE_NORMAL
- en: 'As we already verified the domain suffixes, our domain suffix is okay to sync:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/935f1c09-7f02-4b38-a483-d03112998e60.png)'
  prefs: []
  type: TYPE_IMG
- en: Sign-in configuration option
  prefs: []
  type: TYPE_NORMAL
- en: 'Filter the OU you want to synchronize:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/8736bdb4-4f0a-4891-b842-2f6910f67085.png)'
  prefs: []
  type: TYPE_IMG
- en: Filtering the related objects
  prefs: []
  type: TYPE_NORMAL
- en: 'Enable the following features to see the extended synchronization options:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/57406061-97da-476f-9660-678a6ac1e0f8.png)'
  prefs: []
  type: TYPE_IMG
- en: Configuration of optional features—app and attribute filtering, password hash
    sync, and extension attributes
  prefs: []
  type: TYPE_NORMAL
- en: 'With this configuration, you can limit the attributes that get synced to Azure
    AD for specific workloads:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/7803efa0-5220-410a-a6f5-435ded822c1f.png)'
  prefs: []
  type: TYPE_IMG
- en: App filtering options
  prefs: []
  type: TYPE_NORMAL
- en: 'Choose which attributes get exported:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/4654b2e7-a7ff-465e-9efe-e518387c5da7.png)'
  prefs: []
  type: TYPE_IMG
- en: extensionAttribute limitations
  prefs: []
  type: TYPE_NORMAL
- en: 'Choose some additional attributes, but keep in mind that not all services will
    get these attributes:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/cd50b7fa-4d21-4776-a9e3-12b8719cd336.png)'
  prefs: []
  type: TYPE_IMG
- en: Directory extension implementation
  prefs: []
  type: TYPE_NORMAL
- en: Never start the synchronization directly—Initial load is always a manual stepping
    process that's used to avoid errors.
  prefs: []
  type: TYPE_NORMAL
- en: 'We''re ready to start the configuration, so click Configure:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/4d3f9211-4557-448d-b07b-18e79c678db7.png)'
  prefs: []
  type: TYPE_IMG
- en: Final configuration step
  prefs: []
  type: TYPE_NORMAL
- en: Close the configuration assistant.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Let''s start stepping through the initial load of the new Active Directory
    forest, so open the Synchronization Service Manager:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/1c684d19-220a-474c-954a-f7cf88a6e2ad.png)'
  prefs: []
  type: TYPE_IMG
- en: Connected directories overview
  prefs: []
  type: TYPE_NORMAL
- en: 'Start the initial load with the following steps—and control every step:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run a full import on all AD Forests
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Run a full import on AAD
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Run a full sync on all AD Forests
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Run a full sync on Azure AD
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Run an Export on AAD
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Run an Export on all AD Forests
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Yeah! We connected our new forest under complete control. Congrats!
  prefs: []
  type: TYPE_NORMAL
- en: The authentication part for this will be described in [Chapter 7](468509fa-856c-411d-abdb-e9a39c266750.xhtml), *Deploying
    Solutions on Azure AD and ADFS*, [Chapter 8](efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml), *Using
    the Azure AD App Proxy and the Web Application Proxy*, and [Chapter 10](6b29475f-7917-49bf-91d4-3024835d0278.xhtml), *Exploring
    Azure AD Identity Services*.
  prefs: []
  type: TYPE_NORMAL
- en: Keep an eye out for the ADFS B2B configuration with a claim's provider trust
    in [Chapter 10](6b29475f-7917-49bf-91d4-3024835d0278.xhtml), *Exploring Azure
    AD Identity Services*.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned about declarative provisioning and how synchronization
    rules work. We explored practical examples to learn how to use standard sync rules
    and how to create our own. You also learned how to use PowerShell to configure
    synchronization rules and block/delete attributes to and in Azure AD. With the
    integration of another untrusted Active Directory, you saw the standard procedure
    to do this and to customize your synchronization options to define precisely what
    should happen in your environment.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we'll show you how to monitor your synchronization solution.
  prefs: []
  type: TYPE_NORMAL
