<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Understanding Identity Synchronization</h1>
                </header>
            
            <article>
                
<p class="mce-root CDPAlignLeft CDPAlign">The main component in a hybrid identity and access management solution is the connectivity between the on-premises <strong>Active Directory</strong> (<strong>AD</strong>)and the <strong>Azure</strong> <strong>Active Directory</strong> <span>(<strong>A</strong></span><strong>AD</strong><span>)</span>, including the related synchronization of objects and attributes. Microsoft tries to make the synchronization process straightforward without administrators needing to have the complete details of the system under the hood.</p>
<p class="mce-root">In this chapter, we'll discuss the essential identity-synchronization scenarios and tools for the successful implementation of a full hybrid identity life cycle management. We'll start with an overview of the <strong>Microsoft Identity Manager</strong> (<strong>MIM</strong>) and the Azure AD Connect tool, and then we can dive into the identity-synchronization scenarios. Afterward, we'll run through the different processes, the AD user account cleanup for a hybrid environment and all the crucial parts and steps of the identity synchronization in Azure AD Connect. The chapter will be rounded up with a lot of practical tips and use cases.</p>
<p>We'll cover the following essential topics:</p>
<ul>
<li>Technology overview</li>
<li>Synchronization scenarios</li>
<li>Synchronization terms and processes</li>
</ul>
<p>In the first section, we start with the technology overview.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technology overview</h1>
                </header>
            
            <article>
                
<p><span>The <strong>Microsoft Identity Manager</strong> (<strong>MIM</strong>) 2016 or other identity management products are typically used to prepare the identities stored in the local Active Directory for cloud synchronization. The Azure AD Connect tool is generally used to synchronize the AD identities to the Azure AD to be used in connected <strong>software as a a service</strong> (<strong>SaaS</strong>) applications or other functionalities. The main advantage that MIM 2016 provides for this solution is to help with domain/forest consolidations, attribute normalization, and complete on-premise identity management with the help of workflows to support your business processes.</span></p>
<p class="mce-root">As you can see in the following diagram, MIM 2016 is also capable of synchronizing identities with the Azure AD. So, you're probably wondering which tool you should use to sync identities with Azure AD.</p>
<p>The short, practical answer for common scenarios is the Azure AD Connect tool because it supports all the provided synchronization functionality of the Microsoft Azure AD.</p>
<p>The following diagram provides a schematic view of the usage scenarios of both tools:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f0979a2b-a13e-4b80-a258-51fd5469010c.png" style="width:81.00em;height:65.50em;" width="1272" height="1028"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Identity synchronization architecture</div>
<p><span>Azure AD Connect doesn't offer an active user write back. You'll find this option is deactivated in the Azure AD Connect configuration. To add this functionality, you can use the MIM Graph API connector like in Azure B2B user management, where you need to write the guest user back to your AD. To view a comparison between the tools, check out</span> <span><em>Hybrid Identity directory integration tools comparison</em> at <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/plan-hybrid-identity-design-considerations-tools-comparison">https://docs.microsoft.com/en-us/azure/active-directory/hybrid/plan-hybrid-identity-design-considerations-tools-comparison</a></span><a href="https://bit.ly/2zXq9Ir"><span>.</span></a></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Microsoft Identity Manager (MIM) 2016</h1>
                </header>
            
            <article>
                
<p>MIM 2016 is the primary identity and access management product of Microsoft that provides all the different server roles and components needed in this field of technology. MIM 2016 is mainly used to provide a sanitized and central identity in on-premise environments. In the context of a hybrid architecture, it plays a crucial role in connecting any repository to manage identities in different repositories. Furthermore, complex identity-management scenarios are provided with this component. This also includes the management of Azure AD and many SaaS applications in today's market, as you can see in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/533279a4-8047-40e1-8247-6a5f0eb8c9fd.png" style="width:27.83em;height:29.08em;" width="516" height="539"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Identity Manager functionality and objects</div>
<p>The following section gives you a short overview of the key components of MIM 2016 to help a solution architect/engineer to identify possible interactions or elements that need to be included in a design blueprint for a suitable solution. We also use some of these components in the provided implementation guides of the book, such as in <a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml">Chapter 8</a>, <em>Using the Azure AD App Proxy and the Web Application Proxy</em><em>,</em> where we implement the Azure AD <strong>business to business</strong> (<strong>B2B</strong>) scenarios.</p>
<p>The following main feature sets are provided by MIM 2016:</p>
<ul>
<li>Identity synchronization including provisioning/deprovisioning</li>
<li>Access request and Access Policy Management</li>
<li>Delegation of administration</li>
<li>Self-service password reset and account unlock</li>
<li>Self-service group management</li>
<li>Role management (RBAC, ABAC, SoD)</li>
<li>Manual managed groups</li>
<li>Manager-based groups</li>
<li>Criteria-based groups (attribute-based access controls)</li>
<li>Time-limited group memberships</li>
<li>Certificate management</li>
<li>Reporting and compliance and Access Certification</li>
</ul>
<p>If you want to use MIM 2016 as your central identity-management system, we highly recommend you take a look at the <strong>Workflow Activity Library</strong> (<strong>WAL</strong>) under <a href="http://microsoft.github.io/MIMWAL/">http://microsoft.github.io/MIMWAL/</a>. Also, the combination of the newly integrated privileged access-management solution in Windows Server 2016 and MIM 2016 provides a very effective way to manage and limit security issues with administrative accounts.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">MIM synchronization service</h1>
                </header>
            
            <article>
                
<p>The MIM synchronization service is the heart of the product. You can import and aggregate data in a central identity store, which is called <strong>metaverse</strong> (<strong>MV</strong>). The service provides a staging zone to compare the connected directory with the metaverse. This staging zone is called the <strong>connector space</strong> (<strong>CS</strong>). The connection to any repository is done over specific connectors, which are also called <strong>management agents</strong> (<strong>MAs</strong>). The synchronization service is also responsible for the data integrity through all connected repositories, including the provisioning and deprovisioning of objects, including their attributes. You can find an overview of the available connectors at <a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/supported-management-agents">https://docs.microsoft.com/en-us/microsoft-identity-manager/supported-management-agents</a>. In case you need a custom connector, MIM provides a development framework to fit your needs.</p>
<p>The following screenshot shows an example of different directories and systems that can be connected:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/377ce317-4559-472e-b97d-45be96bd60c8.png" style="width:50.92em;height:24.50em;" width="783" height="377"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Microsoft Identity Manager Synchronization Service Manager</div>
<p>Refer to the following practical notes:</p>
<ul>
<li><span>MIM synchronization service is a state-based system by default:</span>
<ul>
<li class="CDPAlignLeft CDPAlign">Imported data will be compared with previously imported data; differences indicate modifications in the source</li>
<li class="CDPAlignLeft CDPAlign">Imported data will be compared with previously exported data; no difference indicates a successful export</li>
</ul>
</li>
<li>MIM is not real-time; it uses run cycles that can be configured</li>
</ul>
<p>MIM synchronization can work event-based with a synchronization service extension, as we provide in the following section.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">MIM synchronization service extensions</h1>
                </header>
            
            <article>
                
<p class="mce-root">To extend the functionality of the MIM synchronization service, you could use the <span class="packt_screen">Lithnet AutoSync. </span><span class="packt_screen">Lithnet AutoSync</span> runs as a Windows service in addition to the MIM synchronization service. The service enables you to execute MIM Management Agent run profiles automatically. Furthermore, <span class="packt_screen">Lithnet AutoSync</span> empowers you to perform exports and delta synchronizations <span>automatically</span> if the MIM synchronization engine detects a change. Now you have an event-based and a run-cycle-enabled synchronization engine. <span>The following screenshot shows the configuration on the sync engine that you saw in the preceding screenshot:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5b52466d-f147-4050-b787-b82aedc21300.png" style="width:68.67em;height:20.58em;" width="1171" height="351"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Lithnet Autosync management console</div>
<p>To learn more about the <span class="packt_screen">Lithnet AutoSync</span> tool, check out <a href="https://github.com/lithnet/miis-autosync">https://github.com/lithnet/miis-autosync</a><a href="https://bit.ly/2UMTgXM">.</a></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">MIM service and portal</h1>
                </header>
            
            <article>
                
<p>The MIM service provides all the necessary capabilities for policies and workflows. All objects like groups, users, workflows, requests, and other resources used in MIM are stored as objects in the MIM Service database. These objects can be modified with typical CRUD (<strong>Create</strong>, <strong>Read</strong>, <strong>Update</strong>, <strong>Delete</strong>) operation<span>s</span> requests to the MIM service <strong>Identity-Management</strong> (<strong>IdM</strong>) Platform.</p>
<p class="mce-root">With the MIM portal, users interact with the system by using a web browser. The usage depends on the permissions; users can be granted to do requests, respond to approval requests, cancel existing pending requests, or manage objects in the IdM system:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/e91794b5-89cd-48a3-a436-0430105430bf.png" style="width:67.67em;height:48.67em;" width="1272" height="914"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Microsoft Identity Manager Standard Portal</div>
<p>The default MIM Portal is based on a SharePoint solution and can be highly customized. You can find some example configurations at <a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/reference/mim-portal-customizations">https://docs.microsoft.com/en-us/microsoft-identity-manager/reference/mim-portal-customizations</a>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">MIM service extensions</h1>
                </header>
            
            <article>
                
<p>The Lithnet <strong>Forefront Identity Manager</strong> (<strong>FIM</strong>)/MIM Service REST API is a wrapper for the FIM/MIM Service's <strong>Simple Object Access Protocol</strong> (<strong>SOAP</strong>)/<strong>Windows Communication Foundation</strong> (<strong>WCF</strong>) endpoint, exposing create, update, delete, and search functionalities via a series of standard HTTP calls. The API returns JSON-formatted data, making it compatible with a wide range of platforms and services. By default, MIM doesn't provide a REST API to the MIM Service. With this extension, you can adopt your own functionality to MIM 2016, such as your own portal as we've done, or to interact with Power BI and other technologies to provide custom solutions. For more information about the Lithnet REST API for FIM/MIM Service, visit <a href="https://bit.ly/1PsgEjp">https://github.com/lithnet/resourcemanagement-webservice</a>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">MIM password reset and user account unlock</h1>
                </header>
            
            <article>
                
<p>MIM provides two password-related features that can help you to offer solutions in your on-premises environment:</p>
<ul>
<li><strong>Password synchronization</strong>: Password synchronization to other repositories based on the AD password change or reset</li>
<li><strong>Password and account self-service</strong>: Separate portals to provide a self-service password reset and account-unlock capabilities</li>
</ul>
<p>The following screenshot shows the web-based <span class="packt_screen">Password Reset</span> and <span class="packt_screen">Account Unlock</span> functionality:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/94e00fe5-f7c7-432d-8eaf-7e712d4fcfe5.png" style="width:27.33em;height:16.58em;" width="766" height="465"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Microsoft Identity Manager Self-Service Password Reset dialog</div>
<p>I<span>n particular, if you have older Windows clients, such as Windows 7 or Windows 8/8.1, in your environment, you can provide the</span><span> </span><span class="packt_screen">Password Reset</span><span> </span><span>functionality in the Windows login UI. The <span class="packt_screen">Password Reset</span> functionality in Azure only provides support for Windows 10 clients but delivers more capabilities in the verification options than the MIM solution. </span></p>
<div class="packt_tip">Be aware that MIM 2016 isn't able to provide a password hash synchronization such as Azure AD Connect in a hybrid scenario.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">MIM privileged access management</h1>
                </header>
            
            <article>
                
<p>MIM 2016 provides a <strong>p</strong><strong>rivileged access management</strong> (<strong>PAM</strong>) solution, restricts privileged access within an existing AD environment.</p>
<p>PAM solves the following two targets:</p>
<ul>
<li>You can get back the authority over a compromised AD environment if you provide a separate bastion environment that is more protected from malicious attacks</li>
<li>With the isolation of privileged accounts, you can limit the risk of losing sensible credentials</li>
</ul>
<p>PAM helps to address the following problems:</p>
<ul>
<li>Pass-the-hash and pass-the-ticket attacks</li>
<li>Kerberos compromises or spear phishing</li>
<li>Unauthorized privilege escalations</li>
<li>Other vulnerabilities and attacks</li>
</ul>
<p>The following screenshot shows you the role-activation and user-verifica<span>tion processes on the MIM PAM example portal, which you can customize based on your needs:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a37ad9f6-38ef-4d40-ae87-48213d020b25.png" width="684" height="390"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">MIM privileged access management sample portal</div>
<p>Now that you know a bit about MIM's standard functionality, we'll provide you with an overview of an additional solution we developed with a partner company. Hopefully, it gives you an idea of the possibilities that MIM provides and how they can be expanded.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Additional solution</h1>
                </header>
            
            <article>
                
<p>Based on our many years of experience and successfully implemented projects in the area of Identity and access management, we've decided to map the recurring requirements in our solution that fill the gaps we couldn't fulfill with the MIM standard functionality.</p>
<p>The following five key pillars will be provided by our solution and enable us to implement highly standardized identity and access-management processes that are flexible and customizable:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/fced768f-8e86-4135-8739-e064628a9e82.png" style="width:26.33em;height:26.08em;" width="1280" height="1270"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Inovit Identity solution - building blocks</div>
<p>The main features of <strong>Organizational Management</strong> and the frontend are the following:</p>
<ul>
<li>Supports several cloud scenarios and traditional IT infrastructures</li>
<li>Representation of the organizational structure (parameterization and inheritance)</li>
<li>Management of the organizational structure (manual or synchronized)</li>
<li>Allows you to build efficient, role-based access controls</li>
<li>Enables you to deliver beneficial cost management</li>
<li>User-friendly and highly responsive frontend</li>
<li><strong>Single page application</strong> (<strong>SPA</strong>) architecture</li>
<li>Integrated governance features</li>
<li>No SharePoint installation required</li>
</ul>
<ul>
<li>Highly customizable</li>
<li>Single frontend for on-premises or cloud-only deployment</li>
<li>A clear strategy for future invests</li>
<li>Cloud management</li>
</ul>
<p><span>The following screenshot schematically shows the frontend:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b04b979b-a17b-43c6-8e3d-af8b380c4981.png" width="1471" height="935"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Identity Directory SPA portal</div>
<p>The main features of <strong>User Management</strong> are as follows:</p>
<ul>
<li>Standard processes (onboarding, mutation, offboarding)</li>
<li>Time-limited user accounts</li>
<li>Management of standard and administrative user accounts</li>
<li>Management of Azure B2B accounts</li>
<li>Automatic <kbd>samAccountName</kbd> and user generation</li>
<li>Alignment of UPN, email, and SIP for cloud usage</li>
<li>Password reset and account unlock</li>
</ul>
<p><span>The following screenshot schematically shows the positions and role assignment in the frontend:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9d57138c-6bdf-4562-9b89-7cbbd0a272d8.png" width="1486" height="833"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Identity Director position-based Access Management</div>
<p>The main features of <strong>Access Management</strong> are the following:</p>
<ul>
<li>Position-based, role-based, attribute-based access management</li>
<li>Permissions directly assigned to a user (if required)</li>
<li>Approval and notification workflow support</li>
<li>Administration of privileged accounts</li>
<li>Authorization direct views and reports</li>
<li>Bidirectional interfacing with services such as SharePoint and Microsoft teams</li>
</ul>
<p>The main features of <strong>Service Management</strong> are as follows:</p>
<ul>
<li>Automated and straightforward adaptation of systems and services</li>
<li>Representation of the service catalog</li>
<li>Synchronization-based order units</li>
<li>Workflow-based order units (notification and approvals)</li>
<li>Management of Office 365 and other cloud services</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Cloud deployment based on identity director service</h1>
                </header>
            
            <article>
                
<p>With our Azure-based next-gen SaaS integration, you'll be able to choose where you want to start your implementation, whether on-premises based on MIM or directly in the cloud. There will also be a fully supported transition path to the cloud. On Azure, we use the Identity Director Service with a Cosmos DB backend that provides the same functionality and additional features that you already have with an on-premises MIM platform. The highly responsive frontend won't change for the user.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">On-premises deployment based on MIM 2016</h1>
                </header>
            
            <article>
                
<p>MIM 2016 represents Microsoft's on-premises Identity and Access Management solution. MIM 2016 builds the base platform to our on-premises deployment method. With a robust synchronization framework and many interfaces, such as REST, SOAP, LDAP, SQL, PowerShell and file-based, you can harmonize AD identities for synchronization with Azure AD. The MIM 2016 Service provides a dominant workflow component that works state and event-based to solve the Identity and Access Management requirements of your business. With MIM 2016 in place, you benefit from cloud-ready identities, powerful user self-service, and enhanced security.</p>
<p>Now that we've had a quick look at MIM, and the additional available extensions and solutions for preparing and managing the AD objects, we'll proceed with our connection to the Azure AD.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory Connect</h1>
                </header>
            
            <article>
                
<p>Azure AD Connect is part of the identity bridge to build a hybrid cloud identity and access management. The main purpose of this tool is to synchronize on-premises identities to the cloud and is limited back to the AD. Azure AD Connect is also able to install and configure the whole identity bridge. This means that you can also install and configure your <strong>Active Directory Federation Services </strong>(<strong>ADFS</strong>) infrastructure for federation reasons with this tool or use pass-through authentication combined with seamless <strong>single sign-on </strong>(<strong>SSO</strong>) to provide a modern and comfortable authentication scenario. The tools are also capable of integrating external federation tools, such as PingFederate.</p>
<p>The following screenshot provides you with a schematic overview of the Azure AD Connect components, whose practical usage we'll explain during the chapter:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/69f0142e-84de-4983-aa7d-7c29a5ce01fb.png" style="width:50.75em;height:17.17em;" width="1151" height="389"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect synchronization schema overview including management capabilities</div>
<p>The following terms are used in the preceding figure:</p>
<ul>
<li><span><strong>Connected Data Source (CD)</strong>: A data source that can be represented by a repository, directory, database, or data included in flat files.</span></li>
<li><strong>Management agent or call connector (MA)</strong>: The <strong>management agent</strong> (<strong>MA</strong>) is the connector to a CD and manages the data specific to the connected data source. <span>Currently, AD and Azure AD are the supported MAs, as you can see here</span><span>: <a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/reference/microsoft-identity-manager-2016-connector-version-history">https://docs.microsoft.com/en-us/microsoft-identity-manager/reference/microsoft-identity-manager-2016-connector-version-history</a></span><span>.</span></li>
<li><strong>Connector space</strong> <strong>(CS)</strong>: This represents a storage and staging area. It stores the states that indicates whether a piece of information has changed in the CD. Each CD has its logical sector in the CS.</li>
<li><strong>Metaverse:</strong> The central data store that contains the imported and aggregated identity information from all connected data sources. It provides a global view over all objects and attributes.</li>
<li><strong>Staging: </strong>If you run a staged import operation on an MA, such as Full/Delta Import (Stage Only), the data is imported from the <strong>connected directory</strong> (<strong>CD</strong>) into the CS, but no synchronization rule is applied to it. So, a staged import doesn't affect the metaverse.</li>
</ul>
<ul>
<li><strong>Import:</strong> The process of how objects and attributes from the connected data source will be moved into the connector space, including the associated operations, such as creation, modification, deletion, or verification. The import process can be a full or delta import.</li>
<li><strong>Synchronization: </strong>The process of applying all the configured rules to the staged objects in the connector space. Synchronization can be divided into inbound and outbound processes.</li>
<li><strong>Export: </strong>The process of writing changes that occurred during synchronization from the CS back to the connected data source.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Synchronization scenarios</h1>
                </header>
            
            <article>
                
<p>With the creation of a new Azure AD tenant, the directory information is managed independently from the on-premises AD forest by default. So, basically, a new onboarded user must be created in both directories: the Azure AD and the local AD. Unless you drive a cloud-only company, you always need to synchronize identities from the on-premises AD to the Azure AD tenant you own to provide a single identity. After the synchronization process is in place, Azure AD and AD can be viewed as one unique identity service. The following section provides you with several integration scenarios, including the user sign-in options. We will divide this section into the following situations:</p>
<ul>
<li>Single-forest integration</li>
<li>Multi-forest integration</li>
<li>Multi Azure Active Directory Integration</li>
<li>Azure Active Directory Domain Services Integration</li>
<li>Stretched Active Directory to Azure IaaS</li>
<li>Azure Active Directory B2B Integration</li>
<li>Azure Active Directory and Microsoft Office 365 synchronization</li>
<li>Identity and password hash synchronization including SSO options</li>
<li>Identity synchronization including PingFederate integration</li>
<li>Identity and password hash synchronization including ADFS integration</li>
<li>Azure Active Directory Connect high availability</li>
</ul>
<p>Let's start with the single-forest integration.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Single-forest integration</h1>
                </header>
            
            <article>
                
<p>The single-forest scenario is a commonly used one. A single forest can contain one or multiple domains and a single instance of <strong>Azure AD</strong>. The express settings of <strong>Azure AD Connect</strong> support this scenario. We recommend filtering the objects so that service accounts, computers, or other objects won't be synchronized to the cloud:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/65a104a8-b7a7-4ca0-adee-063d1c84cc5c.png" style="width:28.75em;height:7.83em;" width="664" height="181"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect single-forest integration scenario</div>
<p>Additional <strong>Azure AD Connect</strong> servers connected to the same <strong>Azure AD</strong> aren't supported. Excluded is the high availability option with the <strong>Azure AD Connect</strong> staging mode, which is explained in the section, <em>Azure Active Directory Connect high availability</em>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Multi-forest integration</h1>
                </header>
            
            <article>
                
<p>Larger organizations or distributed organizations have environments with multiple on-premises ADs. They're typically used in account/resource forests or provided through mergers and acquisitions. These rules need to be followed:</p>
<ul>
<li>Users have only one enabled account across all on-premises <strong>Active Directory Forests</strong></li>
<li><kbd>UserPrincipalName</kbd> and Source anchor will be provided from the forest</li>
<li>Users have only one mailbox</li>
<li>Users that have a linked mailbox also have an account in a different forest</li>
<li>There's no need to use <strong>Azure AD Connect</strong> on a domain-joined server</li>
</ul>
<p><span>The following diagram shows the account/resource forest scenario:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7f12531e-9b7b-4d36-9edc-d7af9e3fe73c.png" style="width:25.75em;height:10.92em;" width="661" height="280"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect multi-forest integration scenario</div>
<p>Remember: multiple forests and multiple <strong>Azure AD Connect</strong> tools on one Azure AD aren't supported. The only exception is the usage of a staging server. A staging server can be configured for high-availability scenarios (active/passive). In this scenario, the staging server doesn’t export information to the target system.</p>
<p>If you have multiple forests, a single sync server and the users are represented in one directory and, you choose the option <span class="packt_screen">Users are represented only once across all directories</span>, then each object in every forest is represented once in the <span class="packt_screen">Metaverse</span> and aggregated in the target Azure AD tenant:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/60a04d77-af23-417a-ae7f-16de31fbea10.png" width="1072" height="535"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect multi-forest integration scenario including synchronization mappings</div>
<p>If you have numerous forests full of mesh with optional GALSync, you should use the <span class="packt_screen">User identities exist across multiple directories</span> option.</p>
<p>If you use the mail attribute as matching criteria, the identity objects are joined with the mail attribute.This results in the following behavior—the user with a mailbox in one forest is joined with the contact in any other forest:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/19d44136-6ab7-4f8f-8c82-39ab6808c999.png" width="1112" height="862"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Multi-forest integration scenario (mail attribute mapping)</div>
<p>It's essential that objects are unique across AD forests. If objects are unique across every forest, you're in a good position. With object matching and joining, you can <span><span>provide</span></span> a good state when using cloud services. With the usage of joins, the precedence of synchronization rules also comes into play. If you join two objects based on an email address, and a specific attribute value where Object 1 isn't filled and Object 2 is populated, the value of the attribute (Object 2) will be used. But what if both objects have filled the attribute with different values? This is where precedence comes in.</p>
<div class="packt_quote packt_infobox">Rules with higher precedence are implemented later than lower valued rules.</div>
<p>The precedence will be set at the time of adding the forest to Azure AD Connect. So, if the forest of Object 1 was added before the forest of Object 2, the value of Object 1 will win the game. The preceding diagram shows this scenario.</p>
<p>Other objects are contacts you will find in such scenarios where a <strong>Global Address List</strong> (<strong>GAL</strong>) synchronization was implemented between two forests. Azure AD Connect provides the following default behaviors:</p>
<ul>
<li>If Azure AD contact finds a match of a contact and a user, a join will happen</li>
<li>If there's no user object available, a contact object will be created</li>
<li>If a subsequent user object is found with a match to a contact, a user object will be built in AAD</li>
<li>If you have an account/resource forest scenario and you use the <span><span class="packt_screen">User identities exist across multiple directories</span></span><span> </span><span>option</span></li>
</ul>
<p>If you use the matching criteria of <strong>ObjectSID</strong> and the <strong>msExchangeMasterAccountSID</strong> attribute, the expected results are that the users are disabled in this forest. Furthermore, the mailbox is linked to the account forest. The user will be presented uniquely in the Azure AD:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ecaf964b-9cd4-4ca3-b9ef-52b35cb9004d.png" style="width:63.17em;height:35.25em;" width="1059" height="591"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Account/Resource forest integration scenario</div>
<p class="mce-root">The preceding diagram also shows the Azure AD Connect behavior in a scenario where the AD object will be checked to determine whether it's a linked mailbox before it attempts to match <strong>msExchMasterAccountSID.</strong> This will be done with the <strong>recipientTypeDetails</strong> attribute. A value of <kbd>2</kbd> means that it's a linked mailbox. Keep in mind that disabled user accounts are also synchronized to Azure AD by default. Deactivated accounts are commonly used in exchange-resource forest deployments. The account forest holds the active user account and the resource forest holds the disabled user account. We will discuss rule precedence in <a href="8f401db9-e842-4a9a-8b12-5fdd175df3c0.xhtml" target="_blank">Chapter 3</a>, Exploring advanced synchronization concepts.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Multi-Azure Active Directory Integration</h1>
                </header>
            
            <article>
                
<p>Sometimes you need to have multiple Azure Active Directories, for example if parts of your organization are based in China or you need to follow government regulations. For each Azure AD directory, you'll need one Azure AD Connect installation.</p>
<p>In a single-forest filtering scenario to multiple Azure ADs, the following needs to be done:</p>
<ul>
<li>Azure AD Connect must be configured for filtering</li>
<li>DNS domain registration is only possible in a single Azure AD</li>
<li>UPNs of the users on-premises must use separate namespaces</li>
<li>Federation configuration needs to be customized</li>
<li>One Azure AD directory can enable Exchange hybrid with the on-premises AD</li>
<li>Global Address List synchronization needs to be performed through MIM 2016</li>
<li>Windows 10 devices can only be with one Azure AD tenant</li>
<li>The SSO option with the password hash synchronization and pass-through authentication activated can work only with one Azure AD tenant</li>
<li>Group and device write-back scenarios are possible</li>
</ul>
<p class="mce-root"><span>The following diagram shows the multiple Azure AD situation:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/48e9100d-6fb7-461a-8478-da1f2523d99c.png" style="width:24.92em;height:12.92em;" width="678" height="351"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Connecting multiple Azure AD to one AD forest</div>
<div class="packt_tip">It's unsupported to sync the same user to multiple Azure ADs.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory Domain Services Integration</h1>
                </header>
            
            <article>
                
<p>This service provides the capabilities to use AD Domain Services as a Service in Azure. It delivers two domain controllers with a small footprint of management options. It integrates directly with your Azure AD. It’s an excellent option to move entirely to the cloud with everything you use on-premises. This provides smaller companies with an opportunity to live without a local infrastructure. Just imagine that a main <span>legacy </span><strong>LOB</strong> can now be used in an Azure AD integration scenario and everything will be managed under service conditions:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/279370ae-d2ce-4e9d-a5c0-039bdf64ec92.png" style="width:19.75em;height:15.75em;" width="502" height="397"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Domain Services integration scenario</div>
<p>The solution provides capabilities to support NTLM/Kerberos and LDAP applications. You can also securely expose LDAP in an example for printing solutions. We used this option in <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml">Chapter 1</a>, <em>Building and Managing Azure Active Directory</em>. Note that you need to activate the password-hash sync option in Azure AD Connect, so the user can be successfully synced between Azure AD and the Azure AD Domain Services. Furthermore, you benefit from the following additional features:</p>
<ul>
<li><strong>AD account lockout protection</strong>—Users are locked out for 30 minutes if five invalid passwords are used within 2 minutes. Accounts are automatically unlocked after 30 minutes.</li>
<li><strong>Custom</strong> <strong>organizational</strong> <strong>units</strong> (<strong>OUs</strong>)—You are able to create multiple OUs.</li>
<li><strong>Group policy support</strong>—You are able to use group policies to manage servers.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Stretched Active Directory to Azure IaaS</h1>
                </header>
            
            <article>
                
<p>Extending your local AD Domain Services to Azure IaaS provides you with a very flexible scenario to use your line-of-business applications in the cloud. To use this integration, you need to build a VPN or Express Route connection to Azure.</p>
<p>Domain controllers are highly sensitive roles and will have the most concerns focus on the trust of the service. Many alternative solutions don't support seamless lift and shift migration to Azure like this one:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/34ac1298-cca7-4104-abe0-a5e689bc5689.png" style="width:21.50em;height:25.58em;" width="483" height="574"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Extending your Active Directory to the cloud</div>
<p>Follow the following notes:</p>
<ul>
<li><strong>Domain controllers (RW)</strong>: The best choice for IaaS workloads and will be aware of your replication considerations</li>
<li><strong>Domain controllers (RO)</strong>: Normally used for scenarios with poor security and not an appropriate choice for IaaS workloads</li>
<li><strong>Resource forest scenarios</strong>: Not recommended for use in IaaS</li>
</ul>
<p>In the next section, we'll take a look at the Azure AD B2B integration scenario.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory B2B integration</h1>
                </header>
            
            <article>
                
<p>Azure AD B2B allows any partner to use their own identities and credentials in a collaboration scenario. For the authentication flows and capabilities, we'll take a more in-depth look in <a href="efbe1917-c755-4449-b29e-fa4a21e819fd.xhtml">Chapter 8</a>, <em>Using the Azure AD App Proxy and the Web Application Proxy</em> and <a href="6b29475f-7917-49bf-91d4-3024835d0278.xhtml">Chapter 10</a>, <em>Exploring Azure AD Identity Services</em>. For now, we'll give a quick overview of the synchronization part:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d45f123c-2203-474b-b7a4-e2909c41ee90.png" style="width:17.75em;height:13.25em;" width="524" height="391"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD B2B local application access scenario</div>
<p>For <strong>Azure AD</strong><span><strong> B2B</strong> users to use on-premises Kerberos applications, we need to synchronize the guest user accounts back to the <strong>On-Premises Active Directory</strong>. For this reason, you need to provide your default Azure AD domain suffix in your local AD. In our case, it's <kbd>inovitcloudlabs.onmicrosoft.com</kbd>. You will find the option in the AD Domains and Trusts console:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b02962fd-ad8d-4581-882f-e6581a83c9e0.png" style="width:23.17em;height:18.17em;" width="372" height="292"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Adding your Azure AD tenant suffix to your local UPN suffixes</div>
<p>The registration of the new UPN suffix is necessary because the Azure AD Application Proxy checks the local AD for the existence of the guest user <kbd>UserPrincipalName</kbd>, such as <kbd>jochen.nickel_inovit.ch#EXT#@inovitcloudlabs.onmicrosoft.com</kbd>.</p>
<p>Microsoft provides a default solution for synchronizing the guest users back to the local AD; check it out at <a href="https://bit.ly/2Bor7xy">https://bit.ly/2Bor7xy</a>. The solution contains the needed MIM 2016 configuration or a script to deploy the solution<span> successfully</span>. Don't be worried, we'll do the default configuration and extension later in the book.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory and Microsoft Office 365 synchronization</h1>
                </header>
            
            <article>
                
<p>The following scenario works for the most Office 365 services because every service uses its own directory inside of the Azure AD to store and manage identities. In particular, with SharePoint, we need many additional attributes in the <strong>User Profile Application</strong>, but you can't configure the sync between Azure AD and SharePoint Online. You can find all the default attributes at <a href="https://support.office.com/en-us/article/information-about-user-profile-synchronization-in-sharepoint-online-177eb196-5887-43c9-84c3-b98a43d35129">https://support.office.com/en-us/article/information-about-user-profile-synchronization-in-sharepoint-online-177eb196-5887-43c9-84c3-b98a43d35129</a>. The following diagram shows the SharePoint Online synchronization scenario in a schematic view:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/103cb38e-4970-46ce-9b3f-9d2e084ab99c.png" style="width:24.58em;height:20.25em;" width="519" height="428"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD to User Profile App synchronization extension</div>
<p>One option is to extend the synchronization part with your solution, using the Microsoft Azure AD Graph API. In our case, we used a complete serverless solution based on Azure Functions and Logic Apps.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Identity and password-hash synchronization including SSO options</h1>
                </header>
            
            <article>
                
<p>By synchronizing identities and the associated password hashes from the on-premises AD to the Azure AD, we can build a basic scenario for smaller companies that don’t want to invest in an ADFS infrastructure. Also, there's no SSO required. With this scenario, the same password can be used to authenticate the user either in the cloud or on-premises, depending on what resource is being accessed. Furthermore, the Password Reset and Account Unlock features are available with an Azure AD Premium license. A requirement is Azure AD Connect with password-hash synchronization enabled. Optional password write-back is enabled.</p>
<div class="packt_quote packt_infobox">For this process, a rehashing functionality is in place, which allows the user to have two different hash values in the local AD and the Azure AD. Additionally, multi-forest synchronization is also supported.</div>
<p>The following diagram shows the identity and password-hash synchronization scenario:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/01a9bd00-e6ef-4bc9-92c5-cd1951d096ad.png" style="width:13.67em;height:10.33em;" width="396" height="300"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect password-hash synchronization scenario</div>
<p>To add SSO to the solution, you can enable <span class="packt_screen">Pass-through authentication</span> and the seamless SSO feature in the Azure AD Connect tool. This is the most commonly recommended option from Microsoft to reduce complexity and put Azure AD in the role of the central system to provide authentication to your SaaS and on-premises Kerberos/Claims-based applications:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a75c9b10-47e4-4d70-90eb-7f6650eb5f2e.png" style="width:30.58em;height:18.08em;" width="665" height="393"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">PTA and seamless SSO enablement</div>
<p>It's highly recommended you enable password-hash synchronization, so in case of an on-premises service interrupt, your users can still use cloud services. For now, you can read about this feature at <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta">https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta</a><a href="https://bit.ly/2SOVtAk">.</a></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Identity synchronization including PingFederate integration</h1>
                </header>
            
            <article>
                
<p>Microsoft now directly integrates non-Microsoft products into Azure AD Connect. The first one is the integration of PingFederate, which is very popular in the market. There's no change on the directory synchronization<span>—</span>you enable PingFederate as your federation provider instead of ADFS:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/fd571f7a-a098-43d1-8a23-fd6b323f090f.png" style="width:13.58em;height:12.67em;" width="386" height="361"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Integrating PingIdentity for federation and header-based authentication</div>
<p>The main decision that Microsoft has made with this partnership is to move more and more into the hybrid identity management approach to help you to enable Microsoft and other cloud services quickly.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Identity and password-hash synchronization including ADFS integration</h1>
                </header>
            
            <article>
                
<p>With the implementation of the federation, all authentication is retained on-premises, and all passwords are stored on-premises only. All authentication traffic is redirected from Azure AD to the on-premises ADFS, which authenticates the user against a trusted AD domain. This scenario is commonly used in different company sizes if SSO is required and password-hash synchronization is prohibited due to \ security reasons.</p>
<p>The requirement is the usage of a federation service provider, such as ADFS in addition to Azure AD Connect in a highly available deployment.</p>
<p>The following diagram shows the identity and password-hash synchronization with <span class="packt_screen">ADFS</span> scenario:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/c1ca8d1e-f95c-46e4-83c7-eb4f3a9d7eb4.png" style="width:19.42em;height:12.92em;" width="431" height="287"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Combine federation with password-hash synchronization</div>
<p>You can also combine the <span class="packt_screen">ADFS</span> integration with password-hash synchronization to provide the capability if the on-premises infrastructure turns into an outage and users can still access their cloud services with their known password.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory Connect high availability</h1>
                </header>
            
            <article>
                
<p>For high-availability reasons, a new Azure AD Connect server can be rebuilt and resynchronized in a couple of hours for a small or medium-sized business.</p>
<p>Remember that the <kbd>sourceAnchor</kbd> attribute is used to join the objects from on-premises and the cloud. The sync engine matches the objects together again on reinstallation.</p>
<div class="packt_tip">It's very important that you document your configuration changes, such as special filtering or synchronization rules. You need to reapply these settings before you start the synchronization process. You can use the Azure AD Connect documenter (<a href="https://github.com/Microsoft/AADConnectConfigDocumenter">https://github.com/Microsoft/AADConnectConfigDocumenter</a><span>) to save your changes.</span></div>
<p>Larger organizations with more than 100,000 users, groups, and other objects will take much more time to rebuild the synchronization. If there needs to be a faster time to recovery, Azure Active Directory Connect can be configured to use a dedicated SQL server deployment with SQL high availability. This option provides the needed data directly. With more than 100,000 users, an SQL server is required because a large organization wants to have low recovery time for the synchronization service.</p>
<p>Another way to provide a highly redundant system is to use another server with Azure Active Directory Connect installed and configured in <span class="packt_screen">Staging mode</span>. This functionality also reduces recovery time.</p>
<p>The following diagram shows a staging-mode configuration:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/239cee63-2632-495d-a6c4-c863a73d3ccc.png" style="width:38.83em;height:35.58em;" width="879" height="804"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Enable the staging mode for HA</div>
<p>With Azure AD Connect version 1.1.524.0, Microsoft added the SQL <strong>Always-on Availability</strong> (<strong>AOA</strong>) Group support. SQL clustering was added in an earlier release. Be aware that SQL AOA needs to be enabled before you install Azure AD Connect.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Synchronization terms and processes</h1>
                </header>
            
            <article>
                
<p>In this section, we'll discuss and implement the practical use of the synchronization terms and procedures. We'll combine theory directly with practical use. For this reason, we'll install, configure, and run the processes immediately in the Azure AD Connect tool. To use the guidance, you should deploy a virtual machine with the domain controller role enabled.</p>
<p>Build the virtual machine on Azure or your local virtualization platform. An excellent option is to follow the guide at <a href="https://docs.microsoft.com/en-us/office365/enterprise/base-configuration-dev-test-environment">https://docs.microsoft.com/en-us/office365/enterprise/base-configuration-dev-test-environment</a> with the usage of your free trial Azure or MSDN subscription. We provide you with a complete scripting solution in the code package of the book, or you can follow the instructions in <a href="468509fa-856c-411d-abdb-e9a39c266750.xhtml">Chapter 7</a>, <em>Deploying Solutions on Azure AD and ADFS</em>.</p>
<p><span>We use the same domain name you used in <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml">Chapter 1</a>, <em>Building and Managing Azure Active Directory</em>. In our case, we use the domain name <kbd>inovitlabs.ch</kbd>. So, change the scripts for your environment.</span></p>
<p>Now that we have our primary test environment in place, we can start the preparation and installation of the Azure AD Connect on the Domain Controller. We use this scenario to reduce the costs of your test environment. Be aware that we'll extend the test environment in the coming chapters to demonstrate the functionalities we discuss in this book.</p>
<p>Are you ready? Let's prepare the domain:</p>
<ol>
<li>Log in with the domain administrator credentials and run the following script to create the demo organizational unit structure:</li>
</ol>
<pre style="padding-left: 60px"><strong>New-ADOrganizationalUnit -Name "Managed Business Objects" -Path "DC=INOVITLABS,DC=CH"</strong><br/><br/><strong>New-ADOrganizationalUnit -Name "Users" -Path "OU=Managed Business Objects,DC=INOVITLABS,DC=CH"</strong><br/><br/><strong>New-ADOrganizationalUnit -Name "Groups" -Path "OU=Managed Business Objects,DC=INOVITLABS,DC=CH"</strong><br/><br/><strong>New-ADOrganizationalUnit -Name "Devices" -Path "OU=Managed Business Objects,DC=INOVITLABS,DC=CH"</strong><br/><br/><strong>New-ADOrganizationalUnit -Name "Managed Service Objects" -Path "DC=INOVITLABS,DC=CH"</strong><br/><br/><strong>New-ADOrganizationalUnit -Name "AAD" -Path "OU=Managed Service Objects,DC=INOVITLABS,DC=CH"</strong><br/><br/><strong>New-ADOrganizationalUnit -Name "Users" -Path "OU=AAD,OU=Managed Service Objects,DC=INOVITLABS,DC=CH"</strong></pre>
<p style="padding-left: 60px">The following diagram shows <span>the expected result:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/ad5d3b0f-6bfa-4b10-9aa7-67e2d8e5f2a3.png" style="width:13.67em;height:9.17em;" width="218" height="147"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD service organizational unit</div>
<ol start="2">
<li>Enable the Active Directory recycle bin feature:</li>
</ol>
<pre style="padding-left: 60px"><strong>Enable-ADOptionalFeature –Identity 'CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=inovitlabs,DC=ch' –Scope ForestOrConfigurationSet –Target 'inovitlabs.ch'</strong></pre>
<ol start="3">
<li>Create the <strong>group-managed service account</strong> (<strong>gMSA</strong>) to run the Azure AD Connect service. Replace the computer name with the one you choose for your test environment:</li>
</ol>
<pre style="padding-left: 60px"><strong>Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)<br/></strong><br/><strong>New-ADServiceAccount -Name svcaadconnect -DNSHostname INOLABSADS01 -PrincipalsAllowedToRetrieveManagedPassword INOLABSADS01$</strong></pre>
<ol start="4">
<li>Create the service account for the Active Directory Management Agent that will be used to connect and do the synchronization operations:</li>
</ol>
<pre style="padding-left: 60px"><strong>New-ADUser -Name "svcaadcadma" -SamAccountName svcaadcadma -UserPrincipalName svcaadcadma@inovitlabs.ch -path "OU=Users,OU=AAD,OU=Managed Service Objects,DC=inovitlabs,DC=ch" -AccountPassword (ConvertTo-SecureString "Pass@word1" -AsPlainText -Force) -Enabled $True</strong> </pre>
<p style="padding-left: 60px">The Active Directory Management Agent account needs to be configured with the correct permissions on the domain level.</p>
<ol start="5">
<li>Configure the permissions to configure the <kbd>svcaadcadma</kbd> Azure AD Connect with the Active Directory user's and computer's console (<kbd>dsa.msc</kbd>). Don't forget to enable the advanced features under the view option where you can see the <span class="packt_screen">Security</span> tabs:
<ul>
<li><span class="packt_screen">Replicate Directory Changes</span></li>
<li><span class="packt_screen">Replicate Directory Changes All</span></li>
</ul>
</li>
</ol>
<p style="padding-left: 60px">The following screenshot shows<span> </span><span>the expected result:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/b51db496-0ec0-4cd1-8bae-41e0625ab93f.png" style="width:26.42em;height:26.67em;" width="394" height="398"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Assigning correct permissions to the Azure AD Connect AD Management Agent service account</div>
<p>Now that we've finished the preparation tasks in our test environment, let's run through the following<span> </span>sections for the theoretical explanations and the practical execution. For every task, we'll use the same credentials in an evaluated PowerShell session.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">UserPrincipalName suffix decisions</h1>
                </header>
            
            <article>
                
<p><kbd>UserPrincipalName</kbd> is one of the most relevant user attributes in the connection from a local AD to the <strong>Azure A</strong><strong>D</strong>. Azure AD Connect follows the rules shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4bd3840d-734a-4688-ad61-768c3f61ec65.png" style="width:81.50em;height:53.17em;" width="1064" height="695"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">User Principal Name decision path</div>
<p>As you can see in the preceding diagram, AAD Connect uses the following logic by default:</p>
<ul>
<li>If a UPN is available, it will be used</li>
<li>If a UPN isn't available, it uses the user's <strong>sAMAccountName</strong> and the <strong>fully qualified domain name</strong> (<strong>FQDN</strong>) of the connect AD domain</li>
<li>If the UPN to be exported to the Azure AD isn't verified, the suffix will be replaced with <strong>&lt;tenant&gt;.onmicrosoft.com</strong></li>
</ul>
<p>Remember that users can exist in any synchronized forest and they include <kbd>UserPrincipalName</kbd> and <kbd>sourceAnchor</kbd>. In the case of using linked mailboxes, they will be ignored because the synchronization engine will find an active and deactivated account representation of the user.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Active Directory preparations</h1>
                </header>
            
            <article>
                
<p>To prepare your AD environment, you can use the IdFix tool, which you can download from <a href="http://bit.ly/1VnsvVn">http://bit.ly/1VnsvVn</a>. It performs the discovery and remediation of identity objects and their attributes in an on-premises AD environment in preparation for synchronization to Azure AD. IdFix is provided for AD administrators that plan to use Azure AD Connect with the Azure AD/Office 365 services. You can use the tool for every synchronization scenario:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1d1dc543-bf7f-4f05-89bf-068a6080de4e.png" width="1347" height="142"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Incorrect user accounts found by the IdFix tool</div>
<p>To test the <span class="packt_screen">IdFix</span> utility, we'll create some incorrect test users with the following script:</p>
<pre><strong>New-ADUser -Name "James Meyers" -GivenName J. -Surname Meyers -SamAccountName jmeyers -UserPrincipalName james.meyers@local -path "OU=Users,OU=Managed Business Objects,DC=inovitlabs,DC=ch" -AccountPassword (ConvertTo-SecureString "Pass@word1" -AsPlainText -Force) -Enabled $True</strong><br/><br/><strong>New-ADUser -Name "Adrian Gilbert" -GivenName Adrian -Surname Gilbert -SamAccountName adrian.gilbert -UserPrincipalName "adrian.gilbert @inovitlabs.ch" -path "OU=Users,OU=Managed Business Objects,DC=inovitlabs,DC=ch" -AccountPassword (ConvertTo-SecureString "Pass@word1" -AsPlainText -Force) -Enabled $True</strong><br/><br/><strong>New-ADUser -Name "Wilma Chavez" -GivenName Wilma -Surname Chavez -SamAccountName wilma.chavez -UserPrincipalName "wilma.chavez°@inovitlabs.ch" -path "OU=Users,OU=Managed Business Objects,DC=inovitlabs,DC=ch" -AccountPassword (ConvertTo-SecureString "Pass@word1" -AsPlainText -Force) -Enabled $True</strong></pre>
<p>The following screenshot shows<span> </span><span>the expected result:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/f41fa94a-0075-421a-8133-a0620ab0ebf2.png" style="width:29.00em;height:14.83em;" width="467" height="238"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Creation result of the damaged user accounts</div>
<p>Now we can run the <span class="packt_screen">IdFix</span> tool to check the local AD for a user that will build errors in a synchronization:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/50a1f40a-338c-4a43-9db0-6f34b02a10b8.png" style="width:50.25em;height:10.00em;" width="784" height="156"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Errors found on the damaged user accounts</div>
<p>After you test the <span class="packt_screen">IdFix</span> tool, delete the created test user accounts.</p>
<p>With the next steps we will start the installation of the Azure AD Connect tool:</p>
<ol>
<li>Run the Azure AD Connect installation. Download the actual version of the tool from <a href="https://www.microsoft.com/en-us/download/details.aspx?id=47594">https://www.microsoft.com/en-us/download/details.aspx?id=47594</a> <a href="https://bit.ly/1JPD3qY">and start the installation with the Domain Administrator credentials.</a></li>
<li>Choose the custom installation option so that we can view all the essential configuration steps. I always use the custom option and not the <span class="packt_screen">Express</span> option.</li>
<li>Use the gMSA created in the previous steps to configure the Azure AD Connect service:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d0d47629-e355-4539-8bc4-7a45da8e2bb8.png" style="width:47.67em;height:33.42em;" width="876" height="614"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Service account configuration</div>
<ol start="4">
<li>At this time, we don't set any <span class="packt_screen">User sign-in</span> option:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/cfd7e498-3eea-487c-94c8-1b8af9b18117.png" style="width:39.00em;height:27.42em;" width="876" height="615"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">User sign-in configuration</div>
<p>In the next section, we'll discuss the source anchor decision process, so click <span class="packt_screen">Next</span> and wait for the next lab part.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Source Anchor decisions</h1>
                </header>
            
            <article>
                
<p>It’s crucial to understand Source Anchor because it builds the basis for the relationship between the AD Domain Services user and the Azure AD user. The <kbd>sourceAnchor</kbd> attribute can't be changed. Be aware that your configuration fits your expected scenario.</p>
<p>The attribute provides the following capabilities to you:</p>
<ul>
<li>Supports faster rebuilding scenarios</li>
<li>Supports the move from a cloud-only to a synchronized scenario with a hard match</li>
</ul>
<ul>
<li>In a federation scenario, it builds the claim with <kbd>UserPrincipalName</kbd> to identify a user <span>uniquely</span></li>
</ul>
<p>The following rules need to be followed when choosing a <kbd>sourceAnchor</kbd> attribute:</p>
<ul>
<li>Less than 60 characters</li>
<li>No special characters, such as {, }, |, ~, &lt;, &gt;, (, ), ' ; : , [, ], ", @, _,\, !, #, $, %, &amp;, *, +, /, =, ?, ^, or `</li>
<li>Globally unique</li>
<li>String, integer, or binary</li>
<li>Should not be based on the user's name and case-sensitive</li>
<li>Assigned at object-creation time</li>
</ul>
<p>Azure AD Connect uses the following defaults as the <kbd>sourceAnchor</kbd> attribute:</p>
<ul>
<li>Azure AD Connect (version 1.1.486.0 and older<span>) usage of the objectGUID as the</span> <kbd>sourceAnchor</kbd> <span>attribute</span></li>
<li>Azure AD Connect (version 1.1.524.0 and after) usage of the <span class="packt_screen">ms-DS-ConsistencyGuid</span> as <kbd>sourceAnchor</kbd> attribute</li>
</ul>
<p>The following screenshot shows the configuration in the Azure AD Connect installation wizard:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/04e1a01b-c9bd-4b57-9703-0548a061f69a.png" style="width:83.75em;height:39.92em;" width="1308" height="624"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">sourceAnchor definition of Azure AD Connect</div>
<p><span>The Management Agent user account must be granted write permissions to the</span> <span class="packt_screen">ms-DS-ConsistencyGuid</span> <span>attribute in the local AD. Keep in mind, only newer versions of Azure AD Connect (1.1.552.0 and after) support switching from ObjectGuid to</span> <span class="packt_screen">ms-DS-ConsistencyGuid</span> <span>as the</span> <kbd>sourceAnchor</kbd> <span>attribute.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Connected Directories</h1>
                </header>
            
            <article>
                
<p class="mce-root">The <strong>Synchronization Engine</strong> from the Azure AD Connect processes identities from the AD and the Azure AD. Every directory or repository organizes the data in their method and provides different access methods. The data repositories that are synchronized with Azure AD Connect are called connected data sources or <strong>connected directories</strong> (<strong>CDs</strong>). The two supported CDs in Azure AD Connect are the AD and the Azure AD. You can connect any other repository but in a Microsoft, unsupported way. The following diagram shows the basic concept of synchronization:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/16d19282-8ddb-4fba-a144-0b8dbaace242.png" style="width:18.17em;height:8.00em;" width="424" height="186"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Basic concept of a connector and the connected directory</div>
<p>Now, let's jump back to the Azure AD Connect configuration and log back into your Domain Controller.</p>
<p>We will configure the two repositories:</p>
<ol>
<li>Provide your <span class="packt_screen">global administrator credentials</span> from your <span class="packt_screen">Azure AD</span> and click <span class="packt_screen">Next</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d8679d60-869b-4763-9884-24861aa2917c.png" style="width:50.42em;height:35.50em;" width="876" height="616"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Connect Azure AD Connect to the Azure AD</div>
<ol start="2">
<li>Connect the local <span class="packt_screen">Active Directory</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/18493b17-7ddb-4432-be41-f2117d97ccd3.png" style="width:50.25em;height:35.17em;" width="878" height="614"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Connect the local AD</div>
<ol start="3">
<li>Use the created AD Management Agent account for this task:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/fb6c6cd9-9976-4bd9-8db3-5d513f1b4a4f.png" style="width:29.58em;height:23.42em;" width="598" height="472"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Configure the AD Management Agent service account</div>
<ol start="4">
<li>Find your verified custom domain, in my case <span class="packt_screen">inovitlabs.ch</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7edcd30e-934f-4067-ac22-a1483767acc6.png" style="width:35.92em;height:25.17em;" width="876" height="615"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Define the sign-in options</div>
<ol start="5">
<li>On the <span class="packt_screen">Domain and OU filtering</span> page, choose the created <span class="packt_screen">Managed Business Objects</span> OU. With the following setting, no newly created OUs will be included in the synchronization process:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6c223ef9-3ea0-408d-be63-142081d57e9e.png" style="width:50.00em;height:35.25em;" width="874" height="616"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">OU filtering options</div>
<ol start="6">
<li>With the following option, every newly established OU under <span class="packt_screen">Managed Business Objects</span> will be included in the synchronization process:</li>
</ol>
<div class="CDPAlignCenter packt_figref CDPAlign"><img src="Images/0f0e1a64-1b7e-46b4-b25e-73ad0545fa71.png" style="width:49.75em;height:34.92em;" width="875" height="614"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">The second part of OU filtering options</div>
<ol start="7">
<li>Configure the <kbd>sourceAnchor</kbd> <span><span class="packt_screen">ms-DS-ConsistencyGuid</span> as we discussed in the </span><em>Source Anchor decisions</em> section <span>:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d9457fe4-4e99-498b-a8d3-9bf63a6982b2.png" style="width:49.75em;height:35.08em;" width="876" height="617"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">sourceAnchor definition dialog</div>
<ol start="8">
<li>In the <span class="packt_screen">Filter users and devices</span> section, choose the default option. You could also use the group option for proof of concepts:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a614ae7c-de2a-421b-a42b-efd295c08866.png" style="width:49.75em;height:34.92em;" width="876" height="615"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Filter users and devices dialog</div>
<ol start="9">
<li>In the <span class="packt_screen">Optional features</span> section, you see the available synchronization options, which we discussed in the integration scenarios. Keep in mind that you need the correct permissions for the Active Directory Management Agent account to write back to the local AD:</li>
</ol>
<div class="CDPAlignCenter packt_figref CDPAlign"><img src="Images/3536a0a4-4c2e-401a-a1e5-5d0f4676d3c5.png" style="width:49.50em;height:34.67em;" width="876" height="614"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect Optional features section</div>
<ol start="10">
<li>Click <span class="packt_screen">Next</span> to finish the configuration. Be sure that you don't enable the synchronization process because we do the things step by step.</li>
</ol>
<p>The directories will be connected after we finish the Azure AD Connect installation wizard, and can be viewed in the <span class="packt_screen">Synchronization Service Manager</span> under <span class="packt_screen">Connectors</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/1a2f749c-34db-4afb-88a4-67bf654ef134.png" style="width:48.75em;height:21.75em;" width="789" height="352"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure AD Connect - Connected directories</div>
<p>After installing and configuring the Azure AD Connect tool, we can jump into the detailed sections of the synchronization. In the upcoming <a href="8f401db9-e842-4a9a-8b12-5fdd175df3c0.xhtml">Chapter 3</a>, <em>Exploring Advanced Synchronization Concepts</em>, we'll enable the available writeback, extension, and filtering options.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Import flow</h1>
                </header>
            
            <article>
                
<p>The internal sync engine contains two namespaces that store identity information: the CS and the <strong>metaverse</strong> (<strong>MV</strong>). The CS is used to detect changes in the connected data sources. The connector space is also used to proceed outgoing changes for the export process into the connected data source.</p>
<div class="packt_quote packt_infobox">Data can flow in each direction, but it can't flow in both directions simultaneously. <br/>
Just to recap: the MV is a storage area that contains the aggregated identity information from multiple connected data. It's very important to understand that every synchronization engine object must have a <strong>globally unique identifier</strong> (<strong>GUID</strong>) for data integration reasons and the relationships between the objects.</div>
<p>The import process is done between the connected data source and the connector space. For this reason, we provide some information about the connector space.</p>
<p>Connector space objects have two attributes:</p>
<ul>
<li><strong>Globally unique identifier</strong> (<strong>GUID</strong>)</li>
<li><strong>Distinguished name</strong> (<strong>DN</strong>)</li>
</ul>
<p>CS objects can be one of the following:</p>
<ul>
<li>A CS object</li>
<li>A placeholder</li>
</ul>
<p>The following diagram shows<span> </span><span>the schematic view of the <strong>Synchronization Engine</strong>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a8ccbf48-de66-454c-8f1a-70ad56bc8cc4.png" style="width:51.00em;height:16.67em;" width="1011" height="331"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Synchronization Engine overview</div>
<p>Now let's see the import flow in action. Keep in mind that we already have users in our Azure AD from<span> <a href="54c375d9-b7d0-4478-8777-33935239254b.xhtml">Chapter 1</a>,</span> <em>Building and Managing Azure AD:</em></p>
<ol>
<li>Log into your Domain Controller and open the Azure AD Connect <span class="packt_screen">Synchronization Service Manager.</span></li>
<li>Run a <span class="packt_screen">Full Import</span> on the connected Active Directory:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/62d846b8-9d54-4a03-87f2-23e67a758d81.png" style="width:47.17em;height:37.08em;" width="788" height="619"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Full Import profile run</div>
<ol start="3">
<li>The sync engine imports the organizational structure (placeholder) into the CS:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/575c2606-7f41-4259-a0ce-5dff307a0249.png" style="width:44.92em;height:12.25em;" width="789" height="215"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Statistics after Full Import</div>
<ol start="4">
<li>You see the imported organizational structure:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/cf75545f-39f6-4562-9b09-2d6ff852144e.png" style="width:32.00em;height:10.00em;" width="574" height="181"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Imported objects</div>
<ol start="5">
<li>Run a <span class="packt_screen">Full Import</span> on the connected <span class="packt_screen">Azure Active Directory</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7d82aed0-7d49-4dc9-a714-a0ae1a6e41c9.png" style="width:49.33em;height:38.83em;" width="787" height="620"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Full Import on Azure AD</div>
<ol start="6">
<li>No objects are created in the CS. Remember that we already <span>have </span>users in the Azure AD<span>—</span>there's no user write-back available:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/261c972a-bba2-4157-8bc7-12218e04e5c5.png" style="width:51.17em;height:15.75em;" width="789" height="243"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Full Import Azure AD statistics</div>
<p>Also, there's no interaction with the MV with an import flow. In the next section, you'll learn more about placeholder objects.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Placeholder objects</h1>
                </header>
            
            <article>
                
<p>An example of a placeholder object is the containers to validate the path to the AD objects. We can also talk about a placeholder object to which the manager attribute refers. As a rule, we can say that placeholder objects don't contain values and are not linked with the MV.</p>
<p>Run profiles—one per forest, one step per domain:</p>
<ul>
<li>We import (stage) all objects into the CS (even filtered by the Connector Filter)</li>
<li>Full Import—all objects</li>
<li>Delta Import—only changed objects</li>
</ul>
<p>Next, we'll move to the synchronization flows.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Synchronization flows</h1>
                </header>
            
            <article>
                
<p>Synchronization flows are specific to the processes between the CS and the MV objects. As a rule, we can say that multiple CS objects can be linked to one MV object. This is typical because the MV represents the unique identity object over all connected systems. On the other hand, a CS object can't have a link to multiple MV objects, as shown in the image below:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/99744c52-9595-49a0-b065-91bd0df677e2.png" style="width:41.92em;height:13.75em;" width="1011" height="331"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Synchronization flow overview</div>
<p>The synchronization flows are configured over the synchronization rules that you can view in the Azure AD Connect <span class="packt_screen">Synchronization Rules Editor</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9a75c387-813c-4e3f-a5b8-c39e864b6acd.png" style="width:58.08em;height:43.17em;" width="940" height="698"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Synchronization rules editor overview</div>
<p>In <a href="8f401db9-e842-4a9a-8b12-5fdd175df3c0.xhtml" target="_blank">Chapter 3</a>, <em>Exploring Advanced Synchronization Concepts,</em> we'll discuss the synchronization rules in detail. For now, we'll focus on the main functions and explanations.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Inbound synchronization</h1>
                </header>
            
            <article>
                
<p>The inbound synchronization is defined by a subset of synchronization rules and contains the terms shown in the following diagram. If we use an inbound synchronization, the synchronization engine will update the changes between the MV and the CS. The inbound synchronization happens when the content of the MV is updated by using the data in the CS:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/25da1a55-e2f6-4f69-b4fe-ca7a1eb186d1.png" style="width:43.25em;height:18.08em;" width="1011" height="422"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Inbound synchronization overview</div>
<p>Another term for the provisioning is <strong>Projection</strong> and it's part of the outbound synchronization. We can also say that provisioning is an object-level operation because the synchronization engine creates a new object in the MV based on the object in the CS and creates a link between them. The join is in the special process, which creates the link. So, the join is also an object-level operation. The import attribute flow is used from the synchronization engine to update attribute values of the MV object. We can say that the import flow is attribute-level-based and requires a link between the CS and the MV object.</p>
<p>Let's take a look at our Azure AD Connect:</p>
<ol>
<li>Log into your Domain Controller and open the Azure AD Connect <span class="packt_screen">Synchronization Service Manager</span>.</li>
<li>Run a <span class="packt_screen">Full Synchronization</span> on the local AD:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/87eefc41-5b19-4e6a-bd3e-e13fdfa17018.png" style="width:49.50em;height:38.92em;" width="789" height="620"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Full Synchronization run on the local AD</div>
<ol start="3">
<li>Nothing happens on the MV. You will only find <span class="packt_screen">5</span> <span class="packt_screen">Disconnectors</span> for the organizational structure (placeholders):</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/eb5e3d84-e1a9-42e2-8e1e-efab70d2a9ec.png" style="width:44.00em;height:13.33em;" width="792" height="240"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Full Synchronization statistics</div>
<p style="padding-left: 60px">Let's create a test user with the same <kbd>UserPrincipalName</kbd> as an existing user in Azure AD. In my case, I use <kbd>jochen.nickel@inovitlabs.ch</kbd>:</p>
<pre style="padding-left: 60px"><strong>New-ADUser -Name "Jochen Nickel" -GivenName Jochen -Surname Nickel -SamAccountName jochen.nickel -UserPrincipalName jochen.nickel@inovitlabs.ch -path "OU=Users,OU=Managed Business Objects,DC=inovitlabs,DC=ch" -AccountPassword (ConvertTo-SecureString "Pass@word1" -AsPlainText -Force) -Enabled $True</strong></pre>
<ol start="4">
<li>Run a <span class="packt_screen">Delta import</span> on the local AD:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/2bedc4ba-32d2-4cbf-acc2-f8286ee78158.png" style="width:46.50em;height:14.08em;" width="791" height="240"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Delta Import statistics on local AD</div>
<ol start="5">
<li>Run a <span class="packt_screen">Delta Synchronization</span> on the local AD:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a69d8700-253d-4e6b-867a-d88e116477fe.png" style="width:55.67em;height:18.33em;" width="854" height="281"/></p>
<div class="CDPAlignCenter CDPAlign packt_figref">Delta synchronization on local AD statistics</div>
<p style="padding-left: 60px">In the actual state, we would have a provisioning of the user in the Azure AD. For this reason, we need to run a <span class="packt_screen">Full Synchronization</span> on the Azure AD to get all the changes. This procedure avoids the making of a wrong provisioning, because we want to <span>join the user based on the</span> <kbd>UserPrincipalName</kbd><span>.</span></p>
<ol start="6">
<li>Run a <span class="packt_screen">Full Synchronization</span> on the Azure AD:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/a6ea3c94-750e-4b95-8bc4-6077f327df57.png" style="width:53.75em;height:16.58em;" width="788" height="243"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Full synchronization statistics </div>
<ol start="7">
<li>Click on <span class="packt_screen"><span class="packt_screen">Connectors</span> without Flow Updates</span> and inspect the changes.</li>
<li>Run an <span class="packt_screen">Export</span> on the Azure AD which will recognize that the user will be joined by <kbd>UserPrincipalName</kbd>. We prove this with a <span class="packt_screen">Metaverse Search</span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="Images/24b2cf40-d14e-4f5f-bcad-516bb80def73.png" style="width:54.83em;height:21.00em;" width="842" height="322"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Metaverse Search options</div>
<p>You synchronized your first user, including a join operation! You can follow up by mapping all the accounts. This is how you can map existing on-premises accounts with Azure AD accounts.</p>
<p>If you run an <span class="packt_screen">Export</span> on the AD, you'll receive a <span class="packt_screen">permission issue</span> error:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6c08162c-7f5a-419b-bd13-22fed36ed41f.png" style="width:49.33em;height:8.58em;" width="857" height="149"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Export statistics on AD</div>
<p>Modify the cmdlets to your environment and execute them to grant the AD Management Account the permissions to write to <kbd>ms-ds-consistencyGuid</kbd>:</p>
<pre>$accountName = "INOVITLABS\svcaadcadma"<br/>$ForestDN = "OU=Managed Business Objects,DC=inovitlabs,DC=ch"<br/>$cmd = "dsacls '$ForestDN' /I:S /G '`"$accountName`":WP;ms-ds-consistencyGuid;user'"<br/>Invoke-Expression $cmd</pre>
<p>Run the <span class="packt_screen">Export</span> on the AD again and the error will disappear.</p>
<p>You can also use the email address or write <kbd>ImmutableId</kbd> to a PowerShell script. You can use the following script for this purpose, <a href="https://gallery.technet.microsoft.com/scriptcenter/Convert-between-Immutable-e1e96aa9">https://gallery.technet.microsoft.com/scriptcenter/Convert-between-Immutable-e1e96aa9</a> or the following procedure:</p>
<pre>$guid = (Get-ADUser -Identity jochen.nickel).ObjectGUID<br/><span>$immutableid=[System.Convert]::ToBase64String($guid.tobytearray())<br/></span><span>Set-MsolUser -UserPrincipalName jochen.nickel@inovitlabs.ch -ImmutableId $immutableid</span><span><br/></span></pre>
<p>After you successfully join all the users, you can run a complete default sync cycle with the following PowerShell cmdlet:</p>
<pre><strong>Start-ADSyncSyncCycle -PolicyType Initial</strong></pre>
<p>This would happen if you enable the synchronization in the installation and configuration wizard of Azure AD Connect.</p>
<p>By default, the Azure AD Connect Sync Engine schedulers runs the following on the initial run:</p>
<ul>
<li>AD—Full Import</li>
<li>AAD<span>—</span>Full Import</li>
<li>AD<span>—</span>Full Sync</li>
<li>AAD<span>—</span>Full Sync</li>
<li>AAD<span>—</span>Export</li>
<li>AD<span>—</span>Export</li>
</ul>
<p>Now that we've done the practical tasks, let's look at the rest of the theoretical information.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Outbound synchronization</h1>
                </header>
            
            <article>
                
<p>With outbound synchronization, you update the exported objects when an MV object is changed but not deleted. The primary purpose of the outbound synchronization is to check the changes to MV objects, which need to be updated in the CS.</p>
<p class="mce-root">With outbound synchronization, we use the following three processes. You will get a provisioning process if changes are applied to an object in the MV. The deprovisioning process always depends on the provisioning itself, because the provisioning process is the only one that can initiate the export attribute flow. The objects in the CS during an export are provided with the pending export flag to make them export objects. You can see the process in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/21dc04d7-5c7a-4f32-bc8d-cd8350638d40.png" style="width:35.83em;height:13.33em;" width="1011" height="375"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Outbound synchronization overview</div>
<p>If changes happen to an MV object, the synchronization engine can create joined objects as part of the provisioning process. Furthermore, the synchronization engine can rename a joined object and disjoin an object. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Joins</h1>
                </header>
            
            <article>
                
<p>Joins are an excellent functionality. We call a linked object in the CS, with an object in the MV a joined object. Otherwise, it's a disjoined object. The following diagram shows the Joins concept:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/286671bf-776d-468d-85c1-2e237cf51178.png" style="width:36.00em;height:11.75em;" width="1011" height="331"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Joins overview</div>
<p>With the synchronization process, an object from the CS will be a joined object. In this case, the related attributes can flow. The attribute flow is in both directions.</p>
<p class="mce-root">The disjoined object usage delivers such that the required information about the object is already stored and they are convertible in both ways. With an import you<span> always</span> create a disjoined object as well with the export.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Connector objects</h1>
                </header>
            
            <article>
                
<p>Now that we have discussed the join operations we will explain the different connector objects, which are used by the system to build the connection between the connector space and the metaverse object.</p>
<p>There are two types of connector objects:</p>
<ul>
<li>Connectors</li>
<li>Explicit connectors</li>
</ul>
<p>A connector is an object in the CS. The object is linked to an object in the MV, so every rule applies to this object. Furthermore, an explicit connector exists. With this type of connector, the object is linked to an object in the MV. This type of connector can only be created with the Joiner functionality, which isn't available in Azure AD Connect.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Disconnector objects</h1>
                </header>
            
            <article>
                
<p>There are three types of disconnector objects:</p>
<ul>
<li>Disconnectors</li>
<li>Explicit disconnectors</li>
<li>Filtered disconnectors</li>
</ul>
<p>We speak about a disconnector when an object in the CS isn't linked to an object in the MV. An explicit disconnector is also not a linked object in the MV and can only be joined with the Joiner toolset of the synchronization engine. This feature is not available in Azure AD Connect. The meaning of a filtered disconnector is an object in the CS, that is prevented from being joined or projected to an object in the MV.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Export flow</h1>
                </header>
            
            <article>
                
<p>During the export process, the synchronization engine checks all the exported objects with the <strong>Pending Export</strong> flag in the CS, and an update will be sent to the data source:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/29e73f73-0954-40f3-9544-cc8e575cfa43.png" style="width:41.83em;height:13.67em;" width="1011" height="331"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Export flow overview</div>
<p>At this moment, the synchronization engine can only validate whether the export was successful. It needs an import to prove that the exported values are correctly transported to the repository:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/d3ca2b48-322e-419a-a696-e8b964ae6cfc.png" style="width:39.75em;height:13.00em;" width="1011" height="331"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Import flow to prove the export</div>
<p>Now that you are equipped with the essential information about Azure AD Connect and synchronization tasks, we'll jump into the details of the synchronization rules editor in <a href="8f401db9-e842-4a9a-8b12-5fdd175df3c0.xhtml" target="_blank">Chapter 3</a>, <em>Exploring Advanced Synchronization Concepts</em>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we discussed the most important identity synchronization tools: Microsoft Identity Manager and Azure Active Directory Connect. We walked through the typical synchronization scenarios. Now you're able to adopt the best scenario for your requirements. In the <em>Synchronization terms and processes</em> section, we took a deep dive into the synchronization service, so you know exactly what's happening under the hood, which will help you to avoid mistakes and provide better troubleshooting for synchronization errors.</p>
<p>In the next chapter, we'll explore additional filtering, join attributes, declarative provisioning options, and generic connector usage.</p>


            </article>

            
        </section>
    </div>



  </body></html>