<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;6.&#xA0;Glance &#x2013; OpenStack Image Service" id="2IV0U1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06" class="calibre1"/>Chapter 6. Glance – OpenStack Image Service</h1></div></div></div><p class="calibre10">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Introduction to OpenStack Image services</li><li class="listitem">Managing images</li><li class="listitem">Using image snapshots</li><li class="listitem">Using image metadata</li><li class="listitem">Protecting images</li><li class="listitem">Deactivating images</li><li class="listitem">Creating custom images</li></ul></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Glance &#x2013; OpenStack Image Service" id="2IV0U1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Introduction to OpenStack Image services"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch06lvl1sec84" class="calibre1"/>Introduction to OpenStack Image services</h1></div></div></div><p class="calibre10">The OpenStack <a id="id384" class="calibre1"/>Image service, otherwise known as Glance, is a service that allows users to register, discover, and retrieve virtual machine images for use in an OpenStack cloud. Images made available through the OpenStack Image service can be stored in a variety of formats and backend locations, from local filesystem storage to distributed filesystems such as OpenStack Object Storage (Swift) and Ceph.</p><p class="calibre10">The OpenStack Image service is composed of two major components: the <code class="email">glance-api</code> service and the <code class="email">glance-registry</code> service. Users interface with the <code class="email">glance-api</code> service indirectly when performing commands to create, list, delete, or otherwise manage images using OpenStack clients. The <code class="email">glance-registry</code> service is responsible for connecting to the backend database and storing or retrieving images.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Managing images"><div class="book" id="2JTHG2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec85" class="calibre1"/>Managing images</h1></div></div></div><p class="calibre10">Image <a id="id385" class="calibre1"/>management in an OpenStack environment can be achieved using the <code class="email">openstack</code> command-line tool, the Horizon <a id="id386" class="calibre1"/>dashboard, or directly via the Glance REST-based API. Images can be sourced directly from the internet or created and manipulated with tools such as <code class="email">virsh</code>, <code class="email">virt-manager</code>, <code class="email">growpart</code>, and <code class="email">cloud-init</code>. Custom image creation will be covered later in this chapter.</p></div>

<div class="book" title="Managing images">
<div class="book" title="Uploading images"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec236" class="calibre1"/>Uploading images</h2></div></div></div><p class="calibre10">When <a id="id387" class="calibre1"/>creating an image in OpenStack, one must provide attributes that describe the image. These attributes include the image name, the disk format, and the container format. Images can be public, private, or shared among multiple projects.</p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec237" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">Images for the following examples can be downloaded from the following locations:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Ubuntu: <a class="calibre1" href="https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img">https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img</a></li><li class="listitem">CirrOS: <a class="calibre1" href="https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img">https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img</a></li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note21" class="calibre1"/>Note</h3><p class="calibre10">Over time, image locations on the web can change and the URLs in this book may be unavailable. Feel free to replace any URL in these examples with a known, working URL.</p></div><p class="calibre10">When uploading an image, ensure that you have properly sourced your credentials or are otherwise properly authenticated.</p><p class="calibre10">You will need the following details, at a minimum, when uploading an image:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name</li><li class="listitem">Disk format</li><li class="listitem">Image location</li></ul></div><p class="calibre10">For our first example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_CIRROS_IMAGE</code></li><li class="listitem">Disk format: <code class="email">qcow2</code></li><li class="listitem">Image location: <code class="email">/tmp/cirros-0.3.5-i386-disk.img</code></li></ul></div><p class="calibre10">For our <a id="id388" class="calibre1"/>second example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li><li class="listitem">Disk format: <code class="email">qcow2</code></li><li class="listitem">Image location: <code class="email">/tmp/xenial-server-cloudimg-amd64-disk1.img</code></li></ul></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec238" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to upload an image with the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Download the CirrOS image to the <code class="email">/tmp</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">wget </strong></span>
<span class="strong"><strong class="calibre2">https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img -O /tmp/cirros-0.3.5-i386-disk.img</strong></span>
</pre></div></li><li class="listitem" value="2">Upload the CirrOS image:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image create COOKBOOK_CIRROS_IMAGE \</strong></span>
<span class="strong"><strong class="calibre2">--disk-format qcow2 \</strong></span>
<span class="strong"><strong class="calibre2">--file /tmp/cirros-0.3.5-i386-disk.img</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00117.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><p class="calibre22">Repeat the <a id="id389" class="calibre1"/>previous steps for the Ubuntu image:</p></li><li class="listitem" value="3">Download the Ubuntu image to the <code class="email">/tmp</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">wget https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img -O /tmp/xenial-server-cloudimg-amd64-disk1.img</strong></span>
</pre></div></li><li class="listitem" value="4">Upload the Ubuntu image:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image create COOKBOOK_UBUNTU_IMAGE \</strong></span>
<span class="strong"><strong class="calibre2">--disk-format qcow2 \</strong></span>
<span class="strong"><strong class="calibre2">--file /tmp/xenial-server-cloudimg-amd64-disk1.img</strong></span>
</pre></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec239" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Images are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image create IMAGE_NAME \</strong></span>
<span class="strong"><strong class="calibre2">--disk-format DISK_FORMAT \</strong></span>
<span class="strong"><strong class="calibre2">--file FILE_LOCATION \</strong></span>
<span class="strong"><strong class="calibre2">[--public | --private | --shared | --community]</strong></span>
</pre></div><p class="calibre10">Creating an image with the OpenStack client results in the specified file being uploaded to the OpenStack image repository. The repository can be a local directory or volume specified in the Glance configuration file, or even an object store served by Swift, Ceph, Rackspace Cloud Files, or others.</p><p class="calibre10">The <code class="email">disk-format</code> parameter defines the format of the virtual disk used by the image. Options include <code class="email">ami</code>, <code class="email">ari</code>, <code class="email">aki</code>, <code class="email">vhd</code>, <code class="email">vmdk</code>, <code class="email">raw</code>, <code class="email">qcow2</code>, <code class="email">vhdx</code>, <code class="email">vdi</code>, <code class="email">iso</code>, and <code class="email">ploop</code>. The <code class="email">qcow2</code> format is popular among OpenStack-based clouds running QEMU/KVM hypervisors, and it supports smaller image file sizes, copy-on-write support, and various compression and encryption technologies. The default format is <code class="email">raw</code>.</p><p class="calibre10">When uploading images to a Glance store backed by Ceph, the images must be in the <code class="email">raw</code> format <a id="id390" class="calibre1"/>else they will fail to work properly. The <code class="email">qemu-img</code> command can be used to identify the format of an image, and it can also be used to perform the conversion of an image from one format to another.</p><p class="calibre10">An example of converting an image in the <code class="email">qcow2</code> format to the <code class="email">raw</code> format is shown here:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">qemu-img convert -f qcow2 -O raw image.qcow2 image.raw</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip59" class="calibre1"/>Tip</h3><p class="calibre10">Additional examples of using the <code class="email">qemu-img</code> command can be found in the OpenStack documentation here:</p><p class="calibre10">
<a class="calibre1" href="https://docs.openstack.org/image-guide/convert-images.html">https://docs.openstack.org/image-guide/convert-images.html</a>
</p></div><p class="calibre10">The <code class="email">file</code> parameter defines the local location of the image file respective to where the OpenStack client is being run. The OpenStack client uploads the image to the OpenStack image repository, where it is stored according to settings within Glance.</p><p class="calibre10">When specified, the <code class="email">--public</code> option marks the image as accessible by all projects within the cloud. Alternatively, the <code class="email">--private</code> option marks the image as accessible only by the project that created it. By default, all images created are marked as <code class="email">shared</code> and are eligible to be shared with another project. At the time of creation, however, the image can only be seen by the project that created it. The <code class="email">--shared</code> and <code class="email">--community</code> options are discussed later in this chapter in the <span class="strong"><em class="calibre18">Sharing images</em></span> recipe.</p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Listing images"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec240" class="calibre1"/>Listing images</h2></div></div></div><p class="calibre10">To list <a id="id391" class="calibre1"/>the images in the OpenStack Image service repository, use the following OpenStack client command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image list</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00118.jpeg" alt="Listing images" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Viewing image details"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch06lvl2sec241" class="calibre1"/>Viewing image details</h2></div></div></div><p class="calibre10">The details <a id="id392" class="calibre1"/>of individual images can be queried using the following OpenStack client command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image show IMAGE_NAME_OR_ID</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00119.jpeg" alt="Viewing image details" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Deleting images"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch06lvl2sec242" class="calibre1"/>Deleting images</h2></div></div></div><p class="calibre10">Images can <a id="id393" class="calibre1"/>be deleted from the OpenStack image repository at any time. Keep in mind, however, that depending on the version of OpenStack installed, deleting an image can have an adverse effect on the ability to migrate an instance.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note22" class="calibre1"/>Note</h3><p class="calibre10">OpenStack releases newer than Kilo should not be impacted by this issue.</p></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_8"><a id="ch06lvl2sec243" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When deleting an image, the following information will be necessary:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li></ul></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_9"><a id="ch06lvl2sec244" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To delete an image in OpenStack, issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image delete COOKBOOK_CIRROS_IMAGE</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. To verify that the image is no longer available, use <a id="id394" class="calibre1"/>the <code class="email">openstack image list</code> or <code class="email">openstack image show</code> command.</p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Downloading images"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_10"><a id="ch06lvl2sec245" class="calibre1"/>Downloading images</h2></div></div></div><p class="calibre10">Images that <a id="id395" class="calibre1"/>exist in the OpenStack image repository can be downloaded at a later time and transferred to other systems.</p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_11"><a id="ch06lvl2sec246" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To download an image from the OpenStack image repository, you must have access to the image. You will need the following details, at a minimum, to download the image:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li><li class="listitem">Destination for downloaded file</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li><li class="listitem">Download location: <code class="email">/tmp/my_downloaded_ubuntu_image.qcow2</code></li></ul></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_12"><a id="ch06lvl2sec247" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to download an image from the repository with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image save COOKBOOK_UBUNTU_IMAGE \</strong></span>
<span class="strong"><strong class="calibre2">--file /tmp/my_downloaded_ubuntu_image.qcow2</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. Use the <code class="email">ls</code> command to list the downloaded file:</p><div class="mediaobject"><img src="../images/00120.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Managing images">
<div class="book" title="Sharing images"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_13"><a id="ch06lvl2sec248" class="calibre1"/>Sharing images</h2></div></div></div><p class="calibre10">When an <a id="id396" class="calibre1"/>image is <span class="strong"><em class="calibre18">private</em></span>, it is only available to the project from which that image was created or uploaded. On the other hand, when an image is <span class="strong"><em class="calibre18">public</em></span>, it is available to all projects. The OpenStack Image service provides a mechanism whereby these private images can be shared between a subset of projects. This allows greater control over images that need to exist for different projects without making them available to all.</p><p class="calibre10">Sharing images among projects requires the following workflow:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Tenant A updates an image's ability to be shared</li><li class="listitem">Tenant A shares an image with Tenant B</li><li class="listitem">Tenant B accepts or rejects the sharing attempt</li></ul></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_14"><a id="ch06lvl2sec249" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When sharing an image, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum, to share the image:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li><li class="listitem">Project name or ID</li></ul></div><p class="calibre10">For our example, the <code class="email">ADMIN</code> project will share an image with the <code class="email">FINANCE</code> project. The following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li><li class="listitem">Project name: <code class="email">FINANCE</code></li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note23" class="calibre1"/>Note</h3><p class="calibre10">For instructions on how to create projects within OpenStack, refer to the <a class="calibre1" title="Chapter 3. Keystone – OpenStack Identity Service" href="part0035_split_000.html#11C3M1-189e69df43a248268db97cde1b1a8e47">Chapter 3</a>, <span class="strong"><em class="calibre18">Keystone – OpenStack Identity Service</em></span>, chapter of this book.</p></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_15"><a id="ch06lvl2sec250" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to share an image with the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Configure the environment with the credentials of a user in the <code class="email">FINANCE</code> project:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">source finance_openrc</strong></span>
</pre></div></li><li class="listitem" value="2">As a user in the <code class="email">FINANCE</code> project, view all available images:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image list</strong></span>
</pre></div><p class="calibre22">The output will resemble the following if no images are available:</p><div class="mediaobject"><img src="../images/00121.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><div class="note" title="Note"><h3 class="title2"><a id="note24" class="calibre1"/>Note</h3><p class="calibre10">In this environment, no images are available to the <code class="email">FINANCE</code> project.</p></div></li><li class="listitem" value="3">Now, configure <a id="id397" class="calibre1"/>the environment with the credentials of a user in the ADMIN project:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">source openrc</strong></span>
</pre></div></li><li class="listitem" value="4">Update the Ubuntu image and make it available for sharing:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set COOKBOOK_UBUNTU_IMAGE --shared</strong></span>
</pre></div><p class="calibre22">No output will be returned.</p></li><li class="listitem" value="5">Share the Ubuntu image with the FINANCE project:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image add project COOKBOOK_UBUNTU_IMAGE FINANCE</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00122.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><div class="note" title="Note"><h3 class="title2"><a id="note25" class="calibre1"/>Note</h3><p class="calibre10">At this point, the user should notify the <code class="email">FINANCE</code> project of the sharing attempt and provide the image ID. In this example, the image ID is <code class="email">d120a923-5246-4dca-8f52-51a951bffce5</code>.</p></div></li><li class="listitem" value="6">Reconfigure <a id="id398" class="calibre1"/>the environment with the credentials of a user in the <code class="email">FINANCE</code> project:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">source finance_openrc</strong></span>
</pre></div></li><li class="listitem" value="7">Accept the sharing attempt:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set d120a923-5246-4dca-8f52-51a951bffce5 --accept</strong></span>
</pre></div><p class="calibre22">No output will be returned.</p></li><li class="listitem" value="8">View all available images:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image list</strong></span>
</pre></div><p class="calibre22">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00123.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Managing images">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_16"><a id="ch06lvl2sec251" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">Sharing images requires the use of the <code class="email">openstack image add project</code> command on the part of the producer and the <code class="email">openstack image set </code>command on the part of the consumer. The process involves communication between the producer and the consumer outside of the OpenStack API, as the image ID must be shared between them.</p><p class="calibre10">Producers <a id="id399" class="calibre1"/>invoke the sharing process using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image add project &lt;image&gt; &lt;project&gt;</strong></span>
</pre></div><p class="calibre10">Once shared, the consumer has the ability to accept or reject the attempt using the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set &lt;image&gt; [--accept | --reject | --pending]</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note26" class="calibre1"/>Note</h3><p class="calibre10">Marking an image as <code class="email">pending</code> makes the image unavailable to users in the consuming project, but leaves open the possibility of making it available at a later time.</p></div><p class="calibre10">The producer can revoke the sharing of an image using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image remove project &lt;image&gt; &lt;project&gt;</strong></span>
</pre></div><p class="calibre10">An alternative to marking an image as shared would be to mark its visibility as <code class="email">community</code> using the <code class="email">--community</code> option. This allows a user to share an image with all projects, but still requires the consuming projects to accept the image before it is returned in an image list. This reduces the administrative overhead on the part of the user sharing the image without unnecessarily cluttering the entire image list for all projects.</p><p class="calibre10">For additional information regarding the sharing of images, visit <a class="calibre1" href="https://docs.openstack.org/image-guide/share-images.html">https://docs.openstack.org/image-guide/share-images.html</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using image snapshots" id="2KS221-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec86" class="calibre1"/>Using image snapshots</h1></div></div></div><p class="calibre10">In OpenStack, a snapshot is an image that reflects the state of an instance at a point in time. Snapshots <a id="id400" class="calibre1"/>are often used to backup instances or migrate instances from one cloud to another, and can even be shared with other projects like regular images.</p></div>

<div class="book" title="Using image snapshots" id="2KS221-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Creating snapshots"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec252" class="calibre1"/>Creating snapshots</h2></div></div></div><p class="calibre10">Snapshots <a id="id401" class="calibre1"/>in OpenStack can be created using the <code class="email">openstack server image create</code> command.</p></div></div>

<div class="book" title="Using image snapshots" id="2KS221-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec253" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When creating a snapshot, ensure that you are authenticated as an administrator or are the owner of the instance. You will need the following details:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Instance name or ID</li><li class="listitem">Image name</li></ul></div><p class="calibre10">For our example, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Instance name: <code class="email">COOKBOOK_TEST_INSTANCE</code></li><li class="listitem">Image: <code class="email">COOKBOOK_TEST_SNAPSHOT_20170824</code></li></ul></div></div></div>

<div class="book" title="Using image snapshots" id="2KS221-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec254" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to create a snapshot with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server image create \</strong></span>
<span class="strong"><strong class="calibre2">--name COOKBOOK_TEST_SNAPSHOT_20171016 \</strong></span>
<span class="strong"><strong class="calibre2">COOKBOOK_TEST_INSTANCE</strong></span>
</pre></div><p class="calibre10">The output will resemble the following:</p><div class="mediaobject"><img src="../images/00124.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Using image snapshots" id="2KS221-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec255" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Images snapshots are created with the following syntax:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server image create [--name &lt;image-name&gt;] \</strong></span>
<span class="strong"><strong class="calibre2">[--wait] \</strong></span>
<span class="strong"><strong class="calibre2">&lt;server&gt;</strong></span>
</pre></div><p class="calibre10">The creation <a id="id402" class="calibre1"/>of a snapshot results in the system writing the instance's disk to a temporary file on the compute node and uploading it to the OpenStack Image service as a new image. When an instance's disk is located on a Ceph backend, the snapshot occurs on the backend itself and the compute node filesystem is not involved. The resulting snapshot/image can then be used to boot new instances within the same cloud, or it can be downloaded and copied to an offline storage system or another cloud.</p><p class="calibre10">The <code class="email">name</code> parameter defines the name of the image when stored in the image repository.</p><p class="calibre10">The <code class="email">&lt;server&gt;</code> parameter defines the name or ID of the instance from which the snapshot is taken.</p><p class="calibre10">When specified, the <code class="email">--wait</code> option forces OpenStack to perform the snapshot in the foreground, meaning the CLI will be unavailable until the task is complete.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using image metadata"><div class="book" id="2LQIK2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec87" class="calibre1"/>Using image metadata</h1></div></div></div><p class="calibre10">Images have <a id="id403" class="calibre1"/>properties known as <span class="strong"><strong class="calibre2">metadata</strong></span> that help describe the image and how it relates to other OpenStack components. The metadata that is applied <a id="id404" class="calibre1"/>to an image can be used to enable specific functionality in other OpenStack services or to determine the scheduling of an instance to a host based on CPU architectures or features, and more.</p></div>

<div class="book" title="Using image metadata">
<div class="book" title="Setting image metadata"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec256" class="calibre1"/>Setting image metadata</h2></div></div></div><p class="calibre10">Image <a id="id405" class="calibre1"/>metadata in OpenStack can be manipulated using the <code class="email">openstack image set</code> command. The <code class="email">--property</code> argument can be used to set additional properties using the <code class="email">key=value</code> pairs.</p></div></div>

<div class="book" title="Using image metadata">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec257" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When setting image metadata, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li><li class="listitem">Property name and value</li></ul></div><p class="calibre10">For our <a id="id406" class="calibre1"/>examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li><li class="listitem">Property name and value: <code class="email">architecture=m68k, os_distro=ubuntu</code></li></ul></div></div></div>

<div class="book" title="Using image metadata">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec258" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to set image metadata with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set COOKBOOK_UBUNTU_IMAGE \</strong></span>
<span class="strong"><strong class="calibre2">--property architecture=m68k \</strong></span>
<span class="strong"><strong class="calibre2">--property os_distro=ubuntu</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. However, using <code class="email">openstack image show</code> will reveal that the properties have been set:</p><div class="mediaobject"><img src="../images/00125.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Using image metadata">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec259" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When image <a id="id407" class="calibre1"/>metadata is set in OpenStack, the properties have an impact on how the system handles instances using that image. Properties such as <code class="email">hypervisor_type</code> and <code class="email">architecture</code> affect how an instance is scheduled to a host, while other properties such as <code class="email">hw_disk_bus</code> and <code class="email">hw_cdrom_bus</code> affect how virtual devices are connected to the instance.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note27" class="calibre1"/>Note</h3><p class="calibre10">In order to schedule instances based on image metadata, be sure to include the <code class="email">'ImagePropertiesFilter'</code> filter in the <code class="email">enabled_filters</code> list in <code class="email">/etc/nova/nova.conf</code>. This is a default in most OpenStack installations, including the environment built in this book.</p></div><p class="calibre10">In this environment, booting an instance using the modified image requiring an architecture of <code class="email">m68k</code> (Motorola 68000) should result in the following error:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">NoValidHost: No valid host was found. There are not enough hosts available.</strong></span>
</pre></div><p class="calibre10">Modifying the image to require <code class="email">x86_64</code> or removing the property altogether should allow the instance to be scheduled according to other defined metadata or environmental defaults.</p><p class="calibre10">A current <a id="id408" class="calibre1"/>list of image metadata properties at time of writing can be found at the following location:</p><p class="calibre10">
<a class="calibre1" href="https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html">https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html</a>
</p></div></div>

<div class="book" title="Using image metadata">
<div class="book" title="Removing image metadata"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec260" class="calibre1"/>Removing image metadata</h2></div></div></div><p class="calibre10">Image <a id="id409" class="calibre1"/>metadata in OpenStack can be removed using the <code class="email">openstack image unset</code> command. The <code class="email">--property</code> argument can be used to unset individual properties.</p></div></div>

<div class="book" title="Using image metadata">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch06lvl2sec261" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When removing image metadata, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li><li class="listitem">Property name</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li><li class="listitem">Property name: <code class="email">architecture</code></li></ul></div></div></div>

<div class="book" title="Using image metadata">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch06lvl2sec262" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to unset image metadata with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image unset COOKBOOK_UBUNTU_IMAGE \</strong></span>
<span class="strong"><strong class="calibre2">--property architecture</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. To verify that the property has been removed, use the <code class="email">openstack image show</code> command.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec88" class="calibre1"/>Protecting images</h1></div></div></div><p class="calibre10">Like other <a id="id410" class="calibre1"/>OpenStack objects, images and snapshots are susceptible to accidental deletion by users. By default, images are unprotected, meaning they can be deleted at any time by a user within a project. The following sections explain how an image can be protected to ensure its survival.</p></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Protecting an image"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec263" class="calibre1"/>Protecting an image</h2></div></div></div><p class="calibre10">Images can <a id="id411" class="calibre1"/>be protected using the <code class="email">openstack image set</code> command with the <code class="email">--protected</code> argument.</p></div></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec264" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When protecting an image, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li></ul></div></div></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec265" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to protect an image with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set COOKBOOK_UBUNTU_IMAGE --protected</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. Use the <code class="email">openstack image show</code> command to reveal the status of the image:</p><div class="mediaobject"><img src="../images/00126.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec266" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When an <a id="id412" class="calibre1"/>image is protected in OpenStack, users are unable to delete the image. Attempting to delete a protected image results in an error similar to the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Failed to delete image with name or ID 'COOKBOOK_UBUNTU_IMAGE': 403 Forbidden: Image d120a923-5246-4dca-8f52-51a951bffce5 is protected and cannot be deleted. (HTTP 403)</strong></span>
<span class="strong"><strong class="calibre2">Failed to delete 1 of 1 images.</strong></span>
</pre></div><p class="calibre10">Protecting an image is a useful step in ensuring that snapshots and other special images remain unharmed in a cloud shared by many users and projects.</p></div></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Unprotecting an image"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec267" class="calibre1"/>Unprotecting an image</h2></div></div></div><p class="calibre10">Images can <a id="id413" class="calibre1"/>be unprotected using the <code class="email">openstack image set</code> command with the <code class="email">--unprotected</code> argument.</p></div></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch06lvl2sec268" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When unprotecting an image, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li></ul></div></div></div>

<div class="book" title="Protecting images" id="2MP361-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch06lvl2sec269" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the <a id="id414" class="calibre1"/>OpenStack client installed on our system, we are now able to unprotect an image with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set COOKBOOK_UBUNTU_IMAGE --unprotected</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. Use the <code class="email">openstack image show</code> command to reveal the status of the image.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec89" class="calibre1"/>Deactivating images</h1></div></div></div><p class="calibre10">By default, images <a id="id415" class="calibre1"/>are available for use immediately upon completion of the uploading process. At times, it may be necessary to deactivate an image to prevent users from booting instances with the image, especially in cases where the image may be outdated but must be retained for archival purposes.</p></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Deactivating an image"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec270" class="calibre1"/>Deactivating an image</h2></div></div></div><p class="calibre10">Images can <a id="id416" class="calibre1"/>be deactivated using the <code class="email">openstack image set</code> command with the <code class="email">--deactivate</code> argument.</p></div></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec271" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When deactivating an image, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li></ul></div></div></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec272" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to deactivate an image with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set COOKBOOK_UBUNTU_IMAGE --deactivate</strong></span>
</pre></div><p class="calibre10">No output <a id="id417" class="calibre1"/>is returned if the operation is successful. Use the <code class="email">openstack image show</code> command to reveal the status of the image:</p><div class="mediaobject"><img src="../images/00127.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec273" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre10">When an image is deactivated in OpenStack, users are unable to boot instances using the image. Attempting to boot an instance with a deactivated image results in an error similar to the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Image d120a923-5246-4dca-8f52-51a951bffce5 is not active. (HTTP 400) (Request-ID: req-fb43f34c-982b-4eeb-abb1-76c93ebc2b5f)</strong></span>
</pre></div><p class="calibre10">Deactivating an image is a useful step in ensuring that images are retained but unusable. Existing instances using the image are not impacted.</p></div></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Activating an image"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec274" class="calibre1"/>Activating an image</h2></div></div></div><p class="calibre10">Deactivated <a id="id418" class="calibre1"/>images can be activated using the <code class="email">openstack image set</code> command with the <code class="email">--activate</code> argument.</p></div></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch06lvl2sec275" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">When activating an image, ensure that you are authenticated as an administrator or are the owner of the image. You will need the following details, at a minimum:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name or ID</li></ul></div><p class="calibre10">For our examples, the following will be used:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">COOKBOOK_UBUNTU_IMAGE</code></li></ul></div></div></div>

<div class="book" title="Deactivating images" id="2NNJO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch06lvl2sec276" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">With the OpenStack client installed on our system, we are now able to activate an image with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image set COOKBOOK_UBUNTU_IMAGE --activate</strong></span>
</pre></div><p class="calibre10">No output is returned if the operation is successful. Use the <code class="email">openstack image show</code> command to reveal the status of the image.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating custom images"><div class="book" id="2OM4A2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec90" class="calibre1"/>Creating custom images</h1></div></div></div><p class="calibre10">Users can <a id="id419" class="calibre1"/>create custom images of various operating systems that can be used within an OpenStack environment. Tools such as <code class="email">cloud-init</code> can be installed in the image to provide a method of bootstrapping an instance once it has been deployed.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note28" class="calibre1"/>Note</h3><p class="calibre10">The use of <code class="email">cloud-init</code> is beyond the scope of this book. More information can be found at <a class="calibre1" href="https://cloud-init.io">https://cloud-init.io</a>.</p></div></div>

<div class="book" title="Creating custom images">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec277" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To begin, ensure that you are using an operating system that is not the OpenStack environment used throughout this book. Software packages and libraries needed to create images may <a id="id420" class="calibre1"/>conflict with the software currently installed, and could result in a broken environment. In this example, we will use a virtual machine configured with Ubuntu 16.04 LTS to create a custom CentOS 7 image.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note29" class="calibre1"/>Note</h3><p class="calibre10">Configuring a virtual machine with the Ubuntu 16.04 LTS operating system is beyond the scope of this book. A physical server can be used in lieu of a virtual machine, if necessary.</p></div><p class="calibre10">The following packages are prerequisites for the host building of the image:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">qemu-kvm</code></li><li class="listitem"><code class="email">libvirt-bin</code></li><li class="listitem"><code class="email">virt-manager</code></li></ul></div><p class="calibre10">Using <code class="email">apt</code>, install the packages with the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt update</strong></span>
<span class="strong"><strong class="calibre2">sudo apt install qemu-kvm libvirt-bin virt-manager</strong></span>
</pre></div></div></div>

<div class="book" title="Creating custom images">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec278" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">Carry out the following steps within the virtual machine to create a custom image:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Change to your home directory and create a kickstart file named <code class="email">ks.cfg</code> with the following contents:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd ~/ </strong></span>
<span class="strong"><strong class="calibre2">install</strong></span>
<span class="strong"><strong class="calibre2">text</strong></span>
<span class="strong"><strong class="calibre2">url --url http://mirror.rackspace.com/CentOS/7/os/x86_64/</strong></span>
<span class="strong"><strong class="calibre2">lang en_US.UTF-8</strong></span>
<span class="strong"><strong class="calibre2">keyboard us</strong></span>
<span class="strong"><strong class="calibre2">network --onboot yes --bootproto dhcp --noipv6</strong></span>
<span class="strong"><strong class="calibre2">timezone --utc America/Chicago</strong></span>
<span class="strong"><strong class="calibre2">zerombr</strong></span>
<span class="strong"><strong class="calibre2">clearpart --all --initlabel</strong></span>
<span class="strong"><strong class="calibre2">bootloader --location=mbr --append="crashkernel=auto"</strong></span>
<span class="strong"><strong class="calibre2">part / --fstype=ext4 --size=1024 --grow</strong></span>
<span class="strong"><strong class="calibre2">authconfig --enableshadow --passalgo=sha512</strong></span>
<span class="strong"><strong class="calibre2">rootpw openstack</strong></span>
<span class="strong"><strong class="calibre2">firewall --disable</strong></span>
<span class="strong"><strong class="calibre2">selinux --disabled</strong></span>
<span class="strong"><strong class="calibre2">skipx</strong></span>
<span class="strong"><strong class="calibre2">shutdown</strong></span>
<span class="strong"><strong class="calibre2">%packages</strong></span>
<span class="strong"><strong class="calibre2">@core</strong></span>
<span class="strong"><strong class="calibre2">openssh-server</strong></span>
<span class="strong"><strong class="calibre2">openssh-clients</strong></span>
<span class="strong"><strong class="calibre2">wget</strong></span>
<span class="strong"><strong class="calibre2">curl</strong></span>
<span class="strong"><strong class="calibre2">git</strong></span>
<span class="strong"><strong class="calibre2">man</strong></span>
<span class="strong"><strong class="calibre2">vim</strong></span>
<span class="strong"><strong class="calibre2">ntp</strong></span>
<span class="strong"><strong class="calibre2">%end</strong></span>
<span class="strong"><strong class="calibre2">%post</strong></span>
<span class="strong"><strong class="calibre2">%end</strong></span>
</pre></div></li><li class="listitem" value="2">Create an <a id="id421" class="calibre1"/>empty 10 GB virtual disk to be used by the CentOS virtual machine:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo qemu-img create -f qcow2 \</strong></span>
<span class="strong"><strong class="calibre2">/var/lib/libvirt/images/centos-7.qcow2 10G</strong></span>
</pre></div></li><li class="listitem" value="3">Execute the following commands to initiate an unattended installation of the CentOS operating system:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo virt-install --virt-type qemu \</strong></span>
<span class="strong"><strong class="calibre2">--name centos-7 \</strong></span>
<span class="strong"><strong class="calibre2">--ram 2048 \</strong></span>
<span class="strong"><strong class="calibre2">--location="http://mirror.rackspace.com/CentOS/7/os/x86_64/" \</strong></span>
<span class="strong"><strong class="calibre2">--disk /var/lib/libvirt/images/centos-7.qcow2,format=qcow2 \</strong></span>
<span class="strong"><strong class="calibre2">--network network=default \</strong></span>
<span class="strong"><strong class="calibre2">--graphics vnc,listen=0.0.0.0 \</strong></span>
<span class="strong"><strong class="calibre2">--noautoconsole \</strong></span>
<span class="strong"><strong class="calibre2">--os-type=linux \</strong></span>
<span class="strong"><strong class="calibre2">--os-variant=centos7.0 \</strong></span>
<span class="strong"><strong class="calibre2">--initrd-inject ks.cfg \</strong></span>
<span class="strong"><strong class="calibre2">--rng /dev/random \</strong></span>
<span class="strong"><strong class="calibre2">--extra-args="inst.ks=file:/ks.cfg console=ttyS0,115200"</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note30" class="calibre1"/>Note</h3><p class="calibre10">If the installation is being performed inside a virtual machine using nested virtualization, you may need to change <code class="email">virt-type</code> to <code class="email">qemu</code> from <code class="email">kvm</code> for the machine to start properly. Use <code class="email">kvm</code> for better performance if the image is being built without nested virtualization.</p></div><p class="calibre22">The output <a id="id422" class="calibre1"/>returned should resemble the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">Starting install...</strong></span>
<span class="strong"><strong class="calibre2">Retrieving file vmlinuz...                  | 5.1 MB  00:00:01</strong></span>
<span class="strong"><strong class="calibre2">Retrieving file initrd.img...               |  41 MB  00:00:07</strong></span>
<span class="strong"><strong class="calibre2">Allocating 'centos-7.0-vm.img'              | 5.0 GB  00:00:00</strong></span>
<span class="strong"><strong class="calibre2">Creating domain...                          |    0 B  00:00:00</strong></span>
<span class="strong"><strong class="calibre2">Domain installation still in progress. You can reconnect to</strong></span>
<span class="strong"><strong class="calibre2">the console to complete the installation process.</strong></span>
</pre></div><p class="calibre22">From the host machine, console to the newly-created CentOS virtual machine and log in as the <code class="email">root</code> user with the <code class="email">openstack</code> password. To escape from the console session, press <span class="strong"><strong class="calibre2">Ctrl</strong></span> + <span class="strong"><strong class="calibre2">]</strong></span>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">virsh console centos-7</strong></span>
</pre></div><p class="calibre22">To refresh <a id="id423" class="calibre1"/>the console, press the <span class="strong"><strong class="calibre2">Enter</strong></span> key. The output will resemble the following:</p><div class="mediaobject"><img src="../images/00128.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><p class="calibre22">The guest should be in the process of booting, and a live console log will be displayed. The installation process is automated and could take a while depending on the resources available to the host performing the build.</p><p class="calibre22">When the installation is complete, the output will resemble the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">[  OK  ] Reached target Shutdown.</strong></span>
<span class="strong"><strong class="calibre2">dracut Warning: Killing all remaining processes</strong></span>
<span class="strong"><strong class="calibre2">Powering off.</strong></span>
<span class="strong"><strong class="calibre2">[ 3388.611074] Power down.</strong></span>
</pre></div><p class="calibre22">The console session should end, and you will be returned to a prompt on the host.</p></li><li class="listitem" value="4">Start the VM with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo virsh start centos-7</strong></span>
</pre></div><p class="calibre22">From the host machine, console to the CentOS virtual machine and log in as the <code class="email">root</code> user with the <code class="email">openstack</code> password. To escape from the console session, press <span class="strong"><strong class="calibre2">Ctrl</strong></span> + <span class="strong"><strong class="calibre2">]</strong></span>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">virsh console centos-7</strong></span>
</pre></div><p class="calibre22">To refresh the console, press the <span class="strong"><strong class="calibre2">Enter</strong></span> key. The output will resemble the following:</p><div class="informalexample"><pre class="programlisting">Connected to domain centos-7
Escape character is ^]

CentOS Linux 7 (Core)
Kernel 3.10.0-693.el7.x86_64 on an x86_64

localhost login: root
Password:
Last login: Wed Aug 30 09:02:14 on tty1
[root@localhost ~]#</pre></div></li><li class="listitem" value="5">In the <a id="id424" class="calibre1"/>guest, install the <code class="email">epel-release</code> and <code class="email">cloud-init</code> packages with the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">yum -y install epel-release</strong></span>
<span class="strong"><strong class="calibre2">yum -y install cloud-init cloud-utils cloud-utils-growpart</strong></span>
</pre></div></li><li class="listitem" value="6">Using a text editor, replace the guest's <code class="email">cloud.cfg</code> file at <code class="email">/etc/cloud/cloud.cfg</code> with the following contents:<div class="informalexample"><pre class="programlisting">users:
- default

disable_root: 1
ssh_pwauth:   0

locale_configfile: /etc/sysconfig/i18n
mount_default_fields: [~, ~, 'auto', 'defaults,nofail', '0', '2']
resize_rootfs_tmp: /dev
ssh_deletekeys:   0

ssh_genkeytypes:  ~
syslog_fix_perms: ~

cloud_init_modules:
- bootcmd
- write-files
- resizefs
- set_hostname
- update_hostname
- update_etc_hosts
- rsyslog
- users-groups
- ssh

cloud_config_modules:
- mounts
- locale
- set-passwords
- timezone
- puppet
- chef
- salt-minion
- mcollective
- disable-ec2-metadata
- runcmd

cloud_final_modules:
- rightscale_userdata
- scripts-per-once
- scripts-per-boot
- scripts-per-instance
- scripts-user
- ssh-authkey-fingerprints
- keys-to-console
- phone-home
- final-message

system_info:
 distro: rhel
 default_user:
   name: centos
   lock_passwd: True
   shell: /bin/bash
   sudo: ["ALL=(ALL) NOPASSWD: ALL"]
 paths:
   cloud_dir: /var/lib/cloud
   templates_dir: /etc/cloud/templates
 ssh_svcname: sshd</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note31" class="calibre1"/>Note</h3><p class="calibre10">The contents of <code class="email">cloud.cfg</code> are constructed in YAML, and are interpreted by <code class="email">cloud-init</code> upon startup. In this example, the default username used to access the instance is <code class="email">centos</code> and no password is set. Instead, an SSH key must be used and will be pushed to the instance via the OpenStack metadata service. Refer to <a class="calibre1" title="Chapter 5. Nova – OpenStack Compute" href="part0062_split_000.html#1R42S1-189e69df43a248268db97cde1b1a8e47">Chapter 5</a>, <span class="strong"><em class="calibre18">Nova – OpenStack Compute</em></span>, for more information.</p></div></li><li class="listitem" value="7">Ensure that the <a id="id425" class="calibre1"/>guest can communicate with the metadata service with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">echo "NOZEROCONF=yes" &gt;&gt; /etc/sysconfig/network</strong></span>
</pre></div></li><li class="listitem" value="8">Remove persistent rules with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">rm -rf /etc/udev/rules.d/70-persistent-net.rules</strong></span>
</pre></div></li><li class="listitem" value="9">Remove machine-specific MAC address and UUID. Edit the <code class="email">/etc/sysconfig/network-scripts/ifcfg-eth0</code> file and remove lines starting with <code class="email">HWADDR</code> and <code class="email">UUID</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sed -i '/HWADDR/d' /etc/sysconfig/network-scripts/ifcfg-eth0</strong></span>
<span class="strong"><strong class="calibre2">sed -i '/UUID/d' /etc/sysconfig/network-scripts/ifcfg-eth0</strong></span>
</pre></div></li><li class="listitem" value="10">After making the changes, ensure that the interface configuration file resembles the following:<div class="informalexample"><pre class="programlisting">NAME="eth0"
ONBOOT="yes"
NETBOOT="yes"
IPV6INIT="no"
BOOTPROTO="dhcp"
TYPE="Ethernet"
DEFROUTE="yes"
PEERDNS="yes"
PEERROUTES="yes"
IPV4_FAILURE_FATAL="no"</pre></div><div class="note" title="Note"><h3 class="title2"><a id="note32" class="calibre1"/>Note</h3><p class="calibre10">If you need IPv6 support, modify the interface file accordingly to ensure that instances using the image can procure their IPv6 address via DHCPv6 or SLAAC.</p></div></li><li class="listitem" value="11">Clean up <a id="id426" class="calibre1"/>various files and directories using the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">yum clean all</strong></span>
<span class="strong"><strong class="calibre2">rm -rf /var/log/*</strong></span>
<span class="strong"><strong class="calibre2">rm -rf /tmp/*</strong></span>
<span class="strong"><strong class="calibre2">history -c</strong></span>
</pre></div></li><li class="listitem" value="12">From within the guest, cleanly shutdown the guest using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">shutdown -h now</strong></span>
</pre></div><p class="calibre22">Once the guest is shutdown, the console session should end and you will be returned to a prompt on the host. Transfer the disk located at <code class="email">/var/lib/libvirt/images/centos-7.qcow2</code> to your home directory, where it can be transferred out of the host and onto a client, where the OpenStack command-line utility is installed. Using the OpenStack client, upload the image to the OpenStack image repository:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image create MY_CENTOS_IMAGE \</strong></span>
<span class="strong"><strong class="calibre2">--disk-format qcow2 \</strong></span>
<span class="strong"><strong class="calibre2">--file ~/centos-7.qcow2</strong></span>
</pre></div><p class="calibre22">The output should resemble the following:</p><div class="mediaobject"><img src="../images/00129.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><p class="calibre22">For more <a id="id427" class="calibre1"/>information on building custom images, visit <a class="calibre1" href="https://docs.openstack.org/image-guide/create-images-manually.html">https://docs.openstack.org/image-guide/create-images-manually.html</a>.</p></li></ol><div class="calibre20"/></div></div></div></body></html>