- en: Understanding Encryption Key Management Strategies
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, you''ll learn to use the three different key deployment models
    to address different compliance requirements and understand what role the Azure
    Key Vault service plays in this. We''ll discuss the three Azure Rights Management
    Services flows for a better understanding of how keys are used in the complete
    **Azure Information Protection** (**AIP**) solution to address the correct implementation
    and to help you troubleshooting the solution. This chapter will be divided into
    the following sections:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Azure Information Protection key basics:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Key deployment models
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: What is a **hardware security module** (**HSM**)?
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: What is the Azure Key Vault?
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'How Azure RMS works under the hood:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Algorithms and key lengths
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: User environment-initialization flow
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Content protection flow
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Content consumption flow
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Let's start with the AIP key basics!
  prefs: []
  type: TYPE_NORMAL
- en: Azure Information Protection key basics
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The Azure **Rights Management Service** (**RMS**) is part of the AIP solution
    of Microsoft. The Rights Management web service provides protection functionality,
    including administration, account certification, and licensing. Certification
    refers to the account certification and activation activities performed by Azure
    RMS. Each user must acquire a set of certificates and associated keys to be able
    to participate. Licensing refers to the set of operations by which Azure RMS grants
    access to protected content to authorized users. The Azure RMS service grants
    a use license (usage rights) for each document to authorized users.
  prefs: []
  type: TYPE_NORMAL
- en: The Azure RMS service exposes **Simple Object Access Protocol** (**SOAP**) interfaces
    that are used by clients to interact with Azure RMS
  prefs: []
  type: TYPE_NORMAL
- en: The Azure Rights Management web service also uses rights management templates,
    which specify a predefined set of rights and conditions that can be applied to
    protect content. In AIP, the rights-management templates are associated with labels.
    To support other classification solutions, rights-management templates can also
    be configured without the association of a label. We already dived into these
    topics in [Chapter 13](bf7343f1-51f5-4e33-a9a6-e6e682e58071.xhtml), *Identifying
    and Detecting Sensitive Data*.
  prefs: []
  type: TYPE_NORMAL
- en: The web service provides by default the needed high availability with a **Service
    Level Agreement** (**SLA**) of 99.9% uptime.
  prefs: []
  type: TYPE_NORMAL
- en: Azure RMS is an Azure service that provides information protection by using
    encryption to help secure documents, files, emails, and other content.
  prefs: []
  type: TYPE_NORMAL
- en: By default, AIP and the rights-management part generate the tenant key and manage
    most aspects of the tenant key life cycle. This is the simplest option with the
    lowest administrative overhead. In most cases, organizations with no additional
    or special security requirements will use this deployment model. They just sign
    up for AIP and the key-management process is handled by Microsoft.
  prefs: []
  type: TYPE_NORMAL
- en: Alternatively, organizations might want to have complete control over their
    tenant key due to security or compliance requirements. For this reason, Microsoft
    provides a separate deployment model called **bring your own key** (**BYOK**).
    Typical customers are based in the insurance or health sector. In this deployment
    model, customers can create hardware- or software-based keys. Hardware-based keys
    will be created on an HSM, which is the recommended option, and will be securely
    transferred to and stored in Azure Key Vault. AIP will be configured to use customer
    keys. Many large organizations already have the hardware, software, and processes
    in place to manage their key material—this is typical on HSM. Most of them prefer
    to extend the HSM infrastructure to the cloud.
  prefs: []
  type: TYPE_NORMAL
- en: The third deployment model is called **hold your own key** (**HYOK**). This
    model requires an isolated on-premise **Active Directory Rights Management Service**
    (**AD RMS**) instance to be installed on a Windows Server. The AD RMS instance
    will work with a different private key to protect secret data. Protection using
    this AD RMS instance is based on labels. AD RMS, by default, doesn't provide any
    labeling capabilities.
  prefs: []
  type: TYPE_NORMAL
- en: 'Choosing between the different models is driven by your organization''s compliance
    requirements, which are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Contracts with your customers with a specific requirement for cryptography and
    audit
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Industry, corporate, and regulation requirements
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Data-sovereignty laws, which bring place regulations and key placement
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Data classification, which defines what sensitive data can't be stored in the
    cloud
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following diagram shows the three deployment models:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/54409845-b171-443d-a501-b43f301227e5.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure RMS deployment models
  prefs: []
  type: TYPE_NORMAL
- en: 'Within the following licenses, you can use the three deployment models:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **Scenario** | **Office 365 E3 or higher** | **AIP P1 or EMS E3/M365 E3**
    | **AIP P2 or EMS E5/M365 E3** |'
  prefs: []
  type: TYPE_TB
- en: '| Microsoft-managed | X | X | X |'
  prefs: []
  type: TYPE_TB
- en: '| BYOK | X | X | X |'
  prefs: []
  type: TYPE_TB
- en: '| HYOK |  |  | X |'
  prefs: []
  type: TYPE_TB
- en: There is also an option to use service encryption with a customer key in Office
    365 to provide and control the encryption keys for your at-rest Office 365 data
    at the application level.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following tenant key actions are available:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **Action** | **Microsoft-managed** | **Customer-managed** |'
  prefs: []
  type: TYPE_TB
- en: '| Revoke |  | X |'
  prefs: []
  type: TYPE_TB
- en: '| Rekey | X | X |'
  prefs: []
  type: TYPE_TB
- en: '| Back up and recover |  | X |'
  prefs: []
  type: TYPE_TB
- en: '| Export | X |  |'
  prefs: []
  type: TYPE_TB
- en: '| Breach response | X | X |'
  prefs: []
  type: TYPE_TB
- en: To find out more about service encryption with Customer Key for Office 365,
    visit [https://bit.ly/2SxCJW5](https://bit.ly/2SxCJW5).
  prefs: []
  type: TYPE_NORMAL
- en: 'Also shown in the preceding diagram are the three keys that matter in the main
    protection flow:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Red**: The tenant private key (asymmetric), which is used for the decryption
    of the publishing license'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Orange**: The tenant public key (asymmetric), which is used for the encryption
    of the publishing license'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Green**: The document-specific key (symmetric), which is used for encryption/decryption
    of the content'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To understand this better, check out the main functionality of the **Rights
    Management Services** in the following diagram:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/2d0e9279-5e7b-4e06-b1fb-c6f64f11f34d.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure RMS basic functionality
  prefs: []
  type: TYPE_NORMAL
- en: 'The process starts with protecting information and ends with consuming it with
    the applied permissions from the data owner or the classification level:'
  prefs: []
  type: TYPE_NORMAL
- en: The document will be created, labeled, and protected with RMS—for this, we need
    to be authenticated against the rights-management service
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The label-associated rights and the key material will be requested transparently
    from the user
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The key material will be received transparently by the user
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The document will be protected with the chosen rights
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The document will be distributed to the required recipients
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The document will be received from the recipient, so the recipient needs to
    be authenticated against the Rights Management Service by Single-Sign-On or Single Login
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The key material and the usage rights will be requested transparent to the recipient
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The key material will be received, and the recipient can access the information
    with the appropriated rights, otherwise the user will get an access denied message
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Be sure to plan your key deployment carefully.
  prefs: []
  type: TYPE_NORMAL
- en: Next, we will discuss the Microsoft-managed key-deployment model.
  prefs: []
  type: TYPE_NORMAL
- en: Microsoft-managed keys
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'If AIP gets activated, a new tenant key be generated, stored, and managed by
    the Azure Information Protection services. In this default case, the key type
    is referred to as a Microsoft-managed key. The following diagram shows the deployment
    model:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/9961f090-c6f5-4336-8200-20143c5d59d1.png)'
  prefs: []
  type: TYPE_IMG
- en: Microsoft Services key model
  prefs: []
  type: TYPE_NORMAL
- en: 'You should use this deployment model if Microsoft''s security and controls
    are adequate for your organization. This model is available by default and doesn''t
    need any additional subscription or configuration. There are also no special plans
    needed for capacity, performance, or scale. For most organizations, this is the
    best option. The deployment model has the following features:'
  prefs: []
  type: TYPE_NORMAL
- en: Completely-managed tenant private key
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tenant private key is encrypted at rest and handled as customer data
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Default key length is 2,048 bit RSA
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Now, we will verify the `Microsoft-managed` key that''s used by our tenant
    with the following cmdlets:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'The following screenshot shows the expected result of a freshly-activated tenant:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/7c255bd4-0a0b-4840-806b-faf635afe55a.png)'
  prefs: []
  type: TYPE_IMG
- en: Actual RMS key information
  prefs: []
  type: TYPE_NORMAL
- en: 'Another important factor is where your Azure RMS service is provisioned for
    choosing an Azure Key Vault location in a BYOK-deployment for latency reasons.
    We can gather this information with the following cmdlet:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'In our case, the Azure RMS tenant is provisioned in Europe, which we can see
    in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8bf78a30-8b1a-4bb1-8038-a42184208f5d.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure RMS actual configuration overview
  prefs: []
  type: TYPE_NORMAL
- en: Next, we will take a deeper look into the BYOK deployment model.
  prefs: []
  type: TYPE_NORMAL
- en: Bring your own key
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: If you use Azure Key Vault to store key, which indicates that you use the BYOK deployment,
    you can import keys from your on-premises HSM or generate keys inside the **Azure
    Key Vault** that are stored in an HSM. Keys never leave the HSM boundaries.
  prefs: []
  type: TYPE_NORMAL
- en: At the time of writing, Microsoft provides a public preview using dedicated
    HSMs. You can find more information at [https://bit.ly/2KFnJT7](https://bit.ly/2KFnJT7).
  prefs: []
  type: TYPE_NORMAL
- en: 'You should use the **BYOK** deployment model if you need to fulfill additional
    compliance requirements, such as data residency or specific cryptographic regulations.
    The following diagram shows the architecture of the deployment:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/419b751c-c4fb-4b44-8bf6-3e96cb205085.png)'
  prefs: []
  type: TYPE_IMG
- en: Bring your own key model
  prefs: []
  type: TYPE_NORMAL
- en: 'The following key facts are related to BYOK:'
  prefs: []
  type: TYPE_NORMAL
- en: Azure Information Protection doesn't have visibility over the private key; there
    is a clear separation of duties with the usage of **Azure Key Vault**
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Cryptographic operations are done completely within Azure Key Vault
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The tenant private key is stored in Azure Key Vault
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: With the configuration part, we'll take a closer look at HSMs and the Azure
    Key Vault. We'll configure our Azure-Key-Vault-based key and change to the BYOK
    deployment.
  prefs: []
  type: TYPE_NORMAL
- en: What is an HSM?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'HSMs are physical devices that provide a hardened, tamper-resistant environment
    to manage and securely store digital keys used in Azure RMS and other applications.
    HSMs provide organizations with the ability to securely manage their private keys
    on-premises. The following diagram, provided by Thales, shows the BYOK-integration
    scenario:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/278c4371-22ea-47e9-8051-aebd1fe62542.png)'
  prefs: []
  type: TYPE_IMG
- en: Thales HSM integration
  prefs: []
  type: TYPE_NORMAL
- en: 'The following table provides a summary of the benefits of implementing a **Thales** HSM
    in the Azure RMS deployment:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **Secure key storage** | HSMs provide a tamper-resistant environment for
    the storage of private keys. All Thales HSMs are certified to meet the highest
    security standards. |'
  prefs: []
  type: TYPE_TB
- en: '| **Compliance** | HSMs are FIPS 140-2 Level 3 Standard, which is the most
    widely accepted benchmark for hardware security in both enterprise and government
    environments. |'
  prefs: []
  type: TYPE_TB
- en: '| **Extensibility** | Using a Thales HSM for key storage allows the Azure RMS
    environment to be extensible to on-premises for future migrations. |'
  prefs: []
  type: TYPE_TB
- en: You can also use Gemalto HSMs for this scenario. You can find an example at [https://bit.ly/2GW3t1d](https://bit.ly/2GW3t1d).
  prefs: []
  type: TYPE_NORMAL
- en: What is the Azure Key Vault?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Azure Key Vault can be best described as a Key Management Service that is based
    on FIPS 140-2 validated HSMs, which also provides secrets and certificate-management
    services. Azure Key Vault is used for Azure RMS BYOK deployments. The service
    itself provides the following capabilities:'
  prefs: []
  type: TYPE_NORMAL
- en: Centralized secret management
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Compliance through Software/Hardware HSM protection
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Read/Write management over REST API/SDK/PowerShell and CLI
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Access and usage monitoring
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Automated distribution, logging inspection, and deployments
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Throttling and Versioning
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: SLA 99.9% and 6 persistent copies (3 copies same region/3 additional copies
    secondary region)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: For Azure RMS and BYOK, you need to use the P1 Premium option to import your
    keys from on-premises or create keys directly in Azure Key Vault. The term BYOK
    is used both times. For production environments, we recommend using an on-premises
    HSM, and you can work through the following source to configure your environment: [https://bit.ly/2wma4Yl](https://bit.ly/2wma4Yl).
  prefs: []
  type: TYPE_NORMAL
- en: For demonstration purposes, we are using keys that were generated in Azure Key
    Vault, because we don't think you want to invest many thousands of dollars into
    your personal HSM.
  prefs: []
  type: TYPE_NORMAL
- en: 'Perform the following steps to test the BYOK deployment in your demo environment:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Open [https://portal.azure.com](https://portal.azure.com) as a global administrator,
    choose Key Vaults, and click Create key vault:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/da90872a-1a67-4eea-ac16-170218a972e0.png)'
  prefs: []
  type: TYPE_IMG
- en: Key Vault creation
  prefs: []
  type: TYPE_NORMAL
- en: 'Fill in the following information:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Use the Premium Pricing Tier
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Use the Location near your service to avoid network-latency issues
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Leave the access policy and the Virtual Network Access defaults for now:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/c352eb16-6bed-43e7-8377-4074ea134e21.png)'
  prefs: []
  type: TYPE_IMG
- en: Key Vault properties
  prefs: []
  type: TYPE_NORMAL
- en: 'Generate the key using the Generate/Import option:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c0963dae-1e9e-4b6e-bb17-e10aa3655aee.png)'
  prefs: []
  type: TYPE_IMG
- en: Key creation process
  prefs: []
  type: TYPE_NORMAL
- en: 'Use the following options:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Key Type RSA-HSM with a key size of 2048 bit
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Copy the Key Identifier to a notepad for later:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/684f2f09-db3c-44a7-a284-b47eb8d2b0e1.png)'
  prefs: []
  type: TYPE_IMG
- en: Key properties
  prefs: []
  type: TYPE_NORMAL
- en: 'Add the Microsoft Rights Management Services principal to your access policy:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/4db5ecbe-4627-429e-9f87-db3c50828dba.png)'
  prefs: []
  type: TYPE_IMG
- en: Service Principal assignment
  prefs: []
  type: TYPE_NORMAL
- en: 'Assign the following minimal permissions:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Key Management Operations: Get and List'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Cryptographic Operations: Decrypt and Sign:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/e20b30bf-7940-4c3a-b531-9b3171c1b539.png)'
  prefs: []
  type: TYPE_IMG
- en: Permission assignment
  prefs: []
  type: TYPE_NORMAL
- en: 'Optionally, you can limit the access to your vault by using a new feature set—a
    firewall in front:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/f10df736-5afd-4ec9-8f55-f184db6ade95.png)'
  prefs: []
  type: TYPE_IMG
- en: Key Vault firewall options
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the `Azure RMS` service to use our freshly-created key:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'The output of the preceding command will look as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/76d1a0b0-b8bf-4aaf-a2b6-5b43cc1b0c7b.png)'
  prefs: []
  type: TYPE_IMG
- en: Change key usage to the newly created one
  prefs: []
  type: TYPE_NORMAL
- en: 'Set the key to the `Active` state:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'The output of the preceding command will look as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/d6cc9724-e938-4e0e-b719-9df5abd1b922.png)'
  prefs: []
  type: TYPE_IMG
- en: Activating the key
  prefs: []
  type: TYPE_NORMAL
- en: 'Your Azure Key Vault stored key is in use:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/d26a3710-65c4-4f57-b045-a2a3a21a25ba.png)'
  prefs: []
  type: TYPE_IMG
- en: Actual used keys overview
  prefs: []
  type: TYPE_NORMAL
- en: 'You can change back to the `Microsoft-managed key` with the following command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Now that we know about HSMs, Azure Key Vault, and how to configure a BYOK deployment,
    we'll jump into the HYOK deployment model in the next section.
  prefs: []
  type: TYPE_NORMAL
- en: Hold your own key
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: HYOK uses an isolated on-premises AD RMS instance that provides the RMS templates
    based on the second different private key that's driven by an AIP label. This
    deployment model should be chosen for high security and compliance requirements.
  prefs: []
  type: TYPE_NORMAL
- en: 'Most of the time, this us used for data that can''t be stored on a public cloud.
    This sensitive data needs to be stored and protected on-premises. Keep in mind
    that HYOK-protected data is typically between 3 to 5% of an organization''s protected
    data. The following diagram shows the deployment model:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ff76c651-8232-49a3-b1a5-ff21edc231f4.png)'
  prefs: []
  type: TYPE_IMG
- en: Hold your own key model
  prefs: []
  type: TYPE_NORMAL
- en: 'The following limitations/benefits are available by design:'
  prefs: []
  type: TYPE_NORMAL
- en: External sharing configuration isn't available through the Azure Information
    Protection service
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: External sharing is only possible in a controlled manner with known and named
    partners
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Office 365 services cannot provide indexing or search capabilities; Exchange
    Online transport rules and Office 365 DLP can't decrypt the content and inspect
    it
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Sharing and the access logs aren't disclosed to anyone
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Data remains encrypted always, inaccessible even to Microsoft services
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To use the on-premises AD RMS infrastructure in your AIP labels, you need to
    choose the HYOK (AD RMS) option in the protection options. You can choose between
    two options:'
  prefs: []
  type: TYPE_NORMAL
- en: Set AD RMS template details (template GUID and licensing URL)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Set user-defined permissions (Preview)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following screenshot shows the template-based approach:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/366df71f-23dc-4b35-8651-3d10ecda6d0f.png)'
  prefs: []
  type: TYPE_IMG
- en: HYOK template configuration in a label
  prefs: []
  type: TYPE_NORMAL
- en: To configure the HYOK deployment in your demo environment, we'll need to add
    an additional virtual machine to your existing domain to install and configure
    AD RMS.
  prefs: []
  type: TYPE_NORMAL
- en: 'Keep in mind that the following configuration is just for proof-of-concept
    or demo purposes:'
  prefs: []
  type: TYPE_NORMAL
- en: For production environments, we recommend that you use a SQL Server for AD RMS
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use the identity federation option to support external sharing if needed
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Use a dedicated administrative account
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Publish the service endpoints through a firewall or reverse proxy
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'With the following steps, we start the configuration of a local AD RMS infrastructure:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a Windows Server 2016/2019 Server virtual machine like the following:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/4be0d6b5-c129-4bee-89b3-60acca7e23bf.png)'
  prefs: []
  type: TYPE_IMG
- en: VM creation to hold the AD RMS service
  prefs: []
  type: TYPE_NORMAL
- en: Create a CNAME entry in your public DNS configuration—in our example, this is
    it's `rms.inovitdemos.ch CNAME inodemosrms01.westeurope.cloudapp.azure.com`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open the virtual machine directly for HTTPS (PoC/Demo):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/0eb7cb33-87a7-4a07-a596-8dba8c84036a.png)'
  prefs: []
  type: TYPE_IMG
- en: Firewall configuration to accept HTTPS traffic on the VM
  prefs: []
  type: TYPE_NORMAL
- en: 'You need a public SSL certificate at least with the RMS cluster URL included:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We use a wildcard certificate—`*.inovitdemos.ch`
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Be sure that you join your virtual machine to your domain and install the certificate
    into the local machine store! For demo purposes, you can also run with an HTTP
    configuration.
  prefs: []
  type: TYPE_NORMAL
- en: Prepare the Active Directory objects as a domain administrator on the domain
    controller for the configuration.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create the RMS cluster service account:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Create the RMS superusers group and apply an email address to recover protected
    data:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Create a test group such as `Executives`, for the RMS template and configure
    an email address—fill in the group with the users you want to test:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'Create an internal DNS entry for your RMS endpoints:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: Log in as a domain administrator to the new server that's hosting the AD RMS
    server.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open the server manager and add the Active Directory Rights Management Services:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Click Add Features:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/edc065c6-2efb-451c-85b6-6b674f69e576.png)'
  prefs: []
  type: TYPE_IMG
- en: AD RMS role installation
  prefs: []
  type: TYPE_NORMAL
- en: 'Leave all the defaults as is and click Next:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/d8021a23-bbd9-4812-a20e-13771e6ff174.png)'
  prefs: []
  type: TYPE_IMG
- en: Role service installation
  prefs: []
  type: TYPE_NORMAL
- en: Configure AD RMS by clicking Next on the welcome screen.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create the RMS cluster ("cluster" is a specific term in AD RMS that indicates
    that you can have more than one RMS server—it doesn''t mean a Windows Server cluster):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/ec0277ca-ba87-4457-99ae-75fe4eedcf05.png)'
  prefs: []
  type: TYPE_IMG
- en: RMS cluster creation process
  prefs: []
  type: TYPE_NORMAL
- en: 'Choose the database deployment—for production environments, use a dedicated
    SQL server:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/25547208-8dec-4746-90ad-981c0e887b96.png)'
  prefs: []
  type: TYPE_IMG
- en: Database configuration for the AD RMS cluster
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the service account we created previously, that is, `svcrmscluster@inovitdemos.ch`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/38bfb0f8-6cf7-4255-987f-b418bebcb330.png)'
  prefs: []
  type: TYPE_IMG
- en: Service account usage for AD RMS
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the following options, as follows:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Cryptographic Mode: Mode 2'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Cluster Key Storage: Use AD RMS'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Cluster Key Password: Choose your cluster key word like `455A#aasdd+!`'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Cluster Web Site: Use the default website'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Configure the cluster address:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/06306972-cb8c-40e4-af96-f1286e2353e4.png)'
  prefs: []
  type: TYPE_IMG
- en: AD RMS Cluster address configuration
  prefs: []
  type: TYPE_NORMAL
- en: If you don't want to use HTTPS, change to HTTP for PoC/Demo purposes.
  prefs: []
  type: TYPE_NORMAL
- en: Choose your certificate if you configured HTTPS in the previous step.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Give your Licensor Certificate a name. We recommend using the organization name,
    such as `INOVITDEMOS`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Don't register the SCP. If you're already on an existing infrastructure, you
    must change the option to not use an SCP.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'We''ve almost finished the configuration of our AD RMS instance. We need to
    log out and log in again to complete the configuration:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/9d418f1a-406f-49d7-9d40-6172c2cb2fe9.png)'
  prefs: []
  type: TYPE_IMG
- en: AD RMS Installation result overview
  prefs: []
  type: TYPE_NORMAL
- en: Configure the last options by opening the AD RMS management console.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open Properties and configure the Extranet URLs, like the Intranet URLs:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/764dc3ab-bf1d-4823-87c9-315f22d9bc5b.png)'
  prefs: []
  type: TYPE_IMG
- en: Configuring AD RMS Extranet URLs
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the AD RMS Super User Group:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/56941b59-7fb1-4e6c-9bb6-e20d96e8348c.png)'
  prefs: []
  type: TYPE_IMG
- en: Providing the AD RMS Super User group
  prefs: []
  type: TYPE_NORMAL
- en: 'Open the registry editor to set the GICURL REG_SZ entry—`http or https rms
    cluster name /_wmcs/certification/certification.asmx`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/04f1ada6-a04a-42dd-82ab-42aba642e96b.png)'
  prefs: []
  type: TYPE_IMG
- en: Setting the HYOK registry keys
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the RMS Template for HYOK:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/3c698b72-f1af-4807-9494-11c9c9a1f0a9.png)'
  prefs: []
  type: TYPE_IMG
- en: HYOK RMS template settings
  prefs: []
  type: TYPE_NORMAL
- en: 'Define some example rights and the group you created previously to test its
    functionality:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/da75aade-9e73-4295-9e82-c2b7e47b5645.png)'
  prefs: []
  type: TYPE_IMG
- en: Assignment of the executive's group
  prefs: []
  type: TYPE_NORMAL
- en: Finish the configuration and open a PowerShell to gather the related information
    so that you can configure the Azure Information Protection label.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Run the following commands to get the RMS template GUID:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'Log into [https://portal.azure.com](https://portal.azure.com) to configure
    a new sub-label to test the HYOK configuration—add a new sub-label under Highly
    Confidential:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/233bb822-fa4f-48ac-b258-304f2ff1602b.png)'
  prefs: []
  type: TYPE_IMG
- en: AIP Global Policy overview
  prefs: []
  type: TYPE_NORMAL
- en: 'Configure the label so:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/788bb88f-b896-4c00-9a6d-25b5a606712d.png)'
  prefs: []
  type: TYPE_IMG
- en: Configuring the HYOK label
  prefs: []
  type: TYPE_NORMAL
- en: 'Enable the new sub-label for the global policy, which the test users will be
    able to choose:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/cbad3039-14b8-48b6-808d-ffda148a6f71.png)'
  prefs: []
  type: TYPE_IMG
- en: Adding the label to the global policy
  prefs: []
  type: TYPE_NORMAL
- en: Open one of the Azure-Information-Protection-enabled internal domain-joined
    test clients from [Chapter 13](bf7343f1-51f5-4e33-a9a6-e6e682e58071.xhtml), *Identifying
    and Detecting Sensitive Data*.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a new document and choose the HYOK label. Save the document and you
    should get the following message the first time you use the new label:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/754a42a5-c62f-4729-9edc-f3a0174d708a.png)'
  prefs: []
  type: TYPE_IMG
- en: First-time use message for the local RMS template
  prefs: []
  type: TYPE_NORMAL
- en: 'The document should be protected with the HYOK RMS template permissions:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/bc14993e-71a9-4ac5-b567-73366ad96c21.png)'
  prefs: []
  type: TYPE_IMG
- en: HYOK protected document
  prefs: []
  type: TYPE_NORMAL
- en: You've successfully implemented an HYOK deployment in your test environment.
    Now that we've had a complete walk-through for all three deployment methods, we'll
    take a closer look at the Azure RMS functionality itself.
  prefs: []
  type: TYPE_NORMAL
- en: How Azure RMS works under the hood
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: It's quite important to how RMS works it delivers the data protection service
    of the complete Azure Information Protection solution. First of all, the protected
    data will never be transferred to the Azure Information Protection or Rights Management
    service itself. Basically, the data is encrypted at the application level and
    includes a policy that defines who is authorized and which usage rights are applied
    for these users. Keep in mind that group memberships are cached for three hours.
    So, if you change permissions, remember this to avoid misinterpreted results.
    To get a better understanding of the three typical flows, let's explore the flows
    in this section. But first, we'll look at the algorithms and key lengths used
    by Azure RMS.
  prefs: []
  type: TYPE_NORMAL
- en: Algorithms and key lengths
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Azure RMS uses the following cryptographic controls in the different usage
    scenarios. The following table gives you the needed information if you get asked
    in a project or workshop:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **Cryptographic controls** | **Azure RMS usage** |'
  prefs: []
  type: TYPE_TB
- en: '| **Algorithm**: AES **Key length**: 128/256 bits | Documentation protection**Used
    by**:'
  prefs: []
  type: TYPE_NORMAL
- en: Azure Information Protection client
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Rights Management sharing application
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: '| **Algorithm**: RSA**Key length**: 2,048 bits/*1,024 bits | Key protection'
  prefs: []
  type: TYPE_NORMAL
- en: Migration from AD RMS running Cryptographic Mode 1
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Migration with AD RMS and Exchange Online usage
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Archived keys (on-premises) before the migration
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'BYOK supports 1024/2048 bits - recommended: 2,048 bits'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: '| SHA-256 | Certificate-signing |'
  prefs: []
  type: TYPE_TB
- en: Now that we have a clear picture of the cryptographic controls, we can go further
    into the first use flow, or user environment-initialization.
  prefs: []
  type: TYPE_NORMAL
- en: User environment-initialization flow
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The user environment-initialization is also called the bootstrapping process.
    The process starts when the Azure Information Protection client is installed on
    the client and a user opens an Office application, for example. It runs if a user
    consumes protected content or protects a newly-created document.
  prefs: []
  type: TYPE_NORMAL
- en: Keep in mind that if the user moves to another machine or another user uses
    the same machine, the process always runs the first time it's used.
  prefs: []
  type: TYPE_NORMAL
- en: 'During this process, many things happen in the background, and if the user
    is provided by Single-Sign-On in a federated environment, they don''t recognize
    the steps overall. After a successful authentication to the RMS service, the three
    main certificates will be received:'
  prefs: []
  type: TYPE_NORMAL
- en: The Security Processor Certificate (SPC)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Client Licensor Certificate (CLC)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Rights Account Certificate (**RAC**), formerly known as Group Identity Certificate
    (GIC)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: These are all valid for 31 days and authenticate the user to the Azure Active
    Directory.
  prefs: []
  type: TYPE_NORMAL
- en: Also, the Rights Management templates from the organization will be received.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows the main components during this process:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/41f1e112-fb62-472b-8600-81588cdf84d7.png)'
  prefs: []
  type: TYPE_IMG
- en: Main components and actors on the bootstrapping process
  prefs: []
  type: TYPE_NORMAL
- en: Many other things happen during this process. If you need more details about
    the bootstrap process, you can find them at [https://bit.ly/2FbcxNt](https://bit.ly/2FbcxNt)
    and [https://bit.ly/2RxtcRR](https://bit.ly/2RxtcRR).
  prefs: []
  type: TYPE_NORMAL
- en: 'Here are some other helpful sources:'
  prefs: []
  type: TYPE_NORMAL
- en: '**AIP Client Admin Guide**: [https://bit.ly/2Txpoxr](https://bit.ly/2Txpoxr)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '***Th*e Evolution of AD RMS to Azure Information Protection Part 6 by Matt
    Felton**: [https://bit.ly/2AwGR1Q](https://bit.ly/2AwGR1Q)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Logging and analyzing usage**:[ https://bit.ly/2RdJ3Wf](https://bit.ly/2RdJ3Wf)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Next, we'll look into the content-protection flow.
  prefs: []
  type: TYPE_NORMAL
- en: Content-protection flow
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The next is the content-protection flow, which is that happens if a user protects
    a document or email. The RMS client creates a random content key and encrypts
    the document using an AES symmetric-encryption algorithm. The flow is shown in
    full in the following diagram. Let''s highlight just a few points:'
  prefs: []
  type: TYPE_NORMAL
- en: The main attribute to identify users or groups is the `ProxyAddresses` attribute;
    always keep old email addresses to be able to use older protected content
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the `ProxyAddresses` are empty, `UserPrincipalName` will be used instead
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The RMS client uses the organization's key to encrypt the policy and the content
    key
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The RMS client signs the policy with the user's certificate
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The protection level stays always with the content
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In the following diagram, you can see the content-protection flow:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/4e9d2804-7323-4934-8e21-8a6c840b9e7d.png)'
  prefs: []
  type: TYPE_IMG
- en: Content-protection flow
  prefs: []
  type: TYPE_NORMAL
- en: Next, we will jump into the content-consumption flow.
  prefs: []
  type: TYPE_NORMAL
- en: Content-consumption flow
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Content consumption happens if a user tries to open an RMS-protected document
    or email. The process always starts by requesting access to the Azure Rights Management
    service. Let''s highlight the most important points:'
  prefs: []
  type: TYPE_NORMAL
- en: The authenticated user sends the document policy and the user's certificates
    to the Azure Rights Management service
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The policy will be decrypted and evaluated by the service
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The service builds the rights for every user identification through the `ProxyAddresses`
    or `UserPrincipalName` attribute
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The content key gets extracted from the decrypted policy; the key will be encrypted
    with the user's public key
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The encrypted use license contains the re-encrypted content key
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The RMS client decrypts the encrypted use license with its own private key
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The RMS client decrypts the documents body and the rights list will be enforced
    by the application
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following view shows the content-consumption flow:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/5e60023f-96e8-486e-984d-850718e7fc5d.png)'
  prefs: []
  type: TYPE_IMG
- en: Content-consumption flow
  prefs: []
  type: TYPE_NORMAL
- en: With this flow, we've finished our journey through the Azure RMS flows. Well
    done!
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you received all the necessary information to map your requirements
    to the correct key-deployment model. We looked at the pros and cons of using HYOK.
    With the provided configuration examples, we gathered practical experience, which
    you can now share or use in your next project or workshop. We learned about the
    main Azure RMS flows, which are helpful in understanding how Azure RMS works under
    the hood. You can use this knowledge to support deployments or troubleshoot common
    issues because many errors happen on the environment-initialization (bootstrapping)
    process or in the deployment.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we'll finish configuring the example Azure Information
    Protection solution, and then you'll be fully prepared for your journey with this
    nice technology.
  prefs: []
  type: TYPE_NORMAL
