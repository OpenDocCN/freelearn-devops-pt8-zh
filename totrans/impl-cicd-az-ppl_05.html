<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer158">
<h1 class="chapter-number" id="_idParaDest-63"><a id="_idTextAnchor063"/>5</h1>
<h1 id="_idParaDest-64"><a id="_idTextAnchor064"/> Implementing the Build Pipeline Using Deployment Tasks</h1>
<p>In the previous chapter, we created a pipeline using YAML, and we learned the process of creating jobs and tasks in the YAML format and exporting and importing a build pipeline. This chapter will dive deep into creating a pipeline using standard tasks. By the end of this chapter, you will have learned how to create a build pipeline for web application development, including Node.js, .NET Core, Docker, and Microsoft SQL Server, both on-premises and in Azure, using beginner-friendly tasks that make it easy to understand <span class="No-Break">the concept.</span></p>
<p>We will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Working with Node.js and <strong class="bold">Node Package Manager</strong> (<span class="No-Break"><strong class="bold">NPM</strong></span><span class="No-Break">) tasks</span></li>
<li>Working with .NET Core <span class="No-Break">CLI tasks</span></li>
<li>Working with <span class="No-Break">Docker tasks</span></li>
<li>Working with SQL Server <span class="No-Break">deployment tasks</span></li>
</ul>
<p>Let’s start by learning how to create a pipeline using Node.js and <span class="No-Break">NPM tasks.</span></p>
<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/>Working with Node.js and NPM tasks</h1>
<p>You need to use <a id="_idIndexMarker210"/>Node.js and<a id="_idIndexMarker211"/> NPM commands to build and deploy Node.js applications. There are many predefined tasks to build such applications in an Azure pipeline. Follow these steps to create a pipeline using Node.js and <span class="No-Break">NPM tasks:</span></p>
<ol>
<li>After logging in to the Azure DevOps portal, select your organization, navigate to the <strong class="bold">Pipelines</strong> page, and click on <span class="No-Break"><strong class="bold">New pipeline</strong></span><span class="No-Break">:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer139">
<img alt="Figure 5.1 – A new pipeline" height="516" src="image/B18875_05_1.jpg" width="1205"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.1 – A new pipeline</p>
<ol>
<li value="2">Select <strong class="bold">Azure Repos Git</strong>, which <a id="_idIndexMarker212"/>is a source code repository for <span class="No-Break">this </span><span class="No-Break"><a id="_idIndexMarker213"/></span><span class="No-Break">demo:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer140">
<img alt="Figure 5.2 – Selecting Azure Repos Git" height="518" src="image/B18875_05_2.jpg" width="964"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.2 – Selecting Azure Repos Git</p>
<ol>
<li value="3">Select<a id="_idIndexMarker214"/> the <strong class="bold">PacktAzureDevOps</strong> repository that we<a id="_idIndexMarker215"/> created in <a href="B18875_02.xhtml#_idTextAnchor034"><span class="No-Break"><em class="italic">Chapter 2</em></span></a><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer141">
<img alt="Figure 5.3 – Selecting a repository" height="706" src="image/B18875_05_3.jpg" width="745"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.3 – Selecting a repository</p>
<ol>
<li value="4">Click on <span class="No-Break"><strong class="bold">Show more</strong></span><span class="No-Break">:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer142">
<img alt="Figure 5.4 – Showing more tasks" height="493" src="image/B18875_05_4.jpg" width="933"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.4 – Showing more tasks</p>
<ol>
<li value="5">Select the <span class="No-Break"><strong class="bold">Node.js</strong></span><span class="No-Break"> option:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<img alt="Figure 5.5 – Selecting Node.js" height="868" src="image/B18875_05_5.jpg" width="816"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.5 – Selecting Node.js</p>
<ol>
<li value="6">You can <a id="_idIndexMarker216"/>rename the<a id="_idIndexMarker217"/> default filename, which is <strong class="source-inline">azure-pipelines-1.yml</strong>, by clicking on it and changing it <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">node.yml</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer144">
<img alt="Figure 5.6 – Editing the name of the file" height="656" src="image/B18875_05_6.jpg" width="793"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.6 – Editing the name of the file</p>
<ol>
<li value="7">Click on <strong class="bold">Save and run</strong> | <span class="No-Break"><strong class="bold">Save</strong></span><span class="No-Break">:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<img alt="Figure 5.7 – Saving a pipeline file" height="673" src="image/B18875_05_7.jpg" width="964"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.7 – Saving a pipeline file</p>
<p>After you select <a id="_idIndexMarker218"/>a template of Node.js and NPM tasks, you can continue <a id="_idIndexMarker219"/>changing the default NPM command that matches your Azure pipeline, such as which version of Node.js you need. The following section will show you how to create tasks for .<span class="No-Break">NET Core.</span></p>
<h1 id="_idParaDest-66"><a id="_idTextAnchor066"/>Working with .NET Core CLI tasks</h1>
<p>For .NET applications, you<a id="_idIndexMarker220"/> must use .NET Core CLI commands to build and deploy .NET applications. There are many predefined tasks to build .NET applications in an Azure pipeline. Follow these steps to create a pipeline using .NET Core <span class="No-Break">CLI tasks:</span></p>
<ol>
<li>Follow <em class="italic">steps 1 to 3</em> from the previous section for Node.js and <span class="No-Break">NPM tasks.</span></li>
<li>Select <span class="No-Break"><strong class="bold">Starter pipeline</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer146">
<img alt="Figure 5.8 – Selecting the Starter pipeline option" height="484" src="image/B18875_05_8.jpg" width="906"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.8 – Selecting the Starter pipeline option</p>
<ol>
<li value="3">Rename the file from the default name to make it easier to understand what the YAML file <span class="No-Break">is for:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<img alt="Figure 5.9 – Renaming a pipeline file" height="900" src="image/B18875_05_9.jpg" width="1248"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.9 – Renaming a pipeline file</p>
<ol>
<li value="4">Select the <strong class="bold">Use .NET Core</strong> task <a id="_idIndexMarker221"/>and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Add</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer148">
<img alt="Figure 5.10 – Selecting the Use .NET Core task" height="560" src="image/B18875_05_10.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.10 – Selecting the Use .NET Core task</p>
<ol>
<li value="5">Update the <strong class="source-inline">version</strong> property to use .<span class="No-Break">NET 6:</span></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<img alt="Figure 5.11 – Updating the .NET version" height="659" src="image/B18875_05_11.jpg" width="830"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.11 – Updating the .NET version</p>
<ol>
<li value="6">Select the <strong class="bold">.NET Core</strong> task <a id="_idIndexMarker222"/>and click <span class="No-Break">on </span><span class="No-Break"><strong class="bold">Add</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer150">
<img alt="Figure 5.12 – Selecting the .NET Core task" height="642" src="image/B18875_05_12.jpg" width="1542"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.12 – Selecting the .NET Core task</p>
<ol>
<li value="7">Review the<a id="_idIndexMarker223"/> two predefined .<span class="No-Break">NET tasks:</span><ul><li><strong class="source-inline">UseDotNet@2</strong> is used to install the .NET compiler <span class="No-Break">version 6.0.x</span></li><li><strong class="source-inline">DotNetCoreCLI@2</strong> is the .NET command to run a specific command, which is the <span class="No-Break"><strong class="source-inline">build</strong></span><span class="No-Break"> command</span></li></ul><p class="list-inset">These are shown in the <span class="No-Break">following screenshot:</span></p></li>
</ol>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<img alt="Figure 5.13 – A view of the .NET Core build task" height="720" src="image/B18875_05_13.jpg" width="840"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.13 – A view of the .NET Core build task</p>
<p>After you create a starter task for the .NET CLI command, you can continue to customize your tasks by using the <strong class="source-inline">DotNetCoreCLI@2</strong> command, which specifies the <strong class="source-inline">build</strong> command to be used<a id="_idIndexMarker224"/> to build the .NET application, from source code to the .NET binary files. The following section will show you how to work with Docker tasks for <span class="No-Break">containerized applications.</span></p>
<h1 id="_idParaDest-67"><a id="_idTextAnchor067"/>Working with Docker tasks</h1>
<p>For cloud-native applications, you<a id="_idIndexMarker225"/> need to use Docker commands to build and deploy cloud-native applications. There are many predefined tasks for building cloud-native applications in an Azure pipeline. You can perform the following steps to create a pipeline using <span class="No-Break">Docker tasks:</span></p>
<ol>
<li>Follow <em class="italic">steps 1 to 4</em> as described in the previous section for .NET Core <span class="No-Break">CLI tasks.</span></li>
<li>Rename the file for the <span class="No-Break">Docker pipeline:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer152">
<img alt="Figure 5.14 – Renaming the file" height="924" src="image/B18875_05_14.jpg" width="1464"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.14 – Renaming the file</p>
<ol>
<li value="3">Select the <strong class="bold">Docker CLI installer</strong> task, click on <strong class="bold">Add</strong>, and <span class="No-Break">update </span><span class="No-Break"><strong class="source-inline">DockerInstaller@0</strong></span><span class="No-Break">:</span><pre class="source-code">
- task: DockerInstaller@0
  inputs:
    dockerVersion: '17.09.0-ce'</pre><p class="list-inset">The following<a id="_idIndexMarker226"/> screenshot shows you how to add a <strong class="bold">Docker CLI installer</strong> task and fill in the details on <span class="No-Break">this task:</span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer153">
<img alt="Figure 5.15 – Adding a Docker CLI installer task" height="440" src="image/B18875_05_15.jpg" width="1009"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.15 – Adding a Docker CLI installer task</p>
<ol>
<li value="4">Select the <strong class="bold">Docker</strong> task and click on <strong class="bold">Add</strong>, and you will see the following code. This is the Docker task to build and push images in <span class="No-Break">one task:</span><pre class="source-code">
- task: Docker@2
  inputs:
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'</pre><p class="list-inset">The following screenshot shows you how to add a Docker task and fill in <span class="No-Break">the details:</span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer154">
<img alt="Figure 5.16 – Adding a Docker task" height="486" src="image/B18875_05_16.jpg" width="994"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.16 – Adding a Docker task</p>
<p class="list-inset">For easy error <a id="_idIndexMarker227"/>handling, you can replace the <strong class="source-inline">buildAndPush</strong> task with separate <em class="italic">build</em> and <em class="italic">push</em> tasks. In the <em class="italic">push</em> task, you set the <strong class="source-inline">condition</strong> value as <strong class="source-inline">succeeded()</strong>, which ensures that the task will only run if the previous steps (in this case, the build task) are <span class="No-Break">completed successfully.</span></p>
<p class="list-inset">You can use the following code to replace the <span class="No-Break"><strong class="source-inline">buildAndPush</strong></span><span class="No-Break"> task:</span></p>
<pre class="source-code">
  - task: Docker@2
    displayName: 'Build Docker image'
    inputs:
      command: build
      Dockerfile: '**/Dockerfile'
      tags: latest
  - task: Docker@2
    displayName: 'Push Docker image'
    inputs:
      command: push
    condition: succeeded()</pre> <p class="list-inset">The difference is that the <strong class="source-inline">buildAndPush</strong> task will build and push the image in one task, which means if you need to add a task between building and pushing, you cannot <span class="No-Break">do that.</span></p>
<ol>
<li value="5">Next, select<a id="_idIndexMarker228"/> the <strong class="bold">Command line</strong> task and click <strong class="bold">Add</strong>. Update the command line, as shown in the following <span class="No-Break">code snippet:</span><pre class="source-code">
- task: CmdLine@2
  inputs:
    script: |
      docker login &lt;docker hub url&gt; -u &lt;your username&gt; -p &lt;your password&gt;
      docker push &lt;your repository&gt;:&lt;your tag&gt;</pre><p class="list-inset">The following screenshot shows you how to add a <strong class="bold">Command line</strong> task and fill in <span class="No-Break">the details:</span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer155">
<img alt="Figure 5.17 – Adding a Command line task" height="433" src="image/B18875_05_17.jpg" width="981"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.17 – Adding a Command line task</p>
<p>After running this pipeline, you will see the Docker image on your <span class="No-Break">Docker Hub.</span></p>
<h1 id="_idParaDest-68"><a id="_idTextAnchor068"/>Working with SQL Server deployment tasks</h1>
<p>You need to use SQL Server commands <a id="_idIndexMarker229"/>to build and deploy SQL Server applications. There are many tasks that need to be completed to build SQL Server applications in Azure Pipelines; follow these steps to create a pipeline using SQL Server <span class="No-Break">deployment tasks:</span></p>
<ol>
<li>You can follow <em class="italic">steps 1 to 4</em> as described in the <em class="italic">Working with .NET Core CLI </em><span class="No-Break"><em class="italic">tasks</em></span><span class="No-Break"> section.</span></li>
<li>Rename the file as shown in the <span class="No-Break">following screenshot:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer156">
<img alt="Figure 5.18 – Renaming the file" height="911" src="image/B18875_05_18.jpg" width="1443"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.18 – Renaming the file</p>
<ol>
<li value="3">Search for <strong class="source-inline">SQL Server database</strong>, select the <strong class="bold">SQL Server database deploy</strong> task, and enter <span class="No-Break">the following:</span><pre class="source-code">
- task: SqlDacpacDeploymentOnMachineGroup@0
  inputs:
    TaskType: 'sqlQuery'
    SqlFile: 'migrate.sql'
    ExecuteInTransaction: true
    ServerName: 'localhost'
    DatabaseName: 'your_database'
    AuthScheme: 'sqlServerAuthentication'
    SqlUsername: 'your_username'
    SqlPassword: 'your_password'</pre><p class="list-inset">Let’s look<a id="_idIndexMarker230"/> at each property <span class="No-Break">in detail:</span></p><ul><li><strong class="source-inline">TaskType</strong>: This could be <strong class="source-inline">dacpac</strong>, <strong class="source-inline">sqlQuery</strong>, <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">sqlInline</strong></span><span class="No-Break">:</span><ul><li><strong class="source-inline">dacpac</strong> means this task will execute the SQL commands from the <span class="No-Break"><strong class="source-inline">dacpac</strong></span><span class="No-Break"> file</span></li><li><strong class="source-inline">sqlQuery</strong> means this task will execute the SQL commands, such as the <strong class="source-inline">SELECT</strong>, <strong class="source-inline">UPDATE</strong>, <strong class="source-inline">INSERT</strong>, and <strong class="source-inline">DELETE</strong> commands, in a <span class="No-Break">SQL file</span></li><li><strong class="source-inline">sqlInline</strong> means this task will execute the SQL directly as a NOT value in the <span class="No-Break">SQL file</span></li></ul></li><li><strong class="source-inline">SqlFile</strong>: This is the full name path for a <span class="No-Break">SQL file</span></li><li><strong class="source-inline">ExecuteInTransaction</strong>: If this is set to <strong class="source-inline">true</strong>, the task will execute a SQL file under the <span class="No-Break">transaction scope</span></li><li><strong class="source-inline">ServerName</strong>: This can be a database server name or <span class="No-Break">an IP</span></li><li><strong class="source-inline">DatabaseName</strong>: This is a database name <span class="No-Break">for execution</span></li><li><strong class="source-inline">AuthScheme</strong>: This could be <strong class="source-inline">sqlServerAuthentication</strong>, which will use authentication from SQL Server, or <strong class="source-inline">windowsAuthentication</strong>, which will use authentication <span class="No-Break">from Windows</span></li><li><strong class="source-inline">SqlUsername</strong>: This is a user from <span class="No-Break">SQL Server</span></li><li><strong class="source-inline">SqlPassword</strong>: This is a password from <span class="No-Break">SQL Server</span></li></ul></li> </ol>
<p> The following <a id="_idIndexMarker231"/>screenshot shows you how to add the <a id="_idIndexMarker232"/>SQL <strong class="bold">Data-Tier Application Package</strong> (<strong class="bold">DACPAC</strong>) deployment task and fill in <span class="No-Break">the details:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<img alt="Figure 5.19 – Adding the SQL Server database deploy task" height="796" src="image/B18875_05_19.jpg" width="1593"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.19 – Adding the SQL Server database deploy task</p>
<p>After you create a SQL Server database deploy task, you can proceed to further customize your tasks. For instance, you can specify the <strong class="source-inline">ServerName</strong> parameter, which represents the database hostname or the server name of the SQL Server that this task should connect to. After making these customizations, you can save the <span class="No-Break">pipeline file.</span></p>
<h1 id="_idParaDest-69"><a id="_idTextAnchor069"/>Summary</h1>
<p>This chapter taught you how to build and release pipelines, using standard NPM, the .NET Core CLI, Docker, and SQL Server deployment tasks. These predefined tasks are popular for building and deploying Node.js and .NET applications. They reduce the time spent by developers creating manual commands when running a pipeline to build <span class="No-Break">those applications.</span></p>
<p>In the next chapter, you will learn in depth about integrating testing and security tasks to make your code and applications <span class="No-Break">more reliable.</span></p>
</div>
</div></body></html>