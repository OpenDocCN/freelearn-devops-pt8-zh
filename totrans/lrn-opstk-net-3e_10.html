<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Creating Standalone Routers with Neutron</h1>
                </header>
            
            <article>
                
<p>Neutron enables users to build routers that provide connectivity between networks created by users and external networks. In a reference implementation, the Neutron L3 agent provides IP routing and network address translation for virtual machine instances within the cloud by utilizing network namespaces to provide isolated routing instances. By creating networks and attaching them to routers, users can expose connected virtual machine instances and their applications to the internet.</p>
<p><span>Prior to the Juno release of OpenStack, users were limited to building standalone routers that acted as single points of failure in the network stack. Since the advent of distributed virtual routers in Juno and beyond, standalone routers are now referred to as <span class="ItalicsPACKT">legacy routers</span>. While the preference may be to provide resiliency in the form of highly-available or distributed virtual routers, standalone routers provide the simplest implementation of the three options.</span></p>
<p>In previous chapters, we discovered the difference between provider and self-service project networks and demonstrated the process of booting an instance and connecting it to the network. In this chapter, we will work through the following:</p>
<ul>
<li>Installing and configuring the L3 agent</li>
<li>Creating an external provider network</li>
<li>Creating a standalone router in the CLI and Horizon dashboard</li>
<li>Attaching a router to both external and tenant networks</li>
<li>Booting instances</li>
<li>Demonstrating instance and namespace connectivity using Linux bridges</li>
<li>Demonstrating SNAT and DNAT functionality provided by floating IPs</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Routing traffic in the cloud</h1>
                </header>
            
            <article>
                
<p>In a reference implementation, virtual routers created in Neutron exist as network namespaces that reside on nodes running the Neutron L3 agent service. A virtual router is often connected to a single external provider network and one or more project networks. The router interfaces connected to those networks can be identified as follows:</p>
<ul>
<li><span class="CodeInTextPACKT"><span class="packt_screen">qg</span></span>: Gateway interface</li>
<li><span class="CodeInTextPACKT"><span class="packt_screen">qr</span>:</span>&amp;amp;nbsp;Router interface</li>
</ul>
<p>Neutron routers are responsible for providing inbound and outbound connectivity to and from project networks through the use of Network Address Translation, or NAT. The following diagram shows how a router namespace may be connected to multiple bridges in a Linux bridge-based implementation:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/f2f18ced-a8ca-4e65-b5e1-9af3934b16df.png" style="width:37.67em;height:35.33em;"/></div>
<p>The preceding diagram demonstrates a Neutron router connected to multiple bridges in a Linux bridge-based implementation. In an Open vSwitch-based implementation, the router's interfaces are connected directly to the integration bridge. Traffic from project networks is routed in through <span class="CodeInTextPACKT"><span class="packt_screen">qr</span></span> interfaces and out the <span class="CodeInTextPACKT"><span class="packt_screen">qg</span></span> interface onto the external network. Routing tables within the namespace dictate how traffic is routed, and iptables rules dictate how traffic is translated, if necessary.</p>
<p>More on creating and configuring standalone Neutron routers, along with examples on how they are connected to the network and provide connectivity to instances, can be found later on in this chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing and configuring the Neutron L3 agent</h1>
                </header>
            
            <article>
                
<p>To install the Neutron L3 agent, run the following command on the <kbd>controller01</kbd> node:</p>
<pre># apt install neutron-l3-agent </pre>
<p>Neutron stores the L3 agent configuration in the <kbd><span class="CodeInTextPACKT">/etc/neutron/l3_agent.ini</span></kbd> file. The most common configuration options will be covered in the following subsections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Defining an interface driver</h1>
                </header>
            
            <article>
                
<p>The Neutron L3 agent must be configured to use an interface driver that corresponds to the chosen mechanism driver. In a reference implementation, that can be either the Linux bridge or Open vSwitch drivers. In this environment, the <span class="CodeInTextPACKT">linux bridge</span> driver will be installed on <kbd>controller01</kbd>.</p>
<p>On the <kbd>controller01</kbd> node, update the Neutron L3 agent configuration file at <kbd><span class="CodeInTextPACKT">/etc/neutron/l3_agent.ini</span></kbd> and specify the following Linux bridge interface driver for this particular environment:</p>
<pre>[DEFAULT]<br/>...<br/>interface_driver = linuxbridge</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>For your reference, the following can be used when the <kbd>network</kbd> node hosting routers is configured for Open vSwitch:</p>
<pre>[DEFAULT]<br/>...<br/>interface_driver = openvswitch </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Enabling the metadata proxy</h1>
                </header>
            
            <article>
                
<p>When Neutron routers are used as the gateway for instances, requests for metadata are proxied by the router rather than the DHCP server and are forwarded to the Nova metadata service. This feature is enabled by default and can be disabled by setting the <kbd><span class="CodeInTextPACKT">enable_metadata_proxy</span></kbd><span class="CodeInTextPACKT">&amp;amp;nbsp;</span>value to <span class="CodeInTextPACKT"><kbd>False</kbd>&amp;amp;nbsp;</span>in the <kbd><span class="CodeInTextPACKT">l3_agent.ini</span></kbd> configuration file and uncommenting the line. For this environment, leave the setting at its default <kbd><span class="CodeInTextPACKT">True</span></kbd> value.</p>
<div class="packt_infobox">If the metadata proxy is disabled, users may only be able to obtain metadata using config-drive.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting the agent mode</h1>
                </header>
            
            <article>
                
<p>By default, the Neutron L3 agent works in legacy mode, which means that the L3 agent is deployed on a centralized node responsible for networking services. The default value for <kbd><span class="CodeInTextPACKT">agent_mode</span></kbd> is <kbd><span class="CodeInTextPACKT">legacy</span></kbd>, which shall remain unchanged for the remainder of this chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Enabling the router service plugin</h1>
                </header>
            
            <article>
                
<p>The <span class="CodeInTextPACKT">router</span> service plugin must be enabled before Neutron will accept API commands related to Neutron routers. On the <kbd>controller01</kbd> node, update the Neutron API server configuration file at <kbd><span class="CodeInTextPACKT">/etc/neutron/neutron.conf</span></kbd> and append&amp;amp;nbsp;<kbd><span class="CodeInTextPACKT">router</span></kbd> to the list of service plugins, as shown here:</p>
<pre>service_plugins = router </pre>
<div class="packt_tip">The <kbd><span class="CodeInTextPACKT">service_plugins</span></kbd> configuration option may be disabled. Remove any leading hash (#) to enable the option.</div>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Enabling router management in the dashboard</h1>
                </header>
            
            <article>
                
<p>The Horizon dashboard can be used to manage routers, but the option must be enabled first.</p>
<p>On the <kbd>controller01</kbd> node, edit the OpenStack dashboard configuration file at <kbd><span class="CodeInTextPACKT">/etc/openstack-dashboard/local_settings.py</span></kbd> and navigate to the <kbd><span class="CodeInTextPACKT">OPENSTACK_NEUTRON_NETWORK</span></kbd> configuration option. Change the <kbd><span class="CodeInTextPACKT">enable_router</span></kbd> dictionary value from <kbd><span class="CodeInTextPACKT">False</span></kbd> to <span class="CodeInTextPACKT"><kbd>True</kbd>,</span> as shown here:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/b0000103-56b8-4b32-8475-2e88ac9529c2.png" style="width:23.67em;height:14.92em;"/></div>
<p>Close the file and proceed with the next section to restart services.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Restarting services</h1>
                </header>
            
            <article>
                
<p>After making changes to the configuration of the Neutron L3 agent and API service, issue the following commands on the&amp;amp;nbsp;<kbd>controller01</kbd> node to restart the respective services:</p>
<pre># systemctl restart neutron-l3-agent neutron-server apache2 </pre>
<p>Verify that the agent is running:</p>
<pre># systemctl status neutron-l3-agent</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The service should return a similar output to the following and be in an <span class="CodeInTextPACKT">active (running)</span> state:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/3b4553ad-b3e9-4991-928e-92d665c321d8.png"/></div>
<p>If the service remains stopped, troubleshoot any errors that may be indicated in the <kbd><span class="CodeInTextPACKT">/var/log/neutron/l3-agent.log</span></kbd> log file.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Router management in the CLI</h1>
                </header>
            
            <article>
                
<p>Neutron offers a number of commands that can be used to create and manage routers. The primary commands associated with router management include the following:</p>
<p class="mce-root"/>
<p class="mce-root"/>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT CDPAlignCenter"><strong>Router Management Commands</strong></p>
</td>
<td>
<p class="TableColumnHeadingPACKT CDPAlignCenter CDPAlign"><strong>Description</strong></p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router create</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Creates a router</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router delete</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Deletes a router(s)</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router set</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Sets a router gateway and other properties</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router unset</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Unsets a router gateway and other properties</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router show</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Displays router details</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists routers</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router add port</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Adds an interface to a router using an existing port</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router add subnet</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Adds an interface to a router using an existing subnet</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router remove port</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Removes an interface from a router using a corresponding port ID</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>router remove subnet</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Removes an interface from a router using a corresponding subnet ID</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>network agent list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists all network agents</p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating routers in the CLI</h1>
                </header>
            
            <article>
                
<p>Routers in Neutron are associated with projects and can only be managed by users associated with the project. Unlike networks, routers cannot be shared among projects. However, shared networks can be attached to routers and potentially route traffic between different projects. Users with the <span class="CodeInTextPACKT">admin</span> role can associate routers with other projects during the router creation process.</p>
<p>To create a standalone router, use the <span class="CodeInTextPACKT"><kbd>openstack router create</kbd>&amp;amp;nbsp;</span>command shown here:</p>
<pre>openstack router create<br/>[--enable | --disable]<br/>[--project &lt;project&gt;]<br/>[--project-domain &lt;project-domain&gt;]<br/>&lt;name&gt; </pre>
<p>The router will be created without any interfaces attached and will immediately be scheduled to an L3 agent. A corresponding network namespace should be visible on the node hosting the respective L3 agent and can be found using the <kbd><span class="CodeInTextPACKT">ip netnslist</span></kbd> command.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Listing routers in the CLI</h1>
                </header>
            
            <article>
                
<p>To display a list of existing routers, use the <kbd><span class="CodeInTextPACKT">openstack router list</span></kbd> command shown here:</p>
<pre>openstack router list<br/>[--name &lt;name&gt;] [--enable | --disable] [--long]<br/>[--project &lt;project&gt;]<br/>[--project-domain &lt;project-domain&gt;]<br/>[--agent &lt;agent-id&gt;] [--tags &lt;tag&gt;[,&lt;tag&gt;,...]]<br/>[--any-tags &lt;tag&gt;[,&lt;tag&gt;,...]]<br/>[--not-tags &lt;tag&gt;[,&lt;tag&gt;,...]]<br/>[--not-any-tags &lt;tag&gt;[,&lt;tag&gt;,...]] </pre>
<p>Filters based on name, project, admin state, scheduled agent, and tags can be used to narrow returned results.</p>
<div class="packt_infobox">Users will only see routers associated with their project. When executed as a user with the <span class="CodeInTextPACKT">admin</span> role, Neutron will return a listing of all routers across all projects unless a project ID is specified.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying router attributes in the CLI</h1>
                </header>
            
            <article>
                
<p>To display the attributes of a router, use the <kbd><span class="CodeInTextPACKT">openstack router show</span></kbd> command shown here:</p>
<pre>openstack router show &lt;router&gt; </pre>
<p>Among the output returned is the admin state, the external network, the SNAT state, and project ID associated with the router. Two additional attributes, <span class="CodeInTextPACKT">distributed</span> and <span class="CodeInTextPACKT">HA</span>, are used to identify the router as being distributed or highly-available. For standalone routers, both attributes will be set to <span class="CodeInTextPACKT">False</span>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Updating router attributes in the CLI</h1>
                </header>
            
            <article>
                
<p>To update the attributes of a router, use the <kbd><span class="CodeInTextPACKT">openstack router set</span></kbd> or <span class="CodeInTextPACKT"><kbd>openstack router unset</kbd>&amp;amp;nbsp;</span>commands shown here:</p>
<pre>openstack router set<br/>[--name &lt;name&gt;] [--description &lt;description&gt;]<br/>[--enable | --disable]<br/>[--distributed | --centralized]<br/>[--route destination=&lt;subnet&gt;,gateway=&lt;ip-address&gt;]<br/>[--no-route] [--ha | --no-ha]<br/>[--external-gateway &lt;network&gt;]<br/>[--fixed-ip subnet=&lt;subnet&gt;,ip-address=&lt;ip-address&gt;]<br/>[--enable-snat | --disable-snat] [--tag &lt;tag&gt;]<br/>[--no-tag]<br/>&lt;router&gt;<br/><br/>openstack router unset<br/>[--route destination=&lt;subnet&gt;,gateway=&lt;ip-address&gt;]<br/>[--external-gateway] [--tag &lt;tag&gt; | --all-tag]<br/>&lt;router&gt;        </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Working with router interfaces in the CLI</h1>
                </header>
            
            <article>
                
<p>Standalone Neutron routers have two types of interfaces: gateway and internal. The gateway interface of a Neutron router is analogous to the WAN interface of a physical router. It is the interface connected to an upstream device that provides connectivity to external resources. The internal interfaces of Neutron routers are analogous to the LAN interfaces of physical routers. Internal interfaces are connected to project networks and often serve as the gateway or next hop for instances in those networks.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attaching internal interfaces to routers</h1>
                </header>
            
            <article>
                
<p>To create an internal router interface and attach it to a subnet, use the <kbd><span class="CodeInTextPACKT">openstack router add subnet</span></kbd> command shown here:</p>
<pre>openstack router add subnet &lt;router&gt; &lt;subnet&gt; </pre>
<p>The <span class="CodeInTextPACKT"><kbd>subnet</kbd>&amp;amp;nbsp;</span>argument represents a subnet name or ID to be attached to the router. Neutron will assign the gateway IP of the subnet to the router when creating the <kbd><span class="CodeInTextPACKT">qr</span></kbd> interface and corresponding port.</p>
<p>To attach an existing port directly to the router, use the <kbd><span class="CodeInTextPACKT">openstack router add port</span></kbd> command shown here:</p>
<pre>openstack router subnet add &lt;router&gt; &lt;port&gt; </pre>
<p>The <kbd><span class="CodeInTextPACKT">port</span></kbd> keyword represents a port name or ID to be attached to the router.</p>
<p>A Neutron router can only have one interface in a given subnet, but can be attached to multiple subnets simultaneously. The L3 agent is responsible for connecting interfaces within the router namespace to the proper bridges on the host.</p>
<div class="packt_tip"><span>In Neutron, a network may contain multiple subnets. A router must be connected to all subnets in a network to properly route traffic for that network. Be sure <span class="ItalicsPACKT">not</span> to attach an external network using this process, as traffic may be negatively impacted!</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attaching a gateway interface to a router</h1>
                </header>
            
            <article>
                
<p>The external interface of a Neutron router is referred to as the gateway interface. A router is limited to a single gateway interface. To be eligible for use as an external network that can be used for router gateway interfaces, a provider network must have its <span class="CodeInTextPACKT">router's external</span> attribute set to <span class="CodeInTextPACKT">True&amp;amp;nbsp;</span>or <span class="CodeInTextPACKT">External</span>.</p>
<p>To attach a gateway interface to a router, use the <kbd><span class="CodeInTextPACKT">openstack router set</span></kbd> command shown here:</p>
<pre>openstack router set --external-gateway &lt;network&gt; &lt;router&gt;</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The <kbd>&lt;network&gt;</kbd><span class="CodeInTextPACKT">&amp;amp;nbsp;</span>argument represents a network name or ID to be attached to the router as the gateway network. Neutron will assign an IP address from the external network to the router. By default, Neutron routers perform source network address translation, or SNAT, on all traffic from instances that lack floating IPs. NAT and SNAT will be covered in more detail later in this chapter. To disable this functionality, use the <span class="CodeInTextPACKT"><kbd>--disable-snat</kbd>&amp;amp;nbsp;</span>argument when using the <span class="CodeInTextPACKT"><kbd>openstack router set</kbd>&amp;amp;nbsp;</span>command.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Listing interfaces attached to routers</h1>
                </header>
            
            <article>
                
<p>To list the interfaces attached to a router, use the <kbd><span class="CodeInTextPACKT">openstack port list</span></kbd> command shown here:</p>
<pre>openstack port list --router &lt;router&gt; </pre>
<p>The <span class="CodeInTextPACKT">router&amp;amp;nbsp;</span>argument represents the router name or ID.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deleting internal interfaces</h1>
                </header>
            
            <article>
                
<p>To delete an internal interface from a router, use the <span class="CodeInTextPACKT"><kbd>openstack router remove port</kbd>&amp;amp;nbsp;</span>or&amp;amp;nbsp;<span class="CodeInTextPACKT"><kbd>openstack router remove subnet</kbd>&amp;amp;nbsp;</span>commands shown here:</p>
<pre>openstack router remove port &lt;router&gt; &lt;port&gt;<br/>openstack router remove subnet &lt;router&gt; &lt;subnet&gt; </pre>
<p>The <span class="CodeInTextPACKT"><kbd>&lt;port&gt;</kbd>&amp;amp;nbsp;</span>argument represents the name or ID of a particular port to be removed from the router, while the <span class="CodeInTextPACKT"><kbd>&lt;subnet&gt;</kbd>&amp;amp;nbsp;</span>argument represents the name of ID of a subnet to be removed from the router. In either case, deleting an interface based on port or subnet results in the respective Neutron port being removed from the database.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Clearing the gateway interface</h1>
                </header>
            
            <article>
                
<p>Gateway interfaces cannot be removed from a router using the <kbd><span class="CodeInTextPACKT">openstack router remove</span></kbd> commands. Instead, the <kbd><span class="CodeInTextPACKT">openstack router unset</span></kbd> command must be used.</p>
<p>To clear the gateway of a router, use the <kbd><span class="CodeInTextPACKT">openstack router unset</span></kbd> command shown here:</p>
<pre>openstack router unset --external-gateway &lt;router&gt;</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>
<p>Neutron performs checks that will prohibit the clearing of a gateway interface in the event floating IPs are associated with the router.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deleting routers in the CLI</h1>
                </header>
            
            <article>
                
<p>To delete a router, use the <span class="CodeInTextPACKT"><kbd>openstack router delete</kbd>&amp;amp;nbsp;</span>command and specify the name or ID of the router:</p>
<pre>openstack router delete &lt;router&gt; [&lt;router&gt; ...] </pre>
<p>Multiple routers can also be deleted simultaneously, as follows:</p>
<pre>openstack router delete &lt;router1&gt; &lt;router2&gt; </pre>
<p>Neutron will successfully delete the routers as long as all connected ports or subnets have been removed and all floating IPs have been disassociated or deleted.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Network address translation</h1>
                </header>
            
            <article>
                
<p>Network address translation, or NAT, is a networking concept that was developed in the early 1990s in response to the rapid depletion of IP addresses throughout the world. Prior to NAT, every host connected to the internet had a unique IP address.</p>
<p>Standalone routers support two types of NAT:</p>
<ul>
<li>one-to-one</li>
<li>many-to-one</li>
</ul>
<p><span>A <span class="KeyWordPACKT">one-to-one</span> NAT is a method in which one IP address is directly mapped to another. Commonly referred to as a static NAT, a one-to-one NAT is often used to map a unique public address to a privately addressed host. Floating IPs utilize one-to-one NAT concepts.</span></p>
<p><span>A <span class="KeyWordPACKT">many-to-one</span> NAT is a method in which multiple addresses are mapped to a single address. A many-to-one NAT employs the use of port address translation, or PAT. Neutron uses PAT to provide external access to instances behind the router when floating IPs are not assigned.</span></p>
<p>For more information on network address translation, please visit the following Wikipedia page at&amp;amp;nbsp;<span class="URLPACKT"><a href="http://en.wikipedia.org/wiki/Network_address_translation">http://en.wikipedia.org/wiki/Network_address_translation</a>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Floating IP addresses</h1>
                </header>
            
            <article>
                
<p><span>Self-service project networks, when attached to a Neutron router, often utilize the router as their default gateway. By default, when a router receives traffic from an instance and routes it upstream, the router performs a port address translation and modifies the source address of the packet to appear as its own external interface address. When the translation occurs, the ephemeral source port is mapped to the original client address in a table that is referred to when the response packet is received. This ensures that the packet can be routed upstream and returned to the router, where the packet is modified and returned to the instance that initiated the connection. Neutron refers to this type of behavior as <span class="KeyWordPACKT">source NAT</span>.</span></p>
<p><span>When users require direct inbound access to instances, a floating IP address can be utilized. A <span class="KeyWordPACKT">floating IP</span> address in OpenStack is a one-to-one static NAT that maps an external address from an external network to an internal address in a project network. This method of NAT allows instances to be accessible from remote networks such as the internet. Floating IP addresses are configured on the external interface of the router that serves as the gateway for the instance, which is then responsible for modifying both the source and destination address of packets depending on their direction.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Floating IP management</h1>
                </header>
            
            <article>
                
<p>The OpenStack command-line client offers a number of commands that can be used to create and manage floating IPs. The primary commands associated with floating IPs include the following:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Floating IP Commands</strong></p>
</td>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Description</strong></p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ip create</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Creates a floating IP</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ip delete</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Deletes a floating IP&amp;amp;nbsp;</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ip list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists floating IP&amp;amp;nbsp;</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ip show</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Displays floating IP details</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ip set</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Sets floating IP properties</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ipunset</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Unsets floating IP properties</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>floating ip pool list</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Lists pools of floating IP addresses</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>server add floating ip</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Adds a floating IP address to a server</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT"><kbd>server remove floating ip</kbd></p>
</td>
<td>
<p class="TableColumnContentPACKT">Removes a floating IP address from a server</p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating floating IPs in the CLI</h1>
                </header>
            
            <article>
                
<p>If you recall from previous chapters, IP addresses are not assigned directly to instances. Instead, an IP address is associated with a Neutron port, and that port is logically mapped to an instance or other network resource.</p>
<p>When a floating IP is created, it will not be functional until it is associated with a Neutron port. To create a floating IP from within the CLI, use the <kbd><span class="CodeInTextPACKT">openstack floating ip create</span></kbd> command shown here:</p>
<pre>openstack floating ip create<br/>[--subnet &lt;subnet&gt;]<br/>[--port &lt;port&gt;]<br/>[--floating-ip-address &lt;ip-address&gt;]<br/>[--fixed-ip-address &lt;ip-address&gt;]<br/>[--description &lt;description&gt;]<br/>[--project &lt;project&gt;]<br/>[--project-domain &lt;project-domain&gt;]<br/>&lt;network&gt; </pre>
<p>Floating IP addresses can only be used within the project in which they were created. The&amp;amp;nbsp;<span class="CodeInTextPACKT"><kbd>--project</kbd>&amp;amp;nbsp;</span>argument can be used by an administrator so that they are able to specify the project associated with the floating IP.</p>
<p>The <kbd><span class="CodeInTextPACKT">--port</span></kbd> argument is optional and is used to specify the port to be associated with the floating IP upon creation.</p>
<p>Because a port can have multiple IP addresses associated with it, it may be necessary to define a specific fixed IP to associate the floating IP with. Use the <span class="CodeInTextPACKT"><kbd>--fixed-ip-address</kbd>&amp;amp;nbsp;</span>argument to specify the fixed IP address that should be associated with the floating IP.</p>
<p>In previous releases of OpenStack, floating IPs were automatically assigned from the allocation pool of the external network. This behavior made it difficult for users who required particular addresses, especially when upstream NATs or firewall rules were already in place that specified certain floating IP addresses. Beginning with Kilo, it is possible to create a floating IP using a specified address as long as it is available and not associated with another project. With this feature, users can specify a particular floating IP address and avoid modifying external systems.</p>
<p>Use the <span class="CodeInTextPACKT"><kbd>--floating-ip-address</kbd>&amp;amp;nbsp;</span>argument to specify a particular address from the external network for use as a floating IP.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Associating floating IPs with ports in the CLI</h1>
                </header>
            
            <article>
                
<p>Once a floating IP has been created, it is available for use by any user within the project that created it. To associate a floating IP with an instance, it is first necessary to determine the Neutron port that is associated with the fixed IP of the instance.</p>
<p>The port ID associated with the fixed IP address of an instance can be determined in a couple of different ways. The quickest way may be to use the <kbd><span class="CodeInTextPACKT">openstack port list</span></kbd> command with a filter that can narrow down ports per instance.</p>
<p class="CDPAlignLeft CDPAlign">For example, the ports of an instance whose ID is <kbd><span class="CodeInTextPACKT">3d577137-9658-4226-906e-88d3117e497e</span></kbd> can be determined in the following way:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e3169655-d0d8-4559-8f07-bb3c29bedcba.png"/></p>
<p>Once the port ID has been determined, use the <kbd><span class="CodeInTextPACKT">openstack floating ip set</span></kbd> command to associate the floating IP with the port:</p>
<pre>openstack floating ip set --port &lt;port&gt;<br/>[--fixed-ip-address &lt;ip-address&gt;]<br/>&lt;floating-ip&gt; </pre>
<p>Neutron uses the subnet ID of the specified port to determine the router in which to configure the floating IP address and respective NAT rules. The logic involved means that no more than one standalone router should be attached to a project network at any given time when floating IPs are used, otherwise unexpected results may occur.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Listing floating IPs in the CLI</h1>
                </header>
            
            <article>
                
<p>To determine the association of floating IPs to Neutron ports and addresses, use the <kbd><span class="CodeInTextPACKT">openstack floating ip list</span></kbd> command shown here:</p>
<pre>openstack floating ip list<br/>[--network &lt;network&gt;] [--port &lt;port&gt;]<br/>[--fixed-ip-address &lt;ip-address&gt;] [--long]<br/>[--status &lt;status&gt;] [--project &lt;project&gt;]<br/>[--project-domain &lt;project-domain&gt;]<br/>[--router &lt;router&gt;]</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The output returned includes the floating IP ID, fixed IP address, floating IP address, and port ID associated with the floating IP. All arguments are optional and help with filtering results.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Displaying floating IP attributes in the CLI</h1>
                </header>
            
            <article>
                
<p>To display the attributes of a floating IP in the CLI, use the <kbd><span class="CodeInTextPACKT">openstack floating ip show</span></kbd> command shown here:</p>
<pre>openstack floating ip show &lt;floating-ip&gt; </pre>
<p>The output returned includes the floating IP address and the associated external network, fixed IP address, port, project, and router IDs.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Disassociating floating IPs in the CLI</h1>
                </header>
            
            <article>
                
<p>To disassociate a floating IP from a port, use the <span class="CodeInTextPACKT"><kbd>openstack floating ip unset</kbd></span> command shown here:</p>
<pre>openstack floating ip unset [--port] &lt;floating-ip&gt; </pre>
<p>Disassociating a floating IP from a port makes the floating IP available for use by other users within the project.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deleting floating IPs in the CLI</h1>
                </header>
            
            <article>
                
<p>To delete a floating IP, use the <span class="CodeInTextPACKT"><kbd>openstack floating ip delete</kbd>&amp;amp;nbsp;</span>command shown here:</p>
<pre>openstack floating ip delete &lt;floating-ip&gt; [&lt;floating-ip&gt; ...] </pre>
<p>Deleting a floating IP returns the IP address to the external network allocation pool where it can be allocated to other projects and used by other network resources, including routers and floating IPs.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Demonstrating traffic flow from an instance to the internet</h1>
                </header>
            
            <article>
                
<p>This section is dedicated to a walkthrough that leverages fundamental Neutron concepts that have been discussed in this book so far. I will demonstrate the process of creating and connecting standalone Neutron routers to both project and external provider networks to provide network connectivity to instances.</p>
<p>A VLAN-based provider network will be created and used as an external gateway network for the Neutron router, while a VLAN-based project network will be created and used by instances. A Neutron router will be created and used to route traffic from instances in the project network to the internet, and floating IPs will be created and used to provide direct connectivity to instances.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting the foundation</h1>
                </header>
            
            <article>
                
<p>In this demonstration, a Cisco Adaptive Security Appliance (ASA) serves as the physical network gateway device and is connected to the internet. The following networks will be utilized:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td style="width: 196px">
<p class="TableColumnHeadingPACKT"><strong>VLAN name</strong></p>
</td>
<td style="width: 276px">
<p class="TableColumnHeadingPACKT"><strong>VLAN ID</strong></p>
</td>
<td style="width: 479.531px">
<p class="TableColumnHeadingPACKT"><strong>Network</strong></p>
</td>
</tr>
<tr>
<td style="width: 196px">
<p class="TableColumnContentPACKT">GATEWAY_NET</p>
</td>
<td style="width: 276px">
<p class="TableColumnContentPACKT">30</p>
</td>
<td style="width: 479.531px">
<p class="TableColumnContentPACKT">10.30.0.0/24</p>
</td>
</tr>
<tr>
<td style="width: 196px">
<p class="TableColumnContentPACKT">PROJECT_NET</p>
</td>
<td style="width: 276px">
<p class="TableColumnContentPACKT">auto</p>
</td>
<td style="width: 479.531px">
<p class="TableColumnContentPACKT">192.168.200.0/24</p>
</td>
</tr>
</tbody>
</table>
<p>Â </p>
<p>An inside interface of the Cisco ASA has been configured with an IP address of 10.30.0.1/24 on VLAN 30 and will serve as the gateway for the external provider network created in the upcoming section.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The following diagram is the logical diagram of the network to be built as part of this demonstration:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/719b1715-d1e1-4683-a3f2-92d0545a774f.png" style="width:38.58em;height:45.25em;"/></div>
<p>In the preceding diagram, a Cisco ASA serves as the external network device in front of the OpenStack cloud.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an external provider network</h1>
                </header>
            
            <article>
                
<p>In order to provide instances with external connectivity, a Neutron router must be connected to a provider network eligible for use as an external network.</p>
<p>Using the <kbd><span class="CodeInTextPACKT">openstack network create</span></kbd> command, create a provider network in the <span class="CodeInTextPACKT">admin</span> project with the following attributes:</p>
<ul>
<li>Name: GATEWAY_NET</li>
<li>Type: VLAN</li>
<li>Segmentation ID: 30</li>
<li>Physical Network: physnet1</li>
<li>External: True</li>
</ul>
<p>The following screenshot displays the resulting output of the <span class="CodeInTextPACKT"><kbd>openstack network create</kbd></span> command:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/3750f014-3494-44ff-ae74-daf6cea9fd3d.png" style="width:26.75em;height:31.83em;"/></div>
<p>Using the <kbd><span class="CodeInTextPACKT">openstack subnet create</span></kbd> command, create a subnet with the following attributes:</p>
<ul>
<li>Name: GATEWAY_SUBNET</li>
<li>Network: 10.30.0.0</li>
<li>Subnet Mask: 255.255.255.0</li>
<li>Gateway: 10.30.0.1</li>
<li>DHCP: Disabled</li>
<li>Allocation Pool: 10.30.0.100 - 10.30.0.254</li>
</ul>
<p>The following screenshot displays the resulting output of the <span class="CodeInTextPACKT"><kbd>openstack subnet create</kbd>&amp;amp;nbsp;</span>command:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/24f68096-2db5-463f-9cbc-dd123b9b55db.png" style="width:32.08em;height:34.42em;"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a Neutron router</h1>
                </header>
            
            <article>
                
<p>Create a router using the <kbd><span class="CodeInTextPACKT">openstack router create</span></kbd> command with the following attribute:</p>
<ul>
<li>Name: MyLegacyRouter</li>
</ul>
<p>The following screenshot displays the resulting output of the <kbd><span class="CodeInTextPACKT">openstack router create</span></kbd> command:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/ea57d17e-9860-48ce-b619-acea2989156b.png" style="width:35.67em;height:26.33em;"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attaching the router to an external network</h1>
                </header>
            
            <article>
                
<p>When attaching a Neutron router an external network, the respective network must have its <kbd><span class="CodeInTextPACKT">router:external</span></kbd> attribute set to <kbd><span class="CodeInTextPACKT">True</span></kbd> to be eligible for use as an external network. Otherwise, the command will fail. The <span class="CodeInTextPACKT"><kbd>GATEWAY_NET</kbd>&amp;amp;nbsp;</span>network created previously meets this requirement.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Using the <kbd><span class="CodeInTextPACKT">openstack router set</span></kbd> command, attach the router <span class="CodeInTextPACKT"><kbd>MyLegacyRouter</kbd>&amp;amp;nbsp;</span>to the <kbd><span class="CodeInTextPACKT">GATEWAY_NET</span></kbd> network:</p>
<pre>openstack router set --external-gateway GATEWAY_NET MyLegacyRouter </pre>
<p>No output will be returned upon successful completion of the command. Using the <kbd><span class="CodeInTextPACKT">openstack port list</span></kbd> command, determine the external IP address of the router:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/c69f030c-aab8-44a3-81c0-ea7e53e7167b.png"/></div>
<p>In this example, the IP address assigned to the router's external interface is <kbd>10.30.0.106</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Identifying the L3 agent and namespace</h1>
                </header>
            
            <article>
                
<p>Once the gateway interface has been added, the router will be scheduled to an eligible L3 agent. Using the&amp;amp;nbsp;<kbd><span class="CodeInTextPACKT">openstack network age</span><span class="CodeInTextPACKT">nt list</span></kbd> command, you can determine which L3 agent the router was scheduled to:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ed662f35-628f-4f82-b87e-de8b4a75593c.png"/></p>
<p>In this example, the router was scheduled to the <kbd>controller01</kbd> node. In an environment running multiple <kbd>L3</kbd> agents, a standalone router can be scheduled to any one of the agents, but will not be scheduled to more than one at any given time.</p>
<p>The L3 agent is responsible for creating a network namespace that acts as the virtual router. For easy identification, the name of the namespace incorporates the router's ID. The <kbd><span class="CodeInTextPACKT">ip netns list</span></kbd> command can be used to list all network namespaces on a node:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/e4cf9cef-1462-4656-a94a-ff32027d0100.png" style="width:37.67em;height:8.50em;"/></div>
<p>Inside the respective <span class="CodeInTextPACKT">qrouter&amp;amp;nbsp;</span>namespace, you will find an interface with a prefix of <kbd><span class="CodeInTextPACKT">qg</span></kbd>. The <kbd><span class="CodeInTextPACKT">qg</span></kbd> interface is the gateway, or external, interface of the router. Neutron automatically provisions an IP address to the <kbd><span class="CodeInTextPACKT">qg</span></kbd> interface from the allocation pool of the external network's subnet:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/5a2cbc65-e507-43f0-b42e-09fd807d591a.png"/></div>
<p>In the preceding screenshot, the IP address 1<span class="packt_screen">0.30.0.106</span> was automatically configured on the external interface inside the namespace.</p>
<p>When using the Open vSwitch interface driver, the <span class="CodeInTextPACKT"><kbd>qg</kbd>&amp;amp;nbsp;</span>interface is connected directly to the integration bridge. When using the Linux bridge interface driver, as in this example, the <kbd><span class="CodeInTextPACKT">qg</span></kbd> interface is one end of a veth pair whose other end is connected to a Linux bridge on the host.</p>
<p>Using <span class="CodeInTextPACKT">ethtool</span>, we can determine the peer index of the corresponding interface on the host. This can be useful in troubleshooting connectivity issues in and out of network namespaces:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a3bf5931-c216-4526-8d9b-2c66f607e849.png"/></p>
<p>Using <span class="CodeInTextPACKT">ip link show</span> on the host, the corresponding interface (peer index 16) can be found by searching for the index on the controller:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/fd969c23-e745-409e-a51e-4ffb35c1af2c.png"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The output conveniently reveals the corresponding network namespace using the <kbd><span class="CodeInTextPACKT">link-netnsid</span></kbd> identifier. In this example, the peer interface resides in the network namespace with an ID of <span class="CodeInTextPACKT">3</span>, otherwise known as <kbd><span class="CodeInTextPACKT">qrouter-9ef2eeed-4a55-4f64-b8be-4b07a43ec373</span></kbd>.</p>
<div class="packt_tip">The <span class="CodeInTextPACKT">link-netnsid</span> ID from <kbd><span class="CodeInTextPACKT">ip link show</span></kbd> should correspond to a namespace provided in the output of the <span class="CodeInTextPACKT"><kbd>ip netns list</kbd>&amp;amp;nbsp;</span>command.</div>
<p>When using the Linux bridge interface driver, the veth interface is connected to a bridge that corresponds to the external network shown here:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/04c24954-7c53-4d1c-8d78-8a76de8284e7.png" style="width:59.00em;height:20.17em;"/></div>
<div class="packt_tip">For easy identification, the bridge name includes the first ten characters of the Neutron network ID. In addition, each end of the veth pair includes the first ten characters of the port ID associated with the interface.</div>
<p>The namespace is able to communicate with other devices in the same subnet through the bridge. The other interface in the bridge, <kbd><span class="CodeInTextPACKT">eth2.30</span></kbd>, tags traffic as <kbd>VLAN 30</kbd> as it exits the bridge and out physical interface <kbd><span class="CodeInTextPACKT">eth2</span></kbd>.</p>
<p>Observe the route table within the namespace. The default gateway address corresponds to the address defined in the external provider subnet's <kbd><span class="CodeInTextPACKT">gateway_ip</span></kbd> attribute. In this case, it's <kbd>10.30.0.1</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/cf9e8d80-ded7-4ab1-b63b-bcebb5e8fa40.png" style="width:63.42em;height:5.67em;"/></p>
<p>In this example environment, <kbd>10.30.0.1</kbd> is configured on the Cisco ASA and will serve as the next hop gateway for outbound traffic from the Neutron router.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing gateway connectivity</h1>
                </header>
            
            <article>
                
<p>To test external connectivity from the Neutron router, ping the edge gateway device from within the router namespace:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/58ff5664-096c-414d-8904-e1172b3670f6.png" style="width:57.17em;height:14.67em;"/></p>
<p>Successful ping attempts from the router namespace to the physical gateway device demonstrate proper external VLAN configuration on both physical and virtual networking components.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an internal network</h1>
                </header>
            
            <article>
                
<p>Within the <span class="CodeInTextPACKT">admin&amp;amp;nbsp;</span>project, create an internal network for instances. In this demonstration, a network will be created with the following attribute:</p>
<ul>
<li>Name: PROJECT_NET</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The following screenshot demonstrates the resulting output of the <kbd><span class="CodeInTextPACKT">openstack network create</span></kbd> command:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/42bdb09b-b245-4de0-b86c-5ad12e4ad384.png" style="width:36.08em;height:37.08em;"/></div>
<p>Notice how Neutron automatically determined the network type, physical network, and segmentation ID for the network. Because the <kbd><span class="CodeInTextPACKT">openstack network create</span></kbd> command was executed without specific provider attributes, Neutron relied on the configuration found in the plugin configuration file to determine what type of network to create.</p>
<p>The following configuration options in the ML2 configuration file were used to determine the network type, physical network, and segmentation ID:</p>
<pre>tenant_network_types = vlan,vxlan<br/>network_vlan_ranges = physnet1:40:43</pre>
<p class="mce-root"/>
<div class="packt_tip">Remember, in this configuration, Neutron will consume all available VLAN segmentation IDs as networks are created before moving on to VXLAN networks.</div>
<p>Using the <span class="CodeInTextPACKT"><kbd>openstack subnet create</kbd>&amp;amp;nbsp;</span>command, create a subnet with the following attributes:</p>
<ul>
<li>Name: PROJECT_SUBNET</li>
<li>Network: 192.168.200.0</li>
<li>Subnet Mask: 255.255.255.0</li>
<li>Gateway: &lt;auto&gt;</li>
<li>DHCP Range: &lt;auto&gt;</li>
<li>DNS Nameserver: 8.8.8.8</li>
</ul>
<p>The output should resemble the following:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/cdc6e932-a834-4082-9d9a-61a00aa8c0b2.png" style="width:30.00em;height:31.00em;"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attaching the router to the internal network</h1>
                </header>
            
            <article>
                
<p>Using the <kbd><span class="CodeInTextPACKT">openstack router add subnet</span></kbd> command, attach the <span class="CodeInTextPACKT"><kbd>PROJECT_SUBNET</kbd></span> subnet to <kbd><span class="CodeInTextPACKT">MyLegacyRouter</span></kbd>:</p>
<pre><strong># openstack router add subnet MyLegacyRouter PROJECT_SUBNET</strong> </pre>
<p>No output is provided if the command is successful. Using the <kbd><span class="CodeInTextPACKT">openstack port list</span></kbd> command, determine the internal IP of the router:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/05f697f4-92ad-4989-a7d7-fc0ddd0457f0.png"/></p>
<p>In this example, the IP address assigned to the router's internal interface is <kbd>192.168.200.1</kbd>. When a port ID or IP address is not specified when attaching the router to a subnet, the IP address assigned to the router's internal interface defaults to the address set as the <span class="CodeInTextPACKT"><kbd>gateway_ip</kbd>&amp;amp;nbsp;</span>for the subnet.</p>
<p>Inside the router namespace, a new interface has been added with a prefix of <kbd><span class="CodeInTextPACKT">qr</span></kbd>. A <kbd><span class="CodeInTextPACKT">qr</span></kbd> interface is an internal interface of the router:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/218c7718-b0ce-4609-bfef-6ab25111541d.png" style="width:61.92em;height:23.83em;"/></p>
<p>When using the Open vSwitch interface driver, the interface is connected directly to the integration bridge. When using the Linux bridge interface driver, as in this example, every <kbd><span class="CodeInTextPACKT">qr</span></kbd> interface is one end of a veth pair whose other end is connected to a bridge on the host:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/53b9f95e-19fa-4c16-8cbc-ca3bfa517fa2.png" style="width:60.50em;height:26.33em;"/></div>
<div class="packt_tip">For easy identification, the bridge name includes the first ten characters of the respective Neutron network ID. In addition, each end of the veth pair includes the first ten characters of the Neutron port ID associated with the interface.</div>
<p>The router namespace is able to communicate with other devices in the same subnet through the bridge. The&amp;amp;nbsp;<span class="CodeInTextPACKT"><kbd>eth2.43</kbd> interface&amp;amp;nbsp;</span>in the bridge tags traffic as <kbd>VLAN 43</kbd> as it exits the bridge out to the parent interface&amp;amp;nbsp;<kbd><span class="CodeInTextPACKT">eth2</span></kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating instances</h1>
                </header>
            
            <article>
                
<p>Create two instances with the following characteristics:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Name</strong></p>
</td>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Network</strong></p>
</td>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Image</strong></p>
</td>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Flavor</strong></p>
</td>
<td class="CDPAlignCenter CDPAlign">
<p class="TableColumnHeadingPACKT"><strong>Host</strong></p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT">MyInstance1</p>
</td>
<td>
<p class="TableColumnContentPACKT">PROJECT_NET</p>
</td>
<td>
<p class="TableColumnContentPACKT">cirros-0.4.0</p>
</td>
<td>
<p class="TableColumnContentPACKT">tiny</p>
</td>
<td>
<p class="TableColumnContentPACKT">compute01</p>
</td>
</tr>
<tr>
<td>
<p class="TableColumnContentPACKT">MyInstance2</p>
</td>
<td>
<p class="TableColumnContentPACKT">PROJECT_NET</p>
</td>
<td>
<p class="TableColumnContentPACKT">cirros-0.4.0</p>
</td>
<td>
<p class="TableColumnContentPACKT">tiny</p>
</td>
<td>
<p class="TableColumnContentPACKT">compute02</p>
</td>
</tr>
</tbody>
</table>
<p class="mce-root"/>
<p class="mce-root"/>
<p>If necessary, use the <kbd><span class="CodeInTextPACKT">openstack image list</span></kbd> command to determine the ID of the CirrOS image downloaded in <span class="ChapterrefPACKT"><a href="1638cc46-d387-4ec0-9597-b25eee47618b.xhtml"/><a href="1638cc46-d387-4ec0-9597-b25eee47618b.xhtml"><em>Chapter 2</em></a>,</span> <em><span class="ItalicsPACKT">Installing OpenStack</span></em>:</p>
<p>Use the following <kbd><span class="CodeInTextPACKT">openstack server create</span></kbd> commands to boot two instances across two <kbd>compute</kbd> nodes in the <kbd><span class="CodeInTextPACKT">PROJECT_NET</span></kbd> network:</p>
<pre>openstack server create \<br/>--flavor tiny \<br/>--image cirros-0.4.0 \<br/>--nic net-id=PROJECT_NET \<br/>--availability-zone nova:compute01 \<br/>MyInstance1<br/><br/>openstack server create \<br/>--flavor tiny \<br/>--image cirros-0.4.0 \<br/>--nic net-id=PROJECT_NET \<br/>--availability-zone nova:compute02 \<br/>MyInstance2 </pre>
<p>The <span class="CodeInTextPACKT"><kbd>openstack server list</kbd>&amp;amp;nbsp;</span>command can be used to return a list of instances and their IP addresses:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6aafc47e-0fba-41ab-8ee7-15b86aee4dac.png"/></p>
<p>On <kbd>compute01</kbd>, a Linux bridge has been created that corresponds to the <kbd><span class="CodeInTextPACKT">PROJECT_NET</span></kbd> network. When connected to the bridge, we can find a <kbd>VLAN</kbd> interface and the tap interface that corresponds to <kbd><span class="CodeInTextPACKT">MyInstance1</span></kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3b704a1f-8dca-4d17-8f90-06cba9c8cd1d.png"/></p>
<div class="packt_infobox">When the Linux bridge agent is used, bridges correspond to individual networks, and the names will have a prefix of <span class="CodeInTextPACKT">brq</span>.</div>
<p>On <kbd>compute02</kbd>, we can find the tap interface that corresponds to <span class="CodeInTextPACKT"><kbd>MyInstance2</kbd>&amp;amp;nbsp;</span>is connected to the Linux bridge dedicated to the respective port:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d70c0703-c265-406d-9064-c2f77e4495a1.png" style="width:31.50em;height:4.50em;"/></p>
<div class="packt_infobox">When the Open vSwitch agent is used along with the <kbd><span class="CodeInTextPACKT">iptables_hybrid</span></kbd> firewall driver, bridges correspond to individual ports, and the names will have a prefix of <kbd><span class="CodeInTextPACKT">qbr</span></kbd>. These bridges are only used to overcome iptables limitations with Open vSwitch virtual switches.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Verifying instance connectivity</h1>
                </header>
            
            <article>
                
<p>When a network and subnet are created with DHCP enabled, a network namespace is created by a DHCP agent that serves as a DHCP server for the network. On the host running the Neutron DHCP agent service, the&amp;amp;nbsp;<span class="CodeInTextPACKT"><kbd>ip netns list</kbd>&amp;amp;nbsp;</span>command can be used to reveal the namespace. For easy identification, the name of a DHCP namespace corresponds to the ID of the network it is serving:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c5a1e65c-5f12-4026-baee-2e871309e92b.png" style="width:44.08em;height:7.08em;"/></p>
<p>Inside the namespace, an interface with a prefix of <kbd><span class="CodeInTextPACKT">ns</span></kbd> has been created and assigned an address from the allocation pool of the subnet:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/aeb6d3db-edbf-4621-8875-f302fd77fec7.png" style="width:44.67em;height:13.42em;"/></div>
<p>When a DHCP agent is configured to use the Open vSwitch interface driver, the <span class="CodeInTextPACKT"><kbd>ns</kbd>&amp;amp;nbsp;</span>interface inside the namespace is connected directly to the integration bridge. When a DHCP agent is configured to use the Linux bridge interface driver, as in this example, the <kbd><span class="CodeInTextPACKT">ns</span></kbd> interface is one end of a veth pair whose other end is connected to a bridge on the host. The namespace is able to communicate with other devices in the same subnet through the respective bridge and VLAN.</p>
<p>As the instances come online, they send a DHCP request that is served by the <kbd><span class="CodeInTextPACKT">dnsmasq</span></kbd> process in the DHCP namespace. A populated ARP table within the namespace confirms instances are functioning in the VLAN at Layer 2:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e4951937-2fa3-4771-aa87-b53fe47ab3d4.png"/></p>
<div class="packt_infobox">The L2 population driver is used to pre-populate ARP and forwarding tables to reduce overhead on overlay networks and may not provide an accurate picture of connectivity in those networks. If an entry is in a PERMANENT state, it has been statically programmed and may not reflect actual reachability.</div>
<p>Before you can connect to the instances, security group rules must be updated to allow ICMP and SSH. <em><span class="ChapterrefPACKT"><a href="240902fd-5108-446e-afa5-8122de12f0af.xhtml">Chapter 8</a>,</span> <span class="ItalicsPACKT">Managing Security Groups</span></em>, focuses on the implementation and administration of security group rules in more detail. To test connectivity, add ICMP and SSH access to security group applied to the instances. Use the following command to determine the security group for these particular instances:</p>
<pre><strong># openstack port list --server MyInstance1 --long -c 'Security Groups'<br/></strong><strong># openstack port list --server MyInstance2 --long -c 'Security Groups'</strong> </pre>
<p>The output may resemble the following:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3d3712e6-5d35-492f-8a74-9e22addba3b9.png" style="width:38.92em;height:13.17em;"/></p>
<p>Use the <kbd><span class="CodeInTextPACKT">openstack security group rule create</span></kbd> command to create rules within the respective security group that allow inbound ICMP and SSH:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/f2390827-62b8-47cf-ad5d-492e17f195c8.png" style="width:32.00em;height:48.08em;"/></div>
<p>Using the <span class="CodeInTextPACKT">SSH</span> command, connect to the instance <kbd><span class="CodeInTextPACKT">MyInstance1</span></kbd> from either the router or DHCP namespace. The CirrOS image has a built-in user named <span class="CodeInTextPACKT">cirros&amp;amp;nbsp;</span>with a password of <kbd><span class="CodeInTextPACKT">gocubsgo</span></kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/46460293-9166-450c-8495-bad205050e30.png" style="width:51.00em;height:15.67em;"/></p>
<p>Observe the routing table inside the instance, like so:</p>
<pre>$ ip r<br/>default via 192.168.200.1 dev eth0<br/>169.254.169.254 via 192.168.200.1 dev eth0<br/>192.168.200.0/24 dev eth0  src 192.168.200.6 </pre>
<p>The default gateway of <kbd>192.168.200.1</kbd> is the Neutron router that we created earlier in this chapter. Pinging an external resource from an instance should prove successful, provided external connectivity from the Neutron router exists:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d77ed185-fc20-4e4e-827e-da1009de1d51.png" style="width:52.08em;height:15.00em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Observing default NAT behavior</h1>
                </header>
            
            <article>
                
<p>The default behavior of the Neutron router is to source NAT traffic from instances that lack floating IPs when traffic egresses the external, or gateway, interface of the router.</p>
<p>Performing a packet capture on the <span class="CodeInTextPACKT">eth2.43&amp;amp;nbsp;</span>interface of the <kbd>controller</kbd> node that corresponds with the <kbd><span class="CodeInTextPACKT">PROJECT_NET</span></kbd> network, we can observe ICMP traffic from the instances sourcing from their real or fixed addresses as the traffic heads towards the router. The reply also references the same fixed IP address:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5e2383e7-cc9e-4508-8e42-da3a2bfe36b1.png" style="width:49.25em;height:7.25em;"/></p>
<p>From the <span class="CodeInTextPACKT">eth2.30&amp;amp;nbsp;</span>interface on the <kbd>controller</kbd> node that corresponds to the <kbd><span class="CodeInTextPACKT">GATEWAY_NET</span></kbd> network, we can observe ICMP traffic from the instances after it has traversed the router sourcing as the router's external address, <kbd>10.30.0.106</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f5f2e7e2-5caf-4387-810e-dcb990be84a6.png" style="width:51.42em;height:7.25em;"/></p>
<p>A look at the iptables chains within the router namespace reveals the NAT rules responsible for this behavior:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/ae6cff3c-be15-49e9-8424-1f236b7a2046.png" style="width:38.25em;height:28.67em;"/></div>
<p>In this configuration, instances can communicate with outside resources through the router as long as the instances initiate the connection. Outside resources cannot initiate connections directly to instances via their fixed IP address.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Assigning floating IPs</h1>
                </header>
            
            <article>
                
<p>To initiate connections to instances behind Neutron routers from outside networks, you must configure a floating IP address and associate it with the instance. In OpenStack, a floating IP is associated with a Neutron port that corresponds to an interface of the instance accepting connections.</p>
<p>Using the <kbd><span class="CodeInTextPACKT">openstack port list</span></kbd> command, determine the port ID of each instance recently booted. The command allows results to be filtered by device or instance ID, as shown in the following screenshot:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/db96d180-e739-4a03-b180-13af6da06049.png"/></div>
<p>Using the <kbd><span class="CodeInTextPACKT">openstack floating ip create</span></kbd> command, create a single floating IP address and associate it with the port of the instance known as <kbd>MyInstance1</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/df5d76e9-284b-4ffb-bccf-ee70879d42d9.png" style="width:60.17em;height:23.17em;"/></p>
<div class="packt_infobox">Upon creation, the floating IP may appear to be in a <span class="CodeInTextPACKT">DOWN</span> state. Once the changes have been applied to the network, the status should reflect an <span class="CodeInTextPACKT">ACTIVE</span> state.</div>
<p>From within the guest OS, verify that the instance can still communicate with outside resources:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3357c697-9ad1-461a-9b33-3865100135de.png" style="width:29.50em;height:9.75em;"/></p>
<p>Performing a packet capture on the&amp;amp;nbsp;<kbd><span class="CodeInTextPACKT">eth2.30</span></kbd> interface on the <kbd>controller01</kbd> node, we can observe ICMP traffic from the instance through the router having a source IP that corresponds to the floating IP address <kbd>10.30.0.101</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/738ebe80-efc2-4a8a-8ed7-da7d9909500f.png" style="width:37.17em;height:10.83em;"/></p>
<p>Within the router namespace, the floating IP has been configured as a secondary address on the <kbd><span class="CodeInTextPACKT">qg</span></kbd> interface:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/40dc4dea-440b-43d5-97bd-aab19783d907.png" style="width:43.17em;height:18.00em;"/></p>
<p>When the floating IP is configured as a secondary network address on the <kbd><span class="CodeInTextPACKT">qg</span></kbd> interface, the router is able to respond to ARP requests to the floating IP from the upstream gateway device and other Neutron routers or devices in the same external network. This allows inbound connectivity to the instance via the floating IP.</p>
<p>A look at the <kbd>iptables</kbd> chains within the router namespace show rules have been added to perform the 1:1 NAT translation from the floating IP to the fixed IP of <kbd>MyInstance1</kbd>, and vice versa:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9a7cc48d-8602-46c3-8960-89601fa899d8.png" style="width:42.75em;height:22.50em;"/></p>
<p>Provided our client workstation can route to the external provider network, traffic can be initiated directly to the instance via the floating IP:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1d699426-90d4-4d21-ac62-f2d7642d0892.png" style="width:36.00em;height:16.33em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Reassigning floating IPs</h1>
                </header>
            
            <article>
                
<p>Neutron provides the ability to quickly disassociate a floating IP from an instance or other network resource and associate it with another. A list of floating IPs shows the current association:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0c9794c5-9b88-4eb5-b9bc-6e7115101816.png"/></p>
<p>Using the <span class="CodeInTextPACKT"><kbd>openstack floating ip unset</kbd>&amp;amp;nbsp;</span>and <kbd><span class="CodeInTextPACKT">openstack floating ip set</span></kbd> commands, disassociate the floating IP from <kbd>MyInstance1</kbd> and associate it with <kbd>MyInstance2</kbd>. The disassociation can be seen here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e0420e13-30e9-4d3f-b593-a72655df3670.png"/></p>
<p>No output will be returned if the command is successful. The <kbd><span class="CodeInTextPACKT">openstack floating ip list</span></kbd> command shows that the floating IP is no longer associated with a port:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/09cb9ad6-3838-4805-ad7d-73e697cacd2b.png"/></div>
<div class="packt_infobox">The floating IP is still owned by the project that created it and cannot be assigned to another project without first being deleted.</div>
<p>Using the <span class="CodeInTextPACKT"><kbd>openstack floating ip set</kbd>&amp;amp;nbsp;</span>command, associate the floating IP with the port of <kbd>MyInstance2</kbd>, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9057099a-bd42-48e0-919f-7b66082cf0c9.png"/></p>
<p>No output will be returned if the command is successful. Observe the iptables rules within the router namespace. The NAT relationship has been modified, and traffic from <kbd>MyInstance2</kbd> will now appear as the floating IP:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/eee6370d-a218-4e9a-970e-b735b23d359d.png" style="width:63.67em;height:33.08em;"/></p>
<p>As a result of the new association, attempting an SSH connection to the floating IP may result in the following message on the client machine:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ffcbae62-1dda-4053-ad75-ee8caf3b385c.png" style="width:55.00em;height:21.00em;"/></p>
<p>The warning message is a good indicator that traffic is being sent to a different host. Clearing the offending key and logging into the instance reveals it to be <kbd>MyInstance2</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4cdb6df5-788d-41c2-9aac-7bc287678eb6.png" style="width:46.17em;height:35.50em;"/></p>
<p>At this point, we have successfully deployed two instances behind a single virtual router and have verified connectivity to and from the instances using floating IPs. In the next section, we will explore how those same tasks can be accomplished within the Horizon dashboard.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Router management in the dashboard</h1>
                </header>
            
            <article>
                
<p><span>From the Horizon dashboard, routers can be created and managed within the <span class="ScreenTextPACKT"><span class="packt_screen">Project | Network | Routers</span></span> pane:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8ce1ed2c-ded0-4613-8ce7-f9e3eca2c5d0.png" style="width:59.17em;height:18.67em;"/></p>
<p>Routers available to the logged-in user can be seen on this page.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a router in the dashboard</h1>
                </header>
            
            <article>
                
<p><span>From the <span class="ScreenTextPACKT"><span class="packt_screen">Routers</span></span> page, click <span class="ScreenTextPACKT"><span class="packt_screen">Create Router</span></span> in the upper right-hand corner to create a router. A wizard will open that resembles the following:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/991fd875-a972-4461-80a5-0f3fcf68bf98.png" style="width:39.17em;height:17.58em;"/></p>
<p><span>Enter the name of the router, select its admin state, and choose the appropriate external network. Click the blue <span class="ScreenTextPACKT"><span class="packt_screen">Create Router</span></span> button to complete the operation.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attaching internal interfaces in the dashboard</h1>
                </header>
            
            <article>
                
<p><span>To attach internal interfaces to routers in the dashboard, click the router to reveal the <span class="ScreenTextPACKT"><span class="packt_screen">Router Details</span></span> page shown here:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2bdc5def-19e6-4718-a426-83603ff6117c.png" style="width:61.92em;height:29.75em;"/></p>
<p>Click the <span class="ScreenTextPACKT"><span class="packt_screen">Interfaces</span></span> tab to reveal details of the router's interfaces:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/83e7fdaf-9643-48d9-bd0c-492d7613cfb5.png" style="width:61.50em;height:23.67em;"/></p>
<p><span>Clicking the <span class="ScreenTextPACKT"><span class="packt_screen">Add Interface</span></span> button reveals a wizard that allows you to select details of the interface to be added:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/90cbc4b7-1e80-420b-be6c-ecfc916f365e.png" style="width:49.58em;height:23.50em;"/></div>
<p><span>Select a subnet you wish to attach to the router from the <span class="ScreenTextPACKT"><span class="packt_screen">Subnet</span>&amp;amp;nbsp;</span>menu and click the blue <span class="ScreenTextPACKT"><span class="packt_screen">Submit</span></span> button to attach the interface. The newly attached interface will be revealed on the <span class="packt_screen"><span class="ScreenTextPACKT">Interface</span></span> <span class="ScreenTextPACKT">p</span>ane shown here:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/52af236d-6582-4273-8f0f-7c0853c80fbe.png" style="width:50.08em;height:21.75em;"/></p>
<div class="packt_infobox">It is normal for an interface's status to be <span class="ScreenTextPACKT">Down</span> immediately after adding the interface to the router. Neutron will not mark the interface as <span class="ScreenTextPACKT">Active</span> until the agents have completed their tasks. Refreshing the dashboard will update the status accordingly.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Viewing the network topology in the dashboard</h1>
                </header>
            
            <article>
                
<p>From within the dashboard, users can view a logical topology of the network based on the network configuration managed by Neutron.</p>
<p><span>Click on <span class="ScreenTextPACKT"><span class="packt_screen">Network Topology</span></span> under the <span class="ScreenTextPACKT"><span class="packt_screen">Project| Network</span>&amp;amp;nbsp;</span>pane to find a logical diagram based on the networks, router, and instances that we created earlier:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/fd2345dc-7dec-4213-ad10-2f50c4d99709.png" style="width:62.67em;height:44.58em;"/></p>
<p>Hovering over the router icon reveals a popup displaying details about the router such as connected ports, IPs, and port status:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/80fcd470-7eb1-4672-aa56-14935a672abe.png" style="width:47.67em;height:36.67em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Associating floating IPs to instances in the dashboard</h1>
                </header>
            
            <article>
                
<p><span>Floating IPs in the dashboard are managed on the <span class="ScreenTextPACKT"><span class="packt_screen">Instances</span></span> page found within the <span class="ScreenTextPACKT"><span class="packt_screen">Project| Compute</span>&amp;amp;nbsp;</span>pane. Click the menu under the <span class="ScreenTextPACKT"><span class="packt_screen">Actions</span>&amp;amp;nbsp;</span>column next to the instance you wish to assign a floating IP to:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d38bb4ca-e4ca-482b-9a24-f3c6462a59e1.png" style="width:39.75em;height:13.25em;"/></p>
<p><span>To assign a floating IP, click <span class="ScreenTextPACKT"><span class="packt_screen">Associate Floating IP</span></span>. A wizard will be revealed that allows you to manage floating IP allocations:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/597dfcef-071a-4ecf-b8db-c1111e2678d4.png" style="width:38.33em;height:15.00em;"/></p>
<p><span>If there are no floating IP addresses available for allocation, click the plus <span class="ScreenTextPACKT">(+)&amp;amp;nbsp;</span>sign to create one. Click the <span class="ScreenTextPACKT"><span class="packt_screen">Associate</span></span> button to associate the floating IP with the port.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Disassociating floating IPs in the dashboard</h1>
                </header>
            
            <article>
                
<p><span>To disassociate a floating IP from an instance in the dashboard, click the menu under the <span class="ScreenTextPACKT"><span class="packt_screen">Actions</span></span> column that corresponds to the instance and select <span class="ScreenTextPACKT"><span class="packt_screen">Disassociate Floating IP</span></span>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f2873c8d-ea5a-4fa0-8648-93ee518f3360.png" style="width:50.33em;height:7.50em;"/></p>
<p>A message will appear that warns you of the pending action:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5282f1f4-0c24-4095-9c2f-1ecbf5dca2d9.png" style="width:46.42em;height:10.67em;"/></p>
<p><span>Click the blue <span class="ScreenTextPACKT"><span class="packt_screen">Disassociate Floating IP</span></span> button to proceed with the action.</span></p>
<div class="packt_infobox">While the floating IP has been disassociated with the instance, it remains under the ownership of the project and is not returned to the allocation pool until it is deleted.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>Neutron routers are a core component of networking in OpenStack and provide users the flexibility to design the network to best suit their application. The use of floating IPs allows users to quickly and programmatically provide direct connectivity to applications while preserving limited IPv4 address space through the use of network address translation.</p>
<p>Standalone routers are easy to implement but are a single point of failure in any network design. In the event of an L3 agent failure, all routers scheduled to the agent may become unavailable or unreliable. In the next chapter, we will discuss how Neutron implements highly available routers using the Virtual Router Redundancy Protocol, or VRRP, to solve many of the shortcomings of legacy standalone routers.</p>


            </article>

            
        </section>
    </body></html>