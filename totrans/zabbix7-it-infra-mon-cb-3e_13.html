<html><head></head><body>
<div id="_idContainer695" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-392"><a id="_idTextAnchor2307" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1.1">13</span></h1>
<h1 id="_idParaDest-393" class="calibre5"><a id="_idTextAnchor2308" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.2.1">Bringing Zabbix to the Cloud with Zabbix Cloud Integration</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">For the last chapter, we have prepared something special. </span><span class="kobospan" id="kobo.3.2">As a long-time Zabbix user, the importance of cloud integration for tools such as Zabbix has not gone unnoticed. </span><span class="kobospan" id="kobo.3.3">For some people, the cloud can be daunting, and thus with this chapter, I want to show you just how easy it can be to start working with the most popular cloud providers </span><span><span class="kobospan" id="kobo.4.1">and Zabbix.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">We are going to start by talking about monitoring the </span><strong class="bold"><span class="kobospan" id="kobo.6.1">Amazon Web Services</span></strong><span class="kobospan" id="kobo.7.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.8.1">AWS</span></strong><span class="kobospan" id="kobo.9.1">) cloud with Zabbix. </span><span class="kobospan" id="kobo.9.2">Then we will also see how the same things are done using Microsoft Azure so we can clearly see </span><span><span class="kobospan" id="kobo.10.1">the differences.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.11.1">After going through these cloud products, we’ll also check out container monitoring with Docker, a very popular product that can also benefit greatly from setting up Zabbix monitoring. </span><span class="kobospan" id="kobo.11.2">Follow these recipes closely and you will be able to monitor all of these products easily and work to extend the products using Zabbix. </span><span class="kobospan" id="kobo.11.3">This chapter comprises the </span><span><span class="kobospan" id="kobo.12.1">following recipes:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.13.1">Setting up </span><span><span class="kobospan" id="kobo.14.1">AWS monitoring</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.15.1">Setting up Microsoft </span><span><span class="kobospan" id="kobo.16.1">Azure monitoring</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.17.1">Building your Zabbix </span><span><span class="kobospan" id="kobo.18.1">Docker monitoring</span></span></li>
</ul>
<h1 id="_idParaDest-394" class="calibre5"><a id="_idTextAnchor2309" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2310" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.19.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.20.1">As this chapter focuses on AWS, Microsoft Azure, and Docker monitoring, we are going to need a working AWS, Microsoft Azure, or Docker setup. </span><span class="kobospan" id="kobo.20.2">The recipe does not cover how to set these up, so make sure to have your own infrastructure at </span><span><span class="kobospan" id="kobo.21.1">the ready.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.22.1">Furthermore, we are going to need our Zabbix server running Zabbix 7. </span><span class="kobospan" id="kobo.22.2">We will call this server </span><strong class="source-inline"><span class="kobospan" id="kobo.23.1">lar-book-rocky</span></strong><span class="kobospan" id="kobo.24.1"> in </span><span><span class="kobospan" id="kobo.25.1">this chapter.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.26.1">You can download the code files for this chapter from the following GitHub </span><span><span class="kobospan" id="kobo.27.1">link: </span></span><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter13" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.28.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter13</span></span></a><span><span class="kobospan" id="kobo.29.1">.</span></span></p>
<h1 id="_idParaDest-395" class="calibre5"><a id="_idTextAnchor2311" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2312" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.30.1">Setting up AWS monitoring</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.31.1">A lot of</span><a id="_idTextAnchor2313" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.32.1"> infrastructure </span><a id="_idIndexMarker1011" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.33.1">is moving toward the cloud these days, and it’s important to keep an eye on this infrastructure as much as you would if it were your own hardware. </span><span class="kobospan" id="kobo.33.2">In this recipe, we</span><a id="_idIndexMarker1012" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.34.1"> are going to discover how to monitor EC2 instances, </span><strong class="bold"><span class="kobospan" id="kobo.35.1">Relational Database Service</span></strong><span class="kobospan" id="kobo.36.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.37.1">RDS</span></strong><span class="kobospan" id="kobo.38.1">) instances</span><a id="_idTextAnchor2314" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.39.1">, and </span><strong class="bold"><span class="kobospan" id="kobo.40.1">S3 buckets</span></strong><span class="kobospan" id="kobo.41.1"> with</span><a id="_idIndexMarker1013" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.42.1"> our </span><span><span class="kobospan" id="kobo.43.1">Zabbix setu</span><a id="_idTextAnchor2315" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2316" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.44.1">p.</span></span></p>
<h2 id="_idParaDest-396" class="calibre7"><a id="_idTextAnchor2317" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.45.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.46.1">For this recipe, we are going to need our AWS cloud with at least one of the following </span><span><span class="kobospan" id="kobo.47.1">three resources:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span><span class="kobospan" id="kobo.48.1">EC2 instances</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.49.1">RDS instances</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.50.1">S3 buckets</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.51.1">Of course, we will also need our Zabbix server, which we’ll call </span><strong class="source-inline"><span class="kobospan" id="kobo.52.1">lar-book-rocky</span></strong><span class="kobospan" id="kobo.53.1"> in </span><span><span class="kobospan" id="kobo.54.1">this recipe.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.55.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.56.1">Using Amazon CloudWatch</span><a id="_idIndexMarker1014" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.57.1"> is not free, so you will incur costs. </span><span class="kobospan" id="kobo.57.2">Make sure you check out the </span><a id="_idIndexMarker1015" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.58.1">A</span><a id="_idTextAnchor2318" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.59.1">mazon pricing for AWS CloudWatch before </span><span><span class="kobospan" id="kobo.60.1">proceeding: </span></span><a href="https://aws.amazon.com/cloudwatch/pricing/" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.61.1">https://aws.amazon.com/cloudwatch/pricing/</span></span></a><span><span class="kobospan" id="kobo.62.1">.</span></span></p>
<h2 id="_idParaDest-397" class="calibre7"><a id="_idTextAnchor2319" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.63.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.64.1">Setting up AWS monitoring might seem like a daunting task at first, but once we get the hang of the technique, it’s not that difficult. </span><span class="kobospan" id="kobo.64.2">Let’s waste no more time and check out one of the methods we </span><span><span class="kobospan" id="kobo.65.1">could use:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.66.1">Let’s start by logging in to our Zabbix server with the </span><span><span class="kobospan" id="kobo.67.1">hostname </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.68.1">lar-book-rocky</span></strong></span><span><span class="kobospan" id="kobo.69.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.70.1">Log in to your AWS account by navigating to the following URL in your </span><span><span class="kobospan" id="kobo.71.1">browser: </span></span><a href="https://aws.amazon.com/" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.72.1">https://aws.amazon.com/</span></span></a><span><span class="kobospan" id="kobo.73.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.74.1">On this page, click on </span><strong class="bold"><span class="kobospan" id="kobo.75.1">Sign In to </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.76.1">the Console</span></strong></span><span><span class="kobospan" id="kobo.77.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.78.1">Once logged in, we can navigate to </span><strong class="bold"><span class="kobospan" id="kobo.79.1">My Security Credentials</span></strong><span class="kobospan" id="kobo.80.1">, which should be listed in your</span><a id="_idIndexMarker1016" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.81.1"> user profile in the </span><span><span class="kobospan" id="kobo.82.1">top-right cor</span><a id="_idTextAnchor2320" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.83.1">ner:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer659">
<span class="kobospan" id="kobo.84.1"><img alt="Figure 13.1 – AWS web frontend user profile" src="image/B19803_13_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.85.1">Figure 13.1 – AWS web frontend user profile</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.86.1">On the next page, on the left-hand side, c</span><a id="_idTextAnchor2321" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.87.1">lick on </span><strong class="bold"><span class="kobospan" id="kobo.88.1">Users</span></strong><span class="kobospan" id="kobo.89.1"> under </span><span><strong class="bold"><span class="kobospan" id="kobo.90.1">Access management</span></strong></span><span><span class="kobospan" id="kobo.91.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.92.1">Let’s create a new dedicated Zabbix monitoring user by clicking on the </span><strong class="bold"><span class="kobospan" id="kobo.93.1">Add users</span></strong><span class="kobospan" id="kobo.94.1"> button. </span><span class="kobospan" id="kobo.94.2">Add the user </span><span><span class="kobospan" id="kobo.95.1">as follows.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer660">
<span class="kobospan" id="kobo.96.1"><img alt="Figure 13.2 – AWS new user" src="image/B19803_13_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.97.1">Figure 13.2 – AWS new user</span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.98.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.99.1">Next</span></strong><span class="kobospan" id="kobo.100.1">, and at the second step, if you’d like, you can add the user to a group to inherit some permissions, copy them, or set up a custom policy. </span><span class="kobospan" id="kobo.100.2">I’ll skip this step for now by clicking </span><span><strong class="bold"><span class="kobospan" id="kobo.101.1">Next</span></strong></span><span><span class="kobospan" id="kobo.102.1"> again.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.103.1">Now click on </span><strong class="bold"><span class="kobospan" id="kobo.104.1">Create</span></strong><span class="kobospan" id="kobo.105.1"> to finish setting up </span><span><span class="kobospan" id="kobo.106.1">this user.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.107.1">Select the user</span><a id="_idIndexMarker1017" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.108.1"> from the list to </span><span><span class="kobospan" id="kobo.109.1">edit it:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer661">
<span class="kobospan" id="kobo.110.1"><img alt="Figure 13.3 – AWS – edit new Zabbix user" src="image/B19803_13_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.111.1">Figure 13.3 – AWS – edit new Zabbix user</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.112.1">In the list, we can see there are no policies assigned to this user yet, so let’s create a new policy just for </span><span><span class="kobospan" id="kobo.113.1">Zabbix monitoring.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.114.1">Click </span><a id="_idIndexMarker1018" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.115.1">on </span><strong class="bold"><span class="kobospan" id="kobo.116.1">Create inline policy</span></strong><span class="kobospan" id="kobo.117.1"> from the </span><span><span class="kobospan" id="kobo.118.1">drop-down list:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer662">
<span class="kobospan" id="kobo.119.1"><img alt="Figure 13.4 – AWS – edit new Zabbix user policies" src="image/B19803_13_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.120.1">Figure 13.4 – AWS – edit new Zabbix user policies</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.121.1">Then click on </span><strong class="bold"><span class="kobospan" id="kobo.122.1">JSON</span></strong><span class="kobospan" id="kobo.123.1"> to define the new policy in the JSON format. </span><span class="kobospan" id="kobo.123.2">It should look like the </span><span><span class="kobospan" id="kobo.124.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer663">
<span class="kobospan" id="kobo.125.1"><img alt="Figure 13.5 – AWS – edit new Zabbix user – add new policy" src="image/B19803_13_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.126.1">Figure 13.5 – AWS – edit new Zabbix user – add new policy</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.127.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.128.1">Check out Zabbix’s integrations page for the latest required permissions for the AWS template you’ll be using. </span><span class="kobospan" id="kobo.128.2">Different templates need different permissions, and new permissions might be added </span><a id="_idIndexMarker1019" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.129.1">later to incorporate new features or changes on the AWS </span><span><span class="kobospan" id="kobo.130.1">side: </span></span><a href="https://www.zabbix.com/integrations/aws" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.131.1">https://www.zabbix.com/integrations/aws</span></span></a><span><span class="kobospan" id="kobo.132.1">.</span></span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.133.1">You </span><a id="_idIndexMarker1020" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.134.1">can now click on </span><strong class="bold"><span class="kobospan" id="kobo.135.1">Next</span></strong><span class="kobospan" id="kobo.136.1"> and name </span><span><span class="kobospan" id="kobo.137.1">your policy.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer664">
<span class="kobospan" id="kobo.138.1"><img alt="Figure 13.6 – AWS – edit new Zabbix user – add new policy name" src="image/B19803_13_06.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.139.1">Figure 13.6 – AWS – edit new Zabbix user – add new policy name</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.140.1">Then, click on </span><strong class="bold"><span class="kobospan" id="kobo.141.1">Create policy</span></strong><span class="kobospan" id="kobo.142.1"> at the bottom of </span><span><span class="kobospan" id="kobo.143.1">the page.</span></span><p class="calibre3"><span class="kobospan" id="kobo.144.1">With the permissions out of the way, let’s make sure we will be able to authenticate with this </span><span><span class="kobospan" id="kobo.145.1">user account.</span></span></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.146.1">Still on the same page after creating the new policy, scroll down to </span><strong class="bold"><span class="kobospan" id="kobo.147.1">Access keys (access key ID and secret access key)</span></strong><span class="kobospan" id="kobo.148.1"> for this new user. </span><span class="kobospan" id="kobo.148.2">This will show you </span><span><span class="kobospan" id="kobo.149.1">the followin</span><a id="_idTextAnchor2322" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.150.1">g:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer665">
<span class="kobospan" id="kobo.151.1"><img alt="Figure 13.7 – AWS access keys page" src="image/B19803_13_07.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.152.1">Figure 13.7 – AWS access keys page</span></p>
<ol class="calibre16">
<li value="16" class="calibre15"><span class="kobospan" id="kobo.153.1">Click on </span><strong class="bold"><span class="kobospan" id="kobo.154.1">Create access key</span></strong><span class="kobospan" id="kobo.155.1"> to create a </span><a id="_idIndexMarker1021" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.156.1">new access key. </span><span class="kobospan" id="kobo.156.2">You should see </span><span><span class="kobospan" id="kobo.157.1">the followin</span><a id="_idTextAnchor2323" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.158.1">g:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer666">
<span class="kobospan" id="kobo.159.1"><img alt="Figure 13.8 – AWS access key creati﻿on" src="image/B19803_13_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.160.1">Figure 13.8 – AWS access key creati</span><a id="_idTextAnchor2324" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.161.1">on</span></p>
<ol class="calibre16">
<li value="17" class="calibre15"><span class="kobospan" id="kobo.162.1">Select </span><a id="_idIndexMarker1022" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.163.1">a reason and click on </span><strong class="bold"><span class="kobospan" id="kobo.164.1">Next</span></strong><span class="kobospan" id="kobo.165.1">. </span><span class="kobospan" id="kobo.165.2">Make sure you understand the possible </span><span><span class="kobospan" id="kobo.166.1">security implications.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.167.1">Name your new </span><span><span class="kobospan" id="kobo.168.1">access key:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer667">
<span class="kobospan" id="kobo.169.1"><img alt="Figure 13.9 – AWS access key creation naming" src="image/B19803_13_09.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.170.1">Figure 13.9 – AWS access key creation naming</span></p>
<ol class="calibre16">
<li value="19" class="calibre15"><span class="kobospan" id="kobo.171.1">Lastly, click on </span><strong class="bold"><span class="kobospan" id="kobo.172.1">Create access key</span></strong><span class="kobospan" id="kobo.173.1"> and store the access key and secret access key somewhere safe (such as a password vault). </span><span class="kobospan" id="kobo.173.2">After you’ve done that, click </span><span><span class="kobospan" id="kobo.174.1">on </span></span><span><strong class="bold"><span class="kobospan" id="kobo.175.1">Done</span></strong></span><span><span class="kobospan" id="kobo.176.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer668">
<span class="kobospan" id="kobo.177.1"><img alt="Figure 13.10 – AWS access key creation – copy keys" src="image/B19803_13_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.178.1">Figure 13.10 – AWS access key creation – copy keys</span></p>
<ol class="calibre16">
<li value="20" class="calibre15"><span class="kobospan" id="kobo.179.1">Now, let’s </span><a id="_idIndexMarker1023" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.180.1">finally move on to Zabbix. </span><span class="kobospan" id="kobo.180.2">Log in to your Zabbix GUI and navigate to </span><strong class="bold"><span class="kobospan" id="kobo.181.1">Data collection</span></strong><span class="kobospan" id="kobo.182.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.183.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.184.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.185.1">Create a new host by clicking on </span><strong class="bold"><span class="kobospan" id="kobo.186.1">Create host</span></strong><span class="kobospan" id="kobo.187.1"> in the top-right corner. </span><span class="kobospan" id="kobo.187.2">We’ll create a new host called </span><strong class="source-inline1"><span class="kobospan" id="kobo.188.1">lar-book-aws</span></strong><span class="kobospan" id="kobo.189.1"> and add the </span><strong class="bold"><span class="kobospan" id="kobo.190.1">AWS by HTTP</span></strong><span class="kobospan" id="kobo.191.1"> template and a host group such </span><span><span class="kobospan" id="kobo.192.1">as </span></span><span><strong class="bold"><span class="kobospan" id="kobo.193.1">Cloud</span></strong></span><span><span class="kobospan" id="kobo.194.1">.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer669">
<span class="kobospan" id="kobo.195.1"><img alt="Figure 13.11 – New AWS host" src="image/B19803_13_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.196.1">Figure 13.11 – New AWS host</span></p>
<ol class="calibre16">
<li value="22" class="calibre15"><span class="kobospan" id="kobo.197.1">Before</span><a id="_idIndexMarker1024" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.198.1"> adding the host, make sure to go to </span><strong class="bold"><span class="kobospan" id="kobo.199.1">Macros</span></strong><span class="kobospan" id="kobo.200.1">. </span><span class="kobospan" id="kobo.200.2">We have to fill in a few macros to make this new template work. </span><span class="kobospan" id="kobo.200.3">Make sure to fill out the keys you saved in </span><em class="italic"><span class="kobospan" id="kobo.201.1">step 19</span></em><span class="kobospan" id="kobo.202.1"> and fill them in as in the following screenshot. </span><span class="kobospan" id="kobo.202.2">Also, make sure to add the region in which you want to discover </span><span><span class="kobospan" id="kobo.203.1">your information.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer670">
<span class="kobospan" id="kobo.204.1"><img alt="Figure 13.12 – New AWS host macros" src="image/B19803_13_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.205.1">Figure 13.12 – New AWS host macros</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.206.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.207.1">In my case, all of the AWS resources I am running are within the same AWS regions. </span><span class="kobospan" id="kobo.207.2">In a lot of production environments, this isn’t the case. </span><span class="kobospan" id="kobo.207.3">For those environments, you might want to create a Zabbix host per region to be able to discover all of your resources. </span><span class="kobospan" id="kobo.207.4">All you have to do is define the </span><strong class="bold"><span class="kobospan" id="kobo.208.1">{$AWS.REGION}</span></strong><span class="kobospan" id="kobo.209.1"> macro uniquely </span><span><span class="kobospan" id="kobo.210.1">per host.</span></span></p>
<ol class="calibre16">
<li value="23" class="calibre15"><span class="kobospan" id="kobo.211.1">Now click on </span><strong class="bold"><span class="kobospan" id="kobo.212.1">Add</span></strong><span class="kobospan" id="kobo.213.1"> to add this </span><span><span class="kobospan" id="kobo.214.1">new host.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.215.1">If done correctly, your AWS resources will be added once the discovery rule has been executed, as we can see in the following screenshot for some of my </span><span><span class="kobospan" id="kobo.216.1">EC2 instances:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer671">
<span class="kobospan" id="kobo.217.1"><img alt="Figure 13.13 – Discovered EC2 instances﻿﻿" src="image/B19803_13_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.218.1">Figure 13.13 – Discovered EC2 instances</span><a id="_idTextAnchor2325" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2326" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-398" class="calibre7"><a id="_idTextAnchor2327" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.219.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.220.1">Now that we’ve </span><a id="_idIndexMarker1025" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.221.1">done all the setup work, let’s have a look at what we have actually done. </span><span class="kobospan" id="kobo.221.2">Zabbix 7.0 contains out-of-the-box cloud monitoring templates, which we’ve utilized to monitor some of the most common </span><span><span class="kobospan" id="kobo.222.1">AWS resources.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.223.1">The templates provided by Zabbix use a fairly extensive piece of JavaScript code to execute API calls toward AWS, parse through the received data, and then put that into a JSON array that Zabbix’s low-level </span><span><span class="kobospan" id="kobo.224.1">discovery understands.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.225.1">Looking at the template at </span><strong class="bold"><span class="kobospan" id="kobo.226.1">Data collection</span></strong><span class="kobospan" id="kobo.227.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.228.1">Templates</span></strong><span class="kobospan" id="kobo.229.1"> and then opening </span><strong class="bold"><span class="kobospan" id="kobo.230.1">Discovery</span></strong><span class="kobospan" id="kobo.231.1"> for the </span><strong class="bold"><span class="kobospan" id="kobo.232.1">AWS by HTTP</span></strong><span class="kobospan" id="kobo.233.1"> template, we can see three </span><span><span class="kobospan" id="kobo.234.1">discovery rules:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer672">
<span class="kobospan" id="kobo.235.1"><img alt="Figure 13.14 – AWS by HTTP discovery rules" src="image/B19803_13_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.236.1">Figure 13.14 – AWS by HTTP discovery rules</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.237.1">These three rules discover the EC2 instances, RDS instances, and S3 buckets in AWS and use </span><strong class="bold"><span class="kobospan" id="kobo.238.1">Host prototypes</span></strong><span class="kobospan" id="kobo.239.1"> to create a new host for each instance or bucket found. </span><span class="kobospan" id="kobo.239.2">Those created hosts will then in turn use their own templates to get the actual statistics from those instances or buckets, as we can see in the </span><span><span class="kobospan" id="kobo.240.1">template list:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer673">
<span class="kobospan" id="kobo.241.1"><img alt="Figure 13.15 – The other three AWS templates in Zabbix 7.0" src="image/B19803_13_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.242.1">Figure 13.15 – The other three AWS templates in Zabbix 7.0</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.243.1">In my case, only two EC2 instances were discovered, and as such, those two hosts were added with the </span><strong class="bold"><span class="kobospan" id="kobo.244.1">AWS EC2 by HTTP</span></strong><span class="kobospan" id="kobo.245.1"> template, as seen in </span><span><em class="italic"><span class="kobospan" id="kobo.246.1">Figure 13</span></em></span><span><em class="italic"><span class="kobospan" id="kobo.247.1">.13</span></em></span><span><span class="kobospan" id="kobo.248.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.249.1">All of the information is then collected by </span><strong class="bold"><span class="kobospan" id="kobo.250.1">Script</span></strong><span class="kobospan" id="kobo.251.1"> item types with their own unique JavaScript code. </span><span class="kobospan" id="kobo.251.2">We can see a piece of the code in the following screenshot, where we make a call to </span><a id="_idIndexMarker1026" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.252.1">AWS to a specific URL (underlined) with headers for things such </span><span><span class="kobospan" id="kobo.253.1">as authentication:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer674">
<span class="kobospan" id="kobo.254.1"><img alt="Figure 13.16 – AWS template call" src="image/B19803_13_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.255.1">Figure 13.16 – AWS template call</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.256.1">It is also possible to edit this JavaScript code to create entirely new calls to retrieve your own data and create different types of monitoring, as well as simply extending the </span><span><span class="kobospan" id="kobo.257.1">out-of-the-box templates.</span></span></p>
<h2 id="_idParaDest-399" class="calibre7"><a id="_idTextAnchor2328" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2329" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.258.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.259.1">It takes time to start monitoring with AWS CloudWatch as we need a good understanding of the AWS CLI commands with the use of CloudWatch. </span><span class="kobospan" id="kobo.259.2">When you use the templates provided by Zabbix as a basis, you have a solid foundation on which </span><span><span class="kobospan" id="kobo.260.1">to build.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.261.1">Make sure to check out the AWS documentation for more information on the commands that we can use, using the </span><span><span class="kobospan" id="kobo.262.1">following link:</span></span></p>
<p class="calibre3"><a href="https://docs.aws.amazon.com/cli/latest/reference/#available-services" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.263.1">https://docs.aws.amazon.com/cli/latest/reference/#available-services</span></span></a></p>
<h1 id="_idParaDest-400" class="calibre5"><a id="_idTextAnchor2330" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2331" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.264.1">Setting up Microsoft Azure monitoring</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.265.1">The Microsoft Azure</span><a id="_idTextAnchor2332" class="pcalibre calibre6 pcalibre1"/> <a id="_idIndexMarker1027" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.266.1">cloud is a big player in the cloud market these days and it’s important to keep an eye on this infrastructure as much as you would your own hardware. </span><span class="kobospan" id="kobo.266.2">In this recipe, we are going to discover how to monitor Azure instances with our </span><span><span class="kobospan" id="kobo.267.1">Zabbix setup.</span></span><a id="_idTextAnchor2333" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2334" class="pcalibre calibre6 pcalibre1"/></p>
<h2 id="_idParaDest-401" class="calibre7"><a id="_idTextAnchor2335" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.268.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.269.1">For this recipe, we are going to need our Azure cloud with at least one of the following resources in </span><span><span class="kobospan" id="kobo.270.1">it already.</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.271.1">Cosmos DB for </span><span><span class="kobospan" id="kobo.272.1">MongoDB databases</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.273.1">Microsoft </span><span><span class="kobospan" id="kobo.274.1">SQL databases</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.275.1">MySQL servers</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.276.1">PostgreSQL servers</span></span></li>
<li class="calibre15"><span><span class="kobospan" id="kobo.277.1">Virtual machines</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.278.1">The recipe does not </span><a id="_idIndexMarker1028" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.279.1">cover how to set up any of these resources, so make sure to do this in advance. </span><span class="kobospan" id="kobo.279.2">We will also need our Zabbix server, which we’ll call </span><strong class="source-inline"><span class="kobospan" id="kobo.280.1">lar-book-rocky</span></strong><span class="kobospan" id="kobo.281.1"> in </span><span><span class="kobospan" id="kobo.282.1">this recipe</span><a id="_idTextAnchor2336" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2337" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.283.1">.</span></span></p>
<h2 id="_idParaDest-402" class="calibre7"><a id="_idTextAnchor2338" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.284.1">How to do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.285.1">For Azure monitoring, we face some of the same techniques as we do for AWS monitoring. </span><span class="kobospan" id="kobo.285.2">It can become a bit daunting if we dive into customization, but setting up the initial monitoring is a lot easier than it looks. </span><span class="kobospan" id="kobo.285.3">Let’s check </span><span><span class="kobospan" id="kobo.286.1">it out:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.287.1">With Azure monitoring, first we are going to need to set up our authentication correctly. </span><span class="kobospan" id="kobo.287.2">To do so, navigate to </span><a href="http://portal.azure.com" class="pcalibre calibre6 pcalibre1"><span class="kobospan" id="kobo.288.1">portal.azure.com</span></a><span class="kobospan" id="kobo.289.1"> and </span><span><span class="kobospan" id="kobo.290.1">log in.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.291.1">In the search bar, search for </span><strong class="source-inline1"><span class="kobospan" id="kobo.292.1">Enterprise applications</span></strong><span class="kobospan" id="kobo.293.1"> and select it from the list. </span><span class="kobospan" id="kobo.293.2">Click on </span><span><strong class="bold"><span class="kobospan" id="kobo.294.1">New application</span></strong></span><span><span class="kobospan" id="kobo.295.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer675">
<span class="kobospan" id="kobo.296.1"><img alt="Figure 13.17 – Azure enterprise application creation" src="image/B19803_13_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.297.1">Figure 13.17 – Azure enterprise application creation</span></p>
<ol class="calibre16">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.298.1">Then click on </span><strong class="bold"><span class="kobospan" id="kobo.299.1">Create your </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.300.1">own application</span></strong></span><span><span class="kobospan" id="kobo.301.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer676">
<span class="kobospan" id="kobo.302.1"><img alt="Figure 13.18 – Azure enterprise application creation – creating your own application" src="image/B19803_13_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.303.1">Figure 13.18 – Azure enterprise application creation – creating your own application</span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.304.1">This is where we have to name our application. </span><span class="kobospan" id="kobo.304.2">Name it something appropriate, as seen in the </span><span><span class="kobospan" id="kobo.305.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer677">
<span class="kobospan" id="kobo.306.1"><img alt="Figure 13.19 – Azure enterprise application creation – setting the name of your application" src="image/B19803_13_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.307.1">Figure 13.19 – Azure enterprise application creation – setting the name of your application</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.308.1">Then </span><a id="_idIndexMarker1029" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.309.1">click </span><strong class="bold"><span class="kobospan" id="kobo.310.1">Create</span></strong><span class="kobospan" id="kobo.311.1"> at the bottom of the page to finish creating a new empty application. </span><span class="kobospan" id="kobo.311.2">It will show you the application ID on this page. </span><span class="kobospan" id="kobo.311.3">Make sure to write it down as we will need </span><span><span class="kobospan" id="kobo.312.1">it later:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer678">
<span class="kobospan" id="kobo.313.1"><img alt="Figure 13.20 – Azure enterprise application overview page" src="image/B19803_13_20.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.314.1">Figure 13.20 – Azure enterprise application overview page</span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.315.1">With the application created, let’s immediately dive into setting up the credentials for it. </span><span class="kobospan" id="kobo.315.2">To do so, use the Azure search bar at the top and search for </span><strong class="source-inline1"><span class="kobospan" id="kobo.316.1">Azure Active Directory</span></strong><span class="kobospan" id="kobo.317.1">, then select it from </span><span><span class="kobospan" id="kobo.318.1">the list.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.319.1">In the</span><a id="_idIndexMarker1030" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.320.1"> left-hand sidebar, you should see </span><strong class="bold"><span class="kobospan" id="kobo.321.1">App registrations</span></strong><span class="kobospan" id="kobo.322.1">. </span><span class="kobospan" id="kobo.322.2">We are going to create a new registration, so click on </span><span><strong class="bold"><span class="kobospan" id="kobo.323.1">New registration</span></strong></span><span><span class="kobospan" id="kobo.324.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer679">
<span class="kobospan" id="kobo.325.1"><img alt="Figure 13.21 – Azure enterprise application – App registrations" src="image/B19803_13_21.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.326.1">Figure 13.21 – Azure enterprise application – App registrations</span></p>
<ol class="calibre16">
<li value="8" class="calibre15"><span class="kobospan" id="kobo.327.1">Simply give your registration a new name and keep the rest of the settings as </span><span><span class="kobospan" id="kobo.328.1">the default:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer680">
<span class="kobospan" id="kobo.329.1"><img alt="Figure 13.22 – Azure enterprise application – new app registration" src="image/B19803_13_22.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.330.1">Figure 13.22 – Azure enterprise application – new app registration</span></p>
<ol class="calibre16">
<li value="9" class="calibre15"><span class="kobospan" id="kobo.331.1">Click </span><strong class="bold"><span class="kobospan" id="kobo.332.1">Register</span></strong><span class="kobospan" id="kobo.333.1"> to finish this registration. </span><span class="kobospan" id="kobo.333.2">This will redirect you to your newly </span><span><span class="kobospan" id="kobo.334.1">created registration.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.335.1">Now let’s</span><a id="_idIndexMarker1031" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.336.1"> add the authentication. </span><span class="kobospan" id="kobo.336.2">Go to </span><strong class="bold"><span class="kobospan" id="kobo.337.1">Certificates &amp; secrets</span></strong><span class="kobospan" id="kobo.338.1"> in the </span><span><span class="kobospan" id="kobo.339.1">left-hand sidebar.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.340.1">We’ll create a new client secret here. </span><span class="kobospan" id="kobo.340.2">To do so, click on </span><strong class="bold"><span class="kobospan" id="kobo.341.1">New </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.342.1">client secret</span></strong></span><span><span class="kobospan" id="kobo.343.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer681">
<span class="kobospan" id="kobo.344.1"><img alt="Figure 13.23 – Azure enterprise application – app registration secrets" src="image/B19803_13_23.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.345.1">Figure 13.23 – Azure enterprise application – app registration secrets</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.346.1">All we have to do now is name the secret and set an expiry time period. </span><span class="kobospan" id="kobo.346.2">Keep in mind that a shorter expiry means more administrative overhead. </span><span class="kobospan" id="kobo.346.3">Faster expiry could mean better security as there is less time to potentially leak (or use once leaked) </span><span><span class="kobospan" id="kobo.347.1">the secrets:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer682">
<span class="kobospan" id="kobo.348.1"><img alt="Figure 13.24 – Azure enterprise application – app registration secret creation" src="image/B19803_13_24.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.349.1">Figure 13.24 – Azure enterprise application – app registration secret creation</span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.350.1">Now click on </span><strong class="bold"><span class="kobospan" id="kobo.351.1">Add</span></strong><span class="kobospan" id="kobo.352.1"> to finish setting up the new secret. </span><span class="kobospan" id="kobo.352.2">It will show you the values once. </span><span class="kobospan" id="kobo.352.3">Make sure to store them somewhere safe, such as in a </span><span><span class="kobospan" id="kobo.353.1">password vault:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer683">
<span class="kobospan" id="kobo.354.1"><img alt="Figure 13.25 – Azure enterprise application secrets" src="image/B19803_13_25.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.355.1">Figure 13.25 – Azure enterprise application secrets</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.356.1">With the authentication out of the way, there is only one thing left to do. </span><span class="kobospan" id="kobo.356.2">We need to provide the correct permissions to this new enterprise application. </span><span class="kobospan" id="kobo.356.3">To do so, search for </span><strong class="source-inline1"><span class="kobospan" id="kobo.357.1">Subscriptions</span></strong><span class="kobospan" id="kobo.358.1"> in the Azure search bar at the top of </span><span><span class="kobospan" id="kobo.359.1">the page.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.360.1">For things</span><a id="_idIndexMarker1032" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.361.1"> such as Azure virtual machine and database instance monitoring, you will need to assign (read) permissions to your entire subscription. </span><span class="kobospan" id="kobo.361.2">Find the subscription where your resources are located. </span><span class="kobospan" id="kobo.361.3">Mine is called </span><span><strong class="bold"><span class="kobospan" id="kobo.362.1">OICTS Azure</span></strong></span><span><span class="kobospan" id="kobo.363.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer684">
<span class="kobospan" id="kobo.364.1"><img alt="Figure 13.26 – Azure subscriptions" src="image/B19803_13_26.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.365.1">Figure 13.26 – Azure subscriptions</span></p>
<ol class="calibre16">
<li value="16" class="calibre15"><span class="kobospan" id="kobo.366.1">Now is also a great time to write down the subscription ID, as we will need it in a </span><span><span class="kobospan" id="kobo.367.1">later step!</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.368.1">Select your subscription, and then from the list, select </span><strong class="bold"><span class="kobospan" id="kobo.369.1">Access control (IAM)</span></strong><span class="kobospan" id="kobo.370.1">. </span><span class="kobospan" id="kobo.370.2">Then, click on </span><strong class="bold"><span class="kobospan" id="kobo.371.1">Add </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.372.1">role assignment</span></strong></span><span><span class="kobospan" id="kobo.373.1">.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer685">
<span class="kobospan" id="kobo.374.1"><img alt="Figure 13.27 – Azure subscription – role assignment" src="image/B19803_13_27.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.375.1">Figure 13.27 – Azure subscription – role assignment</span></p>
<ol class="calibre16">
<li value="18" class="calibre15"><span class="kobospan" id="kobo.376.1">On the </span><a id="_idIndexMarker1033" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.377.1">next page, select the </span><strong class="bold"><span class="kobospan" id="kobo.378.1">Reader</span></strong><span class="kobospan" id="kobo.379.1"> role from the list and then </span><span><span class="kobospan" id="kobo.380.1">press </span></span><span><strong class="bold"><span class="kobospan" id="kobo.381.1">Next</span></strong></span><span><span class="kobospan" id="kobo.382.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.383.1">At the </span><strong class="bold"><span class="kobospan" id="kobo.384.1">Members</span></strong><span class="kobospan" id="kobo.385.1"> part of the creation process, click on </span><strong class="bold"><span class="kobospan" id="kobo.386.1">+ Select members</span></strong><span class="kobospan" id="kobo.387.1">. </span><span class="kobospan" id="kobo.387.2">We’ll add the </span><strong class="bold"><span class="kobospan" id="kobo.388.1">Zabbix book monitoring</span></strong><span class="kobospan" id="kobo.389.1"> member. </span><span class="kobospan" id="kobo.389.2">It will look </span><span><span class="kobospan" id="kobo.390.1">as follows:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer686">
<span class="kobospan" id="kobo.391.1"><img alt="Figure 13.28 – Azure subscription – role assignment members" src="image/B19803_13_28.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.392.1">Figure 13.28 – Azure subscription – role assignment members</span></p>
<ol class="calibre16">
<li value="20" class="calibre15"><span class="kobospan" id="kobo.393.1">Now click on </span><strong class="bold"><span class="kobospan" id="kobo.394.1">Review + assign</span></strong><span class="kobospan" id="kobo.395.1"> and the permissions will </span><span><span class="kobospan" id="kobo.396.1">be added.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.397.1">There’s one more thing to do in the Azure portal. </span><span class="kobospan" id="kobo.397.2">In the search bar at the top of the page, type in </span><strong class="source-inline1"><span class="kobospan" id="kobo.398.1">Tenant properties</span></strong><span class="kobospan" id="kobo.399.1"> and select it from the list. </span><span class="kobospan" id="kobo.399.2">On this page, make sure to note down the tenant ID as we will need </span><span><span class="kobospan" id="kobo.400.1">it shortly.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.401.1">With the application set up, the authentication created, and the permissions assigned, let’s move on to the Zabbix frontend. </span><span class="kobospan" id="kobo.401.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.402.1">Data collection</span></strong><span class="kobospan" id="kobo.403.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.404.1">Hosts</span></strong><span class="kobospan" id="kobo.405.1"> and</span><a id="_idIndexMarker1034" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.406.1"> create a new host by clicking on </span><strong class="bold"><span class="kobospan" id="kobo.407.1">Create host</span></strong><span class="kobospan" id="kobo.408.1"> in the </span><span><span class="kobospan" id="kobo.409.1">top-right corner:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer687">
<span class="kobospan" id="kobo.410.1"><img alt="Figure 13.29 – Azure tenant properties" src="image/B19803_13_29.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.411.1">Figure 13.29 – Azure tenant properties</span></p>
<ol class="calibre16">
<li value="23" class="calibre15"><span class="kobospan" id="kobo.412.1">Create the following host, with the name </span><strong class="source-inline1"><span class="kobospan" id="kobo.413.1">lar-book-azure</span></strong><span class="kobospan" id="kobo.414.1">, the </span><strong class="bold"><span class="kobospan" id="kobo.415.1">Azure by HTTP</span></strong><span class="kobospan" id="kobo.416.1"> template, and a host group such </span><span><span class="kobospan" id="kobo.417.1">as </span></span><span><strong class="bold"><span class="kobospan" id="kobo.418.1">Cloud</span></strong></span><span><span class="kobospan" id="kobo.419.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer688">
<span class="kobospan" id="kobo.420.1"><img alt="Figure 13.30 – New Azure monitoring host in Zabbix" src="image/B19803_13_30.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.421.1">Figure 13.30 – New Azure monitoring host in Zabbix</span></p>
<ol class="calibre16">
<li value="24" class="calibre15"><span class="kobospan" id="kobo.422.1">Before</span><a id="_idIndexMarker1035" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.423.1"> adding the host, switch to the </span><span><strong class="bold"><span class="kobospan" id="kobo.424.1">Macros</span></strong></span><span><span class="kobospan" id="kobo.425.1"> tab:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer689">
<span class="kobospan" id="kobo.426.1"><img alt="Figure 13.31– New Azure monitoring host macros in Zabbix" src="image/B19803_13_31.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.427.1">Figure 13.31– New Azure monitoring host macros in Zabbix</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.428.1">We will have to add at least the following </span><span><span class="kobospan" id="kobo.429.1">macros here:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.430.1">For </span><strong class="source-inline1"><span class="kobospan" id="kobo.431.1">{$AZURE.APP.ID}</span></strong><span class="kobospan" id="kobo.432.1">, fill in the application ID from </span><span><em class="italic"><span class="kobospan" id="kobo.433.1">step 5</span></em></span><span><span class="kobospan" id="kobo.434.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.435.1">For </span><strong class="source-inline1"><span class="kobospan" id="kobo.436.1">{$AZURE.PASSWORD}</span></strong><span class="kobospan" id="kobo.437.1">, fill in the value under the </span><strong class="bold"><span class="kobospan" id="kobo.438.1">Value</span></strong><span class="kobospan" id="kobo.439.1"> column from </span><span><em class="italic"><span class="kobospan" id="kobo.440.1">step 13</span></em></span><span><span class="kobospan" id="kobo.441.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.442.1">For </span><strong class="source-inline1"><span class="kobospan" id="kobo.443.1">{$AZURE.SUBSCRIPTION.ID}</span></strong><span class="kobospan" id="kobo.444.1">, fill in the subscription ID from </span><span><em class="italic"><span class="kobospan" id="kobo.445.1">step 15</span></em></span><span><span class="kobospan" id="kobo.446.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.447.1">For </span><strong class="source-inline1"><span class="kobospan" id="kobo.448.1">{$AZURE.TENANT.ID}</span></strong><span class="kobospan" id="kobo.449.1">, fill in the tenant ID from </span><span><em class="italic"><span class="kobospan" id="kobo.450.1">step 22</span></em></span><span><span class="kobospan" id="kobo.451.1">.</span></span></li>
</ul>
<ol class="calibre16">
<li value="25" class="calibre15"><span class="kobospan" id="kobo.452.1">That’s it; you can now add the new host by clicking on the </span><span><strong class="bold"><span class="kobospan" id="kobo.453.1">Add</span></strong></span><span><span class="kobospan" id="kobo.454.1"> button.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.455.1">After the discovery rule runs for the first time, your discovered instances will be added as new hosts, as you can see in the </span><span><span class="kobospan" id="kobo.456.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer690">
<span class="kobospan" id="kobo.457.1"><img alt="Figure 13.32 – New Azure-discovered virtual machine" src="image/B19803_13_32.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.458.1">Figure 13.32 – New Azure-discovered virtual machine</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.459.1">That’s it, your</span><a id="_idIndexMarker1036" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.460.1"> automated Azure monitoring is now working as expected. </span><span class="kobospan" id="kobo.460.2">Let’s have a look at how </span><span><span class="kobospan" id="kobo.461.1">it works.</span></span></p>
<h2 id="_idParaDest-403" class="calibre7"><span class="kobospan" id="kobo.462.1">How it</span><a id="_idTextAnchor2339" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2340" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2341" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.463.1"> works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.464.1">If you’ve followed the recipe on AWS monitoring, you might think that Azure monitoring works in the exact same way. </span><span class="kobospan" id="kobo.464.2">To an extent, that is true; the monitoring is completely based on API calls made from Zabbix toward the </span><span><span class="kobospan" id="kobo.465.1">Azure API.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.466.1">What is different between AWS and Azure is of course going to be the JavaScript scripts used in the Zabbix items on </span><span><span class="kobospan" id="kobo.467.1">the templates.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.468.1">The templates provided by Zabbix 7.0 out of the box use a fairly extensive piece of JavaScript code to execute API calls toward Azure, parse through the received data, and then put that into a JSON array that Zabbix low-level </span><span><span class="kobospan" id="kobo.469.1">discovery understands.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.470.1">Looking at the template found at </span><strong class="bold"><span class="kobospan" id="kobo.471.1">Data collection</span></strong><span class="kobospan" id="kobo.472.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.473.1">Templates</span></strong><span class="kobospan" id="kobo.474.1"> and then opening </span><strong class="bold"><span class="kobospan" id="kobo.475.1">Discovery</span></strong><span class="kobospan" id="kobo.476.1"> for the </span><strong class="bold"><span class="kobospan" id="kobo.477.1">Azure by HTTP</span></strong><span class="kobospan" id="kobo.478.1"> template, we can see six </span><span><span class="kobospan" id="kobo.479.1">discovery rules.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer691">
<span class="kobospan" id="kobo.480.1"><img alt="Figure 13.33 – Azure by HTTP discovery rules" src="image/B19803_13_33.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.481.1">Figure 13.33 – Azure by HTTP discovery rules</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.482.1">These six rules</span><a id="_idIndexMarker1037" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.483.1"> discover the different types of Azure database instances and virtual machines and use host prototypes to create a new host for each instance found. </span><span class="kobospan" id="kobo.483.2">The only difference here is that storage accounts won’t use host prototypes but item prototypes to supply you with information. </span><span class="kobospan" id="kobo.483.3">The hosts created by host prototypes will then in turn use their own templates to get the actual statistics from those instances or buckets, as we can see in the </span><span><span class="kobospan" id="kobo.484.1">template list:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer692">
<span class="kobospan" id="kobo.485.1"><img alt="Figure 13.34 – The other Azure templates in Zabbix 7.0" src="image/B19803_13_34.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.486.1">Figure 13.34 – The other Azure templates in Zabbix 7.0</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.487.1">In my case, only one virtual machine was discovered, and as such, that host was added with the </span><strong class="bold"><span class="kobospan" id="kobo.488.1">Azure Virtual Machine by HTTP</span></strong><span class="kobospan" id="kobo.489.1"> template, as seen in </span><span><em class="italic"><span class="kobospan" id="kobo.490.1">Figure 13</span></em></span><span><em class="italic"><span class="kobospan" id="kobo.491.1">.32</span></em></span><span><span class="kobospan" id="kobo.492.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.493.1">All of the </span><a id="_idIndexMarker1038" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.494.1">information is then collected by </span><strong class="bold"><span class="kobospan" id="kobo.495.1">Script</span></strong><span class="kobospan" id="kobo.496.1"> item types with their own unique JavaScript code. </span><span class="kobospan" id="kobo.496.2">We can see a piece of the code in the following screenshot, where we make a call to Azure to a specific </span><span><span class="kobospan" id="kobo.497.1">URL (underlined):</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer693">
<span class="kobospan" id="kobo.498.1"><img alt="Figure 13.35 – Azure template call" src="image/B19803_13_35_new.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.499.1">Figure 13.35 – Azure template call</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.500.1">It is also possible to edit this JavaScript code to create entirely new calls to retrieve your own data and create different types of monitoring, as well as simply extending the </span><span><span class="kobospan" id="kobo.501.1">out-of-the-box templates.</span></span></p>
<h2 id="_idParaDest-404" class="calibre7"><span class="kobospan" id="kobo.502.1">There’s</span><a id="_idTextAnchor2342" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2343" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.503.1"> more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.504.1">We can discover way more from Azure using the method applied in this recipe. </span><span class="kobospan" id="kobo.504.2">The JavaScript we employ is used to get metrics from Azure, which can be edited to gather almost any metric from the </span><span><span class="kobospan" id="kobo.505.1">Azure API.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.506.1">Check out the Azure API documentation for more information on the metrics retrieved </span><span><span class="kobospan" id="kobo.507.1">using JavaScript:</span></span></p>
<p class="calibre3"><a href="https://learn.microsoft.com/en-us/rest/api/azure/" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.508.1">https://learn.microsoft.com/en-us/rest/api/azure/</span></span></a></p>
<h1 id="_idParaDest-405" class="calibre5"><span class="kobospan" id="kobo.509.1">Buildin</span><a id="_idTextAnchor2344" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2345" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.510.1">g your Zabbix Docker monitoring</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.511.1">Ever since the release</span><a id="_idTextAnchor2346" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.512.1"> of</span><a id="_idIndexMarker1039" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.513.1"> Zabbix 5, monitoring our Docker containers became a lot easier with the introduction of Zabbix agent 2 and plugins. </span><span class="kobospan" id="kobo.513.2">Using Zabbix agent 2 and Zabbix 7, we are able to monitor our Docker containers out of </span><span><span class="kobospan" id="kobo.514.1">the box.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.515.1">In this recipe, we are going to see how to set this up and how </span><span><span class="kobospan" id="kobo.516.1">it works.</span></span></p>
<h2 id="_idParaDest-406" class="calibre7"><span class="kobospan" id="kobo.517.1">Gettin</span><a id="_idTextAnchor2347" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2348" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.518.1">g ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.519.1">For this recipe, we require some Docker containers. </span><span class="kobospan" id="kobo.519.2">We won’t go over the setup of Docker containers, so make sure to do this yourself. </span><span class="kobospan" id="kobo.519.3">Furthermore, we are going to need Zabbix agent 2 installed on the host running these Docker containers. </span><span class="kobospan" id="kobo.519.4">Zabbix agent does not work in relation to this recipe; Zabbix agent 2 </span><span><span class="kobospan" id="kobo.520.1">is required.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.521.1">We also need our Zabbix server to actually monitor the Docker containers. </span><span class="kobospan" id="kobo.521.2">We will call our Zabbix </span><span><span class="kobospan" id="kobo.522.1">server </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.523.1">zbx-home</span></strong></span><span><span class="kobospan" id="kobo.524.1">.</span></span></p>
<h2 id="_idParaDest-407" class="calibre7"><span class="kobospan" id="kobo.525.1">How to</span><a id="_idTextAnchor2349" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2350" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.526.1"> do it…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.527.1">Let’s waste no </span><a id="_idIndexMarker1040" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.528.1">more time and dive right into the process of monitoring your Docker setup </span><span><span class="kobospan" id="kobo.529.1">with Zabbix:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.530.1">First things first, log in to the Linux CLI of the host running your </span><span><span class="kobospan" id="kobo.531.1">Docker container(s).</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.532.1">Add the repo</span><a id="_idTextAnchor2351" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.533.1">sitory for installing </span><span><span class="kobospan" id="kobo.534.1">Zabbix components.</span></span><p class="calibre3"><span class="kobospan" id="kobo.535.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.536.1">the following:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.537.1">rpm -Uvh https://repo.zabbix.com/zabbix/7.0/rhel/8x86_64/zabbix-release-7.0-1.el8.noarch.rpm</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.538.1">dnf clean all</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.539.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.540.1">the following:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.541.1">wget https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.542.1">dpkg -i zabbix-release_7.0-1+ubuntu22.04_all.deb</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.543.1">apt update</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.544.1">Now, install Zabbix agent 2 with the </span><span><span class="kobospan" id="kobo.545.1">following command.</span></span><p class="calibre3"><span class="kobospan" id="kobo.546.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.547.1">the following:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.548.1">dnf install zabbix-agent2</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.549.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.550.1">the following:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.551.1">apt install zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.552.1">Following installation, make sure to edit the configuration file of the newly installed Zabbix agent 2 with the help of the </span><span><span class="kobospan" id="kobo.553.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.554.1">vim /etc/zabbix/zabbix_agent2.conf</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.555.1">Find the line that says </span><strong class="source-inline1"><span class="kobospan" id="kobo.556.1">Server</span></strong><span class="kobospan" id="kobo.557.1"> and add your Zabbix server IP address to the file, </span><span><span class="kobospan" id="kobo.558.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.559.1">Server=10.16.16.102</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.560.1">Now, we</span><a id="_idIndexMarker1041" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.561.1"> need to add the </span><strong class="source-inline1"><span class="kobospan" id="kobo.562.1">zabbix</span></strong><span class="kobospan" id="kobo.563.1"> user to the Docker group by executing the </span><span><span class="kobospan" id="kobo.564.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.565.1">gpasswd -a zabbix docker</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.566.1">Make sure to save the file and then restart Zabbix agent 2 with the </span><span><span class="kobospan" id="kobo.567.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.568.1">systemctl restart zabbix-agent2</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.569.1">Now, navigate to your Zabbix server frontend. </span><span class="kobospan" id="kobo.569.2">Go to </span><strong class="bold"><span class="kobospan" id="kobo.570.1">Data collection</span></strong><span class="kobospan" id="kobo.571.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.572.1">Hosts</span></strong><span class="kobospan" id="kobo.573.1"> and click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.574.1">Create </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.575.1">host</span></strong></span><span><span class="kobospan" id="kobo.576.1"> button.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.577.1">Let’s create a new host called </span><strong class="source-inline1"><span class="kobospan" id="kobo.578.1">Docker containers</span></strong><span class="kobospan" id="kobo.579.1"> and make sure to link the </span><strong class="bold"><span class="kobospan" id="kobo.580.1">Docker by Zabbix agent 2</span></strong><span class="kobospan" id="kobo.581.1"> template to </span><span><span class="kobospan" id="kobo.582.1">the host.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer694">
<span class="kobospan" id="kobo.583.1"><img alt="Fig﻿ure 13.36 – New Docker host configuration" src="image/B19803_13_36.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.584.1">Fig</span><a id="_idTextAnchor2352" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.585.1">ure 13.36 – New Docker host configuration</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.586.1">That’s all there is to monitoring Docker containers with the Zabbix server. </span><span class="kobospan" id="kobo.586.2">Let’s now see how </span><span><span class="kobospan" id="kobo.587.1">it works.</span></span></p>
<h2 id="_idParaDest-408" class="calibre7"><span class="kobospan" id="kobo.588.1">How i</span><a id="_idTextAnchor2353" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2354" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.589.1">t works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.590.1">Docker </span><a id="_idIndexMarker1042" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.591.1">monitoring in Zabbix these days is easy, due to the new Zabbix agent 2 support and default templates. </span><span class="kobospan" id="kobo.591.2">On occasion, though, a default template does not cut it, so let’s break down the </span><span><span class="kobospan" id="kobo.592.1">items used.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.593.1">Almost all the items we can see on our host are dependent items, most of which are dependent on the master item, </span><strong class="source-inline"><span class="kobospan" id="kobo.594.1">Docker: Get info</span></strong><span class="kobospan" id="kobo.595.1">. </span><span class="kobospan" id="kobo.595.2">This master item is the most important item on our Docker template. </span><span class="kobospan" id="kobo.595.3">It executes the </span><strong class="source-inline"><span class="kobospan" id="kobo.596.1">docker.info</span></strong><span class="kobospan" id="kobo.597.1"> item key, which is built into the new Zabbix agent 2. </span><span class="kobospan" id="kobo.597.2">This item retrieves a list with all kinds of information from our Docker setup. </span><span class="kobospan" id="kobo.597.3">We use the dependent items and preprocessing to get the values we want from this </span><span><span class="kobospan" id="kobo.598.1">master item.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.599.1">The Docker temp</span><a id="_idTextAnchor2355" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.600.1">late also contains two Zabbix discovery rules, one to discover Docker images and one to discover Docker containers. </span><span class="kobospan" id="kobo.600.2">If we check out the discovery rule for Docker containers called </span><strong class="source-inline"><span class="kobospan" id="kobo.601.1">Containers discovery</span></strong><span class="kobospan" id="kobo.602.1">, we can see what happens. </span><span class="kobospan" id="kobo.602.2">Our Zabbix Docker host will use the </span><strong class="source-inline"><span class="kobospan" id="kobo.603.1">docker.containers.discovery</span></strong><span class="kobospan" id="kobo.604.1"> item key to find every container and put this in the </span><strong class="source-inline"><span class="kobospan" id="kobo.605.1">{#NAME}</span></strong><span class="kobospan" id="kobo.606.1"> LLD macro. </span><span class="kobospan" id="kobo.606.2">In the item prototypes, we then use this </span><strong class="source-inline"><span class="kobospan" id="kobo.607.1">{#NAME}</span></strong><span class="kobospan" id="kobo.608.1"> LLD macro to discover statistics with another master item, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.609.1">docker.container_info</span></strong><span class="kobospan" id="kobo.610.1">. </span><span class="kobospan" id="kobo.610.2">From this master item, we then use the dependent items and preprocessing again to include this information in other item prototypes as well. </span><span class="kobospan" id="kobo.610.3">We are now monitoring a bunch of statistics straight from our </span><span><span class="kobospan" id="kobo.611.1">Docker setup.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.612.1">If you want to get values from Docker that aren’t in the default template, check out the information collected with the master items on the template. </span><span class="kobospan" id="kobo.612.2">Use a new dependent item (prototype) and </span><a id="_idIndexMarker1043" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.613.1">then use preprocessing to get the correct data from the </span><span><span class="kobospan" id="kobo.614.1">master item.</span></span></p>
<h2 id="_idParaDest-409" class="calibre7"><span class="kobospan" id="kobo.615.1">The</span><a id="_idTextAnchor2356" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2357" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.616.1">re’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.617.1">If you want to learn more about the </span><a id="_idIndexMarker1044" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.618.1">Zabbix agent 2 Docker item keys, check out the supported item key list f</span><a id="_idTextAnchor2358" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.619.1">or Zabbix agent 2 in the </span><span><span class="kobospan" id="kobo.620.1">Zabbix documentation:</span></span></p>
<p class="calibre3"><a href="https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/zabbix_agent/zabbix_agent2?s%5B%5D=docker" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.621.1">https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/zabbix_agent/zabbix_agent2?s[]=docker</span></span></a><span><span class="kobospan" id="kobo.622.1">.</span></span></p>
</div>
</body></html>