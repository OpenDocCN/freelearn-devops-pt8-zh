<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Mastering modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Mastering modules</h1></div></div></div><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>There are no big problems, there are just a lot of little problems.</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Henry Ford</em></span></span></td></tr></table></div><p>In this chapter you'll learn about Puppet Forge, the public repository for Puppet modules, and you'll see how to install and use third-party modules from Puppet Forge, using the <code class="literal">r10k</code> module management tool. You'll see examples of how to use three important Forge modules: <code class="literal">puppetlabs/apache</code>, <code class="literal">puppetlabs/mysql</code>, and <code class="literal">puppet/archive</code>. You'll be introduced to some useful functions provided by <code class="literal">puppetlabs/stdlib</code>, the Puppet standard library. Finally, working through a complete example, you'll learn how to develop your own Puppet module from scratch, how to add appropriate metadata for your module, and how to upload it to Puppet Forge.</p><div class="mediaobject"><img src="graphics/8880_07_01.jpg" alt="Mastering modules"/></div><div class="section" title="Using Puppet Forge modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec37"/>Using Puppet Forge modules</h1></div></div></div><p>Although you <a id="id308" class="indexterm"/>could write your own manifests for everything you want to manage, you can save yourself a lot of time and effort by using public Puppet modules wherever possible. A <span class="strong"><strong>module</strong></span> in Puppet is a self-contained unit of shareable, reusable code, usually designed to manage one particular service or piece of software, such as the Apache web server.</p><div class="section" title="What is the Puppet Forge?"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec107"/>What is the Puppet Forge?</h2></div></div></div><p>The <span class="strong"><strong>Puppet Forge</strong></span> is a <a id="id309" class="indexterm"/>public repository of Puppet modules, many of them officially supported and maintained by Puppet and all of which you can download and use. You can browse the Forge at the following URL:</p><p>
<a class="ulink" href="https://forge.puppet.com/">https://forge.puppet.com/</a>
</p><p>One of the advantages of using a well-established tool like Puppet is that there are a large number of mature public modules available, which cover the most common software you're likely to need. For example, here is a small selection of the things you can manage with public modules from Puppet Forge:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MySQL/PostgreSQL/SQL Server</li><li class="listitem" style="list-style-type: disc">Apache/Nginx</li><li class="listitem" style="list-style-type: disc">Java/Tomcat/PHP/Ruby/Rails</li><li class="listitem" style="list-style-type: disc">HAProxy</li><li class="listitem" style="list-style-type: disc">Amazon AWS</li><li class="listitem" style="list-style-type: disc">Docker</li><li class="listitem" style="list-style-type: disc">Jenkins</li><li class="listitem" style="list-style-type: disc">Elasticsearch/Redis/Cassandra</li><li class="listitem" style="list-style-type: disc">Git repos</li><li class="listitem" style="list-style-type: disc">Firewalls (via iptables)</li></ul></div></div><div class="section" title="Finding the module you need"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec108"/>Finding the module you need</h2></div></div></div><p>The Puppet Forge <a id="id310" class="indexterm"/>home page has a search bar at the top. Type what you're looking for into this box, and the website will show you all the modules which match your search keywords. Often, there will be more than one result, so how do you decide which module to use?</p><p>The best choice is a <span class="strong"><strong>Puppet Supported</strong></span> module, if one is available. These are officially supported and maintained by Puppet, and you can be confident that supported modules will work with a wide range of operating systems and Puppet versions. Supported modules are indicated by a yellow <span class="strong"><strong>SUPPORTED</strong></span> flag in search results, or you can browse the list of all supported modules at the following URL:</p><p>
<a class="ulink" href="https://forge.puppet.com/modules?endorsements=supported">https://forge.puppet.com/modules?endorsements=supported</a>
</p><p>The next best option is a <span class="strong"><strong>Puppet Approved</strong></span> module. While not officially supported, these modules are recommended by Puppet and have been checked to make sure they follow best practices and meet certain quality standards. Approved modules are indicated by a green <span class="strong"><strong>APPROVED</strong></span> flag in search results, or you can browse the list of all approved modules at the following URL:</p><p>
<a class="ulink" href="https://forge.puppet.com/modules?endorsements=approved">https://forge.puppet.com/modules?endorsements=approved</a>
</p><p>Assuming that a Puppet-Supported or Puppet-Approved module is not available, another useful way to choose modules is by looking at the number of downloads. Selecting the <span class="strong"><strong>Most Downloads</strong></span> tab on the Puppet Forge search results page will sort the results by downloads, with the most popular modules first. The most-downloaded modules are not necessarily the best, of course, but they're usually a good place to start.</p><p>It's also worth <a id="id311" class="indexterm"/>checking the latest release date for modules. If the module you're looking at hasn't been updated in over a year, it may be better to go with a more actively-maintained module, if one is available. Clicking on the <span class="strong"><strong>Latest release</strong></span> tab will sort search results by the most recently updated.</p><p>You can also filter search results by operating system support and Puppet version compatibility; this can be very useful for finding a module that works with your system.</p><p>Having chosen the module you want, it's time to add it to your Puppet infrastructure.</p></div><div class="section" title="Using r10k"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec109"/>Using r10k</h2></div></div></div><p>In the past, many <a id="id312" class="indexterm"/>people used to download Puppet Forge modules directly and check a copy of them into their codebase, effectively forking the module repo (and <a id="id313" class="indexterm"/>some still do this). There are many drawbacks to this approach. One is that your codebase becomes cluttered with code that is not yours, and this can make it difficult to search for the code you want. Another is that it's difficult to test your code with different versions of public modules, without creating your own Git branches, redownloading the modules, and so on. You also won't get future bug fixes and improvements from the Puppet Forge modules unless you manually update your copies. In many cases, you will need to make small changes or fixes to the modules to use them in your environment, and your version of the module will then diverge from the upstream version, storing up maintenance problems for the future.</p><p>A much better approach to module management, therefore, is to use the <code class="literal">r10k</code> tool, which eliminates these problems. Instead of downloading the modules you need directly and adding them to your codebase, <code class="literal">r10k</code> installs your required modules on each Puppet-managed node, using a special text file called a <span class="strong"><strong>Puppetfile</strong></span>. <code class="literal">r10k</code> will manage the contents of your <code class="literal">modules/</code> directory, based entirely on the Puppetfile metadata. The module code is never checked into your codebase, but always downloaded from the Puppet Forge when requested. So you can stay up to date with the latest releases if you want, or pin each module to a specified version which you know works with your manifest.</p><p>
<code class="literal">r10k</code> is the de facto standard module manager for Puppet deployments, and we'll be using it to manage modules throughout the rest of this book.</p><p>In this example, we'll <a id="id314" class="indexterm"/>use <code class="literal">r10k</code> to install the <code class="literal">puppetlabs/stdlib</code> module. The Puppetfile in the example repo contains a list of all the modules we'll use in this book. Here it is (we'll look more closely at the syntax in a moment):</p><div class="informalexample"><pre class="programlisting">forge 'http://forge.puppetlabs.com'

mod 'garethr/docker', '5.3.0'
mod 'puppet/archive', '1.3.0'
mod 'puppet/staging', '2.2.0'
mod 'puppetlabs/apache', '2.0.0'
mod 'puppetlabs/apt', '3.0.0'
mod 'puppetlabs/aws', '2.0.0'
mod 'puppetlabs/concat', '4.0.1'
mod 'puppetlabs/docker_platform', '2.2.1'
mod 'puppetlabs/mysql', '3.11.0'
mod 'puppetlabs/stdlib', '4.17.1'
mod 'stahnma/epel', '1.2.2'

mod 'pbg_ntp',
  :git =&gt; 'https://github.com/bitfield/pbg_ntp.git',
  :tag =&gt; '0.1.4'</pre></div><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following commands to clear out your <code class="literal">modules/</code> directory, if there's anything in it (make sure you have backed up anything here you want to keep):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /etc/puppetlabs/code/environments/pbg</strong></span>
<span class="strong"><strong>sudo rm -rf modules/</strong></span>
</pre></div></li><li class="listitem">Run the following command to have <code class="literal">r10k</code> process the example Puppetfile here and install your requested modules:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo r10k puppetfile install --verbose</strong></span>
</pre></div></li></ol></div><p>
<code class="literal">r10k</code> downloads all the modules listed in the Puppetfile into the <code class="literal">modules/</code> directory. All modules in this directory will be automatically loaded by Puppet and available for use in your manifests. To test that the <code class="literal">stdlib</code> module is correctly installed, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment pbg -e "notice(upcase('hello'))"</strong></span>
Notice: Scope(Class[main]): HELLO</pre></div><p>The <code class="literal">upcase</code> function, which converts its string argument to uppercase, is part of the <code class="literal">stdlib</code> module. If this <a id="id315" class="indexterm"/>doesn't work, then <code class="literal">stdlib</code> has not been properly installed. As in previous examples, we're using the <code class="literal">--environment pbg</code> switch to tell Puppet to look for code, modules, and data in the <code class="literal">/etc/puppetlabs/code/environments/pbg</code> directory.</p></div><div class="section" title="Understanding the Puppetfile"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec110"/>Understanding the Puppetfile</h2></div></div></div><p>The example <a id="id316" class="indexterm"/>Puppetfile begins with the following:</p><div class="informalexample"><pre class="programlisting">forge 'http://forge.puppetlabs.com'</pre></div><p>The <code class="literal">forge</code> statement specifies the repository where modules should be retrieved from.</p><p>There follows a group of lines beginning with <code class="literal">mod</code>:</p><div class="informalexample"><pre class="programlisting">mod 'garethr/docker', '5.3.0'
mod 'puppet/archive', '1.3.0'
mod 'puppet/staging', '2.2.0'
...</pre></div><p>The <code class="literal">mod</code> statement specifies the name of the module (<code class="literal">puppetlabs/stdlib</code>) and the specific version of the module to install (<code class="literal">4.17.0</code>).</p></div><div class="section" title="Managing dependencies with generate-puppetfile"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec111"/>Managing dependencies with generate-puppetfile</h2></div></div></div><p>
<code class="literal">r10k</code> <a id="id317" class="indexterm"/>does not automatically manage dependencies between modules. For example, the <code class="literal">puppetlabs/apache</code> module depends on having both <code class="literal">puppetlabs/stdlib</code> and <code class="literal">puppetlabs/concat</code> installed. <code class="literal">r10k</code> will not automatically install these for you <a id="id318" class="indexterm"/>unless you specify them, so you also need to include them in your Puppetfile.</p><p>However, you can use the <code class="literal">generate-puppetfile</code> tool to find out what dependencies you need so that you can add them to your Puppetfile.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following command to install the <code class="literal">generate-puppetfile</code> gem:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo gem install generate-puppetfile</strong></span>
</pre></div></li><li class="listitem">Run the <a id="id319" class="indexterm"/>following command to generate the Puppetfile for a list of specified modules (list all the modules you need on the command line, separated by spaces):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>generate-puppetfile puppetlabs/docker_platform</strong></span>
Installing modules. This may take a few minutes.
Your Puppetfile has been generated. Copy and paste between the markers:
=============================================
forge 'http://forge.puppetlabs.com'

# Modules discovered by generate-puppetfile
mod 'garethr/docker', '5.3.0'
mod 'puppetlabs/apt', '3.0.0'
mod 'puppetlabs/docker_platform', '2.2.1'
mod 'puppetlabs/stdlib', '4.17.1'
mod 'stahnma/epel', '1.2.2'
=============================================</pre></div></li><li class="listitem">Run the following command to generate a list of updated versions and dependencies for an existing Puppetfile:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>generate-puppetfile -p /etc/puppetlabs/code/environments/pbg/Puppetfile</strong></span>
</pre></div></li></ol></div><p>This is an extremely <a id="id320" class="indexterm"/>useful tool both for finding dependencies you need to specify in your Puppetfile and for keeping your Puppetfile up to date with the latest versions of all the modules you use.</p></div></div></div>
<div class="section" title="Using modules in your manifests"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec38"/>Using modules in your manifests</h1></div></div></div><p>Now that we <a id="id321" class="indexterm"/>know how to find and install public Puppet modules, let's see how to use them. We'll work through a few examples, using the <code class="literal">puppetlabs/mysql</code> module to set up a MySQL server and database, using the <code class="literal">puppetlabs/apache</code> module to set up an Apache website, and using <code class="literal">puppet/archive</code> to download and unpack a compressed archive. After you've tried out these examples, you should feel quite confident in your ability to find an appropriate Puppet module, add it to your <code class="literal">Puppetfile</code>, and deploy it with <code class="literal">r10k</code>.</p><div class="section" title="Using puppetlabs/mysql"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec112"/>Using puppetlabs/mysql</h2></div></div></div><p>Follow these <a id="id322" class="indexterm"/>steps to run the <code class="literal">puppetlabs/mysql</code> example:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you've previously followed the steps in the <span class="emphasis"><em>Using r10k</em></span> section, the required module will already be installed. If not, run the following commands to install it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /etc/puppetlabs/code/environments/pbg</strong></span>
<span class="strong"><strong>sudo r10k puppetfile install</strong></span>
</pre></div></li><li class="listitem">Run the following command to apply the manifest:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment=pbg /examples/module_mysql.pp</strong></span>
Notice: Compiled catalog for ubuntu-xenial in environment pbg in 0.89 seconds
Notice: /Stage[main]/Mysql::Server::Config/File[/etc/mysql]/ensure: created
Notice: /Stage[main]/Mysql::Server::Config/File[/etc/mysql/conf.d]/ensure: created
Notice: /Stage[main]/Mysql::Server::Config/File[mysql-config-file]/ensure: defined content as '{md5}44e7aa974ab98260d7d013a2087f1c77'
Notice: /Stage[main]/Mysql::Server::Install/Package[mysql-server]/ensure: created
Notice: /Stage[main]/Mysql::Server::Root_password/Mysql_user[root@localhost]/password_hash: password_hash changed '' to '*F4AF2E5D85456A908E0F552F0366375B06267295'
Notice: /Stage[main]/Mysql::Server::Root_password/File[/root/.my.cnf]/ensure: defined content as '{md5}4d59f37fc8a385c9c50f8bb3286b7c85'
Notice: /Stage[main]/Mysql::Client::Install/Package[mysql_client]/ensure: created
Notice: /Stage[main]/Main/Mysql::Db[cat_pictures]/Mysql_database[cat_pictures]/ensure: created
Notice: /Stage[main]/Main/Mysql::Db[cat_pictures]/Mysql_user[greebo@localhost]/ensure: created
Notice: /Stage[main]/Main/Mysql::Db[cat_pictures]/Mysql_grant[greebo@localhost/cat_pictures.*]/ensure: created
Notice: Applied catalog in 79.85 seconds</pre></div></li></ol></div><p>Let's take a look at the example manifest (<code class="literal">module_mysql.pp</code>). The first part installs the MySQL server itself, by including the class <code class="literal">mysql::server</code>:</p><div class="informalexample"><pre class="programlisting"># Install MySQL and set up an example database
include mysql::server</pre></div><p>The <code class="literal">mysql::server</code> class accepts a number of parameters, most of which we needn't worry about for now, but we would like to set a couple of them for this example. Although you can set the values for class parameters directly in your Puppet manifest code, just as you would for resource attributes, I'll show you a better way to do it: using Hiera's automatic <a id="id323" class="indexterm"/>parameter lookup mechanism.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip32"/>Tip</h3><p>We mentioned briefly in <a class="link" href="ch06.html" title="Chapter 6. Managing data with Hiera">Chapter 6</a>, <span class="emphasis"><em>Managing data with Hiera</em></span>, that Hiera can supply values for class and module parameters, but how does it work, exactly? When you include a class <code class="literal">x</code> which takes a parameter <code class="literal">y</code>, Puppet automatically searches Hiera for any keys matching the name <code class="literal">x::y</code>. If it finds one, it uses that value for the parameter. Just as with any other Hiera data, you can use the hierarchy to set different values for different nodes, roles, or operating systems.</p></div></div><p>In this example, our parameters are set in the example Hiera data file (<code class="literal">/etc/puppetlabs/code/environments/pbg/data/common.yaml</code>):</p><div class="informalexample"><pre class="programlisting">mysql::server::root_password: 'hairline-quotient-inside-tableful'
mysql::server::remove_default_accounts: true</pre></div><p>The <code class="literal">root_password</code> parameter, as you'd expect, sets the password for the MySQL <code class="literal">root</code> user. We also enable <code class="literal">remove_default_accounts</code>, which is a security feature. MySQL ships with various default user accounts for testing purposes, which should be turned off in production. This parameter disables these default accounts.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip33"/>Tip</h3><p>Note that although we've specified the password in plain text for the purposes of clarity, in your production manifests, this should be encrypted, just as with any other credentials or secret data (see <a class="link" href="ch06.html" title="Chapter 6. Managing data with Hiera">Chapter 6</a>, <span class="emphasis"><em>Managing data with Hiera</em></span>).</p></div></div><p>Next comes a resource declaration:</p><div class="informalexample"><pre class="programlisting">mysql::db { 'cat_pictures':
  user     =&gt; 'greebo',
  password =&gt; 'tabby',
  host     =&gt; 'localhost',
  grant    =&gt; ['SELECT', 'UPDATE'],
}</pre></div><p>As you can see, this looks just like the built-in resources we've used before, such as the <code class="literal">file</code> and <code class="literal">package</code> resources. In effect, the <code class="literal">mysql</code> module has added a new resource type to Puppet: <code class="literal">mysql::db</code>. This resource models a specific MySQL database: <code class="literal">cat_pictures</code> in our example.</p><p>The title of the resource is the name of the database, in this case, <code class="literal">cat_pictures</code>. There follows a list of attributes. The <code class="literal">user</code>, <code class="literal">password</code>, and <code class="literal">host</code> attributes specify that the user <code class="literal">greebo</code> should be allowed to connect to the database from <code class="literal">localhost</code> using the password <code class="literal">tabby</code>. The <code class="literal">grant</code> attribute specifies the MySQL privileges that the user should have: <code class="literal">SELECT</code> and <code class="literal">UPDATE</code> on the database.</p><p>When this manifest is applied, Puppet will create the <code class="literal">cat_pictures</code> database and set up the <code class="literal">greebo</code> user account to <a id="id324" class="indexterm"/>access it. This is a very common pattern for Puppet manifests which manage an application: usually, the application needs some sort of database to store its state, and user credentials to access it. The <code class="literal">mysql</code> module lets you configure this very easily.</p><p>So we can now see the general principles of using a Puppet Forge module:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We add the module and its dependencies to our <code class="literal">Puppetfile</code> and deploy it using <code class="literal">r10k</code></li><li class="listitem" style="list-style-type: disc">We <code class="literal">include</code> the class in our manifest, supplying any required parameters as Hiera data</li><li class="listitem" style="list-style-type: disc">Optionally, we add one or more resource declarations of a custom resource type defined by the module (in this case, a MySQL database)</li></ul></div><p>Almost all Puppet modules work in a similar way. In the next section, we'll look at some key modules which you're likely to need in the course of managing servers with Puppet.</p></div><div class="section" title="Using puppetlabs/apache"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec113"/>Using puppetlabs/apache</h2></div></div></div><p>Most applications <a id="id325" class="indexterm"/>have a web interface of some kind, which usually requires a web server, and the venerable Apache remains a popular choice. The <code class="literal">puppetlabs/apache</code> module not only installs and configures Apache, but also allows you to manage virtual hosts (individual websites, such as the frontend for your application).</p><p>Here's an example manifest which uses the <code class="literal">apache</code> module to create a simple virtual host serving an image file (<code class="literal">module_apache.pp</code>):</p><div class="informalexample"><pre class="programlisting">include apache

apache::vhost { 'cat-pictures.com':
  port          =&gt; '80',
  docroot       =&gt; '/var/www/cat-pictures',
  docroot_owner =&gt; 'www-data',
  docroot_group =&gt; 'www-data',
}

file { '/var/www/cat-pictures/index.html':
  content =&gt; "&lt;img 
    src='http://bitfieldconsulting.com/files/happycat.jpg'&gt;",
  owner   =&gt; 'www-data',
  group   =&gt; 'www-data',
}</pre></div><p>Follow these steps to apply the manifest:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you've previously followed the steps in the <span class="emphasis"><em>Using r10k</em></span> section, the required module will already be installed. If not, run the following commands to install it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /etc/puppetlabs/code/environments/pbg</strong></span>
<span class="strong"><strong>sudo r10k puppetfile install</strong></span>
</pre></div></li><li class="listitem">Run the following command to apply the manifest:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment=pbg /examples/module_apache.pp</strong></span>
</pre></div></li><li class="listitem">To test the new website, point your browser to (for Vagrant users; if you're not using the Vagrant box, browse to port <code class="literal">80</code> on the server you're managing with Puppet) <code class="literal">http://localhost:8080/</code></li></ol></div><p>You should see <a id="id326" class="indexterm"/>a picture of a happy cat:</p><div class="mediaobject"><img src="graphics/8880_07_02.jpg" alt="Using puppetlabs/apache"/></div><p>Let's go through the manifest and see how it works in detail.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">It starts with the <code class="literal">include</code> declaration which actually installs Apache on the server (<code class="literal">module_apache.pp</code>):<div class="informalexample"><pre class="programlisting">include apache</pre></div></li><li class="listitem">There are many parameters you could set for the <code class="literal">apache</code> class, but in this example, we only need to set one, and as with the other examples, we set it using Hiera data in the example Hiera file:<div class="informalexample"><pre class="programlisting">apache::default_vhost: false</pre></div><p>This disables the default <span class="strong"><strong>Apache 2 Test Page</strong></span> virtual host.</p></li><li class="listitem">Next comes a <a id="id327" class="indexterm"/>resource declaration for an <code class="literal">apache::vhost</code> resource, which creates an Apache virtual host or website.<div class="informalexample"><pre class="programlisting">apache::vhost { 'cat-pictures.com':
  port          =&gt; '80',
  docroot       =&gt; '/var/www/cat-pictures',
  docroot_owner =&gt; 'www-data',
  docroot_group =&gt; 'www-data',
}</pre></div><p>The title of the resource is the domain name which the virtual host will respond to (<code class="literal">cat-pictures.com</code>). The <code class="literal">port</code> tells Apache which port to listen on for requests. The <code class="literal">docroot</code> identifies the pathname of the directory where Apache will find the website files on the server. Finally, the <code class="literal">docroot_owner</code> and <code class="literal">docroot_group</code> attributes specify the user and group which should own the <code class="literal">docroot/</code> directory.</p></li><li class="listitem">Finally, we create an <code class="literal">index.html</code> file to add some content to the website, in this case, an image of a happy cat.<div class="informalexample"><pre class="programlisting">file { '/var/www/cat-pictures/index.html':
  content =&gt; "&lt;img 
    src='http://bitfieldconsulting.com/files/happycat.jpg'&gt;",
  owner   =&gt; 'www-data',
  group   =&gt; 'www-data',
}</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>Note that port <code class="literal">80</code> on the Vagrant box is mapped to port <code class="literal">8080</code> on your local machine, so browsing to <code class="literal">http://localhost:8080</code> is the equivalent of browsing directly to port <code class="literal">80</code> on the Vagrant box. If for some reason you need to change this port mapping, edit your <code class="literal">Vagrantfile</code> (in the Puppet Beginner's Guide repo) and look for the following line:</p><div class="informalexample"><pre class="programlisting">config.vm.network "forwarded_port", guest: 80, host: 8080</pre></div><p>Change these settings <a id="id328" class="indexterm"/>as required and run the following command on your local machine in the PBG repo directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>vagrant reload</strong></span>
</pre></div></div></div></div><div class="section" title="Using puppet/archive"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec114"/>Using puppet/archive</h2></div></div></div><p>While installing <a id="id329" class="indexterm"/>software from packages is a common task, you'll also occasionally need to install software from archive files, such as a tarball (a <code class="literal">.tar.gz</code> file) or ZIP file. The <code class="literal">puppet/archive</code> module is a great help for this, as it provides an easy way to download archive files from the Internet, and it can also unpack them for you.</p><p>In the following example, we'll use the <code class="literal">puppet/archive</code> module to download and unpack the latest version of the popular WordPress blogging software. Follow these steps to apply the manifest:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you've previously followed the steps in the <span class="emphasis"><em>Using r10k</em></span> section, the required module will already be installed. If not, run the following commands to install it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /etc/puppetlabs/code/environments/pbg</strong></span>
<span class="strong"><strong>sudo r10k puppetfile install</strong></span>
</pre></div></li><li class="listitem">Run the following command to apply the manifest:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment=pbg /examples/module_archive.pp</strong></span>
Notice: Compiled catalog for ubuntu-xenial in environment production in 2.50 seconds
Notice: /Stage[main]/Main/Archive[/tmp/wordpress.tar.gz]/ensure: download archive from https://wordpress.org/latest.tar.gz to /tmp/wordpress.tar.gz and extracted in /var/www with cleanup</pre></div></li></ol></div><p>Unlike the previous modules in this chapter, there's nothing to install with <code class="literal">archive</code>, so we don't need to include the class itself. All you need to do is declare an <code class="literal">archive</code> resource. Let's look at the example in detail to see how it works (<code class="literal">module_archive.pp</code>):</p><div class="informalexample"><pre class="programlisting">archive { '/tmp/wordpress.tar.gz':
  ensure       =&gt; present,
  extract      =&gt; true,
  extract_path =&gt; '/var/www',
  source       =&gt; 'https://wordpress.org/latest.tar.gz',
  creates      =&gt; '/var/www/wordpress',
  cleanup      =&gt; true,
}</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The title gives the path to where you want the archive file to be downloaded (<code class="literal">/tmp/wordpress.tar.gz</code>). Assuming you don't need to keep the archive file after it's been unpacked, it's usually a good idea to put it in <code class="literal">/tmp</code>.</li><li class="listitem">The <code class="literal">extract</code> attribute determines whether or not Puppet should unpack the archive; this should usually be set to <code class="literal">true</code>.</li><li class="listitem">The <code class="literal">extract_path</code> attribute specifies where to unpack the contents of the archive. In this case, it makes sense to extract it to a subdirectory of <code class="literal">/var/www/</code>, but this will vary depending on the nature of the archive. If the archive file contains software which will be compiled and installed, for example, it may be a good idea to unpack it in <code class="literal">/tmp/</code>, so that the files will be automatically cleaned up after the next reboot.</li><li class="listitem">The <code class="literal">source</code> attribute tells Puppet where to download the archive from, usually (as in this example) a web URL.</li><li class="listitem">The <code class="literal">creates</code> <a id="id330" class="indexterm"/>attribute works exactly the same way as <code class="literal">creates</code> on an <code class="literal">exec</code> resource, which we looked at in <a class="link" href="ch04.html" title="Chapter 4. Understanding Puppet resources">Chapter 4</a>, <span class="emphasis"><em>Understanding Puppet resources</em></span>. It specifies a file which unpacking the archive will create. If this file exists, Puppet knows the archive has already been unpacked, so it does not need to unpack it again.</li><li class="listitem">The <code class="literal">cleanup</code> attribute tells Puppet whether or not to delete the archive file once it has been unpacked. Usually, this will be set to <code class="literal">true</code>, unless you need to keep the archive around or unless you don't need to unpack it in the first place.</li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip34"/>Tip</h3><p>Once the file has been deleted by <code class="literal">cleanup</code>, Puppet won't redownload the archive file <code class="literal">/tmp/wordpress.tar.gz</code> the next time you apply the manifest, even though it has <code class="literal">ensure =&gt; present</code>. The <code class="literal">creates</code> clause tells Puppet that the archive has already been downloaded and extracted.</p></div></div></div></div>
<div class="section" title="Exploring the standard library"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec39"/>Exploring the standard library</h1></div></div></div><p>One of the <a id="id331" class="indexterm"/>oldest-established Puppet Forge modules is <code class="literal">puppetlabs/stdlib</code>, the official Puppet standard library. We looked at this briefly earlier in the chapter when we used it as an example of installing a module with <code class="literal">r10k</code>, but let's look more closely now and see what the standard library provides and where you might use it.</p><p>Rather than managing some specific software or file format, the standard library aims to provide a set of functions and resources which could be useful in any piece of Puppet code. Consequently, well-written Forge modules use the facilities of the standard library rather than implementing their own utility functions which do the same thing.</p><p>You should do the same in your own Puppet code: when you need a particular piece of functionality, check the <a id="id332" class="indexterm"/>standard library first to see if it solves your problem rather than implementing it yourself.</p><p>Before trying the examples in this section, make sure the <code class="literal">stdlib</code> module is installed by following these steps: If you've previously followed the steps in the <span class="emphasis"><em>Using r10k</em></span> section, the required module will already be installed. If not, run the following commands to install it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd /etc/puppetlabs/code/environments/pbg</strong></span>
<span class="strong"><strong>sudo r10k puppetfile install</strong></span>
</pre></div><div class="section" title="Safely installing packages with ensure_packages"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec115"/>Safely installing packages with ensure_packages</h2></div></div></div><p>As you <a id="id333" class="indexterm"/>know, you can install <a id="id334" class="indexterm"/>a package using the <code class="literal">package</code> resource, like this (<code class="literal">package.pp</code>):</p><div class="informalexample"><pre class="programlisting">package { 'cowsay':
  ensure =&gt; installed,
}</pre></div><p>But what happens if you also install the same package in another class in a different part of your manifest? Puppet will refuse to run, with an error like this:</p><div class="informalexample"><pre class="programlisting">Error: Evaluation Error: Error while evaluating a Resource Statement, Duplicate declaration: Package[cowsay] is already declared in file /examples/package.pp:1; cannot redeclare at /examples/package.pp:4 at /examples/package.pp:4:1 on node ubuntu-xenial</pre></div><p>If both of your classes really require the package, then you have a problem. You could create a class which simply declares the package, and then include that in both classes, but that is a lot of overhead for a single package. Worse, if the duplicate declaration is in a third-party module, it may not be possible, or advisable, to change that code.</p><p>What we need is a way to declare a package which will not cause a conflict if that package is also declared somewhere else. The standard library provides this facility in the <code class="literal">ensure_packages()</code> function. Call <code class="literal">ensure_packages()</code> with an array of package names, and they will be installed if they are not already declared elsewhere (<code class="literal">package_ensure.pp</code>):</p><div class="informalexample"><pre class="programlisting">ensure_packages(['cowsay'])</pre></div><p>To apply this example, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment=pbg /examples/package_ensure.pp</strong></span>
</pre></div><p>You can try all the <a id="id335" class="indexterm"/>remaining examples in this chapter in the same way. Make sure you supply the <code class="literal">--environment=pbg</code> switch to <code class="literal">puppet apply</code>, as the necessary modules are only installed in the <code class="literal">pbg</code> environment.</p><p>If you need to pass additional attributes to the <code class="literal">package</code> resource, you can supply them in a hash as the second argument to <code class="literal">ensure_packages()</code>, like this (<code class="literal">package_ensure_params.pp</code>):</p><div class="informalexample"><pre class="programlisting">ensure_packages(['cowsay'],
  {
    'ensure' =&gt; 'latest',
  }
)</pre></div><p>Why is this better than using the <code class="literal">package</code> resource directly? When you declare the same <code class="literal">package</code> resource in more than one place, Puppet will give an error message and refuse to run. If the <a id="id336" class="indexterm"/>package is declared by <code class="literal">ensure_packages()</code>, however, Puppet will run successfully.</p><p>Since it provides a safe way to install packages without resource conflicts, you should always use <code class="literal">ensure_packages()</code> instead of the built-in <code class="literal">package</code> resource. It is certainly essential if you're writing modules for public release, but I recommend you use it in all your code. We'll <a id="id337" class="indexterm"/>use it to manage packages throughout the rest of this book.</p></div><div class="section" title="Modifying files in place with file_line"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec116"/>Modifying files in place with file_line</h2></div></div></div><p>Often, when <a id="id338" class="indexterm"/>managing configuration with Puppet, we would like to change or add a particular line to a file, without incurring the overhead of managing the whole file with Puppet. Sometimes it may not be possible to manage the whole file in any case, as another Puppet class or another application may be managing it. We could write an <code class="literal">exec</code> resource to modify the file for us, but the standard library provides a resource type for exactly this purpose: <code class="literal">file_line</code>.</p><p>Here's an example of using the <code class="literal">file_line</code> resource to add a single line to a system config file (<code class="literal">file_line.pp</code>):</p><div class="informalexample"><pre class="programlisting">file_line { 'set ulimits':
  path =&gt; '/etc/security/limits.conf',
  line =&gt; 'www-data         -       nofile          32768',
}</pre></div><p>If there is a possibility that some other Puppet class or application may need to modify the target file, use <code class="literal">file_line</code> instead of managing the file directly. This ensures that your class won't conflict with any other attempts to control the file.</p><p>You can also use <code class="literal">file_line</code> to find and modify an existing line, using the <code class="literal">match</code> attribute (<code class="literal">file_line_match.pp</code>):</p><div class="informalexample"><pre class="programlisting">file_line { 'adjust ulimits':
  path  =&gt; '/etc/security/limits.conf',
  line  =&gt; 'www-data         -       nofile          9999',
  match =&gt; '^www-data .* nofile',
}</pre></div><p>The value of <a id="id339" class="indexterm"/>
<code class="literal">match</code> is a regular expression, and if Puppet finds a line in the file which matches this expression, it will replace it with the value of <code class="literal">line</code>. (If you need to potentially change multiple lines, set the <code class="literal">multiple</code> attribute to <code class="literal">true</code> or Puppet will complain when more than one line matches the expression.)</p><p>You can also use <code class="literal">file_line</code> to delete a line in a file if it is present (<code class="literal">file_line_absent.pp</code>):</p><div class="informalexample"><pre class="programlisting">file_line { 'remove dash from valid shells':
  ensure            =&gt; absent,
  path              =&gt; '/etc/shells',
  match             =&gt; '^/bin/dash',
  match_for_absence =&gt; true,
}</pre></div><p>Note that when using <code class="literal">ensure =&gt; absent</code>, you also need to set the <code class="literal">match_for_absence</code> attribute to <code class="literal">true</code> if you want Puppet to actually delete matching lines.</p></div><div class="section" title="Introducing some other useful functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec117"/>Introducing some other useful functions</h2></div></div></div><p>The <code class="literal">grep()</code> function <a id="id340" class="indexterm"/>will search an array for a regular expression and return all matching elements (<code class="literal">grep.pp</code>):</p><div class="informalexample"><pre class="programlisting">$values = ['foo', 'bar', 'baz']
notice(grep($values, 'ba.*'))

# Result: ['bar', 'baz']</pre></div><p>The <code class="literal">member()</code> and <code class="literal">has_key()</code> functions return <code class="literal">true</code> if a given value is in the specified array or hash, respectively (<code class="literal">member_has_key.pp</code>):</p><div class="informalexample"><pre class="programlisting">$values = [
  'foo',
  'bar',
  'baz',
]
notice(member($values, 'foo'))

# Result: true

$valuehash = {
  'a' =&gt; 1,
  'b' =&gt; 2,
  'c' =&gt; 3,
}
notice(has_key($valuehash, 'b'))

# Result: true</pre></div><p>The <code class="literal">empty()</code> function <a id="id341" class="indexterm"/>returns <code class="literal">true</code> if its argument is an empty string, array, or hash (<code class="literal">empty.pp</code>):</p><div class="informalexample"><pre class="programlisting">notice(empty(''))

# Result: true

notice(empty([]))

# Result: true

notice(empty({}))

# Result: true</pre></div><p>The <code class="literal">join()</code> function joins together the elements of a supplied array into a string, using a given separator character or string (<code class="literal">join.pp</code>):</p><div class="informalexample"><pre class="programlisting">$values = ['1', '2', '3']
notice(join($values, '... '))

# Result: '1... 2... 3'</pre></div><p>The <code class="literal">pick()</code> function is a <a id="id342" class="indexterm"/>neat way to provide a default value when a variable happens to be empty. It takes any number of arguments and returns the first argument which is not undefined or empty (<code class="literal">pick.pp</code>):</p><div class="informalexample"><pre class="programlisting">$remote_host = ''
notice(pick($remote_host, 'localhost'))

# Result: 'localhost'</pre></div><p>Sometimes you need to parse structured data in your Puppet code which comes from an outside source. If that data is in YAML format, you can use the <code class="literal">loadyaml()</code> function to read and parse it into a native Puppet data structure (<code class="literal">loadyaml.pp</code>):</p><div class="informalexample"><pre class="programlisting">$db_config = loadyaml('/examples/files/database.yml')
notice($db_config['development']['database'])

# Result: 'dev_db'</pre></div><p>The <code class="literal">dirname()</code> function is <a id="id343" class="indexterm"/>very useful if you have a string path to a file or directory and you want to reference its parent directory, for example to declare it as a Puppet resource (<code class="literal">dirname.pp</code>):</p><div class="informalexample"><pre class="programlisting">$file = '/var/www/vhosts/mysite'
notice(dirname($file))

# Result: '/var/www/vhosts'</pre></div></div><div class="section" title="The pry debugger"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec118"/>The pry debugger</h2></div></div></div><p>When a Puppet <a id="id344" class="indexterm"/>manifest doesn't do quite what you expect, troubleshooting the <a id="id345" class="indexterm"/>problem can be difficult. Printing out the values of variables and data structures with <code class="literal">notice()</code> can help as can running <code class="literal">puppet apply -d</code> to see detailed debug output, but if all else fails, you can use the standard library's <code class="literal">pry()</code> method to enter an interactive debugger session (<code class="literal">pry.pp</code>):</p><div class="informalexample"><pre class="programlisting">pry()</pre></div><p>With the <code class="literal">pry</code> gem installed in Puppet's context, you can call <code class="literal">pry()</code> at any point in your code. When you apply the manifest, Puppet will start an interactive Pry shell at the point where the <code class="literal">pry()</code> function is called. You can then run the <code class="literal">catalog</code> command to inspect Puppet's catalog, which contains all the resources currently declared in your manifest:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment=pbg /examples/pry_install.pp</strong></span>
<span class="strong"><strong>sudo puppet apply --environment=pbg /examples/pry.pp</strong></span>
...
[1] pry(#&lt;Puppet::Parser::Scope&gt;)&gt; catalog
=&gt; #&lt;Puppet::Resource::Catalog:0x00000001bbcf78
...
 @resource_table={["Stage", "main"]=&gt;Stage[main]{}, ["Class", "Settings"]=&gt;Class[Settings]{}, ["Class", "main"]=&gt;Class[main]{}},
 @resources=[["Stage", "main"], ["Class", "Settings"], ["Class", "main"]],
...</pre></div><p>Once you've finished <a id="id346" class="indexterm"/>inspecting the catalog, type <code class="literal">exit</code> to quit the debugger and continue applying your Puppet manifest.</p></div></div>
<div class="section" title="Writing your own modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec40"/>Writing your own modules</h1></div></div></div><p>As we've seen, a Puppet <a id="id347" class="indexterm"/>module is a way of grouping together a set of related code and resources that performs some particular task, like managing the Apache web server or dealing with archive files. But how do you actually create a module? In this section, we'll develop a module of our own to manage the NTP service, familiar to most system administrators as the easiest way to keep server clocks synchronized with the Internet time standard. (Of course, it's not necessary to write your own module for this because a perfectly good one exists on Puppet Forge. But we'll do so anyway, for learning purposes.)</p><div class="section" title="Creating a repo for your module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec119"/>Creating a repo for your module</h2></div></div></div><p>If we're going to use <a id="id348" class="indexterm"/>our new module alongside others that we've installed from Puppet Forge, then we should create a new Git repo just for our module. Then we can add its details to our Puppetfile and have <code class="literal">r10k</code> install it for us.</p><p>If you've already worked through <a class="link" href="ch03.html" title="Chapter 3. Managing your Puppet code with Git">Chapter 3</a>, <span class="emphasis"><em>Managing your Puppet code with Git</em></span>, you'll have created a GitHub account. If not, go to that chapter and follow the instructions in the <span class="emphasis"><em>Creating a GitHub account and project</em></span> section before continuing:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to your GitHub account and click on the <span class="strong"><strong>Start a project</strong></span> button.</li><li class="listitem">On the <span class="strong"><strong>Create a new repository</strong></span> screen, enter a suitable name for your repo (I'm using <code class="literal">pbg_ntp</code> for the Puppet Beginner's Guide's NTP module).</li><li class="listitem">Check the <span class="strong"><strong>Initialize this repository with a README</strong></span> box.</li><li class="listitem">Click on <span class="strong"><strong>Create repository</strong></span>.</li><li class="listitem">GitHub will take you to the project page for the new repository. Click on the <span class="strong"><strong>Clone or download</strong></span> button. If you're using GitHub with an SSH key, as we discussed in <a class="link" href="ch03.html" title="Chapter 3. Managing your Puppet code with Git">Chapter 3</a>, <span class="emphasis"><em>Managing your Puppet code with Git</em></span>, copy the <span class="strong"><strong>Clone with SSH</strong></span> link. Otherwise, click on <span class="strong"><strong>Use HTTP</strong></span>S and copy the <span class="strong"><strong>Clone with HTTPS</strong></span> link.</li><li class="listitem">On your own computer, or wherever you develop Puppet code, run the following command to clone the new repo (use the GitHub URL you copied in the previous step instead of this one):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git clone https://github.com/bitfield/pbg_ntp.git</strong></span>
</pre></div></li></ol></div><p>When the clone <a id="id349" class="indexterm"/>operation completes successfully, you're ready to get started with creating your new module.</p></div><div class="section" title="Writing the module code"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec120"/>Writing the module code</h2></div></div></div><p>As you'll see if you <a id="id350" class="indexterm"/>look inside the Puppet Forge modules you've already installed, modules have a standard directory structure. This is so that Puppet can automatically find the manifest files, templates, and other components within the module. Although complex modules have many subdirectories, the only ones we will be concerned with in this example are manifests and files. In this section, we'll create the necessary subdirectories, write the code to manage NTP, and add a config file which the code will install.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>All the code and files for this module are available in the GitHub repo at the following URL:</p><p>
<a class="ulink" href="https://github.com/bitfield/pbg_ntp">https://github.com/bitfield/pbg_ntp</a>
</p></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following commands to create the <code class="literal">manifests</code> and <code class="literal">files</code> subdirectories:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd pbg_ntp</strong></span>
<span class="strong"><strong>mkdir manifests</strong></span>
<span class="strong"><strong>mkdir files</strong></span>
</pre></div></li><li class="listitem">Create the file <code class="literal">manifests/init.pp</code> with the following contents:<div class="informalexample"><pre class="programlisting"># Manage NTP
class pbg_ntp {
  ensure_packages(['ntp'])

  file { '/etc/ntp.conf':
    source  =&gt; 'puppet:///modules/pbg_ntp/ntp.conf',
    notify  =&gt; Service['ntp'],
    require =&gt; Package['ntp'],
  }

  service { 'ntp':
    ensure =&gt; running,
    enable =&gt; true,
  }
}</pre></div></li><li class="listitem">Create the file <code class="literal">files/ntp.conf</code> with the following contents:<div class="informalexample"><pre class="programlisting">driftfile /var/lib/ntp/ntp.drift

pool 0.ubuntu.pool.ntp.org iburst
pool 1.ubuntu.pool.ntp.org iburst
pool 2.ubuntu.pool.ntp.org iburst
pool 3.ubuntu.pool.ntp.org iburst
pool ntp.ubuntu.com

restrict -4 default kod notrap nomodify nopeer noquery limited
restrict -6 default kod notrap nomodify nopeer noquery limited
restrict 127.0.0.1
restrict ::1</pre></div></li><li class="listitem">Run the following <a id="id351" class="indexterm"/>commands to add, commit, and push your changes to GitHub (you'll need to enter your GitHub username and password if you're not using an SSH key):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git add manifests/ files/</strong></span>
<span class="strong"><strong>git commit -m 'Add module manifest and config file'</strong></span>
<span class="strong"><strong>[master f45dc50] Add module manifest and config file</strong></span>
 2 files changed, 29 insertions(+)
 create mode 100644 files/ntp.conf
 create mode 100644 manifests/init.pp
<span class="strong"><strong>git push origin master</strong></span>
</pre></div></li></ol></div><p>Notice that the <code class="literal">source</code> attribute for the <code class="literal">ntp.conf</code> file looks like the following:</p><div class="informalexample"><pre class="programlisting">puppet:///modules/pbg_ntp/ntp.conf</pre></div><p>We haven't seen this kind of file source before, and it's generally only used within module code. The <code class="literal">puppet://</code> prefix indicates that the file comes from within the Puppet repo, and the path <code class="literal">/modules/pbg_ntp/</code> tells Puppet to look within the <code class="literal">pbg_ntp</code> module for it. Although the <code class="literal">ntp.conf</code> file is actually in the directory <code class="literal">modules/pbg_ntp/files/</code>, we don't need to specify the <code class="literal">files</code> part: that's assumed, because this is a <code class="literal">file</code> resource. (It's not just you: this confuses everybody).</p><p>Rather than installing the <code class="literal">ntp</code> package via a <code class="literal">package</code> resource, we use <code class="literal">ensure_packages()</code> from the standard library, as described earlier in this chapter.</p></div><div class="section" title="Creating and validating the module metadata"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec121"/>Creating and validating the module metadata</h2></div></div></div><p>Every Puppet <a id="id352" class="indexterm"/>module should have a file in its top-level directory <a id="id353" class="indexterm"/>named <code class="literal">metadata.json</code>, which contains helpful information about the module that can be used by module management tools, including Puppet Forge.</p><p>Create the file <code class="literal">metadata.json</code> with the following contents (use your own name and GitHub URLs):</p><div class="informalexample"><pre class="programlisting">{
  "name": "pbg_ntp",
  "version": "0.1.1",
  "author": "John Arundel",
  "summary": "Example module to manage NTP",
  "license": "Apache-2.0",
  "source": "https://github.com/bitfield/pbg_ntp.git",
  "project_page": "https://github.com/bitfield/pbg_ntp",
  "tags": ["ntp"],
  "dependencies": [
    {"name":"puppetlabs/stdlib",
      "version_requirement":"&gt;= 4.17.0 &lt; 5.0.0"}
  ],
  "operatingsystem_support": [
    {
      "operatingsystem": "Ubuntu",
      "operatingsystemrelease": [ "16.04" ]
    }
  ]
}</pre></div><p>Most of these are fairly self-explanatory. <code class="literal">tags</code> is an array of strings which will help people find your module if it is listed on Puppet Forge, and it's usual to tag your module <a id="id354" class="indexterm"/>with the name of the software or service it manages (in this case, <code class="literal">ntp</code>).</p><p>If your module relies <a id="id355" class="indexterm"/>on other Puppet modules, which is very likely (for example, this module relies on <code class="literal">puppetlabs/stdlib</code> for the <code class="literal">ensure_packages()</code> function) you use the <code class="literal">dependencies</code> metadata to record this. You should list each module used by your module along with the earliest and latest versions of that module which will work with your module. (If the currently-released version works, specify the next major release as the latest version. For example, if your module works with <code class="literal">stdlib</code> version 4.17.0 and that's the latest version available, specify 5.0.0 as the highest compatible version.)</p><p>Finally, the <code class="literal">operatingsystem_support</code> metadata lets you specify which operating systems and versions your module works with. This is very helpful for people searching for a Puppet module which will work with their operating system. If you know your module works with Ubuntu 16.04, as the example module does, you can list that in the <code class="literal">operatingsystem_support</code> section. The more operating systems your module can support, the better, so if possible, test your module on other operating systems and list them in the metadata once you know they work.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip35"/>Tip</h3><p>For full details on module metadata and how to use it, see the Puppet documentation:</p><p>
<a class="ulink" href="https://docs.puppet.com/puppet/latest/reference/modules_metadata.html">https://docs.puppet.com/puppet/latest/reference/modules_metadata.html</a>
</p></div></div><p>It's important to get the <a id="id356" class="indexterm"/>metadata for your module right, and there's a little <a id="id357" class="indexterm"/>tool that can help you with this, called <code class="literal">metadata-json-lint</code>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the following commands to install <code class="literal">metadata-json-lint</code> and check your metadata:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo gem install metadata-json-lint</strong></span>
<span class="strong"><strong>metadata-json-lint metadata.json</strong></span>
</pre></div></li><li class="listitem">If <code class="literal">metadata-json-lint</code> produces no output, your metadata is valid and you can go on to the next steps. If you see error messages, fix the problem before continuing.</li><li class="listitem">Run the following commands to add, commit, and push your metadata file to GitHub:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git add metadata.json</strong></span>
<span class="strong"><strong>git commit -m 'Add metadata.json'</strong></span>
<span class="strong"><strong>git push origin master</strong></span>
</pre></div></li></ol></div></div><div class="section" title="Tagging your module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec122"/>Tagging your module</h2></div></div></div><p>Just like when you use <a id="id358" class="indexterm"/>third-party Puppet Forge modules, it's important to be able to specify in your Puppetfile the exact version of your module to be installed. You can do this by using Git tags to attach a version tag to a specific commit in your module repo. As you develop the module further and make new releases, you can add a new tag for each release.</p><p>For the first release of your module, which according to the metadata is version 0.1.1, run the following commands to create and push the release tag:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git tag -a 0.1.1 -m 'Release 0.1.1'</strong></span>
<span class="strong"><strong>git push origin 0.1.1</strong></span>
</pre></div></div><div class="section" title="Installing your module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec123"/>Installing your module</h2></div></div></div><p>We can use <code class="literal">r10k</code> to <a id="id359" class="indexterm"/>install our new module, just as we did with the Puppet Forge modules, with one small difference. Since our module isn't on the Puppet Forge (yet), just specifying the name of the module in our Puppetfile isn't enough; we need to supply the Git URL so that <code class="literal">r10k</code> can clone the module from GitHub.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following <code class="literal">mod</code> statement to your Puppetfile (using your GitHub URL instead of mine):<div class="informalexample"><pre class="programlisting">mod 'pbg_ntp',
  :git =&gt; 'https://github.com/bitfield/pbg_ntp.git',
  :tag =&gt; '0.1.1'</pre></div></li><li class="listitem">Because the module also requires <code class="literal">puppetlabs/stdlib</code>, add this <code class="literal">mod</code> statement too:<div class="informalexample"><pre class="programlisting">mod 'puppetlabs/stdlib', '4.17.0'</pre></div></li><li class="listitem">Now install the module in the normal way with <code class="literal">r10k</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo r10k puppetfile install --verbose</strong></span>
</pre></div></li></ol></div><p>
<code class="literal">r10k</code> can install a module from any Git repo you have access to; all you have to do is add the <code class="literal">:git</code> and <code class="literal">:tag</code> parameters to the <code class="literal">mod</code> statement in your Puppetfile.</p></div><div class="section" title="Applying your module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec124"/>Applying your module</h2></div></div></div><p>Now that you've <a id="id360" class="indexterm"/>created, uploaded, and installed your module, we can use it in a manifest:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo puppet apply --environment=pbg -e 'include pbg_ntp'</strong></span>
</pre></div><p>If you're using the Vagrant box or a recent version of Ubuntu, your server will most likely be running NTP already, so the only change you'll see Puppet apply will be the <code class="literal">ntp.conf</code> file. Nonetheless, it confirms that your module works.</p></div><div class="section" title="More complex modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec125"/>More complex modules</h2></div></div></div><p>Of course, the <a id="id361" class="indexterm"/>module we've developed is a very trivial example. However, it demonstrates the essential requirements of a Puppet module. As you become a more advanced Puppet coder, you will be creating and maintaining much more complicated modules, similar to those you download and use from Puppet Forge.</p><p>Real-world modules often feature one or more of the following components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Multiple manifest files and subdirectories</li><li class="listitem" style="list-style-type: disc">Parameters (which may be supplied directly or looked up from Hiera data)</li><li class="listitem" style="list-style-type: disc">Custom facts and custom resource types and providers</li><li class="listitem" style="list-style-type: disc">Example code showing how to use the module</li><li class="listitem" style="list-style-type: disc">Specs and tests which developers can use to validate their changes</li><li class="listitem" style="list-style-type: disc">Dependencies on other modules (which must be declared in the module metadata)</li><li class="listitem" style="list-style-type: disc">Support for multiple operating systems </li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip36"/>Tip</h3><p>You can find more <a id="id362" class="indexterm"/>detailed information about modules and advanced features of modules in the Puppet documentation:</p><p>
<a class="ulink" href="https://docs.puppet.com/puppet/latest/reference/modules_fundamentals.html">https://docs.puppet.com/puppet/latest/reference/modules_fundamentals.html</a>
</p></div></div></div><div class="section" title="Uploading modules to Puppet Forge"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec126"/>Uploading modules to Puppet Forge</h2></div></div></div><p>It's very easy to <a id="id363" class="indexterm"/>upload a module to the Puppet Forge: all you <a id="id364" class="indexterm"/>need to do is sign up for an account, use the <code class="literal">puppet module build</code> command to create an archive file of your module, and upload it via the Puppet Forge website.</p><p>Before deciding to write a module in the first place, though, you should check whether there is already a module on the Puppet Forge which does what you need. There are over 4,500 modules available at the time of writing, so it's quite likely that you'll be able to use an existing Puppet Forge module instead of writing your own. Contributing a new module when there is already one available just makes it more difficult for users to choose which module they should use. For example, there are currently 150 modules which manage the Nginx web server. Surely this is at least 149 too many, so only submit a new module if you've made sure that there are no similar modules already on the Puppet Forge.</p><p>If there is a module which <a id="id365" class="indexterm"/>covers the software you want to manage, but it doesn't support your operating system or version, consider improving this module instead of starting a new one. Contact the module author to see whether and how you can help improve their module and extend support to your operating system. Similarly, if you find bugs in a module or want to make improvements to it, open an issue (if there is an issue tracker associated with the module), fork the GitHub repo (if it's versioned on GitHub), or contact the author to find out how you can help. The vast majority of Puppet Forge modules are written and maintained by volunteers, so your support and contributions benefit the entire Puppet community.</p><p>If you don't want to fork or contribute to an existing module, consider writing a small wrapper module which extends or overrides the existing module, rather than creating a new module from scratch.</p><p>If you do decide to <a id="id366" class="indexterm"/>write and publish your own module, use facilities from the standard library wherever possible, such as <code class="literal">ensure_packages()</code>. This will give your module the best chance of being compatible with other Forge modules.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>If you want to contribute more to the Puppet module community, consider joining the Vox Pupuli group, which maintains over a hundred open source Puppet modules: </p><p>
<a class="ulink" href="https://voxpupuli.org/">https://voxpupuli.org/</a> </p></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec41"/>Summary</h1></div></div></div><p>In this chapter, we've gained an understanding of Puppet modules, including an introduction to the Puppet Forge module repository. We've seen how to search for the modules we need and how to evaluate the results, including <span class="strong"><strong>Puppet Approved</strong></span> and <span class="strong"><strong>Puppet Supported</strong></span> modules, operating system support, and download count.</p><p>We've looked at using the <code class="literal">r10k</code> tool to download and manage Puppet modules in your infrastructure and how to specify the modules and versions you need in your Puppetfile. We've worked through detailed examples of using three important Forge modules: <code class="literal">puppetlabs/apache</code>, <code class="literal">puppetlabs/mysql</code>, and <code class="literal">puppet/archive</code>.</p><p>Introducing the standard library for Puppet, we've covered the use of <code class="literal">ensure_packages()</code> to avoid package conflicts between modules, the <code class="literal">file_line</code> resource, which provides line-level editing for config files, and a host of useful functions for manipulating data, as well as looking at the Pry debugger.</p><p>To fully understand how modules work, we've developed a simple module from scratch to manage the NTP service, hosted in its own Git repository and managed via a Puppetfile and <code class="literal">r10k</code>. We've seen what metadata modules require and how to create it and validate it using <code class="literal">metadata-json-lint</code>.</p><p>Finally, we've looked at some of the features of more sophisticated modules, discussed uploading modules to the Puppet Forge, and outlined some considerations to bear in mind when you're deciding whether to start a new module or extend and improve an existing one.</p><p>In the next chapter, we'll look at how to organize your Puppet code into classes, how to pass parameters to your classes, how to create defined resource types, and how to structure your manifests using roles, profiles, and how to include classes on a node using Hiera data.</p></div></body></html>