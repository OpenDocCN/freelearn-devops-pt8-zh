<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;5.&#xA0;Nova &#x2013; OpenStack Compute" id="1R42S1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Nova – OpenStack Compute</h1></div></div></div><p class="calibre10">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Introduction to OpenStack Compute</li><li class="listitem">Adding a compute host using OpenStack-Ansible</li><li class="listitem">Suspending a host for maintenance</li><li class="listitem">Configuring Nova Scheduler to use host aggregates</li><li class="listitem">Creating a host aggregate</li><li class="listitem">Adding a compute host to a host aggregate</li><li class="listitem">Removing a compute host from a host aggregate</li><li class="listitem">Adding metadata to a host aggregate</li><li class="listitem">Deleting a host aggregate</li><li class="listitem">Creating an Availability Zone</li><li class="listitem">Booting an instance into an Availability Zone</li><li class="listitem">Removing an Availability Zone</li><li class="listitem">Creating a flavor</li><li class="listitem">Deleting a flavor</li><li class="listitem">Setting CPU limits for a flavor </li><li class="listitem">Setting IOPS limits for a flavor </li><li class="listitem">Booting an instance</li><li class="listitem">Stopping an instance</li><li class="listitem">Deleting an instance</li><li class="listitem">Live migration</li><li class="listitem">Snapshotting an instance</li><li class="listitem">Booting an instance from a snapshot</li><li class="listitem">Rescuing an instance</li><li class="listitem">Shelving an instance</li><li class="listitem">Reviewing the console logs</li></ul></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Nova &#x2013; OpenStack Compute" id="1R42S1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Introduction to OpenStack Compute"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec59" class="calibre1"/>Introduction to OpenStack Compute</h1></div></div></div><p class="calibre10">Compute <a id="id283" class="calibre1"/>services in OpenStack are provided by a project that goes by the name Nova. Nova is an API-driven system that manages physical and virtual <a id="id284" class="calibre1"/>compute resources in an OpenStack cloud, providing <span class="strong"><strong class="calibre2">Infrastructure as a Service</strong></span> (<span class="strong"><strong class="calibre2">IaaS</strong></span>). OpenStack operators, administrators, and users can leverage the Nova API to manage the life cycle of compute resources.</p><p class="calibre10">Nova is <a id="id285" class="calibre1"/>primarily responsible for managing two resource types: <span class="strong"><strong class="calibre2">instances</strong></span>, which are the running virtual machines, application containers, or even full bare-metal <a id="id286" class="calibre1"/>machines a user has requested, and <span class="strong"><strong class="calibre2">hosts</strong></span>, that provide the hardware resources required by instances. In most circumstances, instances are synonymous to virtual machines.</p><p class="calibre10">It is important to make a distinction between two main features of Nova: the Nova API service (and associated services such as the <code class="email">nova-scheduler</code>, <code class="email">nova-conductor</code>, and <code class="email">nova-placement</code>), which runs on our cluster of three controller nodes, and the <code class="email">nova-compute</code> service, which runs on each compute host in our environment.</p><p class="calibre10">In this chapter, we will first cover the administration of the physical host and Nova services, then the remainder of the chapter will take a task-centric approach to working with Nova. This means that the depth and detail on Nova features and functionality are beyond the scope of this book.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a compute host using OpenStack-Ansible" id="1S2JE1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec60" class="calibre1"/>Adding a compute host using OpenStack-Ansible</h1></div></div></div><p class="calibre10">In order <a id="id287" class="calibre1"/>to run instances, OpenStack Compute needs to be aware of the physical resources on which to run the instances. As OpenStack has grown and matured over time, the process for adding a host has also <a id="id288" class="calibre1"/>grown with it. OpenStack-Ansible provides a very convenient and consistent method for adding new compute hosts which allows you to scale your environment as your needs grow. A compute host runs the <code class="email">nova-compute</code> service and the hypervisor that spawns the appropriate instance type requested.</p></div>

<div class="book" title="Adding a compute host using OpenStack-Ansible" id="1S2JE1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec163" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">In order to add a compute host to an OpenStack cluster using <code class="email">openstack-ansible</code>, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The IP address of the host</li><li class="listitem">SSH access to the host</li><li class="listitem">The SSH key from your deployment host</li><li class="listitem">Access to the deployment host</li></ul></div><p class="calibre10">The values used in our example are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Compute host: <code class="email">172.29.236.15</code></li><li class="listitem">Deployment host: <code class="email">controller-01.cook.book</code></li></ul></div><p class="calibre10">We assume that your environment was already installed using OpenStack-Ansible as described in <a class="calibre1" title="Chapter 1. Installing OpenStack with Ansible" href="part0014_split_000.html#DB7S2-189e69df43a248268db97cde1b1a8e47">Chapter 1</a>, <span class="strong"><em class="calibre18">Installing OpenStack with Ansible</em></span>.</p></div></div>

<div class="book" title="Adding a compute host using OpenStack-Ansible" id="1S2JE1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec164" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To install <a id="id289" class="calibre1"/>and configure an additional <a id="id290" class="calibre1"/>compute host using <code class="email">openstack-ansible</code>, carry out the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">From the <span class="strong"><em class="calibre18">deployment host</em></span>, add the additional compute host to the <code class="email">/etc/openstack_deploy/openstack_user_config.yml</code> file, as shown in the following example:<div class="informalexample"><pre class="programlisting">compute_hosts:
  compute-01:
    ip: 172.29.236.13
  compute-02:
    ip: 172.29.236.14
  compute-03:
    ip: 172.29 236.15</pre></div></li><li class="listitem" value="2">Run <code class="email">setup-hosts.yml</code>, limiting the tasks to just <code class="email">compute-03</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd /opt/openstack-ansible/playbooks</strong></span>
<span class="strong"><strong class="calibre2">openstack-ansible setup-hosts.yml --limit compute-03</strong></span>
</pre></div></li><li class="listitem" value="3">Have Ansible gather facts about the new host:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ansible nova_all -m setup -a 'filter=ansible_local gather_subset="!all"'</strong></span>
</pre></div></li><li class="listitem" value="4">Simply run <code class="email">os-nova-install.yml</code> to install and configure <code class="email">nova-compute</code> on our new compute host:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack-ansible os-nova-install.yml --limit compute-03</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip22" class="calibre1"/>Tip</h3><p class="calibre10">Should the <code class="email">openstack-ansible</code> command fail, the <code class="email">-v</code> flag can be used to increase verbosity to assist in troubleshooting. Adding <code class="email">-v</code> multiple times will provide additional levels of detail.</p></div></li><li class="listitem" value="5">Confirm the new hypervisor by running the following commands on any of the controller servers (as they run the utility container):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">lxc-attach --name $(lxc-ls -1 | grep utility)</strong></span>
<span class="strong"><strong class="calibre2">source openrc</strong></span>
<span class="strong"><strong class="calibre2">openstack hypervisor list</strong></span>
</pre></div><p class="calibre22">This should bring back output like the following:</p><div class="mediaobject"><img src="../images/00060.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Adding a compute host using OpenStack-Ansible" id="1S2JE1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec165" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">/etc/openstack_deploy/openstack_user_config</code> file provides mappings of roles to <a id="id291" class="calibre1"/>hosts in our environment. Adding the IP address for <code class="email">compute-03.cook.book</code> to the <code class="email">compute_hosts</code> stanza, informs <a id="id292" class="calibre1"/>the <code class="email">openstack-ansible</code> command to apply the packages, settings, and so forth to the new host. It also adds any required configuration to the remainder of your environment.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip23" class="calibre1"/>Tip</h3><p class="calibre10">A full discussion of the Openstack-Ansible playbooks is beyond the scope of this book. For additional information on the playbooks and how they operate, you can review their documentation here: <a class="calibre1" href="https://docs.openstack.org/project-deploy-guide/openstack-ansible/pike/">https://docs.openstack.org/project-deploy-guide/openstack-ansible/pike/</a>
</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Suspending a host for maintenance" id="1T1401-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec61" class="calibre1"/>Suspending a host for maintenance</h1></div></div></div><p class="calibre10">Often times <a id="id293" class="calibre1"/>a host needs to be taken offline to have memory replaced, an operating system upgraded, or other routine maintenance done. In order to ensure that running instances are not adversely affected, we use the <code class="email">openstack compute service set</code> command.</p></div>

<div class="book" title="Suspending a host for maintenance" id="1T1401-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec166" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">In order to place a host into maintenance mode, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line utility</li><li class="listitem">The <code class="email">nova</code> command-line utility</li><li class="listitem">An <code class="email">openrc</code> file with admin credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the host</li></ul></div><p class="calibre10">The host we will put into maintenance mode is as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Compute host: <code class="email">compute-03</code></li></ul></div></div></div>

<div class="book" title="Suspending a host for maintenance" id="1T1401-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec167" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To remove a hypervisor for maintenance, carry out the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we will list the available hosts:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">source ~/openrc</strong></span>
<span class="strong"><strong class="calibre2">openstack compute service list -c Binary -c Host -c Status -f table</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00061.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Next, we will disable the service called <code class="email">nova-compute</code> for the compute host, so we will specify:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack compute service set --disable compute-03 nova-compute</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip24" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output when successful.</p></div></li><li class="listitem" value="3">Verify that <a id="id294" class="calibre1"/>the host is disabled with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack compute service list -c Binary -c Host -c Status -f table</strong></span>
</pre></div><p class="calibre22">This produces an output like the following:</p><div class="mediaobject"><img src="../images/00062.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">Once the compute host has been disabled (meaning that it will no longer accept requests to run new instances), we can then migrate the running instances off this disabled compute host, onto other running compute hosts in our environment:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">nova host-evacuate-live --block-migrate compute-03</strong></span>
</pre></div><p class="calibre22">This produces an output like the following:</p><div class="mediaobject"><img src="../images/00063.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Suspending a host for maintenance" id="1T1401-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec168" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">In order <a id="id295" class="calibre1"/>to take a host offline for maintenance, Nova must first be told to no longer place new instances onto the host. This is done by disabling the <code class="email">nova-compute</code> service on the compute host with the <code class="email">openstack service set --disable [host] [service]</code> command. Once the host is marked disabled, and before powering it down for maintenance, the running instances need to be migrated off the host. The <code class="email">nova host-evacuate-live [host]</code> command attempts to live-migrate all running instances on the specified host. It does this by asking Nova to reschedule the instances onto hosts with availability.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip25" class="calibre1"/>Tip</h3><p class="calibre10">In cases where instances are not using shared storage, the <code class="email">--block-migrate</code> flag can be used to attempt to migrate the storage as well.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring Nova Scheduler to use host aggregates" id="1TVKI1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec62" class="calibre1"/>Configuring Nova Scheduler to use host aggregates</h1></div></div></div><p class="calibre10">OpenStack Compute <a id="id296" class="calibre1"/>provides the ability <a id="id297" class="calibre1"/>to create logical groupings of hypervisors called <span class="strong"><strong class="calibre2">host aggregates</strong></span>, which allow users and administrators to control <a id="id298" class="calibre1"/>what physical compute hosts can run the requested workload. Often times, host aggregates are used to organize hosts with similar attributes, such as SSD, performance, or hosts, that have passed a security audit such as HITRUST or PCI. A host can be assigned to multiple aggregates. That is, a host can be part of the PCI and SSD grouping. To enable host aggregate scheduling in Nova Scheduler, you must first enable host aggregate filtering in <code class="email">nova.conf</code>. In <code class="email">openstack-ansible</code>, Ansible manages this file, and we will use it to push the appropriate changes.</p></div>

<div class="book" title="Configuring Nova Scheduler to use host aggregates" id="1TVKI1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec169" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">Ensure that <a id="id299" class="calibre1"/>you are <code class="email">root</code> on the deployment host. In most cases, this is the first infrastructure controller node, <code class="email">infra01</code>.</p></div></div>

<div class="book" title="Configuring Nova Scheduler to use host aggregates" id="1TVKI1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec170" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To enable <a id="id300" class="calibre1"/>scheduling for host aggregates, the following steps can be used:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">On the deployment host, add the following line to the <code class="email">/etc/openstack_deploy/user_variables.yml</code> file:<div class="informalexample"><pre class="programlisting">nova_scheduler_default_filters: "AggregateInstanceExtraSpecsFilter,RetryFilter,AvailabilityZoneFilter,RamFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,AggregateCoreFilter,AggregateDiskFilter"</pre></div></li><li class="listitem" value="2">We can then use Ansible to deploy the changes with the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd /opt/openstack-ansible/playbooks</strong></span>
<span class="strong"><strong class="calibre2">openstack-ansible os-nova-install.yml</strong></span>
</pre></div></li><li class="listitem" value="3">Log in to the <code class="email">nova-scheduler</code> container and verify the change:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">lxc-attach --name controller-01_nova_scheduler_container-ed0f657d</strong></span>
<span class="strong"><strong class="calibre2">grep Aggregate /etc/nova/nova.conf</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip26" class="calibre1"/>Tip</h3><p class="calibre10">The containers have unique UUIDs in their names. Look at the name of your containers with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">lxc-ls -f</strong></span>
</pre></div></div><p class="calibre22">This will bring back an output like the following if the word <code class="email">Aggregate</code> was found, which shows that the change was successful:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">enabled_filters = AggregateInstanceExtraSpecsFilter,RetryFilter,AvailabilityZoneFilter,RamFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,AggregateCoreFilter,AggregateDiskFilter</strong></span>
</pre></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Configuring Nova Scheduler to use host aggregates" id="1TVKI1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec171" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Adding <code class="email">AggregateInstanceExtraSpecsFilter</code> to <code class="email">enabled_filters</code>, tells <code class="email">nova-scheduler</code> to match the instance <span class="strong"><em class="calibre18">flavor metadata</em></span> to that of the <span class="strong"><em class="calibre18">host-aggregate metadata</em></span>. The <code class="email">openstack-ansible</code> command is then used to propagate this change to the <code class="email">/etc/nova/nova.conf</code> files within the OpenStack cloud environment.</p><p class="calibre10">Once <a id="id301" class="calibre1"/>enabled, and when a new instance is requested, the Nova Scheduler examines the metadata of the flavor associated <a id="id302" class="calibre1"/>with the request and attempts to match it with the metadata of host aggregates.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a host aggregate" id="1UU541-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec63" class="calibre1"/>Creating a host aggregate</h1></div></div></div><p class="calibre10">After we <a id="id303" class="calibre1"/>have enabled OpenStack to allow host aggregate filtering, we can then proceed to create our host aggregates. This recipe will show you how to create a host aggregate.</p></div>

<div class="book" title="Creating a host aggregate" id="1UU541-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec172" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To create a host aggregate, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">A <span class="strong"><em class="calibre18">name</em></span> for the aggregate</li></ul></div><p class="calibre10">For our example, the host aggregate will be named <code class="email">cookbook-ssd-hosts</code>.</p></div></div>

<div class="book" title="Creating a host aggregate" id="1UU541-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec173" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To create a host aggregate, carry out the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we will list the current host aggregates:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate list</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00064.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Next, we will create the aggregate:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate create cookbook-ssd-hosts</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00065.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">List the host aggregates:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate list</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00066.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Creating a host aggregate" id="1UU541-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec174" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">In Nova, a <span class="strong"><strong class="calibre2">host aggregate</strong></span> provides <a id="id304" class="calibre1"/>OpenStack administrators <a id="id305" class="calibre1"/>and operators a mechanism to group hosts based on arbitrary attributes that are later used for controlling what compute hosts service a user's request. Creating a host aggregate is done with the <code class="email">openstack aggregate create name</code> command.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a compute host to a host aggregate" id="1VSLM1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec64" class="calibre1"/>Adding a compute host to a host aggregate</h1></div></div></div><p class="calibre10">Before a <a id="id306" class="calibre1"/>host aggregate can be used by OpenStack Compute, you must first add hosts to the aggregate groups created.</p></div>

<div class="book" title="Adding a compute host to a host aggregate" id="1VSLM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec175" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To add a host to an aggregate, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the aggregate</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the host</li></ul></div><p class="calibre10">For the following example, the required values are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Host aggregate: <code class="email">cookbook-ssd-hosts</code></li><li class="listitem">Compute host: <code class="email">compute-01</code></li></ul></div></div></div>

<div class="book" title="Adding a compute host to a host aggregate" id="1VSLM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec176" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following <a id="id307" class="calibre1"/>process is used to add a host to a host aggregate:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">List hosts that are already in the aggregate:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate show cookbook-ssd-hosts</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00067.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Now add the specified compute host to this aggregate as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate add host cookbook-ssd-hosts compute-01</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00068.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Adding a compute host to a host aggregate" id="1VSLM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec177" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">openstack aggregate host add</code> command associates a host with a host aggregate <a id="id308" class="calibre1"/>in the Nova database. This information is then used by the Nova Scheduler to make decisions about where to place an instance. If the metadata of the host aggregate matches that of the flavor or a particular project a user is in, an instance can be scheduled to a host within the aggregate.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Removing a compute host from a host aggregate" id="20R681-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec65" class="calibre1"/>Removing a compute host from a host aggregate</h1></div></div></div><p class="calibre10">If the <a id="id309" class="calibre1"/>properties of a host change, or the needs of an aggregate change, hosts can be removed from a host aggregate.</p></div>

<div class="book" title="Removing a compute host from a host aggregate" id="20R681-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec178" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To remove a host from a host aggregate, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the aggregate</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the host</li></ul></div></div></div>

<div class="book" title="Removing a compute host from a host aggregate" id="20R681-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec179" class="calibre1"/>How to do it…</h2></div></div></div><div class="book"><ol class="orderedlist"><li class="listitem" value="1">List hosts already in the aggregate with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate show cookbook-ssd-hosts</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following. Note that the <code class="email">hosts</code> field shows the compute hosts that are currently associated with the host aggregate:</p><div class="mediaobject"><img src="../images/00069.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">To remove <a id="id310" class="calibre1"/>the compute host from this host aggregate, issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate remove host cookbook-ssd-hosts compute-01</strong></span>
</pre></div><p class="calibre22">This will bring back the following. Note that in the <code class="email">hosts</code> field, <code class="email">compute-01</code> is now missing:</p><div class="mediaobject"><img src="../images/00070.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Removing a compute host from a host aggregate" id="20R681-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec180" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Removing <a id="id311" class="calibre1"/>a host from a host aggregate tells OpenStack Compute that the additional metadata filters no longer apply and the host can be scheduled as normal.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip27" class="calibre1"/>Tip</h3><p class="calibre10">Currently, running instances are unaffected by this operation. Operations on host aggregates affect new instance requests only.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding metadata to a host aggregate" id="21PMQ1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec66" class="calibre1"/>Adding metadata to a host aggregate</h1></div></div></div><p class="calibre10">The power <a id="id312" class="calibre1"/>of host aggregates comes from the ability to use them to logically group hosts based on their properties. This can be used, for example, to enable load balancing, enforce physical separation, or keep instances that are <a id="id313" class="calibre1"/>insecure from being scheduled into a secured environment. We will show this by matching the <span class="strong"><strong class="calibre2">metadata</strong></span> of a host aggregate with that of an instance flavor.</p></div>

<div class="book" title="Adding metadata to a host aggregate" id="21PMQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec181" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To add metadata to a host aggregate, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the aggregate</li><li class="listitem">The <span class="strong"><em class="calibre18">metadata</em></span> property to add</li></ul></div><p class="calibre10">In our example, these values will be the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Host aggregate: <code class="email">cookbook-ssd-hosts</code></li><li class="listitem">Metadata: <code class="email">ssd=true</code></li></ul></div></div></div>

<div class="book" title="Adding metadata to a host aggregate" id="21PMQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec182" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To add metadata to host aggregate, use the following process:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Show the existing metadata associated with an aggregate:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate show cookbook-ssd-hosts</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following. Note that the <code class="email">properties</code> field is blank if no metadata is associated yet:</p><div class="mediaobject"><img src="../images/00071.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Add the metadata with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate set --property ssd=true cookbook-ssd-hosts</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip28" class="calibre1"/>Tip</h3><p class="calibre10">This command displays no output when successful.</p></div></li><li class="listitem" value="3">Now <a id="id314" class="calibre1"/>confirm the addition of the metadata with the following command again:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate show cookbook-ssd-hosts</strong></span>
</pre></div><p class="calibre22">You will see that the <code class="email">properties</code> field has been updated with this information:</p><div class="mediaobject"><img src="../images/00072.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">Now that we have set the metadata of our host aggregate, we can now associate this with a flavor so that when that flavor is specified by a user during the boot process, Nova will match the property to only the hosts within <a id="id315" class="calibre1"/>that host aggregate group. For example, we may have a flavor that is called <code class="email">cookbook.ssd</code> that sets the expectation, which when a user select, the host will have SSDs available. This is the power of host aggregates. In the example here, <code class="email">compute-02</code> has SSDs available as we have specified this in the host aggregate named <code class="email">cookbook-ssd-hosts</code>. To take advantage of this, let's create a new flavor called <code class="email">cookbook.ssd</code> with the <code class="email">ssd=true</code> property:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor create</strong></span>
<span class="strong"><strong class="calibre2">    --vcpus 1</strong></span>
<span class="strong"><strong class="calibre2">    --ram 512</strong></span>
<span class="strong"><strong class="calibre2">    --disk 5</strong></span>
<span class="strong"><strong class="calibre2">    --public</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.ssd</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip29" class="calibre1"/>Tip</h3><p class="calibre10">Creating flavors is described in more detail in the <span class="strong"><em class="calibre18">Creating a flavor</em></span> recipe.</p></div></li><li class="listitem" value="5">We now need to set the flavor <span class="strong"><strong class="calibre2">extra specs</strong></span>, so that on choosing the flavor it is associated with the relevant host aggregate. For this, we use the <code class="email">nova</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">nova flavor-key cookbook.ssd set ssd=true</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip30" class="calibre1"/>Tip</h3><p class="calibre10">You may need to use the UUID of the flavor instead of the name. If so, list the flavors with the following command and not the UUID of the <code class="email">cookbook.ssd</code> flavor:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor list</strong></span>
</pre></div></div></li><li class="listitem" value="6">Now when a user selects the <code class="email">cookbook.ssd</code> flavor, unknown to them, the instance will be restricted to the hosts within the host aggregate group that has this key/value pair set.</li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Adding metadata to a host aggregate" id="21PMQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec183" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Metadata is specified as a key/value pairing, which is then associated with a host aggregate in the Nova database. These key/value pairs are arbitrary and can be defined to match a <a id="id316" class="calibre1"/>given environment. A host aggregate can have any number of key/value pairs stored; however, this may adversely affect instance scheduling because of potentially conflicting or confusing key/value pairs.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting a host aggregate" id="22O7C1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec67" class="calibre1"/>Deleting a host aggregate</h1></div></div></div><p class="calibre10">When a <a id="id317" class="calibre1"/>host aggregate no longer applies in a given environment, it can be deleted. A host aggregate must have all hosts removed before it can be removed.</p></div>

<div class="book" title="Deleting a host aggregate" id="22O7C1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec184" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To delete a host aggregate, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the aggregate</li></ul></div><p class="calibre10">For the following example, we will delete the <code class="email">cookbook-threadripper-hosts</code> aggregate.</p></div></div>

<div class="book" title="Deleting a host aggregate" id="22O7C1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec185" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following commands are used to delete a host aggregate:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the existing aggregates:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate list</strong></span>
</pre></div><p class="calibre22">This will bring back the following output:</p><div class="mediaobject"><img src="../images/00073.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Confirm that the aggregate has no hosts (Refer to the <span class="strong"><em class="calibre18">Removing a compute host from a host aggregate</em></span> recipe if necessary):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate show cookbook-threadripper-hosts</strong></span>
</pre></div><p class="calibre22">This will bring back the following output:</p><div class="mediaobject"><img src="../images/00074.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Now we can delete the aggregate with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate delete cookbook-threadripper-hosts</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip31" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output when successful.</p></div></li><li class="listitem" value="4">Confirm <a id="id318" class="calibre1"/>the change with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate list</strong></span>
</pre></div><p class="calibre22">This will bring back the following output, where the host aggregate has now been removed:</p><div class="mediaobject"><img src="../images/00075.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Deleting a host aggregate" id="22O7C1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec186" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Deleting a host aggregate removes it and all of its metadata from the Nova database, and it can no longer be used for instance scheduling.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating an Availability Zone" id="23MNU1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec68" class="calibre1"/>Creating an Availability Zone</h1></div></div></div><p class="calibre10">
<span class="strong"><strong class="calibre2">Availability Zones</strong></span> (<span class="strong"><strong class="calibre2">AZs</strong></span>) are a special case of host aggregates. Here, host aggregates are used <a id="id319" class="calibre1"/>by Nova to make scheduling decisions; they are generally only visible to operators and administrators of the OpenStack Cloud. AZs are <a id="id320" class="calibre1"/>the end-user visible component. An AZ can be configured, like host aggregates, to represent features of the hardware.</p><p class="calibre10">AZs are typically used to define failure domains, such as a cabinet or data center, or even geography. When configuring AZs, it is important to note that a host can only be a member of one AZ at a time.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note20" class="calibre1"/>Note</h3><p class="calibre10">As AZs are a special use-case of host aggregates, a lot of operations, such as adding and removing hosts are the same. Thus, they are not repeated here.</p></div><p class="calibre10">Creating an AZ is a two-step process. First, we create an aggregate with the <code class="email">--zone</code> parameter, or add it to an existing aggregate. Second, a host needs to be added to the aggregate before instances can be scheduled into the zone.</p></div>

<div class="book" title="Creating an Availability Zone" id="23MNU1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec187" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To create an AZ, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the aggregate</li><li class="listitem">The desired <span class="strong"><em class="calibre18">name</em></span> of the AZ</li><li class="listitem">The <span class="strong"><em class="calibre18">host</em></span> or <span class="strong"><em class="calibre18">hosts</em></span> to add to the AZ</li></ul></div><p class="calibre10">For our example, these values are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Aggregate name: <code class="email">cookbook-az</code></li><li class="listitem">Availability zone name: <code class="email">cookbook-az</code></li><li class="listitem">Compute host: <code class="email">compute-01</code></li></ul></div></div></div>

<div class="book" title="Creating an Availability Zone" id="23MNU1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec188" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following steps are to be used when creating an AZ:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we will list the current AZs with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack availability zone list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00076.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Create <a id="id321" class="calibre1"/>a new aggregate with the <code class="email">--zone</code> parameter:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate create --zone cookbook-az cookbook-az</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00077.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Now add a host to the aggregate with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate add host cookbook-az compute-01</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following when successful:</p><div class="mediaobject"><img src="../images/00078.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">Now <a id="id322" class="calibre1"/>list the AZs we have available:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack availability zone list</strong></span>
</pre></div><p class="calibre22">This will show the following:</p><div class="mediaobject"><img src="../images/00079.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><div class="note" title="Note"><h3 class="title2"><a id="tip32" class="calibre1"/>Tip</h3><p class="calibre10">Listing AZs will show all AZs available, irrespective of whether hosts exist in them or not. To verify that the hosts that are within an AZ, issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack availability zone show nameofAZ</strong></span>
</pre></div><p class="calibre10">This will bring back the output as shown in step 3.</p></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Creating an Availability Zone" id="23MNU1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec189" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The first command, <code class="email">openstack availability zone list</code>, lists all AZs. Next, when creating the new aggregate, the special <code class="email">--zone cookbook-az</code> parameter is passed, telling OpenStack Nova that this aggregate is also an AZ, specifying its name. Finally, a host is added to the AZ much the same as a host is added to an aggregate.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Booting an instance into an Availability Zone" id="24L8G1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec69" class="calibre1"/>Booting an instance into an Availability Zone</h1></div></div></div><p class="calibre10">Instances <a id="id323" class="calibre1"/>can be created into a given <a id="id324" class="calibre1"/>AZ by passing the <code class="email">--availability-zone</code> parameter as part of the creation process. Additionally, AZ can be selected in OpenStack Horizon as part of the instance creation wizard.</p></div>

<div class="book" title="Booting an instance into an Availability Zone" id="24L8G1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec190" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">The <a id="id325" class="calibre1"/>following information is required to boot an instance into an AZ:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the AZ</li><li class="listitem">Additional information required to start an instance<div class="note" title="Note"><h3 class="title2"><a id="tip34" class="calibre1"/>Tip</h3><p class="calibre10">Creating instances is covered in detail in the <span class="strong"><em class="calibre18">Booting an instance</em></span> recipe. As such, this example skips some of the detail, instead it  focuses on how to create an instance in a specific AZ.</p></div></li></ul></div></div></div>

<div class="book" title="Booting an instance into an Availability Zone" id="24L8G1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec191" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To boot <a id="id326" class="calibre1"/>an instance into a specific AZ, the <code class="email">--availability-zone</code> parameter is specified when running the <code class="email">openstack server create</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server create --flavor openstack.cookbook</strong></span>
<span class="strong"><strong class="calibre2">   --image 08b822ba-be44-4639-b577-45e8dd37c06d</strong></span>
<span class="strong"><strong class="calibre2">   --nic net-id=6cb5a4ce-1ea5-4817-9c34-a2212a66f394</strong></span>
<span class="strong"><strong class="calibre2">   --security-group bd7d5e0f-538a-4d93-b123-98cc3207b3d2</strong></span>
<span class="strong"><strong class="calibre2">   --key-name cookbook_key</strong></span>
<span class="strong"><strong class="calibre2">   --availability-zone cookbook-az</strong></span>
<span class="strong"><strong class="calibre2">   cookbook.test-03</strong></span>
</pre></div><p class="calibre10">This will bring back an output like the following, showing the AZ (the <code class="email">OS-EXT-AZ:availability-zone</code> field) where the instance was scheduled to:</p><div class="mediaobject"><img src="../images/00080.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre17"> </p></div></div>

<div class="book" title="Booting an instance into an Availability Zone" id="24L8G1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec192" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">When <a id="id327" class="calibre1"/>specified, the <code class="email">--availability-zone</code> parameter causes the Nova Scheduler to examine the specified AZ to see <a id="id328" class="calibre1"/>if the request can be satisfied.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Removing an Availability Zone" id="25JP21-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec70" class="calibre1"/>Removing an Availability Zone</h1></div></div></div><p class="calibre10">Removing <a id="id329" class="calibre1"/>an AZ is a multistep process, and has some caveats. To remove an AZ, you must first remove the hosts from the host aggregate.</p></div>

<div class="book" title="Removing an Availability Zone" id="25JP21-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec193" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">The following information is required to remove an AZ:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the AZ</li></ul></div></div></div>

<div class="book" title="Removing an Availability Zone" id="25JP21-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec194" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following steps can be used to remove an AZ:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the AZs available with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack availability zone list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00081.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Now list <a id="id330" class="calibre1"/>the hosts within the AZ that we want to delete:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate show cookbook-az</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00082.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Now remove the hosts with following command (repeat as necessary for each host in the aggregate):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate remove host cookbook-az compute-01</strong></span>
</pre></div><p class="calibre22">This will bring back the following output:</p><div class="mediaobject"><img src="../images/00083.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">Remove the AZ using the <code class="email">aggregate delete</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack aggregate delete cookbook-az</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip35" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output if successful.</p></div></li><li class="listitem" value="5">Confirm <a id="id331" class="calibre1"/>the removal of the AZ with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack availability zone list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following, showing that our AZ has been removed:</p><div class="mediaobject"><img src="../images/00084.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Removing an Availability Zone" id="25JP21-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec195" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">In order <a id="id332" class="calibre1"/>to remove an AZ, it must first have no active hosts. Because AZs are a special case of host aggregates, the commands for identifying and removing hosts from an AZ are the same. Once you have removed the hosts, the <code class="email">openstack aggregate delete [name]</code> command is used to complete the removal of the AZ.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a flavor" id="26I9K1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec71" class="calibre1"/>Creating a flavor</h1></div></div></div><p class="calibre10">Before Nova <a id="id333" class="calibre1"/>can start instances, it first needs to know what resources should be assigned to those instances. The way Nova handles resource assignments is to define <span class="strong"><strong class="calibre2">flavors</strong></span>. A flavor specifies the number of vCPUs, RAM, and the disk to assign to an instance.</p></div>

<div class="book" title="Creating a flavor" id="26I9K1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec196" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To create <a id="id334" class="calibre1"/>a new flavor, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span>, <span class="strong"><em class="calibre18">vCPU</em></span>, <span class="strong"><em class="calibre18">RAM</em></span>, and <span class="strong"><em class="calibre18">disk</em></span> values for the new flavor</li></ul></div><p class="calibre10">The flavor we will create in this example will have the following attributes:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Flavor name: <code class="email">openstack.cookbook</code></li><li class="listitem">vCPU: 1</li><li class="listitem">Ram: 512 MB</li><li class="listitem">Disk: 5 GB</li><li class="listitem">Visibility: Public</li></ul></div></div></div>

<div class="book" title="Creating a flavor" id="26I9K1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec197" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following <a id="id335" class="calibre1"/>commands are used to create a new flavor:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the available flavors already configured in our environment with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00085.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Create the flavor with our given attributes:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor create</strong></span>
<span class="strong"><strong class="calibre2">    --vcpus 1</strong></span>
<span class="strong"><strong class="calibre2">    --ram 512</strong></span>
<span class="strong"><strong class="calibre2">    --disk 5</strong></span>
<span class="strong"><strong class="calibre2">    --public</strong></span>
<span class="strong"><strong class="calibre2">    openstack.cookbook</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00086.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">List the <a id="id336" class="calibre1"/>flavors again to see the new flavor:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor list</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00087.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Creating a flavor" id="26I9K1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec198" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">openstack flavor create --vcpus [vcpu_count] --ram [ram_MB] --disk [disk_GB] --public [name]</code> command is used to define flavors. The <code class="email">--public</code> option <a id="id337" class="calibre1"/>is used to specify if the flavor should be available to all users of the OpenStack environment, or if it should remain limited in scope and visibility to the project in which the user belongs to.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting a flavor" id="27GQ61-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec72" class="calibre1"/>Deleting a flavor</h1></div></div></div><p class="calibre10">Often times, requirements change; there is a demand for more performance, or business needs <a id="id338" class="calibre1"/>change. Whatever be the reason, your existing flavors may not meet the needs of those consuming cloud resources. When a given flavor is no longer suitable, it will need to be deleted.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip36" class="calibre1"/>Tip</h3><p class="calibre10">A flavor that is associated with a running instance cannot be deleted.</p></div></div>

<div class="book" title="Deleting a flavor" id="27GQ61-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec199" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To change attributes of a flavor for Nova, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the flavor to delete</li></ul></div></div></div>

<div class="book" title="Deleting a flavor" id="27GQ61-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec200" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following <a id="id339" class="calibre1"/>commands are used to delete a flavor:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the flavors available:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor list</strong></span>
</pre></div><p class="calibre22">This will bring back a list of flavors like the following:</p><div class="mediaobject"><img src="../images/00088.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">To delete the flavor, execute the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor delete openstack.cookbook</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip37" class="calibre1"/>Tip</h3><p class="calibre10">This command shows no output when successful.</p></div></li><li class="listitem" value="3">List the flavors again to view updated attributes:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor list</strong></span>
</pre></div><p class="calibre22">Once again, this lists the flavors that are now available:</p><div class="mediaobject"><img src="../images/00089.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Deleting a flavor" id="27GQ61-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec201" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">To delete <a id="id340" class="calibre1"/>a flavor the <code class="email">openstack flavor delete [name]</code> command is used. Should you need to delete multiple flavors, you can specify multiple names or IDs, separating each with a space.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Setting CPU limits for a flavor" id="28FAO1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec73" class="calibre1"/>Setting CPU limits for a flavor</h1></div></div></div><p class="calibre10">In addition <a id="id341" class="calibre1"/>to defining the number of vCPUs assigned to an instance, limits on the use of these CPU cycles can be further imposed. Nova relies on the underlying hypervisor for the specific implementation of the CPU limits, and thus the values available may vary. Our example is based on QEMU/KVM.</p><p class="calibre10">CPU limits are a special case of flavor attributes that you may encounter.</p></div>

<div class="book" title="Setting CPU limits for a flavor" id="28FAO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec202" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To add a CPU limit to a flavor, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the flavor to change</li><li class="listitem">The values you would like to set the CPU limit to (share of time the allotted CPU is allowed to consume in milliseconds per cycle)</li></ul></div><p class="calibre10">These values in our example are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">cpu_quota</code> = 5000 ms</li><li class="listitem"><code class="email">cpu_period</code> = 2500 ms</li></ul></div></div></div>

<div class="book" title="Setting CPU limits for a flavor" id="28FAO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec203" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following commands are used to add CPU limits to a flavor.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip38" class="calibre1"/>Tip</h3><p class="calibre10">CPU limits are not applied live. Rather, they are applied on instance launch.</p><p class="calibre10">At the time of this writing, the <code class="email">openstack</code> command-line client is the only way to view and change this setting. It is also not shown by default when viewing instance attributes.</p></div><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, view the current attributes of the flavor that we are changing, noting that we have no <code class="email">properties</code> set:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor show openstack.cookbook</strong></span>
</pre></div><p class="calibre22">This gives the following output:</p><div class="mediaobject"><img src="../images/00090.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Add <a id="id342" class="calibre1"/>the CPU limit:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor set</strong></span>
<span class="strong"><strong class="calibre2">    --property quota:cpu_quota=5000</strong></span>
<span class="strong"><strong class="calibre2">    --property quota:cpu_period=2500</strong></span>
<span class="strong"><strong class="calibre2">    openstack.cookbook</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip39" class="calibre1"/>Tip</h3><p class="calibre10">This command shows no output when successful</p></div></li><li class="listitem" value="3">View <a id="id343" class="calibre1"/>the CPU limit by interrogating the flavor again, noting the <code class="email">properties</code> field:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor show openstack.cookbook</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00091.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Setting CPU limits for a flavor" id="28FAO1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec204" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">In order <a id="id344" class="calibre1"/>to help mitigate the <span class="strong"><em class="calibre18">noisy neighbor</em></span> issue, or to provide further definition of service levels, OpenStack supports CPU limits. In OpenStack, this is called the <span class="strong"><strong class="calibre2">Instance Resource Quota</strong></span>. CPU limits are part of the flavor definition. Meaning, all instances of a given flavor will have the same CPU limits.</p><p class="calibre10">Imposing <a id="id345" class="calibre1"/>CPU limits are hypervisor specific. For KVM/libvirt environments, CPU limits are enforced using cgroups, using a combination of the following three values:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">cpu_shares</code></li><li class="listitem"><code class="email">cpu_quota</code></li><li class="listitem"><code class="email">cpu_period</code></li></ul></div><p class="calibre10">A full <a id="id346" class="calibre1"/>discussion of what these values are and how they interact is beyond the scope of this book. However, you can find a detailed explanation of them on the OpenStack wiki at the following:</p><p class="calibre10">
<a class="calibre1" href="https://wiki.openstack.org/wiki/InstanceResourceQuota">https://wiki.openstack.org/wiki/InstanceResourceQuota</a>
</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Setting IOPS limits for a flavor" id="29DRA1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec74" class="calibre1"/>Setting IOPS limits for a flavor</h1></div></div></div><p class="calibre10">As with <a id="id347" class="calibre1"/>CPU limits, IOPS limits can also be imposed to prevent an instance type from hogging all of the available IO on a system. IOPS here refers to the storage and network IO. Also, as with CPU limits, IOPS limits are a special case of flavor attributes that you may encounter frequently.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip40" class="calibre1"/>Tip</h3><p class="calibre10">At the time of this writing, the <code class="email">openstack</code> command-line client is the only way to view and change this setting. It is also not shown by default when viewing instance attributes.</p></div></div>

<div class="book" title="Setting IOPS limits for a flavor" id="29DRA1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec205" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To add an IOPS limit to a flavor, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the flavor to change</li><li class="listitem">The value you would like to set the IOPS limit to.</li></ul></div><div class="book"><ul class="itemizedlist"><li class="listitem">In our example, these values are as follows:</li><li class="listitem"><code class="email">disk_read_iops</code> = 100 IOPS</li><li class="listitem"><code class="email">disk_write_iops</code> = 100 IOPS</li></ul></div></div></div>

<div class="book" title="Setting IOPS limits for a flavor" id="29DRA1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec206" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following <a id="id348" class="calibre1"/>commands are used to add IOPS limits to a flavor:</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip41" class="calibre1"/>Tip</h3><p class="calibre10">As with changing flavor attributes, IOPS limits are not applied to running instances. Rather, they are applied on instance launch.</p></div><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, view the attributes of the flavor that is changing, noting that the <code class="email">properties</code> field is blank:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor show openstack.cookbook</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00092.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Now we can add the IOPS limit with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor set</strong></span>
<span class="strong"><strong class="calibre2">    --property quota:disk_read_iops=100</strong></span>
<span class="strong"><strong class="calibre2">    --property quota:disk_write_iops=100</strong></span>
<span class="strong"><strong class="calibre2">    openstack.cookbook</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip42" class="calibre1"/>Tip</h3><p class="calibre10">This command shows no output when successful.</p></div></li><li class="listitem" value="3">We can <a id="id349" class="calibre1"/>verify the IOPS limits by viewing the flavor properties:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor show openstack.cookbook</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following, noting that we have now set the properties to reflect the IOPS imposed:</p><div class="mediaobject"><img src="../images/00093.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Setting IOPS limits for a flavor" id="29DRA1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec207" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">As with <a id="id350" class="calibre1"/>CPU limits, IO limits are defined at a flavor level. However, unlike CPU limits, IO limits can be applied by the hypervisor, the storage layer, or a combination of the two.</p><p class="calibre10">To set the IOPS limit values for a given flavor, the following <code class="email">openstack</code> command is used:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack flavor set</strong></span>
<span class="strong"><strong class="calibre2">    --property quota:disk_read_iops=[read_iops]</strong></span>
<span class="strong"><strong class="calibre2">    --property quota:disk_write_iops=[write_iops]</strong></span>
<span class="strong"><strong class="calibre2">    [name]</strong></span>
</pre></div><p class="calibre10">While both read and write IOPS are shown for completeness, you need not specify both.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Booting an instance"><div class="book" id="2ACBS2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec75" class="calibre1"/>Booting an instance</h1></div></div></div><p class="calibre10">The most <a id="id351" class="calibre1"/>fundamental tasks that can be performed with instances are life cycle tasks. In this recipe, we will show you how to start or boot an instance.</p></div>

<div class="book" title="Booting an instance">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec208" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To start an instance, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the instance</li><li class="listitem">The <span class="strong"><em class="calibre18">image</em></span> to use for the instance</li><li class="listitem">The name of the <span class="strong"><em class="calibre18">flavor</em></span> to create the instance with</li><li class="listitem">The name of the <span class="strong"><em class="calibre18">network</em></span> or networks to attach the instance to</li><li class="listitem">The <span class="strong"><em class="calibre18">keypair</em></span> name to allow access to an instance</li><li class="listitem">The name of any <span class="strong"><em class="calibre18">security groups</em></span> to associate with the instance</li></ul></div></div></div>

<div class="book" title="Booting an instance">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec209" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The instance we will boot will have the following attributes:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Instance name: <code class="email">cookbook.test</code></li><li class="listitem">Flavor type: <code class="email">openstack.cookbook</code></li><li class="listitem">Image name: <code class="email">Ubuntu 16.04 amd64</code> (UUID)</li><li class="listitem">Network: <code class="email">public</code> (UUID)</li><li class="listitem">Keypair name: <code class="email">cookbook_key</code></li><li class="listitem">Security groups: <code class="email">ssh</code></li></ul></div><p class="calibre10">To start <a id="id352" class="calibre1"/>an instance, use the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">To list the instances that are currently running, we issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip43" class="calibre1"/>Tip</h3><p class="calibre10">This command will produce no output if there are no instances.</p></div></li><li class="listitem" value="2">List the available images:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image list</strong></span>
</pre></div><p class="calibre22">This will bring back a list of images available:</p><div class="mediaobject"><img src="../images/00094.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">List the available networks:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack network list</strong></span>
</pre></div><p class="calibre22">This will list the networks that we can attach an instance to:</p><div class="mediaobject"><img src="../images/00095.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">Create <a id="id353" class="calibre1"/>a keypair (if you do not have one already created and available for use):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ssh-keygen -q -N ""</strong></span>
</pre></div><p class="calibre22">Also, upload this with the following command: </p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack keypair create --public-key ~/.ssh/id_rsa.pub cookbook_key</strong></span>
</pre></div><p class="calibre22">This will bring back an output showing the fingerprint of your key:</p><div class="mediaobject"><img src="../images/00096.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="5">Now we can boot the instance with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server create</strong></span>
<span class="strong"><strong class="calibre2">    --flavor openstack.cookbook</strong></span>
<span class="strong"><strong class="calibre2">    --image 08b822ba-be44-4639-b577-45e8dd37c06d</strong></span>
<span class="strong"><strong class="calibre2">    --nic net-id=6cb5a4ce-1ea5-4817-9c34-a2212a66f394</strong></span>
<span class="strong"><strong class="calibre2">    --security-group ssh </strong></span>
<span class="strong"><strong class="calibre2">    --key-name cookbook_key</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.test</strong></span>
</pre></div><p class="calibre22">This produces a table of output showing that the instance is booting (not shown here for brevity).</p></li><li class="listitem" value="6">To view <a id="id354" class="calibre1"/>more information about the booted instance, issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00097.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Booting an instance">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec210" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">After noting <a id="id355" class="calibre1"/>a number of required values we will be supplying as input, such as the UUID of the image that we want to boot and the UUID of the network we want to attach the instance to, we then called a tool from OpenStack Client to launch our instance. Part of that command line refers to the keypair to use. We then connect to the instance using the private key as part of that keypair generated.</p><p class="calibre10">How does <a id="id356" class="calibre1"/>the cloud instance know what key to use? As part of the boot scripts for this image, it makes a call back to the metaserver, which is a function of the <code class="email">nova-api</code> and <code class="email">nova-api-metadata</code> services. The metaserver provides a go-between that bridges our instance and the real world, which the cloud-init boot process can call and in this case, it downloads a script to inject our private key into the Ubuntu user's <code class="email">.ssh/authorized_keys</code> file.</p><p class="calibre10">When a cloud instance is launched, it generates a number of useful metrics and details about that instance. This is presented by the <code class="email">openstack server list</code> and <code class="email">openstack server show</code> commands. The <code class="email">openstack server list</code> command shows a convenient short version listing the ID, name, status, and IP addresses of our instance.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Stopping an instance" id="2BASE1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec76" class="calibre1"/>Stopping an instance</h1></div></div></div><p class="calibre10">Sometimes, an <a id="id357" class="calibre1"/>instance will need to be stopped for a number of reasons, for example, maintenance and offline migration, yet as an OpenStack administrator, you may not want to completely destroy the instance and data associated with it. Thus, you will want to stop the instance instead.</p></div>

<div class="book" title="Stopping an instance" id="2BASE1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec211" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To stop an instance, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the instance</li></ul></div></div></div>

<div class="book" title="Stopping an instance" id="2BASE1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec212" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">In this example, we will be stopping the <code class="email">cookbook.test</code> instance created in the <span class="strong"><em class="calibre18">Booting an instance</em></span> recipe. To stop the instance, use the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we list the running instances:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list</strong></span>
</pre></div><p class="calibre22">This will bring back a list of the running instances. Consider this example:</p><div class="mediaobject"><img src="../images/00098.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">To stop the instance, simply issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server stop cookbook.test</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip44" class="calibre1"/>Tip</h3><p class="calibre10">This command takes a few moments to complete and will not display the output if successful.</p></div></li><li class="listitem" value="3">Now list <a id="id358" class="calibre1"/>instances to confirm the status of the instances. Here we're looking for the states of <code class="email">SHUTOFF</code> for our <code class="email">cookbook.test</code> instance:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list</strong></span>
</pre></div><p class="calibre22">This gives the following output:</p><div class="mediaobject"><img src="../images/00099.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Stopping an instance" id="2BASE1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec213" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">To stop <a id="id359" class="calibre1"/>an instance we use the <code class="email">openstack</code> client's <code class="email">server stop</code> command: <code class="email">openstack server stop [Name or ID]</code>. This tells Nova to power off the instance. This is synonymous to holding the power button on your laptop, or unplugging a server.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deleting an instance" id="2C9D01-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec77" class="calibre1"/>Deleting an instance</h1></div></div></div><p class="calibre10">To complete <a id="id360" class="calibre1"/>the life cycle of an instance, you will need to delete it. Nova provides a facility for this, using the <code class="email">openstack</code> command-line tool.</p></div>

<div class="book" title="Deleting an instance" id="2C9D01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec214" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To delete an instance, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the instance</li></ul></div></div></div>

<div class="book" title="Deleting an instance" id="2C9D01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec215" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">In this <a id="id361" class="calibre1"/>example, we will be deleting the <code class="email">cookbook.test</code> instance created in the <span class="strong"><em class="calibre18">Booting an instance</em></span> recipe used for booting. To delete the instance, use the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, list the running instances:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00100.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">To delete the instance named <code class="email">cookbook.test</code>, issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server delete cookbook.test</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip45" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output when successful.</p></div></li><li class="listitem" value="3">Now list the instances again to confirm the deletion:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list</strong></span>
</pre></div><p class="calibre22">This will bring back an output, where the instance we have deleted is now not present:</p><div class="mediaobject"><img src="../images/00101.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Deleting an instance" id="2C9D01-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec216" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">openstack server delete</code> command, unlike suspending or shelving an instance, deletes <a id="id362" class="calibre1"/>the instance and all data within it.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Live migration"><div class="book" id="2D7TI2-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec78" class="calibre1"/>Live migration</h1></div></div></div><p class="calibre10">One of the <a id="id363" class="calibre1"/>key tenets of cloud is being abstracted away from hardware. However, hardware does require maintenance from time to time, or a host will need a software upgrade. Whatever the reason, a host may need to be taken offline for maintenance, ideally with little to no downtime for the instances running on the host. To accommodate this, Nova provides two methods for live migrating instances: block migration, when shared storage is not available in the environment, and the live migration flag, when instances are booted from the shared storage (where every compute host can see the <a id="id364" class="calibre1"/>same storage used by each instance for its boot volume).</p></div>

<div class="book" title="Live migration">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec217" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To live migrate an instance, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate administrator credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the instance</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the destination hypervisor</li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip46" class="calibre1"/>Tip</h3><p class="calibre10">If your environment is configured so that instances boot from the shared storage, such as RBD provided by Ceph, then live migrations are almost instantaneous (depending on how busy the instance is). A feature called <span class="strong"><strong class="calibre2">block migration</strong></span> is much slower. Block migration is used in environments where shared storage is not used for instances.</p><p class="calibre10">Migrations can only be performed by a user with admin role privileges.</p></div></div></div>

<div class="book" title="Live migration">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec218" class="calibre1"/>How to do it…</h2></div></div></div><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we list the available hypervisors. We are noting where we can migrate our running instances to:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack hypervisor list</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00102.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Next, view <a id="id365" class="calibre1"/>the instance properties to identify the source host:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test</strong></span>
<span class="strong"><strong class="calibre2">    -c name</strong></span>
<span class="strong"><strong class="calibre2">    -c OS-EXT-SRV-ATTR:hypervisor_hostname</strong></span>
</pre></div><p class="calibre22">This will bring back the fields (also known as column names, as denoted by the <code class="email">-c</code> flag) that we are interested in. Note, in this example, the instance called <code class="email">cookbook.test</code> is running from the hypervisor called <code class="email">compute-01.cook.book</code>:</p><div class="mediaobject"><img src="../images/00103.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">To live migrate the instance <span class="strong"><em class="calibre18">where no shared storage is available</em></span> issue the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server migrate --block-migration cookbook.test</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip47" class="calibre1"/>Tip</h3><p class="calibre10">We do not specify a target compute host using the <code class="email">--block-migration</code> method, instead, we let the Nova Scheduler decide on the next available hypervisor.</p><p class="calibre10">This command shows no output when successful.</p></div><p class="calibre22">To live migrate the instance, <span class="strong"><em class="calibre18">with shared storage such as Ceph</em></span>, issue the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server migrate cookbook.test --live compute-02.cook.book</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip48" class="calibre1"/>Tip</h3><p class="calibre10">We specify the target hypervisor with the <code class="email">--live</code> flag.</p><p class="calibre10">This command shows no output when successful.</p></div></li><li class="listitem" value="4">Check the <a id="id366" class="calibre1"/>status of migration:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show</strong></span>
<span class="strong"><strong class="calibre2">    -c name</strong></span>
<span class="strong"><strong class="calibre2">    -c OS-EXT-STS:task_state cookbook.test</strong></span>
</pre></div><p class="calibre22">As block migrations generally take longer, you may see the state as <code class="email">resize_migrating</code>, indicating that the task of migrating is still in process:</p><div class="mediaobject"><img src="../images/00104.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="5">Verify the migration with the following command, ensuring that the instance is now running from a different hypervisor:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test</strong></span>
<span class="strong"><strong class="calibre2">    -c name</strong></span>
<span class="strong"><strong class="calibre2">    -c OS-EXT-SRV-ATTR:hypervisor_hostname</strong></span>
</pre></div><p class="calibre22">This will bring back an output like the following:</p><div class="mediaobject"><img src="../images/00105.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip49" class="calibre1"/>Tip</h3><p class="calibre10">Migrations of any kind are generally best performed when the instance is not under heavy utilization.</p></div></div></div>

<div class="book" title="Live migration">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec219" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Live migrations are an essential feature that enables OpenStack operators and administrators to perform maintenance of the underlying cloud infrastructure without affecting <a id="id367" class="calibre1"/>the consumers of said cloud. Additionally, the OpenStack administrator can use telemetry data from resource monitoring services (such as Ceilometer) and make live migration decisions to balance workloads across the OpenStack Cloud.</p><p class="calibre10">Live migration in OpenStack is handled by the libvirt drivers. Specifically, when you issue the <code class="email">openstack server migrate</code> command, OpenStack Compute creates a connection from libvirtd on one compute host to the same process on the remote host. Once this connection is established, depending on the parameters you specified, the memory state of the instance is synchronized and the control is transferred. In the preceding example, we first specified the additional <code class="email">--block-migrate</code> parameter, which handles the movement of the instance's disk files in the absence of shared storage, and then we showed how the <code class="email">--live</code> flag can be used when instances are booted from shared storage.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip50" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Remember</strong></span>: Migrations can only be performed by users with the <code class="email">admin</code> role.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Snapshotting an instance" id="2E6E41-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec79" class="calibre1"/>Snapshotting an instance</h1></div></div></div><p class="calibre10">Snapshotting <a id="id368" class="calibre1"/>an instance will create a Glance image of the instance at the point in time the snapshot was taken. This image can then be used to deploy additional instances of a given application, or as a bootable backup of the instance.</p></div>

<div class="book" title="Snapshotting an instance" id="2E6E41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec220" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">In order to create a snapshot of an instance, you require the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the instance</li></ul></div></div></div>

<div class="book" title="Snapshotting an instance" id="2E6E41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec221" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The following <a id="id369" class="calibre1"/>commands are used to create an instance snapshot:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we list the existing images with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image list -c Name -c Status</strong></span>
</pre></div><p class="calibre22">This will bring back a list of images like the following:</p><div class="mediaobject"><img src="../images/00106.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Now list the running instances with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list -c Name -c Status</strong></span>
</pre></div><p class="calibre22">This gives an output like the following:</p><div class="mediaobject"><img src="../images/00107.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">To create the snapshot, issue the following command (note the optional shell expansion command we're using to timestamp the name of the snapshot):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server image create</strong></span>
<span class="strong"><strong class="calibre2">    --name cookbook.test_snapshot-$(date +"%FT%H%M%S")</strong></span>
<span class="strong"><strong class="calibre2">    cookbook.test</strong></span>
</pre></div><p class="calibre22">This brings an output like the following:</p><div class="mediaobject"><img src="../images/00108.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">We can <a id="id370" class="calibre1"/>verify that the snapshot was created with the following command. Note that we limited the screenshot to just show our snapshotted image:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack image list</strong></span>
</pre></div><p class="calibre22">This gives an output that will show our snapshotted image:</p><div class="mediaobject"><img src="../images/00109.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Snapshotting an instance" id="2E6E41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec222" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">Instance <a id="id371" class="calibre1"/>snapshots create a Glance image of the running instance. The snapshot can be used for backup, redistribution, or part of a continuous deployment pipeline as a build artifact. The images created with <code class="email">openstack server image create --name [snapshot_name] [instance]</code> are bootable. You have a large degree of flexibility in how they are used.</p></div></div>

<div class="book" title="Snapshotting an instance" id="2E6E41-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec223" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre10">Instance snapshots are rather powerful. While a full exploration of the possibilities are beyond the scope of this book, the following example shows you what can be achieved using this feature: an easy way to back up all running instances.</p><p class="calibre10">To snapshot every instance, use the following command:</p><div class="informalexample"><pre class="programlisting">for instance in $(openstack server list -f value -c ID); do {
    openstack server image create \
      --name "${instance}"-$(date +"%FT%H%M%S") ${instance}
}; done</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip51" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Warning</strong></span>: Snapshotting every instance is not recommended for larger environments. In addition to being time consuming, it can also consume a rather large amount of storage used by Glance, as snapshots are not sparsely created like those of the original QCOW2 image you may have used</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Booting an instance from a snapshot" id="2F4UM1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec80" class="calibre1"/>Booting an instance from a snapshot</h1></div></div></div><p class="calibre10">Now that <a id="id372" class="calibre1"/>we have created an instance snapshot, imagine that we need to go back and recover files, or revert the application to the state it was at the time the snapshot was taken. As the snapshot is stored as an OpenStack image, you can boot directly from the snapshot, and as such all the details required to boot an instance applies to booting a snapshot.</p></div>

<div class="book" title="Booting an instance from a snapshot" id="2F4UM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec224" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To start an instance from a snapshot, you will need the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> of the instance</li><li class="listitem">The <span class="strong"><em class="calibre18">snapshot</em></span> to use for the instance</li><li class="listitem">The name of the <span class="strong"><em class="calibre18">flavor</em></span> to create the instance with (this must be of equal or greater size of flavor compared with the one used in the original instance)</li><li class="listitem">The name of the <span class="strong"><em class="calibre18">network</em></span> or networks to attach the instance to</li><li class="listitem">The <span class="strong"><em class="calibre18">keypair</em></span> name to allow access to an instance</li><li class="listitem">The name of any <span class="strong"><em class="calibre18">security groups</em></span> to associate with the instance</li></ul></div></div></div>

<div class="book" title="Booting an instance from a snapshot" id="2F4UM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec225" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">The instance we will boot will have the following attributes:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Image name: <code class="email">cookbook.test_snapshot-2017-09-08T163619</code></li><li class="listitem">Instance name: <code class="email">cookbook.test_restore</code></li><li class="listitem">Flavor type: <code class="email">openstack.cookbook</code></li><li class="listitem">Network: <code class="email">public</code> (UUID)</li><li class="listitem">Keypair name: <code class="email">cookbook_key</code></li><li class="listitem">Security groups: <code class="email">ssh</code></li></ul></div><p class="calibre10">To boot from an instance snapshot, we use the same process as used when booting an instance. The commands are repeated here:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we can list the existing running instances with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list -c Name -c Status</strong></span>
</pre></div><p class="calibre22">This will bring back a list of <code class="email">ACTIVE</code> running instances:</p><div class="mediaobject"><img src="../images/00110.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">We can <a id="id373" class="calibre1"/>then boot the instance snapshot using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server create</strong></span>
<span class="strong"><strong class="calibre2">    --flavor openstack.cookbook</strong></span>
<span class="strong"><strong class="calibre2">    --image cookbook.test_snapshot-2017-09-08T163619</strong></span>
<span class="strong"><strong class="calibre2">    --nic net-id=6cb5a4ce-1ea5-4817-9c34-a2212a66f394 </strong></span>
<span class="strong"><strong class="calibre2">    --security-group bd7d5e0f-538a-4d93-b123-98cc3207b3d2 </strong></span>
<span class="strong"><strong class="calibre2">    --key-name cookbook_key</strong></span>
<span class="strong"><strong class="calibre2">  cookbook.test_restore</strong></span>
</pre></div><p class="calibre22">This will bring back the familiar booting an instance output that has been omitted here.</p></li><li class="listitem" value="3">We can now list the running instances again to show our <code class="email">cookbook.test_restore</code> instance is <code class="email">ACTIVE</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server list -c Name -c Status</strong></span>
</pre></div><p class="calibre22">This shows our instance is now running:</p><div class="mediaobject"><img src="../images/00111.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Booting an instance from a snapshot" id="2F4UM1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec226" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">As instance <a id="id374" class="calibre1"/>snapshots are stored as OpenStack images, booting from a snapshot is an identical process to booting from an existing image. There are some caveats however. As snapshots are created while an image is running, booting from them is similar to booting a server after a power failure. You must also ensure that you are using a flavor that is of equal or greater size to the original instance—for example, if an instance was originally created as an m1.large, the snapshot must be booted with an m1.large or greater flavor. Additionally, if the instance is a Windows image attached to an Active Directory domain, it may cause issues having two of the same instances running at the same time. To mitigate this, consider booting the instance onto a separate recovery network.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip52" class="calibre1"/>Tip</h3><p class="calibre10">There are tools available to quiesce the filesystem inside an instance and provide a more consistent image that are beyond the scope of this book. However, as guidance, ensuring that a filesystem sync (to flush any disk writes) inside the running instance is recommended before a snapshot is taken.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Rescuing an instance" id="2G3F81-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec81" class="calibre1"/>Rescuing an instance</h1></div></div></div><p class="calibre10">OpenStack <a id="id375" class="calibre1"/>Compute provides a handy troubleshooting tool with rescue mode. Should a user lose an SSH key, or otherwise not be able to boot and access an instance, say, bad iptables settings or failed network configuration, rescue mode will start a minimal instance and attach the disk from the failed instance to aid in recovery. This applies to both Windows and Linux instances as this process essentially allows the mounting of the boot volume of your failed instance as a secondary disk to the rescue instance.</p></div>

<div class="book" title="Rescuing an instance" id="2G3F81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec227" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To put an instance into rescue mode, you will need the following information:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the instance</li></ul></div><p class="calibre10">The instance we will use in this example is <code class="email">cookbook.test</code>.</p></div></div>

<div class="book" title="Rescuing an instance" id="2G3F81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec228" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To put <a id="id376" class="calibre1"/>an instance into rescue mode, use the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we will put the instance into rescue mode as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server rescue cookbook.test</strong></span>
</pre></div><p class="calibre22">This will present us with a temporary password we can then use to access the rescue instance:</p><div class="mediaobject"><img src="../images/00112.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">To verify that an instance is in rescue mode, use the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test -c name -c status</strong></span>
</pre></div><p class="calibre22">This will present the <code class="email">status</code> value as <code class="email">RESCUE</code>:</p><div class="mediaobject"><img src="../images/00113.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">At this point, we can then access this instance, using the <code class="email">root</code> username, and the temporary password we were given to perform operating system rescue commands on the mounted filesystem (the filesystem that is the boot volume of our original, broke instance).<div class="note" title="Note"><h3 class="title2"><a id="tip53" class="calibre1"/>Tip</h3><p class="calibre10">When in rescue mode, the disk of the instance in rescue mode is attached as a secondary. In order to access the data on the disk, you will need to mount it. As filesystems differ between OS and deployment, showing the mount process is beyond the scope of this book.</p></div></li><li class="listitem" value="4">To exit rescue mode, use the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server unrescue cookbook.test</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip54" class="calibre1"/>Tip</h3><p class="calibre10">This command will produce no output if successful.</p></div></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Rescuing an instance" id="2G3F81-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec229" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">openstack server rescue</code> command provides a rescue environment with the disk of your instance attached. First, it powers off the named instance, then it boots the rescue environment attaching the disks of the original instance. Finally, it provides you with the login <a id="id377" class="calibre1"/>credentials for the rescue instance.</p><p class="calibre10">Accessing the rescue instance is done via SSH. Once logged in to the rescue instance, you can mount the disk using mount <code class="email">&lt;path to disk&gt; /mnt</code>.</p><p class="calibre10">Once you have completed your troubleshooting or recovery, the <code class="email">unrescue</code> command reverses this process; first, stopping the rescue environment and detaching the disk, then booting the instance as it originally was.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Shelving an instance" id="2H1VQ1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec82" class="calibre1"/>Shelving an instance</h1></div></div></div><p class="calibre10">Somewhat <a id="id378" class="calibre1"/>unique to OpenStack Nova is the ability to <span class="strong"><em class="calibre18">shelve</em></span> an instance. Instance shelving allows you to stop an instance without having it consume resources. A shelved instance will be retained as a bootable instance, as well as its resources assigned such as IP address, for a configurable amount of time, then deleted. This is useful as part of an instance life cycle process or to conserve resources.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip55" class="calibre1"/>Tip</h3><p class="calibre10">
<span class="strong"><strong class="calibre2">Stopping versus shelving?</strong></span>
</p><p class="calibre10">Stopping an instance does not free up the amount of resources still available as part of your quota as the assumption is that you will be starting that instance back up again after a short period of time. You would not be able to start a stopped instance if you didn't have any free CPUs or GBs of RAM left of your assigned quota. A stopped instance's resources are still considered <span class="strong"><em class="calibre18">used resources</em></span> to the OpenStack Compute scheduler.</p><p class="calibre10">Shelving, however, frees up these resources, but still allows you, at a later date, to access the shelved instance. Quota rules and restrictions still apply when unshelving an instance, but shelving an instance will allow you to work within your allotted resource quotas while preserving your instance data.</p></div></div>

<div class="book" title="Shelving an instance" id="2H1VQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec230" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To shelve an instance, the following information is required:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the instance</li></ul></div></div></div>

<div class="book" title="Shelving an instance" id="2H1VQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec231" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To shelve an instance, the following commands are used:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we check the status of the instance:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test -c name -c status</strong></span>
</pre></div><p class="calibre22">Ensure that your instance has <code class="email">status</code> of <code class="email">ACTIVE</code>:</p><div class="mediaobject"><img src="../images/00114.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">To shelve <a id="id379" class="calibre1"/>the instance, issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server shelve cookbook.test</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip56" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output when successful. Shelving an instance may take a few moments depending on your environment.</p></div></li><li class="listitem" value="3">To check the status of the instance, issue the following command, noting the new status:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test -c name -c addresses -c status</strong></span>
</pre></div><p class="calibre22">The <code class="email">status</code> value has changed to <code class="email">SHELVED_OFFLOADED</code>:</p><div class="mediaobject"><img src="../images/00115.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p><div class="note" title="Note"><h3 class="title2"><a id="tip57" class="calibre1"/>Tip</h3><p class="calibre10">A shelved instance will retain the addresses it has been assigned.</p></div></li><li class="listitem" value="4">To unshelve the instance and return it back to an <code class="email">ACTIVE</code> state, simply issue the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server unshelve cookbook.test</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title2"><a id="tip58" class="calibre1"/>Tip</h3><p class="calibre10">This command produces no output when successful. As with shelving, the instance may take a few moments to become active, depending on your environment.</p></div></li><li class="listitem" value="5">We can verify the state by checking the status:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack server show cookbook.test -c name -c addresses -c status</strong></span>
</pre></div><p class="calibre22">The <code class="email">status</code> value has returned to <code class="email">ACTIVE</code>:</p><div class="mediaobject"><img src="../images/00116.jpeg" alt="How to do it…" class="calibre16"/></div><p class="calibre23"> </p></li></ol><div class="calibre20"/></div></div></div>

<div class="book" title="Shelving an instance" id="2H1VQ1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec232" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">When told <a id="id380" class="calibre1"/>to shelve an instance, OpenStack Compute will first stop the instance. It then creates an instance snapshot to retain the state of the instance. The runtime details, such as number of vCPUs, memory, and IP addresses, are retained so that the instance can be unshelved and rescheduled at a later time.</p><p class="calibre10">This differs from shutting down an instance, in that the resources of a shutdown instance are still reserved on the host on which it resided, so that it can be powered back on quickly. A shelved instance however, will still show in <code class="email">openstack server list</code>, while the resources that were assigned will remain available. Additionally, as the shelved instance will need to be restored from an image, OpenStack Compute will perform placement as if the instance were new, and starting it will take some time.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Reviewing the console logs" id="2I0GC1-189e69df43a248268db97cde1b1a8e47"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec83" class="calibre1"/>Reviewing the console logs</h1></div></div></div><p class="calibre10">Console logs <a id="id381" class="calibre1"/>are critical for troubleshooting the startup process of an instance. These logs are produced at boot time, before the console becomes available. Typically, when working with cloud hosted instances, accessing these can be difficult. OpenStack Compute provides a mechanism for accessing the console logs.</p></div>

<div class="book" title="Reviewing the console logs" id="2I0GC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec233" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre10">To access the console logs of an instance, the following information is required:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">openstack</code> command-line client</li><li class="listitem">The <code class="email">openrc</code> file containing appropriate credentials</li><li class="listitem">The <span class="strong"><em class="calibre18">name</em></span> or <span class="strong"><em class="calibre18">ID</em></span> of the instance</li></ul></div><p class="calibre10">For this example, we will view the last five lines of the <code class="email">cookbook.test</code> instance.</p></div></div>

<div class="book" title="Reviewing the console logs" id="2I0GC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec234" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre10">To show <a id="id382" class="calibre1"/>the console logs of an instance, use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openstack console log show --lines 5 cookbook.test</strong></span>
</pre></div><p class="calibre10">This connects to the serial console output of an instance, mimicking the information as if a monitor was directly attached to a physical server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">[[0;32m  OK  [0m] Started udev Coldplug all Devices.</strong></span>
<span class="strong"><strong class="calibre2">[[0;32m  OK  [0m] Started Dispatch Password Requests to Console Directory Watch.</strong></span>
<span class="strong"><strong class="calibre2">[[0;32m  OK  [0m] Started Set console font and keymap.</strong></span>
<span class="strong"><strong class="calibre2">[[0;32m  OK  [0m] Created slice system-getty.slice.</strong></span>
<span class="strong"><strong class="calibre2">[[0;32m  OK  [0m] Found device /dev/ttyS0.</strong></span>
</pre></div></div></div>

<div class="book" title="Reviewing the console logs" id="2I0GC1-189e69df43a248268db97cde1b1a8e47">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec235" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre10">The <code class="email">openstack console log show</code> command collects the console logs, as if you were connected <a id="id383" class="calibre1"/>to the server via a serial port or sitting behind the keyboard and monitor at boot time. The command will, by default, return all of the logs generated to that point. To limit the amount of output, the <code class="email">--lines</code> parameter can be used to return a specific number of lines from the end of the log.</p></div></div></body></html>