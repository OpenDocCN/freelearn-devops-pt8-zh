<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;11.&#xA0;Logging and Scaling Your OpenShift Applications"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11" class="calibre1"/>Chapter 11. Logging and Scaling Your OpenShift Applications</h1></div></div></div><p class="calibre6">The specific recipes of this chapter are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Viewing application logs</li><li class="listitem">Working with JBoss application logs</li><li class="listitem">Enabling JBoss access logs</li><li class="listitem">Working with Tomcat application logs</li><li class="listitem">Working with Python application logs</li><li class="listitem">Creating scalable applications</li><li class="listitem">Configuring a different health check URL for HAProxy</li><li class="listitem">Configuring HAProxy to use a different balance algorithm</li><li class="listitem">Creating scalable apps from nonscalable apps</li><li class="listitem">Enabling manual scaling with marker files</li></ul></div></div>

<div class="book" title="Chapter&#xA0;11.&#xA0;Logging and Scaling Your OpenShift Applications">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch11lvl1sec125" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre6">This chapter consists of recipes that will help you to work with the application logs and create scalable applications. The logging recipes will help you to access your application logs and debug any problems you might encounter while running your applications. You will learn how OpenShift uses a component called <code class="email">logshifter</code> to store all application- and cartridge-specific logs in <code class="email">OPENSHIFT_LOG_DIR</code>. This chapter will go into application logging in detail and cover various aspects of logging the JBoss, Tomcat, and Python applications. The logging concepts covered in this chapter will help you work with any web cartridge logs.</p><p class="calibre6">The <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe will give you a general introduction to application logging, with the PHP web cartridge as an example. You will learn how to access application logs using the <code class="email">rhc</code> command-line tool, and understand the log format used by Apache-based cartridges. Next, you will learn how to access JBoss application logs in the <span class="strong"><em class="calibre10">Working with JBoss application logs</em></span> and <span class="strong"><em class="calibre10">Enabling JBoss access logs</em></span> recipes. The <span class="strong"><em class="calibre10">Working with Python application logs</em></span> recipe will cover how to effectively work with Python application logs.</p><p class="calibre6">The second section of this chapter will discuss application scaling in detail. You will learn how to create autoscalable applications in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe. Autoscaling is not always desired, and at times you need manual control over application scaling. In the <span class="strong"><em class="calibre10">Enabling manual scaling with marker files</em></span> recipe, you will learn how to disable autoscaling and manually scale OpenShift applications using the <code class="email">rhc</code> command-line tool.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Viewing application logs"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec126" class="calibre1"/>Viewing application logs</h1></div></div></div><p class="calibre6">Logs<a id="id1071" class="calibre1"/> are important data generated by your application that can help you understand user heuristics, monitor application performance, and debug problems. They are the first place you look when something goes wrong in your application. OpenShift uses a<a id="id1072" class="calibre1"/> service called <code class="email">logshifter</code>, which collects logs from all the different pieces of your application and makes them accessible at a single location. These logs can then be fed to your favorite log management solution, such as Splunk, to gain more useful insights. In this recipe, you will learn how easily you can view all the logs of your application using a single command. This recipe covers logging in a cartridge-agnostic manner. The language-specific aspects of logging will be covered later in this chapter.</p></div>

<div class="book" title="Viewing application logs">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec487" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you <a id="id1073" class="calibre1"/>will need <code class="email">rhc</code> installed on your machine. Also, we will make use of the OpenShift application created in the <span class="strong"><em class="calibre10">Creating an OpenShift application using the rhc command-line client</em></span> recipe in <a class="calibre1" title="Chapter 3. Creating and Managing Applications" href="part0041_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Creating and Managing Applications</em></span>.</p><p class="calibre6">To recreate the application, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app myapp php-5.4</strong></span>
</pre></div></div></div>

<div class="book" title="Viewing application logs">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec488" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">To view the logfiles of your application, perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal and run the following command, either from within the application directory or by passing the application name using the <code class="email">--app</code> option. Have a look at the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail</strong></span>
</pre></div></li><li class="listitem" value="2">You can also use the app name, as shown in the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --app myapp</strong></span>
</pre></div></li><li class="listitem" value="3">Open your favorite browser and go to <code class="email">http://myapp-{domain-name}.rhcloud.com</code>. You will notice new logs being tailed on your command-line terminal. A small snippet of logs is shown in the following command-line output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">117.212.42.145 - - [22/Jun/2014:15:28:03 -0400] "GET / HTTP/1.1" 200 39627 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.153 Safari/537.36"</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Viewing application logs">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec489" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">Every OpenShift application uses one or more cartridges to do its work. Each cartridge is configured to log messages to <code class="email">stdout</code> or <code class="email">stderr</code>. An OpenShift service called <code class="email">logshifter</code> captures all the messages sent to <code class="email">stdout</code> as well as <code class="email">stderr</code> and logs them properly. In OpenShift Online, all the messages captured by <code class="email">logshifter</code> are written to the <code class="email">$OPENSHIFT_LOGS_DIR</code> directory. You can SSH into your application gear using the <code class="email">rhc ssh</code> command and look into the <code class="email">$OPENSHIFT_LOGS_DIR</code> directory, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">[myapp-{domain-name}.rhcloud.com logs]\&gt; cd $OPENSHIFT_LOG_DIR</strong></span>
<span class="strong"><strong class="calibre7">[myapp-{domain-name}.rhcloud.com logs]\&gt; ls</strong></span>
<span class="strong"><strong class="calibre7">php.log</strong></span>
</pre></div><p class="calibre6">As you can see in the<a id="id1074" class="calibre1"/> preceding command line, the <code class="email">$OPENSHIFT_LOGS_DIR</code> directory contains one logfile called <code class="email">php.log</code>. All the application and Apache logs (both access and error) will be written to this logfile. The name of the logfile depends on the tag name passed to <code class="email">logshifter</code> during the cartridge startup. For example, the <code class="email">php</code> cartridge is started using the <code class="email">nohup /usr/sbin/httpd $HTTPD_CMD_CONF -D FOREGROUND |&amp; /usr/bin/logshifter -tag php &amp;</code> command. This command ensures that the Apache logs are piped to the <code class="email">logshifter</code> service and uses <code class="email">php</code> as the tag name. The tag name serves two purposes: first, it identifies the program that generated the log message, and second, it is used as the name of the logfile.</p><p class="calibre6">In step 1, you ran the <code class="email">rhc tail</code> command; this <a id="id1075" class="calibre1"/>command opened an SSH tunnel behind the scenes and ran the <code class="email">tail –f */log*/*</code> command on your application gear. The <code class="email">-f</code> option allows a file to be monitored continuously. As new lines are added to the logfile, <code class="email">tail</code> will update the display. The <code class="email">rhc tail</code> command will tail all the logs in your application gear's <code class="email">$OPENSHIFT_LOG_DIR</code> directory, as shown in step 2. The sample output is shown in the following command. All the Apache-based cartridges (PHP, Python, Perl, and Ruby) will have similar output in the logs. Have a look at the following command output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">117.212.42.145 - - [22/Jun/2014:15:28:03 -0400] "GET / HTTP/1.1" 200 39627 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.153 Safari/537.36"</strong></span>
</pre></div><p class="calibre6">At first glance, the output<a id="id1076" class="calibre1"/> might look a bit cryptic; on closer inspection, it is no different from most application logs. The log follows <a id="id1077" class="calibre1"/>Apache Combined Log Format (<a class="calibre1" href="https://httpd.apache.org/docs/trunk/logs.html#combined">https://httpd.apache.org/docs/trunk/logs.html#combined</a>). The format used is <code class="email">"%{X-Forwarded-For}i %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</code>. Let's look at all these options one by one:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">%{X-Forwarded-For}i</code>: This is the<a id="id1078" class="calibre1"/> HTTP request <code class="email">X-Forwarded-For</code> header. It contains the IP address of the original client. In the log line shown in the preceding command, it corresponds to <code class="email">117.212.42.145</code>.</li><li class="listitem"><code class="email">%l</code>: This is the <a id="id1079" class="calibre1"/>user identity determined by <code class="email">identd</code>. This will return <code class="email">-</code> when the value is not present. In the log line shown in the preceding command, the value is <code class="email">-</code>.</li><li class="listitem"><code class="email">%u</code>: This is the <a id="id1080" class="calibre1"/>remote user determined by HTTP authentication. This will return <code class="email">-</code> when the value is not present. In the log line shown in the preceding command, the value is <code class="email">-</code>.</li><li class="listitem"><code class="email">%t</code>: This is the<a id="id1081" class="calibre1"/> time when the HTTP request is received. In the log line shown in the preceding command, the value is <code class="email">[22/Jun/2014:15:28:03 -0400]</code>.</li><li class="listitem"><code class="email">\"%r\"</code>: This is the<a id="id1082" class="calibre1"/> first line of the HTTP request. In the log line shown in the preceding command, the value is <code class="email">GET / HTTP/1.1</code>.</li><li class="listitem"><code class="email">%&gt;s</code>: This is the<a id="id1083" class="calibre1"/> HTTP status code. In the log line shown in the preceding command, the value is <code class="email">200</code>, which means the request was successful.</li><li class="listitem"><code class="email">%b</code>: This<a id="id1084" class="calibre1"/> is the response from the server in bytes. In the log line shown in the preceding section, the value is <code class="email">39627</code>.</li><li class="listitem"><code class="email">\"%{Referer}i\"</code>: This is the <a id="id1085" class="calibre1"/>referrer URL that is linked to this URL. In the log line shown in the preceding section, the value is <code class="email">-</code>, which means it was not present.</li><li class="listitem"><code class="email">\"%{User-Agent}i\"</code>: This<a id="id1086" class="calibre1"/> is the user agent taken from the HTTP request header. In the log line shown in the preceding section, the value is <code class="email">Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.153 Safari/537.36</code>.</li></ul></div><p class="calibre6">As mentioned in the preceding section, <code class="email">logshifter</code> will write one logfile per cartridge. So, if you add the MySQL cartridge to your application, then <code class="email">logshifter</code> will create another logfile with the name <code class="email">mysql.log</code> and write all the MySQL-specific logs to it. The <code class="email">rhc tail</code> command will tail all the files present inside <code class="email">$OPENSHIFT_LOG_DIR</code>. Make sure to run the <code class="email">tail</code> command again so it can read the new logfile:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">==&gt; app-root/logs/php.log &lt;==</strong></span>
<span class="strong"><strong class="calibre7">117.212.42.145 - - [22/Jun/2014:17:18:09 -0400] "GET / HTTP/1.1" 200 39627 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.153 Safari/537.36"</strong></span>
<span class="strong"><strong class="calibre7">==&gt; app-root/logs/mysql.log &lt;==</strong></span>
<span class="strong"><strong class="calibre7">140622 17:17:31 [Note] Event Scheduler: Loaded 0 events</strong></span>
<span class="strong"><strong class="calibre7">140622 17:17:31 [Note] /opt/rh/mysql55/root/usr/libexec/mysqld: ready for connections.</strong></span>
</pre></div><p class="calibre6">The <code class="email">mysql.log</code> logfile <a id="id1087" class="calibre1"/>will contain all the MySQL logs. If you want to tail only a specific cartridge log, then you can use the <code class="email">-f</code> or <code class="email">--files</code> option of the <code class="email">rhc tail</code> command, as shown in the following command. This will tail only the <code class="email">mysql.log</code> file.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --files app-root/logs/mysql.log</strong></span>
</pre></div><p class="calibre6">You can view all the <code class="email">rhc tail</code> command options by looking at its help, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --help</strong></span>
</pre></div><p class="calibre6">Another responsibility <code class="email">logshifter</code> performs is rolling logfiles based on the file size when they reach a configurable threshold. It also allows you to retain a configurable number of rolled files before removing the oldest prior to the next roll. You can configure the file size and the number of rolled files using the <code class="email">LOGSHIFTER_$TAG_MAX_FILESIZE</code> and <code class="email">LOGSHIFTER_$TAG_MAX_FILES</code> environment variables, where <code class="email">$TAG</code> is replaced by an uppercase string equal to the value of the <code class="email">-tag</code> argument. The default values used by <code class="email">logshifter</code> are <code class="email">10M</code> (<code class="email">M</code> for megabytes) for file size and <code class="email">10</code> for the number of rolled files. Let's suppose you want to configure values as <code class="email">20M</code> for file size and <code class="email">5</code> for the number of rolled files. To configure these new values, you have to first use the <code class="email">rhc env</code> command to set new environment variables and then restart the application, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc env-set LOGSHIFTER_PHP_MAX_FILES=5 LOGSHIFTER_PHP_MAX_FILESIZE=20M &amp;&amp; rhc restart-app</strong></span>
</pre></div><p class="calibre6">You can specify the file size in kilobytes (for example, <code class="email">100K</code>), megabytes (for example, <code class="email">20M</code>), gigabytes (for example, <code class="email">10G</code>), or terabytes (for example, <code class="email">2T</code>). The value of <code class="email">0</code> for the file size will effectively disable the file rolling.</p></div></div>

<div class="book" title="Viewing application logs">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec490" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">You can also ask the <code class="email">rhc tail</code> command<a id="id1088" class="calibre1"/> to output the last <code class="email">n</code> lines using <code class="email">--opts</code> or <code class="email">-o</code>. To output the last 100 lines, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --opts "-n 100"</strong></span>
</pre></div><p class="calibre6">You can pass other <code class="email">tail</code> command options, as well, using the <code class="email">--opts</code> option.</p></div></div>

<div class="book" title="Viewing application logs">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch11lvl2sec491" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Creating an OpenShift application using the rhc command-line client</em></span> recipe in <a class="calibre1" title="Chapter 3. Creating and Managing Applications" href="part0041_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Creating and Managing Applications</em></span></li><li class="listitem">The <span class="strong"><em class="calibre10">Working with JBoss application logs</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Working with Tomcat application logs</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Working with Python application logs</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Working with JBoss application logs"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec127" class="calibre1"/>Working with JBoss application logs</h1></div></div></div><p class="calibre6">As mentioned in the <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe, logs are important data generated by your applications. This <a id="id1089" class="calibre1"/>recipe will cover in detail how you can work with logs in OpenShift's JBoss cartridge applications. This recipe will start with viewing logs of an existing JBoss application, and then you will add application-specific logging using the <code class="email">SLF4J</code> library. This recipe assumes you have already read the <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe.</p></div>

<div class="book" title="Working with JBoss application logs">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec492" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe will use the application created in the <span class="strong"><em class="calibre10">Creating and deploying Java EE 6 applications using the JBoss EAP and PostgreSQL 9.2 cartridges</em></span> recipe in <a class="calibre1" title="Chapter 7. OpenShift for Java Developers" href="part0089_split_000.html#page">Chapter 7</a>, <span class="strong"><em class="calibre10">OpenShift for Java Developers</em></span>. You can recreate the application using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstore jbosseap postgresql-9.2 --from-code https://github.com/OpenShift-Cookbook/chapter7-jobstore-javaee6.git</strong></span>
</pre></div></div></div>

<div class="book" title="Working with JBoss application logs">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec493" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">You can view the JBoss cartridge logs by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --files */log*/jbosseap.log --app jobstore </strong></span>
</pre></div></li><li class="listitem" value="2">You used the <code class="email">--files</code> option to restrict the <code class="email">rhc tail</code> command to only show JBoss-specific logs; otherwise, it will show all the logs in the <code class="email">$OPENSHIFT_LOG_DIR</code> directory. This will print logs, as shown in the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">==&gt; app-root/logs/jbosseap.log &lt;==</strong></span>
<span class="strong"><strong class="calibre7">2014/06/28 13:05:59,844 INFO  [org.jboss.web] (ServerService Thread Pool -- 65) JBAS018210: Register web context: </strong></span>
<span class="strong"><strong class="calibre7">2014/06/28 13:06:00,153 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 36) JBAS018559: Deployed "ROOT.war" (runtime-name : "ROOT.war")</strong></span>
</pre></div></li><li class="listitem" value="3">Open the application URL at <code class="email">http://jobstore-{domain-name}.rhcloud.com</code> in your favorite browser, and you will see Hibernate-specific logs in your terminal. When you go to the application root, then an HTTP GET request is made to fetch all the companies in the database. The following query is the SQL statement that Hibernate executes to get data from the database:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">2014/06/28 13:42:50,423 INFO [stdout] (http-127.13.169.1/127.13.169.1:8080-1) Hibernate: select company0_.id as col_0_0_, company0_.name as col_1_0_, company0_.description as col_2_0_ from Company company0_</strong></span>
</pre></div></li><li class="listitem" value="4">OpenShift's JBoss <a id="id1090" class="calibre1"/>cartridge is configured to log all the <code class="email">INFO</code> and preceding messages to the console. As mentioned in the <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe, any message written to <code class="email">stdout</code> will be picked by <code class="email">logshifter</code> and written to a logfile. For the JBoss EAP cartridge, the logfile name is <code class="email">jbosseap.log</code>, and for the JBoss AS 7 cartridge, the logfile name will be <code class="email">jbossas.log</code>. You can update the logging configuration to show all the <code class="email">DEBUG</code> and preceding messages by updating the logging subsystem in the <code class="email">standalone.xml</code> file inside the <code class="email">.openshift/config</code> directory with the following code:<div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
  &lt;console-handler name="CONSOLE"&gt;
    &lt;level name="DEBUG" /&gt;
    &lt;formatter&gt;
      &lt;pattern-formatter
        pattern="%d{yyyy/MM/dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n" /&gt;
    &lt;/formatter&gt;
  &lt;/console-handler&gt;
  &lt;logger category="com.arjuna"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="org.apache.tomcat.util.modeler"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="sun.rmi"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="jacorb"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="jacorb.config"&gt;
    &lt;level name="ERROR" /&gt;
  &lt;/logger&gt;
  &lt;root-logger&gt;
    &lt;level name="DEBUG" /&gt;
    &lt;handlers&gt;
      &lt;handler name="CONSOLE" /&gt;
    &lt;/handlers&gt;
  &lt;/root-logger&gt;
&lt;/subsystem&gt;</pre></div></li><li class="listitem" value="5">Commit the changes in your local Git repository, and then push them to the OpenShift application gear. OpenShift will now use the updated <code class="email">standalone.xml</code> file, and you will see the <code class="email">DEBUG</code> logs in the output of the <code class="email">rhc tail</code> command.</li><li class="listitem" value="6">As the application <a id="id1091" class="calibre1"/>is not logging anything, the output of the <code class="email">rhc tail</code> command either shows the application server logs or the logs of the different libraries used by your application. You can use any of the Java logging libraries to add application-specific logs. In this recipe, you will use <code class="email">SLF4J</code> with <code class="email">java.util.logging</code> binding to log the application logs, but you can use any other <code class="email">SLF4J</code> binding, such as <code class="email">log4j</code> or <code class="email">logback</code>, as well. Open the Maven <code class="email">pom.xml</code> file, and add the following dependencies to it:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
  &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
  &lt;version&gt;1.7.7&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
  &lt;artifactId&gt;slf4j-jdk14&lt;/artifactId&gt;
  &lt;version&gt;1.7.7&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem" value="7">Open the <code class="email">CompanyResource.java</code> file inside the <code class="email">org.osbook.jobstore.rest</code> package in an editor, and add a couple of statements to import the <code class="email">SLF4J</code> classes, as shown in the following code:<div class="informalexample"><pre class="programlisting">import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</pre></div></li><li class="listitem" value="8">After adding the <code class="email">import</code> statements, update the <code class="email">createNewCompany()</code> and <code class="email">showAll()</code> methods in <code class="email">CompanyResource.java</code> with log messages, as shown in the following code:<div class="informalexample"><pre class="programlisting">private Logger logger = LoggerFactory.getLogger(CompanyResource.class);
@Inject
private CompanyService companyService;

@POST
@Consumes(MediaType.APPLICATION_JSON)
public Response createNewCompany(@Valid Company company) {
  logger.debug("inside createNewCompany().. creating new company {}" , company);
  Company existingCompanyWithName = companyService.findByName(company.getName());
  if (existingCompanyWithName != null) {
    logger.debug("Company with name {} already exists : {}" , company.getName(), existingCompanyWithName);
    return Response.status(Status.NOT_ACCEPTABLE)
            .entity(String.format("Company already exists with name: %s",company.getName())).build();
    }
  company = companyService.save(company);
  logger.info("Created new company {}" , company);
  return Response.status(Status.CREATED).entity(company).build();
}

@GET
@Produces(MediaType.APPLICATION_JSON)
public List&lt;Company&gt; showAll() {
  List&lt;Company&gt; companies = companyService.findAll();
  logger.info("Found {} companies" , companies.size());
  return companies;
}</pre></div></li><li class="listitem" value="9">Revert the changes<a id="id1092" class="calibre1"/> you made to the <code class="email">standalone.xml</code> file in step 3 to view only the <code class="email">INFO</code> messages. Change the <code class="email">root-logger</code> level to <code class="email">INFO</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;root-logger&gt;
  &lt;level name="INFO" /&gt;
  &lt;handlers&gt;
    &lt;handler name="CONSOLE" /&gt;
  &lt;/handlers&gt;
&lt;/root-logger&gt;</pre></div></li><li class="listitem" value="10">Commit the changes to the local Git repository, and then push them to the application gear using the <code class="email">git push</code> command.</li><li class="listitem" value="11">After the changes are deployed, make another request to the web application, and this time you will see your application logs in the <code class="email">rhc tail</code> command output, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">2014/06/28 14:24:50,959 INFO  [org.osbook.jobstore.rest.CompanyResource] (http-127.13.169.1/127.13.169.1:8080-1) Found 1 companies</strong></span>
</pre></div></li><li class="listitem" value="12">If you try to create a new company, then you see that only the <code class="email">INFO</code> messages are getting logged. This is because the logging configuration in the <code class="email">standalone.xml</code> file is configured to only log <code class="email">INFO</code> and preceding messages to the console.</li><li class="listitem" value="13">To view the debug<a id="id1093" class="calibre1"/> messages of your application, you have to update the <code class="email">standalone.xml</code> logging subsystem configuration with the one shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
  &lt;console-handler name="CONSOLE"&gt;
    &lt;level name="DEBUG" /&gt;
    &lt;formatter&gt;
      &lt;pattern-formatter
        pattern="%d{yyyy/MM/dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n" /&gt;
    &lt;/formatter&gt;
  &lt;/console-handler&gt;
  &lt;logger category="com.arjuna"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="org.apache.tomcat.util.modeler"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="sun.rmi"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="jacorb"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;logger category="jacorb.config"&gt;
    &lt;level name="ERROR" /&gt;
  &lt;/logger&gt;
  &lt;logger category="org.osbook.jobstore"&gt;
    &lt;level name="DEBUG"&gt;&lt;/level&gt;
  &lt;/logger&gt;
  &lt;root-logger&gt;
    &lt;level name="INFO" /&gt;
    &lt;handlers&gt;
      &lt;handler name="CONSOLE" /&gt;
    &lt;/handlers&gt;
  &lt;/root-logger&gt;
&lt;/subsystem&gt; </pre></div></li><li class="listitem" value="14">Now, you will also see the application-specific <code class="email">DEBUG</code> logs in the output of the <code class="email">rhc tail</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">2014/06/28 14:40:22,410 DEBUG [org.osbook.jobstore.rest.CompanyResource] (http-/127.13.169.1:8080-1) inside createNewCompany().. creating new company</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Working with JBoss application logs">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec494" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In the preceding steps, you learned how you can view the logs of a JBoss application and add application-specific logging using the <code class="email">SLF4J</code> library. In step 1, you ran the <code class="email">rhc tail</code> command to view all the JBoss-specific logs. All the JBoss EAP-specific logs are written to the <code class="email">jbosseap.log</code> file. This file contains both the JBoss <code class="email">server.log</code> and <code class="email">boot.log</code> content. As discussed in the <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe, <code class="email">logshifter</code> will collect all the logs written to <code class="email">stdout</code> or <code class="email">stderr</code> and write them to the cartridge-specific logfile. Logging the subsystem configuration in the <code class="email">standalone.xml</code> configuration file controls the logging in JBoss cartridges. The <code class="email">standalone.xml</code> file is present inside the <code class="email">.openshift/config</code> directory, and <a id="id1094" class="calibre1"/>you can override it to meet your needs. The logging subsystem consists of three parts: one or more handler configurations, such as <code class="email">console-handle</code> or <code class="email">file-handler</code>, one or more loggers to define a logger category, such as <code class="email">com.arjuna</code> shown in the next code, and a <code class="email">root-logger</code> declaration. You can read more about the JBoss logging configuration<a id="id1095" class="calibre1"/> in the official documentation at <a class="calibre1" href="https://docs.jboss.org/author/display/AS71/Logging+Configuration">https://docs.jboss.org/author/display/AS71/Logging+Configuration</a>. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;subsystem &gt;
  &lt;console-handler name="CONSOLE"&gt;
    &lt;level name="DEBUG" /&gt;
    &lt;formatter&gt;
      &lt;pattern-formatter
        pattern="%d{yyyy/MM/dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n" /&gt;
    &lt;/formatter&gt;
  &lt;/console-handler&gt;
  &lt;logger category="com.arjuna"&gt;
    &lt;level name="WARN" /&gt;
  &lt;/logger&gt;
  &lt;root-logger&gt;
    &lt;level name="DEBUG" /&gt;
    &lt;handlers&gt;
      &lt;handler name="CONSOLE" /&gt;
    &lt;/handlers&gt;
  &lt;/root-logger&gt;
&lt;/subsystem&gt;</pre></div><p class="calibre6">In step 3, you updated the <code class="email">root-logger</code> level to <code class="email">DEBUG</code>. This enables the JBoss server to generate <code class="email">DEBUG</code> and preceding-level logs.</p><p class="calibre6">From step 5 through step 11, you first added the application logs using the <code class="email">SLF4J</code> library and then updated <code class="email">standalone.xml</code> logger subsystem configuration to allow JBoss to log the application <code class="email">DEBUG</code> and preceding messages. This was done by adding an application-specific <code class="email">logger category</code> at<a id="id1096" class="calibre1"/> the <code class="email">DEBUG</code> level. Have a look at the following code:</p><div class="informalexample"><pre class="programlisting">  &lt;logger category="org.osbook.jobstore"&gt;
    &lt;level name="DEBUG"&gt;&lt;/level&gt;
  &lt;/logger&gt;</pre></div></div></div>

<div class="book" title="Working with JBoss application logs">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec495" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">After reading through this recipe, you might be wondering if there is a way to update the logging configuration at runtime. Yes, you can<a id="id1097" class="calibre1"/> do so using the JBoss admin console. To use the JBoss admin console, first run the <code class="email">rhc port-forward</code> command,<a id="id1098" class="calibre1"/> as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc port-forward --app jobstore</strong></span>
</pre></div><p class="calibre6">Then, go to the admin console at <code class="email">http://127.0.0.1:9990/</code>. Navigate to <span class="strong"><strong class="calibre7">Configuration</strong></span> | <span class="strong"><strong class="calibre7">Core</strong></span> | <span class="strong"><strong class="calibre7">Logging</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00145.jpeg" alt="There's more…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Now, go to <a id="id1099" class="calibre1"/>
<span class="strong"><strong class="calibre7">LOG CATEGORIES</strong></span>, and you will see a category for <code class="email">org.osbook.jobstore</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00146.jpeg" alt="There's more…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Change the <span class="strong"><strong class="calibre7">Log Level</strong></span> <a id="id1100" class="calibre1"/>value to <span class="strong"><strong class="calibre7">INFO</strong></span>, and click on the <span class="strong"><strong class="calibre7">Save</strong></span> button:</p><div class="mediaobject"><img src="../images/00147.jpeg" alt="There's more…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Now, if you try to create a new company, you will not see the <code class="email">DEBUG</code> messages. You will only see the <code class="email">INFO</code> and<a id="id1101" class="calibre1"/> preceding messages.</p></div></div>

<div class="book" title="Working with JBoss application logs">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch11lvl2sec496" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling JBoss access logs</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Enabling JBoss access logs"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec128" class="calibre1"/>Enabling JBoss access logs</h1></div></div></div><p class="calibre6">Access logs are very useful<a id="id1102" class="calibre1"/> when you want to see a list of all the requests processed by a server. For Apache-based cartridges, access logs are enabled by default, but you will have to enable it manually in JBoss-based cartridges. In this recipe, you will learn how to enable the access logs for JBoss cartridges.</p></div>

<div class="book" title="Enabling JBoss access logs">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec497" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe will pick up where we left off in the <span class="strong"><em class="calibre10">Working with JBoss application logs</em></span> recipe.</p></div></div>

<div class="book" title="Enabling JBoss access logs">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec498" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to enable the access logs:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open the <code class="email">standalone.xml</code> file inside the <code class="email">.openshift/config</code> directory in your favorite editor.</li><li class="listitem" value="2">Update the <code class="email">urn:jboss:domain:web:1.5</code> subsystem with the one shown in the following code:<div class="informalexample"><pre class="programlisting">&lt;subsystem 
  default-virtual-server="default-host" native="false"&gt;
  &lt;connector name="http" protocol="HTTP/1.1" scheme="http"
    socket-binding="http" /&gt;
  &lt;virtual-server name="default-host" enable-welcome-root="false"&gt;
    &lt;alias name="localhost" /&gt;
    &lt;access-log pattern="%a %t %H %p %U %s %S %T" rotate="true"&gt;
      &lt;directory path="app-root/logs/" relative-to="user.home" /&gt;
    &lt;/access-log&gt;
  &lt;/virtual-server&gt;
  &lt;valve name="remoteipvalve" module="org.jboss.as.web"
    class-name="org.apache.catalina.valves.RemoteIpValve"&gt;
    &lt;param param-name="protocolHeader" param-value="x-forwarded-proto" /&gt;
  &lt;/valve&gt;
&lt;/subsystem&gt;</pre></div></li><li class="listitem" value="3">Commit the changes to the local Git repository, and then push them to the application gear using the <code class="email">git push</code> command.</li><li class="listitem" value="4">Run the <code class="email">rhc tail</code> command again, and you will see the access logs in the <code class="email">tail</code> command output, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">==&gt; app-root/logs/access_log.2014-06-28 &lt;==</strong></span>
<span class="strong"><strong class="calibre7">106.211.32.170 [28/Jun/2014:15:43:28 -0400] HTTP/1.1 80 /api/v1/companies 200 - 5.409</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Enabling JBoss access logs">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec499" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">An access log stores all the<a id="id1103" class="calibre1"/> user requests for individual resources. These include requests to fetch HTML files, JavaScript files, CSS files, REST calls, and so on. The data stored in this file can then be analyzed by another application to get meaningful information out of it. An access log can help you with following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">It can help to calculate the number of unique visitors to your website.</li><li class="listitem">It can help to calculate the number of successful and failed requests. The requests with the <code class="email">2XX</code> code are considered successful, and the requests with <code class="email">4xx</code> and <code class="email">5xx</code> are considered errors.</li><li class="listitem">It can help basic performance analysis. Each access log line contains the time taken to process the request.</li><li class="listitem">It can help to analyze your web application usage pattern in terms of the time of the day, the day of the week, and so on.</li></ul></div><p class="calibre6">In the preceding steps, you updated the <code class="email">urn:jboss:domain:web:1.5</code> subsystem configuration to enable the access logs. Adding the following two lines to the configuration enables the access logs:</p><div class="informalexample"><pre class="programlisting">&lt;access-log pattern="%a %t %H %p %U %s %S %T" rotate="true"&gt;
&lt;directory path="app-root/logs/" relative-to="user.home" /&gt;</pre></div><p class="calibre6">The <code class="email">access-log</code> element<a id="id1104" class="calibre1"/> enables the access logs, and the <code class="email">directory</code> element is used to specify the directory that should be used to generate the logs. The preceding <code class="email">directory</code> element configures JBoss to write the access logs to <code class="email">$OPENSHIFT_LOG_DIR</code> as it looks for the <code class="email">app-root/logs</code> directory relative to the user home. The <code class="email">app-root/logs</code> directory relative to the user home is <code class="email">$OPENSHIFT_LOG_DIR</code>. We have used this value so that the <code class="email">rhc tail</code> command can read this file along with other JBoss logs. The <code class="email">access-log</code> element takes one mandatory attribute called <code class="email">pattern</code>. The <code class="email">pattern</code> element defines the logs format. The following pattern codes are supported:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">%a</code>: Remote <a id="id1105" class="calibre1"/>IP address</li><li class="listitem"><code class="email">%A</code>: Local <a id="id1106" class="calibre1"/>IP address</li><li class="listitem"><code class="email">%b</code>: Bytes <a id="id1107" class="calibre1"/>sent, excluding HTTP headers, or <code class="email">-</code> if zero</li><li class="listitem"><code class="email">%B</code>: Bytes <a id="id1108" class="calibre1"/>sent, excluding HTTP headers</li><li class="listitem"><code class="email">%h</code>: Remote<a id="id1109" class="calibre1"/> hostname (or IP address if <code class="email">resolveHosts</code> is <code class="email">false</code>)</li><li class="listitem"><code class="email">%H</code>: Request <a id="id1110" class="calibre1"/>protocol</li><li class="listitem"><code class="email">%l</code>: Remote <a id="id1111" class="calibre1"/>logical username from <code class="email">identd</code> (always returns <code class="email">-</code>)</li><li class="listitem"><code class="email">%m</code>: Request <a id="id1112" class="calibre1"/>method (GET, POST, and so on)</li><li class="listitem"><code class="email">%p</code>: Local <a id="id1113" class="calibre1"/>port on which this request was received</li><li class="listitem"><code class="email">%q</code>: Query <a id="id1114" class="calibre1"/>string (prepended with a <code class="email">?</code> if it exists)</li><li class="listitem"><code class="email">%r</code>: First line<a id="id1115" class="calibre1"/> of the request (method and request URI)</li><li class="listitem"><code class="email">%s</code>: HTTP<a id="id1116" class="calibre1"/> status code of the response</li><li class="listitem"><code class="email">%S</code>: User<a id="id1117" class="calibre1"/> session ID</li><li class="listitem"><code class="email">%t</code>: Date <a id="id1118" class="calibre1"/>and time in Common Log Format</li><li class="listitem"><code class="email">%u</code>: Remote <a id="id1119" class="calibre1"/>user that was authenticated (if any), else <code class="email">-</code></li><li class="listitem"><code class="email">%U</code>: Requested <a id="id1120" class="calibre1"/>URL path</li><li class="listitem"><code class="email">%v</code>: Local <a id="id1121" class="calibre1"/>server <a id="id1122" class="calibre1"/>name</li><li class="listitem"><code class="email">%D</code>: Time<a id="id1123" class="calibre1"/> taken to process the request in milliseconds</li><li class="listitem"><code class="email">%T</code>: Time taken <a id="id1124" class="calibre1"/>to process the request in seconds</li><li class="listitem"><code class="email">%I</code>: Current request <a id="id1125" class="calibre1"/>thread name (can compare later with stacktraces)</li></ul></div></div></div>

<div class="book" title="Enabling JBoss access logs">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec500" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Working with JBoss application logs</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Working with Tomcat application logs"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec129" class="calibre1"/>Working with Tomcat application logs</h1></div></div></div><p class="calibre6">In this recipe, you will learn how to <a id="id1126" class="calibre1"/>work with logs in Tomcat cartridges. You will start with tailing the logs of an existing Tomcat application, and then you will learn how to add application-specific logging using the <code class="email">SLF4J</code> library.</p></div>

<div class="book" title="Working with Tomcat application logs">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec501" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe will use the application created in the <span class="strong"><em class="calibre10">Creating and Deploying Spring Applications using the Tomcat 7 cartridge</em></span> recipe in <a class="calibre1" title="Chapter 7. OpenShift for Java Developers" href="part0089_split_000.html#page">Chapter 7</a>, <span class="strong"><em class="calibre10">OpenShift for Java Developers</em></span>. You can recreate the application using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstore tomcat-7 mysql-5.5 --from-code https://github.com/OpenShift-Cookbook/chapter7-jobstore-spring.git --timeout 180</strong></span>
</pre></div></div></div>

<div class="book" title="Working with Tomcat application logs">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec502" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">You can view the logs of a Tomcat application using the <code class="email">rhc tail</code> command. Tomcat logs are written to a file named <code class="email">jbossews.log</code> inside the <code class="email">$OPENSHIFT_LOG_DIR</code> directory:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --files */log*/jbossews.log --app jobstore</strong></span>
</pre></div></li><li class="listitem" value="2">The <code class="email">jbossews.log</code> file will contain logs of both Tomcat-specific and application-specific logs, as shown in the following output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">INFO: Starting ProtocolHandler ["http-bio-127.5.249.129-8080"]</strong></span>
<span class="strong"><strong class="calibre7">Jun 29, 2014 5:03:01 AM org.apache.catalina.startup.Catalina start</strong></span>
<span class="strong"><strong class="calibre7">INFO: Server startup in 22062 ms</strong></span>
</pre></div></li><li class="listitem" value="3">Before you can add application-specific logging, you will have to add the following dependencies to your Maven <code class="email">pom.xml</code> file. In this recipe, you will use <code class="email">SLF4J</code> along with <code class="email">logback</code> binding to add application logging:<div class="informalexample"><pre class="programlisting">&lt;dependency&gt;
  &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
  &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
  &lt;version&gt;1.7.7&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
  &lt;version&gt;1.0.13&lt;/version&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem" value="4">Open the <code class="email">CompanyResource.java</code> file inside the <code class="email">org.osbook.jobstore.rest</code> package in an editor, and add a couple of statements to import the <code class="email">SLF4J</code> classes, as shown in the following code:<div class="informalexample"><pre class="programlisting">import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</pre></div></li><li class="listitem" value="5">Now, update the <code class="email">CompanyResource</code> Java class under the <code class="email">org.jobstore.rest</code> package to add application-specific logging, as follows:<div class="informalexample"><pre class="programlisting">private Logger logger = LoggerFactory.getLogger(CompanyResource.class);

@RequestMapping(method = RequestMethod.POST, consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)
public ResponseEntity&lt;Company&gt; createNewCompany(@RequestBody Company company) {
  logger.debug("inside createNewCompany().. creating new company {}" , company);
  Company existingCompany = companyRepository.findByName(company.getName());
  if(existingCompany != null){
    logger.debug("Company with name {} already exists : {}" , company.getName(), existingCompany);
    return new ResponseEntity&lt;&gt;(HttpStatus.NOT_ACCEPTABLE);
  }
  company = companyRepository.save(company);
  logger.info("Created new company {}" , company);
  return new ResponseEntity&lt;&gt;(company,HttpStatus.CREATED);
}
  
@RequestMapping(method=RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
public @ResponseBody List&lt;Company&gt; showAll(){
  List&lt;Company&gt; companies = companyRepository.findAll();
  logger.info("Found {} companies" , companies.size());
  return companies;
}</pre></div></li><li class="listitem" value="6">Commit the<a id="id1127" class="calibre1"/> changes to the local Git repository, and then push them to the application gear using the <code class="email">git push</code> command.</li><li class="listitem" value="7">After the application restarts, you will start seeing various log messages. A short snippet is shown in the following output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">05:43:00.182 [http-bio-127.5.249.129-8080-exec-6] INFO  org.jobstore.rest.CompanyResource - Created new company Company [id=1, name=Red Hat, description=open source company, contactEmail=contact@redhat.com]</strong></span>
<span class="strong"><strong class="calibre7">05:43:00.245 [http-bio-127.5.249.129-8080-exec-6] DEBUG o.s.w.s.m.m.a.HttpEntityMethodProcessor - Written [Company [id=1, name=Red Hat, description=open source company, contactEmail=contact@redhat.com]] as "application/json" using [org.springframework.http.converter.json.MappingJackson2HttpMessageConverter@1d300d2]</strong></span>
</pre></div></li><li class="listitem" value="8">You can use the <code class="email">logback</code> configuration file to enable the logging of specific packages. Create a new file with the name <code class="email">logback.xml</code> inside the <code class="email">src/main/resources</code> directory, and add the following contents to it:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
       &lt;appender name="console" class="ch.qos.logback.core.ConsoleAppender"&gt;
		&lt;encoder&gt;
			&lt;pattern&gt;%d %5p %C:%4L - %m%n&lt;/pattern&gt;
		&lt;/encoder&gt;
	&lt;/appender&gt;
	&lt;logger name="org.jobstore" level="debug" /&gt;
	&lt;root level="WARN"&gt;
		&lt;appender-ref ref="console" /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;</pre></div></li><li class="listitem" value="9">Commit the changes to the<a id="id1128" class="calibre1"/> local Git repository, and push them to the application gear using the <code class="email">git push</code> command. After the app restarts, you will only see the application-specific <code class="email">DEBUG</code> and preceding messages. Have a look at the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">INFO: Server startup in 49113 ms</strong></span>
<span class="strong"><strong class="calibre7">2014-06-29 06:07:27,817  INFO org.jobstore.rest.CompanyResource:  45 - Found 1 companies</strong></span>
<span class="strong"><strong class="calibre7">2014-06-29 06:07:38,513 DEBUG org.jobstore.rest.CompanyResource:  31 - inside createNewCompany().. creating new company Company [id=null, name=test, description=test, contactEmail=test@test.com]</strong></span>
<span class="strong"><strong class="calibre7">2014-06-29 06:07:38,752  INFO org.jobstore.rest.CompanyResource:  38 - Created new company Company [id=2, name=test, description=test, contactEmail=test@test.com]</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Working with Tomcat application logs">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec503" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In the preceding steps, you learned how to view the logs of a Tomcat application and add application-specific logging using the <code class="email">SLF4J</code> library. In step 1, you ran the <code class="email">rhc tail</code> command to view all the Tomcat-specific logs. All the Tomcat-specific logs are written to the <code class="email">jbossews.log</code> file. As discussed in the <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe, <code class="email">logshifter</code> will collect all the logs written to <code class="email">stdout</code> or <code class="email">stderr</code> and write them to the cartridge-specific logfile.</p><p class="calibre6">From step 2 through step 5, you added log statements to the <code class="email">CompanyResource.java</code> file using the <code class="email">SLF4J</code> library. The <code class="email">SLF4J</code> library underneath uses the <code class="email">Logback</code> library that has a default log level of <code class="email">DEBUG</code>. This means if you don't specify any <code class="email">Logback</code> configuration, then all the <code class="email">DEBUG</code> and preceding messages will be logged to <code class="email">jbossews.log</code>.</p><p class="calibre6">
<code class="email">Logback</code> can be configured<a id="id1129" class="calibre1"/> using the <code class="email">logback.xml</code> file. In step 6, you created a <code class="email">logback.xml</code> file and added configuration to only the log application <code class="email">DEBUG</code> messages. All other messages will be logged at <code class="email">WARN</code> level. Then, finally, in step 7, you committed the changes and pushed them to the application gear.</p></div></div>

<div class="book" title="Working with Tomcat application logs">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec504" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">You can enable the access logs for the Tomcat cartridge<a id="id1130" class="calibre1"/> by performing<a id="id1131" class="calibre1"/> the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open the Tomcat <code class="email">server.xml</code> configuration file inside the <code class="email">.openshift/config</code> directory in your favorite editor.</li><li class="listitem" value="2">Add the <code class="email">AccessLogValve</code> configuration to the <code class="email">server.xml</code> file's <code class="email">Host</code> element:<div class="informalexample"><pre class="programlisting">&lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="${user.home}/app-root/logs" prefix="localhost_access_log." suffix=".txt" pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b"/&gt;</pre></div></li><li class="listitem" value="3">Commit the changes to the local Git repository, and push them to the application gear using the <code class="email">git push</code> command.</li><li class="listitem" value="4">Run the <code class="email">rhc tail</code> command again, and this time, you will see the access logs, as well:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">==&gt; app-root/logs/localhost_access_log.2014-06-29.txt &lt;==</strong></span>
<span class="strong"><strong class="calibre7">127.5.249.129 - - [29/Jun/2014:07:18:57 -0400] "POST /api/v1/companies HTTP/1.1" 201 133</strong></span>
<span class="strong"><strong class="calibre7">127.5.249.129 - - [29/Jun/2014:07:18:58 -0400] "GET /api/v1/companies HTTP/1.1" 200 344</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Working with Tomcat application logs">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch11lvl2sec505" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Working with JBoss application logs</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling JBoss access logs</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Working with Python application logs"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec130" class="calibre1"/>Working with Python application logs</h1></div></div></div><p class="calibre6">In this recipe, you will learn<a id="id1132" class="calibre1"/> how to add view and logging to your Python applications. As discussed in <a class="calibre1" title="Chapter 8. OpenShift for Python Developers" href="part0105_split_000.html#page">Chapter 8</a>, <span class="strong"><em class="calibre10">OpenShift for Python Developers</em></span>, OpenShift Python applications use Apache with <code class="email">mod_wsgi</code>.</p></div>

<div class="book" title="Working with Python application logs">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec506" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe will use the application created in the <span class="strong"><em class="calibre10">Creating and deploying Flask web applications using Python and PostgreSQL cartridges</em></span> recipe in <a class="calibre1" title="Chapter 8. OpenShift for Python Developers" href="part0105_split_000.html#page">Chapter 8</a>, <span class="strong"><em class="calibre10">OpenShift for Python Developers</em></span>. You can recreate the application using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstore python-2.7 postgresql-9.2 --from-code https://github.com/OpenShift-Cookbook/chapter8-jobstore-python-flask.git</strong></span>
</pre></div></div></div>

<div class="book" title="Working with Python application logs">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec507" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a new command-line terminal, and navigate to the directory where you have created the Python application.</li><li class="listitem" value="2">To view the logs of a Python application, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --files */log*/python.log</strong></span>
</pre></div></li><li class="listitem" value="3">By visiting the application URL, you will see the following logs in the <code class="email">rhc tail</code> command output when you make a request to the application:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">117.207.184.93 - - [29/Jun/2014:14:50:09 -0400] "GET /api/v1/companies HTTP/1.1" 200 17 "http://jobstore-osbook.rhcloud.com/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.153 Safari/537.36"</strong></span>
</pre></div></li><li class="listitem" value="4">Open the <code class="email">jobstore.py</code> file inside the application directory, and add the following lines just above the <code class="email">index()</code> function. The following lines import the <code class="email">logging</code> module and then create a new <code class="email">logger</code> object with the <code class="email">INFO</code> log level. This logger will be used in the next step for logging.<div class="informalexample"><pre class="programlisting">import logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)</pre></div></li><li class="listitem" value="5">Next, update the <code class="email">index()</code> function with a log statement, as shown in the following code:<div class="informalexample"><pre class="programlisting">@app.route('/')
def index():
logger.info('inside index()...')
return render_template('index.html')</pre></div></li><li class="listitem" value="6">Commit the change to the local Git repository, and then push the changes to the application gear. After the app has started successfully, visit the application URL  and you will see the log message you added to <code class="email">jobstore.py</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">[Sun Jun 29 14:56:08 2014] [error] INFO:jobstore:inside index()...</strong></span>
</pre></div></li><li class="listitem" value="7">There are <a id="id1133" class="calibre1"/>times when you will prefer to use a different file to store your application logs. This can be done using <code class="email">TimedRotatingFileHandler</code>. Open <code class="email">jobstore.py</code> in the application root directory and replace the logging lines added in step 3 with the ones shown in the following code:<div class="informalexample"><pre class="programlisting">import logging
import logging.handlers
logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
log_location = os.environ.get('OPENSHIFT_LOG_DIR') if os.environ.get('OPENSHIFT_LOG_DIR') else '/tmp/'
log_filename = log_location + 'jobstore.log'
handler = logging.handlers.TimedRotatingFileHandler(log_filename,when='midnight',backupCount=5)
handler.setFormatter(formatter)
logger.addHandler(handler)</pre></div></li><li class="listitem" value="8">Commit the change, and push the changes to the application gear. After the app restarts, you will see a new file, <code class="email">jobstore.log</code>, with all the application-specific logs, as shown in the following command lines. You will have to run the <code class="email">rhc tail</code> command so that the <code class="email">tail</code> command can find the new file, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">==&gt; app-root/logs/jobstore.log &lt;==</strong></span>
<span class="strong"><strong class="calibre7">2014-06-29 15:25:34,158 - jobstore - INFO - inside index()...</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Working with Python application logs">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec508" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">Python application <a id="id1134" class="calibre1"/>logs are logged in the <code class="email">python.log</code> file inside <code class="email">$OPENSHIFT_LOG_DIR</code>. This file will contain both Apache access logs and error logs, as well as any application-specific logs. The log follows Apache Combined Log Format discussed in the <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe.</p><p class="calibre6">To add application-level logging, you used the Python standard logging module in step 3. After pushing these changes to the application gear, you will start seeing your application-specific log messages. You will only see the log messages with the level <code class="email">INFO</code> or above. This is because you have configured the default logging level to <code class="email">logging.INFO</code>.</p><p class="calibre6">OpenShift, by default, will log all the messages written to <code class="email">stdout</code> or <code class="email">stderr</code> to the <code class="email">python.log</code> file. If you want to use a different logfile for application-specific logs, then you can use <code class="email">TimedRotaingFileHandler</code> to log messages to the <code class="email">jobstore.log</code> file inside <code class="email">$OPENSHIFT_LOG_DIR</code>, as shown in step 5. In step 6, you pushed the changes to the OpenShift application gear, and after running the <code class="email">rhc tail</code> command again, you will start seeing messages written to <code class="email">jobstore.log</code> in the output.</p></div></div>

<div class="book" title="Working with Python application logs">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec509" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Viewing application logs</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating scalable applications"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec131" class="calibre1"/>Creating scalable applications</h1></div></div></div><p class="calibre6">As your application <a id="id1135" class="calibre1"/>becomes popular and more users start using it, you will have to scale your application to meet the increased usage. Application scaling can be done in either of the following two ways: vertical scaling (or scaling up) and horizontal scaling (scaling out). Vertical scaling is about adding more power to a single machine, that is, faster CPU, more RAM and SSD, and so on. Vertical scalability has a limit and the cost increases exponentially. Horizontal scaling, on the other hand, is about handling more requests and load by adding more machines.</p><p class="calibre6">With most PaaS solutions such as OpenShift, you will soon hit the vertical scaling limit. Currently, in OpenShift, you can't get a bigger gear size than 2 GB of RAM space (that is, large gear), so it is recommended that you design your application for horizontal scalability. There are many good books, such as <span class="strong"><em class="calibre10">Scalability Rules</em></span>, <span class="strong"><em class="calibre10">Martin L. Abbott and Michael T. Fisher</em></span>, <span class="strong"><em class="calibre10">Addison-Wesley Professional</em></span>, written on this subject, and you can refer to them for more information. I have also written an article on best practices to create scalable web applications<a id="id1136" class="calibre1"/> (<a class="calibre1" href="https://www.openshift.com/blogs/best-practices-for-horizontal-application-scaling">https://www.openshift.com/blogs/best-practices-for-horizontal-application-scaling</a>) that you can refer to, as well.</p><p class="calibre6">In this recipe, you will learn how to create scalable applications in OpenShift.</p></div>

<div class="book" title="Creating scalable applications">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec510" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need <code class="email">rhc</code> installed on your machine. This recipe will require all three available gears, so please make sure to delete any existing applications.</p></div></div>

<div class="book" title="Creating scalable applications">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec511" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">To create a scalable application, perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal and change the directory to a convenient location where you want to create the application.</li><li class="listitem" value="2">Next, execute the following command to create the scalable application:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstore jbosseap postgresql-9 --scaling --from-code https://github.com/OpenShift-Cookbook/chapter7-jobstore-javaee6.git</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Creating scalable applications">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec512" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">The <code class="email">rhc create-app</code> command<a id="id1137" class="calibre1"/> used in the preceding steps instructs OpenShift to create an application named <code class="email">jobstore</code> with the JBoss EAP and PostgreSQL 9.2 cartridges. The <code class="email">--scaling</code> option tells OpenShift to create a horizontally scalable application instead of a nonscalable application. The <code class="email">--from-code</code> option tells OpenShift to use the specified Git repository as the reference application. You can also use <code class="email">-s</code> instead of <code class="email">--scaling</code>. The <code class="email">-s</code> option is a shorthand notation of the <code class="email">--scaling</code> option.</p><p class="calibre6">This command will create two OpenShift gears. The HAProxy load balancer and JBoss EAP application server will share the first gear, and the PostgreSQL database will use the second gear. The gear that has the HAProxy cartridge installed is called the <code class="email">main</code> gear. All the commands that work against a gear will apply to this gear. For example, when you run the <code class="email">rhc ssh</code> command, you will be logged in to the HAProxy gear. Similarly, the <code class="email">rhc tail</code> command will tail the logs in the <code class="email">app-root/logs</code> directory of this gear.</p><p class="calibre6">HAProxy<a id="id1138" class="calibre1"/> is a <a id="id1139" class="calibre1"/>software-based load balancer that sits in front of your web application and accepts all the incoming requests. It then parses the HTTP request and, depending on its configuration, will route the incoming request to a backend. The backend here means one or more JBoss EAP instances. OpenShift helps you scale your application by adding new application instances (in our example, JBoss EAP instances) as the number of concurrent HTTP connections reaches a threshold. The current threshold is 16 concurrent HTTP connections. This behavior is called autoscaling, as OpenShift manages the application scaling without any user intervention. You can also configure your application to use manual scaling, which will give you more control over application scaling. This will be covered in the <span class="strong"><em class="calibre10">Enable manual scaling with marker files</em></span> recipe.</p><p class="calibre6">OpenShift currently does not support database scaling. You can use services such as Amazon RDS (covered in the <span class="strong"><em class="calibre10">Using an Amazon RDS MySQL DB instance with OpenShift</em></span> recipe in <a class="calibre1" title="Chapter 4. Using MySQL with OpenShift Applications" href="part0061_split_000.html#page">Chapter 4</a>, <span class="strong"><em class="calibre10">Using MySQL with OpenShift Applications</em></span>), Enterprise DB PostgreSQL Cloud Database (covered in the <span class="strong"><em class="calibre10">Using EnterpriseDB PostgreSQL cloud database with OpenShift</em></span> recipe in <a class="calibre1" title="Chapter 5. Using PostgreSQL with OpenShift Applications" href="part0070_split_000.html#page">Chapter 5</a>, <span class="strong"><em class="calibre10">Using PostgreSQL with OpenShift Applications</em></span>), or MongoLab (covered in the <span class="strong"><em class="calibre10">Using MongoLab MongoDB-as-a-Service with OpenShift</em></span> recipe in <a class="calibre1" title="Chapter 6. Using MongoDB and Third-party Database Cartridges with OpenShift Applications" href="part0079_split_000.html#page">Chapter 6</a>, <span class="strong"><em class="calibre10">Using MongoDB and Third-party Database Cartridges with OpenShift Applications</em></span>) to get database scaling.</p><p class="calibre6">Every OpenShift scalable application has a daemon running called <code class="email">haproxy_ctld</code>. This daemon controls the autoscaling behavior by polling the HAProxy Unix socket status port every five seconds to collect the basic HAProxy statistics. By default, it is configured to use the HTTP concurrent connection of autoscaling, but users can customize it to autoscale applications<a id="id1140" class="calibre1"/> based on other factors such as CPU usage, as well (<a class="calibre1" href="https://www.openshift.com/blogs/customizing-autoscale-functionality-in-openshift">https://www.openshift.com/blogs/customizing-autoscale-functionality-in-openshift</a>). </p><p class="calibre6">The daemon checks the current concurrent HTTP connections, and if the number of concurrent connections is more than 90 percent of the allocated, that is, 16, then it fires the scale-up event. When a scale-up event happens, the daemon will make an HTTP request to the OpenShift broker to add a new gear to the application. The broker will spin up a new gear with the same configuration as the existing application gear, attach the new gear with HAProxy, use the <code class="email">rsync</code> command to copy the contents of the <code class="email">~/app-root/repo</code> directory on the main gear to the new gear, and finally start the new gear. From now on, HAProxy will start sending requests to both the gears based on the configured algorithm. By default, OpenShift uses sticky sessions along with the least connection balance algorithm to make sure that the request from a user ends up on the same gear always, and the server with the least connection gets the request from the new client. Users can override the default HAProxy configuration according to their needs. We will cover that later in this chapter.</p><p class="calibre6">Applications will scale <a id="id1141" class="calibre1"/>down when your application web traffic falls below 50 percent of the allocated HTTP connections for several minutes. Then, the new gear will be removed, and it will also be removed from the HAProxy configuration.</p><p class="calibre6">An OpenShift application developer can see the HAProxy stats on the HAProxy status page. This page is located at <code class="email">http://jobstore-{domain-name}.rhcloud.com/haproxy-status</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00148.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">The HAProxy status page is divided into two sections: <span class="strong"><strong class="calibre7">stats</strong></span> and <span class="strong"><strong class="calibre7">express</strong></span>. The <span class="strong"><strong class="calibre7">stats</strong></span> section is configured to listen to all the requests made to the HAProxy status page. Every time you refresh the <code class="email">http://jobstore-domainname.rhcloud.com/haproxy-status page</code> page, the total number of sessions under the <span class="strong"><strong class="calibre7">Sessions</strong></span> tab will increment. This is shown under the <span class="strong"><strong class="calibre7">Total</strong></span> column. The <span class="strong"><strong class="calibre7">Cur</strong></span> column is the number of users currently accessing the status page. The <span class="strong"><strong class="calibre7">Max</strong></span> column is the maximum number of concurrent users. All these numbers are calculated since HAProxy was started; if you restart HAProxy, the stats will reset.</p><p class="calibre6">The <span class="strong"><strong class="calibre7">express</strong></span> section is more interesting from the application point of view. The <span class="strong"><strong class="calibre7">local-gear</strong></span> row corresponds to the requests handled by JBoss EAP. The total number of sessions handled by the application is shown in the <span class="strong"><strong class="calibre7">Total</strong></span> column. The <span class="strong"><strong class="calibre7">Cur</strong></span> column is the number of users currently accessing the application. The <span class="strong"><strong class="calibre7">Max</strong></span> column is the maximum number of concurrent users. All these figures pertain to the time period since HAProxy was started; if you restart HAProxy, the stats will reset. In the preceding screenshot, we can see that <span class="strong"><strong class="calibre7">local-gear</strong></span> has handled seven requests, one at a time. When the application scales, it will <a id="id1142" class="calibre1"/>add more rows for the new gears.</p></div></div>

<div class="book" title="Creating scalable applications">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec513" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">You can define the minimum and maximum values for<a id="id1143" class="calibre1"/> application scaling. By default, a scalable application will consume at least one gear and, at peak traffic, can consume all the gears in your OpenShift account. You can set the minimum and maximum values using the <code class="email">rhc scale-cartridge</code> command,<a id="id1144" class="calibre1"/> as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc scale-cartridge &lt;web cartridge&gt; --app &lt;app_name&gt; --min &lt;minimum gears&gt; --max &lt;maximum gear&gt;</strong></span>
</pre></div><p class="calibre6">Let's take the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc scale-cartridge jbosseap --app jobstore --min 2 --max 4</strong></span>
</pre></div><p class="calibre6">The preceding command will make sure that the <code class="email">jobstore</code> application will at least have two instances of the JBoss EAP cartridge, and at maximum, four instances.</p></div></div>

<div class="book" title="Creating scalable applications">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch11lvl2sec514" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Configuring a different health check URL for HAProxy</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Configuring HAProxy to use a different balance algorithm</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling manual scaling with marker files</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring a different health check URL for HAProxy"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec132" class="calibre1"/>Configuring a different health check URL for HAProxy</h1></div></div></div><p class="calibre6">In this recipe, you will learn how to update the <a id="id1145" class="calibre1"/>HAProxy configuration file to<a id="id1146" class="calibre1"/> configure a different heath check URL.</p></div>

<div class="book" title="Configuring a different health check URL for HAProxy">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec515" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need <code class="email">rhc</code> installed on your machine. This recipe will utilize the application created in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe.</p></div></div>

<div class="book" title="Configuring a different health check URL for HAProxy">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec516" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal and navigate to the application directory created in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe.</li><li class="listitem" value="2">SSH into the main application gear using the <code class="email">rhc ssh</code> command, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app jobstore</strong></span>
</pre></div></li><li class="listitem" value="3">Change the directory to the <code class="email">haproxy</code> configuration directory, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ cd haproxy/conf</strong></span>
</pre></div></li><li class="listitem" value="4">Now, open the <code class="email">haproxy.cfg</code> file using VIM, and remove the following content:<div class="informalexample"><pre class="programlisting">option httpchk GET /</pre></div><p class="calibre14">In its place, insert the following content:</p><div class="informalexample"><pre class="programlisting">option httpchk GET /api/v1/ping</pre></div></li><li class="listitem" value="5">Finally, restart the HAProxy cartridge from your local machine using the <code class="email">rhc</code> command-line client:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc restart-cartridge --cartridge haproxy --app jobstore</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Configuring a different health check URL for HAProxy">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec517" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">HAProxy <a id="id1147" class="calibre1"/>performs periodic health checks to determine<a id="id1148" class="calibre1"/> the health of the application gears. The default configuration pings the root URL <code class="email">/</code> every two seconds. If HAProxy receives an HTTP code other than <code class="email">2xx</code> or <code class="email">3xx</code>, then it considers it a server failure, and your application will give a <code class="email">Service Unavailable</code> error. One scenario where you will see this behavior is when you use OpenShift to host your REST backend at a nonroot URL, such as <code class="email">/api/v1/</code>. In the preceding steps, you updated the <code class="email">haproxy.cfg</code> file to use a different health check URL.</p></div></div>

<div class="book" title="Configuring a different health check URL for HAProxy">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec518" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Configuring HAProxy to use a different balance algorithm</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling manual scaling with marker files</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring HAProxy to use a different balance algorithm"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec133" class="calibre1"/>Configuring HAProxy to use a different balance algorithm</h1></div></div></div><p class="calibre6">The HAProxy load balancer can work with several load-balancing algorithms. The configuration used by HAProxy in OpenShift applications uses the<a id="id1149" class="calibre1"/> <span class="strong"><strong class="calibre7">leastconn</strong></span> load-balancing algorithm. This algorithm is useful when you have long-lived connections, but is not recommended for short connections. For short connections, as in the case of our application, it is more suitable to use the <a id="id1150" class="calibre1"/>
<span class="strong"><strong class="calibre7">roundrobin</strong></span> algorithm.</p><p class="calibre6">In this recipe, you will learn how to configure HAProxy to use the <span class="strong"><strong class="calibre7">roundrobin balance</strong></span> algorithm<a id="id1151" class="calibre1"/> instead of the leastconn algorithm.</p></div>

<div class="book" title="Configuring HAProxy to use a different balance algorithm">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec519" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will <a id="id1152" class="calibre1"/>need <code class="email">rhc</code> installed on <a id="id1153" class="calibre1"/>your machine. This recipe will utilize the application created in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe.</p></div></div>

<div class="book" title="Configuring HAProxy to use a different balance algorithm">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec520" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to configure HAProxy to use the roundrobin balance algorithm:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal and navigate to the application directory created in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe.</li><li class="listitem" value="2">Scale the JBoss EAP cartridge to use two JBoss EAP instances by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc scale-cartridge --min 2 --cartridge jbosseap-6</strong></span>
</pre></div></li><li class="listitem" value="3">SSH into the main application gear using the <code class="email">rhc ssh</code> command, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app jobstore</strong></span>
</pre></div></li><li class="listitem" value="4">Once you are inside the application gear, change the directory to the <code class="email">haproxy/conf</code> directory, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ cd haproxy/conf</strong></span>
</pre></div></li><li class="listitem" value="5">It is always a good idea to make a backup of the configuration files before making any changes to them. Use the <code class="email">copy</code> command to create a copy of the <code class="email">haproxy.cfg</code> file in <code class="email">$OPENSHIFT_DATA_DIR</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ cp haproxy.cfg $OPENSHIFT_DATA_DIR</strong></span>
</pre></div></li><li class="listitem" value="6">Now, open the <code class="email">haproxy.cfg</code> file using VIM, and update the section under <code class="email">balance leastconn</code> to the following code:<div class="informalexample"><pre class="programlisting">balance roundrobin
    server gear-2 host2:port2 check fall 2 rise 3 inter 2000 weight 1
    server local-gear host1:port1 check fall 2 rise 3 inter 2000 weight 1</pre></div></li><li class="listitem" value="7">Replace <code class="email">gear-2</code> with your application's second gear name. Also, replace <code class="email">host1</code> and <code class="email">host2</code> and <code class="email">port1</code> and <code class="email">port2</code> with the gear 1 and gear 2 host and port values. You can get the values from the copy of <code class="email">haproxy.cfg</code> saved in step 5.</li><li class="listitem" value="8">You can ask HAProxy to reload the configuration by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc reload-cartridge --cartridge haproxy</strong></span>
</pre></div></li><li class="listitem" value="9">Run Apache Benchmark to see the new configuration in action, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ ab -n 1000 -c 20 http://jobstore-{domain-name}.rhcloud.com/api/v1/companies</strong></span>
</pre></div></li><li class="listitem" value="10">In the <a id="id1154" class="calibre1"/>preceding <a id="id1155" class="calibre1"/>test, <code class="email">ab</code> will make a total of <code class="email">1000</code> requests with <code class="email">20</code> concurrent requests at a time. As we are using the roundrobin algorithm, both the gears should handle 500 requests each. You can verify the number of requests by looking at the following HAProxy status page (screenshot):<div class="mediaobject"><img src="../images/00149.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Configuring HAProxy to use a different balance algorithm">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec521" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">HAProxy supports various load-balance algorithms. The algorithm you choose will determine which backend server will be used to serve the request. The default load-balance algorithm used by OpenShift's scalable applications is leastconn. This algorithm selects the server with the least number of active connections. HAProxy is also configured to use persistent cookies to achieve sticky session behavior. Session stickiness ensures that a user request is served from the same gear that served their first request.</p><p class="calibre6">In the preceding steps, you overrode the default configuration to use the roundrobin algorithm. The algorithm to use can be set using the <code class="email">balance</code> parameter. The roundrobin algorithm selects servers in turn to make sure requests are balanced fairly. You can assign weights to the servers to manipulate how frequently a server is selected compared to others. In step 6, you used <code class="email">roundrobin</code> as the value of the balance parameter and assigned a weight of <code class="email">1</code> to both the servers. Because we gave both servers the same weight, both will serve an equal number of requests. Then, you asked HAProxy to reload the configuration using the <code class="email">rhc reload-cartridge</code> command in step 7.</p><p class="calibre6">In step 8, you ran a load test on the application using Apache Benchmark, to see if your changes were working as expected. Because both servers had a weight of <code class="email">1</code>, they both handled 500 requests each.</p><p class="calibre6">Now, let's update the HAProxy configuration to use different weights for different servers. Update the <code class="email">haproxy.cfg</code> roundrobin section with the following code:</p><div class="informalexample"><pre class="programlisting">balance roundrobin
    server gear-2 host2:port2 check fall 2 rise 3 inter 2000 weight 1
    server local-gear host1:port1 check fall 2 rise 3 inter 2000 weight 2  </pre></div><p class="calibre6">Again, reload the <a id="id1156" class="calibre1"/>configuration by<a id="id1157" class="calibre1"/> <a id="id1158" class="calibre1"/>running the <code class="email">rhc reload-cartridge</code> command, and then run the Apache Benchmark test performed in step 8. Because <code class="email">gear-2</code> has a weight of <code class="email">1</code> and <code class="email">gear-1</code> has a weight of <code class="email">2</code>, gear 1 will serve twice as many requests as gear 2. You can verify that by looking at the following HAProxy status page (screenshot):</p><div class="mediaobject"><img src="../images/00150.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre9"> </p></div></div>

<div class="book" title="Configuring HAProxy to use a different balance algorithm">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec522" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Configuring a different health check URL for HAProxy</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling manual scaling with marker files</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating scalable apps from nonscalable apps"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec134" class="calibre1"/>Creating scalable apps from nonscalable apps</h1></div></div></div><p class="calibre6">OpenShift currently does not <a id="id1159" class="calibre1"/>support the conversion of an <a id="id1160" class="calibre1"/>existing nonscalable application to a scalable application. In this recipe, you will learn how to create a new scalable application using an existing nonscalable application.</p></div>

<div class="book" title="Creating scalable apps from nonscalable apps">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec523" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need <code class="email">rhc</code> installed on your machine. This recipe will require all three available gears, so please make sure to delete any existing applications.</p></div></div>

<div class="book" title="Creating scalable apps from nonscalable apps">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec524" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to covert a nonscalable application to a scalable application:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a new command-line terminal and navigate to a convenient location where you want to create the application.</li><li class="listitem" value="2">Create a nonscalable application with JBoss EAP 6 using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstore jbosseap postgresql-9.2 --from-code https://github.com/OpenShift-Cookbook/chapter7-jobstore-javaee6.git</strong></span>
</pre></div></li><li class="listitem" value="3">To create a scalable application using the application created in step 2, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstorescalable --from-app jobstore --scaling</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Creating scalable apps from nonscalable apps">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec525" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">Using another application as a template, you can create a new application using the <code class="email">--from-app</code> option. When you specify the <code class="email">--from-app</code> option, OpenShift will use the template application configuration to create the new application. The configuration includes existing cartridges, storage configuration, gear sizes, scaling configuration, deployment configuration, and so on.</p><p class="calibre6">In the preceding steps, you created a scalable application from a nonscalable application. Because you want to create a scalable application, you have to provide the <code class="email">--scaling</code> option; otherwise, a nonscalable application will be created. You can also specify different gear sizes using the <code class="email">--gear-size</code> option:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstorescalable --from-app jobstore –-scaling --gear-size large</strong></span>
</pre></div><p class="calibre6">Apart from <code class="email">--scaling</code> and <code class="email">--gear-size</code>, you can also provide the <code class="email">--env</code>, <code class="email">--no-git</code>, and <code class="email">--enable-jenkins</code> options.</p><p class="calibre6">The <code class="email">--from-app</code> option makes<a id="id1161" class="calibre1"/> use of application snapshots to<a id="id1162" class="calibre1"/> transfer the template application data and Git repository. It first takes the <code class="email">jobstore</code> application snapshot, transfers it to the <code class="email">jobstorescalable</code> application, and then restores it. This can be seen in the application creation logs as shown in the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">Setting deployment configuration ... done</strong></span>
<span class="strong"><strong class="calibre7">Pulling down a snapshot of application 'jobstore' to /var/folders/9s/kp39j6zj1wg90n4jwshtdykh0000gn/T/jobstore_temp_clone.tar.gz</strong></span>
<span class="strong"><strong class="calibre7">...</strong></span>
<span class="strong"><strong class="calibre7">done</strong></span>
<span class="strong"><strong class="calibre7">Restoring from snapshot /var/folders/9s/kp39j6zj1wg90n4jwshtdykh0000gn/T/jobstore_temp_clone.tar.gz to application</strong></span>
<span class="strong"><strong class="calibre7">'jobstorescalable' ...</strong></span>
<span class="strong"><strong class="calibre7">done</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note35" class="calibre1"/>Note</h3><p class="calibre6">The cartridge data is not transferred when you create an application using <code class="email">--from-app</code>, but any data stored in <code class="email">$OPENSHIFT_DATA_DIR</code> is transferred to the new application.</p></div></div></div>

<div class="book" title="Creating scalable apps from nonscalable apps">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec526" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling manual scaling with marker files</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Enabling manual scaling with marker files"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch11lvl1sec135" class="calibre1"/>Enabling manual scaling with marker files</h1></div></div></div><p class="calibre6">In this recipe, you will learn<a id="id1163" class="calibre1"/> how you can disable autoscaling and add<a id="id1164" class="calibre1"/> gears manually to a scalable application using the <code class="email">rhc</code> command-line tool.</p></div>

<div class="book" title="Enabling manual scaling with marker files">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch11lvl2sec527" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will need <code class="email">rhc</code> installed on your machine. This recipe will utilize the application created in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe.</p></div></div>

<div class="book" title="Enabling manual scaling with marker files">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch11lvl2sec528" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to manually add a new gear to a scalable application:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a command-line terminal and navigate to the application directory created in the <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe.</li><li class="listitem" value="2">Create a new marker file with the name <code class="email">disable_auto_scaling</code> in the <code class="email">.openshift/marker</code> directory inside your application director. On Mac and Linux machines, you can use the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ touch .openshift/markers/disable_auto_scaling</strong></span>
</pre></div></li><li class="listitem" value="3">On Windows machines, you can create a new file using the <span class="strong"><strong class="calibre7">File</strong></span> menu.</li><li class="listitem" value="4">Commit the file to the local Git repository, and push the changes to the OpenShift application gear Git repository using the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git add .</strong></span>
<span class="strong"><strong class="calibre7">$ git commit -am "disabled auto scaling"</strong></span>
<span class="strong"><strong class="calibre7">$ git push</strong></span>
</pre></div></li><li class="listitem" value="5">Restart the HAProxy cartridge so that it does not run the <code class="email">haproxy_ctld</code> process. The <code class="email">haproxy_ctld</code> process is responsible for publishing scale-up and scale-down events. Have a look at the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc cartridge-restart haproxy</strong></span>
</pre></div></li><li class="listitem" value="6">Now, to add a new gear to your application, you can use the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc scale-up-app --app jobstore</strong></span>
</pre></div></li><li class="listitem" value="7">To remove a gear from your application, you can use the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc scale-down-app --app jobstore</strong></span>
</pre></div></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Enabling manual scaling with marker files">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch11lvl2sec529" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">OpenShift scalable applications are by default autoscalable in nature, which means they can add or remove web cartridge gears based on the number of concurrent users. While autoscaling is useful in most cases, there are times when you will prefer to control the scaling behavior yourself. You will enable manual scaling in situations where you can anticipate web traffic on your application well in advance. Examples are a holiday season or a promotion, where you know in advance that you can expect more visitors to your applications. For such situations, you can enable manual scaling to have a bunch of gears available to serve the web traffic.</p><p class="calibre6">OpenShift allows users<a id="id1165" class="calibre1"/> to manually add or remove gears <a id="id1166" class="calibre1"/>using the <code class="email">rhc scale-up-app</code> or <code class="email">rhc scale-down-app</code> commands. These commands add or remove one gear at a time. Under the covers, these commands use the OpenShift REST API to publish scale-up and scale-down events to the broker. OpenShift Broker consumes these requests and acts accordingly. After running the <code class="email">rhc scale-up-app</code> command in step 5, you should see that the <code class="email">jobstore</code> application is consuming three gears. You can also see the new gear in the HAProxy status page:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc show-app --app jobstore</strong></span>
<span class="strong"><strong class="calibre7">jobstore @ http://jobstore-osbook.rhcloud.com/ (uuid: 53d405dd4382ec661c001842)</strong></span>
<span class="strong"><strong class="calibre7">-------------------------------------------------------------------------------</strong></span>
<span class="strong"><strong class="calibre7">  Domain:          osbook</strong></span>
<span class="strong"><strong class="calibre7">  Created:         1:17 AM</strong></span>
<span class="strong"><strong class="calibre7">  Gears:           3 (defaults to small)</strong></span>
</pre></div></div></div>

<div class="book" title="Enabling manual scaling with marker files">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch11lvl2sec530" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">As mentioned in the preceding section, the<a id="id1167" class="calibre1"/> <code class="email">rhc scale-up-app</code> or <code class="email">scale-down-app</code> commands use the REST API to add or remove a gear. So, if you don't want to use <a id="id1168" class="calibre1"/>OpenShift tooling to perform manual scaling, then you can call the REST API yourself to add or remove gears from the application.</p><p class="calibre6">To scale up using <code class="email">curl</code>, you can run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">curl -k -X POST https://openshift.redhat.com/broker/rest/domains/{domain_name}/applications/{app_name}/events --user "openshift_login:openshift_login_password" --data "event=scale-up"</strong></span>
</pre></div><p class="calibre6">Replace <code class="email">domain_name</code>, <code class="email">app_name</code>, <code class="email">openshift_login</code>, and <code class="email">openshift_login_password</code> with their respective values.</p><p class="calibre6">To scale down using <code class="email">curl</code>, you can run the wfollowing command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">curl -k -X POST https://openshift.redhat.com/broker/rest/domains/{domain_name}/applications/{app_name}/events --user "openshift_login:openshift_login_password" --data "event=scale-down"</strong></span>
</pre></div></div></div>

<div class="book" title="Enabling manual scaling with marker files">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch11lvl2sec531" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Creating scalable applications</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Enabling manual scaling with marker files</em></span> recipe</li></ul></div></div></div>
<div class="book" title="Appendix&#xA0;A.&#xA0;Running OpenShift on a Virtual Machine"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="appA" class="calibre1"/>Appendix A. Running OpenShift on a Virtual Machine</h1></div></div></div><p class="calibre6">OpenShift Origin<a id="id1169" class="calibre1"/> is the free and open source flavor of OpenShift PaaS. It is the<a id="id1170" class="calibre1"/> upstream project to both OpenShift Online and Enterprise. You will learn how to run OpenShift Origin in a <span class="strong"><strong class="calibre7">Virtual Machine</strong></span> (<span class="strong"><strong class="calibre7">VM</strong></span>) <a id="id1171" class="calibre1"/>running on your machine. This will help you work with OpenShift even when you are not connected to the Internet. You can use the OpenShift Origin VM as your development environment to test your changes, and then when you are ready for deployment, you can push the source code to OpenShift Online. To use the OpenShift Origin VM as your development environment, run<a id="id1172" class="calibre1"/> the <code class="email">rhc setup --server</code> command. The <code class="email">--server</code> option should point to the OpenShift Origin VM broker. You can refer to the <span class="strong"><em class="calibre10">Specifying a different OpenShift server hostname</em></span> recipe in <a class="calibre1" title="Chapter 1. Getting Started with OpenShift" href="part0014_split_000.html#page">Chapter 1</a>, <span class="strong"><em class="calibre10">Getting Started with OpenShift</em></span>, for more details.</p><p class="calibre6">To prepare yourself, you will need to have VirtualBox installed on your machine. If you do not have it installed, please<a id="id1173" class="calibre1"/> download it from the official website at <a class="calibre1" href="https://www.virtualbox.org/">https://www.virtualbox.org/</a>. Also, install the 7-Zip software<a id="id1174" class="calibre1"/> for your operating system, which you can download from its official website at <a class="calibre1" href="http://www.7-zip.org/download.html">http://www.7-zip.org/download.html</a>.</p><p class="calibre6">Perform the following steps to run <a id="id1175" class="calibre1"/>OpenShift<a id="id1176" class="calibre1"/> on a VM:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Download the OpenShift Origin Version 3 VM image. The VM is over 2 GB in size. You can run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ wget https://mirror.openshift.com/pub/origin-server/release/3/images/openshift-origin.zip –secure-protocol=SSLv3</strong></span>
</pre></div></li><li class="listitem" value="2">Windows users can download either via the browser, or they can first download the <code class="email">wget</code> software<a id="id1177" class="calibre1"/> for Windows at <a class="calibre1" href="http://gnuwin32.sourceforge.net/packages/wget.htm">http://gnuwin32.sourceforge.net/packages/wget.htm</a>, and then use it to download the OpenShift Origin VM.</li><li class="listitem" value="3">The advantage of <a id="id1178" class="calibre1"/>using <code class="email">wget</code> is that you can resume the partial <a id="id1179" class="calibre1"/>download using the <code class="email">-c</code> option. This will help if you are at a location where the Internet connection is not stable, so you can resume the download using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ wget -c  https://mirror.openshift.com/pub/origin-server/release/3/images/openshift-origin.zip --secure-protocol=SSLv3</strong></span>
</pre></div></li><li class="listitem" value="4">Next, unpack the zip archive using the 7-Zip file archiver:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ 7z x openshift-origin.zip</strong></span>
</pre></div></li><li class="listitem" value="5">Typing in this command will result in three additional files, as shown in the next command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ ls -1t</strong></span>
</pre></div><p class="calibre14">These are <code class="email">OpenShift Origin Release 3.vmx</code>, <code class="email">OpenShift Origin Release 3.vbox</code>, and <code class="email">origin-rel3.vmdk</code>.</p></li><li class="listitem" value="6">Start the VirtualBox manager, and click on the <span class="strong"><strong class="calibre7">New</strong></span> button. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00151.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="7">Change the details<a id="id1180" class="calibre1"/> required for the OpenShift Origin VM. You<a id="id1181" class="calibre1"/> can keep whatever name you like, but you have to use <span class="strong"><strong class="calibre7">Type</strong></span> as <span class="strong"><strong class="calibre7">Linux</strong></span> and <span class="strong"><strong class="calibre7">Version</strong></span> as <span class="strong"><strong class="calibre7">Fedora (64 bit)</strong></span>. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00152.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="8">Next, set the memory<a id="id1182" class="calibre1"/> size to 1 GB, as this will give the VM a<a id="id1183" class="calibre1"/> reasonable amount of memory to work well with. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00153.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="9">Next, you will add a<a id="id1184" class="calibre1"/> virtual hard drive to the new machine. Please <a id="id1185" class="calibre1"/>select the <span class="strong"><strong class="calibre7">Use an existing virtual hard drive file</strong></span> option, and click on the <span class="strong"><strong class="calibre7">Choose a virtual hard drive file upload</strong></span> button. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00154.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="10">VirtualBox will<a id="id1186" class="calibre1"/> present a file selection dialog. Browse to find <a id="id1187" class="calibre1"/>the <code class="email">origin-rel3.vmdk</code> file, and select it. Click on the button labeled <span class="strong"><strong class="calibre7">Open</strong></span>. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00155.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="11">After selecting the<a id="id1188" class="calibre1"/> file, click on <span class="strong"><strong class="calibre7">Create</strong></span> to create a new VM. You <a id="id1189" class="calibre1"/>will see a new VM in the virtual manager display. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00156.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="12">Next, you will<a id="id1190" class="calibre1"/> set up a bridged network adapter, which will <a id="id1191" class="calibre1"/>allow you to work with the OpenShift Origin VM from your local machine. Select the VM, and right-click on it. Then, click on the <span class="strong"><strong class="calibre7">Settings</strong></span> icon:<div class="mediaobject"><img src="../images/00157.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="13">Navigate to the <a id="id1192" class="calibre1"/><span class="strong"><strong class="calibre7">Network</strong></span> settings, and select <span class="strong"><strong class="calibre7">Adapter 2</strong></span>. Check<a id="id1193" class="calibre1"/> the <span class="strong"><strong class="calibre7">Enable Network Adapter</strong></span> checkbox, and then set the <span class="strong"><strong class="calibre7">Attached to</strong></span> drop-down menu to <span class="strong"><strong class="calibre7">Bridged Adapter</strong></span>. Finally, set the name to the network adapter you want to bridge. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00158.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p><p class="calibre14">Each system<a id="id1194" class="calibre1"/> may have different names for their <a id="id1195" class="calibre1"/>physical network adaptors. Click on <span class="strong"><strong class="calibre7">OK</strong></span> after making the preceding changes.</p></li><li class="listitem" value="14">Start the VM by clicking on the <span class="strong"><strong class="calibre7">Start</strong></span> button. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00159.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="15">When the VM has <a id="id1196" class="calibre1"/>finished booting, it will present you with a tutorial<a id="id1197" class="calibre1"/> that will help you understand how to work with the OpenShift Origin VM, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00160.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p><p class="calibre14">After you enter <code class="email">yes</code>, the tutorial will walk you through the features of the OpenShift Origin VM from an administrator's perspective.</p></li><li class="listitem" value="16">After finishing the <a id="id1198" class="calibre1"/>admin tutorial, you will be shown a menu<a id="id1199" class="calibre1"/> where you can select options to interact with the OpenShift Origin VM. Choose the second option to connect with the web console. You will be shown the web console details, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00161.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="17">Copy the URL<a id="id1200" class="calibre1"/> and paste it into your browser. The default <a id="id1201" class="calibre1"/>username/password combination is <code class="email">demo</code>/<code class="email">changeme</code>. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00162.jpeg" alt="Running OpenShift on a Virtual Machine" class="calibre8"/></div><p class="calibre12"> </p><p class="calibre14">Log in to the web console using the default username and password. You will be <a id="id1202" class="calibre1"/>directed to the application creation <a id="id1203" class="calibre1"/>page. You can create the WordPress application by following the steps mentioned in the <span class="strong"><em class="calibre10">Creating a WordPress application using the web console</em></span> recipe in <a class="calibre1" title="Chapter 1. Getting Started with OpenShift" href="part0014_split_000.html#page">Chapter 1</a>, <span class="strong"><em class="calibre10">Getting Started with OpenShift</em></span>.</p></li></ol><div class="calibre13"/></div></div></body></html>