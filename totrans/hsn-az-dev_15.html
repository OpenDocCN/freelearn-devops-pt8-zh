<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using Application Insights to Monitor Your Applications</h1>
                </header>
            
            <article>
                
<p>Azure is not only about developing an application. Once we have our solution deployed to the cloud, we have to somehow monitor and diagnose it. The Azure Application Insights service offers a complete toolset for maintaining your applications, with SDKs available for multiple languages and platforms, alerts, query language, and integration with many native Azure services. It simplifies logging in to applications and gets rid of multiple sources of truth when it comes to analyzing an issue using data from several places.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Using the Azure Application Insights service</li>
<li>Monitoring different platforms</li>
<li>Using the Analytics module</li>
<li>Automating Azure Application Insights</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>To perform the exercises in this chapter, you will need:</p>
<ul>
<li>An Azure subscription</li>
<li>Visual Studio with the following workloads installed—ASP.NET,web development, and Azure development</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using the Application Insights service</h1>
                </header>
            
            <article>
                
<p>One of the most important features when developing applications (especially hosted in the cloud) is the ability to easily monitor them and detect at an early stage any possible issues and flaws. To do so, you need a whole architecture of loggers, storage, and report tools, which you have to integrate, configure, and maintain daily. This requires an additional set of skills in your team and, of course, takes time—the bigger your application is, the more is required. With Azure Application Insights, all those operations are much simpler: you have a single service and endpoint for logging all required information, and the rest is done for you automatically.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Logging data in the cloud</h1>
                </header>
            
            <article>
                
<p>Let's assume you have the following architecture:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/889d8c58-aeb8-4601-ab16-225b3e43f116.png" style="width:47.67em;height:24.58em;" width="684" height="353"/></p>
<p>It contains many different web apps, different storage capabilities (such as a SQL database or Azure Storage), and also Azure Functions. If we want to be able to monitor all those services, we will need the following components:</p>
<ul>
<li>A tool for saving logs (which is able to use different outputs such as storage or a file, possibly multiplatform)</li>
<li>Storage able to store gigabytes of log data</li>
<li>Some kind of dashboard, which will get data from the storage and display it using different filters and parameters</li>
</ul>
<p>When you take all those into account, you may find the following caveats:</p>
<ul>
<li>Storing raw data is not enough as you will need some kind of projections view, which can be quickly fetched and does not require extra transformations or processing.</li>
<li>You have to find a way to store data that allows users to query at will with different vectors—<span>appending logs</span> may seem great for checking recent records, <span>but for creating an index of dynamic parameters it is not so good.</span></li>
<li>You have to implement some kind of data <span>retention—</span>most logs have no use after a fixed time period.</li>
<li>Performance for both applications and the reporting solution should be repeatable and should not change in time (for example, with the increased amount of data stored).</li>
<li>Having a dedicated team for issue tracking may not be the best allocation of resources—people with reporting and data analyzing skills are much more valuable when they work on actual business data.</li>
</ul>
<p>The ideal solution for the preceding problems would be a single component capable of doing everything we mentioned earlier:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/4f34f9a5-a936-4bcc-bef7-a6f89cf27f64.png" style="width:32.58em;height:22.58em;" width="637" height="440"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>In Azure, such a component is Azure Application Insights, which we will cover in this chapter.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Application Insights fundamentals</h1>
                </header>
            
            <article>
                
<p>Connecting to the Azure Application Insights service can differ depending on your circumstances. In general, you have multiple possibilities when integrating the service:</p>
<ul>
<li>Seamless integration within the portal—no additional steps required, you just enable and configure a feature—the rest is already implemented</li>
<li>Using an appropriate SDK depending on the platform</li>
<li>Sending telemetry events directly to the service endpoints</li>
</ul>
<p>Depending on the concept you use, a different configuration will be used:</p>
<ul>
<li>For the portal, you need no extra steps as you are already authenticated, and a resource can be selected for example from a drop-down menu.</li>
<li>For SDK, you need an instrumentation key, which can be found in the portal—we will cover this topic later in this chapter.</li>
<li>Using REST APIs, there are different options available, such as App ID, key, or OAuth2 flow .</li>
</ul>
<div class="packt_tip">Note that, depending on the method of logging used, different features and capabilities may be available. This is especially true for sending custom events or custom logging logic—such actions often will require using a dedicated SDK.</div>
<p>Besides some obvious features (such as the ability to log and store information about a request or an exception), Azure Application Insights has many different capabilities implemented:</p>
<ul>
<li><strong>Requests telemetry</strong>: You can automatically gather information regarding the request count, average latency, and failure rates. If using this service, for example, with Azure App Services, you are given full insights into your web application by just implementing the SDK.</li>
<li><strong>Dependencies</strong>: Besides general telemetry, in Azure Application Insights you can find information about how your dependencies (such as Azure Table Storage and Azure SQL) perform. This is especially true if you have multiple services integrated and you want to know which one affects the latency the most.</li>
<li><strong>Exceptions</strong>: Having information about failed requests or dependencies is one thing, but a detailed dashboard displaying aggregated data about errors is a much more useful thing. In Azure Application Insights, you can easily check which type of error is connected to some specific subset of requests. This gives you a much better understanding of what is going on under the hood in your application and where to start fixing it.</li>
<li><strong>User telemetry</strong>: Do you want to know exactly how many users you have? Are you interested in what the flow is when they use your application? In Azure Application Insights, there are additional features that give you information about user and session counts, their behavior, and overall activities.</li>
</ul>
<p>Of course, I have not listed all the available features—there are even more, such as gathering information regarding AJAX calls, page view, and web performance; performance counters (for VMs), and host diagnostics from Docker. In fact, the availability of a feature also depends on the service you have chosen—a different telemetry is gathered for Azure Functions and for Azure App Services.</p>
<div class="packt_tip">In reality, you can achieve the same level of granularity of your logs<em> </em>with similar charts and diagnostics available in most services. What changes is the level of effort required—the less integration a service has with Azure Application Insights, the more you have to do on your own.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating Azure Application Insights in the portal</h1>
                </header>
            
            <article>
                
<p>To create an instance of Azure Application Insights, you have to search for the service in the marketplace.</p>
<p>You will have to fill in the following simple form to proceed:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7a3ab130-9ec6-4139-9426-4f77c8d26d83.png" style="width:23.92em;height:29.67em;" width="364" height="452"/></p>
<p>In fact, it contains one field that you probably have not met yet:</p>
<ul>
<li><span class="packt_screen">Application Type</span>: Depending on your choice (<span class="packt_screen">ASP.NET web application</span>, <span class="packt_screen">Java</span>, <span class="packt_screen">App Center</span>, <span class="packt_screen">Node.js</span>, or <span class="packt_screen">General</span>), a different set of charts will be selected. This option does not affect the available features of a service. Rather, it ensures that, for a specific instance, you will see only the information you are most interested in.</li>
</ul>
<p>The rest of what your instance is capable of depends solely on the services integrated with it and the amount of data sent to it. </p>
<div class="packt_tip">Unlike most Azure services, in Azure Application Insights there is no requirement to have a unique service name for all instances globally—here you just cannot use the same name for multiple services within a service. This is because it does not use a DNS name to work and connect with other applications.</div>
<p class="mce-root"/>
<p>When you click <span class="packt_screen">Create<strong>,</strong> </span>it should not take long to provision a new instance of a service, which should look similar to the following:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/1af48625-1557-4280-a56e-462aa672d77c.png" width="1766" height="715"/></div>
<p>As you can see, there is the <span class="packt_screen">Essentials </span>section, hidden by default—it contains some common metadata and, what is more important, an instrumentation key— and an identifier, which uniquely identifies your instance of your service. We will use it to actually connect to Azure Application Insights—the rest of the feature will be described later in this chapter.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Monitoring different platforms</h1>
                </header>
            
            <article>
                
<p>The strength of Azure Application Insights is its ability to monitor simultaneously from different platforms. You can choose from ASP.NET pages, Java, Node.JS, or even Python or Ruby (however, there are some languages and frameworks officially supported by Application Insights teams and some are supported by the community). The point is, it is platform-agnostic. When you, in fact, need the implementation of the communication channel, with an instrumentation key you can easily send data to an instance of a service without additional keys and an extended configuration. In this section, we will focus on sending information from different platforms, so you will be able to start integration in your projects easily on your own.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">.NET</h1>
                </header>
            
            <article>
                
<p>In .NET applications, the only thing you have to do to get started is to install the latest <kbd>Microsoft.ApplicationInsights </kbd>package. The easiest way is to use the following code snippet:</p>
<pre>TelemetryConfiguration.Active.InstrumentationKey = "&lt;instrumentation-key&gt;";<br/>var telemetryClient = new TelemetryClient();</pre>
<p>This code does two things:</p>
<ul>
<li>Sets the current configuration by providing an instrumentation key. It is all that is needed to connect to a service.</li>
<li>Initializes an instance of <kbd>TelemetryClient</kbd>—this class is a proxy to a service, which enables you to communicate with it.</li>
</ul>
<p>Then you can use different methods to log some data:</p>
<pre><span>telemetryClient.TrackTrace(</span><span class="hljs-string">"Hello World!"</span><span>);<br/>telemetryClient.TrackException(new Exception());<br/>telemetryClient.TrackDependency(new DependencyTelemetry());</span></pre>
<p>Of course, there are more methods available—you can find them in the <em>Further reading</em><strong> </strong>section. In the first snippet, we used the <kbd>TelemetryConfiguration </kbd>type—in fact, the data stored in the configuration it provides is initially fetched from the <kbd>ApplicationInsights.config</kbd><strong> </strong>file—it can look like this:</p>
<pre>&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;ApplicationInsights &gt;<br/>  &lt;InstrumentationKey&gt;8sad7asd-asd876asf-jr323jsd-3hshjahj&lt;/InstrumentationKey&gt;<br/>  &lt;TelemetryInitializers&gt;<br/>    &lt;Add Type="Microsoft.ApplicationInsights.DependencyCollector.HttpDependenciesParsingTelemetryInitializer, Microsoft.AI.DependencyCollector"/&gt;<br/>  &lt;/TelemetryInitializers&gt;<br/>  &lt;TelemetryModules&gt;<br/>    &lt;Add Type="Microsoft.ApplicationInsights.DependencyCollector.DependencyTrackingTelemetryModule, Microsoft.AI.DependencyCollector"&gt;<br/>      &lt;ExcludeComponentCorrelationHttpHeadersOnDomains&gt;<br/>      &lt;/ExcludeComponentCorrelationHttpHeadersOnDomains&gt;<br/>      &lt;IncludeDiagnosticSourceActivities&gt;<br/>        &lt;Add&gt;Microsoft.Azure.ServiceBus&lt;/Add&gt;<br/>        &lt;Add&gt;Microsoft.Azure.EventHubs&lt;/Add&gt;<br/>      &lt;/IncludeDiagnosticSourceActivities&gt;<br/>    &lt;/Add&gt;<br/>  &lt;/TelemetryModules&gt;<br/>  &lt;TelemetryChannel Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.ServerTelemetryChannel, Microsoft.AI.ServerTelemetryChannel"/&gt;<br/>&lt;/ApplicationInsights&gt;</pre>
<p>If the file is not present (or it does not contain all values), the configuration will not be correct; in such a scenario, you have to provide it manually. </p>
<div class="packt_infobox">Please note, those above instructions are applicable only if you are using .NET framework.</div>
<p>It is worth mentioning here that the setup differs between platforms. We have discussed the most basic (console app) one, but we can use other application types, like Windows desktop applications:</p>
<pre>public partial class Form1 : Form<br/>{<br/>  private TelemetryClient _telemetryClient = new TelemetryClient();<br/><br/>  private void Form1_Load(object sender, EventArgs e)<br/>  {<br/>    _telemetryClient.InstrumentationKey = "&lt;instrumenation-key&gt;";<br/><br/>    _telemetryClient.Context.User.Id = Environment.UserName;<br/>    _telemetryClient.Context.Session.Id = Guid.NewGuid().ToString();<br/>    _telemetryClient.Context.Device.OperatingSystem = Environment.OSVersion.ToString();<br/><br/>    _telemetryClient.TrackPageView("Form1");<br/>  }<br/>}</pre>
<p>Or we can use web apps that have a seamless integration with Azure Application Insights.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Node.js</h1>
                </header>
            
            <article>
                
<p>To start working with Azure Application Insights in Node.js, you will need the following command:</p>
<pre><strong><span>npm install applicationinsights</span></strong></pre>
<p class="mce-root"/>
<p>It will install an NPM package of Application Insights, which allows working with this service. Here is a full example of the interface of this package:</p>
<pre>let http = require("http");<br/>let appInsights = require("applicationinsights");<br/><br/>appInsights.setup("&lt;instrumentation-key&gt;");<br/>appInsights.start();<br/>let client = appInsights.defaultClient;<br/><br/>client.trackEvent({name: "my custom event", properties: {customProperty: "custom property value"}});<br/>client.trackException({exception: new Error("handled exceptions can be logged with this method")});<br/>client.trackMetric({name: "custom metric", value: 3});<br/>client.trackTrace({message: "trace message"});<br/>client.trackDependency({target:"http://dbname", name:"select customers proc", data:"SELECT * FROM Customers", duration:231, resultCode:0, success: true, dependencyTypeName: "ZSQL"});<br/>client.trackRequest({name:"GET /customers", url:"http://myserver/customers", duration:309, resultCode:200, success:true});<br/><br/><br/>http.createServer( (req, res) =&gt; {<br/>  client.trackNodeHttpRequest({request: req, response: res});<br/>}).listen(1337, "127.0.0.1");<br/><br/>console.log('Server running at http://127.0.0.1:1337/');</pre>
<p>Try to run the example and check the insights—you will see that first requests are logged:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/6d346db0-dd94-4012-8d3c-939208208375.png" width="1797" height="802"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Functions</h1>
                </header>
            
            <article>
                
<p>Azure Application Insights also offers seamless integration with another Azure service, Azure Functions. There are two ways of enabling integration: either turn it on while creating a service, or manually by providing an instrumentation key in the settings.</p>
<p>The following is a form where this feature can be enabled:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3fa34861-fbb9-48ae-bff8-1bf852923c6f.png" style="width:24.17em;height:45.83em;" width="366" height="696"/></p>
<p>There is, however, one caveat to such a setup: you cannot select an instance of a service if you already have one. To do so, you have to enable integration manually by providing <kbd>APPINSIGHTS_INSTRUMENTATIONKEY</kbd><strong><span> </span></strong><span>in the settings of the <span class="packt_screen">Function App</span>.</span></p>
<div class="packt_tip">There is one more option. Instead of providing a key manually, you can click on the <span class="packt_screen">Monitor </span>tab of any function and then <span class="packt_screen">Configure</span>. This option will be available if the classic view is not yet enabled.</div>
<p>With integration enabled, you will be able to analyze the executions of all your queries:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3913790d-2070-4135-8ce7-6457e424da51.png" style="width:32.75em;height:46.58em;" width="528" height="751"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Analytics module</h1>
                </header>
            
            <article>
                
<p>Multiple ways to integrate Azure Application Insights with different services (as well as a custom application) is not the only big feature of this service. Another important and crucial thing is the analytics language available in the Analytics module. It is an interactive query language, which enables you to explore logged data easily, using a simple and intuitive syntax. Another great thing about it is that you do not need any additional tools to get started—once you store traces, exceptions, or requests, it is available out-of-the-box—the only thing you need to do is write a query. In this section, we will cover both the query language and the module, so you can start writing your own queries and discover many different dimensions available in stored logs.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Accessing the Analytics module</h1>
                </header>
            
            <article>
                
<p>Getting started with the Analytics module is really easy. Go to the <span class="packt_screen">Overview </span>blade of your instance of Azure Application Analytics and click on the <span class="packt_screen">Analytics </span>button:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/5350591d-7431-4e17-993b-be6af122ced9.png" width="570" height="52"/></p>
<p>It will display another window showing new options, such as the ability to enter a query, use a pre-defined one, or simply explore the different dimensions available:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/9e54cc2a-2789-49dc-a2a0-5b1360ec75ae.png" style="width:48.25em;height:34.25em;" width="720" height="511"/></p>
<p>The most important thing here is the query window. It is an interactive feature which enables you to write a query and offers you additional capabilities, such as a syntax validator and suggestions. Let's start with a simple query which displays request counts over the last few days:</p>
<pre>requests<br/>| summarize totalCount=sum(itemCount) by bin(timestamp, 30m)<br/>| render timechart</pre>
<p>As you can see, it has three parts:</p>
<ul>
<li><kbd>requests</kbd>: The dimension you are querying </li>
<li><kbd>summarize</kbd>: A function which defines what you want to get from the dimension</li>
<li><kbd>render</kbd>: An optional function that draws a chart based on the data </li>
</ul>
<p class="mce-root"/>
<p>Of course, queries can have different structures; you can find one that is a bit more complicated:</p>
<pre>requests<br/>| summarize RequestsCount=sum(itemCount), AverageDuration=avg(duration), percentiles(duration, 50, 95, 99) by operation_Name<br/>| order by RequestsCount desc</pre>
<p>From the preceding example, there will be no chart—instead, it will display a table:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/0f8a53a4-5a56-4976-b8c6-626142a51c8e.png" width="994" height="417"/></p>
<p>The important thing is the date range for a query as inside it you can just filter data. You have to select which dates you are interested in. To do so, click on the <span class="packt_screen">Time range</span><strong> </strong>button, next to the<span class="packt_screen"> Run</span> button, and choose the right option:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/7098bce1-86dc-4e9d-9ba0-73d57eb22870.png" style="width:18.33em;height:17.17em;" width="323" height="302"/></p>
<div class="packt_tip">The query language in Azure Application Analytics is very rich as it defines many different functions for different data types and actions (you can use many different window functions, for example, <kbd>next()</kbd>). The relevant reference can be found in the <em>Further reading</em><strong> </strong>section.</div>
<p>Additionally, when a query is actioned, you can select an additional filter for it (based on the result), so you can choose specific records:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/8c454505-b435-4dc9-9bff-7bba553dd856.png" style="width:27.17em;height:46.83em;" width="382" height="660"/></div>
<p>There is also one other helpful feature of the Analytics module—smart analytics. It is a set of additional functions which extend the analytic capabilities by introducing elements of machine learning in data analysis. Currently, the following functions are available:</p>
<ul>
<li><strong>Autocluster</strong>:<strong> </strong>A function which automatically divides data into clusters to make it easier to understand.</li>
<li><strong>Basket</strong>: This one automatically finds interesting data inside the results of a query.</li>
<li><strong>Diffpatterns</strong>: This feature operates on a column that stores true/false data and tries to find patterns corresponding to the differences between them.</li>
<li><strong>Timer series</strong>: This function (<kbd>make-series</kbd>) will convert data into a single row making it possible to analyze the root cause of a problem.</li>
<li><strong>Linear regression</strong>: With this function, you will easily find data trends based on the results (whether, for example, the number of <span>exceptions grows</span> or not).</li>
<li><strong>Outlier value detection</strong>: This one finds how a value is anomalous in comparison with others.</li>
</ul>
<p>With these advanced functions, you can greatly improve the analysis of your data. They incorporate many helpful features, making the whole service much more flexible. What is more, you do not have to be a data scientist to actually work on data, find trends, and anomalies.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Application Insights automation</h1>
                </header>
            
            <article>
                
<p>Monitoring is not something you like to spend time on on a daily basis. In fact, the more automated the service is, the better results you can get. It is always easier to let the machine look at different dimensions and find problems based on some preset rules; it will do it quicker and more carefully. In Azure Application Insights, you have many options when it comes to automation: ARM templates, alerts in the portal, or integrating external services (such as Microsoft Flow). In the last section of this chapter, you will learn how to get started with automation and make sure you focus on development, instead of log analysis and service maintenance.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Alerts</h1>
                </header>
            
            <article>
                
<p>An alert is a feature which enables you to be notified when an anomaly occurs. There are plenty of different possibilities when it comes to setting up an alert, starting with an ARM template:</p>
<pre>{<br/>  "name": "[variables('myFirstAlertName')]",<br/>  "type": "Microsoft.Insights/alertrules",<br/>  "apiVersion": "2014-04-01",<br/>  "location": "[parameters('appLocation')]",<br/>  "dependsOn": [<br/>    "[resourceId('Microsoft.Insights/components', parameters('myApplicationName'))]"<br/>  ],<br/>  "tags": {<br/>    "[concat('hidden-link:', resourceId('Microsoft.Insights/components', parameters('myApplicationName')))]": "Resource"<br/>  },<br/>  "properties": {<br/>    "name": "[variables('responseAlertName')]",<br/>    "description": "response time alert",<br/>    "isEnabled": true,<br/>    "condition": {<br/>      "$type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.ThresholdRuleCondition, Microsoft.WindowsAzure.Management.Mon.Client",<br/>      "odata.type": "Microsoft.Azure.Management.Insights.Models.ThresholdRuleCondition",<br/>      "dataSource": {<br/>        "$type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.RuleMetricDataSource, Microsoft.WindowsAzure.Management.Mon.Client",<br/>        "odata.type": "Microsoft.Azure.Management.Insights.Models.RuleMetricDataSource",<br/>        "resourceUri": "[resourceId('microsoft.insights/components', parameters('myApplicationName'))]",<br/>        "metricName": "request.duration"<br/>      },<br/>      "threshold": "[parameters('responseTime')]",<br/>      "windowSize": "PT15M"<br/>    },<br/>    "actions": [{<br/>      "$type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.RuleEmailAction, Microsoft.WindowsAzure.Management.Mon.Client",<br/>      "odata.type": "Microsoft.Azure.Management.Insights.Models.RuleEmailAction",<br/>      "sendToServiceOwners": true,<br/>      "customEmails": []<br/>    }]<br/>  }<br/>}</pre>
<p>While initially such an ARM template may be a little bit overwhelming, in fact it contains a fixed set of parameters which can be easily found using Resource Explorer (you can find a link to it in the <em>Further reading</em><strong> </strong>section). Here you can find out how existing alert rules can be discovered:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/86bcb024-11ce-454c-b7e6-c78fa358ce7c.png" style="width:13.33em;height:21.67em;" width="206" height="336"/></p>
<p>In the preceding screenshot, I displayed the available alert rules inside an Azure Application Insights instance, which I created inside a particular resource group. When you click on it, you will see a full description of the resource inside Azure.</p>
<div class="packt_tip">Resource Explorer is a great tool when you work with ARM templates and search for a reference to a particular resource. It displays all parameters describing a service from the ARM point of view.</div>
<p>Here, you can find the default alert, created when a service is deployed:</p>
<pre>{<br/>  "id": "/subscriptions/.../resourceGroups/handsonazure-rg/providers/microsoft.insights/alertrules/Failure Anomalies - handsonazure-ai",<br/>  "name": "Failure Anomalies - handsonazure-ai",<br/>  "type": "Microsoft.Insights/alertRules",<br/>  "location": "West Europe",<br/>  "properties": {<br/>    "name": "Failure Anomalies - handsonazure-ai",<br/>    "description": "",<br/>    "isEnabled": true,<br/>    "condition": {<br/>      "$type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.ThresholdRuleCondition, Microsoft.WindowsAzure.Management.Mon.Client",<br/>      "odata.type": "Microsoft.Azure.Management.Insights.Models.ThresholdRuleCondition",<br/>      "dataSource": {<br/>        "$type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.RuleMetricDataSource, Microsoft.WindowsAzure.Management.Mon.Client",<br/>        "odata.type": "Microsoft.Azure.Management.Insights.Models.RuleMetricDataSource",<br/>        "resourceUri": "/subscriptions/.../resourcegroups/handsonazure-rg/providers/microsoft.insights/components/handsonazure-ai",<br/>        "resourceLocation": null,<br/>        "metricNamespace": null,<br/>        "metricName": "...",<br/>        "legacyResourceId": null<br/>      },<br/>      "operator": "GreaterThan",<br/>      "threshold": 2,<br/>      "windowSize": "PT1H",<br/>      "timeAggregation": null<br/>    },<br/>    "action": null,<br/>    "lastUpdatedTime": "2018-09-14T12:04:57.6355645Z",<br/>    "provisioningState": "Succeeded",<br/>    "actions": [<br/>      {<br/>        "$type": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.RuleEmailAction, Microsoft.WindowsAzure.Management.Mon.Client",<br/>        "odata.type": "Microsoft.Azure.Management.Insights.Models.RuleEmailAction",<br/>        "sendToServiceOwners": true,<br/>        "customEmails": []<br/>      }<br/>    ]<br/>  }<br/>}</pre>
<p>To make things a little bit easier to understand, let's check how to set an alert inside a portal. You can access the <span class="packt_screen">Alerts </span>blade in the <span class="packt_screen">Configure </span>section:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/be476561-b19c-472c-8cf5-3684a9b53fb5.png" style="width:14.92em;height:20.25em;" width="212" height="288"/></div>
<p>To get started you need to click on the <span class="packt_screen">+ New alert rule</span> button. What you will see is a detailed wizard, providing a quick way to set up an alert. The most important thing here is the conditions—they define how an alert is triggered:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/cc3c8254-1ee9-41f4-9e15-76977b44f798.png" width="978" height="386"/></p>
<p>Of course, an alert can have more than only one trigger as it all depends on its characteristics. What is more, the conditions can be quite complex; they can refer to multiple resources and introduce the concept of composite alert rules. The next thing defined here is the alert details—you have to provide some metadata which describes them:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/3ef39d55-4334-4029-8568-022298e5b1da.png" style="width:54.75em;height:29.75em;" width="697" height="379"/></p>
<p>The important thing is the severity of an alert: the higher it is, the more crucial an alert will be. The last part of the wizard is the actual action, and you have multiple options available:</p>
<ul>
<li>Email/SMS/Push/Voice</li>
<li>Azure Function</li>
<li>LogicApp</li>
<li>Webhook</li>
<li>ITSM</li>
<li>Automation runbook</li>
</ul>
<p>Some of them require you to already have a service which will handle an alert—you have to select the option that suits your needs the most. When you create an alert, it will be active and visible in the service:</p>
<p class="CDPAlignCenter CDPAlign"><img src="Images/75c9967d-c310-4fa7-9e0d-1d455d561acf.png" style="width:44.58em;height:27.92em;" width="610" height="381"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you learned about a monitoring solution available for Azure: Azure Application Insights. We covered things such as provisioning a resource, creating an alert, and integrating with other services. This Azure component offers many additional features besides those mentioned in the chapter—there are things such as smart detection, continuous export of data, or detailed usage logs. I strongly encourage you to explore it further on your own, as it greatly simplifies monitoring activities and resolving issues. In the next chapter, we will cover the last Azure service within the scope of this book: Azure SQL, which is a PaaS service, being an Azure version of the well-known database engine.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>What is needed to identify an Azure Application Insights instance and connect to it?</li>
<li>Is it possible to use Azure Application Insights inside a Node.js application?</li>
<li>What is the Smart Analytics module?</li>
<li>How can you query logs stored inside Azure Application Insights?</li>
<li>How can you automate creating alerts in the service?</li>
<li>Is it possible to use SMS as an action for a triggered alert?</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li>TelemetryClient reference: <a href="https://docs.microsoft.com/pl-pl/dotnet/api/microsoft.applicationinsights.telemetryclient?view=azure-dotnet">https://docs.microsoft.com/pl-pl/dotnet/api/microsoft.applicationinsights.telemetryclient?view=azure-dotnet</a></li>
<li>Azure log analytics reference: <a href="https://docs.loganalytics.io/index">https://docs.loganalytics.io/index</a></li>
<li>Smart analytics: <a href="https://docs.loganalytics.io/docs/Learn/Tutorials/Smart-Analytics/Understanding-Autocluster">https://docs.loganalytics.io/docs/Learn/Tutorials/Smart-Analytics/Understanding-Autocluster</a></li>
<li>Resource Explorer: <a href="https://resources.azure.com/">https://resources.azure.com/</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>