<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;10.&#xA0;Continuous Integration for OpenShift Applications"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10" class="calibre1"/>Chapter 10. Continuous Integration for OpenShift Applications</h1></div></div></div><p class="calibre6">This chapter will help you to add continuous integration to your OpenShift applications using the Jenkins cartridge. The specific recipes of this chapter are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Adding Jenkins CI to your application</li><li class="listitem">Increasing the slave idle timeout</li><li class="listitem">Installing Jenkins plugins</li><li class="listitem">Using Jenkins to build projects hosted on GitHub</li><li class="listitem">Creating a Jenkins workflow for your OpenShift applications</li><li class="listitem">Upgrading Jenkins to the latest version</li></ul></div></div>

<div class="book" title="Chapter&#xA0;10.&#xA0;Continuous Integration for OpenShift Applications">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch10lvl1sec118" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre6">In this chapter, you will learn how to add <span class="strong"><strong class="calibre7">Continuous Integration</strong></span> (<span class="strong"><strong class="calibre7">CI</strong></span>)<a id="id1001" class="calibre1"/> support to your OpenShift applications. CI is an <span class="strong"><strong class="calibre7">Extreme Programming</strong></span> (<span class="strong"><strong class="calibre7">XP</strong></span>)<a id="id1002" class="calibre1"/> practice in which a tool monitors your version control system, such as Git or SVN, for code changes. Whenever it detects a change, it builds the project and runs its test cases. If the build fails for some reason, the tool will notify the development team about the failure via e-mail or other communication channels so that they can fix the build failure immediately. CI tools can do much more beyond building and testing the application. They can also keep track of the code quality over a period of time, run functional tests, perform automatic deployment, apply database migrations, and perform a lot of other tasks. This helps us to discover defects early in the software development cycle, improves code quality, and automates deployment.</p><p class="calibre6">OpenShift supports Jenkins as its CI tool of choice. Jenkins<a id="id1003" class="calibre1"/> (<a class="calibre1" href="http://jenkins-ci.org/">http://jenkins-ci.org/</a>) is the <a id="id1004" class="calibre1"/>most dominant and popular CI server in the market today. It is an open source project written in the Java programming language. Jenkins is feature rich and extensible through plugins. There are more than 600 Jenkins plugins made by an active community at your disposal, which can cover everything from version control system, build tools, code quality metrics, build notifiers, and much more.</p><p class="calibre6">The <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe will help you to add Jenkins to your existing OpenShift application. We will use a Java application to showcase OpenShift Jenkins integration. This chapter discusses Jenkins in the context of Java applications. Nevertheless, even if you are using any other web cartridge supported by OpenShift, this chapter will give you a good understanding on how to add the OpenShift Jenkins CI support to your application.</p><p class="calibre6">OpenShift uses the Jenkins master/slave topology (<a class="calibre1" href="https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds">https://wiki.jenkins-ci.org/display/JENKINS/Distributed+builds</a>) to distribute build jobs<a id="id1005" class="calibre1"/> among different slaves. This ensures you get a scalable Jenkins environment for your OpenShift applications. Also, the Jenkins master will create different types of slaves to build different OpenShift application types. The type of slave depends on the application type. For example, to build a JBoss EAP application, the Jenkins master will create a slave that has a JBoss EAP cartridge installed. By default, a slave will die after 15 minutes of inactivity. The <span class="strong"><em class="calibre10">Increasing the slave idle timeout</em></span> recipe will cover how you can increase the idle timeout for slaves.</p><p class="calibre6">Plugins make Jenkins extensible and allow you to extend it to meet your needs. In the <span class="strong"><em class="calibre10">Installing Jenkins plugins</em></span> recipe, you will learn how to install Jenkins plugins. You can view the full list of Jenkins plugins<a id="id1006" class="calibre1"/> at <a class="calibre1" href="https://wiki.jenkins-ci.org/display/JENKINS/Plugins">https://wiki.jenkins-ci.org/display/JENKINS/Plugins</a>.</p><p class="calibre6">You can use Jenkins not only to build applications hosted on OpenShift but also to build projects hosted elsewhere. The <span class="strong"><em class="calibre10">Using Jenkins to build projects hosted on GitHub</em></span> recipe will cover how you can build projects hosted on GitHub.</p><p class="calibre6">The <span class="strong"><em class="calibre10">Creating a Jenkins workflow for your OpenShift applications</em></span> recipe will show how you can customize the default build created by OpenShift for your needs. In this recipe, you will create a Jenkins workflow, including three Jenkins jobs. The first Jenkins job will poll a Git repository for changes, the second job will run code coverage over the application source code, and the third will deploy the application to OpenShift.</p><p class="calibre6">The Jenkins version supported by OpenShift is not the latest version. In the <span class="strong"><em class="calibre10">Upgrading Jenkins to the latest version</em></span> recipe, you will upgrade Jenkins to the latest version. The advantage of using the latest version is that some of the plugins do not work with the Jenkins version supported by OpenShift.</p><p class="calibre6">Jenkins is not the only CI server you can use to build and deploy OpenShift applications. You can also use a hosted CI server, such as Travis CI, to build and deploy an OpenShift application. The OpenShift Travis CI integration is not covered in this chapter, but you can refer to my blog for more <a id="id1007" class="calibre1"/>information on this topic at <a class="calibre1" href="https://www.openshift.com/blogs/how-to-build-and-deploy-openshift-java-projects-using-travis-ci">https://www.openshift.com/blogs/how-to-build-and-deploy-openshift-java-projects-using-travis-ci</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding Jenkins CI to your application"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10lvl1sec119" class="calibre1"/>Adding Jenkins CI to your application</h1></div></div></div><p class="calibre6">Adding Jenkins to your application is a two-step process. You have to first create the Jenkins server application and then add the Jenkins client cartridge to your application. In this recipe, you will learn how to add Jenkins CI to an existing OpenShift application. After adding Jenkins to your application, each Git push to your OpenShift application Git repository will initiate a Jenkins job that will build the project and then deploy it to OpenShift.</p></div>

<div class="book" title="Adding Jenkins CI to your application">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec462" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">To complete this recipe, you will <a id="id1008" class="calibre1"/>need three available gears. One gear will be <a id="id1009" class="calibre1"/>used by the application, and Jenkins will consume the remaining two gears. This chapter will use the application created in <a class="calibre1" title="Chapter 7. OpenShift for Java Developers" href="part0089_split_000.html#page">Chapter 7</a>, <span class="strong"><em class="calibre10">OpenShift for Java Developers</em></span>. If you don't have this application running, then recreate the application using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc app create jobstore jbosseap postgresql-9.2 --from-code https://github.com/OpenShift-Cookbook/chapter7-jobstore-javaee6.git</strong></span>
</pre></div></div></div>

<div class="book" title="Adding Jenkins CI to your application">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec463" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to add Jenkins to your application:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Before you can add the Jenkins cartridge to your application, you have to create the Jenkins server application:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jenkins jenkins</strong></span>
</pre></div></li><li class="listitem" value="2">After the preceding command is executed, the Jenkins server will be available at <code class="email">http://jenkins-{domain-name}.rhcloud.com</code>. Please replace <code class="email">{domain-name}</code> with your OpenShift account domain name.</li><li class="listitem" value="3">Make note of the username and password that the OpenShift <code class="email">rhc</code> command-line client presented to you in the application creation logs. These are used to log in to the Jenkins web console. This is shown in the following command-line output:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">Creating application 'jenkins' ... done</strong></span>
<span class="strong"><strong class="calibre7">  Jenkins created successfully.  Please make note of these credentials:</strong></span>
<span class="strong"><strong class="calibre7">   User: admin</strong></span>
<span class="strong"><strong class="calibre7">   Password: xxxxxx</strong></span>
<span class="strong"><strong class="calibre7">Note:  You can change your password at: https://jenkins-{domain-name}.rhcloud.com/me/configure</strong></span>
</pre></div></li><li class="listitem" value="4">Log in to Jenkins at <code class="email">https://jenkins-{domain-name}.rhcloud.com/me/configure</code> using the credentials you got in step 1. I recommend that you change the Jenkins password to something that you can easily remember. To<a id="id1010" class="calibre1"/> change the password, enter your new <a id="id1011" class="calibre1"/>password in the <span class="strong"><strong class="calibre7">Password</strong></span> section, and click on the <span class="strong"><strong class="calibre7">Save</strong></span> button:<p class="calibre14"> </p><div class="mediaobject"><img src="../images/00110.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p><p class="calibre14">
</p></li><li class="listitem" value="5">After saving your new password, log out and log in again using the new password. You will be presented with the Jenkins dashboard as shown in the following screenshot:<div class="mediaobject"><img src="../images/00111.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="6">Now that you have created the Jenkins server application, you can add the Jenkins cartridge to the <code class="email">jobstore</code> application. To add the cartridge, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc add-cartridge jenkins --app jobstore</strong></span>
</pre></div></li><li class="listitem" value="7">Go to the Jenkins dashboard at <code class="email">https://jenkins-{domain-name}.rhcloud.com/</code>, and you will see a new job configured for the <code class="email">jobstore</code> application, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00112.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="8">Click on the <span class="strong"><strong class="calibre7">jobstore-build</strong></span> link (<code class="email">https://jenkins-{domain-name}.rhcloud.com/job/jobstore-build/</code>) to view the Jenkins job details.</li><li class="listitem" value="9">To initiate a new <a id="id1012" class="calibre1"/>build, you can either click on the <span class="strong"><strong class="calibre7">Build Now</strong></span> link <a id="id1013" class="calibre1"/>on the left-hand side or make a change to the project source, commit it, and then push the change to the application Git repository. Let's make a small change to our application source code. Change the title in the <code class="email">src/main/webapp/index.html</code> location from <code class="email">&lt;title&gt;JobStore&lt;/title&gt;</code> to <code class="email">&lt;title&gt;JobStore with Jenkins&lt;/title&gt;</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git commit -am "updated title"</strong></span>
<span class="strong"><strong class="calibre7">$ git push</strong></span>
</pre></div></li><li class="listitem" value="10">The <code class="email">git push</code> logs will show that Jenkins is building the project as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">remote: Executing Jenkins build.</strong></span>
<span class="strong"><strong class="calibre7">remote: You can track your build at https://jenkins-xxxx.rhcloud.com/job/jobstore-build</strong></span>
<span class="strong"><strong class="calibre7">remote: </strong></span>
<span class="strong"><strong class="calibre7">remote: Waiting for build to schedule................................Done</strong></span>
<span class="strong"><strong class="calibre7">remote: Waiting for job to complete..............................</strong></span>
</pre></div></li><li class="listitem" value="11">You can view the build logs in the Jenkins web console by clicking on the <span class="strong"><strong class="calibre7">Console Output</strong></span> option as shown in the following screenshot:<div class="mediaobject"><img src="../images/00113.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="12">After the job is <a id="id1014" class="calibre1"/>completed, you will see the build status under <span class="strong"><strong class="calibre7">Build History</strong></span>. The successful builds are shown in blue and failed builds are shown in red.</li><li class="listitem" value="13">You can verify that your changes are applied by opening the application URL in your favorite browser (<code class="email">http://jobstore-{domain-name}.rhcloud.com</code>). You will see that the title has been updated to <span class="strong"><strong class="calibre7">Jobstore with Jenkins</strong></span>.</li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Adding Jenkins CI to your application">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec464" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">One of the powerful<a id="id1015" class="calibre1"/> features of Jenkins is its ability to distribute builds over multiple machines. Jenkins uses the master/slave architecture to manage distributed builds. In the master/slave architecture, there is a Jenkins server whose job is to schedule jobs, dispatch builds to the slave for the actual execution, monitor the slave health, and record and present build results. The slave runs the actual build and shares job results with the master.</p><p class="calibre6">OpenShift uses the Jenkins master/slave architecture to build your applications. You can only have one Jenkins master for an OpenShift domain, and all the applications under that domain will use the Jenkins master for application builds. The Jenkins master, depending on the Jenkins job configuration for that application, will create a slave that will build the application. Every OpenShift Jenkins installation has the OpenShift Jenkins plugin installed. This plugin makes it possible for Jenkins to talk with your OpenShift account and create slaves on your behalf. The Jenkins slaves are nothing more than OpenShift gears.</p><p class="calibre6">In step 1, you created the<a id="id1016" class="calibre1"/> Jenkins master application. You can use the <a id="id1017" class="calibre1"/>master instance to execute jobs directly but, most of the time in the master/slave architecture, slaves are used to build the projects. The Jenkins master created by OpenShift is configured not to run any jobs by setting the number of executors configuration to <code class="email">0</code>. The number of executors lets you define the number of concurrent jobs an instance can run. As the number of executors for the master instance is set to <code class="email">0</code>, you can't use it to build any project. You can set the number of executors to a number greater than <code class="email">0</code> by updating the <span class="strong"><strong class="calibre7"># of executors</strong></span> system configuration value in the Jenkins configuration screen (<code class="email">https://jenkins-{domain-name}.rhcloud.com/configure</code>), as shown in the following screenshot. In the <span class="strong"><em class="calibre10">Using Jenkins to build projects hosted on GitHub</em></span> recipe, you will use the Jenkins master to build the project. Have a look at the following screenshot:</p><div class="mediaobject"><img src="../images/00114.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">Once you have created the Jenkins master application, you can add the Jenkins client to the <code class="email">jobstore</code> application. If you try to add the Jenkins client to an application before creating the Jenkins master, you will get an error message in the <code class="email">rhc add-cartridge</code> command logs.</p><p class="calibre6">In step 5, you added the <a id="id1018" class="calibre1"/>Jenkins client cartridge to the <code class="email">jobstore</code> application. The<a id="id1019" class="calibre1"/> Jenkins client cartridge creates a new Jenkins job for the <code class="email">jobstore</code> project. In Jenkins, a job defines what needs to be done. You can view the job configuration by opening <code class="email">https://jenkins-{domain}.rhcloud.com/job/jobstore-build/configure</code> in your favorite browser. </p><p class="calibre6">The job configuration can be divided into three sections: builder configuration, source code management configuration, and build configuration.</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre7">Builder configuration</strong></span>: The <a id="id1020" class="calibre1"/>configuration values shown in the<a id="id1021" class="calibre1"/> following screenshot will be used to create a slave. The configuration says that it needs a builder slave with a small gear size of type <code class="email">redhat-jbosseap-6</code>. This means the slave gear will have a JBoss EAP 6 cartridge installed. It also defines a timeout for which the Jenkins master will wait for the slave to come online. The default builder timeout is <code class="email">5</code> minutes or <code class="email">300000</code> milliseconds. The <span class="strong"><strong class="calibre7">Restrict where this project can be run</strong></span> configuration defines that this project will only be built on the slave with the label <code class="email">jobstore-build</code>. As you might have probably noticed, the name of the label is the same as the name of the job. The OpenShift Jenkins plugin uses the label name to read the job configuration and creates a slave using the builder configuration of the job. So, if you change the name of the label from <code class="email">jobstore-build</code> to <code class="email">jobstore-os-build</code>, then the Jenkins plugin will not be able to find the associated job configuration, and the job will not be executed.<div class="mediaobject"><img src="../images/00115.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem"><span class="strong"><strong class="calibre7">Git configuration</strong></span>: The next<a id="id1022" class="calibre1"/> important configuration is the <a id="id1023" class="calibre1"/>Git version control configuration. This configuration specifies the application Git repository URL. The Jenkins job will clone this Git repository using the specified Git repository URL and build this project. The following screenshot shows the Git configuration:<div class="mediaobject"><img src="../images/00116.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem"><span class="strong"><strong class="calibre7">Build configuration</strong></span>: This is the<a id="id1024" class="calibre1"/> most important part of our job <a id="id1025" class="calibre1"/>configuration. It defines what needs to be done. The job configuration is shown in the following screenshot. The configuration does the following:<div class="book"><ol class="orderedlist1"><li class="listitem" value="1">It downloads the contents from the actual application to the builder application using Git and <code class="email">rsync</code>.</li><li class="listitem" value="2">If the <code class="email">force_clean_build</code> marker is not present, then it also copies the content of the <code class="email">$OPENSHIFT_BUILD_DEPENDENCIES_DIR</code> and <code class="email">$OPENSHIFT_DEPENDENCIES_DIR</code> directories from the actual application to the builder application. When the <code class="email">force_clean_build</code> marker is present, then the dependencies are downloaded again on the builder application, and the build will take more time to finish.</li><li class="listitem" value="3">Then, it builds the application using whatever build commands the cartridge uses. For Java applications, it will use the <code class="email">mvn clean install –Popenshift –DskipTests</code> command.</li><li class="listitem" value="4">After the build finishes successfully, it stops the application gear.</li><li class="listitem" value="5">Then Jenkins copies the new content from the builder application to the actual application using <code class="email">rsync</code>.</li><li class="listitem" value="6">Finally, it starts the application. Have a look at the following screenshot:</li></ol><div class="calibre13"/></div><div class="mediaobject"><img src="../images/00117.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre12"> </p></li></ul></div><p class="calibre6">If you don't have <a id="id1026" class="calibre1"/>Jenkins enabled in your application, then the code<a id="id1027" class="calibre1"/> is built on the same gear on which the application is running. When you push changes to your application gear, OpenShift first stops your application, builds the application, deploys the artifact, and finally starts the application.</p><p class="calibre6">In step 8, after adding the Jenkins cartridge to the <code class="email">jobstore</code> application, you made a change to the source code and pushed changes to the application gear. This time, rather than building the project on the application gear, the Jenkins server launches a slave and initiates the build. The process is explained in detail in the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">The user makes a change and pushes the changes to the application gear using the <code class="email">git push</code> command.</li><li class="listitem" value="2">After receiving the bits, a Git action hook is called that notifies the Jenkins server.</li><li class="listitem" value="3">The Jenkins server creates a dedicated Jenkins slave (builder) to build this project. You can see the new gear created by Jenkins using the <code class="email">rhc apps</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">jobstorebldr @ http://jobstorebldr-xxxx.rhcloud.com/ (uuid: 539b660ce0b8cdeba00000e1)</strong></span>
<span class="strong"><strong class="calibre7">----------------------------------------------------------------------------------------</strong></span>
<span class="strong"><strong class="calibre7">Domain:     xxxx</strong></span>
<span class="strong"><strong class="calibre7">Created:    2:28 AM</strong></span>
<span class="strong"><strong class="calibre7">Gears:      1 (defaults to small)</strong></span>
<span class="strong"><strong class="calibre7">Git URL:    ssh://539b660ce0b8cdeba00000e1@jobstorebldr-xxxx.rhcloud.com/~/git/jobstorebldr.git/</strong></span>
<span class="strong"><strong class="calibre7">SSH:        539b660ce0b8cdeba00000e1@jobstorebldr-xxxx.rhcloud.com</strong></span>
<span class="strong"><strong class="calibre7">Deployment: auto (on git push)</strong></span>

<span class="strong"><strong class="calibre7">jbosseap-6 (JBoss Enterprise Application Platform 6)</strong></span>
<span class="strong"><strong class="calibre7">----------------------------------------------------</strong></span>
<span class="strong"><strong class="calibre7">Gears: 1 small</strong></span>
</pre></div></li><li class="listitem" value="4">Jenkins runs the build using the steps mentioned in the build configuration section. After a successful build, the build artifact is copied to the application gear using the <code class="email">rsync</code> tool, as mentioned in the build configuration.</li><li class="listitem" value="5">Jenkins starts the application after a successful build and then archives the build artifact that you can use later.</li><li class="listitem" value="6">After 15 minutes of idle time, the Jenkins builder is destroyed and will no longer show up in the <code class="email">rhc apps</code> command-line output. The build artifacts, however, will still exist in Jenkins and can be viewed there.</li></ol><div class="calibre13"/></div><p class="calibre6">Using Jenkins with your OpenShift <a id="id1028" class="calibre1"/>application has the following advantages:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre7">No application downtime in case of build failure</strong></span>: Without Jenkins' support, OpenShift runs the build on the same gear on which your application is running. It first stops all the cartridges on the application gear, runs the build, and finally deploys the successful build artifact. In the event of build failure, the build artifact will not be deployed and your application will have downtime. With CI enabled for your application, OpenShift stops the application only after the build finishes successfully. This avoids downtime due to build failures.</li><li class="listitem"><span class="strong"><strong class="calibre7">More resources to build your project</strong></span>: As the Jenkins builders run on separate gears, they have additional resources, such as memory and storage, to run your application build.</li><li class="listitem"><span class="strong"><strong class="calibre7">Store previous builds</strong></span>: Jenkins can store your previous successful build artifacts for you. You can use these build artifacts if you want to roll back to a previous version.</li><li class="listitem"><span class="strong"><strong class="calibre7">Jenkins plugins</strong></span>: Jenkins has a strong and active community that has built a variety of plugins to perform various common tasks. You can use these plugins to automate various tasks of your application. Throughout this chapter, you will install various Jenkins plugins to do various tasks.</li></ul></div><p class="calibre6">You can view the logs of your<a id="id1029" class="calibre1"/> Jenkins server using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc tail --app jenkins</strong></span>
</pre></div></div></div>

<div class="book" title="Adding Jenkins CI to your application">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch10lvl2sec465" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre6">You can also enable Jenkins support at application creation time<a id="id1030" class="calibre1"/> using the <code class="email">--enable-jenkins</code> option as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jobstore jbosseap postgresql-9.2 --from-code https://github.com/OpenShift-Cookbook/chapter7-jobstore-javaee6.git --enable-jenkins</strong></span>
</pre></div><p class="calibre6">The preceding command will create the Jenkins server application and add the Jenkins client to the application. If the Jenkins server application already exists, then it only adds the <code class="email">jenkins</code> client cartridge to the application.</p></div></div>

<div class="book" title="Adding Jenkins CI to your application">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch10lvl2sec466" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Increasing the slave idle timeout</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Installing Jenkins plugins</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Creating a Jenkins workflow for your OpenShift applications</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Increasing the slave idle timeout"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10lvl1sec120" class="calibre1"/>Increasing the slave idle timeout</h1></div></div></div><p class="calibre6">The Jenkins master creates<a id="id1031" class="calibre1"/> slaves to build the project. These slaves remain alive only for 15 minutes after building the project, that is, they will be reused only if the next build request is received within 15 minutes of finishing the first build. If they don't receive the build request in 15 minutes after building the project, then the Jenkins master will kill the slave instance. The next build request will again create a new slave and build the application on it. Slave creation is a time-consuming process and is not ideal during the development cycle, when you expect quick feedback from your CI server.</p><p class="calibre6">In this recipe, you will learn how to increase the slave idle timeout so that you can reuse the slave for a longer time and get quick feedback from the CI server.</p></div>

<div class="book" title="Increasing the slave idle timeout">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec467" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe assumes that you already have a Jenkins-enabled application, as discussed in the <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe.</p></div></div>

<div class="book" title="Increasing the slave idle timeout">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec468" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log in to your Jenkins dashboard, and then go to the Jenkins configuration page at <code class="email">https://jenkins-{domain-name}.rhcloud.com/configure</code>.</li><li class="listitem" value="2">Under the <span class="strong"><strong class="calibre7">Cloud</strong></span> configuration section, there is a <span class="strong"><strong class="calibre7">Slave Idle Time to Live</strong></span> configuration as shown in the following screenshot. The default configuration is 15 minutes.<div class="mediaobject"><img src="../images/00118.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="3">Update the <span class="strong"><strong class="calibre7">Slave Idle Time To Live</strong></span> value to <code class="email">60</code> minutes, and save the configuration by clicking on the <span class="strong"><strong class="calibre7">Save</strong></span> button.</li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Increasing the slave idle timeout">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec469" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">The Jenkins master<a id="id1032" class="calibre1"/> created by OpenShift comes bundled with a few plugins that Jenkins needs to work effectively. You can see all the installed plugins by navigating to <span class="strong"><strong class="calibre7">Plugin Manager</strong></span> | <span class="strong"><strong class="calibre7">Installed</strong></span> as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00119.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">The plugin that makes it possible for Jenkins to talk with your OpenShift account is <span class="strong"><strong class="calibre7">OpenShift Origin Jenkins Cloud Plugin</strong></span>. This plugin is responsible for managing the slave gears that build your application.</p><p class="calibre6">Most of the Jenkins plugins have global configuration and job-level configuration. Global configuration applies to all the Jenkins jobs, whereas the job-level configuration applies only to a particular Jenkins job. You can view the Jenkins global configuration by navigating to the <span class="strong"><strong class="calibre7">Configure System</strong></span> screen at <code class="email">https://jenkins-{domain-name}.rhcloud.com/configure</code>. Many plugins that you will install will also need to be configured here. Jenkins dynamically adds new fields when you install the plugins.</p><p class="calibre6">The default screen<a id="id1033" class="calibre1"/> contains a number of sections to configure either a general, system-wide parameter or various plugin configurations. The OpenShift Jenkins plugin adds the <span class="strong"><strong class="calibre7">OpenShift Cloud</strong></span> subsection under the <span class="strong"><strong class="calibre7">Cloud</strong></span> section. This configuration is used to talk with your OpenShift account and create slaves required to build your application.</p><p class="calibre6">In the preceding steps, you increased the slave idle timeout to 60 minutes in the OpenShift <span class="strong"><strong class="calibre7">Cloud</strong></span> configuration section. This is the maximum slave idle timeout that you can assign to the slave. The next slave that Jenkins will create will use this configuration and will be alive for 60 minutes after building the project.</p></div></div>

<div class="book" title="Increasing the slave idle timeout">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch10lvl2sec470" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Installing Jenkins plugins</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Creating a Jenkins workflow for your OpenShift applications</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Installing Jenkins plugins"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10lvl1sec121" class="calibre1"/>Installing Jenkins plugins</h1></div></div></div><p class="calibre6">The extensible <a id="id1034" class="calibre1"/>architecture of Jenkins makes it very powerful. There are<a id="id1035" class="calibre1"/> third-party plugins that enable you to add extra features to your Jenkins instance. These features enable you to work with different SCM tools, such as Git, to generate code quality and code coverage reports, or to automate other manual tasks, such as database schema migration, and so on. In this recipe, you will learn how you can install the Green Balls plugin<a id="id1036" class="calibre1"/> (<a class="calibre1" href="https://wiki.jenkins-ci.org/display/JENKINS/Green+Balls">https://wiki.jenkins-ci.org/display/JENKINS/Green+Balls</a>) to your OpenShift Jenkins instance. The Green Balls plugin makes Jenkins use green balls instead of blue balls for successful builds.</p></div>

<div class="book" title="Installing Jenkins plugins">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec471" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe assumes you already have a Jenkins-enabled application, as discussed in the <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe.</p></div></div>

<div class="book" title="Installing Jenkins plugins">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec472" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to install a plugin:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log in to your OpenShift Jenkins dashboard and go to the <span class="strong"><strong class="calibre7">Manage Jenkins</strong></span> screen at <code class="email">https://jenkins-{domain-name}.rhcloud.com/manage</code>. The <span class="strong"><strong class="calibre7">Manage Jenkins</strong></span> screen is a central place where you can configure all the aspects of the Jenkins system configuration.</li><li class="listitem" value="2">Next, click on <span class="strong"><strong class="calibre7">Manage Plugins</strong></span> to work with Jenkins plugins. You can install, remove, or update plugins through the <span class="strong"><strong class="calibre7">Manage Plugins</strong></span> screen. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00120.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="3">The <span class="strong"><strong class="calibre7">Manage Plugins</strong></span> screen is divided into four tabs: <span class="strong"><strong class="calibre7">Updates</strong></span>, <span class="strong"><strong class="calibre7">Available</strong></span>, <span class="strong"><strong class="calibre7">Installed</strong></span>, and <span class="strong"><strong class="calibre7">Advanced</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00121.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p><p class="calibre14">The <a id="id1037" class="calibre1"/>
<span class="strong"><strong class="calibre7">Updates</strong></span> tab shows all the installed <a id="id1038" class="calibre1"/>plugins that have updates, the <span class="strong"><strong class="calibre7">Available</strong></span> tab shows all the plugins that you can install on your Jenkins instance, the <span class="strong"><strong class="calibre7">Installed</strong></span> tab shows all the plugins that are already installed on your Jenkins instance, and the <span class="strong"><strong class="calibre7">Advanced</strong></span> tab allows you to manually install the plugin or force Jenkins to check for updates.</p></li><li class="listitem" value="4">All the Jenkins plugins available in the Jenkins plugin registry are shown in the <span class="strong"><strong class="calibre7">Available</strong></span> tab. If you click on the <span class="strong"><strong class="calibre7">Available</strong></span> tab, you will find that the list is empty. To enable Jenkins to show plugins under the <span class="strong"><strong class="calibre7">Available</strong></span> tab, navigate to <span class="strong"><strong class="calibre7">Manage Plugins</strong></span> | <span class="strong"><strong class="calibre7">Advanced</strong></span>, and click on the <span class="strong"><strong class="calibre7">Check Now</strong></span> button, as shown in the following screenshot, to forcefully check for new updates:<div class="mediaobject"><img src="../images/00122.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="5">Once done, you <a id="id1039" class="calibre1"/>will see a list of plugins available under the <span class="strong"><strong class="calibre7">Available</strong></span> tab.</li><li class="listitem" value="6">To install the Green <a id="id1040" class="calibre1"/>Balls plugin, filter the available plugins, and then click on <span class="strong"><strong class="calibre7">Install without restart</strong></span>. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00123.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="7">After the plugin is installed, you will see the Green Balls plugin in action. Please clean your browser cache if you still see blue balls.<div class="mediaobject"><img src="../images/00124.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Installing Jenkins plugins">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec473" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In the preceding <a id="id1041" class="calibre1"/>steps, you installed the Green Balls plugin to your <a id="id1042" class="calibre1"/>OpenShift Jenkins instance. The Green Balls plugin does what it says: it makes successful builds display as green balls instead of the default blue balls.</p><p class="calibre6">There are a couple of ways to install plugins to your Jenkins instance. You can either use the automatic method or the manual method. In the preceding steps, you used the automatic method to install the plugins. The automatic method works for plugins that are listed in the Jenkins central plugins registry<a id="id1043" class="calibre1"/> available at <a class="calibre1" href="http://updates.jenkins-ci.org/download/plugins/">http://updates.jenkins-ci.org/download/plugins/</a>. The plugins that are not available in the central plugin registry need to be installed manually. To install a plugin manually, navigate to <span class="strong"><strong class="calibre7">Manage Jenkins</strong></span> | <span class="strong"><strong class="calibre7">Manage Plugins</strong></span> | <span class="strong"><strong class="calibre7">Advance</strong></span>. In the <span class="strong"><strong class="calibre7">Advanced</strong></span> tab, there is a section called <span class="strong"><strong class="calibre7">Upload Plugin</strong></span> that you can use to upload your plugin. Click on the <span class="strong"><strong class="calibre7">Choose File</strong></span> button, select the plugin from your local machine, and then click on the <span class="strong"><strong class="calibre7">Upload</strong></span> button to upload the plugin:</p><div class="mediaobject"><img src="../images/00125.jpeg" alt="How it works…" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre6">The manually installed plugins are not installed until you restart Jenkins. So, once the plugin is uploaded, restart Jenkins by going to <code class="email">https://jenkins-{domain-name}.rhcloud.com/safeRestart</code>. This will restart Jenkins after the current builds have been completed and will install your plugin.</p></div></div>

<div class="book" title="Installing Jenkins plugins">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch10lvl2sec474" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Using Jenkins to build projects hosted on GitHub</em></span> recipe</li><li class="listitem">The <span class="strong"><em class="calibre10">Creating a Jenkins workflow for your OpenShift applications</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using Jenkins to build projects hosted on GitHub"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10lvl1sec122" class="calibre1"/>Using Jenkins to build projects hosted on GitHub</h1></div></div></div><p class="calibre6">You can use the OpenShift Jenkins instance to build your non-OpenShift projects as well. This recipe will use a Maven-based project publicly hosted on GitHub<a id="id1044" class="calibre1"/> at <a class="calibre1" href="https://github.com/OpenShift-Cookbook/chapter10-demo-app">https://github.com/OpenShift-Cookbook/chapter10-demo-app</a>. The goal of this recipe is to build the project whenever you push code to the GitHub repository and send an e-mail in case the build status changes, that is, the build fails or recovers from a build failure. This is the first step an organization takes when they try to introduce CI.</p></div>

<div class="book" title="Using Jenkins to build projects hosted on GitHub">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec475" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe assumes that you <a id="id1045" class="calibre1"/>already have a Jenkins-enabled application, as discussed in the <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe.</p></div></div>

<div class="book" title="Using Jenkins to build projects hosted on GitHub">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec476" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to learn how to build projects hosted on GitHub:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">In this recipe, we will use the Jenkins master to build the project. Go to <code class="email">https://jenkins-{domain-name}.rhcloud.com/configure</code>, and update the <span class="strong"><strong class="calibre7"># of executors</strong></span> property to <code class="email">1</code>. Any number greater than <code class="email">0</code> will allow the master to run build jobs. Also, change the <span class="strong"><strong class="calibre7">Usage</strong></span> field value to <span class="strong"><strong class="calibre7">Leave this machine for tied jobs only</strong></span>. This configuration will make sure that the master instance is only used for the job explicitly configured to run on the master. Later in the job configuration, you will configure a job to run only on the master. Click on the <span class="strong"><strong class="calibre7">Save</strong></span> button to save the new values:<div class="mediaobject"><img src="../images/00126.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="2">One of the goals of<a id="id1046" class="calibre1"/> this recipe is to send e-mails when the project becomes unstable. To allow Jenkins to send an e-mail, you have to provide e-mail settings in the <span class="strong"><strong class="calibre7">E-mail Notification</strong></span> section under the Jenkins <span class="strong"><strong class="calibre7">Configure System</strong></span> screen. Click on the <span class="strong"><strong class="calibre7">Advanced</strong></span> tab to see all the configuration options. The configuration shown in the following screenshot uses Gmail to send e-mails. Gmail is shown just for demonstration here. Google might send you an e-mail stating that someone is hacking your account, as your account is accessed from a different location than it is usually used. Ideally, you should use your organization SMTP server configuration.<div class="mediaobject"><img src="../images/00127.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="3">You can also send a test e-mail to check the configuration. Check the <span class="strong"><strong class="calibre7">Test</strong></span> configuration by sending a test e-mail checkbox and providing it with the e-mail address you want to send an e-mail to. You will receive an e-mail like the one shown in the following screenshot:<div class="mediaobject"><img src="../images/00128.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="4">One thing that you will find annoying in the preceding screenshot is that the address is not configured yet in the from section of the e-mail. You can configure it to something else by updating the value of the <span class="strong"><strong class="calibre7">System Admin e-mail address</strong></span> property from <span class="strong"><strong class="calibre7">address not configured yet</strong></span> to something user friendly, as shown in the following screenshot. After making this change, the notification e-mails <a id="id1047" class="calibre1"/>from Jenkins will be sent with this address in the from header.<div class="mediaobject"><img src="../images/00129.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="5">Fork the GitHub repository (<a class="calibre1" href="https://github.com/OpenShift-Cookbook/chapter10-demo-app">https://github.com/OpenShift-Cookbook/chapter10-demo-app</a>) by clicking on the <span class="strong"><strong class="calibre7">Fork</strong></span> button. You need to log in to GitHub with a valid account before you can fork this repository. You have to fork this repository so that you can push your changes to the repository.</li><li class="listitem" value="6">Go to your Jenkins dashboard, and click on <span class="strong"><strong class="calibre7">New Job</strong></span>. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00130.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="7">Select the <span class="strong"><strong class="calibre7">Build a free-style software project</strong></span> build type, and give it a name, <code class="email">chapter10-github-recipe-build</code>, as shown in the following screenshot. Click on <span class="strong"><strong class="calibre7">OK</strong></span> to create the job.<div class="mediaobject"><img src="../images/00131.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="8">Next, you will be<a id="id1048" class="calibre1"/> shown the job configuration page where you can configure this job. The first configuration that you will update is under the <span class="strong"><strong class="calibre7">Source Code Management</strong></span> section. As the project is hosted on GitHub, enter the URL of the GitHub repository that you want to build. The GitHub repository URL will be <code class="email">https://github.com/&lt;username&gt;/chapter10-demo-app.git</code>. The username corresponds to your GitHub username. The following screenshot shows the <span class="strong"><strong class="calibre7">Source Code Management</strong></span> section:<div class="mediaobject"><img src="../images/00132.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="9">Next, you have to <a id="id1049" class="calibre1"/>configure when this build should get triggered. This is configured under the <span class="strong"><strong class="calibre7">Build Triggers</strong></span> section. In the configuration shown in the following screenshot, you told Jenkins to poll SCM every minute. It uses the same syntax as <code class="email">crontab</code> on Unix/Linux.<div class="mediaobject"><img src="../images/00133.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="10">Now that the Jenkins job knows from where and how often to get the source code, the next step is to tell the job what to do with the source code. This is achieved by defining the build steps. A job can have one or more build steps. To add a new build step, click on the <span class="strong"><strong class="calibre7">Add build step</strong></span> dropdown, and select <span class="strong"><strong class="calibre7">Execute shell</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00134.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="11">This will render a text area where you can enter the command you want to run. Enter the <code class="email">mvn clean install</code> command in the text area.</li><li class="listitem" value="12">The next configuration that you can optionally specify in your job is what to do after building your project. This is defined by creating one or more post-build actions. Let's add an action that will send an e-mail when the build becomes unstable. Click on the <span class="strong"><strong class="calibre7">Add post-build action</strong></span> drop-down list, and then select <span class="strong"><strong class="calibre7">E-mail notification</strong></span>. In the <span class="strong"><strong class="calibre7">Recipients</strong></span> textbox, provide a whitespace-separated list of e-mail IDs that you want to send an e-mail to in the event of a build failure, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00135.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="13">The last <a id="id1050" class="calibre1"/>configuration left before you can save this job is to configure it to run on the master node. This is done by checking the <span class="strong"><strong class="calibre7">Restrict where this project can be run</strong></span> checkbox and then giving it the name of the node that should be used to build the project, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00136.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="14">Now, save the configuration by clicking on the <span class="strong"><strong class="calibre7">Save</strong></span> button.</li><li class="listitem" value="15">To test the new Jenkins job, first clone the project on your local machine. To clone the project, use the following command. Please replace the username with your GitHub account username.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git clone git@github.com:&lt;username&gt;/chapter10-demo-app.git</strong></span>
</pre></div></li><li class="listitem" value="16">To test whether the job is working correctly, let's change one of the test cases so that it fails. Update the <code class="email">MessageRepositoryTest</code> assertion from <code class="email">assertEquals(1, messages.size());</code> to <code class="email">assertEquals(2, messages.size());</code>.</li><li class="listitem" value="17">Commit the code, and push the changes to your GitHub repository:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git commit -am "added test failure"</strong></span>
<span class="strong"><strong class="calibre7">$ git push</strong></span>
</pre></div></li><li class="listitem" value="18">Jenkins will pick the change and start a new build. The build will fail, and you will receive an e-mail with the job logs.</li><li class="listitem" value="19">Now, let's fix the build failure by reverting the change from <code class="email">assertEquals(2, messages.size());</code> to <code class="email">assertEquals(1, messages.size());</code>. Then run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git commit -am "fixed test failure"</strong></span>
<span class="strong"><strong class="calibre7">$ git push</strong></span>
</pre></div></li><li class="listitem" value="20">Again, Jenkins <a id="id1051" class="calibre1"/>will pick the change and start a new build. This time, you will receive an e-mail saying that the build is back to normal, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00137.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Using Jenkins to build projects hosted on GitHub">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec477" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">You created a freestyle Jenkins job that will poll Jenkins every minute and, if it detects a new commit, it will build the project. In step 1, you updated the Jenkins master configuration so that it can run build jobs. By default, the Jenkins master is not configured to run any builds. Setting the number of executors to <code class="email">1</code> in the Jenkins system configuration enables the Jenkins master to run builds. The number of executors lets you define how many concurrent builds a Jenkins instance can perform.</p><p class="calibre6">E-mail is one of the most popular ways of communication. In step 2, you configured Jenkins to send an e-mail using the Gmail SMTP settings. You can send 99 e-mails per day using the Gmail SMTP server, which is fine for most individual projects, but for your organization projects, you should use your organization SMTP server.</p><p class="calibre6">This recipe requires you to have your own Git repository that will be polled by Jenkins. This is required so that you can push changes to your Git repository, as you can't push changes to the Git repository of another person unless you are added as a collaborator. You forked the repository in step 3 so that you have your own copy of this repository that you can work with.</p><p class="calibre6">In step 4, you created a new Jenkins job that will be used to build the project you forked in step 3. You used a freestyle build job, as it is the most flexible build option that you can use to build any type of project.</p><p class="calibre6">From steps 5 through<a id="id1052" class="calibre1"/> step 9, you configured the job so that Jenkins polls the Git repository every minute and uses the Jenkins master to build the project. After saving the job in step 10, you will see your new job listed in the Jenkins dashboard. Jenkins will automatically run the build for the first time, as it does not have any history for this job. After running the job for the first time, Jenkins will wait for the changes in your Git repository before it starts another build.</p><p class="calibre6">Once the job was configured, you tested the Jenkins job in steps 11 through 15 by making a change to your local repository and pushing the change to GitHub. Jenkins will poll the Git repository in the next one minute, detect the change, and start the build.</p></div></div>

<div class="book" title="Using Jenkins to build projects hosted on GitHub">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch10lvl2sec478" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Creating a Jenkins workflow for your OpenShift applications</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a Jenkins workflow for your OpenShift applications"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10lvl1sec123" class="calibre1"/>Creating a Jenkins workflow for your OpenShift applications</h1></div></div></div><p class="calibre6">In this recipe, you will create a Jenkins workflow that you could use to build and deploy applications on OpenShift.</p></div>

<div class="book" title="Creating a Jenkins workflow for your OpenShift applications">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec479" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe will cover all the steps<a id="id1053" class="calibre1"/> from the start to make<a id="id1054" class="calibre1"/> sure you have all the three gears available.</p></div></div>

<div class="book" title="Creating a Jenkins workflow for your OpenShift applications">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec480" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps to create a Jenkins workflow for your OpenShift applications:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a new Jenkins server application by running the following command. This was covered in detail in the <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app jenkins jenkins</strong></span>
</pre></div></li><li class="listitem" value="2">Create an OpenShift Apache Tomcat 7 application that will be used to deploy the project. The project will be created with the <code class="email">--no-git</code> option, as we do not want to clone the repository, because the code will be hosted on GitHub. The <code class="email">--enable-jenkins</code> option will create a new Jenkins job that will build and deploy the application on OpenShift:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc create-app forumapp tomcat-7 postgresql-9 --enable-jenkins --no-git</strong></span>
</pre></div></li><li class="listitem" value="3">Log in to your Jenkins dashboard, and you will see the <span class="strong"><strong class="calibre7">forumapp-build</strong></span> job listed on the dashboard.</li><li class="listitem" value="4">Create a new Jenkins job with the name <code class="email">forumapp-github-build</code> by following the steps mentioned in the <span class="strong"><em class="calibre10">Using Jenkins to build projects hosted on GitHub</em></span> recipe. Once the job is created, any change pushed to your GitHub repository will result in a Jenkins build.</li><li class="listitem" value="5">Next, install the Jenkins Cobertura plugin by following the instructions mentioned in the <span class="strong"><em class="calibre10">Installing Jenkins plugins</em></span> recipe.</li><li class="listitem" value="6">Once the plugin is<a id="id1055" class="calibre1"/> installed, create<a id="id1056" class="calibre1"/> another job with the name <code class="email">forumapp-quality-build</code>. But, rather than creating a job from the start, you can use the <code class="email">forumapp-github-build</code> job as a template. After entering the details, click on <span class="strong"><strong class="calibre7">OK</strong></span>:<div class="mediaobject"><img src="../images/00138.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="7">You will be directed to the <code class="email">forumapp-quality-build</code> job configuration page. Update the following configuration values to suit this job:<div class="book"><ol class="orderedlist1"><li class="listitem" value="1">Change the <span class="strong"><strong class="calibre7">Restrict this project can be run</strong></span> value from <code class="email">master</code> to <code class="email">forumapp-build</code>.</li><li class="listitem" value="2">Uncheck <span class="strong"><strong class="calibre7">Poll SCM</strong></span> under the <span class="strong"><strong class="calibre7">Build Triggers</strong></span> section.</li><li class="listitem" value="3">Change the <span class="strong"><strong class="calibre7">Execute Shell</strong></span> command from <code class="email">mvn clean install</code> to <code class="email">mvn clean package -Pquality</code>.</li></ol><div class="calibre13"/></div></li><li class="listitem" value="8">Now, you need to add two post-build actions to <code class="email">forumapp-quality-build</code>, first to kick the <code class="email">forumapp-build</code> job that will deploy the application to OpenShift and, second, publish the Cobertura code coverage report. Add the post-build action to trigger <code class="email">forumapp-build</code> when the build succeeds. To add the Cobertura code coverage post-build action, click on the <span class="strong"><strong class="calibre7">Add post-build action hook</strong></span> option, select <span class="strong"><strong class="calibre7">Publish Cobertura Coverage Report</strong></span>, and provide <code class="email">**/ target/site/cobertura/coverage.xml</code> for the <span class="strong"><strong class="calibre7">Cobertura xml report pattern</strong></span> field.</li><li class="listitem" value="9">After updating the <code class="email">forumapp-quality-build</code> job configuration, click on the <span class="strong"><strong class="calibre7">Save</strong></span> button.</li><li class="listitem" value="10">One of the<a id="id1057" class="calibre1"/> responsibilities<a id="id1058" class="calibre1"/> of <code class="email">forumapp-github-build</code> is to start the <code class="email">forumapp-quality-build</code> job after it has been completed successfully. Update the <code class="email">forumapp-github-build</code> job configuration by adding a post-build action. Add the <span class="strong"><strong class="calibre7">Build other projects</strong></span> post-build action to build <code class="email">forumapp-github-build</code> when the build is successful. Click on the <span class="strong"><strong class="calibre7">Save</strong></span> button after adding the post-build action:<div class="mediaobject"><img src="../images/00139.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="11">Now that you have configured the <code class="email">forumapp-github-build</code> and <code class="email">forumapp-quality-build</code> jobs, you need to update the <code class="email">forumapp-build</code> job configuration to pull the code from the GitHub repository and deploy the latest code to OpenShift. Go to <code class="email">https://jenkins-{domain-name}.rhcloud.com/job/forumapp-build/configure</code>, and add a new <span class="strong"><strong class="calibre7">Execute Shell</strong></span> build step. This build step will first add a Git remote to the GitHub repository and then pull code from the GitHub repository. This is shown in the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ git remote add upstream -m master https://github.com/&lt;username&gt;/chapter10-demo-app.git</strong></span>
<span class="strong"><strong class="calibre7">$ git pull -s recursive -X theirs upstream master</strong></span>
</pre></div></li><li class="listitem" value="12">Please replace the username with your GitHub account username. Also, make sure that the order of the build action hooks is the same as the order shown in the following screenshot:<div class="mediaobject"><img src="../images/00140.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="13">Click on the <span class="strong"><strong class="calibre7">Save</strong></span> button to save the configuration.</li><li class="listitem" value="14">Now, to test <a id="id1059" class="calibre1"/>whether all our <a id="id1060" class="calibre1"/>jobs are configured properly, go to the Jenkins dashboard and manually start the <code class="email">forumapp-github-build</code> job. Instead of manually starting the job, you could also make a change to the application source and push the change to the GitHub repository. Jenkins will detect the change and start the build process.</li><li class="listitem" value="15">After all the builds are successfully completed, you will see all the builds in a healthy state on the Jenkins dashboard, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00141.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="16">To view the<a id="id1061" class="calibre1"/> code coverage of your <a id="id1062" class="calibre1"/>project, go to the <span class="strong"><strong class="calibre7">forumapp-quality-build</strong></span> page, and click on <span class="strong"><strong class="calibre7">Coverage Report</strong></span> to see the code coverage of your project:<div class="mediaobject"><img src="../images/00142.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Creating a Jenkins workflow for your OpenShift applications">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec481" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">In the preceding steps, you created a simple workflow with three Jenkins jobs, each responsible for a specific task. The first job polls the GitHub repository at a specified interval for code changes and then builds the project when the changes are found. This job builds the project and runs its unit tests. It used the Jenkins master to build the project. The advantage of using Jenkins for light jobs like this is that you don't have to wait for the slave creation. You should only use the master for jobs that are light in nature; otherwise, the Jenkins master might go down.</p><p class="calibre6">The first build, if <a id="id1063" class="calibre1"/>successful, starts the <a id="id1064" class="calibre1"/>quality job that runs the code coverage over the application code. This build uses Cobertura<a id="id1065" class="calibre1"/> (<a class="calibre1" href="http://cobertura.github.io/cobertura/">http://cobertura.github.io/cobertura/</a>) to identify the parts of the Java application that lack test coverage. The quality build was configured to execute the <code class="email">mvn clean install -Pquality</code> command. This command will run the Maven Cobertura plugin. The Maven plugin will generate both HTML and XML reports. The XML report is used by Jenkins to parse the coverage results. The quality build will use the Jenkins slave instead of the master, as a quality build usually tends to be memory- and CPU-intensive, and you will not like the master going down because of one job.</p><p class="calibre6">On successful completion of the quality build, the third Jenkins job will deploy the application to OpenShift. This job will also use the Jenkins slave.</p></div></div>

<div class="book" title="Creating a Jenkins workflow for your OpenShift applications">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch10lvl2sec482" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Upgrading Jenkins to the latest version</em></span> recipe</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Upgrading Jenkins to the latest version"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch10lvl1sec124" class="calibre1"/>Upgrading Jenkins to the latest version</h1></div></div></div><p class="calibre6">The Jenkins application<a id="id1066" class="calibre1"/> created by OpenShift runs an old version of Jenkins. At the time of this writing, the Jenkins application created by OpenShift runs the 1.509.1 Version. This version is quite old, and some Jenkins plugins do not work with this version. In this recipe, you will learn how to upgrade Jenkins to the latest version. The latest version of Jenkins at the time of this writing is 1.567.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note34" class="calibre1"/>Note</h3><p class="calibre6">This recipe is experimental, and I don't recommend that people use it for their production Jenkins instances. The aim of this recipe is to show that it is feasible to upgrade the Jenkins version. This might result in build data loss or a break in the Jenkins instance. So, use this recipe in your test environments first.</p></div></div>

<div class="book" title="Upgrading Jenkins to the latest version">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch10lvl2sec483" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre6">This recipe assumes you already have a Jenkins-enabled application, as discussed in the <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe.</p></div></div>

<div class="book" title="Upgrading Jenkins to the latest version">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch10lvl2sec484" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre6">Perform the following steps <a id="id1067" class="calibre1"/>to upgrade the Jenkins version:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open a new command-line terminal, and SSH into your Jenkins application by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">$ rhc ssh --app jenkins</strong></span>
</pre></div></li><li class="listitem" value="2">Create a new directory called <code class="email">jenkins-latest-version</code> inside <code class="email">$OPENSHIFT_DATA_DIR</code>, and download the latest Jenkins WAR file using <code class="email">wget</code> by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">cd $OPENSHIFT_DATA_DIR &amp;&amp; mkdir jenkins-latest-version &amp;&amp; cd jenkins-latest-version &amp;&amp; wget http://mirrors.jenkins-ci.org/war/latest/jenkins.war</strong></span>
</pre></div></li><li class="listitem" value="3">Exit the SSH session by typing the <code class="email">exit</code> command.</li><li class="listitem" value="4">Create two environment variables by running the following command. Please replace <code class="email">$OPENSHIFT_DATA_DIR</code> with your Jenkins application's <code class="email">$OPENSHIFT_DATA_DIR</code> environment variable value:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre7">rhc env-set JENKINS_WAR_PATH=$OPENSHIFT_DATA_DIR/jenkins-latest-version/jenkins.war JENKINS_JAR_CACHE_PATH="~/app-root/data/.jenkins/cache/jars" --app jenkins</strong></span>
</pre></div></li><li class="listitem" value="5">Go to the Jenkins plugin manager, and uninstall the OpenShift Jenkins plugin. Restart Jenkins after uninstalling the plugin for the changes to take effect. You can restart Jenkins by going to the <code class="email">https://jenkins-{domain-name}.rhcloud.com/safeRestart</code> URL.</li><li class="listitem" value="6">After the Jenkins restart, you will see the latest version of Jenkins running, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00143.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="7">The default OpenShift<a id="id1068" class="calibre1"/> plugin installed with the Jenkins installation does not work with the latest version of Jenkins. You have to build the latest OpenShift Jenkins plugin from source. The source code is available on GitHub at <a class="calibre1" href="https://github.com/openshift/jenkins-cloud-plugin">https://github.com/openshift/jenkins-cloud-plugin</a>. I have packaged the latest version and made it available at <a class="calibre1" href="https://github.com/OpenShift-Cookbook/chapter10-openshift-jenkins-plugin">https://github.com/OpenShift-Cookbook/chapter10-openshift-jenkins-plugin</a>. Download the latest plugin from <a class="calibre1" href="https://github.com/OpenShift-Cookbook/chapter10-openshift-jenkins-plugin/raw/master/openshift.hpi">https://github.com/OpenShift-Cookbook/chapter10-openshift-jenkins-plugin/raw/master/openshift.hpi</a> to a convenient location on your machine.</li><li class="listitem" value="8">Install the plugin manually by going to the plugin manager <span class="strong"><strong class="calibre7">Advanced</strong></span> tab and uploading the plugin.</li><li class="listitem" value="9">Restart Jenkins so that the plugin gets installed.</li><li class="listitem" value="10">Go to the Jenkins system configuration, add a new OpenShift cloud, and click on <span class="strong"><strong class="calibre7">Save</strong></span>. Have a look at the following screenshot:<div class="mediaobject"><img src="../images/00144.jpeg" alt="How to do it…" class="calibre8"/></div><p class="calibre12"> </p></li><li class="listitem" value="11">Go to <span class="strong"><strong class="calibre7">Plugin Manager</strong></span> (<code class="email">https://jenkins-{domain-name}.rhcloud.com/pluginManager/</code>), and update all the installed plugins.</li><li class="listitem" value="12">Finally, to<a id="id1069" class="calibre1"/> test whether all of your existing jobs are working fine, start an existing job manually. If you followed the last recipe, then you will already have three Jenkins jobs listed on the Jenkins dashboard.</li></ol><div class="calibre13"/></div></div></div>

<div class="book" title="Upgrading Jenkins to the latest version">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch10lvl2sec485" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre6">The OpenShift Jenkins cartridge allows a user to upgrade the Jenkins version by defining an environment variable, <code class="email">JENKINS_WAR_PATH</code>. If this environment variable were used, then the OpenShift Jenkins cartridge will use the Jenkins <code class="email">war</code> file located at this path. From step 1 through step 4, you first downloaded the latest version of Jenkins WAR and then created the <code class="email">JENKINS_WAR_PATH</code> environment variable.</p><p class="calibre6">You also created another environment variable called <code class="email">JENKINS_JAR_CACHE_PATH</code>. This is required with Jenkins Version 1.540 or higher. The reason you need to set this environment variable is that if you don't set this environment variable, then Jenkins will try to cache the plugin in the user home directory at <code class="email">~/.jenkins/cache/jars</code>. In OpenShift, you can only write to the <code class="email">$OPENSHIFT_DATA_DIR</code> directory. This environment variable makes sure that JARs are cached in a writable directory; otherwise, your build will fail.</p><p class="calibre6">After setting the<a id="id1070" class="calibre1"/> environment variables, you restarted Jenkins so that the new environment variables are picked up by Jenkins. You will now see the latest Jenkins version running.</p></div></div>

<div class="book" title="Upgrading Jenkins to the latest version">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch10lvl2sec486" class="calibre1"/>See also</h2></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><em class="calibre10">Adding Jenkins CI to your application</em></span> recipe</li></ul></div></div></div></body></html>