<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;9.&#xA0;Automation and Authentication &#x2013; Service Management Automation and ADFS" id="2E6E41-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09" class="calibre1"/>Chapter 9. Automation and Authentication – Service Management Automation and ADFS</h1></div></div></div><p class="calibre8">In this chapter, we will be focusing on automating our Windows Azure Pack-based cloud solution. You will learn the installation and configuration of <span class="strong"><strong class="calibre9">SMA</strong></span> (<span class="strong"><strong class="calibre9">Service Management Automation</strong></span>). You will also learn to create, author, and manage runbooks and assets.</p><p class="calibre8">Along with automation, you will also learn about the authentication, which is using ADFS to authenticate for both management and tenant portal. The following topics are covered in this chapter:</p><div class="book"><ul class="itemizedlist"><li class="listitem">SMA – overview and architecture</li><li class="listitem">Planning the SMA infrastructure</li><li class="listitem">Installing and configuring SMA</li><li class="listitem">Dealing with SMA assets</li><li class="listitem">Dealing with SMA runbooks</li><li class="listitem">Enabling ADFS authentication for WAP portals</li></ul></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Automation and Authentication &#x2013; Service Management Automation and ADFS" id="2E6E41-b479cf466c26404ca54119871a9b2715">
<div class="book" title="SMA – overview and architecture"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch09lvl1sec75" class="calibre1"/>SMA – overview and architecture</h1></div></div></div><p class="calibre8">SMA, a part of the system <a id="id1022" class="calibre1"/>center product family, adds automation capabilities to the Windows Azure Pack cloud. SMA enables a cloud provider to automate provisioning, monitoring, and <a id="id1023" class="calibre1"/>managing all resources in a WAP cloud.</p><p class="calibre8">Let's take an example. In a large-scale cloud provider scenario, tenants create and delete virtual machines in real time on a large scale, that is, hundreds of operations everyday. This cloud provider provides multiple capabilities and features on VMs hosted on the cloud as a value added to it; such capabilities include the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Backup and disaster recovery</li><li class="listitem">Real-time monitoring</li><li class="listitem">Antivirus and anti-malware protection</li><li class="listitem">Automatic point in time state snapshots</li></ul></div><p class="calibre8">Each VM provisioned by tenants needs to be configured in respective tools to enable the previous capabilities. And after each deletion of VMs by tenants, their respective configuration needs to be<a id="id1024" class="calibre1"/> removed from backup, monitoring, and so on. Assume achieving this in a cloud having hundreds or more VM provisioning operations daily using traditional methods.</p><p class="calibre8">SMA can drastically simplify and automate these operations. Service providers can create SMA runbooks for the provisioning and removal of configurations. Runbooks can then be linked with VM create and delete operations which will automatically initiate execution of respective runbooks with specific VM parameters.</p></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Automation and Authentication &#x2013; Service Management Automation and ADFS" id="2E6E41-b479cf466c26404ca54119871a9b2715">
<div class="book" title="SMA – overview and architecture">
<div class="book" title="An overview of SMA"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec154" class="calibre1"/>An overview of SMA</h2></div></div></div><p class="calibre8">SMA was introduced with the System Center 2012 R2 product family and is included in the System Center Orchestrator installation media. It can be used as a standalone product as well as along with Windows Azure Pack.</p><p class="calibre8">SMA provides the automation engine for Microsoft's on-premises cloud infrastructure. It relies on Windows PowerShell workflows; that is, almost any tasks that can be <a id="id1025" class="calibre1"/>performed via Windows PowerShell can be automated using SMA.</p><p class="calibre8">PowerShell workflows were introduced with the release of Windows PowerShell 3.0, and they contain traditional PowerShell cmdlets to execute tasks. Runbooks in SMA are authored in PowerShell workflows adding the following capabilities of PowerShell workflows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Checkpoint or suspend a workflow that is a runbook</li><li class="listitem">The parallel execution of PowerShell tasks on multiple systems</li></ul></div><p class="calibre8">Natively, SMA does not provide any GUI to create, manage, or execute runbooks. Unlike System Center Orchestrator, all runbooks in SMA must be written in PowerShell workflows manually.</p><p class="calibre8">The Windows Azure Pack administrator portal integrates well with SMA and provides GUI for scheduling, executing, and performing other management operations on runbooks.</p><p class="calibre8">It must be noted that SMA<a id="id1026" class="calibre1"/> functionality isn't available for tenants to create and manage their own runbooks.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note34" class="calibre1"/>Note</h3><p class="calibre8">Microsoft Azure automation works on the same architecture as SMA and provides similar automation capabilities for customers using Microsoft Azure for hosting their IT resources.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;9.&#xA0;Automation and Authentication &#x2013; Service Management Automation and ADFS" id="2E6E41-b479cf466c26404ca54119871a9b2715">
<div class="book" title="SMA – overview and architecture">
<div class="book" title="The architecture of SMA"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec155" class="calibre1"/>The architecture of SMA</h2></div></div></div><p class="calibre8">Similar to all other WAP cloud<a id="id1027" class="calibre1"/> components, SMA is distributed across multiple components and provides the flexible architecture to achieve performance and eliminate a single point of failure. SMA<a id="id1028" class="calibre1"/> involves the following components to function:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The SMA web service</li><li class="listitem">The SMA runbook worker</li><li class="listitem">The database server</li><li class="listitem">The SMA PowerShell module (optional)</li></ul></div><p class="calibre8"><span class="strong"><strong class="calibre9">The SMA web service</strong></span>: The web service is the interface to SMA for all other administrative mediums. Windows Azure Pack uses the SMA web service to communicate with SMA and for <a id="id1029" class="calibre1"/>other SMA tasks, such as executing a runbook or getting the status of a runbook.</p><p class="calibre8">It exposes a REST endpoint and OData API, which can be leveraged by WAP or any other custom developed portal for integration with SMA.</p><p class="calibre8">It is also responsible for authorization and distribution of runbook execution tasks to worker roles.</p><p class="calibre8"><span class="strong"><strong class="calibre9">The SMA runbook worker</strong></span>: SMA runbooks' jobs are executed or processed by worker servers. A runbook worker server<a id="id1030" class="calibre1"/> executes multiple runbooks in isolated environments, which are also known as sandboxes. This ensures that activities performed by one runbook don't affect the other runbook that is being executed by the same worker server.</p><p class="calibre8"><span class="strong"><strong class="calibre9">The SMA database</strong></span>: SMA leverages the<a id="id1031" class="calibre1"/> Microsoft SQL server database to store its configuration and runtime data. SMA database stores SMA runbooks, jobs, and other SMA-related objects' configurations and runtime data.</p><p class="calibre8"><span class="strong"><strong class="calibre9">The SMA PowerShell module</strong></span>: This can be <a id="id1032" class="calibre1"/>used to automate the automation; that is, it provides 40+ PowerShell cmdlet, which can be used by admins to automate the process of executing and managing runbooks. The PowerShell module also interacts with the SMA web service to perform SMA operations. This can be<a id="id1033" class="calibre1"/> installed on the administrator's endpoint and can be used as an alternative to the WAP portal for SMA operations.</p><p class="calibre8">The following diagram illustrates the role and flow of SMA components with Windows Azure Pack:</p><div class="mediaobject"><img src="../images/00246.jpeg" alt="The architecture of SMA" class="calibre10"/></div><p class="calibre11"> </p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Planning the SMA infrastructure" id="2F4UM1-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec76" class="calibre1"/>Planning the SMA infrastructure</h1></div></div></div><p class="calibre8">SMA works on the distributed<a id="id1034" class="calibre1"/> architecture to allow an easy and non-disruptive<a id="id1035" class="calibre1"/> scale in and out of the operations. The following aspects must be taken into consideration while planning the infrastructure for SMA deployment:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Planning for availability</li><li class="listitem">Planning for performance/capacity</li></ul></div></div>

<div class="book" title="Planning the SMA infrastructure" id="2F4UM1-b479cf466c26404ca54119871a9b2715">
<div class="book" title="Planning for availability"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec156" class="calibre1"/>Planning for availability</h2></div></div></div><p class="calibre8">All the components of the SMA solution can be protected against a single point of failure by adding redundant servers. The following <a id="id1036" class="calibre1"/>guidelines include the recommended configuration with respect to the availability of each role:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">The SMA web service role</strong></span>: This is recommended to deploy multiple web service roles (the minimum recommendation is two for high availability) and configure with a load<a id="id1037" class="calibre1"/> balancer. Any administrative endpoint such as the WAP portal must point to the load balancer to communicate with the SMA web service.</li><li class="listitem"><span class="strong"><strong class="calibre9">The SMA worker role</strong></span>: It is recommended<a id="id1038" class="calibre1"/> to deploy multiple SMA worker roles (the minimum recommendation is two for high availability) to avoid any single point of failure. The SMA web service automatically distributes job tasks to different workers ensuring load balancing.</li><li class="listitem"><span class="strong"><strong class="calibre9">The SMA database</strong></span>: It is recommended to <a id="id1039" class="calibre1"/>protect SMA SQL database against any single point of failure using SQL availability techniques. SMA database is supported to run on the following:<div class="book"><ul class="itemizedlist1"><li class="listitem">Standalone SQL server</li><li class="listitem">SQL server cluster</li><li class="listitem">SQL Always on</li></ul></div></li><li class="listitem"><span class="strong"><strong class="calibre9">Virtual machines for SMA servers</strong></span>: Using <a id="id1040" class="calibre1"/>virtual machines or hosting SMA servers adds another layer of protection against any hardware failure.</li></ul></div></div></div>

<div class="book" title="Planning the SMA infrastructure" id="2F4UM1-b479cf466c26404ca54119871a9b2715">
<div class="book" title="Planning for performance and capacity"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec157" class="calibre1"/>Planning for performance and capacity</h2></div></div></div><p class="calibre8">The following factors should be<a id="id1041" class="calibre1"/> taken into consideration while planning the SMA infrastructure sizing:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The number of runbooks</li><li class="listitem">The size of runbooks (activities, variables, connections, and so on)</li><li class="listitem">The average run time of runbooks</li><li class="listitem">Remote calls being executed</li></ul></div><p class="calibre8">There is no direct formula to calculate the sizing based on the previous factors. The following guidelines can be helpful in sizing SMA servers:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">The SMA web service</strong></span>: SMA web service is<a id="id1042" class="calibre1"/> stateless; that is, it can be scaled in and out easily with increased compute and additional servers along with a load balancer. Web services are responsible for communicating with administrative consoles, such as WAP, and worker roles to assign runbook jobs. High resource utilization and requirements are unlikely for the SMA web service unless a large number of users start initiating the SMA execution process simultaneously. Two CPU cores and 4 GB of RAM (minimum), 8 GB (recommended) are good compute configurations to start with.</li><li class="listitem"><span class="strong"><strong class="calibre9">The SMA worker</strong></span>: SMA worker hosts a sandbox to execute runbook jobs that aren't stateless as web services. Each sandbox can handle 30 concurrent jobs, and a worker can host a maximum of four sandboxes by default. This comes as 120 concurrent jobs per worker server. The standard SMA server's hardware recommends two CPU cores and 4 GB of RAM (minimum), but 8 GB is recommended. This can likely handle these efficiently. Worker roles can then be scaled out as per usage and requirement.</li><li class="listitem"><span class="strong"><strong class="calibre9">The SMA database</strong></span>: There <a id="id1043" class="calibre1"/>can only be one database as per the SMA deployment; hence, it is recommended to use a dedicated instance for the SMA database in the production environment, ensuring that it gets the required compute resources. Microsoft recommends using SQL servers for SMA databases with a minimum 8 GB of RAM and 8 cores in terms of compute. For storage as per Microsoft guidelines, 1 month of data with 12 jobs per minute requires 20 GB of disk space. Along with this, it is<a id="id1044" class="calibre1"/> recommended to follow standard Microsoft SQL Server performance and capacity guidelines. See <a class="calibre1" href="https://technet.microsoft.com/en-us/sqlserver/bb671430.aspx">https://technet.microsoft.com/en-us/sqlserver/bb671430.aspx</a> to learn about SQL server best practices.</li></ul></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Installing and configuring SMA"><div class="book" id="2G3F82-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec77" class="calibre1"/>Installing and configuring SMA</h1></div></div></div><p class="calibre8">SMA installation binaries are<a id="id1045" class="calibre1"/> located inside System Center Orchestrator Media and follows<a id="id1046" class="calibre1"/> similar installation instructions as per other system center products.</p></div>

<div class="book" title="Installing and configuring SMA">
<div class="book" title="SMA installation prerequisites"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec158" class="calibre1"/>SMA installation prerequisites</h2></div></div></div><p class="calibre8">The SMA installation prerequisites can be <a id="id1047" class="calibre1"/>divided in three categories:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Software <a id="id1048" class="calibre1"/>components prerequisites</li><li class="listitem">AD accounts prerequisites</li><li class="listitem">SSL certificate prerequisites</li></ul></div><p class="calibre8">Windows Server 2012 R2 is the minimum OS version supported for SMA installation. Apart from this, the following software components must be installed before starting the SMA installation as SMA installer doesn't automatically install prerequisite components.</p><p class="calibre8">Software prerequisite for installing the <a id="id1049" class="calibre1"/>SMA web service are as<a id="id1050" class="calibre1"/> follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Internet Information Services</strong></span> (<span class="strong"><strong class="calibre9">IIS</strong></span>) 7.5 or higher</li><li class="listitem">IIS basic authentication</li><li class="listitem">IIS Windows authentication</li><li class="listitem">IIS URL authorization</li><li class="listitem">ASP.NET 4.5</li><li class="listitem">.NET Framework 3.5 (for the setup program)</li><li class="listitem">.NET Framework 4.5</li><li class="listitem">WCF HTTP activation</li><li class="listitem">SQL Server 2012 DB connectivity</li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note35" class="calibre1"/>Note</h3><p class="calibre8">To install .NET 3.5 on Windows Server 2012/R2 using Server Manager's <span class="strong"><strong class="calibre9">Add Feature</strong></span> wizard, alternate<a id="id1051" class="calibre1"/> source locations must be specified during the installation, and it needs to be pointed to the <code class="email">sxs</code> folder under sources in the Windows installation media.</p></div><p class="calibre8">Software prerequisites to install the SMA worker role—Windows PowerShell 4.0 (this is included by default with Windows Server 2012 R2):</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Active Directory Accounts</strong></span>: It is recommended to <a id="id1052" class="calibre1"/>create separate dedicated accounts and groups for running following services in SMA deployment. The following table lists the accounts required for deploying SMA components:<div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre25">
<p class="calibre22">Sample account/group name</p>
</th><th valign="bottom" class="calibre25">
<p class="calibre22">Account usage</p>
</th><th valign="bottom" class="calibre25">
<p class="calibre22">Remarks</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">SMA pool</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">SMA Application Pool Admin Group</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">A member of Local Administrators</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">SMA poolsvc</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">SMA Pool <a id="id1053" class="indexterm"/>Web Service Account</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">A member of Local Administrators</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">SMA workersvc</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">SMA Worker Service Account</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">A member of Local Administrators</p>
</td></tr></tbody></table></div></li><li class="listitem"><span class="strong"><strong class="calibre9">SSL certificate</strong></span>: It is recommended to use<a id="id1054" class="calibre1"/> an internal CA issued SSL certificate for the SMA web service instead of the automatically generated self-signed certificate. This certificate must be trusted by the SPF server.</li></ul></div></div><div class="book" title="Installing the SMA web service, runbook worker, and PowerShell module"><div class="book"><div class="book"><div class="book"><div class="calibre14" id="calibre_pb_2"/>
</div></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Installing and configuring SMA">
<div class="book" title="Installing the SMA web service, runbook worker, and PowerShell module">
<div class="book">
<div class="book">
<div class="book">
<h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec159" class="calibre1"/>Installing the SMA web service, runbook worker, and PowerShell module</h2></div></div></div><p class="calibre8">For the purpose <a id="id1055" class="calibre1"/>of evaluation in this book, we will be installing all three components on <a id="id1056" class="calibre1"/>a single server. The following steps are<a id="id1057" class="calibre1"/> required to install the SMA web <a id="id1058" class="calibre1"/>service:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the server designated<a id="id1059" class="calibre1"/> for installing the<a id="id1060" class="calibre1"/> SMA web service.</li><li class="listitem" value="2">Start <code class="email">SetupOrchestrator.exe</code> from System Center Orchestrator Media.</li><li class="listitem" value="3">Click on <span class="strong"><strong class="calibre9">Web Service</strong></span> on the <span class="strong"><strong class="calibre9">Install</strong></span> page under <span class="strong"><strong class="calibre9">Service Management</strong></span>.<div class="mediaobject"><img src="../images/00247.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Click <a id="id1061" class="calibre1"/>on <span class="strong"><strong class="calibre9">Install</strong></span><a id="id1062" class="calibre1"/> to<a id="id1063" class="calibre1"/> proceed.<div class="mediaobject"><img src="../images/00248.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Enter the <span class="strong"><strong class="calibre9">Name</strong></span> and <span class="strong"><strong class="calibre9">Organization</strong></span> names <a id="id1064" class="calibre1"/>along with the registration key if any. The setup will get installed in<a id="id1065" class="calibre1"/> the evaluation<a id="id1066" class="calibre1"/> mode if no<a id="id1067" class="calibre1"/> registration key is provided at this<a id="id1068" class="calibre1"/> stage:<div class="mediaobject"><img src="../images/00249.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="6">Agree to the terms and <a id="id1069" class="calibre1"/>condition to proceed further.</li><li class="listitem" value="7">The setup will start its prerequisite check and will display any error or warning as applicable. Proceed<a id="id1070" class="calibre1"/> further if all the prerequisites are met:<div class="mediaobject"><img src="../images/00250.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="8">Enter the database<a id="id1071" class="calibre1"/> server connection information<a id="id1072" class="calibre1"/> including the <a id="id1073" class="calibre1"/>server name, port, database<a id="id1074" class="calibre1"/> name, and credentials. Both <a id="id1075" class="calibre1"/>Windows and SQL authentication can be used:<div class="mediaobject"><img src="../images/00251.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="9">Specify <a id="id1076" class="calibre1"/>security <a id="id1077" class="calibre1"/>groups or <a id="id1078" class="calibre1"/>users and<a id="id1079" class="calibre1"/> credentials to run the<a id="id1080" class="calibre1"/> web service application <a id="id1081" class="calibre1"/>pool:<div class="mediaobject"><img src="../images/00252.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="10">Specify the web<a id="id1082" class="calibre1"/> service port and SSL certificate<a id="id1083" class="calibre1"/> to use. The setup<a id="id1084" class="calibre1"/> can also generate<a id="id1085" class="calibre1"/> a self-signed <a id="id1086" class="calibre1"/>certificate to use in<a id="id1087" class="calibre1"/> test environments:<div class="mediaobject"><img src="../images/00253.jpeg" alt="Installing the SMA web service, runbook worker, and PowerShell module" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="11">Specify a<a id="id1088" class="calibre1"/> location to store web service files.</li><li class="listitem" value="12">Specify choices for <span class="strong"><strong class="calibre9">CEIP</strong></span> (<span class="strong"><strong class="calibre9">Customer Experience Improvement Program</strong></span>) and Microsoft<a id="id1089" class="calibre1"/> update.</li><li class="listitem" value="13">Review the settings <a id="id1090" class="calibre1"/>and click on <span class="strong"><strong class="calibre9">Install</strong></span> to start<a id="id1091" class="calibre1"/> the installation.</li><li class="listitem" value="14">Click <span class="strong"><strong class="calibre9">Close</strong></span> on the successful <a id="id1092" class="calibre1"/>completion; the SMA <a id="id1093" class="calibre1"/>web service is<a id="id1094" class="calibre1"/> now installed.</li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Installing and configuring SMA">
<div class="book" title="Installing web worker roles"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch09lvl2sec160" class="calibre1"/>Installing web worker roles</h2></div></div></div><p class="calibre8">The following steps<a id="id1095" class="calibre1"/> are required to install the SMA worker role:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the server designated to install the<a id="id1096" class="calibre1"/> SMA worker.</li><li class="listitem" value="2">Start <code class="email">SetupOrchestrator.Exe</code> from System Center Orchestrator Media.</li><li class="listitem" value="3">Click on <span class="strong"><strong class="calibre9">Runbook Worker</strong></span> on the <span class="strong"><strong class="calibre9">Install</strong></span> page under Service Management.</li><li class="listitem" value="4">Enter the <span class="strong"><strong class="calibre9">Name</strong></span> and <span class="strong"><strong class="calibre9">Organization</strong></span> name along with the registration key if any. The setup will get installed in the evaluation mode if no registration key is provided at this stage.</li><li class="listitem" value="5">Agree to the terms and condition to proceed further.</li><li class="listitem" value="6">The setup will start its prerequisite checks and will display any error or warning as applicable. Proceed further if all the prerequisites are met.</li><li class="listitem" value="7">Enter the database server connection information including the server name, port, the database name, and credentials. Both Windows and SQL authentication can be used.</li><li class="listitem" value="8">Specify the service account for running the SMA worker service:<div class="mediaobject"><img src="../images/00254.jpeg" alt="Installing web worker roles" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="9">Specify a location to<a id="id1097" class="calibre1"/> store worker files.</li><li class="listitem" value="10">Specify choices for CEIP.</li><li class="listitem" value="11">Review the <a id="id1098" class="calibre1"/>setting and click on <span class="strong"><strong class="calibre9">Install</strong></span> to start the installation.</li><li class="listitem" value="12">Click on <span class="strong"><strong class="calibre9">close</strong></span> upon successful completion. The SMA runbook worker is now installed.</li></ol><div class="calibre27"/></div><p class="calibre8">The SMA PowerShell module can be installed in a similar manner on administrative endpoints.</p></div></div>

<div class="book" title="Installing and configuring SMA">
<div class="book" title="Post installation tasks"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch09lvl2sec161" class="calibre1"/>Post installation tasks</h2></div></div></div><p class="calibre8">Ensure to complete the following tasks to<a id="id1099" class="calibre1"/> have a working SMA deployment for the WAP integration:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Replace the self-signed certificate for SMA web services with trusted SSL in production environments.</li><li class="listitem">Verify the <span class="strong"><strong class="calibre9">SPF</strong></span> (<span class="strong"><strong class="calibre9">Service Provider Foundation</strong></span>) server trust the SSL certificate <a id="id1100" class="calibre1"/>presented by<a id="id1101" class="calibre1"/> SMA web service.</li></ul></div></div></div>
<div class="book" title="Integrating SMA with Windows Azure Pack" id="2H1VQ1-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec78" class="calibre1"/>Integrating SMA with Windows Azure Pack</h1></div></div></div><p class="calibre8">The following <a id="id1102" class="calibre1"/> steps are required to integrate SMA with Windows Azure Pack by<a id="id1103" class="calibre1"/> registering SMA endpoints:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the WAP management portal for administrators.</li><li class="listitem" value="2">Browse through the <span class="strong"><strong class="calibre9">automation</strong></span> workspace:<div class="mediaobject"><img src="../images/00255.jpeg" alt="Integrating SMA with Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Click on<a id="id1104" class="calibre1"/>  <span class="strong"><strong class="calibre9">Register the Service Management Automation Endpoint</strong></span>.</li><li class="listitem" value="4">Enter the SMA<a id="id1105" class="calibre1"/> endpoint details along with some credentials:<div class="mediaobject"><img src="../images/00256.jpeg" alt="Integrating SMA with Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">The SMA endpoint will be visible in the WAP portal upon a successful registration.</li><li class="listitem" value="6">The <span class="strong"><strong class="calibre9">automation</strong></span> <a id="id1106" class="calibre1"/> workspace under the WAP portal can now be<a id="id1107" class="calibre1"/> used for all operations related to SMA. The <span class="strong"><strong class="calibre9">DASHBOARD</strong></span> page displays statuses and statistics about runbooks and jobs throughout the cloud. Similar dashboards can also be accessed per runbook:<div class="mediaobject"><img src="../images/00257.jpeg" alt="Integrating SMA with Windows Azure Pack" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Dealing with SMA assets"><div class="book" id="2I0GC2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec79" class="calibre1"/>Dealing with SMA assets</h1></div></div></div><p class="calibre8">Assets in a SMA-based <a id="id1108" class="calibre1"/>automation solution for WAP provide global configurations and parameters that can be leveraged by runbooks. For example, it is very likely that any runbook being executed for VM cloud's operations may require VMM server connection<a id="id1109" class="calibre1"/> info and credentials. In large environments having hundreds of runbooks, instead of defining VMM server connection information and credentials per runbook, these can be declared as assets and can be leveraged by all runbooks.</p><p class="calibre8">Declaring such variables at global level in asset also helps in handling changes at a later stage in a very smooth manner.</p><p class="calibre8">Assets in Windows Azure Pack automation include the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Connections</li><li class="listitem">Credentials</li><li class="listitem">Variables</li><li class="listitem">Schedules</li><li class="listitem">Modules</li></ul></div></div>

<div class="book" title="Dealing with SMA assets">
<div class="book" title="Asset types and functionalities"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec162" class="calibre1"/>Asset types and functionalities</h2></div></div></div><p class="calibre8">The following are the types of <a id="id1110" class="calibre1"/>assets and their functionalities:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Connections</strong></span>: Connections include connectivity details and authorized credentials for <a id="id1111" class="calibre1"/>common services used by runbooks. Examples include<a id="id1112" class="calibre1"/> services such as SCVMM, Azure, or any other available services.</li><li class="listitem"><span class="strong"><strong class="calibre9">Credentials</strong></span>: Credentials in<a id="id1113" class="calibre1"/> WAP automation assets can be compared to Run As accounts in SCVMM. Credentials contain a<a id="id1114" class="calibre1"/> username and password for accounts leveraged by runbooks for accessing, modifying, and managing resources across the cloud. WAP automation assets can store two types of credentials:<div class="book"><ul class="itemizedlist1"><li class="listitem">Windows PowerShell credentials</li><li class="listitem">SSL certificates credentials</li></ul></div><p class="calibre15">Service providers can add multiple credentials depending upon the permission and usage required by runbooks.</p></li><li class="listitem"><span class="strong"><strong class="calibre9">Variables</strong></span>: As implied<a id="id1115" class="calibre1"/> by its name, variables can be used to store key values used by runbooks. Variables can be defined in the following format:<div class="book"><ul class="itemizedlist1"><li class="listitem">String</li><li class="listitem">Integer</li><li class="listitem">Boolean</li><li class="listitem">Date time</li></ul></div><p class="calibre15">Variables having confidential values such as password can be encrypted for security.</p></li><li class="listitem"><span class="strong"><strong class="calibre9">Schedules</strong></span>: This can be<a id="id1116" class="calibre1"/> used to create a regular schedule for any runbook to execute; for example, a schedule can be created, which will initiate a runbook everyday at some specific time to collect statics data.</li><li class="listitem"><span class="strong"><strong class="calibre9">Modules</strong></span>: This contains <a id="id1117" class="calibre1"/> PowerShell modules, which can be used by runbooks to execute specific PowerShell cmdlets. Modules can be compared with integration packs in System Center Orchestrator.<p class="calibre15">Modules help in managing all PowerShell modules in a central point without requiring installation at each worker role.</p></li></ul></div></div></div>

<div class="book" title="Dealing with SMA assets">
<div class="book" title="Adding and managing assets"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec163" class="calibre1"/>Adding and managing assets</h2></div></div></div><p class="calibre8">The <span class="strong"><strong class="calibre9">ASSETS</strong></span> tab under the <a id="id1118" class="calibre1"/>automation workspace in the WAP management portal provides<a id="id1119" class="calibre1"/> options to add or remove assets.</p><p class="calibre8">The following steps are<a id="id1120" class="calibre1"/> required to add, delete, and modify assets:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the WAP management<a id="id1121" class="calibre1"/> portal for administrators.</li><li class="listitem" value="2">Browse the <span class="strong"><strong class="calibre9">automation</strong></span> workspace and the <span class="strong"><strong class="calibre9">ASSETS </strong></span>tab.</li><li class="listitem" value="3">By default, all the standard PowerShell modules are included in the WAP portal. Any additional module can be imported. Any existing module can be deleted by buttons available in the bottom pane:<div class="mediaobject"><img src="../images/00258.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Click on <span class="strong"><strong class="calibre9">ADD SETTING</strong></span> to add a new asset:<div class="mediaobject"><img src="../images/00259.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Select the type of asset to<a id="id1122" class="calibre1"/> be added and proceed <a id="id1123" class="calibre1"/>further.</li><li class="listitem" value="6">To create a connection asset, select<a id="id1124" class="calibre1"/> a connection and provide connection details including connection type, name, hostname and<a id="id1125" class="calibre1"/> credentials. By default, WAP supports the following connection types:<div class="mediaobject"><img src="../images/00260.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="7">Add any credentials by selecting add credential on the add service page. Provide the credentials type<a id="id1126" class="calibre1"/> and credentials friendly name and a username, password, or the SSL certificate as applicable:<div class="mediaobject"><img src="../images/00261.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="8">Add <a id="id1127" class="calibre1"/>any variable by <a id="id1128" class="calibre1"/>selecting add variable on the add service<a id="id1129" class="calibre1"/> page provide the variable type, variable name, and value with an optional encryption:<div class="mediaobject"><img src="../images/00262.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p><div class="mediaobject"><img src="../images/00263.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="9">Add any schedule by selecting<a id="id1130" class="calibre1"/> add schedule on the add service page. Provide a schedule <a id="id1131" class="calibre1"/>name and schedule values<a id="id1132" class="calibre1"/> including a type (one time or daily) and<a id="id1133" class="calibre1"/> start time:<div class="mediaobject"><img src="../images/00264.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="10">The created assets will now be visible in the <span class="strong"><strong class="calibre9">ASSETS</strong></span> tab. They are ready for usage by the runbooks.</li><li class="listitem" value="11">Clicking on any asset will display its configurations; for example, clicking on a module will display the module information along with PowerShell cmdlets. It will show the following screenshot:<div class="mediaobject"><img src="../images/00265.jpeg" alt="Adding and managing assets" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div><p class="calibre8">Additional<a id="id1134" class="calibre1"/> assets can be<a id="id1135" class="calibre1"/> created in a similar manner.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Dealing with SMA runbooks"><div class="book" id="2IV0U2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec80" class="calibre1"/>Dealing with SMA runbooks</h1></div></div></div><p class="calibre8">SMA runbooks consist of PowerShell workflows, which include PowerShell cmdlets to perform specified tasks in an automated manner.</p><p class="calibre8">The Runbooks can be managed from the <span class="strong"><strong class="calibre9">RUNBOOKS</strong></span> tab under the <span class="strong"><strong class="calibre9">automation</strong></span> workspace WAP portal. Service providers<a id="id1136" class="calibre1"/> can write PowerShell workflows and runbooks anywhere, and then import them in the WAP SMA.</p><p class="calibre8">The <span class="strong"><strong class="calibre9">RUNBOOKS</strong></span> tab in the <span class="strong"><strong class="calibre9">automation</strong></span> workspace provides functionality to perform the following basic operations on runbooks:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Start the execution of any runbook</li><li class="listitem">Import a runbook to WAP (PS1 file)</li><li class="listitem">Export any existing runbook to the PS1 file on<a id="id1137" class="calibre1"/> a local system</li><li class="listitem">Delete any existing runbook from WAP</li></ul></div><p class="calibre8">Note that there is no GUI (drag and drop item) available for authoring runbooks such as System Center Orchestrator (SCO); it must be <a id="id1138" class="calibre1"/>written manually in PowerShell workflows.</p></div>

<div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Sample runbooks"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec164" class="calibre1"/>Sample runbooks</h2></div></div></div><p class="calibre8">Windows Azure Pack along with SMA by default provides a few samples of runbooks that can be used and leveraged as a reference to author new runbooks.</p><p class="calibre8">The following steps outline<a id="id1139" class="calibre1"/> the process to view and manage sample runbooks:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the WAP management <a id="id1140" class="calibre1"/>portal for administrators.</li><li class="listitem" value="2">Browse the <span class="strong"><strong class="calibre9">automation</strong></span> workspace and the <span class="strong"><strong class="calibre9">RUNBOOKS</strong></span> tab.</li><li class="listitem" value="3">Sample runbooks will be displayed. Click on any sample runbook to see its workflows and other configurations.<div class="mediaobject"><img src="../images/00266.jpeg" alt="Sample runbooks" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Any runbook can be started, imported, exported, and deleted using the buttons available in the bottom pane.</li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Creating a runbook"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec165" class="calibre1"/>Creating a runbook</h2></div></div></div><p class="calibre8">The following steps are<a id="id1141" class="calibre1"/> required to create a runbook:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the WAP management portal for administrators.</li><li class="listitem" value="2">Browse the <span class="strong"><strong class="calibre9">automation</strong></span> workspace and the <span class="strong"><strong class="calibre9">RUNBOOKS</strong></span> tab.</li><li class="listitem" value="3">Click on the <span class="strong"><strong class="calibre9">NEW</strong></span> button, select <span class="strong"><strong class="calibre9">RUNBOOK</strong></span> and <span class="strong"><strong class="calibre9">QUICK CREATE</strong></span>:<div class="mediaobject"><img src="../images/00267.jpeg" alt="Creating a runbook" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">The newly created<a id="id1142" class="calibre1"/> runbook will now be listed under the <span class="strong"><strong class="calibre9">RUNBOOKS</strong></span> tab.</li><li class="listitem" value="5">Click on <span class="strong"><strong class="calibre9">RUNBOOK NAME</strong></span> to perform additional operations on the runbook including authoring and scheduling.</li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Authoring a runbook"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec166" class="calibre1"/>Authoring a runbook</h2></div></div></div><p class="calibre8">Authoring a runbook involves<a id="id1143" class="calibre1"/> writing PowerShell workflows for the runbook and managing runbook versions and modifications throughout the lifecycle.</p><p class="calibre8">Multiple tools can be leveraged by service providers to author a runbook:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Windows PowerShell ISE</li><li class="listitem">Visual Studio IDE</li><li class="listitem">Windows Azure Pack management portal</li><li class="listitem">Any other source control or programming tool</li></ul></div><p class="calibre8">While authoring runbooks in the Windows Azure Pack administrator portal, it can either be in the draft or published version. A published version is used by worker servers to execute the workload while initiating a runbook.</p><p class="calibre8">The following outlines the steps required to author a runbook in the Windows Azure Pack portal:</p><p class="calibre8">First, create runbook by following instructions given in the previous topic.</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Select the newly created runbook and browse the <span class="strong"><strong class="calibre9">AUTHOR </strong></span>workspace.</li><li class="listitem" value="2">Click on <span class="strong"><strong class="calibre9">DRAFT</strong></span>, and then the workflow writer will be available:<div class="mediaobject"><img src="../images/00268.jpeg" alt="Authoring a runbook" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Follow the standard<a id="id1144" class="calibre1"/> Microsoft PowerShell workflow writing guidelines to write the workflow for the runbook. See Microsoft documentation at <a class="calibre1" href="https://azure.microsoft.com/en-in/documentation/articles/automation-powershell-workflow/">https://azure.microsoft.com/en-in/documentation/articles/automation-powershell-workflow/</a> to learn more about writing PowerShell workflows.</li><li class="listitem" value="4">The bottom pane buttons can be<a id="id1145" class="calibre1"/> leveraged to add additional functionality into the runbook, such as adding another runbook (nesting) or adding any activity or assets.<div class="mediaobject"><img src="../images/00269.jpeg" alt="Authoring a runbook" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5">Clicking on <span class="strong"><strong class="calibre9">SAVE </strong></span>will save the current version of the draft. Publishing will make this draft available for execution by SMA workers.</li></ol><div class="calibre27"/></div></div><div class="book" title="Using assets in runbook PowerShell workflows"><div class="book"><div class="book"><div class="book"><div class="calibre14" id="calibre_pb_4"/>
</div></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Using assets in runbook PowerShell workflows">
<div class="book">
<div class="book">
<div class="book">
<h2 class="title1" id="calibre_pb_5"><a id="ch09lvl2sec167" class="calibre1"/>Using assets in runbook PowerShell workflows</h2></div></div></div><p class="calibre8">SMA assets <a id="id1146" class="calibre1"/>declared at global level can be used inside workflows by the following syntax:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Connection</strong></span>: The following shows an example where connection declared in assets is being accessed in the PowerShell workflow:<div class="informalexample"><pre class="programlisting">$SCVMMConnection = Get-AutomationConnection -Name "SCVMVMMConnection"
$SCVMMServer = $SCVMMConnection.ComputerName
$SCVMMUser = $SCVMMConnection.Username
$SCVMMPassword = $SCVMMConnection.Password</pre></div></li><li class="listitem"><span class="strong"><strong class="calibre9">Credentials</strong></span>: The following PowerShell shows an example where credentials declared in assets are being accessed in the PowerShell workflow:<div class="informalexample"><pre class="programlisting">$AccessCred = Get-AutomationPSCredential -Name "SampleCred"</pre></div></li><li class="listitem"><span class="strong"><strong class="calibre9">Variable</strong></span>: The following PowerShell shows an example where a variable declared in assets is being accessed in the PowerShell workflow:<div class="informalexample"><pre class="programlisting">$ABCVar = Get-AutomationVariable -Name "SampleVAR"</pre></div></li></ul></div></div></div>

<div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Scheduling a runbook"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch09lvl2sec168" class="calibre1"/>Scheduling a runbook</h2></div></div></div><p class="calibre8">Scheduling a runbook will<a id="id1147" class="calibre1"/> automatically start executing the runbook as per the configured date, time, and frequency value. Schedules configured in assets can be attached with runbooks; custom schedules can also be created.</p><p class="calibre8">The following steps are required to author a runbook:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Select the runbook to be scheduled in the WAP portal and browse the <span class="strong"><strong class="calibre9">SCHEDULE </strong></span>tab:<div class="mediaobject"><img src="../images/00270.jpeg" alt="Scheduling a runbook" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="2">Click on an existing schedule to the leverage schedule created in global assets. Click on <span class="strong"><strong class="calibre9">ADD A NEW SCHEDULE</strong></span> to add a new schedule for this runbook.</li><li class="listitem" value="3">Provide a schedule<a id="id1148" class="calibre1"/> name and type (one time/daily) along with date and time to configure a new schedule.</li><li class="listitem" value="4">Click on <span class="strong"><strong class="calibre9">Finish</strong></span> to save the schedule configured for the runbook.</li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Dealing with jobs"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch09lvl2sec169" class="calibre1"/>Dealing with jobs</h2></div></div></div><p class="calibre8">Whenever a runbook execution is <a id="id1149" class="calibre1"/>started, a corresponding job is created and assigned to a worker role for execution. The worker role stores jobs during runtime in a sandbox.</p><p class="calibre8">Using the Windows Azure pack portal <span class="strong"><strong class="calibre9">automation</strong></span> workspace, we can see the status of jobs in real time and for historical data. Jobs can also be stopped, suspended, and resumed.</p><p class="calibre8">The following outlines the steps for viewing and dealing with runbooks:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">The <span class="strong"><strong class="calibre9">RUNBOOKS </strong></span>tab under the <span class="strong"><strong class="calibre9">automation </strong></span>workspace displays the status for all runbooks in the WAP cloud:<div class="mediaobject"><img src="../images/00271.jpeg" alt="Dealing with jobs" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="2">A job status per runbook can<a id="id1150" class="calibre1"/> be accessed under the <span class="strong"><strong class="calibre9">JOBS </strong></span>tab for each runbook page. Select the job status and timelines to see jobs status as per selected parameters.</li></ol><div class="calibre27"/></div></div><div class="book" title="Configuring the runbook logging"><div class="book"><div class="book"><div class="book"><div class="calibre14" id="calibre_pb_8"/>
</div></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Configuring the runbook logging">
<div class="book">
<div class="book">
<div class="book">
<h2 class="title1" id="calibre_pb_9"><a id="ch09lvl2sec170" class="calibre1"/>Configuring the runbook logging</h2></div></div></div><p class="calibre8">Windows Azure Pack provides<a id="id1151" class="calibre1"/> multiple choices to cloud administrators for configuring logging levels and types for a runbook. Administrators can choose to enable or disable the following level of logging per runbook:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Log Debug Records</li><li class="listitem">Log Verbose Records</li><li class="listitem">Log Progress Records</li></ul></div><p class="calibre8">The following steps are required to configure logging options for a runbook:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Select the runbook and browse the configure tab.</li><li class="listitem" value="2">Scroll down to the logging space and configure settings as per requirement; click on <span class="strong"><strong class="calibre9">SAVE </strong></span>to save the changed configurations:<div class="mediaobject"><img src="../images/00272.jpeg" alt="Configuring the runbook logging" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div></div></div>

<div class="book" title="Dealing with SMA runbooks">
<div class="book" title="Linking runbooks with VM cloud actions"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_10"><a id="ch09lvl2sec171" class="calibre1"/>Linking runbooks with VM cloud actions</h2></div></div></div><p class="calibre8">Linking runbooks with VM cloud<a id="id1152" class="calibre1"/> operations enable executing a specified runbook only when a specific event or action occurs. Linking a runbook with actions helps in getting the required operations performed on objects as soon the objects gets<a id="id1153" class="calibre1"/> created instead of waiting until the next runbook schedule.</p><p class="calibre8">The following steps are required to link the runbook with an action in VM clouds:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the WAP portal for administrators and browse the <span class="strong"><strong class="calibre9">vm clouds</strong></span> workspace.</li><li class="listitem" value="2">Select the <span class="strong"><strong class="calibre9">AUTOMATION</strong></span> tab:<div class="mediaobject"><img src="../images/00273.jpeg" alt="Linking runbooks with VM cloud actions" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="3">Click on <span class="strong"><strong class="calibre9">LINK AN ACTION WITH A RUNBOOK</strong></span>.<p class="calibre15">WAP automation supports the following objects of VM clouds to link a runbook on the specific action:</p><div class="mediaobject"><img src="../images/00274.jpeg" alt="Linking runbooks with VM cloud actions" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Select <span class="strong"><strong class="calibre9">OBJECT</strong></span>, <span class="strong"><strong class="calibre9">ACTION </strong></span><a id="id1154" class="calibre1"/>and <span class="strong"><strong class="calibre9">RUNBOOK </strong></span>to <a id="id1155" class="calibre1"/>configure:<div class="mediaobject"><img src="../images/00275.jpeg" alt="Linking runbooks with VM cloud actions" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="5"><span class="strong"><strong class="calibre9">Click</strong></span> on <span class="strong"><strong class="calibre9">finish</strong></span> to link the runbook with the selected action.</li></ol><div class="calibre27"/></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Enabling ADFS authentication for WAP portals"><div class="book" id="2JTHG2-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec81" class="calibre1"/>Enabling ADFS authentication for WAP portals</h1></div></div></div><p class="calibre8">Windows Azure Pack<a id="id1156" class="calibre1"/> standard installation includes authentication sites for both admin and tenant portals to leverage their default authentication mechanisms. Active directory provides authentication services worldwide. We <a id="id1157" class="calibre1"/>can leverage AD features and capabilities by enabling our WAP portals to use ADFS for authentication.</p><p class="calibre8">This can enable service providers to authenticate tenant users against the tenant's own active directory hosted inside their on-premises infrastructure.</p></div>

<div class="book" title="Enabling ADFS authentication for WAP portals">
<div class="book" title="ADFS authentication architecture and overview – admin and tenant portals"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec172" class="calibre1"/>ADFS authentication architecture and overview – admin and tenant portals</h2></div></div></div><p class="calibre8">By default, Windows Azure<a id="id1158" class="calibre1"/> Pack portals are configured to use the following <a id="id1159" class="calibre1"/>authentication mechanisms.</p><div class="book"><ul class="itemizedlist"><li class="listitem">The WAP management portal for administrators: Windows authentication</li><li class="listitem">The WAP management portal for tenants—ASP.NET provider</li></ul></div><p class="calibre8">Active Directory Federations Services are used to simplify login and enable true SSO (single sign on) capabilities across the applications and services hosted anywhere (on-premises/public clouds). Using ADFS for authentication in Windows Azure Pack, cloud providers can secure and simplify authentication mechanisms for admins portals. For tenant portals, it will help in enabling single sign on for tenant users, leveraging a tenant's own active directory for authentication. The following diagram explains the authentication architecture for Windows Azure Pack with ADFS:</p><div class="mediaobject"><img src="../images/00276.jpeg" alt="ADFS authentication architecture and overview – admin and tenant portals" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre8">Implementing ADFS for the<a id="id1160" class="calibre1"/> Windows Azure Pack cloud involves the following steps:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Setting up ADFS farms (both cloud provides and tenants)</li><li class="listitem">Adding the tenant's ADFS as a claim provider to the cloud provider's ADFS</li><li class="listitem">Adding cloud provider's ADFS as a relying party to tenant's ADFS</li><li class="listitem">Adding the WAP portal (tenant/admin) as a relying party to the cloud provider's ADFS</li><li class="listitem">Adding the cloud provider's ADFS as a claim provider to the WAP tenant portal</li><li class="listitem">Testing and verifying the configuration</li></ul></div><p class="calibre8">Setting up ADFS farms and configuring relationship between a provider's and tenant's ADFS service isn't covered in this book. See<a id="id1161" class="calibre1"/> Microsoft ADFS documentation at <a class="calibre1" href="https://technet.microsoft.com/en-in/windowsserver/dd448613.aspx">https://technet.microsoft.com/en-in/windowsserver/dd448613.aspx</a> to know more about ADFS.</p></div></div>

<div class="book" title="Enabling ADFS authentication for WAP portals">
<div class="book" title="Adding the WAP portal as a relying party"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec173" class="calibre1"/>Adding the WAP portal as a relying party</h2></div></div></div><p class="calibre8">The following steps<a id="id1162" class="calibre1"/> are required to add WAP portals as a relying party to the cloud provider's ADFS service. See <a class="calibre1" title="Chapter 3. Installing and Configuring Windows Azure Pack" href="part0033_split_000.html#VF2I1-b479cf466c26404ca54119871a9b2715">Chapter 3</a>, <span class="strong"><em class="calibre12">Installing and Configuring Windows Azure Pack</em></span>, to learn more about the Windows Azure Pack architecture and role of these components:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log into the ADFS server and open the ADFS console from the server manager.</li><li class="listitem" value="2">Click on the <span class="strong"><strong class="calibre9">Add</strong></span> relaying party trust.</li><li class="listitem" value="3">Provide the federation metadata <a id="id1163" class="calibre1"/>URL of the WAP server in the given format, that is, <code class="email">https://manage.wapcloud.com/federationmetadata/2007-06/federationmetadata.xml</code>:<div class="mediaobject"><img src="../images/00277.jpeg" alt="Adding the WAP portal as a relying party" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Specify <span class="strong"><strong class="calibre9">Display Name</strong></span> and optional note.</li><li class="listitem" value="5">Enable or disable the multi-factor authentication as per the service provider's decision.</li><li class="listitem" value="6">Select <span class="strong"><strong class="calibre9">Permit</strong></span> to allow all users to access this relying party.</li><li class="listitem" value="7">On the <span class="strong"><strong class="calibre9">Finish</strong></span> page, select the checkbox for <span class="strong"><strong class="calibre9">Edit claims rules</strong></span>.</li><li class="listitem" value="8">Add the rule with the setting called <span class="strong"><strong class="calibre9">Send LDAP Attributes as Claims</strong></span>.</li><li class="listitem" value="9">Provide a claim rule name and select <span class="strong"><strong class="calibre9">Active Directory</strong></span> as <span class="strong"><strong class="calibre9">Attribute store</strong></span>.</li><li class="listitem" value="10">Map the User-Principal-Name LDAP attribute to the UPN called <span class="strong"><strong class="calibre9">Outgoing claim type</strong></span>.<div class="mediaobject"><img src="../images/00278.jpeg" alt="Adding the WAP portal as a relying party" class="calibre10"/></div><p class="calibre26"> </p></li><li class="listitem" value="11">Add one more rule with the same configuration except changing the binding by mapping MapToken-Groups—Qualified by the domain name LDAP attribute to the group Outgoing claim type.</li><li class="listitem" value="12">Add another rule with Passthrough or Filter an Incoming Claim rule template.</li><li class="listitem" value="13">Provide a claim rule<a id="id1164" class="calibre1"/> name and select <span class="strong"><strong class="calibre9">UPN</strong></span> in the incoming claim type.</li><li class="listitem" value="14">Add another rule to Passthrough or Filter an Incoming Claim template with Provide claim rule name. Select <span class="strong"><strong class="calibre9">Group</strong></span> in the incoming claim type.</li><li class="listitem" value="15">Verify the created rules and proceed to finish the configuration wizard.<div class="mediaobject"><img src="../images/00279.jpeg" alt="Adding the WAP portal as a relying party" class="calibre10"/></div><p class="calibre26"> </p></li></ol><div class="calibre27"/></div><p class="calibre8">Post this run to finish ADFS<a id="id1165" class="calibre1"/> configurations along with the WAP website identifier:</p><div class="informalexample"><pre class="programlisting">Set-AdfsRelyingPartyTrust -TargetIdentifier<span class="strong"><strong class="calibre9">'http://azureservices/TenantSite'</strong></span>-EnableJWT $true</pre></div><p class="calibre8">To get the identifier, run the following PowerShell. Provide the WAP portal party name in cmdlet:</p><div class="informalexample"><pre class="programlisting">Get-AdfsRelyingPartyTrust -Name "Party Name"</pre></div></div></div>

<div class="book" title="Enabling ADFS authentication for WAP portals">
<div class="book" title="Configuring WAP websites to use ADFS"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec174" class="calibre1"/>Configuring WAP websites to use ADFS</h2></div></div></div><p class="calibre8">The following steps<a id="id1166" class="calibre1"/> are required to configure WAP websites to use ADFS as the authentication site. See <a class="calibre1" title="Chapter 3. Installing and Configuring Windows Azure Pack" href="part0033_split_000.html#VF2I1-b479cf466c26404ca54119871a9b2715">Chapter 3</a>, <span class="strong"><em class="calibre12">Installing and Configuring Windows Azure Pack</em></span>, to learn more about configuring WAP portals:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Execute the following PowerShell on the Windows Azure Pack server to configure tenant websites to use ADFS. Tenants can be replaced with an admin to configure an admin portal:<div class="informalexample"><pre class="programlisting">Set-MgmtSvcRelyingPartySettings -Target Tenant -MetadataEndpoint https://<span class="strong"><strong class="calibre9">adfs.wapcloud.com</strong></span>/FederationMetadata/2007-06/FederationMetadata.xml -DisableCertificateValidation -ConnectionString'Server=<span class="strong"><strong class="calibre9">WAPMGT-SQLDB-01.wapcloud.com;User Id=sa;Password=*******;'</strong></span>
</pre></div></li><li class="listitem" value="2">Execute the following PowerShell on the Windows Azure Pack server to configure the Identity Provider to use ADFS:<div class="informalexample"><pre class="programlisting">Set-MgmtSvcIdentityProviderSettings -Target Membership -MetadataEndpoint https://adfs.wapcloud.com/FederationMetadata/2007-06/FederationMetadata.xml -DisableCertificateValidation -ConnectionString'Server=WAPMGT-SQLDB-01.wapcloud.com;User Id=sa;Password=*******;'</pre></div></li><li class="listitem" value="3">Execute the following PowerShell on the Windows Azure Pack server to configure the selected user as the administrator of WAP:<div class="informalexample"><pre class="programlisting">$adminuser = 'userap@domain.com'
$dbServer = <span class="strong"><strong class="calibre9">'WAPMGT-SQLDB-01.wapcloud.com'</strong></span>
$dbUsername = 'sa'
$dbPassword = 'SQL_Password'
$connectionString = [string]::Format('Server= {0} ;Initial Catalog=Microsoft.MgmtSvc.Store;User Id={1};Password={2};',$dbServer, $dbUsername, $dbPassword)
Add-MgmtSvcAdminUser -Principal $adminuser -ConnectionString $connectionstring</pre></div></li></ol><div class="calibre27"/></div><p class="calibre8">Post successful configuration, ADFS authentication can be verified by opening the WAP portal. The portal will automatically<a id="id1167" class="calibre1"/> redirect the authentication to the ADFS page.</p></div></div>
<div class="book" title="Summary" id="2KS221-b479cf466c26404ca54119871a9b2715"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec82" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">At the end of this chapter, we have completed building essential services for our WAP cloud solution. You learned about building a SMA solution for automating the WAP cloud resource provisioning, monitoring, and management. You learned about planning, installing, and configuring SMA. You learned about SMA assets and runbooks including authoring and managing runbooks.</p><p class="calibre8">We also covered using authentication capabilities of ADFS with Windows Azure Pack for admin and tenant portal authentication.</p><p class="calibre8">In the next chapter, we will look at the extensible architecture of the Windows Azure Pack cloud by learning about partner and third-party developed products for extending WAP capabilities and features.</p></div></body></html>