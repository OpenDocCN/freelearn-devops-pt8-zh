- en: Integrating On-Premise Networks with Azure Virtual Networks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, we covered the first part of the *Deploying and Managing
    Virtual Networks* objective. We covered virtual networking in Azure, and we covered
    the basics of virtual networking and configured private and public IP addresses.
    We also covered VNet peering.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter continues with thisobjective by covering how to integrate your
    on-premises network with an Azure virtual network. In this chapter, we are going
    to focus on VPN connections from your on-premises environment to Azure and from
    Azure to Azure as well. You will learn how to create an Azure VPN gateway, and
    you will learn how to configure a **Site-to-Site** (**S2S**) VPN using an on-premises
    server and the Azure VPN gateway. At the end of this chapter, we are going to
    look at a VNet-to-VNet connection and how this is similar to a S2S VPN.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following topics will be covered in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: Azure VPN gateway
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating and configuring an Azure VPN gateway
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating and configuring a S2S VPN
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Verifying on-premises connectivity
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: VNet-to-VNet
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This chapter uses Azure PowerShell for the examples: [https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0).
  prefs: []
  type: TYPE_NORMAL
- en: The source code for this chapter can be downloaded from the following GitHub
    link [https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter10](https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter10).
  prefs: []
  type: TYPE_NORMAL
- en: Azure VPN gateway
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure VPN provides a secure gateway that can be used for sending encrypted traffic over
    the internet, between an Azure virtual network and an on-premises location. This
    gateway can be used for sending encrypted traffic between different Azure virtual
    networks and the Microsoft networks as well.
  prefs: []
  type: TYPE_NORMAL
- en: For each virtual network, you can only have one VPN gateway. You can, however,
    create multiple connections to the same VPN gateway. When creating multiple connections,
    all of the VPN tunnels will share the available gateway bandwidth.
  prefs: []
  type: TYPE_NORMAL
- en: A **virtual network gateway** is created with two or more virtual machines that
    are deployed in a **gateway subnet**. This is a specific subnet that is created
    for the VPN connection. The VMs that are deployed in the gateway subnet are created
    at the same time the virtual network gateway is created. The VMs are then configured
    to contain specific gateway services and routing tables to connect to the gateway
    in Azure. It is not possible to configure the gateway services and routing tables manually.
  prefs: []
  type: TYPE_NORMAL
- en: 'Azure VPN gateway offers the following pricing tiers:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Basic**: This tier provides a maximum of 10 S2S/VNet-to-VNet tunnels and
    a maximum of 128 **Point-to-Site** (**P2S**) connections. The average bandwidth
    is 100 Mbps.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VpnGw1**: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and
    a maximum of 128 P2S connections. The average bandwidth is 650 Mbps.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VpnGw2**: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and
    a maximum of 128 P2S connections. The average bandwidth is 1 Gbps.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VpnGw3**: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and
    a maximum of 128 P2S connections. The average bandwidth is 1.25 Gbps.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: S2S VPNs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An S2S VPN gateway connection is a connection over an IPsec/IKE (IKEv1 or IKEv2)
    VPN tunnel. These connections can be used for hybrid configurations and cross-premises configurations.
    It is designed to create a secure connection between a location and your virtual
    network over the internet. The location can be an office, for instance. Once the
    S2S VPN connection is configured, you can connect from every device from that
    location to Azure using the same VPN location.
  prefs: []
  type: TYPE_NORMAL
- en: An S2S connection requires a compatible VPN device located on-premises that
    has a public IP address assigned to it. It should not be located behind a NAT.
  prefs: []
  type: TYPE_NORMAL
- en: For more information about the compatible VPN devices, you can refer to the
    following documentation: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#s2s](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#s2s).
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows a S2S VPN connection from an on-premises environment
    to Azure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/1b2cc700-4bb7-475c-8350-a5dc721144d2.png)'
  prefs: []
  type: TYPE_IMG
- en: S2S VPN
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we are going to look at **multi-site VPNs**.
  prefs: []
  type: TYPE_NORMAL
- en: Multi-site VPNs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A multi-site VPN is a variation of the S2S connection. You use this type of
    connection for connecting to multiple on-premises sites from your virtual network
    gateway. It is required that multi-site connections use a route-based VPN type
    gateway. All connections through the gateway will share the available bandwidth.
    This is because each virtual network can only have one VPN gateway.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows a multi-site VPN connection from an on-premises
    environment to Azure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/9034c6db-05bf-4ff6-8ec6-7d3d57d9a899.png)'
  prefs: []
  type: TYPE_IMG
- en: Multi-site VPN
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we are going to look at the **Point-to-Site** (**P2S**) VPN.
  prefs: []
  type: TYPE_NORMAL
- en: P2S VPNs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A P2S VPN gateway connection is designed to create a secure connection between
    an individual client and your virtual network over the internet. It is established
    from the client computer and is useful for people who are working from different
    locations, such as from their home or from a hotel. PS2 VPN is also the best solution
    if you only have a few clients to connect to a virtual network.
  prefs: []
  type: TYPE_NORMAL
- en: A P2S connection does not require an on-premises, public-facing IP address such
    as S2S VPN connections do. You can use P2S connections together with S2S connections
    over the same VPN gateway. You need to make sure that the configuration requirements
    for both connections are compatible so that you can use both connection types
    over the same gateway.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows a P2S VPN connection from an on-premises environment
    to Azure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/07bc981e-05d3-48d6-8d93-6fffc276abbe.png)'
  prefs: []
  type: TYPE_IMG
- en: P2S VPN
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we are going to look at **ExpressRoute**.
  prefs: []
  type: TYPE_NORMAL
- en: ExpressRoute
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: ExpressRoute offers a private connection that is facilitated by a connectivity
    provider. ExpressRoute connections don't go over the public internet, but they
    use a more reliable connection. These types of connections offer lower latencies,
    higher security, and faster speeds than connections that go over the internet.
    You can use it to extend your on-premises networks to Azure and Office 365\. Connections
    can be made from an any-to-any (IP VPN) network, a virtual cross-connection at
    a co-location facility, and a point-to-point Ethernet network connection.
  prefs: []
  type: TYPE_NORMAL
- en: ExpressRoute uses a virtual network gateway, which is configured with a gateway
    type of `ExpressRoute` instead of `VPN`. By default, the traffic is not encrypted,
    but you can create a solution that encrypts the traffic that goes over the ExpressRoute
    circuit.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows an ExpressRoute connection from an on-premises
    environment to Azure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/0f82ccc5-5296-4fec-9194-37e21669b988.png)'
  prefs: []
  type: TYPE_IMG
- en: ExpressRoute
  prefs: []
  type: TYPE_NORMAL
- en: Now that we have looked at the different types of VPN connections you can configure,
    we are now going to create and configure an Azure VPN gateway.
  prefs: []
  type: TYPE_NORMAL
- en: Creating and configuring an Azure VPN gateway
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the upcoming sections, we are going to configure an Azure VPN gateway, configure
    a S2S VPN, and verify the connectivity between Azure and the on-premises environment.
  prefs: []
  type: TYPE_NORMAL
- en: We are going to use Windows Server 2012 with **Routing and ****Remote Access
    Service** (**RRAS**) enabled on it to serve as the compatible VPN device that
    is installed on the on-premises environment.
  prefs: []
  type: TYPE_NORMAL
- en: Creating and configuring the on-premises VPN device
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'First, we are going to set up Windows Server 2012 and activate RRAS on it to
    set up the VPN. For this demonstration, I''ve created a virtual machine on my
    laptop with Windows Server 2012 R2 installed on it. To enable RRAS, perform the
    following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Make sure that the network adapter is set to bridged mode. The VPN gateway in
    Azure can't connect to a VPN that is behind a NAT.
  prefs: []
  type: TYPE_NORMAL
- en: 'Go to **Server Manager** | **Manage** | **Add Roles and Features**to enable
    RRAS:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/00e075cc-c2f1-4081-a13b-5fd5170396dc.png)'
  prefs: []
  type: TYPE_IMG
- en: Enabling RRAS on Windows Server 2012
  prefs: []
  type: TYPE_NORMAL
- en: 'Click **Next** on the first screen of the **Add Roles and Features Wizard**.
    On the next screen, select **Role-based or feature-based installation** and click **Next**.Select
    the server and click **Next**.On the **Server Roles** screen, select **Remote
    Access **and click **Next**:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/536d74eb-c863-478c-9f76-8b4af1be22ac.png)'
  prefs: []
  type: TYPE_IMG
- en: Enabling Remote Access
  prefs: []
  type: TYPE_NORMAL
- en: 'On the Features screen, we can click **Next** immediately. On the **Remote
    Access** screen, click **Next**:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/0763a8e0-88d0-4448-9a44-2ca882c5e984.png)'
  prefs: []
  type: TYPE_IMG
- en: Remote Access
  prefs: []
  type: TYPE_NORMAL
- en: 'On the **Role Services** screen, select **DirectAccess and VPN (RAS)**. A window
    will pop up asking you to add the required features. Click **Add features** and
    then click **Next**:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/22dabd18-d68c-4c1b-b541-6c2f29257ba8.png)'
  prefs: []
  type: TYPE_IMG
- en: Role Services
  prefs: []
  type: TYPE_NORMAL
- en: 'On the **Web Server Role (IIS)** screen, click Next.On the IIS role services
    screen, keep all of the default settings as they are and click **Next** again.
    In the last screen, verify the settings and click the **Install **button:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/9a2a6cd9-da2c-478f-af3e-6191110e34f7.png)'
  prefs: []
  type: TYPE_IMG
- en: Confirmation
  prefs: []
  type: TYPE_NORMAL
- en: The next step is to configure a VNet.
  prefs: []
  type: TYPE_NORMAL
- en: Creating a virtual network
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now that we''ve gone through the configuration of the on-premises VPN device,
    we are going to create a VNet. Therefore, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[Select **Create a resource** and then select **Networking** and the next **Virtual
    network**.](https://portal.azure.com/)'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the **Create virtual network** blade, add the following values:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktVPNVNet`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address space**: `172.17.0.0/16`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Resource group**: Create a new resource group and name it `PacktVPNResourceGroup`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location**: **East US**.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subnet**: **Frontend**.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address range**: `172.17.0.0/24`:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/02388ce9-017b-4f86-bf34-c0cdc629acff.png)'
  prefs: []
  type: TYPE_IMG
- en: Creating the VNet
  prefs: []
  type: TYPE_NORMAL
- en: Click Create to create the VNet.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Now we need to create a **Gateway subnet** that contains the reserved IP addresses
    that are used by the virtual network gateway services. Open the VNet resource
    and under **Settings**, click Subnets and then click **+ Gateway subnet** in the
    top menu:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/457d24b0-c3c9-47bb-bc57-9f0dd085c166.png)'
  prefs: []
  type: TYPE_IMG
- en: Adding a gateway subnet
  prefs: []
  type: TYPE_NORMAL
- en: 'In the Add subnet blade, adjust the address range to `172.17.255.0/27`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/a8bc0e4b-03b3-42d1-a32e-e76fbc73f8cd.png)'
  prefs: []
  type: TYPE_IMG
- en: Adjusting the address range
  prefs: []
  type: TYPE_NORMAL
- en: Click **OK**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Creating an Azure VPN gateway
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now we are going to configure the Azure VPN gateway. Perform the following
    steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the left menu, click **Create a resource** and type `Virtual network gateway` in
    the search box.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the **Create virtual network gateway**, add the following values:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktVnetGateway`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Gateway type**: VPN.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VPN type**: Route-based.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**SKU**: `VpnGw1`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location**: East US.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual network**: Click **Virtual network/Choose a virtual** **network**. Select `PacktVPNVNet`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Public IP address**: In here, you set the public IP address that is associated
    with the VPN gateway. The Azure VPN gateway only supports dynamically assigned
    IP addresses.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'However, once the IP address is associated with the VPN gateway, it will not
    change. The IP address will only change when the VPN gateway is recreated or deleted. Leave **Create
    new** selected. Name the IP address `PacktVNetGWIP`:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/cff60b07-a331-4c7e-bdbb-0df4b8cd5e01.png)'
  prefs: []
  type: TYPE_IMG
- en: Gateway settings
  prefs: []
  type: TYPE_NORMAL
- en: Click **Create** to create the Azure VPN gateway.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'We need the public IP address for the VPN gateway later in this demonstration,
    so go to the overview of the Azure VPN gateway when it has been created. In there,
    copy the public IP address to Notepad:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c2673e13-ec62-40df-9547-442d4e1c75a6.png)'
  prefs: []
  type: TYPE_IMG
- en: Obtaining the public IP address
  prefs: []
  type: TYPE_NORMAL
- en: 'After the creation of the gateway, open the **Overview** page of the VNet resource
    that we created earlier. The VPN gateway is displayed on the Overview page:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/13a6606f-c768-4237-9f70-fd5791bbe4db.png)'
  prefs: []
  type: TYPE_IMG
- en: VPN gateway in VNet
  prefs: []
  type: TYPE_NORMAL
- en: The Azure VPN gateway has been created, so we can now set up the S2S VPN connection
    with the on-premises environment.
  prefs: []
  type: TYPE_NORMAL
- en: Creating and configuring S2S VPN
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To create the S2S VPN, we are going to connect the VPN gateway with the on-premises environment
    we created earlier with RRAS enabled on it. This will serve as a compatible VPN
    device.
  prefs: []
  type: TYPE_NORMAL
- en: To be able to complete this step, we need the public IP address of the on-premises environment.
    I've used VMware for this demonstration and set it up in bridged mode. This way,
    the public IP address of your provider is used. You can check the public IP address
    using multiple tools, such as [https://www.whatsmyip.org/](https://www.whatsmyip.org/).
  prefs: []
  type: TYPE_NORMAL
- en: Creating the local network gateway
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: First, we need to create the local network gateway. This refers to the on-premises
    location where we have Windows Server 2012 R2 installed with RRAS enabled.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create the local network gateway, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/.](https://portal.azure.com/)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the left menu, click **Create a resource** and type `Local network gateway` in
    the search box. Select **Local network gateway** from the list and create a new
    one.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the **Create local network gateway** screen, add the following values:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktOnPremisesGateway`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**IP address**: Here, you need to fill in the public IP address from the on-premises VPN
    device where Azure needs to connect to.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address space**:`82.173.0.0/16`. This represents the address ranges for the
    on-premises network. You can add multiple address ranges.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Configure BGP settings**: Don''t select this.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subscription**: Select the same subscription that was used for the previous
    examples.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Resource group**: Select the resource group that we already created, that
    is, `PacktVPNResourceGroup`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location:** Select the same location where the VNet resides, that is, **East
    US**:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/68f14a99-d86f-4fba-8b1a-43d1fa18f3a1.png)'
  prefs: []
  type: TYPE_IMG
- en: Local network gateway settings
  prefs: []
  type: TYPE_NORMAL
- en: Click **Create**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Configuring the on-premises VPN device
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As we described in the previous section, S2S connections require a compatible
    VPN device. We already configured this in the first step. Now we need to configure
    this to connect to the Azure VPN gateway.
  prefs: []
  type: TYPE_NORMAL
- en: 'To configure RRAS so that they can connect to Azure, we need the following
    artifacts:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Shared key**: We are going to create a shared key that is used for connecting
    to the on-premises device.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**The public IP address of the Azure VPN gateway**: This is the public IP address
    that we copied to Notepad in one of the previous steps.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To create a new connection, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Open the local gateway that we created previously and under Settings, select Connections.
    Click the **Add** button at the top of the screen:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c5ea17b5-9877-46b6-a0b6-25fcf5be9a8d.png)'
  prefs: []
  type: TYPE_IMG
- en: Connections
  prefs: []
  type: TYPE_NORMAL
- en: 'In the **Add connection** blade, add the following values:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktVNetToSite`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Connection type**:Site-to-site (IPSec).'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual network gateway**: Click **Choose a local network gateway** and select `PacktVNetGateway`.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Local network gateway**: This is a fixed value.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Shared Key**: This value must be the same as for your local on-premises device.
    Fill this in with `Packt123`:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/64db1ead-6234-406a-a4c5-ec764585f347.png)'
  prefs: []
  type: TYPE_IMG
- en: Add a connection
  prefs: []
  type: TYPE_NORMAL
- en: Click **OK** to create the connection.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'After creation, you can select the connection from the **Connections **page.
    From there, you can download the configuration package that can be used to configure
    the on-premises VPN device. Click **Download configuration** from the top menu:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/b67f01ba-66cb-4b72-b69a-a8203d72cd2f.png)'
  prefs: []
  type: TYPE_IMG
- en: Downloading the configuration package
  prefs: []
  type: TYPE_NORMAL
- en: 'Since we are using RRAS, which is part of Windows Server, we need to select
    the following values:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Device vendor**: Generic Samples.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Device family**:Device Parameters.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Firmware version**: 1.0:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/c27d841c-30bc-464c-ba81-83afc9ca2b6f.png)'
  prefs: []
  type: TYPE_IMG
- en: Downloading configuration
  prefs: []
  type: TYPE_NORMAL
- en: Click **Download configuration**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The configuration package consists of a text file with all the necessary configuration
    values in it.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Switch over to the on-premises VM with Windows Server 2012 R2 on it and RRAS
    enabled. Perform the following steps on the VPN device with the Azure VPN gateway:'
  prefs: []
  type: TYPE_NORMAL
- en: Download the script from GitHub. This link is provided under the *Technical
    requirements* section at the beginning of this chapter. We are going to use this
    script to configure RRAS. We need to make some adjustments to the script so that
    we can add the Azure VPN gateway and local network addresses. You can use the
    IP address and the subnet address from the downloaded configuration file as input.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The first part of the script gives some additional information about the script
    and creates the `Invoke-WindowsApi` function:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'In the next part, we are going to build the dynamic assembly and define the
    method:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, we need to apply the `P/Invoke` constructor, thus creating the temporary
    type and invoking the method:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, we are going to prepare the parameter values and invoke the API:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we are going to install the RRAS role on the server:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'As we can see, the S2S VPN is installed from here:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Next, we need to add and configure it:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'In the last part of the script, we are going to set the connection to be persistent,
    restart the RRAS server, and dial-in to the Azure gateway:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: This script will also enable RRAS on your server. We did this manually in one
    of the first sections, so we have skipped this part.
  prefs: []
  type: TYPE_NORMAL
- en: We have finished configuring the on-premises VPN device. In the next section,
    we are going to verify on-premises connectivity.
  prefs: []
  type: TYPE_NORMAL
- en: Verifying on-premises connectivity
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are two different ways to verify on-premises connectivity. You can do
    this using the RRAS console on-premises and in the Azure portal.
  prefs: []
  type: TYPE_NORMAL
- en: 'To verify the connection using the RRAS console, open Windows search and type `Remote
    Access Management`.Then, open the node that is displayed in the following screenshot.
    As you can see, RRAS is connected with the Azure VPN gateway:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/2fdd16bb-13e4-4977-bb78-4c8fa46c243d.png)'
  prefs: []
  type: TYPE_IMG
- en: Verifying the connection in the RRAS console
  prefs: []
  type: TYPE_NORMAL
- en: 'To verify the connection from the Azure portal, perform the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Open the `PAcktVnetGateway` resource and under **Settings**, select Connections:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c2c5131d-2678-46c3-bef7-9d3e203e41d9.png)'
  prefs: []
  type: TYPE_IMG
- en: Verifying the connection in the Azure portal
  prefs: []
  type: TYPE_NORMAL
- en: When you select **Connections**, you will be able to see that the `PacktVNetToSite` connection
    is connected, as shown in the preceding screenshot.
  prefs: []
  type: TYPE_NORMAL
- en: VNet-to-VNet
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Configuring a VNet-to-VNet connection is a simple way to connect VNets. Connecting
    a virtual network to another virtual network is similar to creating a S2S IPSec
    connection to an on-premises environment. Both the connection types use the Azure
    VPN gateway. The VPN gateway provides a secure tunnel IPsec/IKE and they communicate
    in the same way. The difference is in the way the local network gateway is configured.
  prefs: []
  type: TYPE_NORMAL
- en: When you create a VNet-to-VNet connection, the local network gateway address
    space is automatically created and populated. If you update the address space
    for one VNet, the other VNet automatically routes to the updated address space.
    This makes it faster and easier to create a VNet-to-VNet connection than a S2S
    connection.
  prefs: []
  type: TYPE_NORMAL
- en: To create a VNet-to-VNet connection from the Azure portal, you can refer to
    the following tutorial: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal).
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we covered the second part of the *Deploying and Managing Virtual
    Networks *objective, by covering how to create and configure an Azure VPN gateway,
    how to create and configure S2S VPNs, and how to verify on-premises connectivity
    with Azure.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will continue with the third part of of the *Deploying
    and Managing Virtual Networks *objective by covering how to monitor and manage
    networking.
  prefs: []
  type: TYPE_NORMAL
- en: Questions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Answer the following questions to test your knowledge of the information in
    this chapter. You can find the answers in the *Assessments* section at the end
    of this book:'
  prefs: []
  type: TYPE_NORMAL
- en: 'ExpressRoute traffic is encrypted by default:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Your organization has a requirement for employees to connect from locations
    other than the office. Do you need to set up a P2S VPN connection for this?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'When you set up the on-premises VPN device for a S2S connection, your server
    isn''t allowed to be behind a NAT:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Further reading
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'You can check out the following links for more information about the topics
    that were covered in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Azure VPN Gateway Documentation*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/](https://docs.microsoft.com/en-us/azure/vpn-gateway/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*About Point-to-Site VPN*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/P2S-about](https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create a Site-to-Site connection in the Azure portal*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-S2S-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create a VNet with a Site-to-Site VPN connection using PowerShell*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-create-S2S-rm-powershell](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create a virtual network with a Site-to-Site VPN connection using CLI*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-S2S-resource-manager-cli](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*ExpressRoute overview*: [https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction](https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create and modify an ExpressRoute circuit*: [https://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-circuit-portal-resource-manager](https://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-circuit-portal-resource-manager)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Configure a VNet-to-VNet VPN gateway connection by using the Azure portal:* [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
