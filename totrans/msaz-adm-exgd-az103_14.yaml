- en: Integrating On-Premise Networks with Azure Virtual Networks
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, we covered the first part of the *Deploying and Managing
    Virtual Networks* objective. We covered virtual networking in Azure, and we covered
    the basics of virtual networking and configured private and public IP addresses.
    We also covered VNet peering.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: This chapter continues with thisobjective by covering how to integrate your
    on-premises network with an Azure virtual network. In this chapter, we are going
    to focus on VPN connections from your on-premises environment to Azure and from
    Azure to Azure as well. You will learn how to create an Azure VPN gateway, and
    you will learn how to configure a **Site-to-Site** (**S2S**) VPN using an on-premises
    server and the Azure VPN gateway. At the end of this chapter, we are going to
    look at a VNet-to-VNet connection and how this is similar to a S2S VPN.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: 'The following topics will be covered in this chapter:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: Azure VPN gateway
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating and configuring an Azure VPN gateway
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating and configuring a S2S VPN
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Verifying on-premises connectivity
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: VNet-to-VNet
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This chapter uses Azure PowerShell for the examples: [https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-1.8.0).
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: The source code for this chapter can be downloaded from the following GitHub
    link [https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter10](https://github.com/PacktPublishing/Microsoft-Azure-Administrator-Exam-Guide-AZ-103/tree/master/Chapter10).
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: Azure VPN gateway
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure VPN provides a secure gateway that can be used for sending encrypted traffic over
    the internet, between an Azure virtual network and an on-premises location. This
    gateway can be used for sending encrypted traffic between different Azure virtual
    networks and the Microsoft networks as well.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: For each virtual network, you can only have one VPN gateway. You can, however,
    create multiple connections to the same VPN gateway. When creating multiple connections,
    all of the VPN tunnels will share the available gateway bandwidth.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: A **virtual network gateway** is created with two or more virtual machines that
    are deployed in a **gateway subnet**. This is a specific subnet that is created
    for the VPN connection. The VMs that are deployed in the gateway subnet are created
    at the same time the virtual network gateway is created. The VMs are then configured
    to contain specific gateway services and routing tables to connect to the gateway
    in Azure. It is not possible to configure the gateway services and routing tables manually.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: 'Azure VPN gateway offers the following pricing tiers:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: '**Basic**: This tier provides a maximum of 10 S2S/VNet-to-VNet tunnels and
    a maximum of 128 **Point-to-Site** (**P2S**) connections. The average bandwidth
    is 100 Mbps.'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VpnGw1**: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and
    a maximum of 128 P2S connections. The average bandwidth is 650 Mbps.'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VpnGw2**: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and
    a maximum of 128 P2S connections. The average bandwidth is 1 Gbps.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VpnGw3**: This tier provides a maximum of 30 S2S/VNet-to-VNet tunnels and
    a maximum of 128 P2S connections. The average bandwidth is 1.25 Gbps.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: S2S VPNs
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An S2S VPN gateway connection is a connection over an IPsec/IKE (IKEv1 or IKEv2)
    VPN tunnel. These connections can be used for hybrid configurations and cross-premises configurations.
    It is designed to create a secure connection between a location and your virtual
    network over the internet. The location can be an office, for instance. Once the
    S2S VPN connection is configured, you can connect from every device from that
    location to Azure using the same VPN location.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: An S2S connection requires a compatible VPN device located on-premises that
    has a public IP address assigned to it. It should not be located behind a NAT.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: For more information about the compatible VPN devices, you can refer to the
    following documentation: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#s2s](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-vpn-faq#s2s).
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows a S2S VPN connection from an on-premises environment
    to Azure:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/1b2cc700-4bb7-475c-8350-a5dc721144d2.png)'
  id: totrans-26
  prefs: []
  type: TYPE_IMG
- en: S2S VPN
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we are going to look at **multi-site VPNs**.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: Multi-site VPNs
  id: totrans-29
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A multi-site VPN is a variation of the S2S connection. You use this type of
    connection for connecting to multiple on-premises sites from your virtual network
    gateway. It is required that multi-site connections use a route-based VPN type
    gateway. All connections through the gateway will share the available bandwidth.
    This is because each virtual network can only have one VPN gateway.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows a multi-site VPN connection from an on-premises
    environment to Azure:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/9034c6db-05bf-4ff6-8ec6-7d3d57d9a899.png)'
  id: totrans-32
  prefs: []
  type: TYPE_IMG
- en: Multi-site VPN
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we are going to look at the **Point-to-Site** (**P2S**) VPN.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: P2S VPNs
  id: totrans-35
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A P2S VPN gateway connection is designed to create a secure connection between
    an individual client and your virtual network over the internet. It is established
    from the client computer and is useful for people who are working from different
    locations, such as from their home or from a hotel. PS2 VPN is also the best solution
    if you only have a few clients to connect to a virtual network.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: A P2S connection does not require an on-premises, public-facing IP address such
    as S2S VPN connections do. You can use P2S connections together with S2S connections
    over the same VPN gateway. You need to make sure that the configuration requirements
    for both connections are compatible so that you can use both connection types
    over the same gateway.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows a P2S VPN connection from an on-premises environment
    to Azure:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/07bc981e-05d3-48d6-8d93-6fffc276abbe.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
- en: P2S VPN
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we are going to look at **ExpressRoute**.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: ExpressRoute
  id: totrans-42
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: ExpressRoute offers a private connection that is facilitated by a connectivity
    provider. ExpressRoute connections don't go over the public internet, but they
    use a more reliable connection. These types of connections offer lower latencies,
    higher security, and faster speeds than connections that go over the internet.
    You can use it to extend your on-premises networks to Azure and Office 365\. Connections
    can be made from an any-to-any (IP VPN) network, a virtual cross-connection at
    a co-location facility, and a point-to-point Ethernet network connection.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: ExpressRoute uses a virtual network gateway, which is configured with a gateway
    type of `ExpressRoute` instead of `VPN`. By default, the traffic is not encrypted,
    but you can create a solution that encrypts the traffic that goes over the ExpressRoute
    circuit.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: 'The following diagram shows an ExpressRoute connection from an on-premises
    environment to Azure:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/0f82ccc5-5296-4fec-9194-37e21669b988.png)'
  id: totrans-46
  prefs: []
  type: TYPE_IMG
- en: ExpressRoute
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: Now that we have looked at the different types of VPN connections you can configure,
    we are now going to create and configure an Azure VPN gateway.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: Creating and configuring an Azure VPN gateway
  id: totrans-49
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the upcoming sections, we are going to configure an Azure VPN gateway, configure
    a S2S VPN, and verify the connectivity between Azure and the on-premises environment.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: We are going to use Windows Server 2012 with **Routing and ****Remote Access
    Service** (**RRAS**) enabled on it to serve as the compatible VPN device that
    is installed on the on-premises environment.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: Creating and configuring the on-premises VPN device
  id: totrans-52
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'First, we are going to set up Windows Server 2012 and activate RRAS on it to
    set up the VPN. For this demonstration, I''ve created a virtual machine on my
    laptop with Windows Server 2012 R2 installed on it. To enable RRAS, perform the
    following steps:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: Make sure that the network adapter is set to bridged mode. The VPN gateway in
    Azure can't connect to a VPN that is behind a NAT.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: 'Go to **Server Manager** | **Manage** | **Add Roles and Features**to enable
    RRAS:'
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/00e075cc-c2f1-4081-a13b-5fd5170396dc.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
- en: Enabling RRAS on Windows Server 2012
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: 'Click **Next** on the first screen of the **Add Roles and Features Wizard**.
    On the next screen, select **Role-based or feature-based installation** and click **Next**.Select
    the server and click **Next**.On the **Server Roles** screen, select **Remote
    Access **and click **Next**:'
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/536d74eb-c863-478c-9f76-8b4af1be22ac.png)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
- en: Enabling Remote Access
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: 'On the Features screen, we can click **Next** immediately. On the **Remote
    Access** screen, click **Next**:'
  id: totrans-61
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/0763a8e0-88d0-4448-9a44-2ca882c5e984.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
- en: Remote Access
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: 'On the **Role Services** screen, select **DirectAccess and VPN (RAS)**. A window
    will pop up asking you to add the required features. Click **Add features** and
    then click **Next**:'
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/22dabd18-d68c-4c1b-b541-6c2f29257ba8.png)'
  id: totrans-65
  prefs: []
  type: TYPE_IMG
- en: Role Services
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: 'On the **Web Server Role (IIS)** screen, click Next.On the IIS role services
    screen, keep all of the default settings as they are and click **Next** again.
    In the last screen, verify the settings and click the **Install **button:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/9a2a6cd9-da2c-478f-af3e-6191110e34f7.png)'
  id: totrans-68
  prefs: []
  type: TYPE_IMG
- en: Confirmation
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: The next step is to configure a VNet.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: Creating a virtual network
  id: totrans-71
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now that we''ve gone through the configuration of the on-premises VPN device,
    we are going to create a VNet. Therefore, perform the following steps:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[Select **Create a resource** and then select **Networking** and the next **Virtual
    network**.](https://portal.azure.com/)'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the **Create virtual network** blade, add the following values:'
  id: totrans-75
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktVPNVNet`.'
  id: totrans-76
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address space**: `172.17.0.0/16`.'
  id: totrans-77
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Resource group**: Create a new resource group and name it `PacktVPNResourceGroup`.'
  id: totrans-78
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location**: **East US**.'
  id: totrans-79
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subnet**: **Frontend**.'
  id: totrans-80
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address range**: `172.17.0.0/24`:'
  id: totrans-81
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/02388ce9-017b-4f86-bf34-c0cdc629acff.png)'
  id: totrans-82
  prefs: []
  type: TYPE_IMG
- en: Creating the VNet
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: Click Create to create the VNet.
  id: totrans-84
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Now we need to create a **Gateway subnet** that contains the reserved IP addresses
    that are used by the virtual network gateway services. Open the VNet resource
    and under **Settings**, click Subnets and then click **+ Gateway subnet** in the
    top menu:'
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/457d24b0-c3c9-47bb-bc57-9f0dd085c166.png)'
  id: totrans-86
  prefs: []
  type: TYPE_IMG
- en: Adding a gateway subnet
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
- en: 'In the Add subnet blade, adjust the address range to `172.17.255.0/27`:'
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/a8bc0e4b-03b3-42d1-a32e-e76fbc73f8cd.png)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
- en: Adjusting the address range
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: Click **OK**.
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Creating an Azure VPN gateway
  id: totrans-92
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Now we are going to configure the Azure VPN gateway. Perform the following
    steps:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the left menu, click **Create a resource** and type `Virtual network gateway` in
    the search box.
  id: totrans-95
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the **Create virtual network gateway**, add the following values:'
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktVnetGateway`.'
  id: totrans-97
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Gateway type**: VPN.'
  id: totrans-98
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VPN type**: Route-based.'
  id: totrans-99
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**SKU**: `VpnGw1`.'
  id: totrans-100
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location**: East US.'
  id: totrans-101
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual network**: Click **Virtual network/Choose a virtual** **network**. Select `PacktVPNVNet`.'
  id: totrans-102
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Public IP address**: In here, you set the public IP address that is associated
    with the VPN gateway. The Azure VPN gateway only supports dynamically assigned
    IP addresses.'
  id: totrans-103
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'However, once the IP address is associated with the VPN gateway, it will not
    change. The IP address will only change when the VPN gateway is recreated or deleted. Leave **Create
    new** selected. Name the IP address `PacktVNetGWIP`:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/cff60b07-a331-4c7e-bdbb-0df4b8cd5e01.png)'
  id: totrans-105
  prefs: []
  type: TYPE_IMG
- en: Gateway settings
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: Click **Create** to create the Azure VPN gateway.
  id: totrans-107
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'We need the public IP address for the VPN gateway later in this demonstration,
    so go to the overview of the Azure VPN gateway when it has been created. In there,
    copy the public IP address to Notepad:'
  id: totrans-108
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/c2673e13-ec62-40df-9547-442d4e1c75a6.png)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
- en: Obtaining the public IP address
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: 'After the creation of the gateway, open the **Overview** page of the VNet resource
    that we created earlier. The VPN gateway is displayed on the Overview page:'
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/13a6606f-c768-4237-9f70-fd5791bbe4db.png)'
  id: totrans-112
  prefs: []
  type: TYPE_IMG
- en: VPN gateway in VNet
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: The Azure VPN gateway has been created, so we can now set up the S2S VPN connection
    with the on-premises environment.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: Creating and configuring S2S VPN
  id: totrans-115
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To create the S2S VPN, we are going to connect the VPN gateway with the on-premises environment
    we created earlier with RRAS enabled on it. This will serve as a compatible VPN
    device.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: To be able to complete this step, we need the public IP address of the on-premises environment.
    I've used VMware for this demonstration and set it up in bridged mode. This way,
    the public IP address of your provider is used. You can check the public IP address
    using multiple tools, such as [https://www.whatsmyip.org/](https://www.whatsmyip.org/).
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: Creating the local network gateway
  id: totrans-118
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: First, we need to create the local network gateway. This refers to the on-premises
    location where we have Windows Server 2012 R2 installed with RRAS enabled.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: 'To create the local network gateway, perform the following steps:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the Azure portal by opening [https://portal.azure.com/.](https://portal.azure.com/)
  id: totrans-121
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the left menu, click **Create a resource** and type `Local network gateway` in
    the search box. Select **Local network gateway** from the list and create a new
    one.
  id: totrans-122
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the **Create local network gateway** screen, add the following values:'
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Name**: `PacktOnPremisesGateway`.'
  id: totrans-124
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**IP address**: Here, you need to fill in the public IP address from the on-premises VPN
    device where Azure needs to connect to.'
  id: totrans-125
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Address space**:`82.173.0.0/16`. This represents the address ranges for the
    on-premises network. You can add multiple address ranges.'
  id: totrans-126
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Configure BGP settings**: Don''t select this.'
  id: totrans-127
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subscription**: Select the same subscription that was used for the previous
    examples.'
  id: totrans-128
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Resource group**: Select the resource group that we already created, that
    is, `PacktVPNResourceGroup`.'
  id: totrans-129
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Location:** Select the same location where the VNet resides, that is, **East
    US**:'
  id: totrans-130
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/68f14a99-d86f-4fba-8b1a-43d1fa18f3a1.png)'
  id: totrans-131
  prefs: []
  type: TYPE_IMG
- en: Local network gateway settings
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: Click **Create**.
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Configuring the on-premises VPN device
  id: totrans-134
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As we described in the previous section, S2S connections require a compatible
    VPN device. We already configured this in the first step. Now we need to configure
    this to connect to the Azure VPN gateway.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: 'To configure RRAS so that they can connect to Azure, we need the following
    artifacts:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: '**Shared key**: We are going to create a shared key that is used for connecting
    to the on-premises device.'
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**The public IP address of the Azure VPN gateway**: This is the public IP address
    that we copied to Notepad in one of the previous steps.'
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Azure VPN 网关的公共 IP 地址**：这是我们在之前步骤中复制到记事本中的公共 IP 地址。'
- en: 'To create a new connection, perform the following steps:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 要创建新连接，请执行以下步骤：
- en: 'Open the local gateway that we created previously and under Settings, select Connections.
    Click the **Add** button at the top of the screen:'
  id: totrans-140
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开我们之前创建的本地网关，在“设置”下，选择“连接”。点击屏幕顶部的**添加**按钮：
- en: '![](img/c5ea17b5-9877-46b6-a0b6-25fcf5be9a8d.png)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![](img/c5ea17b5-9877-46b6-a0b6-25fcf5be9a8d.png)'
- en: Connections
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 连接
- en: 'In the **Add connection** blade, add the following values:'
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**添加连接**面板中，添加以下值：
- en: '**Name**: `PacktVNetToSite`.'
  id: totrans-144
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**名称**：`PacktVNetToSite`。'
- en: '**Connection type**:Site-to-site (IPSec).'
  id: totrans-145
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**连接类型**：站点到站点（IPSec）。'
- en: '**Virtual network gateway**: Click **Choose a local network gateway** and select `PacktVNetGateway`.'
  id: totrans-146
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**虚拟网络网关**：点击**选择本地网络网关**并选择`PacktVNetGateway`。'
- en: '**Local network gateway**: This is a fixed value.'
  id: totrans-147
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**本地网络网关**：这是一个固定值。'
- en: '**Shared Key**: This value must be the same as for your local on-premises device.
    Fill this in with `Packt123`:'
  id: totrans-148
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**共享密钥**：该值必须与本地设备上的共享密钥相同。请填写`Packt123`：'
- en: '![](img/64db1ead-6234-406a-a4c5-ec764585f347.png)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![](img/64db1ead-6234-406a-a4c5-ec764585f347.png)'
- en: Add a connection
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 添加连接
- en: Click **OK** to create the connection.
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**确定**以创建连接。
- en: 'After creation, you can select the connection from the **Connections **page.
    From there, you can download the configuration package that can be used to configure
    the on-premises VPN device. Click **Download configuration** from the top menu:'
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建后，您可以从**连接**页面选择该连接。从那里，您可以下载配置包，用于配置本地 VPN 设备。点击顶部菜单中的**下载配置**：
- en: '![](img/b67f01ba-66cb-4b72-b69a-a8203d72cd2f.png)'
  id: totrans-153
  prefs: []
  type: TYPE_IMG
  zh: '![](img/b67f01ba-66cb-4b72-b69a-a8203d72cd2f.png)'
- en: Downloading the configuration package
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 正在下载配置包
- en: 'Since we are using RRAS, which is part of Windows Server, we need to select
    the following values:'
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 由于我们使用的是 RRAS，它是 Windows Server 的一部分，因此我们需要选择以下值：
- en: '**Device vendor**: Generic Samples.'
  id: totrans-156
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**设备供应商**：通用样本。'
- en: '**Device family**:Device Parameters.'
  id: totrans-157
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**设备类别**：设备参数。'
- en: '**Firmware version**: 1.0:'
  id: totrans-158
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**固件版本**：1.0：'
- en: '![](img/c27d841c-30bc-464c-ba81-83afc9ca2b6f.png)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![](img/c27d841c-30bc-464c-ba81-83afc9ca2b6f.png)'
- en: Downloading configuration
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 正在下载配置
- en: Click **Download configuration**.
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下载配置**。
- en: The configuration package consists of a text file with all the necessary configuration
    values in it.
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置包包含一个文本文件，文件中包含所有必要的配置值。
- en: 'Switch over to the on-premises VM with Windows Server 2012 R2 on it and RRAS
    enabled. Perform the following steps on the VPN device with the Azure VPN gateway:'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 切换到启用了 RRAS 的 Windows Server 2012 R2 的本地 VM，并在 Azure VPN 网关的 VPN 设备上执行以下步骤：
- en: Download the script from GitHub. This link is provided under the *Technical
    requirements* section at the beginning of this chapter. We are going to use this
    script to configure RRAS. We need to make some adjustments to the script so that
    we can add the Azure VPN gateway and local network addresses. You can use the
    IP address and the subnet address from the downloaded configuration file as input.
  id: totrans-164
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从 GitHub 下载脚本。该链接位于本章开头的*技术要求*部分。我们将使用此脚本来配置 RRAS。我们需要对脚本进行一些调整，以便添加 Azure VPN
    网关和本地网络地址。您可以使用从下载的配置文件中获取的 IP 地址和子网地址作为输入。
- en: 'The first part of the script gives some additional information about the script
    and creates the `Invoke-WindowsApi` function:'
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 脚本的第一部分提供了一些关于脚本的附加信息，并创建了`Invoke-WindowsApi`函数：
- en: '[PRE0]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'In the next part, we are going to build the dynamic assembly and define the
    method:'
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在下一部分中，我们将构建动态程序集并定义该方法：
- en: '[PRE1]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Next, we need to apply the `P/Invoke` constructor, thus creating the temporary
    type and invoking the method:'
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们需要应用`P/Invoke`构造函数，从而创建临时类型并调用方法：
- en: '[PRE2]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Then, we are going to prepare the parameter values and invoke the API:'
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，我们将准备参数值并调用 API：
- en: '[PRE3]'
  id: totrans-172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Now we are going to install the RRAS role on the server:'
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们将安装服务器上的 RRAS 角色：
- en: '[PRE4]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'As we can see, the S2S VPN is installed from here:'
  id: totrans-175
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如我们所见，S2S VPN 从这里安装：
- en: '[PRE5]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Next, we need to add and configure it:'
  id: totrans-177
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们需要添加并配置它：
- en: '[PRE6]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'In the last part of the script, we are going to set the connection to be persistent,
    restart the RRAS server, and dial-in to the Azure gateway:'
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在脚本的最后部分，我们将设置连接为持久连接，重新启动 RRAS 服务器，并拨号连接到 Azure 网关：
- en: '[PRE7]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This script will also enable RRAS on your server. We did this manually in one
    of the first sections, so we have skipped this part.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 本脚本还将启用服务器上的RRAS。我们在前面的一节中手动进行了此操作，因此跳过了这部分。
- en: We have finished configuring the on-premises VPN device. In the next section,
    we are going to verify on-premises connectivity.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已完成本地VPN设备的配置。在下一节中，我们将验证本地连接。
- en: Verifying on-premises connectivity
  id: totrans-183
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 验证本地连接
- en: There are two different ways to verify on-premises connectivity. You can do
    this using the RRAS console on-premises and in the Azure portal.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 有两种不同的方法可以验证本地连接。你可以使用本地的RRAS控制台，或者在Azure门户中执行此操作。
- en: 'To verify the connection using the RRAS console, open Windows search and type `Remote
    Access Management`.Then, open the node that is displayed in the following screenshot.
    As you can see, RRAS is connected with the Azure VPN gateway:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用RRAS控制台验证连接，打开Windows搜索并输入`远程访问管理`。然后，打开以下截图中显示的节点。如你所见，RRAS已与Azure VPN网关连接：
- en: '![](img/2fdd16bb-13e4-4977-bb78-4c8fa46c243d.png)'
  id: totrans-186
  prefs: []
  type: TYPE_IMG
  zh: '![](img/2fdd16bb-13e4-4977-bb78-4c8fa46c243d.png)'
- en: Verifying the connection in the RRAS console
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 在RRAS控制台中验证连接
- en: 'To verify the connection from the Azure portal, perform the following steps:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过Azure门户验证连接，请执行以下步骤：
- en: Navigate to the Azure portal by opening [https://portal.azure.com/](https://portal.azure.com/).
  id: totrans-189
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开[https://portal.azure.com/](https://portal.azure.com/)并进入Azure门户。
- en: 'Open the `PAcktVnetGateway` resource and under **Settings**, select Connections:'
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开`PAcktVnetGateway`资源，在**设置**下选择连接：
- en: '![](img/c2c5131d-2678-46c3-bef7-9d3e203e41d9.png)'
  id: totrans-191
  prefs: []
  type: TYPE_IMG
  zh: '![](img/c2c5131d-2678-46c3-bef7-9d3e203e41d9.png)'
- en: Verifying the connection in the Azure portal
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 在Azure门户中验证连接
- en: When you select **Connections**, you will be able to see that the `PacktVNetToSite` connection
    is connected, as shown in the preceding screenshot.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 当你选择**连接**时，你将能够看到`PacktVNetToSite`连接已经连接，如上图所示。
- en: VNet-to-VNet
  id: totrans-194
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: VNet到VNet
- en: Configuring a VNet-to-VNet connection is a simple way to connect VNets. Connecting
    a virtual network to another virtual network is similar to creating a S2S IPSec
    connection to an on-premises environment. Both the connection types use the Azure
    VPN gateway. The VPN gateway provides a secure tunnel IPsec/IKE and they communicate
    in the same way. The difference is in the way the local network gateway is configured.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 配置VNet到VNet的连接是连接VNets的简单方法。将虚拟网络连接到另一个虚拟网络类似于创建S2S IPSec连接到本地环境。两种连接类型都使用Azure
    VPN网关。VPN网关提供了一个安全的隧道IPsec/IKE，它们以相同的方式进行通信。区别在于本地网络网关的配置方式。
- en: When you create a VNet-to-VNet connection, the local network gateway address
    space is automatically created and populated. If you update the address space
    for one VNet, the other VNet automatically routes to the updated address space.
    This makes it faster and easier to create a VNet-to-VNet connection than a S2S
    connection.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 当你创建VNet到VNet的连接时，本地网络网关地址空间会自动创建并填充。如果你更新其中一个VNet的地址空间，另一个VNet会自动路由到更新后的地址空间。这使得创建VNet到VNet的连接比S2S连接更快、更简便。
- en: To create a VNet-to-VNet connection from the Azure portal, you can refer to
    the following tutorial: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal).
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 若要从Azure门户创建VNet到VNet的连接，请参考以下教程：[https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal)。
- en: Summary
  id: totrans-198
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we covered the second part of the *Deploying and Managing Virtual
    Networks *objective, by covering how to create and configure an Azure VPN gateway,
    how to create and configure S2S VPNs, and how to verify on-premises connectivity
    with Azure.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们介绍了*部署和管理虚拟网络*目标的第二部分，涉及如何创建和配置Azure VPN网关，如何创建和配置S2S VPN，以及如何验证本地与Azure的连接。
- en: In the next chapter, we will continue with the third part of of the *Deploying
    and Managing Virtual Networks *objective by covering how to monitor and manage
    networking.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将继续*部署和管理虚拟网络*目标的第三部分，介绍如何监控和管理网络。
- en: Questions
  id: totrans-201
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 问题
- en: 'Answer the following questions to test your knowledge of the information in
    this chapter. You can find the answers in the *Assessments* section at the end
    of this book:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 回答以下问题，以测试你对本章内容的理解。你可以在本书末尾的*评估*部分找到答案：
- en: 'ExpressRoute traffic is encrypted by default:'
  id: totrans-203
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ExpressRoute流量默认是加密的：
- en: 'Yes'
  id: totrans-204
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 是
- en: 'No'
  id: totrans-205
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 否
- en: Your organization has a requirement for employees to connect from locations
    other than the office. Do you need to set up a P2S VPN connection for this?
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  id: totrans-207
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  id: totrans-208
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'When you set up the on-premises VPN device for a S2S connection, your server
    isn''t allowed to be behind a NAT:'
  id: totrans-209
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  id: totrans-210
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'No'
  id: totrans-211
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Further reading
  id: totrans-212
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'You can check out the following links for more information about the topics
    that were covered in this chapter:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
- en: '*Azure VPN Gateway Documentation*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/](https://docs.microsoft.com/en-us/azure/vpn-gateway/)'
  id: totrans-214
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*About Point-to-Site VPN*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/P2S-about](https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about)'
  id: totrans-215
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create a Site-to-Site connection in the Azure portal*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-S2S-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal)'
  id: totrans-216
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create a VNet with a Site-to-Site VPN connection using PowerShell*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-create-S2S-rm-powershell](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell)'
  id: totrans-217
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create a virtual network with a Site-to-Site VPN connection using CLI*: [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-S2S-resource-manager-cli](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli)'
  id: totrans-218
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*ExpressRoute overview*: [https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction](https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction)'
  id: totrans-219
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Create and modify an ExpressRoute circuit*: [https://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-circuit-portal-resource-manager](https://docs.microsoft.com/en-us/azure/expressroute/expressroute-howto-circuit-portal-resource-manager)'
  id: totrans-220
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Configure a VNet-to-VNet VPN gateway connection by using the Azure portal:* [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal)'
  id: totrans-221
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
