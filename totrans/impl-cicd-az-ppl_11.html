<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer274">
<h1 class="chapter-number" id="_idParaDest-166"><a id="_idTextAnchor168"/>11</h1>
<h1 id="_idParaDest-167"><a id="_idTextAnchor169"/>Automating CI/CD for Cross-Mobile Applications by Using Flutter</h1>
<p>In the previous chapter, we learned how to create a pipeline to deploy a containerized web application on AWS. This chapter will take a deep dive into creating a pipeline to automate CI/CD for the Flutter mobile application. Flutter<a id="_idIndexMarker531"/> is the most famous software development kit for mobile applications. Developers can write mobile applications using only Flutter code instead of Kotlin code for Google and Swift code for Apple, and the Azure pipeline can build and deploy Flutter code to the Google and Apple stores. They are the most widely used stores in the context of mobile applications. By the end of this chapter, you will have learned how to create a pipeline using YAML to deploy a Flutter application on Google Firebase, with the Google Play Console, and in an <span class="No-Break">Apple environment.</span></p>
<p>We will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Explaining the <span class="No-Break">solution architecture</span></li>
<li>Implementing Google Firebase <span class="No-Break">for Flutter</span></li>
<li>Implementing an Apple environment <span class="No-Break">for Flutter</span></li>
<li>Implementing a Google Play Console environment <span class="No-Break">for Flutter</span></li>
<li>Navigating <span class="No-Break">common challenges</span></li>
</ul>
<h1 id="_idParaDest-168"><a id="_idTextAnchor170"/>Technical requirements</h1>
<p>You will find the code for this chapter <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines/tree/main/ch11"><span class="No-Break">https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines/tree/main/ch11</span></a><span class="No-Break">.</span></p>
<p>To complete the tasks described in this chapter, you will need to do <span class="No-Break">the following:</span></p>
<ul>
<li>Create a Firebase account and create a Firebase project by following the instructions in the official Firebase <span class="No-Break">guides: </span><a href="https://firebase.google.com/docs/guides"><span class="No-Break">https://firebase.google.com/docs/guides</span></a></li>
<li>Set up Flutter by following the instructions provided in the official Flutter <span class="No-Break">guides: </span><a href="https://docs.flutter.dev/get-started/install"><span class="No-Break">https://docs.flutter.dev/get-started/install</span></a></li>
<li>Download the Flutter code example from the GitHub repository for this <span class="No-Break">book: </span><a href="https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines"><span class="No-Break">https://github.com/PacktPublishing/Implementing-CI-CD-Using-Azure-Pipelines</span></a></li>
<li>Create and set up your app with the Google Play Console by following the instructions in the official Google <span class="No-Break">guides: </span><a href="https://support.google.com/googleplay/android-developer/answer/9859152?hl=en"><span class="No-Break">https://support.google.com/googleplay/android-developer/answer/9859152?hl=en</span></a></li>
<li>Create and set up your app in Apple Developer by following the instructions in the official Apple <span class="No-Break">guides: </span><a href="https://developer.apple.com/help/app-store-connect/create-an-app-record/add-a-new-app/"><span class="No-Break">https://developer.apple.com/help/app-store-connect/create-an-app-record/add-a-new-app/</span></a></li>
</ul>
<h1 id="_idParaDest-169"><a id="_idTextAnchor171"/>Explaining the solution architecture</h1>
<p>The following is a solution<a id="_idIndexMarker532"/> diagram that depicts how, in an Azure Pipelines workflow, to build your Flutter code and deploy it to Google Firebase, the Google Play Console, and Apple <span class="No-Break">Store Connect:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer261">
<img alt="Figure 11.1 – Solution diagram" height="344" src="image/B18875_11_1.jpg" width="487"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.1 – Solution diagram</p>
<p>We will create three pipelines for<a id="_idIndexMarker533"/> Flutter in development and production environments, as shown in the preceding diagram, because mobile applications need to be tested on internal user or customer environments, such as Google Firebase, before deploying to production in the Google and Apple stores. The solution diagram depicts the <span class="No-Break">following steps:</span></p>
<ol>
<li>Developers develop and test mobile applications using Flutter on their machines and push Flutter code to <span class="No-Break">Azure Repos.</span></li>
<li>After the Flutter code is uploaded to Azure Repos, Azure Repos will trigger a pipeline to build the Flutter code and deploy the Flutter applications to <span class="No-Break">Google Firebase.</span></li>
<li>After testing the Flutter applications on Google Firebase, the developers will trigger another pipeline to build the Flutter code and deploy the Flutter applications to the Google <span class="No-Break">Play Store.</span></li>
<li>After testing the Flutter applications on the Google Play Store, developers will trigger another pipeline to build Flutter code and deploy Flutter applications to Apple <span class="No-Break">Store </span><span class="No-Break"><a id="_idIndexMarker534"/></span><span class="No-Break">Connect.</span></li>
</ol>
<p>Before we build our Flutter mobile application and deploy it to the Google and Apple stores, we need to generate and upload certain secure files. Let’s look at <span class="No-Break">these next.</span></p>
<h1 id="_idParaDest-170"><a id="_idTextAnchor172"/>Managing secure files</h1>
<p>Before we build our Flutter <a id="_idIndexMarker535"/>mobile application and deploy it to the Google and Apple stores, we need to upload all the required files that tell the Google and Apple stores who you are, to check your developer profiles before they accept mobile applications. To do this, navigate to the <strong class="bold">Pipelines</strong> | <strong class="bold">Library</strong> | <strong class="bold">Secure files</strong> section and upload the following secure files to build and deploy the <span class="No-Break">Flutter application:</span></p>
<ul>
<li>You can generate an Apple certificate file based on the instructions provided at <a href="https://developer.apple.com/help/account/create-certificates/create-developer-id-certificates"><span class="No-Break">https://developer.apple.com/help/account/create-certificates/create-developer-id-certificates</span></a><span class="No-Break"> (</span><span class="No-Break"><strong class="source-inline">distribution.cer</strong></span><span class="No-Break">)</span></li>
<li>Create a provision profile based on the instructions at <a href="https://developer.apple.com/help/account/manage-provisioning-profiles/create-an-app-store-provisioning-profile"><span class="No-Break">https://developer.apple.com/help/account/manage-provisioning-profiles/create-an-app-store-provisioning-profile</span></a><span class="No-Break"> (</span><span class="No-Break"><strong class="source-inline">Hello_Flutter_AppStore.mobileprovision</strong></span><span class="No-Break">)</span></li>
<li>You can download the API key file (<strong class="source-inline">AuthKey_XXXXXXX.p8</strong>) from Apple Store Connect at <a href="https://appstoreconnect.apple.com/access/api">https://appstoreconnect.apple.com/access/api</a>, as shown in the <span class="No-Break">following screenshot:</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer262">
<img alt="Figure 11.2 – Generate API key" height="476" src="image/B18875_11_2.jpg" width="1167"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.2 – Generate API key</p>
<p>Once these files are uploaded, you<a id="_idIndexMarker536"/> will see a screen similar to <span class="No-Break">the following:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer263">
<img alt="Figure 11.3 – Secure files" height="792" src="image/B18875_11_3.jpg" width="1330"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.3 – Secure files</p>
<p>The following <a id="_idIndexMarker537"/>steps will show you how to prepare all the secure files shown in the preceding screenshot for Flutter <span class="No-Break">application deployment:</span></p>
<ol>
<li><strong class="bold">Personal Information Exchange file</strong> (<strong class="source-inline">Certificates_Distribution.p12</strong>): For Mac, navigate <a id="_idIndexMarker538"/>to <strong class="bold">Keychain Access</strong> at <a href="https://support.apple.com/en-gb/guide/keychain-access/kyca1083/mac">https://support.apple.com/en-gb/guide/keychain-access/kyca1083/mac</a> and the <strong class="bold">My Certificates</strong> tab. After that, select <strong class="bold">Apple Distribution</strong> (<strong class="source-inline">distribution.cer</strong>) to export it into a file with a different format, <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">Certificates_Distribution.p12</strong></span><span class="No-Break">.</span></li>
<li><strong class="bold">Key Store file</strong> (<strong class="source-inline">upload-keystore.jks</strong>): Run <a id="_idIndexMarker539"/>the following command to generate a key <span class="No-Break">store file:</span><pre class="source-code">
<strong class="bold">keytool -genkey -v -keystore upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload</strong></pre></li> <li>Create a secret group using the <strong class="bold">Library</strong> option of the Azure <span class="No-Break">DevOps portal:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer264">
<img alt="Figure 11.4 – Add a new variable group" height="467" src="image/B18875_11_4.jpg" width="829"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.4 – Add a new variable group</p>
<ol>
<li value="4">Create variables for deploying Android and iOS on Google Firebase, the Google Play Console, and the <span class="No-Break">App Store:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer265">
<img alt="Figure 11.5 – Add all variables" height="724" src="image/B18875_11_5.jpg" width="1025"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.5 – Add all variables</p>
<p class="list-inset">Let’s discuss the<a id="_idIndexMarker540"/> variables in <span class="No-Break">some detail:</span></p>
<ul>
<li><strong class="bold">ANDROID_APP_ID</strong>: Navigate to the Google Firebase project page, and you will find the app ID for the <span class="No-Break">Android project:</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer266">
<img alt="Figure 11.6 – App ID of Android project" height="1201" src="image/B18875_11_6.jpg" width="1470"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.6 – App ID of Android project</p>
<ul>
<li><strong class="bold">ANDROID_KEYSTORE</strong>: The <a id="_idIndexMarker541"/>following commands are used to generate it, after which you can copy the contents into the <span class="No-Break"><strong class="source-inline">data.b64</strong></span><span class="No-Break"> file:</span><pre class="source-code">
<strong class="bold">keytool -genkey -v -keystore upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload</strong>
<strong class="bold">certutil -encode upload-keystore.jks tmp.b64 &amp;&amp; findstr /v /c:- tmp.b64 &gt; data.b64</strong></pre></li> <li><strong class="bold">ANDROID_KEYSTORE_ALIAS</strong>: The value should <span class="No-Break">be </span><span class="No-Break"><strong class="source-inline">upload</strong></span><span class="No-Break">.</span></li>
<li><strong class="bold">ANDROID_KEYSTORE_FILE</strong>: The value should be <strong class="source-inline">upload-keystore.jks</strong>. This is a <strong class="bold">Java KeyStore</strong> (<strong class="bold">JKS</strong>) file<a id="_idIndexMarker542"/> used for signing <span class="No-Break">Android applications.</span></li>
<li><strong class="bold">ANDROID_KEYSTORE_PASSWORD</strong>: The password that you enter when you use the key store file generated in <span class="No-Break"><em class="italic">step 2</em></span><span class="No-Break">.</span></li>
<li><strong class="bold">ANDROID_KEYSTORE_PRIVATE_PASSWORD</strong>: The password that you enter when you use the key <span class="No-Break">store file.</span></li>
<li><strong class="bold">APPLE_CERTIFICATE_SIGNING_PASSWORD</strong>: The password when you export the <span class="No-Break">P12 file.</span></li>
<li><strong class="bold">FIREBASE_TOKEN</strong>: Run the following command to generate it, after which you can copy the <a id="_idIndexMarker543"/>Firebase token on the command <span class="No-Break">line result:</span><pre class="source-code">
<strong class="bold">firebase token:ci</strong></pre></li> <li><strong class="bold">IOS_APP_API_ISSUER</strong>, <strong class="bold">IOS_APP_API_KEY</strong> and <strong class="bold">IOS_AUTH_KEY_P8</strong>: Access the Apple Store Connect page at <a href="https://appstoreconnect.apple.com/access/users">https://appstoreconnect.apple.com/access/users</a> and navigate to the <strong class="bold">Keys</strong> section, where you can create a new API key and then download the API key file with the <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">p8</strong></span><span class="No-Break"> extension:</span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer267">
<img alt="Figure 11.7 – Generate API Key" height="719" src="image/B18875_11_7.jpg" width="1179"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.7 – Generate API Key</p>
<ol>
<li value="5">Next, identify<a id="_idIndexMarker544"/> the <strong class="bold">Issuer ID</strong>, <strong class="bold">KEY ID</strong>, and <strong class="bold">API Key</strong> file for Apple <span class="No-Break">application deployment:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer268">
<img alt="Figure 11.8 – Find Issuer ID, KEY ID, and API KEY file" height="504" src="image/B18875_11_08.jpg" width="1211"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.8 – Find Issuer ID, KEY ID, and API KEY file</p>
<ol>
<li value="6">Run the following command to convert the <strong class="source-inline">.p8</strong> file into the encode string and copy the value of the encode string into the variable <span class="No-Break">called </span><span class="No-Break"><strong class="bold">AUTH_KEY_P8</strong></span><span class="No-Break">:</span><pre class="source-code">
<strong class="bold">certutil -encode AuthKey_XXXX.p8 tmp.b64 &amp;&amp; findstr /v /c:- tmp.b64 &gt; data.b64</strong></pre></li> <li>For <strong class="bold">IOS_APP_ID</strong>, navigate to the Google Firebase project page, and you can find <strong class="bold">App ID</strong> under<a id="_idIndexMarker545"/> this section of your <span class="No-Break">Apple project:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer269">
<img alt="Figure 11.9 – App ID of Apple project" height="1244" src="image/B18875_11_09.jpg" width="1431"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.9 – App ID of Apple project</p>
<p>After preparing <a id="_idIndexMarker546"/>all the required variables and files, you can start to create a pipeline for building and deploying the Flutter application to Google Firebase, the Google Play Console, and the App Store. However, before we learn how to do this, let’s discuss some key tasks that are used for deploying Flutter applications to Google Firebase, Apple environments, and <span class="No-Break">Google Play.</span></p>
<h1 id="_idParaDest-171"><a id="_idTextAnchor173"/>Tasks required for Flutter applications on Google Firebase, Apple, and the Google Play Console</h1>
<p>Here<a id="_idIndexMarker547"/> are<a id="_idIndexMarker548"/> some of the <a id="_idIndexMarker549"/>key <span class="No-Break">tasks required:</span></p>
<ul>
<li><strong class="bold">JavaToolInstaller@0</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/java-tool-installer-v0?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/java-tool-installer-v0?view=azure-pipelines</a>): This package task is for setting up the Java compiler. It is a required package task when you need to build a Flutter <span class="No-Break">mobile application.</span></li>
<li><strong class="bold">Hey24sheep</strong> (<a href="https://marketplace.visualstudio.com/items?itemName=Hey24sheep.flutter">https://marketplace.visualstudio.com/items?itemName=Hey24sheep.flutter</a>): This package task is for setting up the Flutter compiler. It is a required package task when you need to build a Flutter <span class="No-Break">mobile application.</span></li>
<li><strong class="bold">CopyFiles@2</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/copy-files-v2?view=azure-pipelines&amp;tabs=yaml">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/copy-files-v2?view=azure-pipelines&amp;tabs=yaml</a>): This package task is for running the command to <span class="No-Break">copy files.</span></li>
<li><strong class="bold">PublishBuildArtifacts@1</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/publish-build-artifacts-v1?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/publish-build-artifacts-v1?view=azure-pipelines</a>): This package task is for publishing the Flutter build files to a temporary folder <span class="No-Break">named </span><span class="No-Break"><strong class="source-inline">Artifacts</strong></span><span class="No-Break">.</span></li>
<li><strong class="bold">Bash@3</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/bash-v3?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/bash-v3?view=azure-pipelines</a>): This<a id="_idIndexMarker550"/> package task is for running<a id="_idIndexMarker551"/> commands in a <a id="_idIndexMarker552"/>Bash <span class="No-Break">shell script.</span></li>
<li><strong class="bold">InstallAppleCertificate@2</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/install-apple-certificate-v2?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/install-apple-certificate-v2?view=azure-pipelines</a>): This package task is for installing Apple certificate files, which are used to verify Flutter applications for deploying to Apple <span class="No-Break">Store Connect.</span></li>
<li><strong class="bold">InstallAppleProvisioningProfile@1</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/install-apple-provisioning-profile-v1?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/install-apple-provisioning-profile-v1?view=azure-pipelines</a>): This package task is for installing an Apple provisioning profile file, which is used to verify a developer who is developing a Flutter application and deploying it to Apple <span class="No-Break">Store Connect.</span></li>
<li><strong class="bold">AppStoreRelease@1</strong> (https://marketplace.visualstudio.com/items?itemName=ms-vsclient.app-store#app-store-release): This package task is for deploying Flutter applications to Apple <span class="No-Break">Store Connect.</span></li>
<li><strong class="bold">AndroidSigning@3</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/android-signing-v3?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/android-signing-v3?view=azure-pipelines</a>): This package task is for signing an Android package or APK file before deploying it to the Google <span class="No-Break">Play Console.</span></li>
<li><strong class="bold">GooglePlayRelease@4</strong> (<a href="https://marketplace.visualstudio.com/items?itemName=ms-vsclient.google-play">https://marketplace.visualstudio.com/items?itemName=ms-vsclient.google-play</a>): This package task is for deploying Flutter applications to the Google <span class="No-Break">Play Console.</span></li>
<li><strong class="bold">DownloadSecureFile@1</strong> (<a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/download-secure-file-v1?view=azure-pipelines">https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/download-secure-file-v1?view=azure-pipelines</a>): This <a id="_idIndexMarker553"/>package task is for downloading the secure files from the <strong class="bold">Secure files</strong> section <a id="_idIndexMarker554"/>of the <strong class="bold">Variable groups</strong> menu. In <a id="_idIndexMarker555"/>our case, it is a signing file to sign a Flutter application before deploying it on the Google <span class="No-Break">Play Console.</span></li>
</ul>
<p>In the next section, you will learn how to implement Google Firebase <span class="No-Break">for Flutter.</span></p>
<h1 id="_idParaDest-172"><a id="_idTextAnchor174"/>Implementing Google Firebase for Flutter</h1>
<p>To <a id="_idIndexMarker556"/>build and deploy Flutter applications on <a id="_idIndexMarker557"/>Google Firebase in both <strong class="bold">Android</strong> and <strong class="bold">iOS</strong>, you need to use the tasks discussed in the previous section. First, let’s learn how we can create a pipeline for building and deploying the Flutter application to Google Firebase <span class="No-Break">on Android.</span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor175"/>Creating a pipeline for Google Firebase on Android</h2>
<p>To create an <a id="_idIndexMarker558"/>Android pipeline, we first need to prepare<a id="_idIndexMarker559"/> an Ubuntu environment and install the Flutter compiler. After that, it will build your code into a binary file and upload it to Google Firebase App Distribution. You can follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Create a pipeline file for Android called <strong class="source-inline">azure-pipeline-for-firebase-android.yml</strong> and paste the following <span class="No-Break">code snippets:</span><ul><li>The first part of the YAML file is for preparing all variables that will use the entirety of this Azure pipeline. It also declares the operating system for building this file, which is Ubuntu in <span class="No-Break">this scenario:</span><pre class="source-code">
trigger: none
pool:
  vmImage: "ubuntu-latest"
variables:
  - group: secrets
  - name: androidReleaseDir
    value: $(build.artifactStagingDirectory)/flutter/hello_world/build/app/outputs/flutter-apk
  - name: apkFile
    value: $(androidReleaseDir)/app-release.apk</pre></li><li>This<a id="_idIndexMarker560"/> task is for the pre-installation <a id="_idIndexMarker561"/>of the Java library for building <span class="No-Break">your code:</span><pre class="source-code">jobs:
  - job: android_deployment
    steps:
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '11'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'</pre></li><li>This task is for the pre-installation of the Flutter compiler for building <span class="No-Break">your code:</span><pre class="source-code">- task: Hey24sheep.flutter.flutter-install.FlutterInstall@0
      displayName: 'Flutter Install'
      inputs:
        version: custom
        customVersion: 3.10.6</pre></li><li>This <a id="_idIndexMarker562"/>task is for building your<a id="_idIndexMarker563"/> code and creating an <span class="No-Break">APK file:</span><pre class="source-code">- task: Hey24sheep.flutter.flutter-build.FlutterBuild@0
      displayName: "Build APK"
      inputs:
        target: apk
        projectDirectory: "./flutter/hello_world"
        buildNumber: ""</pre></li><li>This task is for signing an APK file to allow Android phones to launch <span class="No-Break">your application:</span><pre class="source-code">- task: AndroidSigning@3
      displayName: "Signing and aligning APK file(s) **/*.apk"
      inputs:
        apkFiles: "**/*.apk"
        apksign: true
        apksignerKeystoreFile: "upload-keystore.jks"
        apksignerKeystorePassword: "$(ANDROID_KEYSTORE_PRIVATE_PASSWORD)"
        apksignerKeystoreAlias: "$(ANDROID_KEYSTORE_ALIAS)"
        apksignerKeyPassword: "$(ANDROID_KEYSTORE_PASSWORD)"</pre></li><li>This task is for copying a signed APK file to the artifact directory before uploading it to Azure <span class="No-Break">Pipelines storage:</span><pre class="source-code">- task: CopyFiles@2
      displayName: "Copy apk to artifact directory"
      inputs:
        contents: "**/*.apk"
        targetFolder: "$(build.artifactStagingDirectory)"</pre></li><li>This task is for publishing a signed APK file to Azure <span class="No-Break">Pipelines storage:</span><pre class="source-code">- task: PublishBuildArtifacts@1
      displayName: "Publish signed apk as artifact"
      inputs:
        artifactName: "drop"</pre></li><li>This<a id="_idIndexMarker564"/> task is for uploading a<a id="_idIndexMarker565"/> signed APK file from Azure Pipelines storage to Google Firebase App Distribution and letting all users download it <span class="No-Break">for testing:</span><pre class="source-code">- task: Bash@3
      displayName: "Upload to firebase app distribution"
      inputs:
        targetType: "inline"
        script: |
          npm i -g firebase-tools
          ls -la $(androidReleaseDir)
          firebase appdistribution:distribute "$(apkFile)" \
            --app "$(ANDROID_APP_ID)" \
            --release-notes "Build Android From Azure Pipeline" \
            --groups "beta-testers" \
            --token "$(FIREBASE_TOKEN)"</pre></li></ul></li> <li>For<a id="_idIndexMarker566"/> Android, when a pipeline <a id="_idIndexMarker567"/>build is successful, you can see the result in the <strong class="bold">App Distribution</strong> section of <span class="No-Break">Google Firebase:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer270">
<img alt="Figure 11.10 – App Distribution for the Android project" height="374" src="image/B18875_11_10.jpg" width="1172"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.10 – App Distribution for the Android project</p>
<p>In the next section, let’s learn how to do this <span class="No-Break">on iOS.</span></p>
<h2 id="_idParaDest-174"><a id="_idTextAnchor176"/>Creating a pipeline for Google Firebase on iOS</h2>
<p>To create an <a id="_idIndexMarker568"/>iOS pipeline, we first prepare a macOS <a id="_idIndexMarker569"/>environment and install the Flutter compiler. After that, it will build your code into a binary file and upload it to Google <span class="No-Break">Firebase Distribution:</span></p>
<ol>
<li>Create a pipeline file for Android called <strong class="source-inline">azure-pipeline-for-firebase-ios.yml</strong> and paste the following <span class="No-Break">code snippets:</span><ul><li>The first part of the YAML file is for preparing all variables that will use the entirety of this Azure pipeline. It also declares the operating system for building this file, which is the latest version <span class="No-Break">of macOS:</span><pre class="source-code">
trigger: none
pool:
  vmImage: "macos-latest"
variables:
  - group: secrets
  - name: iosReleaseDir
    value: $(Build.SourcesDirectory)/flutter/hello_world/build/ios/ipa
  - name: ipaFile
    value: $(iosReleaseDir)/hello_world.ipa
  - name: rootPath
    value: $(System.DefaultWorkingDirectory)/flutter/hello_world</pre></li><li>This <a id="_idIndexMarker570"/>task is for pre-installing the <a id="_idIndexMarker571"/>Java library for building <span class="No-Break">your code:</span><pre class="source-code">jobs:
  - job: ios_deployment
    steps:
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '11'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'</pre></li><li>This task is for installing Apple certificate that is required for building an <span class="No-Break">iOS application:</span><pre class="source-code">- task: InstallAppleCertificate@2
      displayName: "Install Apple cert dist p12"
      inputs:
        certSecureFile: "Certificates_Distribution.p12"
        certPwd: "$(APPLE_CERTIFICATE_SIGNING_PASSWORD)"
        keychain: "temp"</pre></li><li>This task is for installing an Apple provisioning profile, which is required for building an <span class="No-Break">iOS application:</span><pre class="source-code">    - task: InstallAppleProvisioningProfile@1
      displayName: "Install Apple Mobile Provisioning Profile"
      inputs:
        provisioningProfileLocation: "secureFiles"
        provProfileSecureFile: "Hello_Flutter_AppStore.mobileprovision"</pre></li><li>This<a id="_idIndexMarker572"/> task is for installing the Flutter<a id="_idIndexMarker573"/> compiler to build <span class="No-Break">your code:</span><pre class="source-code">- task: Hey24sheep.flutter.flutter-install.FlutterInstall@0
      displayName: 'Flutter Install'
      inputs:
        version: custom
        customVersion: 3.10.6</pre></li><li>This task is for building your code and creating<a id="_idIndexMarker574"/> an <strong class="bold">iOS App Store Package</strong> (<span class="No-Break"><strong class="bold">IPA</strong></span><span class="No-Break">) file:</span><pre class="source-code">    - task: Bash@3
      displayName: "Build IPA"
      inputs:
        targetType: "inline"
        script: |
          flutter build ipa --export-options-plist=$(rootPath)/ios/Runner/ExportOptions.plist
        workingDirectory: $(rootPath)</pre></li><li>This <a id="_idIndexMarker575"/>task is for uploading an IPA file to<a id="_idIndexMarker576"/> Google Firebase <span class="No-Break">App Distribution:</span><pre class="source-code">- task: Bash@3
      displayName: "Upload to firebase app distribution"
      inputs:
        targetType: "inline"
        script: |
          npm i -g firebase-tools
          ls -la $(iosReleaseDir)
          firebase appdistribution:distribute "$(ipaFile)" \
            --app "$(IOS_APP_ID)" \
            --release-notes "Build iOS From Azure Pipeline" \
            --groups "beta-testers" \
            --token "$(FIREBASE_TOKEN)"</pre></li></ul></li> <li>Similar to<a id="_idIndexMarker577"/> Android, when a pipeline build is<a id="_idIndexMarker578"/> successful, you can see the result in the <strong class="bold">App Distribution</strong> section of <span class="No-Break">Google Firebase:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer271">
<img alt="Figure 11.11 – App Distribution for the Apple project" height="476" src="image/B18875_11_11.jpg" width="1104"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.11 – App Distribution for the Apple project</p>
<p>This section discussed how to build and deploy the Flutter application on Google Firebase for testing before deploying it to the Google Play Console or App Store. Next, let’s discuss how we can create and deploy Flutter applications on Apple <span class="No-Break">Store Connect.</span></p>
<h1 id="_idParaDest-175"><a id="_idTextAnchor177"/>Implementing an Apple environment for Flutter</h1>
<p>To build <a id="_idIndexMarker579"/>and deploy Flutter applications on<a id="_idIndexMarker580"/> Apple Store Connect, you need to use the various tasks in an Azure pipeline, as discussed earlier in this chapter. To reduce the time needed for mobile application deployment process, it is necessary to construct the Apple Store deployment pipeline. To do this, you can follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Create a pipeline file called <strong class="source-inline">azure-pipeline-for-apple-store.yml</strong> and paste the following <span class="No-Break">code snippets:</span><ul><li>The first part of the YAML file is for preparing all variables that will use the entirety of this Azure pipeline. It also declares the operating system for building this file, which is the latest version <span class="No-Break">of macOS:</span><pre class="source-code">
trigger: none
pool:
  vmImage: "macos-latest"
variables:
  - group: secrets
  - name: iosReleaseDir
    value: $(Build.SourcesDirectory)/flutter/hello_world/build/ios/ipa
  - name: ipaFile
    value: $(iosReleaseDir)/hello_world.ipa
  - name: rootPath
    value: $(System.DefaultWorkingDirectory)/flutter/hello_world</pre></li><li>This <a id="_idIndexMarker581"/>task is for the pre-installation<a id="_idIndexMarker582"/> of the Java library for building <span class="No-Break">your code:</span><pre class="source-code">jobs:
  - job: ios_to_apple_store
    steps:
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '11'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'</pre></li><li>This task is for installing the Apple certificate that is required for building an <span class="No-Break">iOS application:</span><pre class="source-code">    - task: InstallAppleCertificate@2
      displayName: "Install Apple cert dist p12"
      inputs:
        certSecureFile: "Certificates_Distribution.p12"
        certPwd: "$(APPLE_CERTIFICATE_SIGNING_PASSWORD)"
        keychain: "temp"</pre></li><li>This <a id="_idIndexMarker583"/>task is for installing an <a id="_idIndexMarker584"/>Apple provisioning profile, which is required for building an <span class="No-Break">iOS application:</span><pre class="source-code">    - task: InstallAppleProvisioningProfile@1
      displayName: "Install Apple Mobile Provisioning Profile"
      inputs:
        provisioningProfileLocation: "secureFiles"
        provProfileSecureFile: "Hello_Flutter_AppStore.mobileprovision"</pre></li><li>This task is for installing the Flutter compiler to build <span class="No-Break">your code:</span><pre class="source-code">    - task: Hey24sheep.flutter.flutter-install.FlutterInstall@0
      displayName: 'Flutter Install'
      inputs:
        version: custom
        customVersion: 3.10.6</pre></li><li>This task is for building your code and creating an <span class="No-Break">IPA file:</span><pre class="source-code">- task: Bash@3
      displayName: "Build IPA"
      inputs:
        targetType: "inline"
        script: |
          flutter build ipa --export-options-plist=$(rootPath)/ios/Runner/ExportOptions.plist
        workingDirectory: $(rootPath)</pre></li><li>This<a id="_idIndexMarker585"/> task is for uploading <a id="_idIndexMarker586"/>a signed IPA file to Apple <span class="No-Break">Store Connect:</span><pre class="source-code">- task: AppStoreRelease@1
      displayName: "Upload to App Store Connect"
      inputs:
        authType: 'ApiKey'
        apiKeyId: '$(IOS_APP_API_KEY)'
        apiKeyIssuerId: '$(IOS_APP_API_ISSUER)'
        apiToken: '$(IOS_AUTH_KEY_P8)'
        releaseTrack: 'TestFlight'
        appIdentifier: 'com.company.flutter'
        appType: 'iOS'
        ipaPath: $(ipaFile)
        shouldSkipWaitingForProcessing: true
        shouldSkipSubmission: true
        appSpecificId: '$(IOS_APP_ID)'</pre></li></ul></li> <li>When a<a id="_idIndexMarker587"/> pipeline build is successful, you <a id="_idIndexMarker588"/>can see the result in the <strong class="bold">App Store Connect</strong> | <span class="No-Break"><strong class="bold">TestFlight</strong></span><span class="No-Break"> tab:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer272">
<img alt="Figure 11.12 – TestFlight on App Store Connect" height="668" src="image/B18875_11_12.jpg" width="1584"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.12 – TestFlight on App Store Connect</p>
<p>In this section, you learned how to create a pipeline to build and deploy Flutter applications on Apple Store Connect. In the next section, you will learn how to build and deploy Flutter applications on the Google <span class="No-Break">Play Console.</span></p>
<h1 id="_idParaDest-176"><a id="_idTextAnchor178"/>Implementing a Google Play Console for Flutter</h1>
<p>You can<a id="_idIndexMarker589"/> create an Azure pipeline when you need to <a id="_idIndexMarker590"/>upload your application to the Google Play Store, which is a marketplace for Android applications that allows all Android users to download applications. To do this, follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Create a pipeline file called <strong class="source-inline">azure-pipeline-for-google-play-store.yml</strong> and paste the following <span class="No-Break">code snippets:</span><ul><li>The first part of the YAML file is for preparing all variables that will use the entirety of this Azure pipeline. It also declares the operating system for building this file, which <span class="No-Break">is Ubuntu:</span><pre class="source-code">
trigger: none
pool:
  vmImage: "ubuntu-latest"
variables:
  - group: secrets
  - name: androidReleaseDir
    value: $(build.artifactStagingDirectory)/flutter/hello_world/build/app/outputs/bundle/release
  - name: aabFile
    value: $(androidReleaseDir)/app-release.aab</pre></li><li>This <a id="_idIndexMarker591"/>task is for downloading the <a id="_idIndexMarker592"/>keystore file, which is needed to sign an <strong class="bold">Android App Bundle</strong> (<strong class="bold">AAB</strong>) file<a id="_idIndexMarker593"/> before uploading it to the Google <span class="No-Break">Play Console:</span><pre class="source-code">jobs:
  - job: android_to_google_play_store
    steps:
    - task: DownloadSecureFile@1
      displayName: "Download keystore file"
      name: "KeyStoreFile"
      inputs:
        secureFile: "upload-keystore.jks"</pre></li><li>This task is for pre-installing the Java library for building <span class="No-Break">your code:</span><pre class="source-code">    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '11'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'</pre></li><li>This<a id="_idIndexMarker594"/> task is for installing the<a id="_idIndexMarker595"/> Flutter compiler to build <span class="No-Break">your code:</span><pre class="source-code">    - task: Hey24sheep.flutter.flutter-install.FlutterInstall@0
      displayName: 'Flutter Install'
      inputs:
        version: custom
        customVersion: 3.10.6</pre></li><li>This task is for building Flutter code in an <span class="No-Break">AAB file:</span><pre class="source-code">    - task: Hey24sheep.flutter.flutter-build.FlutterBuild@0
      displayName: "Build AAB"
      inputs:
        target: aab
        projectDirectory: "./flutter/hello_world"
        buildNumber: ""</pre></li><li>This task is for copying an AAB file from the source folder to an <span class="No-Break">artifact folder:</span><pre class="source-code">    - task: CopyFiles@2
      displayName: "Copy aab to artifact directory"
      inputs:
        contents: "**/*.aab"
        targetFolder: "$(build.artifactStagingDirectory)"</pre></li><li>This task is for moving a signed AAB file to Azure <span class="No-Break">Pipelines storage:</span><pre class="source-code">    - task: PublishBuildArtifacts@1
      displayName: "Publish signed AAB as artifact"
      inputs:
        artifactName: "drop"</pre></li><li>This<a id="_idIndexMarker596"/> task is for uploading an <a id="_idIndexMarker597"/>AAB file to the Google <span class="No-Break">Play Store:</span><pre class="source-code">    - task: GooglePlayRelease@4
      displayName: "Upload to Google Play Store"
      inputs:
        serviceConnection: 'GooglePlayConsole'
        applicationId: 'com.company.flutter'
        action: 'SingleBundle'
        bundleFile: '$(aabFile)'
        track: 'internal'
        isDraftRelease: true</pre></li></ul></li> <li>When a pipeline build is successful, you can see the result in the Google <span class="No-Break">Play Console:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer273">
<img alt="Figure 11.13 – Internal testing on the Google Play Console" height="454" src="image/B18875_11_13.jpg" width="937"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.13 – Internal testing on the Google Play Console</p>
<p>In this section, you learned how to create a pipeline to build and deploy Flutter applications using the internal testing of the Google Play Console. It will help you to focus on application development after you finish setting up <span class="No-Break">the pipelines.</span></p>
<h1 id="_idParaDest-177"><a id="_idTextAnchor179"/>Navigating common challenges</h1>
<p>During Flutter <a id="_idIndexMarker598"/>development, you may face certain common issues that can be prevented if certain best practices are followed. Let’s discuss a couple <span class="No-Break">of them:</span></p>
<ul>
<li><strong class="bold">Managing dependencies</strong>: In Flutter development, two important files are used for managing project dependencies and ensuring consistency across different <span class="No-Break">development environments:</span><ul><li><strong class="source-inline">pubspec.yaml</strong>: This contains the name of the dependencies that you use for Flutter development, such as <span class="No-Break">database dependencies.</span></li><li><strong class="source-inline">pubspec.lock</strong>: This contains the name and version of dependencies that you use for <span class="No-Break">Flutter development.</span></li></ul><p class="list-inset">Ensure that you commit <strong class="source-inline">pubspec.lock</strong> to Azure Repos because if you miss this step, you will get an error. This is because you will get a new <strong class="source-inline">pubspec.lock</strong> file, which will contain a different version of the dependencies that you used when you developed the Flutter application on <span class="No-Break">your computer.</span></p></li>
<li><strong class="bold">Handling platform-specific code</strong>: Flutter allows you to write platform-specific code but managing this in a CI/CD pipeline can be tricky, especially when your application has custom platform-specific modules <span class="No-Break">or dependencies.</span><p class="list-inset">Use separate tasks in Azure Pipelines to handle platform-specific builds. For example, you might have different stages or jobs for iOS and Android builds. Ensure that the<a id="_idIndexMarker599"/> necessary SDKs and tools for each platform are installed and configured in your Azure <span class="No-Break">Pipelines environment.</span></p></li>
</ul>
<p>Now that you’re well-equipped for Flutter development, let’s wrap this <span class="No-Break">chapter up.</span></p>
<h1 id="_idParaDest-178"><a id="_idTextAnchor180"/>Summary</h1>
<p>This chapter taught you how to create build pipelines for Flutter applications. It covered pipelines for Google Firebase – both Android and Apple. It also covered pipelines for Apple Store Connect and Google Play Console deployment. This will help to reduce the time required by developers to create manual commands when they need to build and deploy Flutter applications. This will also help developers focus on developing mobile applications, because you create a pipeline only once and let an Azure pipeline build your code and deploy your application to Google Firebase, Apple Store Connect, and the Google Play Store automatically. This will increase <span class="No-Break">developer productivity.</span></p>
<p>In the last chapter, we will learn about some common pitfalls to avoid when using Azure Pipelines and discuss the potential future applications and trends of <span class="No-Break">this technology.</span></p>
</div>
</div></body></html>