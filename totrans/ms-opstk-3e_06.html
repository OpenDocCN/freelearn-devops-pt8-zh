<html><head></head><body>
  <div id="_idContainer099">
   <h1 class="chapter-number" id="_idParaDest-114">
    <a id="_idTextAnchor159">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     6
    </span>
   </h1>
   <h1 id="_idParaDest-115">
    <a id="_idTextAnchor160">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     OpenStack Networking – Connectivity and Managed Service Options
    </span>
   </h1>
   <p class="author-quote">
    <span class="koboSpan" id="kobo.3.1">
     “It always seems impossible until it’s done.”
    </span>
   </p>
   <p class="author-quote">
    <span class="koboSpan" id="kobo.4.1">
     – Nelson Mandela
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.5.1">
     Neutron, the OpenStack networking service, has evolved throughout different OpenStack releases, offering more capabilities and features.
    </span>
    <span class="koboSpan" id="kobo.5.2">
     Cloud architects can design their OpenStack networking stack with multiple topologies, based on their existing networking resources and requirements.
    </span>
    <span class="koboSpan" id="kobo.5.3">
     Unlike the former Nova networking service, which was bound only to basic networking offerings, OpenStack tenants can expect more granular networking control and flexibility with Neutron.
    </span>
    <span class="koboSpan" id="kobo.5.4">
     Cloud and network administrators can offer more advanced networking features to tenants, such as routing, firewalls, load balancing, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.6.1">
      private networking.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.7.1">
     In this chapter, we will walk through the rich updates that have been made to OpenStack networking by covering the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.8.1">
      following topics:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.9.1">
      The Neutron architecture and its core service interactions
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.10.1">
       in OpenStack
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.11.1">
      Neutron plugins and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.12.1">
       supported drivers
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.13.1">
      Existing Neutron agents and required
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.14.1">
       network types
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.15.1">
      Designing and implementing an OpenStack virtual switching layout using
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.16.1">
       Open vSwitch
      </span>
     </strong>
     <span class="koboSpan" id="kobo.17.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.18.1">
       OVS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.19.1">
      ) and
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.20.1">
       Open Virtual Network
      </span>
     </strong>
     <span class="koboSpan" id="kobo.21.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.22.1">
       OVN
      </span>
     </strong>
     <span class="koboSpan" id="kobo.23.1">
      ) mechanisms as a
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.24.1">
       Software-Defined Networking
      </span>
     </strong>
     <span class="koboSpan" id="kobo.25.1">
      (
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.26.1">
        SDN
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.27.1">
       ) implementation
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.28.1">
      Learning about and implementing routing, using virtual routers to interconnect tenant networks and provide
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.29.1">
       external connectivity
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.30.1">
      Integrating the load balancer as a service feature using the emerging
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.31.1">
       Octavia project
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-116">
    <a id="_idTextAnchor161">
    </a>
    <span class="koboSpan" id="kobo.32.1">
     Exploring Neutron’s core components
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.33.1">
     OpenStack
    </span>
    <a id="_idIndexMarker529">
    </a>
    <span class="koboSpan" id="kobo.34.1">
     networking has evolved through different releases to build an advanced and functioning cloud networking stack.
    </span>
    <span class="koboSpan" id="kobo.34.2">
     Like many other OpenStack services, Neutron is composed of several services that can be stretched across multiple hosts, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.35.1">
      following diagram:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer074">
     <span class="koboSpan" id="kobo.36.1">
      <img alt="Figure 6.1 – The OpenStack Neutron core architecture" src="image/B21716_06_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.37.1">
     Figure 6.1 – The OpenStack Neutron core architecture
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.38.1">
     These components can be briefly broken down
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.39.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.40.1">
       Neutron server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.41.1">
      : This acts as an API portal that receives API requests generated by services or end users and forwards them to the next process – in this case, the Neutron agents through the messaging queue service.
     </span>
     <span class="koboSpan" id="kobo.41.2">
      The other part of the server interaction within an OpenStack ecosystem is access to the database to update the network objects for each
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.42.1">
       API request.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.43.1">
       Neutron agents
      </span>
     </strong>
     <span class="koboSpan" id="kobo.44.1">
      : Neutron’s architecture relies heavily on different types of agents that will be installed in other hosts to handle different networking features.
     </span>
     <span class="koboSpan" id="kobo.44.2">
      The plugin agent, denoted as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.45.1">
       neutron-*-agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.46.1">
      , is the process that handles virtual switching capabilities in each compute node.
     </span>
     <span class="koboSpan" id="kobo.46.2">
      This type can be described as a
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.47.1">
       layer 2
      </span>
     </strong>
     <span class="koboSpan" id="kobo.48.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.49.1">
       L2
      </span>
     </strong>
     <span class="koboSpan" id="kobo.50.1">
      ) agent.
     </span>
     <span class="koboSpan" id="kobo.50.2">
      A very common L2 agent is OVS, which provides L2 connectivity via the ML2 mechanism driver.
     </span>
     <span class="koboSpan" id="kobo.50.3">
      The second type of Neutron agent is the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.51.1">
       layer 3
      </span>
     </strong>
     <span class="koboSpan" id="kobo.52.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.53.1">
       L3
      </span>
     </strong>
     <span class="koboSpan" id="kobo.54.1">
      ) agent, denoted as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.55.1">
       neutron-l3-agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.56.1">
      , which is installed in the network node and deals with instances of network access for L3, such as NAT, firewall, and
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.57.1">
       virtual private network
      </span>
     </strong>
     <span class="koboSpan" id="kobo.58.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.59.1">
       VPN
      </span>
     </strong>
     <span class="koboSpan" id="kobo.60.1">
      ) capabilities.
     </span>
     <span class="koboSpan" id="kobo.60.2">
      The DHCP
     </span>
     <a id="_idIndexMarker530">
     </a>
     <span class="koboSpan" id="kobo.61.1">
      agent, denoted as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.62.1">
       neutron-dhcp-agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.63.1">
      , manages instances of DHCP configuration for each tenant network (a
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.64.1">
        dnsmasq
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.65.1">
       configuration).
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.66.1">
     Depending on the nature of the network function request, the Neutron service will reach the agents deployed
    </span>
    <a id="_idIndexMarker531">
    </a>
    <span class="koboSpan" id="kobo.67.1">
     on the network and/or compute nodes.
    </span>
    <span class="koboSpan" id="kobo.67.2">
     Cloud operators should list which network functions the infrastructure supports, which will decide the choice of plugins and agents that can
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.68.1">
      be installed.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-117">
    <a id="_idTextAnchor162">
    </a>
    <span class="koboSpan" id="kobo.69.1">
     Demystifying Neutron agents
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.70.1">
     Neutron relies on
    </span>
    <a id="_idIndexMarker532">
    </a>
    <span class="koboSpan" id="kobo.71.1">
     agent services that interact with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.72.1">
      neutron-server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.73.1">
     through the queuing message service to implement virtual networking for L2 and L3 connectivity, DHCP, and routing services.
    </span>
    <span class="koboSpan" id="kobo.73.2">
     Different agents will be deployed in the network and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.74.1">
      compute nodes:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.75.1">
       L2 agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.76.1">
      : Deployed on network and compute nodes to implement L2 networking connectivity for instances and virtual networks, such
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.77.1">
       as routers.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.78.1">
       L3 agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.79.1">
      : Deployed on the network node and, optionally, on compute nodes to perform L3 routing between different types of networks, such as tenant and external networks.
     </span>
     <span class="koboSpan" id="kobo.79.2">
      L3 can also implement more advanced networking capabilities, such as firewalls
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.80.1">
       and VPNs.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.81.1">
       DHCP agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.82.1">
      : Deployed on the network node to run the DHCP service for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.83.1">
       tenant networks.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.84.1">
       Plugin agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.85.1">
      : Deployed on the network node to process data packets on virtual networks that depend on the implemented
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.86.1">
       Neutron plugin.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.87.1">
       Metadata agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.88.1">
      : Deployed on the network node.
     </span>
     <span class="koboSpan" id="kobo.88.2">
      The metadata service provided by Nova enables the retrieval of instance information, such as hostname and IP addresses, upon a metadata HTTP request (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.89.1">
       169.254.169.254
      </span>
     </strong>
     <span class="koboSpan" id="kobo.90.1">
      ).
     </span>
     <span class="koboSpan" id="kobo.90.2">
      The Neutron metadata agent facilitates the forwarding of metadata to the Nova metadata service through its internal proxy component with additional information, such as instance and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.91.1">
       tenant IDs.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.92.1">
     The proper function of the deployed Neutron agent will vary, based on the types of the designed networks
    </span>
    <a id="_idIndexMarker533">
    </a>
    <span class="koboSpan" id="kobo.93.1">
     in the OpenStack environment.
    </span>
    <span class="koboSpan" id="kobo.93.2">
     The next section will briefly cover the different categories of networks that should exist in our initial
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.94.1">
      design draft.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-118">
    <a id="_idTextAnchor163">
    </a>
    <span class="koboSpan" id="kobo.95.1">
     Network categories
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.96.1">
     It is essential to go through the
    </span>
    <a id="_idIndexMarker534">
    </a>
    <span class="koboSpan" id="kobo.97.1">
     network types to enable traffic flow, based on their usage.
    </span>
    <span class="koboSpan" id="kobo.97.2">
     The following glossary covers the network categories that are used mainly with the latest releases
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.98.1">
      of OpenStack:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.99.1">
       Provider networks
      </span>
     </strong>
     <span class="koboSpan" id="kobo.100.1">
      : Created and managed by cloud operators who define a set of network attributes, such as the network’s type – for
     </span>
     <a id="_idIndexMarker535">
     </a>
     <span class="koboSpan" id="kobo.101.1">
      example,
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.102.1">
       VXLAN
      </span>
     </strong>
     <span class="koboSpan" id="kobo.103.1">
      ,
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.104.1">
       Generic Routing Encapsulation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.105.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.106.1">
       GRE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.107.1">
      ), or
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.108.1">
       flat
      </span>
     </strong>
     <span class="koboSpan" id="kobo.109.1">
      .
     </span>
     <span class="koboSpan" id="kobo.109.2">
      Cloud operators
     </span>
     <a id="_idIndexMarker536">
     </a>
     <span class="koboSpan" id="kobo.110.1">
      provide and configure the underlying
     </span>
     <a id="_idIndexMarker537">
     </a>
     <span class="koboSpan" id="kobo.111.1">
      infrastructure, such as the physical network interface designated for the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.112.1">
       traffic flow.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.113.1">
       Self-service networks
      </span>
     </strong>
     <span class="koboSpan" id="kobo.114.1">
      : Referred to as
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.115.1">
       tenant networks
      </span>
     </strong>
     <span class="koboSpan" id="kobo.116.1">
      , these are created by cloud users.
     </span>
     <span class="koboSpan" id="kobo.116.2">
      Self-service
     </span>
     <a id="_idIndexMarker538">
     </a>
     <span class="koboSpan" id="kobo.117.1">
      networks are self-contained and fully isolated from other networks in a multi-tenancy environment managed by Neutron.
     </span>
     <span class="koboSpan" id="kobo.117.2">
      Tenants are restricted to creating virtual networks with what was predefined by the cloud operators in terms of network types.
     </span>
     <span class="koboSpan" id="kobo.117.3">
      For example, a cloud user cannot implement GRE networks if the cloud operator does not provide the option.
     </span>
     <span class="koboSpan" id="kobo.117.4">
      Cloud users do not have access to the underlying
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.118.1">
       Neutron configuration.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.119.1">
       External provider networks
      </span>
     </strong>
     <span class="koboSpan" id="kobo.120.1">
      : This refers to a provider network for specific external network connectivity.
     </span>
     <span class="koboSpan" id="kobo.120.2">
      Cloud operators configure an external routing device to access
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.121.1">
       the internet.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.122.1">
     The next section will
    </span>
    <a id="_idIndexMarker539">
    </a>
    <span class="koboSpan" id="kobo.123.1">
     cover the most interesting capabilities of Neutron by exploring the concept of plugins and their latest mode
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.124.1">
      of usage.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-119">
    <a id="_idTextAnchor164">
    </a>
    <span class="koboSpan" id="kobo.125.1">
     The core of networking – Neutron plugins
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.126.1">
     Neutron supports the use of
    </span>
    <a id="_idIndexMarker540">
    </a>
    <span class="koboSpan" id="kobo.127.1">
     plugins and drivers, which use different software and hardware technologies provided by open source communities or vendor solutions.
    </span>
    <span class="koboSpan" id="kobo.127.2">
     There are two types of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.128.1">
      Neutron plugins:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.129.1">
       Core plugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.130.1">
      : Enables L2
     </span>
     <a id="_idIndexMarker541">
     </a>
     <span class="koboSpan" id="kobo.131.1">
      connectivity functions and orchestration
     </span>
     <a id="_idIndexMarker542">
     </a>
     <span class="koboSpan" id="kobo.132.1">
      of network elements, including virtual networks, subnets,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.133.1">
       and ports
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.134.1">
       Service plugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.135.1">
      : Enables additional
     </span>
     <a id="_idIndexMarker543">
     </a>
     <span class="koboSpan" id="kobo.136.1">
      network capabilities, including routing, private networks, firewalls, and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.137.1">
       load balancing
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.138.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.139.1">
     The code for plugins is run on the Neutron server, which can be configured as part of the cloud
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.140.1">
      controller node(s).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.141.1">
     The following section will dive into the most adopted
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.142.1">
      core plugins.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-120">
    <a id="_idTextAnchor165">
    </a>
    <span class="koboSpan" id="kobo.143.1">
     Core plugin – Modular Layer 2
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.144.1">
     The most widely
    </span>
    <a id="_idIndexMarker544">
    </a>
    <span class="koboSpan" id="kobo.145.1">
     adopted core plugin in Neutron is
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.146.1">
      Modular Layer 2
     </span>
    </strong>
    <span class="koboSpan" id="kobo.147.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.148.1">
      ML2
     </span>
    </strong>
    <span class="koboSpan" id="kobo.149.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.149.2">
     The
    </span>
    <a id="_idIndexMarker545">
    </a>
    <span class="koboSpan" id="kobo.150.1">
     introduction
    </span>
    <a id="_idIndexMarker546">
    </a>
    <span class="koboSpan" id="kobo.151.1">
     of ML2 to the OpenStack networking service has increased the flexibility of designing network architectures.
    </span>
    <span class="koboSpan" id="kobo.151.2">
     The secret sauce of ML2 is that it supports the use of a variety of technologies from different vendors simultaneously.
    </span>
    <span class="koboSpan" id="kobo.151.3">
     Thus, cloud architects and operators aren’t limited to a specific set of features and can easily extend or change their
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.152.1">
      network stacks.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.153.1">
     This plugin has been developed due to the historical limitations prior
    </span>
    <a id="_idIndexMarker547">
    </a>
    <span class="koboSpan" id="kobo.154.1">
     to the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.155.1">
      Havana
     </span>
    </strong>
    <span class="koboSpan" id="kobo.156.1">
     release, where operators had to stick to only one core plugin, referred to as a monolithic plugin-based component.
    </span>
    <span class="koboSpan" id="kobo.156.2">
     The two most commonly used core plugins were
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.157.1">
      Linux Bridge
     </span>
    </strong>
    <span class="koboSpan" id="kobo.158.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.159.1">
      OVS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.160.1">
     , which
    </span>
    <a id="_idIndexMarker548">
    </a>
    <span class="koboSpan" id="kobo.161.1">
     have
    </span>
    <a id="_idIndexMarker549">
    </a>
    <span class="koboSpan" id="kobo.162.1">
     been replaced in the latest releases of OpenStack by ML2.
    </span>
    <span class="koboSpan" id="kobo.162.2">
     Replacing does not mean directly removing any of them but bundling
    </span>
    <a id="_idIndexMarker550">
    </a>
    <span class="koboSpan" id="kobo.163.1">
     them as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.164.1">
      mechanism drivers
     </span>
    </strong>
    <span class="koboSpan" id="kobo.165.1">
     in the core ML2 plugin.
    </span>
    <span class="koboSpan" id="kobo.165.2">
     ML2 is not limited to Linux Bridge and OVS and also supports other vendor drivers, such as VMware, Cisco, and OpenDayLight.
    </span>
    <span class="koboSpan" id="kobo.165.3">
     An amazing filtered list can be found on the OpenStack community
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.166.1">
      website:
     </span>
    </span>
    <a href="https://www.openstack.org/marketplace/drivers/#project=neutron%20(networking)">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.167.1">
       https://www.openstack.org/marketplace/drivers/#project=neutron%20(networking)
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.168.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.169.1">
     An overview of the modular
    </span>
    <a id="_idIndexMarker551">
    </a>
    <span class="koboSpan" id="kobo.170.1">
     plugins and drivers supported in Neutron
    </span>
    <a id="_idIndexMarker552">
    </a>
    <span class="koboSpan" id="kobo.171.1">
     is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.172.1">
      illustrated here:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer075">
     <span class="koboSpan" id="kobo.173.1">
      <img alt="Figure 6.2 – An overview of the OpenStack Neutron core and service plugins architecture" src="image/B21716_06_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.174.1">
     Figure 6.2 – An overview of the OpenStack Neutron core and service plugins architecture
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.175.1">
     As shown in the preceding diagram, Neutron relies on the mechanisms of plugins that provide a specific set of networking services.
    </span>
    <span class="koboSpan" id="kobo.175.2">
     An API request will be forwarded by the Neutron server to the associated plugin configured in the controller node.
    </span>
    <span class="koboSpan" id="kobo.175.3">
     The ML2 plugin combines two main elements into the same framework,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.176.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.177.1">
       Type drivers
      </span>
     </strong>
     <span class="koboSpan" id="kobo.178.1">
      : These expose L2 functionalities
     </span>
     <a id="_idIndexMarker553">
     </a>
     <span class="koboSpan" id="kobo.179.1">
      to create more segmented networks, including
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.180.1">
       the following:
      </span>
     </span>
     <ul>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.181.1">
         VLAN
        </span>
       </strong>
       <span class="koboSpan" id="kobo.182.1">
        : Segregates network
       </span>
       <a id="_idIndexMarker554">
       </a>
       <span class="koboSpan" id="kobo.183.1">
        traffic using
       </span>
       <strong class="bold">
        <span class="koboSpan" id="kobo.184.1">
         802.1Q
        </span>
       </strong>
       <span class="koboSpan" id="kobo.185.1">
        tagging.
       </span>
       <span class="koboSpan" id="kobo.185.2">
        Virtual machines that belong to the same VLAN are part of the same broadcast
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.186.1">
         L2 domain
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.187.1">
         VXLAN
        </span>
       </strong>
       <span class="koboSpan" id="kobo.188.1">
        : Uses a
       </span>
       <strong class="bold">
        <span class="koboSpan" id="kobo.189.1">
         virtual network identifier
        </span>
       </strong>
       <span class="koboSpan" id="kobo.190.1">
        (
       </span>
       <strong class="bold">
        <span class="koboSpan" id="kobo.191.1">
         VNI
        </span>
       </strong>
       <span class="koboSpan" id="kobo.192.1">
        ) to separate and differentiate traffic
       </span>
       <a id="_idIndexMarker555">
       </a>
       <span class="koboSpan" id="kobo.193.1">
        between
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.194.1">
         different networks
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.195.1">
         Flat
        </span>
       </strong>
       <span class="koboSpan" id="kobo.196.1">
        : VLAN tagging and network segregation are not supported where instances are connected in the
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.197.1">
         same network
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.198.1">
         GRE
        </span>
       </strong>
       <span class="koboSpan" id="kobo.199.1">
        : Encapsulates traffic using the GRE
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.200.1">
         tunneling protocol
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.201.1">
         GENEVE
        </span>
       </strong>
       <span class="koboSpan" id="kobo.202.1">
        : Resembles the VXLAN overlay technology but with more optimal
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.203.1">
         encapsulation methods
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.204.1">
         Local
        </span>
       </strong>
       <span class="koboSpan" id="kobo.205.1">
        : Connects instances only within the same network hosted in the same compute nodes and not with instances in
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.206.1">
         different nodes
        </span>
       </span>
      </li>
     </ul>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.207.1">
       Mechanism drivers
      </span>
     </strong>
     <span class="koboSpan" id="kobo.208.1">
      : Implements
     </span>
     <a id="_idIndexMarker556">
     </a>
     <span class="koboSpan" id="kobo.209.1">
      the type driver technologies through both network software methods such as OVS, Linux Bridge, and OVN and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.210.1">
       hardware-based ones
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.211.1">
     An up-to-date ML2 driver support matrix list can be found at
    </span>
    <a href="https://docs.openstack.org/neutron/latest/admin/config-ml2.html">
     <span class="koboSpan" id="kobo.212.1">
      https://docs.openstack.org/neutron/latest/admin/config-ml2.html
     </span>
    </a>
    <span class="koboSpan" id="kobo.213.1">
     .
    </span>
    <span class="koboSpan" id="kobo.213.2">
     Each mechanism driver supports a set of network types (type drivers).
    </span>
    <span class="koboSpan" id="kobo.213.3">
     For example, OVS supports most network types, including VLAN, VXLAN, GRE, flat, and local.
    </span>
    <span class="koboSpan" id="kobo.213.4">
     If a need has been raised to support the GENEVE
    </span>
    <a id="_idIndexMarker557">
    </a>
    <span class="koboSpan" id="kobo.214.1">
     type
    </span>
    <a id="_idIndexMarker558">
    </a>
    <span class="koboSpan" id="kobo.215.1">
     driver while in production, the new mechanism driver can be integrated by just installing the driver and reconfiguring the Neutron
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.216.1">
      driver list.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-121">
    <a id="_idTextAnchor166">
    </a>
    <span class="koboSpan" id="kobo.217.1">
     Building virtual switching
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.218.1">
     In this section, two
    </span>
    <a id="_idIndexMarker559">
    </a>
    <span class="koboSpan" id="kobo.219.1">
     mechanism drivers will be discussed to
    </span>
    <a id="_idIndexMarker560">
    </a>
    <span class="koboSpan" id="kobo.220.1">
     establish connectivity between virtual network ports and physical networks.
    </span>
    <span class="koboSpan" id="kobo.220.2">
     OVS is one of the most featured mechanism drivers, with advanced networking capabilities such
    </span>
    <a id="_idIndexMarker561">
    </a>
    <span class="koboSpan" id="kobo.221.1">
     as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.222.1">
      OpenFlow
     </span>
    </strong>
    <span class="koboSpan" id="kobo.223.1">
     .
    </span>
    <span class="koboSpan" id="kobo.223.2">
     The second driver we will cover is
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.224.1">
      OVN
     </span>
    </strong>
    <span class="koboSpan" id="kobo.225.1">
     , an SDN
    </span>
    <a id="_idIndexMarker562">
    </a>
    <span class="koboSpan" id="kobo.226.1">
     implementation that enables programming networks by controlling the flow of packets.
    </span>
    <span class="koboSpan" id="kobo.226.2">
     Linux Bridge
    </span>
    <a id="_idIndexMarker563">
    </a>
    <span class="koboSpan" id="kobo.227.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.228.1">
      L2 Population
     </span>
    </strong>
    <span class="koboSpan" id="kobo.229.1">
     are also well-tested and mature mechanisms.
    </span>
    <span class="koboSpan" id="kobo.229.2">
     With ML2 being an agnostic plugin for the supported drivers, introducing a new mechanism driver will not introduce a lot of complexity in an existing running
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.230.1">
      OpenStack environment.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.231.1">
     Opening vSwitch in OpenStack
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.232.1">
     Most OpenStack
    </span>
    <a id="_idIndexMarker564">
    </a>
    <span class="koboSpan" id="kobo.233.1">
     networking
    </span>
    <a id="_idIndexMarker565">
    </a>
    <span class="koboSpan" id="kobo.234.1">
     implementations would require a minimum of overlay networking technologies that provide tunnel-based virtual networking, with an immense level of network segmentation, such as VXLAN and GRE.
    </span>
    <span class="koboSpan" id="kobo.234.2">
     Tunnel-based networks can provide up to 16 million networks.
    </span>
    <span class="koboSpan" id="kobo.234.3">
     OVS supports most used drivers in large and complex OpenStack networking environments, such as VLAN, VXLAN, GRE, and flat.
    </span>
    <span class="koboSpan" id="kobo.234.4">
     As a cloud operator, it is crucial to have a basic understanding of how OVS operates when installed in an OpenStack environment.
    </span>
    <span class="koboSpan" id="kobo.234.5">
     OVS comes with a complete core architecture, with different components that operate as software switches in a host kernel space.
    </span>
    <span class="koboSpan" id="kobo.234.6">
     The OVS implementation comes with different services when installed in an OpenStack environment,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.235.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.236.1">
       openvswitch
      </span>
     </strong>
     <span class="koboSpan" id="kobo.237.1">
      : A kernel module that handles the data plane that processes the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.238.1">
       network packets.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.239.1">
       ovs-switchd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.240.1">
      : A Linux process that runs on a physical host to control and manage
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.241.1">
       virtual switches.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.242.1">
       ovsdb-server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.243.1">
      : A local database to store the virtual switches
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.244.1">
       running locally.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.245.1">
       neutron-openvswitch-agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.246.1">
      : Configured in compute nodes that use the OVS
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.247.1">
       mechanism driver.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.248.1">
       neutron-server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.249.1">
      : Handles API requests, with the ML2 plugin loading the OVS mechanism driver.
     </span>
     <span class="koboSpan" id="kobo.249.2">
      The neutron-server process passes the network request to the OVS driver via an RPC cast message to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.250.1">
       neutron-openvswitch-agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.251.1">
      .
     </span>
     <span class="koboSpan" id="kobo.251.2">
      The latter configures the OVS switch on the compute node and sets the required resources of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.252.1">
       local instance.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.253.1">
     Once OVS is implemented, a set of virtual network devices is installed, which a cloud operator should keep in mind during deployment or troubleshooting tasks.
    </span>
    <span class="koboSpan" id="kobo.253.2">
     An Ethernet frame would travel
    </span>
    <a id="_idIndexMarker566">
    </a>
    <span class="koboSpan" id="kobo.254.1">
     from an
    </span>
    <a id="_idIndexMarker567">
    </a>
    <span class="koboSpan" id="kobo.255.1">
     instance through the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.256.1">
      following interfaces:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.257.1">
       tapXXXX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.258.1">
      : A tap interface where
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.259.1">
       XXXX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.260.1">
      is the assigned tap
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.261.1">
       interface ID.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.262.1">
       br-int
      </span>
     </strong>
     <span class="koboSpan" id="kobo.263.1">
      : A bridge interface, known as the integration bridge, where it consolidates all the virtual devices, such as virtual machines, routers,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.264.1">
       and firewalls.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.265.1">
       int-br-ethX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.266.1">
      : A virtual patch port connecting different interfaces to the OVS integration bridge
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.267.1">
       interface (
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.268.1">
        br-int
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.269.1">
       ).
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.270.1">
       phy-br-ethX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.271.1">
      : A virtual patch port connecting different interfaces to the OVS provider
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.272.1">
       bridge (
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.273.1">
        br-ethX
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.274.1">
       ).
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.275.1">
       br-ethX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.276.1">
      : A bridge interface where
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.277.1">
       X
      </span>
     </em>
     <span class="koboSpan" id="kobo.278.1">
      is the assigned bridge interface ID connecting to the physical network.
     </span>
     <span class="koboSpan" id="kobo.278.2">
      It is also known as the provider bridge and connects to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.279.1">
       br-int
      </span>
     </strong>
     <span class="koboSpan" id="kobo.280.1">
      integration bridge through a virtual patch cable, provided by patch ports (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.281.1">
       int-br-ethX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.282.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.283.1">
       phy-br-ethX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.284.1">
      patch ports for
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.285.1">
       int-br
      </span>
     </strong>
     <span class="koboSpan" id="kobo.286.1">
      and
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.287.1">
        br-ethX
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.288.1">
       , respectively).
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.289.1">
       qbrXXXX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.290.1">
      : A Linux bridge interface where
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.291.1">
       XXXX
      </span>
     </strong>
     <span class="koboSpan" id="kobo.292.1">
      is the assigned bridge interface ID dedicated to IP
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.293.1">
       tables only.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.294.1">
       br-tun
      </span>
     </strong>
     <span class="koboSpan" id="kobo.295.1">
      : A bridge tunnel interface to handle packet encapsulation
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.296.1">
       and de-encapsulation.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.297.1">
       br-ex
      </span>
     </strong>
     <span class="koboSpan" id="kobo.298.1">
      : A bridge interface providing connectivity to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.299.1">
       external networks.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.300.1">
     Each spawned instance is connected via its tap interface, denoted as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.301.1">
      tapXXXX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.302.1">
     , created in the hypervisor host.
    </span>
    <span class="koboSpan" id="kobo.302.2">
     The associated Linux bridge, denoted as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.303.1">
      qbrXXXX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.304.1">
     , is connected to the OVS
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.305.1">
      br-int
     </span>
    </strong>
    <span class="koboSpan" id="kobo.306.1">
     integration bridge, where the traffic will be routed based on the programmed OpenFlow rules and then forwarded through the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.307.1">
      virtual switch.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.308.1">
     Connections between the integration and provider bridges are handled by patch cables.
    </span>
    <span class="koboSpan" id="kobo.308.2">
     Packets exit the physical network via the OVS provider bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.309.1">
      br-ethX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.310.1">
     ), connected to the physical network interface of the host.
    </span>
    <span class="koboSpan" id="kobo.310.2">
     When configuring OVS in our existing OpenStack environment, each node will run its own integration and provider bridges.
    </span>
    <span class="koboSpan" id="kobo.310.3">
     Connectivity between the OpenStack nodes, including the cloud controller, network, and compute nodes, is
    </span>
    <a id="_idIndexMarker568">
    </a>
    <span class="koboSpan" id="kobo.311.1">
     established
    </span>
    <a id="_idIndexMarker569">
    </a>
    <span class="koboSpan" id="kobo.312.1">
     via the physical network, as illustrated in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.313.1">
      following diagram:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer076">
     <span class="koboSpan" id="kobo.314.1">
      <img alt="Figure 6.3 – Traffic flow through different interfaces using OVS" src="image/B21716_06_03.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.315.1">
     Figure 6.3 – Traffic flow through different interfaces using OVS
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.316.1">
     Now that we understand the basic core components of OVS within an OpenStack setup, we can move on to
    </span>
    <a id="_idIndexMarker570">
    </a>
    <span class="koboSpan" id="kobo.317.1">
     configuring
    </span>
    <a id="_idIndexMarker571">
    </a>
    <span class="koboSpan" id="kobo.318.1">
     our infrastructure code to deploy OVS as the main mechanism driver
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.319.1">
      in Neutron.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.320.1">
     Deploying with OVS
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.321.1">
     The OVS mechanism
    </span>
    <a id="_idIndexMarker572">
    </a>
    <span class="koboSpan" id="kobo.322.1">
     driver implements L2 isolation, which
    </span>
    <a id="_idIndexMarker573">
    </a>
    <span class="koboSpan" id="kobo.323.1">
     offers VXLAN-, GRE-, and VLAN-based networks.
    </span>
    <span class="koboSpan" id="kobo.323.2">
     The next configuration will implement the ML2 plugin to use VXLAN-based networks.
    </span>
    <span class="koboSpan" id="kobo.323.3">
     This will allow instances to connect via VLAN segmentation and VXLAN tunneling.
    </span>
    <span class="koboSpan" id="kobo.323.4">
     Virtual networks for tenants will not be exposed outside of the compute or network nodes.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.324.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.325.1">
     comes with the ML2 plugin enabled by default.
    </span>
    <span class="koboSpan" id="kobo.325.2">
     A few prerequisites must be fulfilled before deploying an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.326.1">
      OVS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.327.1">
     configuration.
    </span>
    <span class="koboSpan" id="kobo.327.2">
     To reach the external networks via routers and provider networks, adjust the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.328.1">
      neutron_external_interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.329.1">
     setting in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.330.1">
      /etc/kolla/globals.yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.331.1">
     file to the network interface dedicated to this matter.
    </span>
    <span class="koboSpan" id="kobo.331.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.332.1">
      eth2
     </span>
    </strong>
    <span class="koboSpan" id="kobo.333.1">
     interface has been assigned an interface to connect with the external world, as designed in
    </span>
    <a href="B21716_03.xhtml#_idTextAnchor108">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.334.1">
        Chapter 3
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.335.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.336.1">
      OpenStack Control Plane – Shared Services
     </span>
    </em>
    <span class="koboSpan" id="kobo.337.1">
     .
    </span>
    <span class="koboSpan" id="kobo.337.2">
     You can adjust the settings
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.338.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.339.1">
...
</span><span class="koboSpan" id="kobo.339.2">neutron_external_interface: "eth2"
...</span></pre>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.340.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.341.1">
     It is important to consider the usage of a physical interface with the OVS provider bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.342.1">
      br-ethX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.343.1">
     ) if you are planning to use more than one provider bridge.
    </span>
    <span class="koboSpan" id="kobo.343.2">
     In this case,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.344.1">
      neutron_external_interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.345.1">
     can be assigned a comma-separated list – for example,
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.346.1">
       neutron_external_interface: "eth2,eth3"
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.347.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.348.1">
     The other check is
    </span>
    <a id="_idIndexMarker574">
    </a>
    <span class="koboSpan" id="kobo.349.1">
     to verify whether
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.350.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.351.1">
     is configured with an OVS driver mechanism that comes with the ML2 plugin.
    </span>
    <span class="koboSpan" id="kobo.351.2">
     Check and adjust the following configuration setting in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.352.1">
       globals.yml
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.353.1">
      file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.354.1">
...
</span><span class="koboSpan" id="kobo.354.2">neutron_plugin_agent: "openvswitch"
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.355.1">
     The next check is to verify that our Neutron services are assigned to the respective OpenStack nodes in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.356.1">
      /ansible/inventory/multi_packtpub_prod
     </span>
    </strong>
    <span class="koboSpan" id="kobo.357.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.357.2">
     As demonstrated in
    </span>
    <a href="B21716_03.xhtml#_idTextAnchor108">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.358.1">
        Chapter 3
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.359.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.360.1">
      OpenStack Control Plane – Shared Services
     </span>
    </em>
    <span class="koboSpan" id="kobo.361.1">
     ,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.362.1">
      neutron-server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.363.1">
     will run as part of the controller node,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.364.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.365.1">
...
</span><span class="koboSpan" id="kobo.365.2">[control]
cc01.os.packtpub
...
</span><span class="koboSpan" id="kobo.365.3">[neutron-server:children]
control
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.366.1">
     Neutron agents, including
    </span>
    <a id="_idIndexMarker575">
    </a>
    <span class="koboSpan" id="kobo.367.1">
     the DHCP, L3, and metadata
    </span>
    <a id="_idIndexMarker576">
    </a>
    <span class="koboSpan" id="kobo.368.1">
     agents, will run in a dedicated network node,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.369.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.370.1">
...
</span><span class="koboSpan" id="kobo.370.2">[network]
net01.os.packtpub
[neutron:children]
network
[neutron-dhcp-agent:children]
neutron
[neutron-l3-agent:children]
neutron
[neutron-metadata-agent:children]
neutron
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.371.1">
     OVS will be installed in the network and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.372.1">
      compute nodes.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.373.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.374.1">
     As shown in
    </span>
    <a href="B21716_05.xhtml#_idTextAnchor146">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.375.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.376.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.377.1">
      OpenStack Storage – Block, Object, and File Shares
     </span>
    </em>
    <span class="koboSpan" id="kobo.378.1">
     , the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.379.1">
      manila-share
     </span>
    </strong>
    <span class="koboSpan" id="kobo.380.1">
     service provides access to the file share by using the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.381.1">
      Neutron plugin.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.382.1">
     The OVS setup in the inventory file is listed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.383.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.384.1">
...
</span><span class="koboSpan" id="kobo.384.2">[openvswitch:children]
network
compute
manila-share
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.385.1">
     Launch the pipeline job to install OVS across the target nodes.
    </span>
    <span class="koboSpan" id="kobo.385.2">
     Note that VXLAN was not explicitly configured in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.386.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.387.1">
     code.
    </span>
    <span class="koboSpan" id="kobo.387.2">
     By default, the Neutron tenant network uses the
    </span>
    <a id="_idIndexMarker577">
    </a>
    <span class="koboSpan" id="kobo.388.1">
     VXLAN type.
    </span>
    <span class="koboSpan" id="kobo.388.2">
     The default VNI range is
    </span>
    <a id="_idIndexMarker578">
    </a>
    <span class="koboSpan" id="kobo.389.1">
     defined from 1 to 1,000 IDs, reserved for the tenant networks when they are created.
    </span>
    <span class="koboSpan" id="kobo.389.2">
     This setting is denoted with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.390.1">
      vni_ranges
     </span>
    </strong>
    <span class="koboSpan" id="kobo.391.1">
     line in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.392.1">
      ml2_config.ini
     </span>
    </strong>
    <span class="koboSpan" id="kobo.393.1">
     file in the controller node.
    </span>
    <span class="koboSpan" id="kobo.393.2">
     The ML2 configuration can be extended and we can employ a configuration override by creating an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.394.1">
      /
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.395.1">
       etc/kolla/config/neutron/ml2_config.ini
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.396.1">
      file.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.397.1">
     The following command line lists the different network agents, including the OVS ones, from the cloud
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.398.1">
      controller node:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.399.1">
$ openstack network agent list</span></pre>
   <p>
    <span class="koboSpan" id="kobo.400.1">
     Here is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.401.1">
      the output:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer077">
     <span class="koboSpan" id="kobo.402.1">
      <img alt="Figure 6.4 – The neutron agent list output" src="image/B21716_06_04.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.403.1">
     Figure 6.4 – The neutron agent list output
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.404.1">
     As shown here, the OVS agents should be up and running in the respective network and compute nodes.
    </span>
    <span class="koboSpan" id="kobo.404.2">
     In the
    </span>
    <a id="_idIndexMarker579">
    </a>
    <span class="koboSpan" id="kobo.405.1">
     following section, we
    </span>
    <a id="_idIndexMarker580">
    </a>
    <span class="koboSpan" id="kobo.406.1">
     will trace the network flow with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.407.1">
      OVS mechanism.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.408.1">
     Traffic flow with OVS
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.409.1">
     The setup of the OVS
    </span>
    <a id="_idIndexMarker581">
    </a>
    <span class="koboSpan" id="kobo.410.1">
     driver will dictate
    </span>
    <a id="_idIndexMarker582">
    </a>
    <span class="koboSpan" id="kobo.411.1">
     the travel hops of an Ethernet frame, from an instance all the way to the physical network.
    </span>
    <span class="koboSpan" id="kobo.411.2">
     Numerous interfaces will be used, including the virtual switch ports and integration bridge.
    </span>
    <span class="koboSpan" id="kobo.411.3">
     The deployment of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.412.1">
      openvswitch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.413.1">
     playbook in the compute node should create the OVS logical bridges on the host, which can be checked by running the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.414.1">
      command line:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.415.1">
$ ovs-vsctl list-br</span></pre>
   <p>
    <span class="koboSpan" id="kobo.416.1">
     The output will be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.417.1">
      as shown:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer078">
     <span class="koboSpan" id="kobo.418.1">
      <img alt="Figure 6.5 – The OVS bridges list" src="image/B21716_06_05.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.419.1">
     Figure 6.5 – The OVS bridges list
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.420.1">
     Instances spawned in the compute node are connected via the same local VLAN.
    </span>
    <span class="koboSpan" id="kobo.420.2">
     With the VXLAN layout, instance ports are attached to the integration bridge, which will be assigned a local VLAN ID.
    </span>
    <span class="koboSpan" id="kobo.420.3">
     Traffic initiated from an instance will be forwarded by the integration bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.421.1">
      br-int
     </span>
    </strong>
    <span class="koboSpan" id="kobo.422.1">
     ) to the tunnel bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.423.1">
      br-tun
     </span>
    </strong>
    <span class="koboSpan" id="kobo.424.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.424.2">
     The overall layout of the connecting bridges and their respective ports can be seen by running the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.425.1">
      command line:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.426.1">
$ ovs-vsctl show</span></pre>
   <p>
    <span class="koboSpan" id="kobo.427.1">
     Here is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.428.1">
      the output:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer079">
     <span class="koboSpan" id="kobo.429.1">
      <img alt="Figure 6.6 – An OVS interface listing" src="image/B21716_06_06.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.430.1">
     Figure 6.6 – An OVS interface listing
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.431.1">
     As depicted in the virtual switch interfaces, the integration bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.432.1">
      br-int
     </span>
    </strong>
    <span class="koboSpan" id="kobo.433.1">
     ) is tagged with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.434.1">
      VLAN 1.
     </span>
    </strong>
    <span class="koboSpan" id="kobo.435.1">
     When traffic reaches instances in different nodes, the packets will travel through the tunnel bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.436.1">
      br-tun
     </span>
    </strong>
    <span class="koboSpan" id="kobo.437.1">
     ) encapsulated in VXLAN packets.
    </span>
    <span class="koboSpan" id="kobo.437.2">
     Under the hood, the local VLAN ID of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.438.1">
      1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.439.1">
     will be swapped with the VXLAN tunnel ID, as shown with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.440.1">
      vxlan-476984a0
     </span>
    </strong>
    <span class="koboSpan" id="kobo.441.1">
     .
    </span>
    <span class="koboSpan" id="kobo.441.2">
     Otherwise, if an instance connects to another one residing in the same compute node, the packets will travel through the integration bridge (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.442.1">
      br-int
     </span>
    </strong>
    <span class="koboSpan" id="kobo.443.1">
     ) locally to the destination port, denoted with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.444.1">
      qrXXXX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.445.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.446.1">
      tapYYYY
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.447.1">
      port interfaces.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.448.1">
     The following
    </span>
    <a id="_idIndexMarker583">
    </a>
    <span class="koboSpan" id="kobo.449.1">
     section
    </span>
    <a id="_idIndexMarker584">
    </a>
    <span class="koboSpan" id="kobo.450.1">
     covers a more complex mechanism driver, OVN, and demonstrates its deployment in our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.451.1">
      OpenStack environment.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.452.1">
     OVN in OpenStack
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.453.1">
     The other major
    </span>
    <a id="_idIndexMarker585">
    </a>
    <span class="koboSpan" id="kobo.454.1">
     and preferred
    </span>
    <a id="_idIndexMarker586">
    </a>
    <span class="koboSpan" id="kobo.455.1">
     network virtualization in an OpenStack environment is OVN.
    </span>
    <span class="koboSpan" id="kobo.455.2">
     OVN is considered a mature implementation of the SDN philosophy that provides greater flexibility for network flow programming.
    </span>
    <span class="koboSpan" id="kobo.455.3">
     Operators can define a set of forwarding rules centrally to define how the flow of packets is controlled.
    </span>
    <span class="koboSpan" id="kobo.455.4">
     OVN uses an abstraction software layer available in a network controller to program switches, with conditions and rules applied to the packet flow.
    </span>
    <span class="koboSpan" id="kobo.455.5">
     The most distinctive functionality of OVN compared to OVS is its richer capabilities and advanced features, such as traffic routing and access control which are programmable.
    </span>
    <span class="koboSpan" id="kobo.455.6">
     Unlike the OVS approach, OVN decouples the control function of network devices from the actual packet forwarding function through flow rules.
    </span>
    <span class="koboSpan" id="kobo.455.7">
     OVN supports most network types, including VLAN, VXLAN (version 20.09 and later), flat,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.456.1">
      and Geneve.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.457.1">
     As depicted in the following diagram, OVN is built on top of OVS, which leverages its switching capabilities and adds an abstraction layer, managed by controllers that are stored
    </span>
    <a id="_idIndexMarker587">
    </a>
    <span class="koboSpan" id="kobo.458.1">
     in a
    </span>
    <a id="_idIndexMarker588">
    </a>
    <span class="koboSpan" id="kobo.459.1">
     set
    </span>
    <a id="_idIndexMarker589">
    </a>
    <span class="koboSpan" id="kobo.460.1">
     of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.461.1">
      OVS
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.462.1">
       databases
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.463.1">
      (
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.464.1">
       OVSDBs
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.465.1">
      ):
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer080">
     <span class="koboSpan" id="kobo.466.1">
      <img alt="Figure 6.7 – OVN integration architecture" src="image/B21716_06_07.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.467.1">
     Figure 6.7 – OVN integration architecture
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.468.1">
     The main constructs of the OVN architecture integration with an OpenStack environment are
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.469.1">
      explained here:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.470.1">
       Southbound database
      </span>
     </strong>
     <span class="koboSpan" id="kobo.471.1">
      : Referenced
     </span>
     <a id="_idIndexMarker590">
     </a>
     <span class="koboSpan" id="kobo.472.1">
      as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.473.1">
       ovsdb-server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.474.1">
      (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.475.1">
       ovnsb.db
      </span>
     </strong>
     <span class="koboSpan" id="kobo.476.1">
      ), this stores data of the logical and physical network flows.
     </span>
     <span class="koboSpan" id="kobo.476.2">
      The database hosts all binding information between the logical and physical networks, such as the port and logical networking bindings associated with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.477.1">
       Port_Binding
      </span>
     </strong>
     <span class="koboSpan" id="kobo.478.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.479.1">
       Logical_Flow
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.480.1">
       tables, respectively.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.481.1">
       Northbound database
      </span>
     </strong>
     <span class="koboSpan" id="kobo.482.1">
      : Referenced as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.483.1">
       ovsdb-server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.484.1">
      (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.485.1">
       ovnnb.db
      </span>
     </strong>
     <span class="koboSpan" id="kobo.486.1">
      ), this stores data at a high level of the virtual networks that represent a
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.487.1">
       cloud management system
      </span>
     </strong>
     <span class="koboSpan" id="kobo.488.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.489.1">
       CMS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.490.1">
      ) – in
     </span>
     <a id="_idIndexMarker591">
     </a>
     <span class="koboSpan" id="kobo.491.1">
      this case, an OpenStack environment.
     </span>
     <span class="koboSpan" id="kobo.491.2">
      The database reflects the networking resources of the CMS in the table datasets, such as the routers and switch ports associated with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.492.1">
       Logical_Router
      </span>
     </strong>
     <span class="koboSpan" id="kobo.493.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.494.1">
       Logical_Switch_Port
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.495.1">
       tables, respectively.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.496.1">
       OVN controller
      </span>
     </strong>
     <span class="koboSpan" id="kobo.497.1">
      : Referenced as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.498.1">
       ovn-controller
      </span>
     </strong>
     <span class="koboSpan" id="kobo.499.1">
      , this runs on hypervisor nodes and connects to the southbound database.
     </span>
     <span class="koboSpan" id="kobo.499.2">
      It acts as the OVS controller by defining the OpenFlow rules on each OVS switch instance, converting logical flows into physical flows, and pushing configurations to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.500.1">
       local OVSDB.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.501.1">
       OVN northbound service
      </span>
     </strong>
     <span class="koboSpan" id="kobo.502.1">
      : Referenced as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.503.1">
       ovn-northd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.504.1">
      , this runs as part of the control plane on the cloud controller.
     </span>
     <span class="koboSpan" id="kobo.504.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.505.1">
       ovn-northd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.506.1">
      daemon connects the northbound to the southbound database by translating the logical configuration
     </span>
     <a id="_idIndexMarker592">
     </a>
     <span class="koboSpan" id="kobo.507.1">
      from the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.508.1">
       ovn-nb
      </span>
     </strong>
     <span class="koboSpan" id="kobo.509.1">
      data to
     </span>
     <a id="_idIndexMarker593">
     </a>
     <span class="koboSpan" id="kobo.510.1">
      logical data path flows.
     </span>
     <span class="koboSpan" id="kobo.510.2">
      The converted data will be populated in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.511.1">
       ovn-sb
      </span>
     </strong>
     <span class="koboSpan" id="kobo.512.1">
      database and made ready for use by the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.513.1">
        ovn-controller
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.514.1">
       instance.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.515.1">
       OVS data plane service
      </span>
     </strong>
     <span class="koboSpan" id="kobo.516.1">
      : Referenced as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.517.1">
       ovs-vswitchd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.518.1">
      , this runs as part of the data plane on the hypervisor nodes.
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.519.1">
       ovs-vswitchd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.520.1">
      applies the packet-forwarding rules provided
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.521.1">
       by
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.522.1">
        ovn-controller
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.523.1">
       .
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.524.1">
       Local OVSDB
      </span>
     </strong>
     <span class="koboSpan" id="kobo.525.1">
      : Referenced as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.526.1">
       ovsdb-server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.527.1">
      , this runs locally in each hypervisor node.
     </span>
     <span class="koboSpan" id="kobo.527.2">
      The OVN reference architecture takes advantage of the database scaling benefit by using a consistent snapshot of the database, to recover from possible
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.528.1">
       connectivity interruptions.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.529.1">
       Metadata agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.530.1">
      : Referenced as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.531.1">
       ovn-metadata-agent
      </span>
     </strong>
     <span class="koboSpan" id="kobo.532.1">
      , this runs in each hypervisor node.
     </span>
     <span class="koboSpan" id="kobo.532.2">
      The OVN metadata agent, such as the Neutron metadata agent, is used to proxy metadata API requests on each compute node.
     </span>
     <span class="koboSpan" id="kobo.532.3">
      This way, each OVS switch instance running in each hypervisor node will route the requests to the local metadata agent and then query the Nova metadata service to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.533.1">
       run instances.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.534.1">
     In the following
    </span>
    <a id="_idIndexMarker594">
    </a>
    <span class="koboSpan" id="kobo.535.1">
     section, we will use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.536.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.537.1">
     to integrate the OVN project in an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.538.1">
      OpenStack
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker595">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.539.1">
      environment.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.540.1">
     Deploying with OVN
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.541.1">
     OVN extends the
    </span>
    <a id="_idIndexMarker596">
    </a>
    <span class="koboSpan" id="kobo.542.1">
     OVS implementation
    </span>
    <a id="_idIndexMarker597">
    </a>
    <span class="koboSpan" id="kobo.543.1">
     to provide network services to instances.
    </span>
    <span class="koboSpan" id="kobo.543.2">
     The ML2 mechanism driver facilitates integration with OpenStack as a CMS.
    </span>
    <span class="koboSpan" id="kobo.543.3">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.544.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.545.1">
     playbooks include most of the OVN configuration and required packages to install.
    </span>
    <span class="koboSpan" id="kobo.545.2">
     Similar to the OVS configuration, adjust
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.546.1">
      /etc/kolla/globals.yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.547.1">
     to use the designated interface to reach external networks, by configuring the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.548.1">
      neutron_external_interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.549.1">
     setting,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.550.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.551.1">
...
</span><span class="koboSpan" id="kobo.551.2">neutron_external_interface: "eth2"
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.552.1">
     Configure the ML2 mechanism driver to use OVN,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.553.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.554.1">
...
</span><span class="koboSpan" id="kobo.554.2">neutron_plugin_agent: "ovn"
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.555.1">
     OVN comes with built-in support for L3 networking functions that enable instances to connect to external networks.
    </span>
    <span class="koboSpan" id="kobo.555.2">
     There are two ways to provide such connectivity in OVN – through a centralized layout that does not use a distributed floating IP design or via
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.556.1">
      distributed virtual routing
     </span>
    </strong>
    <span class="koboSpan" id="kobo.557.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.558.1">
      DVR
     </span>
    </strong>
    <span class="koboSpan" id="kobo.559.1">
     ), which
    </span>
    <a id="_idIndexMarker598">
    </a>
    <span class="koboSpan" id="kobo.560.1">
     requires a floating IP configuration.
    </span>
    <span class="koboSpan" id="kobo.560.2">
     For two instances to reach external networks or each other using L3, traffic must flow through the network node.
    </span>
    <span class="koboSpan" id="kobo.560.3">
     With the DVR method, traffic is more optimized by deploying an L3 agent in each compute node, allowing
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.561.1">
      north-south
     </span>
    </strong>
    <span class="koboSpan" id="kobo.562.1">
     (going to and from external networks) traffic with a floating IP to be routed from and to the compute node, with an extra hop to reach the network node.
    </span>
    <span class="koboSpan" id="kobo.562.2">
     Similarly,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.563.1">
      east-west
     </span>
    </strong>
    <span class="koboSpan" id="kobo.564.1">
     (traffic flow between instances) traffic is routed directly to the compute nodes.
    </span>
    <span class="koboSpan" id="kobo.564.2">
     The latter option is recommended for more optimal performance.
    </span>
    <span class="koboSpan" id="kobo.564.3">
     The distributed floating IP option can be enabled in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.565.1">
      globals.yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.566.1">
     file,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.567.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.568.1">
...
 </span><span class="koboSpan" id="kobo.568.2">neutron_ovn_distributed_fip: "yes"
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.569.1">
     Enable the Neutron OVN agent to provide extensible capabilities for network monitoring and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.570.1">
      Quality of Service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.571.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.572.1">
      QoS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.573.1">
     ) by configuring
    </span>
    <a id="_idIndexMarker599">
    </a>
    <span class="koboSpan" id="kobo.574.1">
     the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.575.1">
      following setting:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.576.1">
...
 </span><span class="koboSpan" id="kobo.576.2">neutron_enable_ovn_agent: "yes"
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.577.1">
     Next, make sure to adjust the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.578.1">
      /ansible/inventory/multi_packtpub_prod
     </span>
    </strong>
    <span class="koboSpan" id="kobo.579.1">
     inventory file to install the OVN services in the assigned nodes.
    </span>
    <span class="koboSpan" id="kobo.579.2">
     Similar to the OVS configuration, make sure to have the Neutron server and respective agents running in the controller and
    </span>
    <a id="_idIndexMarker600">
    </a>
    <span class="koboSpan" id="kobo.580.1">
     network
    </span>
    <a id="_idIndexMarker601">
    </a>
    <span class="koboSpan" id="kobo.581.1">
     nodes, respectively,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.582.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.583.1">
...
</span><span class="koboSpan" id="kobo.583.2">[control]
cc01.os.packtpub
...
</span><span class="koboSpan" id="kobo.583.3">[neutron-server:children]
control
[network]
net01.os.packtpub
[neutron:children]
network
[neutron-dhcp-agent:children]
neutron
[neutron-l3-agent:children]
neutron
[neutron-metadata-agent:children]
neutron
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.584.1">
     As discussed in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.585.1">
      OVN in OpenStack
     </span>
    </em>
    <span class="koboSpan" id="kobo.586.1">
     section, the OVS northbound and southbound databases, in addition to the OVN
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.587.1">
      northd
     </span>
    </strong>
    <span class="koboSpan" id="kobo.588.1">
     daemon, will run on the controller node,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.589.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.590.1">
...
</span><span class="koboSpan" id="kobo.590.2">[ovn-database:children]
control
[ovn-northd:children]
ovn-database
[ovn-nb-db:children]
ovn-database
[ovn-sb-db:children]
ovn-database</span></pre>
   <p>
    <span class="koboSpan" id="kobo.591.1">
     The OVN controller
    </span>
    <a id="_idIndexMarker602">
    </a>
    <span class="koboSpan" id="kobo.592.1">
     instances and OVN
    </span>
    <a id="_idIndexMarker603">
    </a>
    <span class="koboSpan" id="kobo.593.1">
     metadata agents will run on the compute nodes,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.594.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.595.1">
...
</span><span class="koboSpan" id="kobo.595.2">[neutron-ovn-agent:children]
compute
[ovn-controller:children]
ovn-controller-compute
[ovn-controller-compute:children]
compute
[neutron-ovn-metadata-agent:children]
compute
...</span></pre>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.596.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.597.1">
     Since Antelope and later releases, a dedicated OVN agent has been created to implement the lacking
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.598.1">
       ovn-controller
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.599.1">
      function.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.600.1">
     Launching the pipeline job should deploy the OVN services and create an ML2 file,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.601.1">
      /etc/neutron/plugins/ml2/ml2_conf.ini
     </span>
    </strong>
    <span class="koboSpan" id="kobo.602.1">
     , with the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.603.1">
      default configurations:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.604.1">
...
</span><span class="koboSpan" id="kobo.604.2">[ml2]
tenant_network_types = geneve
type_drivers = local,flat,vlan,geneve
mechanism_drivers = ovn
[ml2_type_geneve]
max_header_size = 38
vni_ranges = 1001:2000
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.605.1">
     The default network tenant type is configured with GENEVE as the tunneling protocol.
    </span>
    <span class="koboSpan" id="kobo.605.2">
     The main difference between GENEVE and VXLAN (configured for OVS in a previous section) is how
    </span>
    <a id="_idIndexMarker604">
    </a>
    <span class="koboSpan" id="kobo.606.1">
     the
    </span>
    <a id="_idIndexMarker605">
    </a>
    <span class="koboSpan" id="kobo.607.1">
     networking metadata is encapsulated and encoded between both protocols.
    </span>
    <span class="koboSpan" id="kobo.607.2">
     VXLAN encodes the VNI only in the encapsulation header.
    </span>
    <span class="koboSpan" id="kobo.607.3">
     Meanwhile, the GENEVE protocol uses extensible TLV to carry more information about the packet in the encapsulated header (it has a header length of 38 bytes, while the VXLAN frame can carry 8 bytes), such as the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.608.1">
      ingress
     </span>
    </strong>
    <span class="koboSpan" id="kobo.609.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.610.1">
      egress
     </span>
    </strong>
    <span class="koboSpan" id="kobo.611.1">
     ports.
    </span>
    <span class="koboSpan" id="kobo.611.2">
     GENEVE offers better capabilities, such as transport security, service chaining, and in-band telemetry, compared
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.612.1">
      to VXLAN.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.613.1">
     The other resulting default configuration is the default northbound and southbound database addresses.
    </span>
    <span class="koboSpan" id="kobo.613.2">
     Each OVN controller running in each compute node should be able to reach both databases.
    </span>
    <span class="koboSpan" id="kobo.613.3">
     Such configuration can be found in the same file,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.614.1">
      ml2_conf.ini
     </span>
    </strong>
    <span class="koboSpan" id="kobo.615.1">
     , by checking the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.616.1">
      following settings:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.617.1">
...
</span><span class="koboSpan" id="kobo.617.2">[ovn]
ovn_nb_connection = tcp:10.0.0.24:6642
ovn_sb_connection = tcp:10.0.0.24:6642
ovn_metadata_enabled = True
enable_distributed_floating_ip = True</span></pre>
   <p>
    <span class="koboSpan" id="kobo.618.1">
     Once OVN is configured, further network resource creation and management will be handled by OVN, which maps each OpenStack resource abstraction to an entry object in the OVN southbound and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.619.1">
      northbound databases.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.620.1">
     Both OVS and OVN provide different capabilities to connect instances to networks.
    </span>
    <span class="koboSpan" id="kobo.620.2">
     In the following
    </span>
    <a id="_idIndexMarker606">
    </a>
    <span class="koboSpan" id="kobo.621.1">
     section, we will explore how
    </span>
    <a id="_idIndexMarker607">
    </a>
    <span class="koboSpan" id="kobo.622.1">
     routing is performed in Neutron and demonstrate the different routing traffic options
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.623.1">
      in OpenStack.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-122">
    <a id="_idTextAnchor167">
    </a>
    <span class="koboSpan" id="kobo.624.1">
     Configuring cloud routing
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.625.1">
     Instances within
    </span>
    <a id="_idIndexMarker608">
    </a>
    <span class="koboSpan" id="kobo.626.1">
     the same virtual tenant network can reach each other, but by default, each tenant network cannot reach other tenants or external networks.
    </span>
    <span class="koboSpan" id="kobo.626.2">
     Deploying virtual routers is the way to enable L3 network communication so that tenant virtual networks can connect by associating a subnet with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.627.1">
      a router.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-123">
    <a id="_idTextAnchor168">
    </a>
    <span class="koboSpan" id="kobo.628.1">
     Routing tenant traffic
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.629.1">
     Under the hood, a
    </span>
    <a id="_idIndexMarker609">
    </a>
    <span class="koboSpan" id="kobo.630.1">
     port associated with a tenant virtual
    </span>
    <a id="_idIndexMarker610">
    </a>
    <span class="koboSpan" id="kobo.631.1">
     network will be associated with the IP address of the subnet gateway.
    </span>
    <span class="koboSpan" id="kobo.631.2">
     Instances across different virtual networks reach each other by communicating via the virtual router, using the gateway IP address and their private IP addresses encapsulated in
    </span>
    <a id="_idIndexMarker611">
    </a>
    <span class="koboSpan" id="kobo.632.1">
     the packets.
    </span>
    <span class="koboSpan" id="kobo.632.2">
     This is
    </span>
    <a id="_idIndexMarker612">
    </a>
    <span class="koboSpan" id="kobo.633.1">
     called a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.634.1">
      NAT
     </span>
    </strong>
    <span class="koboSpan" id="kobo.635.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.636.1">
      network address translation
     </span>
    </strong>
    <span class="koboSpan" id="kobo.637.1">
     ) mechanism.
    </span>
    <span class="koboSpan" id="kobo.637.2">
     In OpenStack networking, the Neutron L3 agent manages virtual routers.
    </span>
    <span class="koboSpan" id="kobo.637.3">
     IP packets are forwarded by a virtual router to different self-service and external networks through the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.638.1">
      router interfaces:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.639.1">
       qr
      </span>
     </strong>
     <span class="koboSpan" id="kobo.640.1">
      : Contains the tenant network gateway IP address and is dedicated to routing traffic through all self-service
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.641.1">
       traffic networks
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.642.1">
       qg
      </span>
     </strong>
     <span class="koboSpan" id="kobo.643.1">
      : Contains the external network gateway IP address and is dedicated to routing traffic out onto the external
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.644.1">
       provider network
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.645.1">
     Upon the initiation of a virtual router instance, a network namespace will be created in the Neutron node that defines connections to self-service or external provider networks through routing tables, packet forwarding, and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.646.1">
      iptables
     </span>
    </strong>
    <span class="koboSpan" id="kobo.647.1">
     rules.
    </span>
    <span class="koboSpan" id="kobo.647.2">
     As shown in the following diagram, a
    </span>
    <a id="_idIndexMarker613">
    </a>
    <span class="koboSpan" id="kobo.648.1">
     router namespace refers to a virtual router that
    </span>
    <a id="_idIndexMarker614">
    </a>
    <span class="koboSpan" id="kobo.649.1">
     is attached to multiple bridge ports in an OVS configuration (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.650.1">
      qr
     </span>
    </strong>
    <span class="koboSpan" id="kobo.651.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.652.1">
      qg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.653.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.653.2">
     Traffic flow between instances hosted in the same or different compute nodes is routed through the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.654.1">
      virtual router.
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer081">
     <span class="koboSpan" id="kobo.655.1">
      <img alt="Figure 6.8 – Neutron router namespace connectivity based on OVS implementation" src="image/B21716_06_08.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.656.1">
     Figure 6.8 – Neutron router namespace connectivity based on OVS implementation
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.657.1">
     In the previous OVS implementation, the L3 agent should be up and running to start creating and managing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.658.1">
      virtual routers.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.659.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.660.1">
     The router service plugin should be enabled by default once Neutron agent L3 is deployed, using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.661.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.662.1">
     .
    </span>
    <span class="koboSpan" id="kobo.662.2">
     The service plugin can be verified in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.663.1">
      /etc/neutron/neutron.conf
     </span>
    </strong>
    <span class="koboSpan" id="kobo.664.1">
     file in the Neutron cloud controller node by checking the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.665.1">
      service_plugin =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.666.1">
       router
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.667.1">
      line.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.668.1">
     Optionally, virtual routers can be managed through Horizon.
    </span>
    <span class="koboSpan" id="kobo.668.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.669.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.670.1">
     run for the Neutron deployment should enable the router module in the dashboard.
    </span>
    <span class="koboSpan" id="kobo.670.2">
     That can be verified in the cloud controller node’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.671.1">
      /etc/openstack-dashboard/local_settings.py
     </span>
    </strong>
    <span class="koboSpan" id="kobo.672.1">
     file with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.673.1">
      following settings:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.674.1">
...
</span><span class="koboSpan" id="kobo.674.2">OPENSTACK_NEUTRON_NETWORK = {
    'enable_router': True,
...</span></pre>
   <p>
    <span class="koboSpan" id="kobo.675.1">
     In the next exercise, we
    </span>
    <a id="_idIndexMarker615">
    </a>
    <span class="koboSpan" id="kobo.676.1">
     will create a tenant virtual network with the ML2
    </span>
    <a id="_idIndexMarker616">
    </a>
    <span class="koboSpan" id="kobo.677.1">
     plugin configured in OVS.
    </span>
    <span class="koboSpan" id="kobo.677.2">
     A virtual router will be attached to the tenant network using the OpenStack CLI,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.678.1">
      as follows:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.679.1">
      Create a tenant virtual network using the OpenStack
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.680.1">
       network CLI:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.681.1">$ openstack network create network_pp</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.682.1">
      Create a subnet with an IP range of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.683.1">
       10.10.0.10/24
      </span>
     </strong>
     <span class="koboSpan" id="kobo.684.1">
      , an auto-assigned DHCP, and a default DNS nameserver
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.685.1">
       of
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.686.1">
        8.8.8.8
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.687.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.688.1">$ openstack subnet create --subnet-range 10.10.0.0/24 --network network_pp --dns-server 8.8.8.8 priv_subnet</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.689.1">
      Create a router and attach it to the created
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.690.1">
       tenant network:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.691.1">$ openstack router create router_pp</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.692.1">$ openstack router add subnet router_pp priv_subnet</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.693.1">
      The router attachment to the tenant network will assign a private IP address to the router’s internal interface.
     </span>
     <span class="koboSpan" id="kobo.693.2">
      By default, if no IP address is specified in the attachment command line, the internal interface will be assigned the default gateway of the subnet.
     </span>
     <span class="koboSpan" id="kobo.693.3">
      The following command line verifies the assigned IP address of the router’s
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.694.1">
       internal interface:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.695.1">$ openstack port list --router router_pp</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.696.1">
       It gives the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.697.1">
        following output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer082">
     <span class="koboSpan" id="kobo.698.1">
      <img alt="Figure 6.9 – Virtual router port listing" src="image/B21716_06_09.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.699.1">
     Figure 6.9 – Virtual router port listing
    </span>
   </p>
   <ol>
    <li value="5">
     <span class="koboSpan" id="kobo.700.1">
      The router
     </span>
     <a id="_idIndexMarker617">
     </a>
     <span class="koboSpan" id="kobo.701.1">
      interface can be checked within the router
     </span>
     <a id="_idIndexMarker618">
     </a>
     <span class="koboSpan" id="kobo.702.1">
      namespace
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.703.1">
       qr-
      </span>
     </strong>
     <span class="koboSpan" id="kobo.704.1">
      prefixed interface by running the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.705.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.706.1">$ ip netns</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.707.1">
       The output looks like
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.708.1">
        the following:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer083">
     <span class="koboSpan" id="kobo.709.1">
      <img alt="Figure 6.10 – The network namespaces list" src="image/B21716_06_10.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.710.1">
     Figure 6.10 – The network namespaces list
    </span>
   </p>
   <ol>
    <li value="6">
     <span class="koboSpan" id="kobo.711.1">
      Copy the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.712.1">
       qrouter
      </span>
     </strong>
     <span class="koboSpan" id="kobo.713.1">
      ID from the previous output, and then run the following command line to show the created interface of the router and the assigned IP address from the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.714.1">
       internal network:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.715.1">$ ip netns exec qrouter-3a211622-11da-9687-bda1-acae3d74ad12 ip addr show</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.716.1">
       We will get the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.717.1">
        following output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer084">
     <span class="koboSpan" id="kobo.718.1">
      <img alt="Figure 6.11 – A virtual router namespace internal interface listing" src="image/B21716_06_11.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.719.1">
     Figure 6.11 – A virtual router namespace internal interface listing
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.720.1">
     To enable instances to reach the external network, a second interface in the virtual router should be created that will be attached to the provider’s external network.
    </span>
    <span class="koboSpan" id="kobo.720.2">
     A common networking setup, such as an external network device or a device integrated with a firewall appliance, should be placed in front of the OpenStack endpoint (such as the load balancer).
    </span>
    <span class="koboSpan" id="kobo.720.3">
     Enabling internet access can be configured using the OpenStack CLI,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.721.1">
      as follows:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.722.1">
      Create an
     </span>
     <a id="_idIndexMarker619">
     </a>
     <span class="koboSpan" id="kobo.723.1">
      external network provider.
     </span>
     <span class="koboSpan" id="kobo.723.2">
      As configured in the
     </span>
     <a id="_idIndexMarker620">
     </a>
     <span class="koboSpan" id="kobo.724.1">
      ML2 plugin for OVS, we can create the network as a VLAN type, with a defined segmentation ID and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.725.1">
       physnet1
      </span>
     </strong>
     <span class="koboSpan" id="kobo.726.1">
      for the physical
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.727.1">
       network attribute:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.728.1">$ openstack network create --external -–provider-network-type vlan --provider-segment 40</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.729.1">--provider-physical-network physnet1 external_pp</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.730.1">
      Create the subnet part of the external network with a network range of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.731.1">
       10.20.0.0/24
      </span>
     </strong>
     <span class="koboSpan" id="kobo.732.1">
      and the default gateway as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.733.1">
       10.20.0.1
      </span>
     </strong>
     <span class="koboSpan" id="kobo.734.1">
      , disable DHCP, and set an allocation pool
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.735.1">
       of
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.736.1">
        10.20.0.10-10.20.0.100
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.737.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.738.1">$ openstack subnet create --subnet-range 10.20.0.0/24 --no-dhcp</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.739.1">--network external_pp --allocation-pool</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.740.1">start=10.20.0.10,end=10.20.0.100 pub_subnet</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.741.1">
      Attach the router to an external provider network by running the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.742.1">
       command line:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.743.1">$ openstack router set --external-gateway external_pp router_pp</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.744.1">
      The attachment operation will assign an external IP from the external IP pool to the router, which can be checked by running the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.745.1">
       command line:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.746.1">$ openstack port list --router router_pp</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.747.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.748.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer085">
     <span class="koboSpan" id="kobo.749.1">
      <img alt="Figure 6.12 – A created external port of the virtual router" src="image/B21716_06_12.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.750.1">
     Figure 6.12 – A created external port of the virtual router
    </span>
   </p>
   <ol>
    <li value="5">
     <span class="koboSpan" id="kobo.751.1">
      The last attachment creates a second interface, prefixed with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.752.1">
       qg-
      </span>
     </strong>
     <span class="koboSpan" id="kobo.753.1">
      in the router namespace, which can be verified by the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.754.1">
       command line:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.755.1">$ ip netns exec qrouter-3a211622-11da-9687-bda1-acae3d74ad12 ip addr show</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.756.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.757.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer086">
     <span class="koboSpan" id="kobo.758.1">
      <img alt="Figure 6.13 – A virtual router namespace external interface listing" src="image/B21716_06_13.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.759.1">
     Figure 6.13 – A virtual router namespace external interface listing
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.760.1">
     The next part of our connectivity demonstration involves creating security groups and rules to allow ingress and egress traffic at the network port level.
    </span>
    <span class="koboSpan" id="kobo.760.2">
     To reach the internet and access
    </span>
    <a id="_idIndexMarker621">
    </a>
    <span class="koboSpan" id="kobo.761.1">
     the
    </span>
    <a id="_idIndexMarker622">
    </a>
    <span class="koboSpan" id="kobo.762.1">
     instances, we will create a new security
    </span>
    <a id="_idIndexMarker623">
    </a>
    <span class="koboSpan" id="kobo.763.1">
     group
    </span>
    <a id="_idIndexMarker624">
    </a>
    <span class="koboSpan" id="kobo.764.1">
     and add
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.765.1">
      ICMP
     </span>
    </strong>
    <span class="koboSpan" id="kobo.766.1">
     and
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.767.1">
       SSH
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.768.1">
      access:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.769.1">
      Using the OpenStack CLI, create a new security group to be applied to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.770.1">
       your instances:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.771.1">$ openstack security group create SG_pp</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.772.1">
      Create the rules associated with the created security group for SSH and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.773.1">
       ICMP, respectively:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.774.1">$ openstack security group rule create SG_pp --protocol tcp --dst-port 22</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.775.1">$ openstack security group rule create SG_pp</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.776.1">--protocol icmp</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.777.1">
      Using the OpenStack CLI, create a new test instance with a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.778.1">
       tiny
      </span>
     </strong>
     <span class="koboSpan" id="kobo.779.1">
      flavor and a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.780.1">
       cirros
      </span>
     </strong>
     <span class="koboSpan" id="kobo.781.1">
      image that is connected to the private
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.782.1">
       tenant network:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.783.1">$ openstack server create --flavor tiny --image cirros-0.5.2 --nic net-id=network_pp --security-group SG_pp instance_pp</span></strong></pre>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.784.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.785.1">
     Make sure to adjust your available Glance image name and list of flavors, based on your existing resources.
    </span>
    <span class="koboSpan" id="kobo.785.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.786.1">
      openstack server create
     </span>
    </strong>
    <span class="koboSpan" id="kobo.787.1">
     command line will fail if any of the assigned arguments do not exist.
    </span>
    <span class="koboSpan" id="kobo.787.2">
     Cirros is a minimal Linux distribution, useful for quick testing and proof of concepts.
    </span>
    <span class="koboSpan" id="kobo.787.3">
     The default session username is
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.788.1">
      cirros
     </span>
    </strong>
    <span class="koboSpan" id="kobo.789.1">
     and the password
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.790.1">
      is
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.791.1">
       gocubsgo
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.792.1">
      .
     </span>
    </span>
   </p>
   <ol>
    <li value="4">
     <span class="koboSpan" id="kobo.793.1">
      To test the connectivity from the instance to reach the internet, make sure that the instance state is
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.794.1">
       ACTIVE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.795.1">
      ,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.796.1">
       as follows:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.797.1">$ openstack server list</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.798.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.799.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer087">
     <span class="koboSpan" id="kobo.800.1">
      <img alt="Figure 6.14 – The instance listing" src="image/B21716_06_14.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.801.1">
     Figure 6.14 – The instance listing
    </span>
   </p>
   <ol>
    <li value="5">
     <span class="koboSpan" id="kobo.802.1">
      Access to the created instance can be made in different ways, using the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.803.1">
       virsh console
      </span>
     </strong>
     <span class="koboSpan" id="kobo.804.1">
      command
     </span>
     <a id="_idIndexMarker625">
     </a>
     <span class="koboSpan" id="kobo.805.1">
      line from the compute node or simply
     </span>
     <a id="_idIndexMarker626">
     </a>
     <span class="koboSpan" id="kobo.806.1">
      via SSH from the router namespace.
     </span>
     <span class="koboSpan" id="kobo.806.2">
      Make sure to use the default
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.807.1">
       cirros
      </span>
     </strong>
     <span class="koboSpan" id="kobo.808.1">
      image credentials – that is, the username
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.809.1">
       cirros
      </span>
     </strong>
     <span class="koboSpan" id="kobo.810.1">
      and the password
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.811.1">
       gocubsgo
      </span>
     </strong>
     <span class="koboSpan" id="kobo.812.1">
      – and run a simple ping to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.813.1">
       reach
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.814.1">
        8.8.8.8
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.815.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.816.1">$ ip netns exec qrouter-3a211622-11da-9687-bda1-acae3d74ad12 ssh cirros@10.10.0.12</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.817.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.818.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer088">
     <span class="koboSpan" id="kobo.819.1">
      <img alt="Figure 6.15 – Testing external connectivity" src="image/B21716_06_15.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.820.1">
     Figure 6.15 – Testing external connectivity
    </span>
   </p>
   <ol>
    <li value="6">
     <span class="koboSpan" id="kobo.821.1">
      The instance uses the internal virtual router IP address as the default gateway to route traffic reaching the external network.
     </span>
     <span class="koboSpan" id="kobo.821.2">
      The internet is reachable through SNAT, performed by the router.
     </span>
     <span class="koboSpan" id="kobo.821.3">
      A quick run of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.822.1">
       ip route
      </span>
     </strong>
     <span class="koboSpan" id="kobo.823.1">
      command in the instance shows the default gateway associated with the network
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.824.1">
       route table:
      </span>
     </span>
    </li>
   </ol>
   <p class="IMG---Figure">
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer089">
     <span class="koboSpan" id="kobo.825.1">
      <img alt="Figure 6.16 – Listing the default gateway" src="image/B21716_06_16.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.826.1">
     Figure 6.16 – Listing the default gateway
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.827.1">
     The next part of our walk-through is a demonstration of how resources hosted in external networks can reach instances in an OpenStack environment.
    </span>
    <span class="koboSpan" id="kobo.827.2">
     By default, spawned instances will be assigned an IP address that is not visible outside of the tenant network.
    </span>
    <span class="koboSpan" id="kobo.827.3">
     Neutron provides float IP addresses that implement
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.828.1">
      DNAT
     </span>
    </strong>
    <span class="koboSpan" id="kobo.829.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.830.1">
      destination NAT
     </span>
    </strong>
    <span class="koboSpan" id="kobo.831.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.831.2">
     The router
    </span>
    <a id="_idIndexMarker627">
    </a>
    <span class="koboSpan" id="kobo.832.1">
     simply forwards incoming packets reaching its external interface to the destination instance by checking its configured DNAT rule.
    </span>
    <span class="koboSpan" id="kobo.832.2">
     The traffic response from an instance to external
    </span>
    <a id="_idIndexMarker628">
    </a>
    <span class="koboSpan" id="kobo.833.1">
     resources uses the
    </span>
    <a id="_idIndexMarker629">
    </a>
    <span class="koboSpan" id="kobo.834.1">
     source IP addresses translated to the floating IP, demonstrated
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.835.1">
      as follows:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.836.1">
      Extract the port ID of the created instance, and create a floating IP address to associate
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.837.1">
       with it:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.838.1">$ openstack port list --server instance_pp</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.839.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.840.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer090">
     <span class="koboSpan" id="kobo.841.1">
      <img alt="Figure 6.17 – Listing the instance port" src="image/B21716_06_17.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.842.1">
     Figure 6.17 – Listing the instance port
    </span>
   </p>
   <ol>
    <li value="2">
     <span class="koboSpan" id="kobo.843.1">
      Copy the port ID, and run the following command line by pasting the external port ID after the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.844.1">
       --
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.845.1">
        port
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.846.1">
       option:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.847.1">$ openstack floating ip create --port 524ead12-33da-dc11-e3a1-dc34e6da1c81 external_pp</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.848.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.849.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer091">
     <span class="koboSpan" id="kobo.850.1">
      <img alt="Figure 6.18 – Assigning the floating IP address to the external port" src="image/B21716_06_18.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.851.1">
     Figure 6.18 – Assigning the floating IP address to the external port
    </span>
   </p>
   <ol>
    <li value="3">
     <span class="koboSpan" id="kobo.852.1">
      Under the hood, the router namespace configures a secondary address associated with the external interface, prefixed
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.853.1">
       with
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.854.1">
        'qg'
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.855.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.856.1">$ ip netns exec qrouter-3a211622-11da-9687-bda1-acae3d74ad12 ip addr show</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.857.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.858.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer092">
     <span class="koboSpan" id="kobo.859.1">
      <img alt="Figure 6.19 – Associating the IP address with the virtual router external interface" src="image/B21716_06_19.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.860.1">
     Figure 6.19 – Associating the IP address with the virtual router external interface
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.861.1">
     Traffic routed through the external network provider can reach the instance via the assigned
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.862.1">
      floating IP.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.863.1">
     So far, we have
    </span>
    <a id="_idIndexMarker630">
    </a>
    <span class="koboSpan" id="kobo.864.1">
     explored a standard routing implementation in
    </span>
    <a id="_idIndexMarker631">
    </a>
    <span class="koboSpan" id="kobo.865.1">
     OpenStack.
    </span>
    <span class="koboSpan" id="kobo.865.2">
     The next section will uncover another way of performing routing, via dynamic routing,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.866.1">
      in Neutron.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-124">
    <a id="_idTextAnchor169">
    </a>
    <span class="koboSpan" id="kobo.867.1">
     Neutron dynamic routing
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.868.1">
     Dynamic
    </span>
    <a id="_idIndexMarker632">
    </a>
    <span class="koboSpan" id="kobo.869.1">
     routing
    </span>
    <a id="_idIndexMarker633">
    </a>
    <span class="koboSpan" id="kobo.870.1">
     in OpenStack networking is
    </span>
    <a id="_idIndexMarker634">
    </a>
    <span class="koboSpan" id="kobo.871.1">
     based on
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.872.1">
      BGP
     </span>
    </strong>
    <span class="koboSpan" id="kobo.873.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.874.1">
      Border Gateway Protocol
     </span>
    </strong>
    <span class="koboSpan" id="kobo.875.1">
     ), enabling tenant networks to advertise their network prefixes with physical or virtual routers and network devices that support BGP.
    </span>
    <span class="koboSpan" id="kobo.875.2">
     The new addition of BGP in Neutron eliminates the usage of floating IPs for tenant networks that do not rely on network administrators to advertise their network upstream.
    </span>
    <span class="koboSpan" id="kobo.875.3">
     The term
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.876.1">
      dynamic routing
     </span>
    </em>
    <span class="koboSpan" id="kobo.877.1">
     in Neutron was introduced
    </span>
    <a id="_idIndexMarker635">
    </a>
    <span class="koboSpan" id="kobo.878.1">
     with the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.879.1">
      Mitaka
     </span>
    </strong>
    <span class="koboSpan" id="kobo.880.1">
     release.
    </span>
    <span class="koboSpan" id="kobo.880.2">
     The adoption of the BGP routing mechanism varies from one cloud environment to another, depending on the networking setup, mostly due to the requirement for direct connectivity between the network node and the physical network gateway device to peer with (such as a LAN or WAN peer).
    </span>
    <span class="koboSpan" id="kobo.880.3">
     To avoid IP overlapping when advertising IP prefixes, dynamic
    </span>
    <a id="_idIndexMarker636">
    </a>
    <span class="koboSpan" id="kobo.881.1">
     routing relies on
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.882.1">
      address scopes
     </span>
    </strong>
    <span class="koboSpan" id="kobo.883.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.884.1">
      subnet pools
     </span>
    </strong>
    <span class="koboSpan" id="kobo.885.1">
     , Neutron
    </span>
    <a id="_idIndexMarker637">
    </a>
    <span class="koboSpan" id="kobo.886.1">
     mechanisms that control the allocation of subnet addresses and prevent the usage of addresses
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.887.1">
      that overlap.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.888.1">
     At the heart of the BGP implementation, Neutron
    </span>
    <a id="_idIndexMarker638">
    </a>
    <span class="koboSpan" id="kobo.889.1">
     introduced the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.890.1">
      BGP speaker
     </span>
    </strong>
    <span class="koboSpan" id="kobo.891.1">
     , which enables peering between tenant networks and external router devices.
    </span>
    <span class="koboSpan" id="kobo.891.2">
     The BGP speaker advertises the tenant network to the tenant router, initially as a first hop.
    </span>
    <span class="koboSpan" id="kobo.891.3">
     The BGP speaker in Neutron is not a router instance, nor does it manipulate BGP routes.
    </span>
    <span class="koboSpan" id="kobo.891.4">
     It mainly orchestrates the BGP peer’s information between the tenant routers and external ones.
    </span>
    <span class="koboSpan" id="kobo.891.5">
     The speaker requires a network or cloud operator to configure the peering endpoints.
    </span>
    <span class="koboSpan" id="kobo.891.6">
     As shown in the following diagram, for a successful BGP dynamic routing in OpenStack, the Neutron virtual router
    </span>
    <a id="_idIndexMarker639">
    </a>
    <span class="koboSpan" id="kobo.892.1">
     must be
    </span>
    <a id="_idIndexMarker640">
    </a>
    <span class="koboSpan" id="kobo.893.1">
     attached to both the tenant subnet and the external provider
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.894.1">
      device interface.
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer093">
     <span class="koboSpan" id="kobo.895.1">
      <img alt="Figure 6.20 – Neutron BGP peering and router connectivity for dynamic routing" src="image/B21716_06_20.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.896.1">
     Figure 6.20 – Neutron BGP peering and router connectivity for dynamic routing
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.897.1">
     Both the BGP speaker and the external provider device must be peered (connected to the Neutron virtual router).
    </span>
    <span class="koboSpan" id="kobo.897.2">
     Finally, both the tenant and the external networks must be in the same address scope.
    </span>
    <span class="koboSpan" id="kobo.897.3">
     Adding BGP dynamic routing using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.898.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.899.1">
     is straightforward.
    </span>
    <span class="koboSpan" id="kobo.899.2">
     We will configure the dynamic routing based on the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.900.1">
      OVS implementation.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.901.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.902.1">
     Since the Antelope release, Neutron has supported dynamic routing with the OVN
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.903.1">
      mechanism driver.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.904.1">
     As Neutron provides a BGP agent with default configuration, we will just need to enable the agent installation in the network node by adding the following line to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.905.1">
      /ansible/inventory/multi_packtpub_prod
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.906.1">
      inventory file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.907.1">
...
</span><span class="koboSpan" id="kobo.907.2">[neutron-bgp-dragent:children]
neutron</span></pre>
   <p>
    <span class="koboSpan" id="kobo.908.1">
     Enable the agent installation in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.909.1">
      globals
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.910.1">
      .yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.911.1">
     file,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.912.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.913.1">
enable_neutron_bgp_dragent: "yes"</span></pre>
   <p>
    <span class="koboSpan" id="kobo.914.1">
     Launch the pipeline to roll out the BGP agent installation in the network node.
    </span>
    <span class="koboSpan" id="kobo.914.2">
     In the network node, the
    </span>
    <a id="_idIndexMarker641">
    </a>
    <span class="koboSpan" id="kobo.915.1">
     installed BGP agent can be checked
    </span>
    <a id="_idIndexMarker642">
    </a>
    <span class="koboSpan" id="kobo.916.1">
     by running the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.917.1">
      command line:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.918.1">
$ openstack network agent list --agent-type bgp</span></pre>
   <p>
    <span class="koboSpan" id="kobo.919.1">
     Here is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.920.1">
      the output:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer094">
     <span class="koboSpan" id="kobo.921.1">
      <img alt="Figure 6.21 – Listing the BGP network agent" src="image/B21716_06_21.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.922.1">
     Figure 6.21 – Listing the BGP network agent
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.923.1">
     The Neutron BGP CLI to manage BGP speakers can be found
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.924.1">
      at
     </span>
    </span>
    <a href="https://docs.openstack.org/python-openstackclient/latest/cli/plugin-commands/neutron.html">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.925.1">
       https://docs.openstack.org/python-openstackclient/latest/cli/plugin-commands/neutron.html
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.926.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.927.1">
     Virtual routers are part of the building blocks of OpenStack networking, providing a variety of connectivity options to tenants.
    </span>
    <span class="koboSpan" id="kobo.927.2">
     It is important to note that running with a standalone router presents a single point of failure.
    </span>
    <a href="B21716_07.xhtml#_idTextAnchor174">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.928.1">
        Chapter 7
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.929.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.930.1">
      Running a Highly Available Cloud – Meeting the SLA
     </span>
    </em>
    <span class="koboSpan" id="kobo.931.1">
     , will discuss Neutron implementation for highly available routers.
    </span>
    <span class="koboSpan" id="kobo.931.2">
     Dynamic routing via BGP in Neutron is considered an amazing routing addition in OpenStack.
    </span>
    <span class="koboSpan" id="kobo.931.3">
     Neutron
    </span>
    <a id="_idIndexMarker643">
    </a>
    <span class="koboSpan" id="kobo.932.1">
     has been enriched and modified across OpenStack releases.
    </span>
    <span class="koboSpan" id="kobo.932.2">
     One of these major modifications is the development of
    </span>
    <a id="_idIndexMarker644">
    </a>
    <span class="koboSpan" id="kobo.933.1">
     new networking services in OpenStack, which will be discussed in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.934.1">
      next section.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-125">
    <a id="_idTextAnchor170">
    </a>
    <span class="koboSpan" id="kobo.935.1">
     Joining more networking services
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.936.1">
     Besides the overwhelming
    </span>
    <a id="_idIndexMarker645">
    </a>
    <span class="koboSpan" id="kobo.937.1">
     routing and switching capabilities in Neutron that come with the latest OpenStack releases, Neutron enables cloud operators to offer additional networking services.
    </span>
    <span class="koboSpan" id="kobo.937.2">
     Services such as load balancing, firewalls, and private networks support tenant networks to build well-architected application stacks for a variety of use cases.
    </span>
    <span class="koboSpan" id="kobo.937.3">
     In the next section, we will cover the most used and stable additional Neutron services and deploy them,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.938.1">
      using
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.939.1">
       kolla-ansible
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.940.1">
      .
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-126">
    <a id="_idTextAnchor171">
    </a>
    <span class="koboSpan" id="kobo.941.1">
     Load balancer as a service
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.942.1">
     Since the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.943.1">
      Liberty
     </span>
    </strong>
    <span class="koboSpan" id="kobo.944.1">
     release, the
    </span>
    <a id="_idIndexMarker646">
    </a>
    <span class="koboSpan" id="kobo.945.1">
     Neutron
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.946.1">
      Load Balancer as a Service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.947.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.948.1">
      LBaaS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.949.1">
     ) plugin has
    </span>
    <a id="_idIndexMarker647">
    </a>
    <span class="koboSpan" id="kobo.950.1">
     moved from
    </span>
    <a id="_idIndexMarker648">
    </a>
    <span class="koboSpan" id="kobo.951.1">
     version 1 to version 2, codenamed
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.952.1">
      Octavia
     </span>
    </strong>
    <span class="koboSpan" id="kobo.953.1">
     .
    </span>
    <span class="koboSpan" id="kobo.953.2">
     Cloud
    </span>
    <a id="_idIndexMarker649">
    </a>
    <span class="koboSpan" id="kobo.954.1">
     users who seek to balance the load of their workloads
    </span>
    <a id="_idIndexMarker650">
    </a>
    <span class="koboSpan" id="kobo.955.1">
     using a managed load balancer will appreciate the Octavia offering.
    </span>
    <span class="koboSpan" id="kobo.955.2">
     Octavia is designed to scale horizontally, as it creates and manages virtual machines acting as load-balancer instances, referred to
    </span>
    <a id="_idIndexMarker651">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.956.1">
      as
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.957.1">
       amphorae
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.958.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.959.1">
     Octavia implements the same load-balancing terms as the
    </span>
    <a id="_idIndexMarker652">
    </a>
    <span class="koboSpan" id="kobo.960.1">
     popular
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.961.1">
      HAProxy
     </span>
    </strong>
    <span class="koboSpan" id="kobo.962.1">
     , which can be summarized
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.963.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.964.1">
       Virtual IP (VIP)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.965.1">
      : A layer 4 object
     </span>
     <a id="_idIndexMarker653">
     </a>
     <span class="koboSpan" id="kobo.966.1">
      that exposes a service to be accessed, externally or internally, that is associated with a Neutron port.
     </span>
     <span class="koboSpan" id="kobo.966.2">
      A load balancer is assigned a VIP, and requests that reach the VIP are distributed among backend servers or
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.967.1">
       pool members.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.968.1">
       Pool
      </span>
     </strong>
     <span class="koboSpan" id="kobo.969.1">
      : A group of instances serving the same content or service, such as
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.970.1">
       web servers.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.971.1">
       Pool members
      </span>
     </strong>
     <span class="koboSpan" id="kobo.972.1">
      : An instance of a pool represented by an IP address and listening port that exposes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.973.1">
       the service.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.974.1">
       Listeners
      </span>
     </strong>
     <span class="koboSpan" id="kobo.975.1">
      : A port associated with the VIP that listens for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.976.1">
       incoming requests.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.977.1">
       Health monitor
      </span>
     </strong>
     <span class="koboSpan" id="kobo.978.1">
      : Orchestrates the management of pool members based on health checks carried out on each member.
     </span>
     <span class="koboSpan" id="kobo.978.2">
      Failed health checks will discard the members from the pool, and traffic will be served by the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.979.1">
       healthy ones.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.980.1">
       Load-balancing algorithms
      </span>
     </strong>
     <span class="koboSpan" id="kobo.981.1">
      :
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.982.1">
       Round robin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.983.1">
      ,
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.984.1">
       least connections
      </span>
     </strong>
     <span class="koboSpan" id="kobo.985.1">
      , and
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.986.1">
       source IPs
      </span>
     </strong>
     <span class="koboSpan" id="kobo.987.1">
      are supported algorithms in Octavia that can be assigned when creating
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.988.1">
       a pool.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.989.1">
       Session persistence
      </span>
     </strong>
     <span class="koboSpan" id="kobo.990.1">
      : A mechanism that forces client requests to be served by the same backend server.
     </span>
     <span class="koboSpan" id="kobo.990.2">
      Since the depreciation of LBaaS v1, the load-balancing service in Neutron can be configured through drivers.
     </span>
     <span class="koboSpan" id="kobo.990.3">
      The most common ones are HAProxy and Octavia.
     </span>
     <span class="koboSpan" id="kobo.990.4">
      Other third-party vendor drivers can also be integrated, such as F5 and Citrix, and Neutron will manage the orchestration of the
     </span>
     <a id="_idIndexMarker654">
     </a>
     <span class="koboSpan" id="kobo.991.1">
      API calls in the
     </span>
     <a id="_idIndexMarker655">
     </a>
     <span class="koboSpan" id="kobo.992.1">
      OpenStack environment.
     </span>
     <span class="koboSpan" id="kobo.992.2">
      A glossary
     </span>
     <a id="_idIndexMarker656">
     </a>
     <span class="koboSpan" id="kobo.993.1">
      of different components in Octavia is
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.994.1">
       as follows:
      </span>
     </span>
     <ul>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.995.1">
         Amphora
        </span>
       </strong>
       <span class="koboSpan" id="kobo.996.1">
        : A virtual machine acting as a load balancer, running on compute nodes and preconfigured with load-balancing parameters, such as pools, backend members, and
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.997.1">
         health monitors.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.998.1">
         Controller worker
        </span>
       </strong>
       <span class="koboSpan" id="kobo.999.1">
        : Updates the load-balancer instance (Amphora instance) with
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1000.1">
         configuration settings.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.1001.1">
         API controller
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1002.1">
        : Interacts with the controller worker for load-balancer (Amphora instances configurations and operations for deployment, deletion,
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1003.1">
         and monitoring.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.1004.1">
         Health manager
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1005.1">
        : Watches the state of each load balancer (Amphora instance) and triggers failover events during the unexpected failure of a
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1006.1">
         load balancer.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.1007.1">
         Housekeeping manager
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1008.1">
        : Removes
       </span>
       <a id="_idIndexMarker657">
       </a>
       <span class="koboSpan" id="kobo.1009.1">
        stale database records and handles the
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1010.1">
         spare pool.
        </span>
       </span>
      </li>
     </ul>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1011.1">
     The deployment of Octavia using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1012.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1013.1">
     would require more steps than just installing an agent.
    </span>
    <span class="koboSpan" id="kobo.1013.2">
     To install the load-balancing service in OpenStack using the Octavia driver, start by assigning the core Octavia components to run as part of the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1014.1">
      cloud controller:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1015.1">
...
</span><span class="koboSpan" id="kobo.1015.2">[octavia:children]
control
[octavia-api:children]
octavia
[octavia-driver-agent:children]
octavia
[octavia-health-manager:children]
octavia
[octavia-housekeeping:children]
octavia
[octavia-worker:children]
octavia</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1016.1">
     Enable the
    </span>
    <a id="_idIndexMarker658">
    </a>
    <span class="koboSpan" id="kobo.1017.1">
     Octavia
    </span>
    <a id="_idIndexMarker659">
    </a>
    <span class="koboSpan" id="kobo.1018.1">
     service in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1019.1">
      globals
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1020.1">
      .yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1021.1">
     file,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1022.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1023.1">
...
</span><span class="koboSpan" id="kobo.1023.2">enable_octavia: "yes"</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1024.1">
     Make sure that in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1025.1">
      globals
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1026.1">
      .yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1027.1">
     file, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1028.1">
      enable_neutron_provider_networks
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1029.1">
     setting is set to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1030.1">
      true
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1031.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1031.2">
     This is because we need the Octavia nodes to communicate through the management network.
    </span>
    <span class="koboSpan" id="kobo.1031.3">
     Assign the network interface of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1032.1">
      eth0
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1033.1">
     management network of the cloud
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1034.1">
      controller node:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1035.1">
octavia_network_interface: eth0</span></pre>
   <p>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1036.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1037.1">
     automates most of the Octavia deployment and registration of the associated resources in the OpenStack environment.
    </span>
    <span class="koboSpan" id="kobo.1037.2">
     Octavia interacts with several OpenStack services, including Nova and Neutron.
    </span>
    <span class="koboSpan" id="kobo.1037.3">
     Associated resources can be customized in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1038.1">
      globals
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1039.1">
      .yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1040.1">
     file, such as the amphorae Nova flavor, security groups, and the Octavia network and subnets, which can be set by updating
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1041.1">
      octavia_amp_flavor
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1042.1">
     ,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1043.1">
      octavia_amp_security_groups
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1044.1">
     , and the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1045.1">
      Octavia management network
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1046.1">
     , respectively.
    </span>
    <span class="koboSpan" id="kobo.1046.2">
     By default,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1047.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1048.1">
     is configured to register all
    </span>
    <a id="_idIndexMarker660">
    </a>
    <span class="koboSpan" id="kobo.1049.1">
     dependent Octavia resources automatically.
    </span>
    <span class="koboSpan" id="kobo.1049.2">
     If you want to customize the Octavia registration service, make sure you set all required values
    </span>
    <a id="_idIndexMarker661">
    </a>
    <span class="koboSpan" id="kobo.1050.1">
     for each Octavia setting in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1051.1">
      globals
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1052.1">
      .yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1053.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.1053.2">
     That can be done after changing the following setting from
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1054.1">
      no
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1055.1">
      to
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1056.1">
       yes
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1057.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1058.1">
octavia_auto_configure: "yes"</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1059.1">
     Run the deployment pipeline to roll out the Octavia service.
    </span>
    <span class="koboSpan" id="kobo.1059.2">
     The deployment run should create the necessary Octavia resources, including certificates, the Octavia network, the flavor, the security group, and the SSH key.
    </span>
    <span class="koboSpan" id="kobo.1059.3">
     Make sure that
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1060.1">
      kolla-ansible post-deploy
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1061.1">
     runs successfully by generating an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1062.1">
      octavia-openrc.sh
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1063.1">
     file, loaded
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1064.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1065.1">
$ kolla-ansible post-deploy
$ . </span><span class="koboSpan" id="kobo.1065.2">/etc/kolla/octavia-openrc.sh</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1066.1">
     Octavia uses images to launch amphora instances.
    </span>
    <span class="koboSpan" id="kobo.1066.2">
     Run the following command lines to download a recent
    </span>
    <a id="_idIndexMarker662">
    </a>
    <span class="koboSpan" id="kobo.1067.1">
     amphora image for the Bobcat release, and then add it
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1068.1">
      to Glance:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1069.1">
$ wget https://swift.services.a.regiocloud.tech/swift/v1/AUTH_b182637428444b9aa302bb8d5a5a418c/openstack-octavia-amphora-image/octavia-amphora-haproxy-2023.2.qcow2
$ openstack image create amphora-haproxy --container-format bare --disk-format qcow2 --private --tag amphora --file octavia-amphora-haproxy-2023.2.qcow2 --property hw_architecture='x86_64' --property hw_rng_model=virtio</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1070.1">
     The following steps assume that two web server instances named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1071.1">
      instance1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1072.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1073.1">
      instance2
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1074.1">
     have been deployed and are connected to the tenant network used in a previous
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1075.1">
      demonstration,
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1076.1">
       10.10.0.0/24
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1077.1">
      :
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1078.1">
      Note two of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1079.1">
       created instances:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1080.1">$ openstack server list</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1081.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1082.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer095">
     <span class="koboSpan" id="kobo.1083.1">
      <img alt="Figure 6.22 – Listing the created instances" src="image/B21716_06_22.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1084.1">
     Figure 6.22 – Listing the created instances
    </span>
   </p>
   <ol>
    <li value="2">
     <span class="koboSpan" id="kobo.1085.1">
      To quickly mimic a load-balancing exercise, run the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1086.1">
       SimpleHTTPServer
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1087.1">
      Python module in each of the instances.
     </span>
     <span class="koboSpan" id="kobo.1087.2">
      Create a simple
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1088.1">
       index.html
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1089.1">
      file to trace the load-balancer member pool usage.
     </span>
     <span class="koboSpan" id="kobo.1089.2">
      On
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1090.1">
       instance1
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1091.1">
      , run
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1092.1">
       the following:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1093.1">$ echo "Reaching instance 1" &gt; ~/index.html</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1094.1">$ python -m SimpleHTTPServer</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1095.1">
      Run the same command lines by specifying the second instance in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1096.1">
        index.html
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1097.1">
       file:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1098.1">$ echo "Reaching instance 2" &gt; ~/index.html</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1099.1">$ python -m SimpleHTTPServer</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1100.1">
      Make sure to allow ingress port
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1101.1">
       80
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1102.1">
      on the instances by creating and adding the following
     </span>
     <a id="_idIndexMarker663">
     </a>
     <span class="koboSpan" id="kobo.1103.1">
      security
     </span>
     <a id="_idIndexMarker664">
     </a>
     <span class="koboSpan" id="kobo.1104.1">
      group and rule, if not
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1105.1">
       already attached:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1106.1">$ openstack security group create lb-web-sg</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1107.1">$ openstack security group rule create --ingress --protocol http --dst-port 80 --ethertype IPv4 lb-web-sg</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1108.1">$ openstack server add security group instance1 lb-web-sg</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1109.1">$ openstack server add security group instance2 lb-web-sg</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1110.1">
      Create a load balancer attached to the private subnet,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1111.1">
       priv_subnet
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1112.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1112.2">
      Note that the load balancer will be assigned a VIP that will be used to expose the backend service and allow clients to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1113.1">
       access it:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1114.1">$ openstack loadbalancer create --name lb --vip-subnet-id </span></strong>
<strong class="bold" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1115.1">priv-subnet</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1116.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1117.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer096">
     <span class="koboSpan" id="kobo.1118.1">
      <img alt="Figure 6.23 – Creating the load balancer" src="image/B21716_06_23.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1119.1">
     Figure 6.23 – Creating the load balancer
    </span>
   </p>
   <ol>
    <li value="6">
     <span class="koboSpan" id="kobo.1120.1">
      Once the
     </span>
     <a id="_idIndexMarker665">
     </a>
     <span class="koboSpan" id="kobo.1121.1">
      load
     </span>
     <a id="_idIndexMarker666">
     </a>
     <span class="koboSpan" id="kobo.1122.1">
      balancer updates its
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1123.1">
       PROVISIONING_STATUS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1124.1">
      state from
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1125.1">
       PENDING_CREATE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1126.1">
      to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1127.1">
       ACTIVE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1128.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1129.1">
       OPERATING_STATUS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1130.1">
      to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1131.1">
       ONLINE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1132.1">
      , create a TCP listener port named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1133.1">
       listener80
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1134.1">
      on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1135.1">
       port
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1136.1">
        80
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1137.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1138.1">$ openstack loadbalancer listener create --name listener80 --protocol TCP --protocol-port 80 lb</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1139.1">
      Create a load-balancing pool named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1140.1">
       poolweb
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1141.1">
      , and specify the load-balancing algorithm
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1142.1">
       with
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1143.1">
        ROUND_ROBIN
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1144.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1145.1">$ openstack loadbalancer pool create --name poolweb --lb-algorithm ROUND_ROBIN --listener listener1 --protocol TCP</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1146.1">
      Add a health monitor to the created
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1147.1">
       poolweb
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1148.1">
      with the backend servers and probe the HTTP
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1149.1">
       service port:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1150.1">$ openstack loadbalancer healthmonitor create --name http-check --delay 15 --max-retries 4 --timeout 30 --type HTTP poolweb</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1151.1">
      Join the backend instances (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1152.1">
       instance1
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1153.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1154.1">
       instance2
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1155.1">
      )
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1156.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1157.1">
        poolweb
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1158.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1159.1">$ openstack loadbalancer member create --subnet-id private-subnet --address 10.10.0.114 --protocol-port 80 poolweb</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1160.1">$ openstack loadbalancer member create --subnet-id private-subnet --address 10.10.0.125 --protocol-port 80 poolweb</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1161.1">
      Optionally, check the status of the added backend members and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1162.1">
       created pool:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1163.1">$ openstack loadbalancer member list poolweb</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1164.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1165.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer097">
     <span class="koboSpan" id="kobo.1166.1">
      <img alt="Figure 6.24 – Listing the instance members of the load-balancer pool" src="image/B21716_06_24.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1167.1">
     Figure 6.24 – Listing the instance members of the load-balancer pool
    </span>
   </p>
   <ol>
    <li value="11">
     <span class="koboSpan" id="kobo.1168.1">
      Test the load
     </span>
     <a id="_idIndexMarker667">
     </a>
     <span class="koboSpan" id="kobo.1169.1">
      balancer by connecting to its
     </span>
     <a id="_idIndexMarker668">
     </a>
     <span class="koboSpan" id="kobo.1170.1">
      VIP.
     </span>
     <span class="koboSpan" id="kobo.1170.2">
      Note that requests will be served consecutively by both instances, as the algorithm used for load balancing is
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1171.1">
       round robin:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1172.1">$ for ((i=1;i&lt;=10;i++)); do curl http://10.10.0.14; sleep 1; done</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1173.1">
       Here is
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1174.1">
        the output:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer098">
     <span class="koboSpan" id="kobo.1175.1">
      <img alt="Figure 6.25 – Testing the load-balancer pool backend" src="image/B21716_06_25.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1176.1">
     Figure 6.25 – Testing the load-balancer pool backend
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1177.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1178.1">
     Accessing the pool web backend from the internet can be done in different ways.
    </span>
    <span class="koboSpan" id="kobo.1178.2">
     One way is to attach the load balancer to a public network directly without the need to run behind a virtual router, and the load balancer VIP will be assigned a public routable IP.
    </span>
    <span class="koboSpan" id="kobo.1178.3">
     The other way is by creating a floating IP, and then associating it with the VIP of the load balancer that exists within a subnet behind the virtual router.
    </span>
    <span class="koboSpan" id="kobo.1178.4">
     A floating IP cannot be routable through the internet without a router that applies IP translation, using the assigned floating IP, to a public one to reach
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1179.1">
      external networks.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1180.1">
     A good practice when creating load balancers in Neutron is to think about security first.
    </span>
    <span class="koboSpan" id="kobo.1180.2">
     The latest LBaaS version in OpenStack supports TLS certificate deployment.
    </span>
    <span class="koboSpan" id="kobo.1180.3">
     Even better, OpenStack has a dedicated project that handles keying and certificates, codenamed
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1181.1">
      Barbican
     </span>
    </em>
    <span class="koboSpan" id="kobo.1182.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1182.2">
     To learn
    </span>
    <a id="_idIndexMarker669">
    </a>
    <span class="koboSpan" id="kobo.1183.1">
     more
    </span>
    <a id="_idIndexMarker670">
    </a>
    <span class="koboSpan" id="kobo.1184.1">
     about Barbican, refer to the official OpenStack docs:
    </span>
    <a href="https://docs.openstack.org/barbican/latest/">
     <span class="koboSpan" id="kobo.1185.1">
      https://docs.openstack.org/barbican/latest/
     </span>
    </a>
    <span class="koboSpan" id="kobo.1186.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1186.2">
     A load balancer can work in tandem with the Barbican service to handle its TLS certificates
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1187.1">
      most securely.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-127">
    <a id="_idTextAnchor172">
    </a>
    <span class="koboSpan" id="kobo.1188.1">
     Summary
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1189.1">
     OpenStack networking provides an overwhelming list of features that enable cloud operators and architects to implement advanced network topologies and offer cloud users and tenants more managed network services.
    </span>
    <span class="koboSpan" id="kobo.1189.2">
     As seen in this chapter, the ML2 plugin extends Neutron’s capabilities by unlocking some pertinent features that were lacking in older OpenStack releases.
    </span>
    <span class="koboSpan" id="kobo.1189.3">
     OVS was explored as a mechanism driver that brings more traffic control based on flow rules.
    </span>
    <span class="koboSpan" id="kobo.1189.4">
     For extended networking that requires common VLAN and VXLAN topologies, the chapter demonstrated the support of OVS and OVN drivers in Neutron within the latest OpenStack releases, in addition to their deployments using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1190.1">
      kolla-ansible
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1191.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1191.2">
     It is worth noting that the direction of future networking based on mechanism drivers is almost certainly moving toward adopting the OVN mechanism driver, due to its performance in larger production-grade and hybrid cloud environments.
    </span>
    <span class="koboSpan" id="kobo.1191.3">
     Another big deal, routing in the OpenStack networking world, was discussed.
    </span>
    <span class="koboSpan" id="kobo.1191.4">
     This chapter also revisited a routing implementation using OVS and covered BGP dynamic routing.
    </span>
    <span class="koboSpan" id="kobo.1191.5">
     OVN is becoming a popular way to implement BGP , and new releases might show more stable integration in that direction.
    </span>
    <span class="koboSpan" id="kobo.1191.6">
     However, the chapter did not cover all other extra Neutron services and agents, such as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1192.1">
      VPN as a service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1193.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1194.1">
      firewall as a service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1195.1">
     , and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1196.1">
      Designate
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1197.1">
     for DNS management.
    </span>
    <span class="koboSpan" id="kobo.1197.2">
     LBaaS in Neutron has seen more updates with the latest OpenStack releases.
    </span>
    <span class="koboSpan" id="kobo.1197.3">
     With the new LBaaS v2, cloud operators can configure their load-balancing service by using open source drivers, such as HAProxy or Octavia.
    </span>
    <span class="koboSpan" id="kobo.1197.4">
     Finally, the chapter demonstrated the deployment of a load-balancer setup using Octavia, which is becoming a more widely adopted LBaaS solution that is considered suitable for large-scale
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1198.1">
      production environments.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1199.1">
     In the next chapter, we will enhance our deployed OpenStack environment by tackling resiliency and high availability for the OpenStack control and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1200.1">
      data planes.
     </span>
    </span>
   </p>
  </div>
 

  <div class="Content" id="_idContainer100">
   <h1 id="_idParaDest-128" lang="en-US" xml:lang="en-US">
    <a id="_idTextAnchor173">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     Part 2: Operating the OpenStack Cloud Environment
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.2.1">
     This part will spot the operational mission of cloud operators to bring the cloud to the next stage.
    </span>
    <span class="koboSpan" id="kobo.2.2">
     Essential operational excellence pillars will be covered, including high availability, monitoring, and logging, to ensure business continuity and keep an eye on common best practices on cloud health.
    </span>
    <span class="koboSpan" id="kobo.2.3">
     This part will conclude with an exclusive addition on setting up a continuous infrastructure evaluation and resource
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.3.1">
      optimization layouts.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.4.1">
     This part has the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.5.1">
      following chapters:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <a href="B21716_07.xhtml#_idTextAnchor174">
      <em class="italic">
       <span class="koboSpan" id="kobo.6.1">
        Chapter 7
       </span>
      </em>
     </a>
     <span class="koboSpan" id="kobo.7.1">
      ,
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.8.1">
       Running a Highly Available Cloud – Meeting the SLA
      </span>
     </em>
    </li>
    <li>
     <a href="B21716_08.xhtml#_idTextAnchor188">
      <em class="italic">
       <span class="koboSpan" id="kobo.9.1">
        Chapter 8
       </span>
      </em>
     </a>
     <span class="koboSpan" id="kobo.10.1">
      ,
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.11.1">
       Monitoring and Logging – Remediating Proactively
      </span>
     </em>
    </li>
    <li>
     <a href="B21716_09.xhtml#_idTextAnchor204">
      <em class="italic">
       <span class="koboSpan" id="kobo.12.1">
        Chapter 9
       </span>
      </em>
     </a>
     <span class="koboSpan" id="kobo.13.1">
      ,
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.14.1">
       Benchmarking the Infrastructure – Evaluating Resource Capacity and Optimization
      </span>
     </em>
    </li>
   </ul>
  </div>
  <div>
   <div id="_idContainer101">
   </div>
  </div>
  <div>
   <div id="_idContainer102">
   </div>
  </div>
  <div>
   <div id="_idContainer103">
   </div>
  </div>
  <div>
   <div id="_idContainer104">
   </div>
  </div>
  <div>
   <div id="_idContainer105">
   </div>
  </div>
  <div>
   <div class="Basic-Graphics-Frame" id="_idContainer106">
   </div>
  </div>
  <div>
   <div class="Basic-Graphics-Frame" id="_idContainer107">
   </div>
  </div>
  <div>
   <div id="_idContainer108">
   </div>
  </div>
  <div>
   <div id="_idContainer109">
   </div>
  </div>
  <div>
   <div class="Basic-Graphics-Frame" id="_idContainer110">
   </div>
  </div>
 </body></html>