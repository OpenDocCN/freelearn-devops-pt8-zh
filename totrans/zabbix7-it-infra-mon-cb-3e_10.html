<html><head></head><body>
<div id="_idContainer615" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-321"><a id="_idTextAnchor1893" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.1.1">10</span></h1>
<h1 id="_idParaDest-322" class="calibre5"><a id="_idTextAnchor1894" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.2.1">Extending Zabbix Functionality with Custom Scripts and the Zabbix API</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">Zabbix offers a lot of functionality out of the box. </span><span class="kobospan" id="kobo.3.2">But where Zabbix really shines is customization, not only through the default frontend but especially with scripts and the </span><span><span class="kobospan" id="kobo.4.1">Zabbix API.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, I will go over the basics of using the Zabbix API. </span><span class="kobospan" id="kobo.5.2">We will then see how a Python script can utilize the API to build something cool, such as a jumphost. </span><span class="kobospan" id="kobo.5.3">After that, we’ll use some scripts written by </span><em class="italic"><span class="kobospan" id="kobo.6.1">Brian van Baekel</span></em><span class="kobospan" id="kobo.7.1"> to enable and disable hosts with limited permissions from a </span><span><span class="kobospan" id="kobo.8.1">Zabbix map.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.9.1">After following these recipes, you’ll be more than ready to tackle the Zabbix API and you’ll know how to use scripts to extend Zabbix functionality. </span><span class="kobospan" id="kobo.9.2">This chapter will expand your possibilities with Zabbix to almost endless proportions and you’ll be ready to become a professional Zabbix </span><span><span class="kobospan" id="kobo.10.1">user yourself.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.11.1">In this chapter, we will cover the </span><span><span class="kobospan" id="kobo.12.1">following recipes:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.13.1">Setting up and managing </span><span><span class="kobospan" id="kobo.14.1">API tokens</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.15.1">Using the Zabbix API for </span><span><span class="kobospan" id="kobo.16.1">extending functionality</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.17.1">Building a jumphost using the Zabbix API </span><span><span class="kobospan" id="kobo.18.1">and Python</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.19.1">Enabling and disabling a host from </span><span><span class="kobospan" id="kobo.20.1">Zabbix maps</span></span></li>
</ul>
<h1 id="_idParaDest-323" class="calibre5"><a id="_idTextAnchor1895" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1896" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.21.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.22.1">We are going to need a Zabbix server as well as some new Linux hosts. </span><span class="kobospan" id="kobo.22.2">We will also need to have general knowledge of scripting and programming. </span><span class="kobospan" id="kobo.22.3">We are going to use Python to extend some functionality of Zabbix, which we’ll provide </span><span><span class="kobospan" id="kobo.23.1">scripts for.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.24.1">The code required for the chapter can be found at the </span><span><span class="kobospan" id="kobo.25.1">following link:</span></span></p>
<p class="calibre3"><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter10" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.26.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter10</span></span></a></p>
<p class="calibre3"><span class="kobospan" id="kobo.27.1">Make sure to keep all of this ready and you’ll be sure to nail </span><span><span class="kobospan" id="kobo.28.1">these recipes.</span></span></p>
<h1 id="_idParaDest-324" class="calibre5"><a id="_idTextAnchor1897" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1898" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.29.1">Setting up and managing API tokens</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.30.1">Let’s start off our chapter</span><a id="_idIndexMarker798" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.31.1"> by doing some configuration</span><a id="_idIndexMarker799" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.32.1"> for working with APIs in Zabbix. </span><span class="kobospan" id="kobo.32.2">If you’ve worked with the Zabbix API before, you might know it can be quite a hassle to use API calls to authenticate and get an API token for using it in your scripts. </span><span class="kobospan" id="kobo.32.3">This is no longer the case, as we can generate API tokens using the </span><span><span class="kobospan" id="kobo.33.1">Zabbix frontend</span><a id="_idTextAnchor1899" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1900" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.34.1">.</span></span></p>
<h2 id="_idParaDest-325" class="calibre7"><a id="_idTextAnchor1901" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.35.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.36.1">For this recipe, all we’ll need is the Zabbix setup running. </span><span class="kobospan" id="kobo.36.2">We’ll be using the frontend to generate the API token. </span><span class="kobospan" id="kobo.36.3">From here, we can use the API token in any of our integrations further on in </span><span><span class="kobospan" id="kobo.37.1">this chapter</span><a id="_idTextAnchor1902" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1903" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.38.1">.</span></span></p>
<h2 id="_idParaDest-326" class="calibre7"><a id="_idTextAnchor1904" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.39.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.40.1">First, let’s log in to the Zabbix frontend as a Super </span><span><span class="kobospan" id="kobo.41.1">admin user.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.42.1">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.43.1">Users</span></strong><span class="kobospan" id="kobo.44.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.45.1">User groups</span></strong><span class="kobospan" id="kobo.46.1"> and click the blue </span><strong class="bold"><span class="kobospan" id="kobo.47.1">Create user group</span></strong><span class="kobospan" id="kobo.48.1"> button in the </span><span><span class="kobospan" id="kobo.49.1">top-right corner.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.50.1">Here, we’ll create a new user group. </span><span class="kobospan" id="kobo.50.2">Fill in the </span><strong class="bold"><span class="kobospan" id="kobo.51.1">Group name</span></strong><span class="kobospan" id="kobo.52.1"> field as </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.53.1">API Users</span></strong></span><span><span class="kobospan" id="kobo.54.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.55.1">Switch to the </span><strong class="bold"><span class="kobospan" id="kobo.56.1">Host Permissions</span></strong><span class="kobospan" id="kobo.57.1"> tab and give your API user group permission to every host by clicking the </span><strong class="bold"><span class="kobospan" id="kobo.58.1">Select</span></strong><span class="kobospan" id="kobo.59.1"> button and selecting every </span><span><span class="kobospan" id="kobo.60.1">host group.</span></span><a id="_idTextAnchor1905" class="pcalibre calibre6 pcalibre1"/></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer590">
<span class="kobospan" id="kobo.61.1"><img alt="Figure 10.1 – Zabbix Users | User groups, creating user group host permissions, API Users" src="image/B19803_10_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.62.1">Figure 10.1 – Zabbix Users | User groups, creating user group host permissions, API Users</span></p>
<ol class="calibre16">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.63.1">Move on to</span><a id="_idIndexMarker800" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.64.1"> the </span><strong class="bold"><span class="kobospan" id="kobo.65.1">Template permissions</span></strong><span class="kobospan" id="kobo.66.1"> tab and</span><a id="_idIndexMarker801" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.67.1"> do the same </span><span><span class="kobospan" id="kobo.68.1">thing here.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer591">
<span class="kobospan" id="kobo.69.1"><img alt="Figure 10.2 – Zabbix Users | User groups, creating user group template permissions, API Users" src="image/B19803_10_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.70.1">Figure 10.2 – Zabbix Users | User groups, creating user group template permissions, API Users</span></p>
<ol class="calibre16">
<li value="6" class="calibre15"><span class="kobospan" id="kobo.71.1">Click the blue </span><strong class="bold"><span class="kobospan" id="kobo.72.1">Select</span></strong><span class="kobospan" id="kobo.73.1"> button</span><a id="_idIndexMarker802" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.74.1"> at the bottom of this popup</span><a id="_idIndexMarker803" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.75.1"> and click on </span><strong class="bold"><span class="kobospan" id="kobo.76.1">Read-write</span></strong><span class="kobospan" id="kobo.77.1"> followed by the small dotted </span><strong class="bold"><span class="kobospan" id="kobo.78.1">Add</span></strong><span class="kobospan" id="kobo.79.1"> button. </span><span class="kobospan" id="kobo.79.2">It should now look </span><span><span class="kobospan" id="kobo.80.1">like thi</span><a id="_idTextAnchor1906" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.81.1">s:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer592">
<span class="kobospan" id="kobo.82.1"><img alt="Figure 10.3 – Zabbix Users | User groups, user group permissions page, API Users" src="image/B19803_10_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.83.1">Figure 10.3 – Zabbix Users | User groups, user group permissions page, API Users</span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.84.1">Tip</span></p>
<p class="callout"><span class="kobospan" id="kobo.85.1">Instead of creating the API user as Super admin, we can also limit the permissions by limiting the host and template group access on the </span><strong class="bold"><span class="kobospan" id="kobo.86.1">API Users</span></strong><span class="kobospan" id="kobo.87.1"> user group. </span><span class="kobospan" id="kobo.87.2">This could be preferred in production environments, as you might want to limit API access. </span><span class="kobospan" id="kobo.87.3">Use whatever fits </span><span><span class="kobospan" id="kobo.88.1">your preference.</span></span></p>
<ol class="calibre16">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.89.1">Click the blue </span><strong class="bold"><span class="kobospan" id="kobo.90.1">Add</span></strong><span class="kobospan" id="kobo.91.1"> button at the bottom of the page to add this new </span><span><span class="kobospan" id="kobo.92.1">user group.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.93.1">Now, let’s go to </span><strong class="bold"><span class="kobospan" id="kobo.94.1">Users</span></strong><span class="kobospan" id="kobo.95.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.96.1">Users</span></strong><span class="kobospan" id="kobo.97.1"> and click the blue </span><strong class="bold"><span class="kobospan" id="kobo.98.1">Create user</span></strong><span class="kobospan" id="kobo.99.1"> button in the </span><span><span class="kobospan" id="kobo.100.1">top-right corner.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.101.1">Here we will create</span><a id="_idIndexMarker804" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.102.1"> a new user called</span><a id="_idIndexMarker805" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.103.1"> the </span><strong class="source-inline1"><span class="kobospan" id="kobo.104.1">API</span></strong><span class="kobospan" id="kobo.105.1"> user. </span><span class="kobospan" id="kobo.105.2">Create the user </span><span><span class="kobospan" id="kobo.106.1">as follo</span><a id="_idTextAnchor1907" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.107.1">ws:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer593">
<span class="kobospan" id="kobo.108.1"><img alt="Figure 10.4 – Zabbix Users | Users, user creation page, API user" src="image/B19803_10_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.109.1">Figure 10.4 – Zabbix Users | Users, user creation page, API user</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.110.1">Before adding the user, switch to the </span><strong class="bold"><span class="kobospan" id="kobo.111.1">Permissions</span></strong><span class="kobospan" id="kobo.112.1"> tab and add </span><strong class="bold"><span class="kobospan" id="kobo.113.1">Super </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.114.1">admin rol</span><a id="_idTextAnchor1908" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.115.1">e</span></strong></span><span><span class="kobospan" id="kobo.116.1">.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer594">
<span class="kobospan" id="kobo.117.1"><img alt="Figure 10.5 – Zabbix Users | Users, user permissions page, API user" src="image/B19803_10_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.118.1">Figure 10.5 – Zabbix Users | Users, user permissions page, API user</span></p>
<ol class="calibre16">
<li value="11" class="calibre15"><span class="kobospan" id="kobo.119.1">We can now add the user by clicking the blue </span><strong class="bold"><span class="kobospan" id="kobo.120.1">Add</span></strong><span class="kobospan" id="kobo.121.1"> button at the bottom of </span><span><span class="kobospan" id="kobo.122.1">the page.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.123.1">Next up, we need to create some API tokens for this user. </span><span class="kobospan" id="kobo.123.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.124.1">Users</span></strong><span class="kobospan" id="kobo.125.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.126.1">API tokens</span></strong></span><span><span class="kobospan" id="kobo.127.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.128.1">Let’s click the blue </span><strong class="bold"><span class="kobospan" id="kobo.129.1">Create API token</span></strong><span class="kobospan" id="kobo.130.1"> button</span><a id="_idIndexMarker806" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.131.1"> in the top-right corner </span><a id="_idIndexMarker807" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.132.1">and fill in the </span><strong class="bold"><span class="kobospan" id="kobo.133.1">User</span></strong><span class="kobospan" id="kobo.134.1"> field as </span><strong class="source-inline1"><span class="kobospan" id="kobo.135.1">API</span></strong><span class="kobospan" id="kobo.136.1"> and the </span><strong class="bold"><span class="kobospan" id="kobo.137.1">Name</span></strong><span class="kobospan" id="kobo.138.1"> field as </span><strong class="source-inline1"><span class="kobospan" id="kobo.139.1">API book key</span></strong><span class="kobospan" id="kobo.140.1">. </span><span class="kobospan" id="kobo.140.2">Set </span><strong class="bold"><span class="kobospan" id="kobo.141.1">Expires at</span></strong><span class="kobospan" id="kobo.142.1"> to somewhere far in the future or disable expiration entirely – whatever you think might be secure. </span><span class="kobospan" id="kobo.142.2">It will look </span><span><span class="kobospan" id="kobo.143.1">like th</span><a id="_idTextAnchor1909" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.144.1">is:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer595">
<span class="kobospan" id="kobo.145.1"><img alt="Figure 10.6 – Administration | General | API token, API token creation page" src="image/B19803_10_06.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.146.1">Figure 10.6 – Administration | General | API token, API token creation page</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.147.1">Click the blue </span><strong class="bold"><span class="kobospan" id="kobo.148.1">Add</span></strong><span class="kobospan" id="kobo.149.1"> button at the bottom of the page to generate the new API token. </span><span class="kobospan" id="kobo.149.2">This will bring us to the </span><span><span class="kobospan" id="kobo.150.1">next pag</span><a id="_idTextAnchor1910" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.151.1">e:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer596">
<span class="kobospan" id="kobo.152.1"><img alt="Figure 10.7 – Zabbix API user API token generated page" src="image/B19803_10_07.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.153.1">Figure 10.7 – Zabbix API user API token generated page</span></p>
<ol class="calibre16">
<li value="15" class="calibre15"><span class="kobospan" id="kobo.154.1">Make sure to save</span><a id="_idIndexMarker808" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.155.1"> the </span><strong class="bold"><span class="kobospan" id="kobo.156.1">Auth token</span></strong><span class="kobospan" id="kobo.157.1"> value to a secure location, such as a password</span><a id="_idIndexMarker809" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.158.1"> vault. </span><span class="kobospan" id="kobo.158.2">It will be important later in </span><span><span class="kobospan" id="kobo.159.1">the labs.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.160.1">We can click the </span><strong class="bold"><span class="kobospan" id="kobo.161.1">Close</span></strong><span class="kobospan" id="kobo.162.1"> button at the bottom of this page now. </span><span class="kobospan" id="kobo.162.2">This will bring us back to the </span><strong class="bold"><span class="kobospan" id="kobo.163.1">API tokens</span></strong><span class="kobospan" id="kobo.164.1"> page where we can manage all of our created </span><span><span class="kobospan" id="kobo.165.1">API toke</span><a id="_idTextAnchor1911" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.166.1">ns.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer597">
<span class="kobospan" id="kobo.167.1"><img alt="Figure 10.8 – Zabbix API user API tokens p﻿﻿age" src="image/B19803_10_08.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.168.1">Figure 10.8 – Zabbix API user API tokens p</span><a id="_idTextAnchor1912" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1913" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.169.1">age</span></p>
<h2 id="_idParaDest-327" class="calibre7"><a id="_idTextAnchor1914" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.170.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.171.1">Because Zabbix </span><a id="_idTextAnchor1915" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.172.1">now c</span><a id="_idTextAnchor1916" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.173.1">omes with built-in API token management, it has become a lot easier to work with the Zabbix API. </span><span class="kobospan" id="kobo.173.2">Using a dedicated API user, we can manage all of our tokens in a single location or we can set up private API tokens under our own </span><span><span class="kobospan" id="kobo.174.1">user account.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.175.1">In this case, we created a new API Users group. </span><span class="kobospan" id="kobo.175.2">This is important because our API tokens are still part of a user account meaning they will respect that user its permissions. </span><span class="kobospan" id="kobo.175.3">If we create an API user under any other user type than Super admin, we can restrict our API access using the </span><strong class="bold"><span class="kobospan" id="kobo.176.1">API </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.177.1">Users</span></strong></span><span><span class="kobospan" id="kobo.178.1"> group.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.179.1">Make sure that you apply the role to the user and the permissions to the user group as you see fit in your environment. </span><span class="kobospan" id="kobo.179.2">Also, make sure to set a reasonable expiration date for your API tokens so we can regenerate them from time </span><span><span class="kobospan" id="kobo.180.1">to time.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.181.1">There’s not much else</span><a id="_idIndexMarker810" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.182.1"> to say about setting</span><a id="_idIndexMarker811" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.183.1"> up and managing your API tokens, but let’s see how we can apply what we have learned in this recipe in the </span><span><span class="kobospan" id="kobo.184.1">next rec</span><a id="_idTextAnchor1917" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1918" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.185.1">ipes.</span></span></p>
<h1 id="_idParaDest-328" class="calibre5"><a id="_idTextAnchor1919" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.186.1">Using the Zabbix API for extending functionality</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.187.1">An API is</span><a id="_idTextAnchor1920" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.188.1"> your gateway to getting</span><a id="_idIndexMarker812" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.189.1"> started with extending the functionality</span><a id="_idIndexMarker813" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.190.1"> of any piece of software. </span><span class="kobospan" id="kobo.190.2">Luckily, Zabbix offers a solid working API that we can use to extend our functionality with ease. </span><span class="kobospan" id="kobo.190.3">Zabbix has also released </span><strong class="source-inline"><span class="kobospan" id="kobo.191.1">zabbix-utils</span></strong><span class="kobospan" id="kobo.192.1"> for Python, making building scripts a lot easier for everyone. </span><span class="kobospan" id="kobo.192.2">It’s an amazing addition, but as it’s not allowed in every environment and we want to keep the dependencies to a minimum, we won’t utilize it in our test here. </span><span class="kobospan" id="kobo.192.3">Nevertheless, check out the </span><span><span class="kobospan" id="kobo.193.1">library here:</span></span></p>
<p class="calibre3"><a href="https://github.com/zabbix/python-zabbix-utils" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.194.1">https://github.com/zabbix/python-zabbix-utils</span></span></a></p>
<p class="calibre3"><span class="kobospan" id="kobo.195.1">In this recipe, we’ll explore the use of the Zabbix API to do some tasks, creating a good basis to start working with the Zabbix API in your actual </span><span><span class="kobospan" id="kobo.196.1">production enviro</span><a id="_idTextAnchor1921" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1922" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.197.1">nments.</span></span></p>
<h2 id="_idParaDest-329" class="calibre7"><a id="_idTextAnchor1923" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.198.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.199.1">We are going to need a Zabbix server with some hosts. </span><span class="kobospan" id="kobo.199.2">I’ll be using our </span><strong class="source-inline"><span class="kobospan" id="kobo.200.1">lar-book-centos</span></strong><span class="kobospan" id="kobo.201.1"> host from the previous chapters, but feel free to use any Zabbix server. </span><span class="kobospan" id="kobo.201.2">I will also use another Linux host to do the API calls from, but this can be done from any </span><span><span class="kobospan" id="kobo.202.1">Linux host.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.203.1">We will need to install Python 3 on the Linux host, though, as we’ll be using this to create our </span><span><span class="kobospan" id="kobo.204.1">API calls.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.205.1">Also, make sure</span><a id="_idIndexMarker814" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.206.1"> you have an API</span><a id="_idIndexMarker815" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.207.1"> user with an API token. </span><span class="kobospan" id="kobo.207.2">It is recommended to use the one we created in the </span><span><span class="kobospan" id="kobo.208.1">firs</span><a id="_idTextAnchor1924" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1925" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.209.1">t recipe.</span></span></p>
<h2 id="_idParaDest-330" class="calibre7"><a id="_idTextAnchor1926" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.210.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.211.1">First, on our Linux CLI, let’s move to a </span><span><span class="kobospan" id="kobo.212.1">new directory:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.213.1">cd /home/zabbix/</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.214.1">Install Python 3 on the host with the </span><span><span class="kobospan" id="kobo.215.1">following command.</span></span><p class="calibre3"><span class="kobospan" id="kobo.216.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.217.1">this command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.218.1">dnf install python3</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.219.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.220.1">this command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.221.1">apt install python3</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.222.1">Python </span><strong class="source-inline1"><span class="kobospan" id="kobo.223.1">pip</span></strong><span class="kobospan" id="kobo.224.1"> should’ve been installed with this package by default as well. </span><span class="kobospan" id="kobo.224.2">If not, issue the </span><span><span class="kobospan" id="kobo.225.1">following command.</span></span><p class="calibre3"><span class="kobospan" id="kobo.226.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.227.1">this command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.228.1">dnf install python3-pip</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.229.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.230.1">this command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.231.1">apt install python3-pip</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="kobospan" id="kobo.232.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.233.1">It is possible to have an older version of Python(3) shipped with your Linux distribution. </span><span class="kobospan" id="kobo.233.2">If you run into any errors with the scripts later in the chapter, make sure to check for any error messages indicating that your Python version might not support </span><span><span class="kobospan" id="kobo.234.1">certain functionality.</span></span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.235.1">Now. </span><span class="kobospan" id="kobo.235.2">let’s install our dependencies using Python </span><strong class="source-inline1"><span class="kobospan" id="kobo.236.1">pip</span></strong><span class="kobospan" id="kobo.237.1">. </span><span class="kobospan" id="kobo.237.2">We’ll need these dependencies as they’ll be used in </span><span><span class="kobospan" id="kobo.238.1">the script:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.239.1">pip3 install requests</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.240.1">Download the start of our script from the Packt GitHub repo of this book by issuing the </span><a id="_idTextAnchor1927" class="pcalibre calibre6 pcalibre1"/><span><span class="kobospan" id="kobo.241.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.242.1">wget https://raw.githubusercontent.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/main/chapter10/api_test.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.243.1">If you can’t use </span><strong class="source-inline1"><span class="kobospan" id="kobo.244.1">wget</span></strong><span class="kobospan" id="kobo.245.1"> from your host, you can download the script at the following </span><span><span class="kobospan" id="kobo.246.1">URL: </span></span><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter10/api_test.py" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.247.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter10/api_test.py</span></span></a><span><span class="kobospan" id="kobo.248.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.249.1">Next up, we are going to edit</span><a id="_idIndexMarker816" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.250.1"> our newly downloaded script</span><a id="_idIndexMarker817" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.251.1"> by executing the </span><span><span class="kobospan" id="kobo.252.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.253.1">vim api_test.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.254.1">First, let’s change the IP address, </span><strong class="source-inline1"><span class="kobospan" id="kobo.255.1">10.16.16.152</span></strong><span class="kobospan" id="kobo.256.1">, in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.257.1">url</span></strong><span class="kobospan" id="kobo.258.1"> variable to the IP or DNS of your Zabbix server. </span><span class="kobospan" id="kobo.258.2">Then, make sure to edit the </span><strong class="source-inline1"><span class="kobospan" id="kobo.259.1">api_token</span></strong><span class="kobospan" id="kobo.260.1"> variable by replacing </span><strong class="source-inline1"><span class="kobospan" id="kobo.261.1">PUT_YOUR_TOKEN_HERE</span></strong><span class="kobospan" id="kobo.262.1"> with the API token we generated in the first recipe of </span><span><span class="kobospan" id="kobo.263.1">this chapter:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.264.1">url = "http://10.16.16.152/api_jsonrpc.php"</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.265.1">api_token = "c01ce8726bfdbce02664ec8750f99da 1bbbcb3cb295d924932e2f2808846273"</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.266.1">We will also add some lines of code to our script to retrieve our host ID, hostname, and the interfaces of all our Zabbix hosts. </span><span class="kobospan" id="kobo.266.2">Make sure to add your new code</span><a id="_idIndexMarker818" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.267.1"> between the comments</span><a id="_idIndexMarker819" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.268.1"> shown in the </span><span><span class="kobospan" id="kobo.269.1">following</span><a id="_idTextAnchor1928" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.270.1"> screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer598">
<span class="kobospan" id="kobo.271.1"><img alt="Figure 10.9 – Comments showing where to put c﻿ode" src="image/B19803_10_09.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.272.1">Figure 10.9 – Comments showing where to put c</span><a id="_idTextAnchor1929" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.273.1">ode</span></p>
<ol class="calibre16">
<li value="10" class="calibre15"><span class="kobospan" id="kobo.274.1">Now, add the following lines </span><span><span class="kobospan" id="kobo.275.1">of code:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.276.1">
#Function to retrieve the hosts and interfaces
def get_hosts(api_token, url):
    payload = {
    "jsonrpc": </span><strong class="bold1"><span class="kobospan1" id="kobo.277.1">"</span></strong><span class="kobospan1" id="kobo.278.1">2.0</span><strong class="bold1"><span class="kobospan1" id="kobo.279.1">"</span></strong><span class="kobospan1" id="kobo.280.1">,
    "method": </span><strong class="bold1"><span class="kobospan1" id="kobo.281.1">"</span></strong><span class="kobospan1" id="kobo.282.1">host.get</span><strong class="bold1"><span class="kobospan1" id="kobo.283.1">"</span></strong><span class="kobospan1" id="kobo.284.1">,
    "params": {
        "output": [
            "hostid",
            "host"
        ],
        "selectInterfaces": [
            "interfaceid",
            "ip",
            "main"
        ]
    },
    "id": 2,
    "auth": api_token
    }
    resp = requests.post(url=url, json=payload )
    out = resp.json()
    return out['result']</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.285.1">The</span><a id="_idTextAnchor1930" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.286.1">n, we’ll also add lines</span><a id="_idIndexMarker820" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.287.1"> to write the requested</span><a id="_idIndexMarker821" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.288.1"> information to a file so we can see what happens </span><span><span class="kobospan" id="kobo.289.1">after execution:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.290.1">
#Write the results to a file
def generate_host_file(hosts,host_file):
    hostname = None
    f = open(host_file, "w")
    #Write the host entries retrieved from Zabbix
    for host in hosts:
        hostname = host['host']
        for interface in host["interfaces"]:
            if interface["main"] == "1":
                f.write(hostname + " " + interface["ip"] + "\n")
    f.close()
    return</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.291.1">You should be able to execute this now by executing </span><span><span class="kobospan" id="kobo.292.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.293.1">python3 api_test.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.294.1">This should run but it won’t give you any output. </span><span class="kobospan" id="kobo.294.2">If this doesn’t work, make sure to retrace </span><span><span class="kobospan" id="kobo.295.1">your steps.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.296.1">Let’s check out the file to see what happened by executing </span><span><span class="kobospan" id="kobo.297.1">the following:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.298.1">cat /home/zabbix/resu</span><a id="_idTextAnchor1931" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.299.1">lts</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.300.1">The output of the preceding command should look somethi</span><a id="_idTextAnchor1932" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.301.1">ng </span><span><span class="kobospan" id="kobo.302.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer599">
<span class="kobospan" id="kobo.303.1"><img alt="Figure 10.10 – The cat command with our results showing in the file" src="image/B19803_10_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.304.1">Figure 10.10 – The cat command with our results showing in the file</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.305.1">We’ve now written</span><a id="_idIndexMarker822" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.306.1"> a short script in Python</span><a id="_idIndexMarker823" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.307.1"> to use </span><a id="_idTextAnchor1933" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1934" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.308.1">the </span><span><span class="kobospan" id="kobo.309.1">Zabbix API.</span></span></p>
<h2 id="_idParaDest-331" class="calibre7"><a id="_idTextAnchor1935" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.310.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.311.1">Coding with the Zabbix API can be done with Python, but it’s definitely not our only option. </span><span class="kobospan" id="kobo.311.2">We can use a wide variety of coding languages, including Perl, Go, C#, </span><span><span class="kobospan" id="kobo.312.1">and Java.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.313.1">In our example, though, we’ve used Python, so let’s see what we do here. </span><span class="kobospan" id="kobo.313.2">If we look at the script, we have two </span><span><span class="kobospan" id="kobo.314.1">main functions:</span></span></p>
<ul class="calibre14">
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.315.1">get_hosts</span></strong></span></li>
<li class="calibre15"><span><strong class="source-inline1"><span class="kobospan" id="kobo.316.1">generate_host_file</span></strong></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.317.1">First, we filled in our </span><strong class="source-inline"><span class="kobospan" id="kobo.318.1">api_token</span></strong><span class="kobospan" id="kobo.319.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.320.1">url</span></strong><span class="kobospan" id="kobo.321.1"> variables, which are used to authenticate against the Zabbix API. </span><span class="kobospan" id="kobo.321.2">We then used these to call on the </span><strong class="source-inline"><span class="kobospan" id="kobo.322.1">get_hosts</span></strong><span class="kobospan" id="kobo.323.1"> funct</span><a id="_idTextAnchor1936" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.324.1">ion to retrieve information from t</span><a id="_idTextAnchor1937" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.325.1">he </span><span><span class="kobospan" id="kobo.326.1">Zabbix API:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer600">
<span class="kobospan" id="kobo.327.1"><img alt="Figure 10.11 – Python function Zabbix API payload" src="image/B19803_10_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.328.1">Figure 10.11 – Python function Zabbix API payload</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.329.1">Looking at the code, we used</span><a id="_idIndexMarker824" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.330.1"> a JSON payload</span><a id="_idIndexMarker825" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.331.1"> to request information such as </span><strong class="source-inline"><span class="kobospan" id="kobo.332.1">host</span></strong><span class="kobospan" id="kobo.333.1"> for the hostname, </span><strong class="source-inline"><span class="kobospan" id="kobo.334.1">hostid</span></strong><span class="kobospan" id="kobo.335.1"> for the host ID, and </span><strong class="source-inline"><span class="kobospan" id="kobo.336.1">ip</span></strong><span class="kobospan" id="kobo.337.1"> for the interface’s </span><span><span class="kobospan" id="kobo.338.1">IP address.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.339.1">Now, if we look at our last function, </span><strong class="source-inline"><span class="kobospan" id="kobo.340.1">generate_host_file</span></strong><span class="kobospan" id="kobo.341.1">, we can see that we write the host with an interface IP to the </span><strong class="source-inline"><span class="kobospan" id="kobo.342.1">/home/results</span></strong><span class="kobospan" id="kobo.343.1"> file. </span><span class="kobospan" id="kobo.343.2">This way, we have a solid script for writing host information to </span><span><span class="kobospan" id="kobo.344.1">a file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.345.1">If you’re not familiar with Python or coding in general, working with the Zabbix API might be a big step to take. </span><span class="kobospan" id="kobo.345.2">Let’s take a look at how the API </span><a id="_idTextAnchor1938" class="pcalibre calibre6 pcalibre1"/><span><span class="kobospan" id="kobo.346.1">actually works:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer601">
<span class="kobospan" id="kobo.347.1"><img alt="Figure 10.12 – Python script Zabbix API functionality diagram" src="image/B19803_10_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.348.1">Figure 10.12 – Python script Zabbix API functionality diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.349.1">In </span><a id="_idTextAnchor1939" class="pcalibre calibre6 pcalibre1"/><em class="italic"><span class="kobospan" id="kobo.350.1">step 1</span></em><span class="kobospan" id="kobo.351.1">, we make an API call, using our target URL and API token as specified in our variables for authentication. </span><span class="kobospan" id="kobo.351.2">Next, in </span><em class="italic"><span class="kobospan" id="kobo.352.1">step 2</span></em><span class="kobospan" id="kobo.353.1">, we receive the data as requested in our Python function from Zabbix to further use in our </span><span><span class="kobospan" id="kobo.354.1">Python script.</span></span></p>
<p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.355.1">Step 3</span></em><span class="kobospan" id="kobo.356.1"> is our data processing step. </span><span class="kobospan" id="kobo.356.2">We can do anything we want with the data received from the Zabbix API, but in our case, we format the data and write it to a file. </span><span class="kobospan" id="kobo.356.3">That’s how we use the Zabbix API for extending functionality. </span><span class="kobospan" id="kobo.356.4">This is the step where our file</span><a id="_idIndexMarker826" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.357.1"> gets filled with hostnames</span><a id="_idIndexMarker827" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.358.1"> an</span><a id="_idTextAnchor1940" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1941" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.359.1">d </span><span><span class="kobospan" id="kobo.360.1">IP information.</span></span></p>
<h2 id="_idParaDest-332" class="calibre7"><a id="_idTextAnchor1942" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.361.1">See also</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.362.1">If you</span><a id="_idTextAnchor1943" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.363.1"> are interested in learning more about the Zabbix API and its available functionality, check</span><a id="_idIndexMarker828" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.364.1"> out the Zabbix documentation </span><span><span class="kobospan" id="kobo.365.1">at </span></span><a href="https://www.zabbix.com/documentation/current/en/manual/api" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.366.1">https://www.zabbix.com/documentation/current/en/manual/api</span></span></a><span><span class="kobospan" id="kobo.367.1">.</span></span></p>
<h1 id="_idParaDest-333" class="calibre5"><span class="kobospan" id="kobo.368.1">Building a jumphost using the Zabbix API a</span><a id="_idTextAnchor1944" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.369.1">nd Python</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.370.1">A lo</span><a id="_idTextAnchor1945" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.371.1">t of</span><a id="_idTextAnchor1946" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.372.1"> organizations</span><a id="_idIndexMarker829" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.373.1"> have a</span><a id="_idTextAnchor1947" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.374.1"> jumphost (sometimes</span><a id="_idIndexMarker830" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.375.1"> referred to as a bastion host) to access</span><a id="_idIndexMarker831" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.376.1"> servers, switches, and their</span><a id="_idIndexMarker832" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.377.1"> other equipment</span><a id="_idIndexMarker833" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.378.1"> from a host. </span><span class="kobospan" id="kobo.378.2">A jumphost generally has all the firewall rules needed to access everything important. </span><span class="kobospan" id="kobo.378.3">Now, if we keep our monitoring up to date, we should have every single host in there </span><span><span class="kobospan" id="kobo.379.1">as well.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.380.1">My friend, ex-colleague, and fellow Zabbix geek, </span><em class="italic"><span class="kobospan" id="kobo.381.1">Yadvir Singh</span></em><span class="kobospan" id="kobo.382.1">, had the amazing idea to create a Python script to export all Zabbix hosts with their IPs to the </span><strong class="source-inline"><span class="kobospan" id="kobo.383.1">/etc/hosts</span></strong><span class="kobospan" id="kobo.384.1"> file on another Linux host. </span><span class="kobospan" id="kobo.384.2">Let’s see how we can build a </span><a id="_idTextAnchor1948" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1949" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.385.1">jumphost just </span><span><span class="kobospan" id="kobo.386.1">like his.</span></span></p>
<h2 id="_idParaDest-334" class="calibre7"><a id="_idTextAnchor1950" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.387.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.388.1">We are going to need a new host</span><a id="_idIndexMarker834" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.389.1"> for this recipe with Linux installed</span><a id="_idIndexMarker835" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.390.1"> and ready. </span><span class="kobospan" id="kobo.390.2">We’ll call</span><a id="_idIndexMarker836" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.391.1"> this host </span><strong class="source-inline"><span class="kobospan" id="kobo.392.1">lar-book-jump</span></strong><span class="kobospan" id="kobo.393.1">. </span><span class="kobospan" id="kobo.393.2">We will also need</span><a id="_idIndexMarker837" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.394.1"> our Zabbix server, for which I’ll </span><span><span class="kobospan" id="kobo.395.1">use </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.396.1">lar-book-centos</span></strong></span><span><span class="kobospan" id="kobo.397.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.398.1">Also, it is important to navigate to </span><em class="italic"><span class="kobospan" id="kobo.399.1">Yadvir’s</span></em><span class="kobospan" id="kobo.400.1"> GitHub account, drop him a follow, and star his repository if you think this is a cool </span><span><span class="kobospan" id="kobo.401.1">script: </span></span><a href="https://github.com/cheatas/zabbix_scripts" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.402.1">https://github.com/cheatas/zabbix_scripts</span></span></a><span><span class="kobospan" id="kobo.403.1">.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.404.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.405.1">Setting up this script will override your </span><strong class="source-inline1"><span class="kobospan" id="kobo.406.1">/etc/hosts</span></strong><span class="kobospan" id="kobo.407.1"> file every time the script is executed. </span><span class="kobospan" id="kobo.407.2">Only use this script when you understand what it’s doing, make sure you use an empty host for this lab, and check the d</span><a id="_idTextAnchor1951" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1952" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.408.1">efault </span><strong class="source-inline1"><span class="kobospan" id="kobo.409.1">/</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.410.1">etc/hosts</span></strong></span><span><span class="kobospan" id="kobo.411.1"> settings.</span></span></p>
<h2 id="_idParaDest-335" class="calibre7"><a id="_idTextAnchor1953" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.412.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.413.1">If you haven’t already created an API user with an API token, make sure to check out the first recipe of this </span><span><span class="kobospan" id="kobo.414.1">chapter first.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.415.1">Install Python 3 on the host CLI with the </span><span><span class="kobospan" id="kobo.416.1">following command.</span></span><p class="calibre3"><span class="kobospan" id="kobo.417.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.418.1">this command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.419.1">dnf install python3</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.420.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.421.1">this command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.422.1">apt-get install python3</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.423.1">Python </span><strong class="source-inline1"><span class="kobospan" id="kobo.424.1">pip</span></strong><span class="kobospan" id="kobo.425.1"> should’ve been installed with this package by default as well. </span><span class="kobospan" id="kobo.425.2">If not, issue the </span><span><span class="kobospan" id="kobo.426.1">following command</span></span><p class="calibre3"><span class="kobospan" id="kobo.427.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.428.1">this command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.429.1">dnf install python3-pip</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.430.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.431.1">this command:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.432.1">apt-g</span><a id="_idTextAnchor1954" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.433.1">et ins</span><a id="_idTextAnchor1955" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.434.1">tall pyt</span><a id="_idTextAnchor1956" class="pcalibre calibre18 pcalibre1"/><span class="kobospan1" id="kobo.435.1">hon3-pip</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.436.1">Now, le</span><a id="_idTextAnchor1957" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.437.1">t’s install our dependencies using Python </span><strong class="source-inline1"><span class="kobospan" id="kobo.438.1">pip</span></strong><span class="kobospan" id="kobo.439.1">. </span><span class="kobospan" id="kobo.439.2">We’ll need these dependencies as they’ll be used in </span><span><span class="kobospan" id="kobo.440.1">the script:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.441.1">pip3 install requests</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.442.1">First things first, log in to our new Linux</span><a id="_idIndexMarker838" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.443.1"> host, </span><strong class="source-inline1"><span class="kobospan" id="kobo.444.1">lar-book-jump</span></strong><span class="kobospan" id="kobo.445.1">, and download</span><a id="_idIndexMarker839" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.446.1"> Yadvir’s script to your Linux</span><a id="_idIndexMarker840" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.447.1"> host with the </span><span><span class="kobospan" id="kobo.448.1">following</span></span><span><a id="_idIndexMarker841" class="pcalibre calibre6 pcalibre1"/></span><span><span class="kobospan" id="kobo.449.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.450.1">wget</span></strong> <strong class="bold1"><span class="kobospan1" id="kobo.451.1">https://raw.githubusercontent.com/cheatas/zabbix_scripts/main/host_pull_zabbix.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.452.1">If you can’t use </span><strong class="source-inline1"><span class="kobospan" id="kobo.453.1">wget</span></strong><span class="kobospan" id="kobo.454.1"> from your host, you can download the script at the following </span><span><span class="kobospan" id="kobo.455.1">URL: </span></span><a href="https://github.com/cheatas/zabbix_scripts/blob/main/host_pull_zabbix.py" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.456.1">https://github.com/cheatas/zabbix_scripts/blob/main/host_pull_zabbix.py</span></span></a><span><span class="kobospan" id="kobo.457.1">.</span></span><p class="calibre3"><span class="kobospan" id="kobo.458.1">As a backup, we also provide this script in the Packt repository. </span><span class="kobospan" id="kobo.458.2">You may download this version </span><span><span class="kobospan" id="kobo.459.1">at </span></span><a href="https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter10/host_pull_zabbix.py" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.460.1">https://github.com/PacktPublishing/Zabbix-7-IT-Infrastructure-Monitoring-Cookbook/tree/main/chapter10/host_pull_zabbix.py</span></span></a><span><span class="kobospan" id="kobo.461.1">.</span></span></p></li>
<li class="calibre15"><span class="kobospan" id="kobo.462.1">Now, let’s edit the script by executing the </span><span><span class="kobospan" id="kobo.463.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.464.1">vim host_pull_zabbix.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.465.1">First, let’s edit the </span><strong class="source-inline1"><span class="kobospan" id="kobo.466.1">zabbix_url</span></strong><span class="kobospan" id="kobo.467.1"> variable by replacing </span><a href="https://myzabbix.com/api_jsonrpc.php" class="pcalibre calibre6 pcalibre1"><span class="kobospan" id="kobo.468.1">https://myzabbix.com/api_jsonrpc.php</span></a><span class="kobospan" id="kobo.469.1"> with the IP address or DNS name of our </span><span><span class="kobospan" id="kobo.470.1">Zabbix frontend:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.471.1">zabbix_url = "http://10.16.16.152/api_jsonrpc.php"</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.472.1">We do not need to fill out our username and password as that was only required on older Zabbix versions. </span><span class="kobospan" id="kobo.472.2">Instead, we will </span><a id="_idTextAnchor1958" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.473.1">nee</span><a id="_idTextAnchor1959" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.474.1">d a</span><a id="_idTextAnchor1960" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.475.1">n API token, as genera</span><a id="_idTextAnchor1961" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.476.1">ted in the first recipe in this chapter. </span><span class="kobospan" id="kobo.476.2">Fill in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.477.1">api_token</span></strong><span class="kobospan" id="kobo.478.1"> variable in the script </span><span><span class="kobospan" id="kobo.479.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.480.1">api_token = "c01ce8726bfdbce02664ec8750f99da1bbbcb3cb295</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.481.1">d924932e2f2808846273"</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.482.1">You can find this variable at the bottom of </span><span><span class="kobospan" id="kobo.483.1">the file.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.484.1">We also need to uncomment the </span><span><span class="kobospan" id="kobo.485.1">following lines:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.486.1">zabbix_hosts = get_hosts(api_token,zabbix_url)</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.487.1">generate_host_file(zabbix_hosts,"/etc/hosts")</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.488.1">The end of the scr</span><a id="_idTextAnchor1962" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.489.1">ipt should now look </span><span><span class="kobospan" id="kobo.490.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer602">
<span class="kobospan" id="kobo.491.1"><img alt="Figure 10.13 – End of the script after receiving the API token and with commenting removed" src="image/B19803_10_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.492.1">Figure 10.13 – End of the script after receiving the API token and with commenting removed</span></p>
<ol class="calibre16">
<li value="12" class="calibre15"><span class="kobospan" id="kobo.493.1">Last but not least, make sure</span><a id="_idIndexMarker842" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.494.1"> to comment</span><a id="_idIndexMarker843" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.495.1"> and uncomment</span><a id="_idIndexMarker844" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.496.1"> the right lines</span><a id="_idIndexMarker845" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.497.1"> for your Linux distro. </span><span class="kobospan" id="kobo.497.2">It will look like the </span><span><span class="kobospan" id="kobo.498.1">following figures.</span></span><p class="calibre3"><span class="kobospan" id="kobo.499.1">Fo</span><a id="_idTextAnchor1963" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.500.1">r Ubuntu, it will look </span><span><span class="kobospan" id="kobo.501.1">like this:</span></span></p></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer603">
<span class="kobospan" id="kobo.502.1"><img alt="Figure 10.14 – Print to file for Ubuntu systems" src="image/B19803_10_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.503.1">Figure 10.14 – Print to file for Ubuntu systems</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.504.1">For RHEL-based </span><a id="_idTextAnchor1964" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.505.1">systems, it will look </span><span><span class="kobospan" id="kobo.506.1">like this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer604">
<span class="kobospan" id="kobo.507.1"><img alt="Figure 10.15 – Print to fi﻿le f﻿or RHE﻿L-base﻿d systems" src="image/B19803_10_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.508.1">Figure 10.15 – Print to fi</span><a id="_idTextAnchor1965" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.509.1">le f</span><a id="_idTextAnchor1966" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.510.1">or RHE</span><a id="_idTextAnchor1967" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.511.1">L-base</span><a id="_idTextAnchor1968" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.512.1">d systems</span></p>
<ol class="calibre16">
<li value="13" class="calibre15"><span class="kobospan" id="kobo.513.1">That’s all there is to do, so we can now execute</span><a id="_idIndexMarker846" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.514.1"> the script again and start</span><a id="_idIndexMarker847" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.515.1"> using it. </span><span class="kobospan" id="kobo.515.2">Let’s execute</span><a id="_idIndexMarker848" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.516.1"> the script</span><a id="_idIndexMarker849" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.517.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.518.1">python3 host_pull_zabbix.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.519.1">Test whether it worked by looking at the host file with the </span><span><span class="kobospan" id="kobo.520.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.521.1">cat /etc/hosts</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.522.1">This should give us an output like that</span><a id="_idTextAnchor1969" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.523.1"> shown in the </span><span><span class="kobospan" id="kobo.524.1">following screenshot:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer605">
<span class="kobospan" id="kobo.525.1"><img alt="Figure 10.16 – /etc/hosts filled with our script information" src="image/B19803_10_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.526.1">Figure 10.16 – /etc/hosts filled with our script information</span></p>
<ol class="calibre16">
<li value="15" class="calibre15"><span class="kobospan" id="kobo.527.1">We can now try to SSH directly</span><a id="_idIndexMarker850" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.528.1"> to the name of a host,</span><a id="_idTextAnchor1970" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.529.1"> instead</span><a id="_idTextAnchor1971" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.530.1"> of</span><a id="_idTextAnchor1972" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.531.1"> having to</span><a id="_idTextAnchor1973" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.532.1"> use</span><a id="_idIndexMarker851" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.533.1"> the IP, by issuing</span><a id="_idIndexMarker852" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.534.1"> the </span><span><span class="kobospan" id="kobo.535.1">following</span></span><span><a id="_idIndexMarker853" class="pcalibre calibre6 pcalibre1"/></span><span><span class="kobospan" id="kobo.536.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.537.1">ssh lar-book-agent_passive</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.538.1">We can also use it to find hosts from the file with the </span><span><span class="kobospan" id="kobo.539.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.540.1">cat /etc/hosts | grep agent</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.541.1">Let’s do one more thing. </span><span class="kobospan" id="kobo.541.2">We want this script to be as up to date as possible. </span><span class="kobospan" id="kobo.541.3">So, let’s add a cronjob. </span><span class="kobospan" id="kobo.541.4">Issue the following command to add </span><span><span class="kobospan" id="kobo.542.1">a cronjob:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.543.1">crontab -e</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.544.1">Then add the following line, making sure to fill in the right script location for </span><span><span class="kobospan" id="kobo.545.1">your setup:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.546.1">*/15 * * * * $(which python3) /home/host_pull_zabbix.py &gt;&gt; ~/cron.log 2&gt;&amp;1</span></strong></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.547.1">That’s it – we will now have an up-to-date </span><strong class="source-inline"><span class="kobospan" id="kobo.548.1">/etc/hosts</span></strong><span class="kobospan" id="kobo.549.1"> file all the time</span><a id="_idTextAnchor1974" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1975" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.550.1"> with our new Python script </span><span><span class="kobospan" id="kobo.551.1">and Zabbix.</span></span></p>
<h2 id="_idParaDest-336" class="calibre7"><a id="_idTextAnchor1976" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.552.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.553.1">If your organization uses Zabbix as the main monitoring system, you now have the skills and knowledge to create an organized, reliably up-to-date, and </span><span><span class="kobospan" id="kobo.554.1">easy-to-use jumphost.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.555.1">Jumphosts are super useful when set up correctly, but it’s important to keep them clean so that they are easy </span><span><span class="kobospan" id="kobo.556.1">to update.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.557.1">By using this script, we only add Python 3 and a simple script as a requirement to the server, but the end result is a jumphost that knows about</span><a id="_idTextAnchor1977" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.558.1"> all hosts</span><a id="_idTextAnchor1978" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.559.1"> in </span><span><span class="kobospan" id="kobo.560.1">th</span><a id="_idTextAnchor1979" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.561.1">e en</span><a id="_idTextAnchor1980" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.562.1">vironment.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.563.1">If you’ve followed along with the previous </span><em class="italic"><span class="kobospan" id="kobo.564.1">Using the Zabbix API for extending functionality</span></em><span class="kobospan" id="kobo.565.1"> recipe, then you might notice that it works in roughly the same way. </span><span class="kobospan" id="kobo.565.2">We can see in the follow</span><a id="_idTextAnchor1981" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.566.1">ing diagram how we utilize </span><span><span class="kobospan" id="kobo.567.1">the script:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer606">
<span class="kobospan" id="kobo.568.1"><img alt="Figure 10.17 – Jumphost using script functionality diagram" src="image/B19803_10_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.569.1">Figure 10.17 – Jumphost using script functionality diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.570.1">After editing, our script will start at </span><em class="italic"><span class="kobospan" id="kobo.571.1">step 1</span></em><span class="kobospan" id="kobo.572.1"> of the diagram to request data with an API call, where we use the API token to authenticate. </span><span class="kobospan" id="kobo.572.2">We receive this data in </span><em class="italic"><span class="kobospan" id="kobo.573.1">step 2</span></em><span class="kobospan" id="kobo.574.1">. </span><span class="kobospan" id="kobo.574.2">In the script, we add our default values and then write all the hostnames and IP addresses to the </span><strong class="source-inline"><span class="kobospan" id="kobo.575.1">/</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.576.1">etc/hosts</span></strong></span><span><span class="kobospan" id="kobo.577.1"> file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.578.1">Now, because a Linux host uses the </span><strong class="source-inline"><span class="kobospan" id="kobo.579.1">/etc/hosts</span></strong><span class="kobospan" id="kobo.580.1"> file for hostname-to-IP translation, we can use the real names of servers in Zabbix</span><a id="_idIndexMarker854" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.581.1"> to SSH to the hosts. </span><span class="kobospan" id="kobo.581.2">This makes it easier for us to use the jumphost, as we</span><a id="_idIndexMarker855" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.582.1"> can use the same name</span><a id="_idIndexMarker856" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.583.1"> as the h</span><a id="_idTextAnchor1982" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1983" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.584.1">ostname we know from the </span><span><span class="kobospan" id="kobo.585.1">Zabbix</span></span><span><a id="_idIndexMarker857" class="pcalibre calibre6 pcalibre1"/></span><span><span class="kobospan" id="kobo.586.1"> frontend.</span></span></p>
<h2 id="_idParaDest-337" class="calibre7"><a id="_idTextAnchor1984" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.587.1">See also</span></h2>
<p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.588.1">Yadvir</span></em><span class="kobospan" id="kobo.589.1"> will keep updating the script after writing this recipe (we’ve been using version 1.0 so far). </span><span class="kobospan" id="kobo.589.2">Make sure to follow his GitHub account and star his repository to get the updates. </span><span class="kobospan" id="kobo.589.3">Also, if you have some cool ideas for additions, you can always open a </span><span><span class="kobospan" id="kobo.590.1">pull request.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.591.1">The Zabbix community is all about sharing cool ideas and useful scripts like this one. </span><span class="kobospan" id="kobo.591.2">As </span><em class="italic"><span class="kobospan" id="kobo.592.1">Yadvir</span></em><span class="kobospan" id="kobo.593.1"> has shown, we can get very valuable stuff from each other. </span><span class="kobospan" id="kobo.593.2">Be like </span><em class="italic"><span class="kobospan" id="kobo.594.1">Yadvir</span></em><span class="kobospan" id="kobo.595.1"> – use the Zabbix community GitHub and support other Zabbix users by adding to their GitHub repositories. </span><span class="kobospan" id="kobo.595.2">You can find the Zabbix community GitHub using the </span><span><span class="kobospan" id="kobo.596.1">link here:</span></span></p>
<p class="calibre3"><a href="https://github.com/zabbix/community-templates" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.597.1">htt</span><span id="_idTextAnchor1985"/><span id="_idTextAnchor1986"/><span id="_idTextAnchor1987"/><span id="_idTextAnchor1988"/><span id="_idTextAnchor1989"/><span id="_idTextAnchor1990"/><span id="_idTextAnchor1991"/><span id="_idTextAnchor1992"/><span id="_idTextAnchor1993"/><span class="kobospan" id="kobo.598.1">ps://github.com/zabbix/community-templates</span></span></a></p>
<h1 id="_idParaDest-338" class="calibre5"><span class="kobospan" id="kobo.599.1">Enabling a</span><a id="_idTextAnchor1994" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.600.1">nd disabling a host from Zabbix ma</span><a id="_idTextAnchor1995" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.601.1">ps</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.602.1">We’ve noticed that it is not possible to enable</span><a id="_idIndexMarker858" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.603.1"> and disable hosts</span><a id="_idIndexMarker859" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.604.1"> as a Zabbix user. </span><span class="kobospan" id="kobo.604.2">For some companies, this may be a requirement, so we’ve created an extension for it. </span><span class="kobospan" id="kobo.604.3">In this recipe, I will show you just how to work with t</span><a id="_idTextAnchor1996" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor1997" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.605.1">his Python script and execute it from </span><span><span class="kobospan" id="kobo.606.1">a map.</span></span></p>
<h2 id="_idParaDest-339" class="calibre7"><a id="_idTextAnchor1998" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.607.1">Getting ready</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.608.1">For this recipe, all we are going to need is our Zabbix server, some knowledge of P</span><a id="_idTextAnchor1999" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2000" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.609.1">ython, and some knowledge of the </span><span><span class="kobospan" id="kobo.610.1">Zabbix API.</span></span></p>
<h2 id="_idParaDest-340" class="calibre7"><a id="_idTextAnchor2001" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.611.1">How to do it…</span></h2>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.612.1">First, let’s log in to our Zabbix server CLI and create a </span><span><span class="kobospan" id="kobo.613.1">new directory:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.614.1">mkdir /etc/zabbix/frontendscripts</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.615.1">Change to the </span><span><span class="kobospan" id="kobo.616.1">new directory:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.617.1">cd /etc/zabbix/frontendscripts</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.618.1">Now, download the public script from the </span><em class="italic"><span class="kobospan" id="kobo.619.1">Opensource ICT </span></em><span><em class="italic"><span class="kobospan" id="kobo.620.1">Solutions</span></em></span><span><span class="kobospan" id="kobo.621.1"> GitHub:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.622.1">wget https://github.com/OpensourceICTSolutions/zabbix-toggle-hosts-from-frontend/archive/v2.0.tar.gz</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.623.1">If you can’t use </span><strong class="source-inline1"><span class="kobospan" id="kobo.624.1">wget</span></strong><span class="kobospan" id="kobo.625.1"> from your host, you can check out the script </span><span><span class="kobospan" id="kobo.626.1">here: </span></span><a href="https://github.com/OpensourceICTSolutions/zabbix-toggle-hosts-from-frontend/releases/tag/v2.0" class="pcalibre calibre6 pcalibre1"><span><span class="kobospan" id="kobo.627.1">https://github.com/OpensourceICTSolutions/zabbix-toggle-hosts-from-frontend/releases/tag/v2.0</span></span></a><span><span class="kobospan" id="kobo.628.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.629.1">Unzip the file</span><a id="_idIndexMarker860" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.630.1"> with the </span><span><span class="kobospan" id="kobo.631.1">following</span></span><span><a id="_idIndexMarker861" class="pcalibre calibre6 pcalibre1"/></span><span><span class="kobospan" id="kobo.632.1"> command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.633.1">tar -xvzf v2.0.tar.gz</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.634.1">Remove the </span><strong class="source-inline1"><span class="kobospan" id="kobo.635.1">tar</span></strong><span class="kobospan" id="kobo.636.1"> file using the </span><span><span class="kobospan" id="kobo.637.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.638.1">rm v2.0.tar.gz</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.639.1">Move the script over from the newly created folder with the </span><span><span class="kobospan" id="kobo.640.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.641.1">mv zabbix-toggle-hosts-from-frontend-2.0/enable_disable-host.py ./</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.642.1">We are going to need Python to use this script, so let’s install it </span><span><span class="kobospan" id="kobo.643.1">as follows.</span></span><p class="calibre3"><span class="kobospan" id="kobo.644.1">For RHEL-based systems, use </span><span><span class="kobospan" id="kobo.645.1">this command:</span></span></p><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.646.1">dnf install python3 python3-pip</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.647.1">For Ubuntu systems, use </span><span><span class="kobospan" id="kobo.648.1">this c</span><a id="_idTextAnchor2002" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.649.1">omman</span><a id="_idTextAnchor2003" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.650.1">d:</span></span></p><pre class="source-code"><strong class="bold1"><span class="kobospan1" id="kobo.651.1">apt-get install python3 python3-pip</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.652.1">We will also need the </span><strong class="source-inline1"><span class="kobospan" id="kobo.653.1">requests</span></strong><span class="kobospan" id="kobo.654.1"> module from </span><strong class="source-inline1"><span class="kobospan" id="kobo.655.1">pip</span></strong><span class="kobospan" id="kobo.656.1">. </span><span class="kobospan" id="kobo.656.2">Install it </span><span><span class="kobospan" id="kobo.657.1">as follows:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.658.1">pip3 install requests</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.659.1">Now, let’s edit the script with the </span><span><span class="kobospan" id="kobo.660.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.661.1">vim enable_disable-host.py</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.662.1">In this file, we will change the </span><strong class="source-inline1"><span class="kobospan" id="kobo.663.1">url</span></strong><span class="kobospan" id="kobo.664.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.665.1">token</span></strong><span class="kobospan" id="kobo.666.1"> variables. </span><span class="kobospan" id="kobo.666.2">Change the </span><strong class="source-inline1"><span class="kobospan" id="kobo.667.1">url</span></strong><span class="kobospan" id="kobo.668.1"> variable to match your own Zabbix frontend IP or DNS name. </span><span class="kobospan" id="kobo.668.2">Then, replace </span><strong class="source-inline1"><span class="kobospan" id="kobo.669.1">PUT_YOUR_TOKEN_HERE</span></strong><span class="kobospan" id="kobo.670.1"> with your Zabbix API token. </span><span class="kobospan" id="kobo.670.2">I will fill in the following, but be sure to enter your </span><span><span class="kobospan" id="kobo.671.1">own information:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.672.1">url = 'http://10.16.16.152/api_jsonrpc.php?'</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.673.1">token = "</span></strong> <strong class="bold1"><span class="kobospan1" id="kobo.674.1">c01ce8726bfdbce02664ec8750f99da1bbbcb3cb295d</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.675.1">924932e2f2808846273 "</span></strong></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.676.1">Now, we can move</span><a id="_idIndexMarker862" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.677.1"> on to our Zabbix</span><a id="_idIndexMarker863" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.678.1"> frontend to add a frontend script. </span><span class="kobospan" id="kobo.678.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.679.1">Alerts</span></strong><span class="kobospan" id="kobo.680.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.681.1">Scripts</span></strong><span class="kobospan" id="kobo.682.1">, then click the blue </span><strong class="bold"><span class="kobospan" id="kobo.683.1">Create script</span></strong><span class="kobospan" id="kobo.684.1"> but</span><a id="_idTextAnchor2004" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.685.1">ton at the </span><span><span class="kobospan" id="kobo.686.1">top right.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.687.1">Add the </span><span><span class="kobospan" id="kobo.688.1">following script:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer607">
<span class="kobospan" id="kobo.689.1"><img alt="Figure 10.18 – Zabbix Alerts﻿ | ﻿Scripts, the Create script page, Enable" src="image/B19803_10_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.690.1">Figure 10.18 – Zabbix Alerts</span><a id="_idTextAnchor2005" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.691.1"> | </span><a id="_idTextAnchor2006" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.692.1">Scripts, the Create script page, Enable</span></p>
<ol class="calibre16">
<li value="14" class="calibre15"><span class="kobospan" id="kobo.693.1">Click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.694.1">Add</span></strong><span class="kobospan" id="kobo.695.1"> button and then, on the next page, click the blue </span><strong class="bold"><span class="kobospan" id="kobo.696.1">Create script</span></strong><span class="kobospan" id="kobo.697.1"> button in the top-right </span><span><span class="kobospan" id="kobo.698.1">corner again.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.699.1">No</span><a id="_idTextAnchor2007" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.700.1">w, add the second</span><a id="_idIndexMarker864" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.701.1"> and final script</span><a id="_idIndexMarker865" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.702.1">as follows:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer608">
<span class="kobospan" id="kobo.703.1"><img alt="Figure 10.19 – Zabbix Alerts﻿ | Scrip﻿ts, the Create script page, Disable" src="image/B19803_10_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.704.1">Figure 10.19 – Zabbix Alerts</span><a id="_idTextAnchor2008" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.705.1"> | Scrip</span><a id="_idTextAnchor2009" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.706.1">ts, the Create script page, Disable</span></p>
<ol class="calibre16">
<li value="16" class="calibre15"><span class="kobospan" id="kobo.707.1">Now, navigate to </span><strong class="bold"><span class="kobospan" id="kobo.708.1">Monitoring</span></strong><span class="kobospan" id="kobo.709.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.710.1">Maps</span></strong><span class="kobospan" id="kobo.711.1">, and you should see a map called </span><strong class="bold"><span class="kobospan" id="kobo.712.1">Local network</span></strong><span class="kobospan" id="kobo.713.1"> here, as it’s included with Zabbix by default. </span><span class="kobospan" id="kobo.713.2">Click this map (or any other map with hosts </span><span><span class="kobospan" id="kobo.714.1">in it).</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.715.1">Now, if you click on a host on th</span><a id="_idTextAnchor2010" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.716.1">e map, you will see a drop-down menu </span><span><span class="kobospan" id="kobo.717.1">like this:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer609">
<span class="kobospan" id="kobo.718.1"><img alt="Figure 10.20 – Zabbix Monitoring | M﻿aps, ﻿the Local network map drop-down menu" src="image/B19803_10_20.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.719.1">Figure 10.20 – Zabbix Monitoring | M</span><a id="_idTextAnchor2011" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.720.1">aps, </span><a id="_idTextAnchor2012" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.721.1">the Local network map drop-down menu</span></p>
<ol class="calibre16">
<li value="18" class="calibre15"><span class="kobospan" id="kobo.722.1">If we click on </span><strong class="bold"><span class="kobospan" id="kobo.723.1">Disable</span></strong> <a id="_idTextAnchor2013" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.724.1">here, we will get</span><a id="_idIndexMarker866" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.725.1"> a pop-up message</span><a id="_idIndexMarker867" class="pcalibre calibre6 pcalibre1"/> <span><span class="kobospan" id="kobo.726.1">as follows:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer610">
<span class="kobospan" id="kobo.727.1"><img alt="Figure 10.21 – Zabbix script confirmation window" src="image/B19803_10_21.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.728.1">Figure 10.21 – Zabbix script confirmation window</span></p>
<ol class="calibre16">
<li value="19" class="calibre15"><span class="kobospan" id="kobo.729.1">Click on the blue </span><strong class="bold"><span class="kobospan" id="kobo.730.1">Execute</span></strong><span class="kobospan" id="kobo.731.1"> button and this host will be disabled. </span><span class="kobospan" id="kobo.731.2">Navigate to </span><strong class="bold"><span class="kobospan" id="kobo.732.1">Monitoring</span></strong><span class="kobospan" id="kobo.733.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.734.1">Hosts</span></strong><span class="kobospan" id="kobo.735.1"> to confirm whether this worked. </span><span class="kobospan" id="kobo.735.2">You should see that the host is set </span><span><span class="kobospan" id="kobo.736.1">to </span></span><span><strong class="bold"><span class="kobospan" id="kobo.737.1">Disabled</span></strong></span><span><span class="kobospan" id="kobo.738.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.739.1">Back at </span><strong class="bold"><span class="kobospan" id="kobo.740.1">Monitoring</span></strong><span class="kobospan" id="kobo.741.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.742.1">Maps</span></strong><span class="kobospan" id="kobo.743.1">, you can enable the host again with th</span><a id="_idTextAnchor2014" class="pcalibre calibre6 pcalibre1"/><a id="_idTextAnchor2015" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.744.1">e same drop-down menu. </span><span class="kobospan" id="kobo.744.2">This time, </span><span><span class="kobospan" id="kobo.745.1">select </span></span><span><strong class="bold"><span class="kobospan" id="kobo.746.1">Enable</span></strong></span><span><span class="kobospan" id="kobo.747.1">.</span></span></li>
</ol>
<h2 id="_idParaDest-341" class="calibre7"><a id="_idTextAnchor2016" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.748.1">How it works…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.749.1">The script we just used was built in Python utilizing the Zabbix API. </span><span class="kobospan" id="kobo.749.2">With this script, we can now enable and disable hosts from the Zabbix frontend as a </span><span><span class="kobospan" id="kobo.750.1">Zabbix user.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.751.1">This works because the </span><strong class="bold"><span class="kobospan" id="kobo.752.1">Monitoring</span></strong><span class="kobospan" id="kobo.753.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.754.1">Maps</span></strong><span class="kobospan" id="kobo.755.1"> option is available even to Zabbix users. </span><span class="kobospan" id="kobo.755.2">This script uses the API user for execution,</span><a id="_idTextAnchor2017" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.756.1"> though. </span><span class="kobospan" id="kobo.756.2">Since our Zabbix API user has more user</span><a id="_idTextAnchor2018" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.757.1"> permissions, it can execute the script that gets host information from a Zabbix database and creates a maintenance period using the information. </span><span class="kobospan" id="kobo.757.2">As we can see in the following diagram, our script follows roughly th</span><a id="_idTextAnchor2019" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.758.1">e same steps as the other Zabbix </span><span><span class="kobospan" id="kobo.759.1">API utilities:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer611">
<span class="kobospan" id="kobo.760.1"><img alt="Figure 10.22 – Python script maintenance.py execution diagram" src="image/B19803_10_22.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.761.1">Figure 10.22 – Python script maintenance.py execution diagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.762.1">Because the Zabbix API is very flexible, we can pull data and write data to do almost anything we could do from </span><span><span class="kobospan" id="kobo.763.1">the frontend.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.764.1">We can now use this</span><a id="_idIndexMarker868" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.765.1"> cool function from anywhere </span><a id="_idTextAnchor2020" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.766.1">in th</span><a id="_idTextAnchor2021" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.767.1">e Zabbix</span><a id="_idIndexMarker869" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.768.1"> frontend where we see a dotted line</span><a id="_idTextAnchor2022" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.769.1"> with the hostname, even from </span><strong class="bold"><span class="kobospan" id="kobo.770.1">Monitoring</span></strong><span class="kobospan" id="kobo.771.1"> | </span><span><strong class="bold"><span class="kobospan" id="kobo.772.1">Hosts</span></strong></span><span><span class="kobospan" id="kobo.773.1">.</span></span></p>
<h2 id="_idParaDest-342" class="calibre7"><a id="_idTextAnchor2023" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.774.1">There’s more…</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.775.1">In Zabbix 7, it is possible to provide</span><a id="_idIndexMarker870" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.776.1"> input from the frontend onto your scripts. </span><span class="kobospan" id="kobo.776.2">If you’d like to test this, we can edit the </span><span><span class="kobospan" id="kobo.777.1">script slightly:</span></span></p>
<ol class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.778.1">Go to </span><strong class="bold"><span class="kobospan" id="kobo.779.1">Alerts</span></strong><span class="kobospan" id="kobo.780.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.781.1">Scripts</span></strong><span class="kobospan" id="kobo.782.1"> and edit the </span><strong class="bold"><span class="kobospan" id="kobo.783.1">Host/Enable</span></strong><span class="kobospan" id="kobo.784.1"> and </span><span><strong class="bold"><span class="kobospan" id="kobo.785.1">Host/Disable</span></strong></span><span><span class="kobospan" id="kobo.786.1"> scripts.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.787.1">In the </span><strong class="bold"><span class="kobospan" id="kobo.788.1">Commands</span></strong><span class="kobospan" id="kobo.789.1"> field, replace </span><strong class="source-inline1"><span class="kobospan" id="kobo.790.1">{HOST.HOST}</span></strong><span class="kobospan" id="kobo.791.1"> with </span><strong class="source-inline1"><span class="kobospan" id="kobo.792.1">{MANUALINPUT}</span></strong><span class="kobospan" id="kobo.793.1"> to make this script accept </span><span><span class="kobospan" id="kobo.794.1">dynamic input.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.795.1">Then open up </span><strong class="bold"><span class="kobospan" id="kobo.796.1">Advanced configuration</span></strong><span class="kobospan" id="kobo.797.1"> and fill in the </span><strong class="bold"><span class="kobospan" id="kobo.798.1">Input prompt</span></strong><span class="kobospan" id="kobo.799.1">, </span><strong class="bold"><span class="kobospan" id="kobo.800.1">Default input string</span></strong><span class="kobospan" id="kobo.801.1">, and </span><strong class="bold"><span class="kobospan" id="kobo.802.1">Input validation rule</span></strong><span class="kobospan" id="kobo.803.1"> fields. </span><span class="kobospan" id="kobo.803.2">It should now look like the </span><span><span class="kobospan" id="kobo.804.1">following figure:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer612">
<span class="kobospan" id="kobo.805.1"><img alt="" role="presentation" src="image/B19803_10_23.jpg" class="calibre4"/></span>
</div>
</div>
<div class="calibre2">
<div class="img---figure" id="_idContainer613">
<span class="kobospan" id="kobo.806.1"><img alt="" role="presentation" src="image/B19803_10_24.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.807.1">Figure 10.23 – Manual script input</span></p>
<ol class="calibre16">
<li value="4" class="calibre15"><span class="kobospan" id="kobo.808.1">Now, when we execute</span><a id="_idIndexMarker871" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.809.1"> the script, it will ask us for input. </span><span class="kobospan" id="kobo.809.2">Fill in a hostname here and the host that we wrote in the field will be enabled </span><span><span class="kobospan" id="kobo.810.1">or disabled.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer614">
<span class="kobospan" id="kobo.811.1"><img alt="Figure 10.24 – Manual script input execution" src="image/B19803_10_25.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.812.1">Figure 10.24 – Manual script input execution</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.813.1">As you can see, with this new script</span><a id="_idIndexMarker872" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.814.1"> input method, it is now possible to make the whole execution process a lot more flexible. </span><span class="kobospan" id="kobo.814.2">We can execute scripts like this in a non-static way, allowing us to provide user input data before </span><span><span class="kobospan" id="kobo.815.1">execution. </span><span class="kobospan" id="kobo.815.2">Neat!</span></span></p>
<h2 id="_idParaDest-343" class="calibre7"><a id="_idTextAnchor2024" class="pcalibre calibre6 pcalibre1"/><span class="kobospan" id="kobo.816.1">See also</span></h2>
<p class="calibre3"><em class="italic"><span class="kobospan" id="kobo.817.1">Brian van Baekel</span></em><span class="kobospan" id="kobo.818.1"> created this script for a customer at </span><em class="italic"><span class="kobospan" id="kobo.819.1">Opensource ICT Solutions</span></em><span class="kobospan" id="kobo.820.1"> and then open sourced it. </span><span class="kobospan" id="kobo.820.2">Because Zabbix has a very cool community that continues to extend the possibilities of Zabbix even further, we too upload some of our scripts. </span><span class="kobospan" id="kobo.820.3">Sharing is caring, so check out the other open source scripts </span><span><span class="kobospan" id="kobo.821.1">at </span></span><span><span class="kobospan" id="kobo.822.1">https://github.com/OpensourceICTSolutions</span></span><span><span class="kobospan" id="kobo.823.1">.</span></span></p>
</div>
</body></html>