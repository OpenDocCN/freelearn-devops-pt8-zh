- en: Storage and Content Delivery
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 存储与内容交付
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下方案：
- en: Hosting a static website
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 托管静态网站
- en: Caching a website
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 缓存网站
- en: Working with network storage
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用网络存储
- en: Backing up data for compliance
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于合规的备份数据
- en: Introduction
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 介绍
- en: Each of these recipes is backed by a CloudFormation template that makes them
    quick and easy to reproduce and modify.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 每个这些方案都由CloudFormation模板支持，使其可以快速、轻松地复现和修改。
- en: Storage
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 存储
- en: Storage is an integral part of any organization's cloud usage. When used correctly,
    servers are short-lived and replaceable. This means that having a durable, available
    storage service is critical to persisting and sharing state.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 存储是任何组织云计算使用的关键部分。正确使用时，服务器是短生命周期且可替换的。这意味着拥有一个耐用、可用的存储服务对于持久化和共享状态至关重要。
- en: 'Here is a high-level summary of the storage services AWS offers:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是AWS提供的存储服务的高级概述：
- en: '![](img/B06236_03_01.png)'
  id: totrans-11
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B06236_03_01.png)'
- en: Storage services from AWS
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: AWS的存储服务
- en: Elastic Block Store
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 弹性块存储
- en: '**Elastic Block Store** (**EBS**) provides block-device storage as volumes
    to EC2 instances. It behaves similarly to a **storage area network** (**SAN**)
    and offers the lowest-latency access of the various storage services offered.
    EBS volumes can only be accessed by one instance at a time. The size of a volume
    must be specified when they are provisioned, and cannot be changed after.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: '**弹性块存储**（**EBS**）为EC2实例提供块设备存储。它的行为类似于**存储区域网络**（**SAN**），并且提供了各种存储服务中最低延迟的访问。EBS卷一次只能被一个实例访问。卷的大小必须在创建时指定，并且之后不能更改。'
- en: Volumes are hosted on redundant hardware in a specific AZ, but they do not offer
    redundancy across AZs.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 卷托管在特定可用区的冗余硬件上，但它们不提供跨可用区的冗余。
- en: 'Some recommended use cases for EBS are:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: EBS的一些推荐使用场景：
- en: Instance boot volumes
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实例启动卷
- en: Intensive data processing
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 强大的数据处理
- en: Transactional writes
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 事务性写入
- en: We will cover EBS in more detail in the [Chapter 4](beece917-78ff-43b8-934b-706eca5968f9.xhtml),
    *Using AWS Compute*, as its primary use is as the underlying storage for EC2 instances.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在[第4章](beece917-78ff-43b8-934b-706eca5968f9.xhtml)中更详细地讨论EBS，*使用AWS计算*，因为它的主要用途是作为EC2实例的底层存储。
- en: Elastic File System
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 弹性文件系统
- en: '**Elastic File System** (**EFS**) provides a file-storage service that can
    be accessed simultaneously by many instances, similar to **Network Attached Storage**
    (**NAS**). While not as fast as EBS, it still provides low-latency access. As
    it may be accessed by multiple clients at a time, it can reach much higher levels
    of throughput than EBS. EFS filesystems also in size scale dynamically and so
    do not need to be preallocated or modified during use. Filesystems are stored
    redundantly across AZs.'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: '**弹性文件系统**（**EFS**）提供一种文件存储服务，多个实例可以同时访问，类似于**网络附加存储**（**NAS**）。虽然它的速度不如EBS快，但仍提供低延迟访问。由于可以被多个客户端同时访问，因此它的吞吐量可以远高于EBS。EFS文件系统的大小会动态扩展，因此不需要预分配或在使用过程中进行修改。文件系统会在可用区（AZ）之间冗余存储。'
- en: 'Some recommended use cases for EFS are:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: EFS的一些推荐使用场景：
- en: Home directories
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 主页目录
- en: Serving shared web content
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提供共享网站内容
- en: Content management
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内容管理
- en: EFS performance scales according to the filesystem size. As the filesystem size
    is not preallocated, the only way to increase your performance is to add more
    data to it.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: EFS的性能会根据文件系统的大小进行扩展。由于文件系统的大小不是预分配的，唯一增加性能的方法是向其中添加更多数据。
- en: Simple Storage Service
  id: totrans-28
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 简单存储服务
- en: '**Simple Storage Service** (**S3**) provides a web-based service for hosting
    files. Files are referred to as **objects** and grouped in **buckets**. Objects
    are effectively a key-value pair, similar to a document database. Keys are used
    like file paths, with */* used as a separator and grouping character. Buckets
    can be easily accessed like a website via an automatically generated domain name.'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: '**简单存储服务**（**S3**）提供一个基于Web的文件托管服务。文件被称为**对象**，并分组在**存储桶**中。对象实际上是一个键值对，类似于文档数据库。键像文件路径一样使用，`/`用作分隔符和分组字符。存储桶可以像网站一样通过自动生成的域名轻松访问。'
- en: Due to being associated with a domain name, bucket names must be *globally*
    unique.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 由于与域名相关联，存储桶名称必须是*全局*唯一的。
- en: 'Some recommended usecases for S3 are:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: S3的一些推荐使用场景：
- en: Static website assets
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 静态网站资产
- en: Sharing large files
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 共享大文件
- en: Short-term (a.k.a. *warm*) backups
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 短期（也称为*温暖*）备份
- en: Glacier
  id: totrans-35
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Glacier
- en: '**Glacier** is a companion service to S3, but is the **cold** storage option.
    Cold storage is a service where you are not able to directly access your data;
    you must lodge a request for data to be restored (to S3), and you are notified
    when it is ready. A physical example of cold storage might be backup tapes that
    are stored in a secure location. Similar to S3, files are referred to as *objects*.
    Files are grouped together and stored in **archives**. Archives can be created
    and deleted, but never modified. Archives are grouped together in to **vaults**,
    which allow you to control access.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: '**Glacier** 是 S3 的配套服务，但它是 **冷** 存储选项。冷存储是一种你无法直接访问数据的服务；你必须提出数据恢复请求（恢复到 S3），并在数据准备好时收到通知。冷存储的物理例子可能是存放在安全位置的备份磁带。与
    S3 类似，文件被称为 *对象*。文件被分组存储在 **归档** 中。归档可以创建和删除，但不能修改。归档被分组存储到 **金库** 中，金库让你能够控制访问。'
- en: The shortest restoration time is 1-5 minutes (with limitations). Standard restoration
    times take 3-5 hours, with some other options available.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 最短的恢复时间是 1-5 分钟（有一些限制）。标准恢复时间需要 3-5 小时，还有其他选项可用。
- en: 'Some recommended usecases for Glacier are:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: Glacier 的一些推荐用例包括：
- en: Long-term (a.k.a. *cold*) backups
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 长期（即 *冷*）备份
- en: Compliance backups
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 合规性备份
- en: Content delivery
  id: totrans-41
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 内容交付
- en: Content delivery is aimed at quickly and efficiently distributing your content
    to users. The best practice way to do this is to leverage a **Content Delivery
    Network** (**CDN**). Amazon's CDN service is **Amazon CloudFront**.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 内容交付的目标是快速、高效地将内容分发给用户。最佳实践是利用 **内容分发网络**（**CDN**）。亚马逊的 CDN 服务是 **Amazon CloudFront**。
- en: While AWS currently has 14 regions, it has an additional 68 edge locations that
    can be used as part of CloudFront. This gives you a massive global network of
    resources you can use to improve your users' experience of your application.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 AWS 目前有 14 个区域，但它还有 68 个额外的边缘位置，可以作为 CloudFront 的一部分使用。这为你提供了一个庞大的全球网络资源，你可以利用这些资源提升用户对你应用的体验。
- en: CloudFront works closely with S3 to serve static assets. In addition to this,
    it can be configured to cache dynamic content. This gives you an easy way to improve
    the performance of applications that are not even aware of CloudFront.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: CloudFront 与 S3 紧密合作，提供静态资源。除此之外，它还可以配置缓存动态内容。这为你提供了一种简单的方式来提升不直接与 CloudFront
    配合使用的应用的性能。
- en: CloudFront websites are referred to as **distributions** which speaks to their
    CDN role.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: CloudFront 网站被称为 **分发**，这突出了它们作为 CDN 的角色。
- en: Distributions can also be used to provide a common frontend for multiple, disparate,
    sources of content.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 分发也可以用于为多个不同的内容来源提供共同的前端。
- en: Hosting a static website
  id: totrans-47
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 托管静态网站
- en: It's really easy to host a static website on AWS. It turns out it's also dirt
    cheap, fast, reliable, and massively scalable too.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 在 AWS 上托管静态网站非常简单。事实证明，它不仅成本低廉、快速、可靠，而且具备大规模扩展能力。
- en: You do this by storing your content in an S3 bucket and configuring that bucket
    to behave like a website.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过将内容存储在 S3 桶中，并配置该桶使其像网站一样运行来实现这一点。
- en: It's important to note that we're talking about static content only. This method
    doesn't work for websites requiring server-side processing or some other backend
    functionality. WordPress, for example, requires PHP which means you need a fully
    functional web server to run it. S3 won't interpret PHP pages for you, it will
    just serve files straight to the browser.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 需要注意的是，我们这里只讨论静态内容。此方法不适用于需要服务器端处理或其他后端功能的网站。例如，WordPress 需要 PHP，这意味着你需要一个完全功能的
    web 服务器来运行它。S3 无法为你解析 PHP 页面，它只会直接将文件提供给浏览器。
- en: 'So, why would you want to host a static website in S3? Common scenarios we
    see are:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 那么，为什么你会想要在 S3 中托管静态网站呢？我们常见的场景有：
- en: Simply, your website is completely static and you don't change it very often.
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 简单来说，你的网站完全是静态的，而且你不经常更改它。
- en: Your company is launching a new product or service. You're expecting very large
    numbers of customers to visit a mini-site within a short time period; likely more
    traffic than your existing web hosting environment can handle.
  id: totrans-53
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你的公司正在推出一款新产品或服务。你预计在短时间内会有大量客户访问一个迷你网站；流量可能远超你现有的 web 托管环境所能承受的。
- en: You need somewhere to host a failover or *down for maintenance* style page which
    is separate from your existing web hosting environment.
  id: totrans-54
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你需要为故障转移或 *维护中* 页面提供一个托管位置，这个页面应该与现有的 web 托管环境分开。
- en: HTTPS is not supported by S3 when it is used to serve static content.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 当 S3 用于提供静态内容时，不支持 HTTPS。
- en: '![](img/B06236_03_02-1.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![](img/B06236_03_02-1.png)'
- en: How to do it...
  id: totrans-57
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'This recipe provides you with the CloudFormation necessary to create:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 这个配方为你提供了创建所需CloudFormation配置：
- en: An S3 bucket for hosting your content
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个用于托管内容的S3存储桶
- en: A Route 53 hosted zone and necessary DNS records
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个Route 53托管区和必要的DNS记录
- en: A redirection from `www` to `root/apex` for your domain
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从`www`到`root/apex`的重定向，适用于你的域名
- en: After running this CloudFormation you will of course need to upload your content
    to the buckets which CloudFormation created for you.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 在运行完CloudFormation后，你当然需要将内容上传到CloudFormation为你创建的存储桶中。
- en: Creating S3 buckets and hosting content
  id: totrans-63
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建S3存储桶并托管内容
- en: 'In this example, we''re actually going to create two S3 buckets for our site
    [http://www.example.org/](http://www.example.org/). They correspond to the hostnames:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们将为我们的网站[http://www.example.org/](http://www.example.org/)创建两个S3存储桶。它们分别对应以下主机名：
- en: '`www.example.org`'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`www.example.org`'
- en: '`example.org`'
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`example.org`'
- en: It might be a good time to remind you that S3 bucket names are globally unique.
    You'll also need to substitute `example.org` for a domain which you own.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 也许现在是时候提醒你，S3存储桶名称是全局唯一的。你还需要用你拥有的域名替换`example.org`。
- en: 'We''re going to put all our content in our `example.org` bucket and tell S3
    that requests to `www.example.org` should be redirected to the other bucket. Here''s
    what the relevant parts of the CloudFormation would look like for creating these
    buckets (note that we''ll be expanding on this example as we proceed through this
    recipe):'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们将把所有内容放在`example.org`存储桶中，并告诉S3请求`www.example.org`时应重定向到另一个存储桶。以下是CloudFormation的相关部分，展示如何创建这些存储桶（请注意，随着我们继续本配方，我们将扩展这个例子）：
- en: '[PRE0]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: We won't be hardcoding our domain name into the bucket names. Instead we're
    going to supply our domain as a parameter to the CloudFormation template in order
    to maximize its reusability, then reference it via `!Ref DomainName`. To keep
    this recipe as simple as possible we're going to set up a single page website.
    In the real world, your website will of course consist of multiple files but the
    process you need to follow is exactly the same.
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们不会将域名硬编码到存储桶名称中。相反，我们将作为参数将域名传递给CloudFormation模板，以最大化其可重用性，然后通过`!Ref DomainName`引用它。为了简化这个配方，我们将设置一个单页网站。在现实中，你的网站当然会由多个文件组成，但你需要遵循的过程完全相同。
- en: 'Configuring the index document:'
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置索引文档：
- en: The **index** document is the file which S3 will serve by default when someone
    types your domain name into the address bar in their browser. This precludes the
    user from having to type the full path to a file, that is, `example.org/index.html`.
  id: totrans-72
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**索引**文档是S3在用户在浏览器的地址栏中输入域名时默认提供的文件。这避免了用户需要输入文件的完整路径，即`example.org/index.html`。'
- en: Typically, your index document will be called `index.html`. We'll provide a
    code snippet for this file towards the end of this chapter.
  id: totrans-73
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通常，你的索引文档会被命名为`index.html`。我们将在本章最后提供该文件的代码片段。
- en: 'Configuring the error document:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置错误文档：
- en: The **error** document is the file S3 will serve if something goes wrong (missing
    files, forbidden access, bad requests, and so on). To keep things consistent we're
    going to call ours `error.html`. Again, we'll provide a code snippet for this
    later in the chapter.
  id: totrans-75
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**错误**文档是S3在出现问题时（如文件丢失、访问禁止、请求错误等）提供的文件。为了保持一致性，我们将其命名为`error.html`。同样，我们将在本章稍后提供该文件的代码片段。'
- en: 'Enabling website hosting on your bucket:'
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在存储桶上启用网站托管：
- en: 'As mentioned previously, we''re going to need to tell S3 that it should serve
    static website content from our `example.org` bucket. Often users will perform
    this configuration through the S3 web console. We''re going to do it in CloudFormation
    however. The CLI also offers a nice one-liner for doing this. You''re not going
    to need to run this command, we''re just adding it here for reference:'
  id: totrans-77
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如前所述，我们需要告诉S3它应该从我们的`example.org`存储桶提供静态网站内容。通常用户会通过S3 Web控制台进行此配置，但我们将使用CloudFormation来完成此操作。CLI也提供了一个简便的命令行来完成这个操作。你无需运行这个命令，我们在这里仅作为参考添加它：
- en: '[PRE1]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Setting up redirection from the `www` hostname:'
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 设置从`www`主机名的重定向：
- en: When performing this task manually one has little option but to fire up the
    web console and configure the `www.example.org` bucket to redirect to the `example.org`
    bucket. There's no handy one-line CLI command for this one. Fortunately, it's
    easy in CloudFormation as you'll soon see in the upcoming CloudFormation snippet.
  id: totrans-80
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在手动执行此任务时，你几乎没有选择，只能打开 Web 控制台并将 `www.example.org` 存储桶配置为重定向到 `example.org`
    存储桶。没有简便的一行 CLI 命令可以做到这一点。幸运的是，在 CloudFormation 中，这很容易，正如你将在接下来的 CloudFormation
    代码片段中看到的那样。
- en: 'Configuring permissions:'
  id: totrans-81
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置权限：
- en: The last bucket setup task is to configure permissions. By default S3 buckets
    are private and only the bucket owner can see its contents. This is not much use
    to us in this scenario because we need *everyone* to be able to see our bucket
    contents. This is a public website after all.
  id: totrans-82
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最后一个存储桶设置任务是配置权限。默认情况下，S3 存储桶是私有的，只有存储桶的所有者可以查看其内容。在这种情况下，这对我们没有太大用处，因为我们需要*每个人*都能够看到我们的存储桶内容。毕竟，这是一个公共网站。
- en: 'If we were configuring our bucket manually we would apply a bucket policy which
    looks something like this:'
  id: totrans-83
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果我们手动配置存储桶，我们会应用类似下面这样的存储桶策略：
- en: '[PRE2]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Fortunately, in CloudFormation the task is much simpler. Building on the previous
    example, the `Resources` section of our CloudFormation template now looks like
    this:'
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 幸运的是，在 CloudFormation 中，这个任务要简单得多。基于之前的示例，我们的 CloudFormation 模板的 `Resources`
    部分现在看起来是这样的：
- en: '[PRE3]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Creating a hosted zone
  id: totrans-87
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建托管区域
- en: 'In order to start adding DNS records we first need to add a hosted zone to
    Route 53\. As you can see in the following code, this is reasonably simple to
    do. The `Name` we are going to supply will be provided as a parameter to our CloudFormation
    template:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 为了开始添加 DNS 记录，我们首先需要向 Route 53 添加一个托管区域。如以下代码所示，这相对简单。我们将提供的 `Name` 将作为参数传递给我们的
    CloudFormation 模板：
- en: '[PRE4]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Creating DNS records
  id: totrans-90
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建 DNS 记录
- en: Now that we have a hosted zone we can go ahead and create DNS records for it.
    For this we use the AWS resource type `AWS::Route53::RecordSetGroup`.
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们有了托管区域，可以继续为它创建 DNS 记录了。为此，我们使用 AWS 资源类型 `AWS::Route53::RecordSetGroup`。
- en: We're going to create an A record for our domain's `root/apex` entry and we'll
    make it an alias. This alias will be configured to point to the AWS endpoint for
    S3-hosted websites in the particular region we choose to run this CloudFormation
    in.
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们将为我们域名的 `root/apex` 项创建一个 A 记录，并且我们会将它设置为别名。这个别名将配置为指向我们选择的区域内 S3 托管网站的 AWS
    终端节点。
- en: In order to archive region portability in our template, we'll use a *mapping*
    to provide all the endpoints. The values in this map are published by AWS in their
    API endpoints documentation. You won't need to look these up, however, because
    our code sample provides the most up-to-date endpoints (as of the time of writing
    this). The endpoints tend not to change, but the list obviously grows when AWS
    adds more regions.
  id: totrans-93
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为了实现模板中的区域可移植性，我们将使用*映射*来提供所有终端节点。这个映射中的值由 AWS 在其 API 终端节点文档中发布。不过，你不需要查找这些值，因为我们的代码示例提供了最新的终端节点（截至写作时）。终端节点通常不会更改，但随着
    AWS 增加更多区域，列表显然会增长。
- en: 'The mapping will look like this:'
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 映射看起来是这样的：
- en: '[PRE5]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'We''ll also need a `CNAME` for `www` which will point at our `WWWBucket` so
    that redirection can take place. The final resource for our DNS records will look
    like this:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还需要为 `www` 创建一个 `CNAME`，它将指向我们的 `WWWBucket`，以便进行重定向。我们的 DNS 记录的最终资源将如下所示：
- en: '[PRE6]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'We''re ready for launch. It''s time to create our CloudFormation stack. You
    can do so using the following CLI command:'
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们准备好发布了。是时候创建我们的 CloudFormation 堆栈了。你可以使用以下 CLI 命令来完成：
- en: '[PRE7]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Uploading website content
  id: totrans-100
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 上传网站内容
- en: 'It''s now time to upload some content to our S3 buckets. Here are the snippets
    we promised you earlier. There''s nothing fancy here. Once you''ve got these examples
    working, you can try replacing them with your real website content:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是时候将一些内容上传到我们的 S3 存储桶了。这里是我们之前承诺给你的代码片段。内容并不复杂。一旦你成功运行了这些示例，你可以尝试将它们替换为你真实的网站内容：
- en: '`index.html`'
  id: totrans-102
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`index.html`'
- en: '[PRE8]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '`error.html`'
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`error.html`'
- en: '[PRE9]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: How it works...
  id: totrans-106
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的……
- en: That's it! As soon as S3 has an `index.html` file to serve up, you will be hosting
    a single-page website on S3\. Go ahead and test it out. The supplied CloudFormation
    example will output a URL you can use to see your new website. After you've verified
    it's working, you can go ahead and upload your real static website and enjoy fast,
    cheap, and server-free hosting.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 就这样！一旦 S3 有了一个 `index.html` 文件来提供服务，你就可以在 S3 上托管一个单页网站了。去试试看吧。提供的 CloudFormation
    示例将输出一个 URL，你可以用它来查看你新建的网站。在验证其正常工作后，你可以继续上传你真实的静态网站，享受快速、廉价且无需服务器的托管服务。
- en: There's more...
  id: totrans-108
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多……
- en: Let's look at some additional things to consider.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们来看看一些需要考虑的额外事项。
- en: Delegating your domain to AWS
  id: totrans-110
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 将你的域名委托给 AWS
- en: 'While we''ve created a hosted zone and some DNS records in Route 53, no one
    can actually see them yet. In order to send your website visitors to your new
    S3 static website, you''ll need to delegate your domain to Route 53\. This is
    left to you as an exercise; however, there are some important things to remember:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然我们已经在 Route 53 中创建了托管区域和一些 DNS 记录，但实际上还没有人能看到它们。为了将你的网站访客引导到新的 S3 静态网站，你需要将域名委托给
    Route 53。这部分留给你作为练习；不过，有一些重要事项需要记住：
- en: The DNS servers to delegate your domain to can be found in the NS record for
    your hosted zone.
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你需要将域名委托给的 DNS 服务器可以在你的托管区域的 NS 记录中找到。
- en: If your domain is already live and production-like, you'll need to make sure
    all your DNS records for your zone are recreated in Route 53, including things
    such as MX records, which are critical for the continuity of your e-mail service.
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果你的域名已经上线并接近生产环境，你需要确保你的区域 DNS 记录都已经在 Route 53 中重新创建，包括如 MX 记录这类对邮件服务持续性至关重要的内容。
- en: Before delegating to AWS, you may consider reducing the TTL values on your DNS
    records. This will be useful if for some reason you need to re-delegate or make
    changes to them. Once your DNS setup is stable, you can increase TTLs.
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在委托给 AWS 之前，你可以考虑减少 DNS 记录的 TTL 值。如果你需要重新委托或更改记录，这将非常有用。一旦你的 DNS 设置稳定，可以增加 TTL
    值。
- en: Cross-origin resource sharing
  id: totrans-115
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 跨源资源共享
- en: It's worth discussing **cross-origin resource sharing** (**CORS**) here because
    the more static web content hosting you do in S3, the higher your chances are
    of needing to know about this, particularly where web fonts are concerned.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里值得讨论一下**跨源资源共享**（**CORS**），因为你在 S3 上托管更多静态网页内容时，了解 CORS 的可能性会更高，尤其是在涉及网页字体时。
- en: Some browsers implement a *same origin* policy restriction. This prevents the
    browser from loading certain kinds of assets from hostnames that are different
    from the page being displayed to the user. Web fonts fall under this restriction
    and are an often-cited example because when they don't load correctly, your website
    will usually look a lot different to how you intended. The solution to this is
    to add a CORS configuration to your bucket to allow its content to be loaded by
    the particular origin or hostname that requested it.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 一些浏览器实施了*同源*策略限制。这会阻止浏览器从与当前显示给用户的页面不同的主机名加载某些类型的资源。网页字体就是一个常见的例子，因为如果它们无法正确加载，通常会导致你的网站看起来与预期大相径庭。解决方案是为你的存储桶添加
    CORS 配置，允许特定来源或主机名加载其内容。
- en: 'We''ll leave the CORS configuration out of our full example, but if you need
    to add one to your bucket, here''s how you can do it. Update your `AllowedOrigins`
    property to look similar to the following CloudFormation and you should be all
    set:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将会把 CORS 配置从完整示例中省略，但如果你需要为存储桶添加一个，下面是如何操作的。更新你的`AllowedOrigins`属性，格式可以参考下面的
    CloudFormation，你应该就能设置好：
- en: '[PRE10]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Caching a website
  id: totrans-120
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 缓存网站
- en: In this recipe, we'll show you how to use AWS CloudFront to cache your website.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个操作中，我们将向你展示如何使用 AWS CloudFront 来缓存你的网站。
- en: 'The primary reasons you''ll want to consider doing this are as follows:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 你考虑执行此操作的主要原因如下：
- en: Copies of your content will be geographically located closer to your end users,
    thus improving their experience and delivering content to them faster.
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你内容的副本将地理上靠近你的终端用户，从而改善他们的体验，并更快地为他们提供内容。
- en: The burden for serving content will be removed from your fleet of servers. This
    could potentially result in a large cost saving if you're able to turn off some
    servers or reduce your bandwidth bill.
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内容的提供负担将从你的服务器群上移除。如果你能够关闭一些服务器或减少带宽账单，可能会带来巨大的成本节约。
- en: You may need to be shielded from large and unexpected spikes in traffic.
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可能需要保护自己免受大规模且意外的流量激增。
- en: While not the focus of this chapter, CloudFront gives you the ability to implement
    **Web Application Firewall** (**WAF**) as an added layer of protection from the
    bad guys.
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 虽然这章的重点不是这个，CloudFront 让你能够实现**Web 应用防火墙**（**WAF**），为你提供额外的保护层，防止恶意攻击者。
- en: Unlike most AWS services, which are region specific, CloudFront is a *global*
    service.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 不同于大多数 AWS 服务是区域特定的，CloudFront 是一个*全球*服务。
- en: Getting ready
  id: totrans-128
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备就绪
- en: First of all, you're going to need a publicly accessible website. This could
    be a static website hosted in S3, or it could be a dynamically generated website
    hosted in EC2\. In fact, your website doesn't even need to be hosted in AWS in
    order to use CloudFront. As long as your website is publicly accessible, you should
    be good to go.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，你需要一个公开可访问的网站。这可以是托管在 S3 上的静态网站，也可以是托管在 EC2 上的动态生成网站。事实上，你的网站甚至不需要托管在 AWS
    上也能使用 CloudFront。只要你的网站是公开可访问的，就可以使用 CloudFront。
- en: You'll also need to have the ability to modify the DNS records for your website.
    Instead of pointing to your web server (or S3 bucket), we'll eventually point
    them to CloudFront.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 你还需要能够修改网站的 DNS 记录。我们最终将把它们指向 CloudFront，而不是指向你的 Web 服务器（或 S3 存储桶）。
- en: About dynamic content
  id: totrans-131
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 关于动态内容
- en: If your website consists of mostly dynamic content, you can still benefit from
    implementing CloudFront.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的网站主要由动态内容组成，你仍然可以通过实施 CloudFront 受益。
- en: First of all, CloudFront will maintain a pool of persistent connections with
    your origin servers. This lessens the time it takes for files to be served to
    your users because the number of three-way handshakes they'll need to perform
    is reduced.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，CloudFront 将保持与源服务器的持久连接池。这减少了文件传输到用户所需的时间，因为需要执行的三次握手次数减少了。
- en: Second, CloudFront implements some additional optimizations around TCP connections
    for high performance. More data is able to initially be transferred over the wire
    because CloudFront uses a wider initial TCP window.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 其次，CloudFront 在 TCP 连接方面实施了一些额外的优化，以提高性能。由于 CloudFront 使用更大的初始 TCP 窗口，因此能够更快地传输更多的数据。
- en: Finally, implementing a CDN such as CloudFront *does* give you the opportunity
    to review your caching strategy and how you use cache-control headers. If your
    home page is dynamically generated, you'll get some benefit straight away by serving
    it via CloudFront, but the benefits will be much greater if you were to let CloudFront
    cache it for a few minutes. Again, cost, end user, and backend performance are
    all things you should take into consideration.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，实施像 CloudFront 这样的 CDN *确实*给你提供了审查缓存策略和使用缓存控制头的机会。如果你的首页是动态生成的，通过 CloudFront
    服务它你会立刻得到一些好处，但如果你让 CloudFront 缓存几分钟，效果会更好。再次强调，成本、最终用户体验和后台性能都是你需要考虑的因素。
- en: Configuring CloudFront distributions
  id: totrans-136
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置 CloudFront 分发
- en: 'Distributions can be configured with a fairly wide array of options. Our recipe
    is going to be quite simple so that you can get up and running as quickly as possible.
    But we will talk through some of the more common configuration options:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 分发可以配置多种选项。我们的配置将相对简单，以便你能够尽快上手。但我们会讨论一些更常见的配置选项：
- en: 'Origins: A distribution needs to have at least one origin. An origin, as the
    name indicates, is where your website content originates from your public-facing
    website. The properties you''ll most likely be concerned with are:'
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 源：一个分发需要至少有一个源。正如其名称所示，源是你的网站内容的来源，来自你公开面向用户的网站。你最关心的属性通常是：
- en: 'Origin Domain Name: This is the hostname of your public-facing website. The
    CloudFormation template we supply accepts this hostname as a parameter.'
  id: totrans-139
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 源域名：这是你公开面向用户的网站的主机名。我们提供的 CloudFormation 模板将这个主机名作为参数接受。
- en: 'Origin Path: It''s possible to configure the distribution to fetch content
    from a directory or subfolder at the origin, for example, `/content/images` if
    you were using CloudFront to cache images only. In our case, we are caching our
    entire website, so we don''t specify an Origin Path at all.'
  id: totrans-140
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 源路径：可以配置分发从源站的目录或子文件夹获取内容，例如，如果你只使用 CloudFront 缓存图片，可以设置 `/content/images`。在我们的案例中，我们缓存的是整个网站，因此我们根本不指定源路径。
- en: 'Origin ID: This is particularly important when you are using nondefault cache
    behavior settings and therefore have configured multiple origins. You need to
    assign a unique ID to the origins so that the cache behaviors know which origin
    to target. There''ll be more discussion on cache behaviors later.'
  id: totrans-141
  prefs:
  - PREF_UL
  - PREF_UL
  type: TYPE_NORMAL
  zh: 源 ID：当你使用非默认的缓存行为设置并配置多个源时，这一点尤其重要。你需要为源分配唯一的 ID，以便缓存行为知道要针对哪个源进行操作。稍后会对缓存行为进行更多讨论。
- en: 'HTTP Port, HTTPS Port: If your origin is listening on nonstandard ports for
    HTTP or HTTPS, you would use these parameters to define those ports.'
  id: totrans-142
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: HTTP 端口，HTTPS 端口：如果你的源在非标准端口上监听 HTTP 或 HTTPS，你可以使用这些参数来定义这些端口。
- en: 'Origin Protocol Policy: You are able to configure the distribution to talk
    to your origin via:'
  id: totrans-143
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 源协议策略：你可以配置分发与源服务器进行通信的方式：
- en: HTTP Only
  id: totrans-144
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 仅支持HTTP
- en: HTTPS Only
  id: totrans-145
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 仅支持HTTPS
- en: Match Viewer
  id: totrans-146
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 匹配查看者
- en: The Match Viewer option forwards requests to the origin based on which protocol
    the user requested with in their browser. Again, we are keeping things quite simple
    in this recipe, so we'll be opting for HTTP Only.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 匹配查看者选项根据用户在浏览器中请求的协议将请求转发到源服务器。由于我们在这个方案中保持简单，所以我们选择了仅支持HTTP。
- en: 'Logging: Keep in mind that because less traffic will be hitting your origin,
    fewer access logs will also be captured. It makes sense to have CloudFront keep
    these logs for us in an S3 bucket. This is included in the CloudFormation provided
    with this recipe:'
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 日志记录：请记住，由于流量减少，访问源服务器的请求也会减少，因此捕获的访问日志也会较少。将这些日志存储在S3桶中由CloudFront来管理是有意义的。在这个方案中，CloudFormation模板已经包括了这项内容：
- en: '**Cache behaviors**: In this recipe, we''ll configure a single (default) cache
    behavior, which will forward all requests to our origin.'
  id: totrans-149
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**缓存行为**：在这个方案中，我们将配置一个单一的（默认）缓存行为，它将把所有请求转发到我们的源服务器。'
- en: '**CloudFront**: It allows you to get quite fine grained with the behaviors
    you configure. You might, for example, want to apply a rule to all the `.js` and
    `.css` files on your origin. Perhaps you want to forward query strings to the
    origin for these file types. Similarly, you might want to ignore the TTL the origin
    is trying to set for image files, instead telling CloudFront to cache for a minimum
    of 24 hours.'
  id: totrans-150
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**CloudFront**：它允许你对配置的行为进行非常精细的控制。例如，你可能想要对源服务器上的所有`.js`和`.css`文件应用一个规则。也许你希望将查询字符串转发到源服务器针对这些文件类型。类似地，你可能希望忽略源服务器尝试为图像文件设置的TTL，而是指示CloudFront缓存至少24小时。'
- en: 'Aliases: These are additional hostnames you want the distribution to serve
    traffic for. For example, if your Origin Domain Name is configured to `loadbalancer.example.org`,
    then you probably want aliases that look something like this:'
  id: totrans-151
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 别名：这些是你希望分发为其提供流量的附加主机名。例如，如果你的源域名配置为`loadbalancer.example.org`，你可能希望添加类似以下的别名：
- en: '`example.org`'
  id: totrans-152
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`example.org`'
- en: '`www.example.org`'
  id: totrans-153
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`www.example.org`'
- en: The CloudFormation template provided with this recipe expects one or more
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 本方案提供的CloudFormation模板期望至少包含一个或多个
- en: aliases to be provided in the form of a comma-delimited list of strings.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 别名应以逗号分隔的字符串列表的形式提供。
- en: 'Allowed HTTP Methods: By default, CloudFront will only forward GET and HEAD
    requests to your origin. This recipe doesn''t change those defaults, so we don''t
    declare this parameter in the provided template. If your origin is serving dynamically
    generated content, then you will likely want to declare this parameter and set
    its values to GET, HEAD, OPTIONS, PUT, POST, PATCH, and DELETE.'
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 允许的HTTP方法：默认情况下，CloudFront只会将GET和HEAD请求转发到源服务器。这个方案没有更改这些默认设置，因此我们没有在提供的模板中声明这个参数。如果你的源服务器提供动态生成的内容，你可能希望声明此参数，并将其值设置为GET、HEAD、OPTIONS、PUT、POST、PATCH和DELETE。
- en: 'TTLs (minimum/maximum/default): You can optionally define how long you''d like
    objects to stay in CloudFront''s caches before expiring and being refetched from
    the origin. Again, we''ve opted to stick to CloudFront''s default values to keep
    this recipe simple, so we''ve omitted this parameter from our template. The defaults
    are as follows:'
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: TTL（最小/最大/默认）：你可以选择定义对象在CloudFront缓存中保留多长时间，直到过期并从源服务器重新获取。由于我们选择保持CloudFront的默认值以简化方案，因此在模板中没有包含这个参数。默认值如下：
- en: 'Minimum TTL: 0 seconds'
  id: totrans-158
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最小TTL：0秒
- en: 'Default TTL: 1 day'
  id: totrans-159
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认TTL：1天
- en: 'Maximum TTL: 1 year'
  id: totrans-160
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最大TTL：1年
- en: 'Price Class: By default, CloudFront will serve your content from all of its
    edge locations, giving you the maximum performance possible. We''re going to deploy
    our distribution using the lowest possible price class, Price Class *100*. This
    corresponds to edge locations in the United States, Canada, and Europe. Users
    from Australia would not benefit too much from this Price Class, but you''re also
    paying less for it. Price Class *200* adds Asian regions, and Price Class *All*
    adds South America and Australia.'
  id: totrans-161
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 价格类别：默认情况下，CloudFront会从所有的边缘位置提供内容，从而提供最佳的性能。我们将使用最低的价格类别Price Class *100*来部署我们的分发。这对应于美国、加拿大和欧洲的边缘位置。来自澳大利亚的用户可能不会从这个价格类别中受益太多，但你也支付的费用较少。价格类别*200*增加了亚洲地区，价格类别*All*则包括南美洲和澳大利亚。
- en: A comprehensive list and detailed explanation on which values can be specified
    when creating a CloudFront distribution can be found here at [http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html).
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 创建CloudFront分发时可以指定的值的详细列表和解释，请参见此链接：[http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html)。
- en: How to do it...
  id: totrans-163
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The first (and only) thing we need to do is configure a CloudFront distribution
    as shown in the following diagram:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要做的第一件事（也是唯一的事）是按照下图所示配置CloudFront分发：
- en: '![](img/image_03_003.png)'
  id: totrans-165
  prefs: []
  type: TYPE_IMG
  zh: '![](img/image_03_003.png)'
- en: 'Create a new CloudFormation template and add the following code:'
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新的CloudFormation模板，并添加以下代码：
- en: '[PRE11]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Using the template we created above, go ahead and create your CloudFront distribution.
    Expect to wait around 20-25 minutes for this stack to finish creating. It takes
    a while for your distribution configuration to be pushed out to all the AWS CloudFront
    locations:'
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用我们上面创建的模板，继续创建CloudFront分发。预计需要等待约20-25分钟，直到这个堆栈完成创建。由于需要将你的分发配置推送到所有AWS CloudFront位置，所以这会花费一些时间：
- en: '[PRE12]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Working with network storage
  id: totrans-170
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用网络存储
- en: In this recipe, we will use the Amazon EFS to provide network-based storage
    to instances.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个教程中，我们将使用Amazon EFS为实例提供基于网络的存储。
- en: 'Some of the benefits of using EFS compared to other AWS services are as follows:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 使用EFS与其他AWS服务相比的一些好处如下：
- en: Guaranteed write order between distributed clients
  id: totrans-173
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 保证分布式客户端之间的写入顺序
- en: Automatic resizing—no need to preallocate and no need to downsize
  id: totrans-174
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动调整大小——无需预分配，也无需缩小
- en: You only pay for the space you use (per GB)—no transfer or extra costs
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你只需为你使用的空间付费（按GB计），无需支付传输或额外费用
- en: Getting ready
  id: totrans-176
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: This example works with the default VPC and subnets, present in all AWS accounts
    when they are created. Even if you have changed you network configuration, all
    you need is a working VPC with two or more subnets in different AZs for this recipe.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例使用的是默认VPC和子网，这些在所有AWS账户创建时都会自动创建。即使你已经更改了网络配置，本教程所需的仅是一个包含两个或更多不同可用区（AZ）的工作VPC。
- en: How to do it...
  id: totrans-178
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Open your favorite text editor, and start a new CloudFormation template by
    defining the `AWSTemplateFormatVersion` and `Description`:'
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开你喜欢的文本编辑器，通过定义`AWSTemplateFormatVersion`和`Description`来开始一个新的CloudFormation模板：
- en: '[PRE13]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Create a top-level `Parameters` section, and define the required parameters,
    `VpcId` and `SubnetIds`, inside it:'
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个顶级的`Parameters`部分，并在其中定义必需的参数`VpcId`和`SubnetIds`：
- en: '[PRE14]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Create a top-level `Resources` property, which will contain all the resources
    defined.
  id: totrans-183
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个顶级`Resources`属性，用来包含所有定义的资源。
- en: 'Under the `Resources` property, add the `EFS` filesystem resource:'
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`Resources`属性下，添加`EFS`文件系统资源：
- en: '[PRE15]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Add mount target resources for connecting to the filesystem you just created:'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 添加挂载目标资源，用于连接到你刚刚创建的文件系统：
- en: '[PRE16]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Create a security group to control access to the mount targets:'
  id: totrans-188
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个安全组来控制对挂载目标的访问：
- en: '[PRE17]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Create a security group to access the mount target security group you created
    in the previous step:'
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个安全组以访问你在上一步创建的挂载目标安全组：
- en: '[PRE18]'
  id: totrans-191
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Define the ingress and egress rules for the mount target security group:'
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定义挂载目标安全组的入站和出站规则：
- en: '[PRE19]'
  id: totrans-193
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Define the ingress and egress rules for the mount target access security group:'
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定义挂载目标访问安全组的入站和出站规则：
- en: '[PRE20]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: Save your template with the name `03-working-with-network-storage.yaml`.
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将你的模板保存为`03-working-with-network-storage.yaml`。
- en: 'Launch the CloudFormation stack with the following AWS CLI command, substituting
    your own VPC ID and subnet IDs:'
  id: totrans-197
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下AWS CLI命令启动CloudFormation堆栈，替换成你自己的VPC ID和子网ID：
- en: '[PRE21]'
  id: totrans-198
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: How it works...
  id: totrans-199
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'Here is what the created resources will look like at the end of the recipe:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 这是在教程结束时创建的资源的样子：
- en: '![](img/image_03_004.png)'
  id: totrans-201
  prefs: []
  type: TYPE_IMG
  zh: '![](img/image_03_004.png)'
- en: Working with network storage
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 使用网络存储
- en: We start by creating the standard CloudFormation template properties in step
    1.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 我们从第1步开始创建标准的CloudFormation模板属性。
- en: In step 2, you define the template's parameters that will be used when configuring
    the resources.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 在第2步中，你定义了模板的参数，这些参数将在配置资源时使用。
- en: Steps 3 and 4 are where the EFS resources are specified. They consist of an
    EFS filesystem and mount targets in each of the AZs that will access it.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 第3步和第4步是指定EFS资源的地方。它们由一个EFS文件系统和在每个可用区（AZ）中的挂载目标组成，这些挂载目标将访问该文件系统。
- en: 'We then create the security groups in steps 5 and 6: one for the mount targets
    and one for the instances that are allowed to connect to the mount targets.'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们在步骤 5 和 6 中创建安全组：一个用于挂载目标，另一个用于允许连接到挂载目标的实例。
- en: As these two security groups contain two-way (or circular) references to each
    other, we must define the rules between them in separate resources in steps 7
    and 8.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 由于这两个安全组之间有双向（或循环）引用，我们必须在步骤 7 和 8 中将它们之间的规则定义为单独的资源。
- en: In step 9, you save the template with a specific filename so that it can be
    referenced in the command to launch the stack in step 10.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 在步骤 9 中，你将以特定的文件名保存模板，以便在步骤 10 中的命令中引用它来启动堆栈。
- en: There's more...
  id: totrans-209
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'To confirm that your EFS filesystem, mount targets, and security groups are
    working, you can also provision some client instances to connect to them. Add
    the following resources and parameters to the template you have already created:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确认你的 EFS 文件系统、挂载目标和安全组是否正常工作，你还可以配置一些客户端实例来连接它们。将以下资源和参数添加到你已经创建的模板中：
- en: 'Add the following parameters to your top-level `Parameters` section to configure
    your instances:'
  id: totrans-211
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将以下参数添加到你的顶层 `Parameters` 部分以配置你的实例：
- en: '[PRE22]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Add an `AutoScalingGroup` under the `Resources` section; regardless of which
    AZ your servers are provisioned to, they will have access to the `EFS` filesystem
    via the local mount point:'
  id: totrans-213
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `Resources` 部分添加一个 `AutoScalingGroup`；无论你的服务器被配置到哪个可用区，它们都可以通过本地挂载点访问 `EFS`
    文件系统：
- en: '[PRE23]'
  id: totrans-214
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Still in the `Resources` section, add a launch configuration:'
  id: totrans-215
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 仍然在 `Resources` 部分，添加一个启动配置：
- en: '[PRE24]'
  id: totrans-216
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Launch the CloudFormation stack with the following AWS CLI command, substituting
    your own parameter values:'
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下 AWS CLI 命令启动 CloudFormation 堆栈，替换为你自己的参数值：
- en: '[PRE25]'
  id: totrans-218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: Once the new stack is ready, you will be able to SSH to your instances and verify
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦新堆栈准备就绪，你将能够 SSH 连接到你的实例并进行验证。
- en: that they have mounted the EFS filesystem.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 确保它们已经挂载了 EFS 文件系统。
- en: Backing up data for compliance
  id: totrans-221
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 数据备份以符合合规要求
- en: We work with a lot of companies (especially in the finance industry) that have
    strict rules around the minimum time data needs to be kept for. This can become
    quite onerous and expensive if you need to keep customer records for a minimum
    of 7 years, for example.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 我们与许多公司合作（尤其是在金融行业），这些公司对数据需要保存的最短时间有严格的规定。例如，如果你需要保存客户记录至少 7 年，这可能会变得非常繁琐和昂贵。
- en: Using S3, Glacier, and life cycle rules, we can create a flexible long-term
    backup solution while also automating the archiving and purging of backups and
    reducing costs.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 S3、Glacier 和生命周期规则，我们可以创建一个灵活的长期备份解决方案，同时自动化备份的归档和清除，降低成本。
- en: We are also going to utilize *versioning* in order to mitigate the damaged caused
    by a file being accidentally deleted or overwritten in our backup bucket.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将利用 *版本控制* 来减轻由于文件在备份桶中被意外删除或覆盖而造成的损坏。
- en: How to do it...
  id: totrans-225
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'First, we need to define a few parameters:'
  id: totrans-226
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，我们需要定义一些参数：
- en: '`ExpirationInDays`: This is the maximum amount of time we want to have our
    files kept in backup for. We''ve set a default for this value of 2,555 days (7
    years).'
  id: totrans-227
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ExpirationInDays`：这是我们希望将文件保存在备份中的最大时间。我们已将此值的默认设置为 2,555 天（7 年）。'
- en: '`TransitionToInfrequentAccessInDays`: After a backup has been copied to S3,
    we want to move it to the *infrequently accessed* class to reduce our costs. This
    doesn''t affect the durability of the backup, but it does have a small impact
    on its availability. We''ll set this to 30 days.'
  id: totrans-228
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`TransitionToInfrequentAccessInDays`：在备份复制到 S3 后，我们希望将其转移到 *不常访问* 存储类，以减少成本。这不会影响备份的持久性，但会对其可用性产生轻微影响。我们将其设置为
    30 天。'
- en: '`TransitionToGlacierInDays`: After the backup has been kept in the infrequently
    accessed class for a while, we want to move it to Glacier. This again helps us
    reduce our costs at the expense of retrieval times. If we need to fetch a backup
    from Glacier, the wait time will be approximately 3-5 hours. We''ll set the default
    for this to 60 days.'
  id: totrans-229
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`TransitionToGlacierInDays`：在备份保留在不常访问的存储类一段时间后，我们希望将其转移到 Glacier。这样做有助于我们降低成本，但会牺牲检索时间。如果我们需要从
    Glacier 恢复备份，等待时间大约为 3-5 小时。我们将默认设置为 60 天。'
- en: '`PreviousVersionsExpirationInDays`: Given that we will have versioning enabled
    on our bucket, we want to make sure old versions of files aren''t kept forever—we''re
    using this feature only to mitigate accidents. We''ll set this value to 60 days,
    which gives us more than enough time to identify and recover from an accidental
    deletion or overwrite.'
  id: totrans-230
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PreviousVersionsExpirationInDays`：鉴于我们将在桶中启用版本控制，我们希望确保旧版本的文件不会被永久保留——我们使用此功能仅是为了防止意外。我们将此值设置为
    60 天，这样我们就有足够的时间识别并从意外删除或覆盖中恢复。'
- en: '`PreviousVersionsToInfrequentAccessInDays`: Just like our other backup files,
    we want to move our old versions to the infrequently accessed class after a period
    of time in order to minimize costs. We''ll set this to 30 days:'
  id: totrans-231
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PreviousVersionsToInfrequentAccessInDays`：就像我们的其他备份文件一样，我们希望在一段时间后将旧版本移动到不常访问的存储类，以最小化成本。我们将此值设置为
    30 天：'
- en: '[PRE26]'
  id: totrans-232
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Next, we''ll need to create the S3 bucket to store our backups in. Note that
    we''re omitting the `name` property for this bucket in order to avoid bucket name
    conflicts and maximize region portability. We''re also enabling versioning and
    adding our life cycle rules from our previous `Parameters`:'
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，我们需要创建 S3 桶来存储备份。请注意，我们省略了该桶的 `name` 属性，以避免桶名冲突并最大化区域可移植性。我们还启用了版本控制，并添加了之前
    `Parameters` 中的生命周期规则：
- en: '[PRE27]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Finally, let''s add an output so we know which bucket to store our backups
    in:'
  id: totrans-235
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，让我们添加一个输出，以便我们知道将备份存储到哪个桶中：
- en: '[PRE28]'
  id: totrans-236
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: How it works...
  id: totrans-237
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理...
- en: 'Go ahead and launch this CloudFormation stack. If you''re happy with the default
    values for the parameters, you don''t need to provide them with the CLI command:'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 继续并启动此 CloudFormation 堆栈。如果您对参数的默认值感到满意，则无需在 CLI 命令中提供它们：
- en: '[PRE29]'
  id: totrans-239
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Once the stack has been created, you'll be all set to start copying backups
    to the S3 bucket and to start worrying less about your backups' life cycle and
    management. If you decide that the expiry or transition times need to change after
    you've created the bucket, you can do this by simply updating the parameters for
    the stack.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦堆栈创建完成，您就可以开始将备份复制到 S3 桶中，并且不再需要过多担心备份的生命周期和管理。如果在创建桶之后，您决定需要更改过期或转换时间，可以通过简单地更新堆栈的参数来实现。
