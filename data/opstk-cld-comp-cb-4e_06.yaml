- en: Chapter 6. Glance – OpenStack Image Service
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第6章 Glance – OpenStack镜像服务
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主题：
- en: Introduction to OpenStack Image services
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OpenStack镜像服务介绍
- en: Managing images
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 管理镜像
- en: Using image snapshots
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用镜像快照
- en: Using image metadata
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用镜像元数据
- en: Protecting images
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 保护镜像
- en: Deactivating images
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 禁用镜像
- en: Creating custom images
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建自定义镜像
- en: Introduction to OpenStack Image services
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: OpenStack镜像服务介绍
- en: The OpenStack Image service, otherwise known as Glance, is a service that allows
    users to register, discover, and retrieve virtual machine images for use in an
    OpenStack cloud. Images made available through the OpenStack Image service can
    be stored in a variety of formats and backend locations, from local filesystem
    storage to distributed filesystems such as OpenStack Object Storage (Swift) and
    Ceph.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: OpenStack镜像服务，也称为Glance，是一个允许用户注册、发现和获取虚拟机镜像，以便在OpenStack云中使用的服务。通过OpenStack镜像服务提供的镜像可以存储在多种格式和后端位置中，从本地文件系统存储到分布式文件系统，如OpenStack对象存储（Swift）和Ceph。
- en: 'The OpenStack Image service is composed of two major components: the `glance-api`
    service and the `glance-registry` service. Users interface with the `glance-api`
    service indirectly when performing commands to create, list, delete, or otherwise
    manage images using OpenStack clients. The `glance-registry` service is responsible
    for connecting to the backend database and storing or retrieving images.'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: OpenStack镜像服务由两个主要组件组成：`glance-api`服务和`glance-registry`服务。用户在使用OpenStack客户端执行创建、列出、删除或管理镜像等命令时，间接与`glance-api`服务进行交互。`glance-registry`服务负责连接后端数据库，并存储或检索镜像。
- en: Managing images
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 管理镜像
- en: Image management in an OpenStack environment can be achieved using the `openstack`
    command-line tool, the Horizon dashboard, or directly via the Glance REST-based
    API. Images can be sourced directly from the internet or created and manipulated
    with tools such as `virsh`, `virt-manager`, `growpart`, and `cloud-init`. Custom
    image creation will be covered later in this chapter.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在OpenStack环境中，可以使用`openstack`命令行工具、Horizon仪表板或通过Glance基于REST的API直接进行镜像管理。镜像可以直接从互联网获取，或者使用`virsh`、`virt-manager`、`growpart`、`cloud-init`等工具创建和操作。自定义镜像创建将在本章后面进行介绍。
- en: Uploading images
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 上传镜像
- en: When creating an image in OpenStack, one must provide attributes that describe
    the image. These attributes include the image name, the disk format, and the container
    format. Images can be public, private, or shared among multiple projects.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在OpenStack中创建镜像时，必须提供描述镜像的属性。这些属性包括镜像名称、磁盘格式和容器格式。镜像可以是公共的、私有的，或者在多个项目之间共享。
- en: Getting ready
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'Images for the following examples can be downloaded from the following locations:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例所需的镜像可以从以下位置下载：
- en: 'Ubuntu: [https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img](https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img)'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'Ubuntu: [https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img](https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img)'
- en: 'CirrOS: [https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img](https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img)'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'CirrOS: [https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img](https://download.cirros-cloud.net/0.3.5/cirros-0.3.5-i386-disk.img)'
- en: Note
  id: totrans-20
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Over time, image locations on the web can change and the URLs in this book may
    be unavailable. Feel free to replace any URL in these examples with a known, working
    URL.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 随着时间的推移，网络上的镜像位置可能会发生变化，本书中的URL可能不可用。您可以自由地将这些示例中的任何URL替换为已知且有效的URL。
- en: When uploading an image, ensure that you have properly sourced your credentials
    or are otherwise properly authenticated.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 上传镜像时，确保您已经正确获取凭证或已通过其他方式正确认证。
- en: 'You will need the following details, at a minimum, when uploading an image:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 上传镜像时，您至少需要以下信息：
- en: Image name
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称
- en: Disk format
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 磁盘格式
- en: Image location
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像位置
- en: 'For our first example, the following will be used:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的第一个示例，将使用以下内容：
- en: 'Image name: `COOKBOOK_CIRROS_IMAGE`'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '镜像名称: `COOKBOOK_CIRROS_IMAGE`'
- en: 'Disk format: `qcow2`'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '磁盘格式: `qcow2`'
- en: 'Image location: `/tmp/cirros-0.3.5-i386-disk.img`'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '镜像位置: `/tmp/cirros-0.3.5-i386-disk.img`'
- en: 'For our second example, the following will be used:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的第二个示例，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '镜像名称: `COOKBOOK_UBUNTU_IMAGE`'
- en: 'Disk format: `qcow2`'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '磁盘格式: `qcow2`'
- en: 'Image location: `/tmp/xenial-server-cloudimg-amd64-disk1.img`'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '镜像位置: `/tmp/xenial-server-cloudimg-amd64-disk1.img`'
- en: How to do it…
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'With the OpenStack client installed on our system, we are now able to upload
    an image with the following steps:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 在系统上安装 OpenStack 客户端后，我们现在可以通过以下步骤上传镜像：
- en: 'Download the CirrOS image to the `/tmp` directory:'
  id: totrans-37
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 CirrOS 镜像下载到 `/tmp` 目录：
- en: '[PRE0]'
  id: totrans-38
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Upload the CirrOS image:'
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 上传 CirrOS 镜像：
- en: '[PRE1]'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'The output will resemble the following:'
  id: totrans-41
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出将类似于以下内容：
- en: '![How to do it…](img/00117.jpeg)'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作...](img/00117.jpeg)'
- en: 'Repeat the previous steps for the Ubuntu image:'
  id: totrans-43
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对 Ubuntu 镜像重复执行上述步骤：
- en: 'Download the Ubuntu image to the `/tmp` directory:'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 Ubuntu 镜像下载到 `/tmp` 目录：
- en: '[PRE2]'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Upload the Ubuntu image:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 上传 Ubuntu 镜像：
- en: '[PRE3]'
  id: totrans-47
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: How it works...
  id: totrans-48
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'Images are created with the following syntax:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 创建镜像的语法如下：
- en: '[PRE4]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Creating an image with the OpenStack client results in the specified file being
    uploaded to the OpenStack image repository. The repository can be a local directory
    or volume specified in the Glance configuration file, or even an object store
    served by Swift, Ceph, Rackspace Cloud Files, or others.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 OpenStack 客户端创建镜像时，指定的文件将被上传到 OpenStack 镜像库。镜像库可以是 Glance 配置文件中指定的本地目录或卷，也可以是由
    Swift、Ceph、Rackspace Cloud Files 等提供的对象存储。
- en: The `disk-format` parameter defines the format of the virtual disk used by the
    image. Options include `ami`, `ari`, `aki`, `vhd`, `vmdk`, `raw`, `qcow2`, `vhdx`,
    `vdi`, `iso`, and `ploop`. The `qcow2` format is popular among OpenStack-based
    clouds running QEMU/KVM hypervisors, and it supports smaller image file sizes,
    copy-on-write support, and various compression and encryption technologies. The
    default format is `raw`.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '`disk-format` 参数定义了镜像使用的虚拟磁盘格式。可选项包括 `ami`、`ari`、`aki`、`vhd`、`vmdk`、`raw`、`qcow2`、`vhdx`、`vdi`、`iso`
    和 `ploop`。`qcow2` 格式在基于 OpenStack 的云环境中广泛使用，特别是在运行 QEMU/KVM 虚拟化的环境中，它支持较小的镜像文件大小、写时复制（copy-on-write）支持以及各种压缩和加密技术。默认格式为
    `raw`。'
- en: When uploading images to a Glance store backed by Ceph, the images must be in
    the `raw` format else they will fail to work properly. The `qemu-img` command
    can be used to identify the format of an image, and it can also be used to perform
    the conversion of an image from one format to another.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 当将镜像上传到由 Ceph 支持的 Glance 存储时，镜像必须为 `raw` 格式，否则无法正常工作。可以使用 `qemu-img` 命令识别镜像的格式，同时该命令也可以用来将镜像从一种格式转换为另一种格式。
- en: 'An example of converting an image in the `qcow2` format to the `raw` format
    is shown here:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是一个将 `qcow2` 格式的镜像转换为 `raw` 格式的示例：
- en: '[PRE5]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Tip
  id: totrans-56
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: 'Additional examples of using the `qemu-img` command can be found in the OpenStack
    documentation here:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 更多使用 `qemu-img` 命令的示例可以在 OpenStack 文档中找到：
- en: '[https://docs.openstack.org/image-guide/convert-images.html](https://docs.openstack.org/image-guide/convert-images.html)'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.openstack.org/image-guide/convert-images.html](https://docs.openstack.org/image-guide/convert-images.html)'
- en: The `file` parameter defines the local location of the image file respective
    to where the OpenStack client is being run. The OpenStack client uploads the image
    to the OpenStack image repository, where it is stored according to settings within
    Glance.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '`file` 参数定义了镜像文件相对于运行 OpenStack 客户端的位置。OpenStack 客户端将镜像上传到 OpenStack 镜像库，并根据
    Glance 中的设置进行存储。'
- en: When specified, the `--public` option marks the image as accessible by all projects
    within the cloud. Alternatively, the `--private` option marks the image as accessible
    only by the project that created it. By default, all images created are marked
    as `shared` and are eligible to be shared with another project. At the time of
    creation, however, the image can only be seen by the project that created it.
    The `--shared` and `--community` options are discussed later in this chapter in
    the *Sharing images* recipe.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 当指定时，`--public` 选项将镜像标记为所有云中的项目都可以访问。或者，`--private` 选项将镜像标记为仅创建它的项目可以访问。默认情况下，所有创建的镜像都标记为
    `shared`，并且可以与另一个项目共享。然而，在创建时，镜像只能由创建它的项目看到。`--shared` 和 `--community` 选项将在本章后续的
    *共享镜像* 章节中讨论。
- en: Listing images
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 列出镜像
- en: 'To list the images in the OpenStack Image service repository, use the following
    OpenStack client command:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 要列出 OpenStack 镜像服务库中的镜像，请使用以下 OpenStack 客户端命令：
- en: '[PRE6]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The output will resemble the following:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 输出将类似于以下内容：
- en: '![Listing images](img/00118.jpeg)'
  id: totrans-65
  prefs: []
  type: TYPE_IMG
  zh: '![列出镜像](img/00118.jpeg)'
- en: Viewing image details
  id: totrans-66
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 查看镜像详情
- en: 'The details of individual images can be queried using the following OpenStack
    client command:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用以下 OpenStack 客户端命令查询单个镜像的详细信息：
- en: '[PRE7]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The output will resemble the following:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 输出将类似于以下内容：
- en: '![Viewing image details](img/00119.jpeg)'
  id: totrans-70
  prefs: []
  type: TYPE_IMG
  zh: '![查看镜像详情](img/00119.jpeg)'
- en: Deleting images
  id: totrans-71
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 删除镜像
- en: Images can be deleted from the OpenStack image repository at any time. Keep
    in mind, however, that depending on the version of OpenStack installed, deleting
    an image can have an adverse effect on the ability to migrate an instance.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 图像可以随时从 OpenStack 图像仓库中删除。但请记住，根据安装的 OpenStack 版本，删除图像可能会对迁移实例的能力产生不利影响。
- en: Note
  id: totrans-73
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: OpenStack releases newer than Kilo should not be impacted by this issue.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 新版本的 OpenStack（Kilo 之后）不应受到此问题的影响。
- en: Getting ready
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When deleting an image, the following information will be necessary:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 删除图像时，需要以下信息：
- en: Image name or ID
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图像名称或 ID
- en: How to do it…
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'To delete an image in OpenStack, issue the following command:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 要在 OpenStack 中删除图像，请执行以下命令：
- en: '[PRE8]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: No output is returned if the operation is successful. To verify that the image
    is no longer available, use the `openstack image list` or `openstack image show`
    command.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，则不会返回任何输出。要验证图像是否已不再可用，可以使用`openstack image list`或`openstack image show`命令。
- en: Downloading images
  id: totrans-82
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 下载图像
- en: Images that exist in the OpenStack image repository can be downloaded at a later
    time and transferred to other systems.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 存在于 OpenStack 图像仓库中的图像可以在以后下载并传输到其他系统。
- en: Getting ready
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'To download an image from the OpenStack image repository, you must have access
    to the image. You will need the following details, at a minimum, to download the
    image:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 要从 OpenStack 图像仓库下载图像，您必须拥有访问该图像的权限。下载图像时，至少需要以下详细信息：
- en: Image name or ID
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图像名称或 ID
- en: Destination for downloaded file
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 下载文件的目标位置
- en: 'For our example, the following will be used:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的示例，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: 'Download location: `/tmp/my_downloaded_ubuntu_image.qcow2`'
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 下载位置：`/tmp/my_downloaded_ubuntu_image.qcow2`
- en: How to do it…
  id: totrans-91
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'With the OpenStack client installed on our system, we are now able to download
    an image from the repository with the following command:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了 OpenStack 客户端后，我们现在可以使用以下命令从仓库中下载图像：
- en: '[PRE9]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'No output is returned if the operation is successful. Use the `ls` command
    to list the downloaded file:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，则不会返回任何输出。使用`ls`命令列出已下载的文件：
- en: '![How to do it…](img/00120.jpeg)'
  id: totrans-95
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作……](img/00120.jpeg)'
- en: Sharing images
  id: totrans-96
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 分享图像
- en: When an image is *private*, it is only available to the project from which that
    image was created or uploaded. On the other hand, when an image is *public*, it
    is available to all projects. The OpenStack Image service provides a mechanism
    whereby these private images can be shared between a subset of projects. This
    allows greater control over images that need to exist for different projects without
    making them available to all.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 当图像为*私有*时，仅对创建或上传该图像的项目可用。另一方面，当图像为*公共*时，它对所有项目可用。OpenStack 图像服务提供了一种机制，允许这些私有图像在一部分项目之间共享。这使得在不向所有项目公开的情况下，更好地控制需要存在于不同项目中的图像。
- en: 'Sharing images among projects requires the following workflow:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 在项目之间共享图像需要以下工作流程：
- en: Tenant A updates an image's ability to be shared
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 租户 A 更新图像的共享能力
- en: Tenant A shares an image with Tenant B
  id: totrans-100
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 租户 A 与租户 B 分享图像
- en: Tenant B accepts or rejects the sharing attempt
  id: totrans-101
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 租户 B 接受或拒绝共享请求
- en: Getting ready
  id: totrans-102
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When sharing an image, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum,
    to share the image:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 共享图像时，请确保您已通过身份验证为管理员，或是该图像的所有者。共享图像至少需要以下详细信息：
- en: Image name or ID
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图像名称或 ID
- en: Project name or ID
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 项目名称或 ID
- en: 'For our example, the `ADMIN` project will share an image with the `FINANCE`
    project. The following will be used:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的示例，`ADMIN` 项目将与 `FINANCE` 项目共享图像。将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: 'Project name: `FINANCE`'
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 项目名称：`FINANCE`
- en: Note
  id: totrans-109
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: For instructions on how to create projects within OpenStack, refer to the [Chapter
    3](part0035_split_000.html#11C3M1-189e69df43a248268db97cde1b1a8e47 "Chapter 3. Keystone
    – OpenStack Identity Service"), *Keystone – OpenStack Identity Service*, chapter
    of this book.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 有关如何在 OpenStack 中创建项目的说明，请参见本书的[第 3 章](part0035_split_000.html#11C3M1-189e69df43a248268db97cde1b1a8e47
    "第 3 章. Keystone – OpenStack 身份服务")，*Keystone – OpenStack 身份服务*。
- en: How to do it…
  id: totrans-111
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'With the OpenStack client installed on our system, we are now able to share
    an image with the following steps:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了 OpenStack 客户端后，我们现在可以通过以下步骤共享图像：
- en: 'Configure the environment with the credentials of a user in the `FINANCE` project:'
  id: totrans-113
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`FINANCE`项目中用户的凭证配置环境：
- en: '[PRE10]'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'As a user in the `FINANCE` project, view all available images:'
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 作为`FINANCE`项目中的用户，查看所有可用的图片：
- en: '[PRE11]'
  id: totrans-116
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'The output will resemble the following if no images are available:'
  id: totrans-117
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果没有可用的图片，输出将类似于以下内容：
- en: '![How to do it…](img/00121.jpeg)'
  id: totrans-118
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作...](img/00121.jpeg)'
- en: Note
  id: totrans-119
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: In this environment, no images are available to the `FINANCE` project.
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在此环境中，`FINANCE`项目没有可用的图片。
- en: 'Now, configure the environment with the credentials of a user in the ADMIN
    project:'
  id: totrans-121
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，使用ADMIN项目中用户的凭证配置环境：
- en: '[PRE12]'
  id: totrans-122
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Update the Ubuntu image and make it available for sharing:'
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更新Ubuntu镜像并使其可共享：
- en: '[PRE13]'
  id: totrans-124
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: No output will be returned.
  id: totrans-125
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 不会返回任何输出。
- en: 'Share the Ubuntu image with the FINANCE project:'
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 与FINANCE项目共享Ubuntu镜像：
- en: '[PRE14]'
  id: totrans-127
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'The output will resemble the following:'
  id: totrans-128
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出将类似于以下内容：
- en: '![How to do it…](img/00122.jpeg)'
  id: totrans-129
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作...](img/00122.jpeg)'
- en: Note
  id: totrans-130
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: At this point, the user should notify the `FINANCE` project of the sharing attempt
    and provide the image ID. In this example, the image ID is `d120a923-5246-4dca-8f52-51a951bffce5`.
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此时，用户应通知`FINANCE`项目共享尝试并提供图片ID。在此示例中，图片ID为`d120a923-5246-4dca-8f52-51a951bffce5`。
- en: 'Reconfigure the environment with the credentials of a user in the `FINANCE`
    project:'
  id: totrans-132
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`FINANCE`项目中用户的凭证重新配置环境：
- en: '[PRE15]'
  id: totrans-133
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Accept the sharing attempt:'
  id: totrans-134
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接受共享尝试：
- en: '[PRE16]'
  id: totrans-135
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: No output will be returned.
  id: totrans-136
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 不会返回任何输出。
- en: 'View all available images:'
  id: totrans-137
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 查看所有可用的图片：
- en: '[PRE17]'
  id: totrans-138
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'The output will resemble the following:'
  id: totrans-139
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出将类似于以下内容：
- en: '![How to do it…](img/00123.jpeg)'
  id: totrans-140
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作...](img/00123.jpeg)'
- en: How it works...
  id: totrans-141
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: Sharing images requires the use of the `openstack image add project` command
    on the part of the producer and the `openstack image set` command on the part
    of the consumer. The process involves communication between the producer and the
    consumer outside of the OpenStack API, as the image ID must be shared between
    them.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 共享图片需要生产者使用`openstack image add project`命令，消费者使用`openstack image set`命令。此过程涉及生产者与消费者之间的沟通，超出了OpenStack
    API，因为图片ID必须在它们之间共享。
- en: 'Producers invoke the sharing process using the following command:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 生产者使用以下命令启动共享过程：
- en: '[PRE18]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Once shared, the consumer has the ability to accept or reject the attempt using
    the following:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦共享，消费者可以使用以下方式接受或拒绝该尝试：
- en: '[PRE19]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Note
  id: totrans-147
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Marking an image as `pending` makes the image unavailable to users in the consuming
    project, but leaves open the possibility of making it available at a later time.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 将图片标记为`pending`使该图片在消费项目中不可用，但仍然保留稍后使其可用的可能性。
- en: 'The producer can revoke the sharing of an image using the following command:'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 生产者可以使用以下命令撤销图片的共享：
- en: '[PRE20]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: An alternative to marking an image as shared would be to mark its visibility
    as `community` using the `--community` option. This allows a user to share an
    image with all projects, but still requires the consuming projects to accept the
    image before it is returned in an image list. This reduces the administrative
    overhead on the part of the user sharing the image without unnecessarily cluttering
    the entire image list for all projects.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 标记图片为共享的替代方法是将其可见性标记为`community`，使用`--community`选项。这允许用户将图片共享给所有项目，但仍然需要消费项目在图片出现在图片列表之前接受该图片。这减少了共享图片用户的管理负担，同时不会无谓地使所有项目的图片列表变得凌乱。
- en: For additional information regarding the sharing of images, visit [https://docs.openstack.org/image-guide/share-images.html](https://docs.openstack.org/image-guide/share-images.html).
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 有关共享图片的更多信息，请访问[https://docs.openstack.org/image-guide/share-images.html](https://docs.openstack.org/image-guide/share-images.html)。
- en: Using image snapshots
  id: totrans-153
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用图片快照
- en: In OpenStack, a snapshot is an image that reflects the state of an instance
    at a point in time. Snapshots are often used to backup instances or migrate instances
    from one cloud to another, and can even be shared with other projects like regular
    images.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 在OpenStack中，快照是反映实例在某个时间点状态的图片。快照通常用于备份实例或将实例从一个云迁移到另一个云，并且可以像普通图片一样与其他项目共享。
- en: Creating snapshots
  id: totrans-155
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建快照
- en: Snapshots in OpenStack can be created using the `openstack server image create`
    command.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用`openstack server image create`命令在OpenStack中创建快照。
- en: Getting ready
  id: totrans-157
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: 'When creating a snapshot, ensure that you are authenticated as an administrator
    or are the owner of the instance. You will need the following details:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 创建快照时，请确保您已作为管理员进行身份验证或是实例的所有者。您将需要以下详细信息：
- en: Instance name or ID
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实例名称或ID
- en: Image name
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图片名称
- en: 'For our example, the following will be used:'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的示例，将使用以下内容：
- en: 'Instance name: `COOKBOOK_TEST_INSTANCE`'
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实例名称：`COOKBOOK_TEST_INSTANCE`
- en: 'Image: `COOKBOOK_TEST_SNAPSHOT_20170824`'
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图片：`COOKBOOK_TEST_SNAPSHOT_20170824`
- en: How to do it…
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to create
    a snapshot with the following command:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 安装OpenStack客户端后，我们现在可以使用以下命令创建快照：
- en: '[PRE21]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'The output will resemble the following:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 输出结果将类似于以下内容：
- en: '![How to do it…](img/00124.jpeg)'
  id: totrans-168
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作…](img/00124.jpeg)'
- en: How it works…
  id: totrans-169
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的…
- en: 'Images snapshots are created with the following syntax:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 图片快照使用以下语法创建：
- en: '[PRE22]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: The creation of a snapshot results in the system writing the instance's disk
    to a temporary file on the compute node and uploading it to the OpenStack Image
    service as a new image. When an instance's disk is located on a Ceph backend,
    the snapshot occurs on the backend itself and the compute node filesystem is not
    involved. The resulting snapshot/image can then be used to boot new instances
    within the same cloud, or it can be downloaded and copied to an offline storage
    system or another cloud.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 快照的创建会导致系统将实例的磁盘写入计算节点上的临时文件，并将其上传到OpenStack镜像服务作为新的图片。当实例的磁盘位于Ceph后端时，快照发生在后端本身，计算节点文件系统不参与其中。生成的快照/图片随后可以用于在同一云中启动新的实例，或者可以下载并复制到离线存储系统或其他云中。
- en: The `name` parameter defines the name of the image when stored in the image
    repository.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: '`name`参数定义了图片存储在镜像库中的名称。'
- en: The `<server>` parameter defines the name or ID of the instance from which the
    snapshot is taken.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: '`<server>`参数定义了从中拍摄快照的实例的名称或ID。'
- en: When specified, the `--wait` option forces OpenStack to perform the snapshot
    in the foreground, meaning the CLI will be unavailable until the task is complete.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 如果指定了`--wait`选项，它会强制OpenStack在前台执行快照操作，这意味着在任务完成之前，CLI将无法使用。
- en: Using image metadata
  id: totrans-176
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用图片元数据
- en: Images have properties known as **metadata** that help describe the image and
    how it relates to other OpenStack components. The metadata that is applied to
    an image can be used to enable specific functionality in other OpenStack services
    or to determine the scheduling of an instance to a host based on CPU architectures
    or features, and more.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 图片具有被称为**元数据**的属性，这些属性有助于描述图片及其与其他OpenStack组件的关系。应用于图片的元数据可以用于启用其他OpenStack服务中的特定功能，或根据CPU架构或特性等确定将实例调度到主机的方式，等等。
- en: Setting image metadata
  id: totrans-178
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置图片元数据
- en: Image metadata in OpenStack can be manipulated using the `openstack image set`
    command. The `--property` argument can be used to set additional properties using
    the `key=value` pairs.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: OpenStack中的图片元数据可以通过`openstack image set`命令进行操作。`--property`参数可以用来通过`key=value`对设置其他属性。
- en: Getting ready
  id: totrans-180
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When setting image metadata, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 在设置图片元数据时，请确保您已认证为管理员或是该图片的所有者。至少需要以下信息：
- en: Image name or ID
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图片名称或ID
- en: Property name and value
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 属性名称和值
- en: 'For our examples, the following will be used:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 图片名称：`COOKBOOK_UBUNTU_IMAGE`
- en: 'Property name and value: `architecture=m68k, os_distro=ubuntu`'
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 属性名称和值：`architecture=m68k, os_distro=ubuntu`
- en: How to do it…
  id: totrans-187
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to set image
    metadata with the following command:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 安装OpenStack客户端后，我们现在可以使用以下命令设置图片元数据：
- en: '[PRE23]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'No output is returned if the operation is successful. However, using `openstack
    image show` will reveal that the properties have been set:'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，则不会返回任何输出。然而，使用`openstack image show`将显示属性已被设置：
- en: '![How to do it…](img/00125.jpeg)'
  id: totrans-191
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作…](img/00125.jpeg)'
- en: How it works...
  id: totrans-192
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: When image metadata is set in OpenStack, the properties have an impact on how
    the system handles instances using that image. Properties such as `hypervisor_type`
    and `architecture` affect how an instance is scheduled to a host, while other
    properties such as `hw_disk_bus` and `hw_cdrom_bus` affect how virtual devices
    are connected to the instance.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 在OpenStack中设置图片元数据时，属性会影响系统如何处理使用该图片的实例。属性如`hypervisor_type`和`architecture`影响实例如何调度到主机，而其他属性如`hw_disk_bus`和`hw_cdrom_bus`则影响虚拟设备如何连接到实例。
- en: Note
  id: totrans-194
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: In order to schedule instances based on image metadata, be sure to include the
    `'ImagePropertiesFilter'` filter in the `enabled_filters` list in `/etc/nova/nova.conf`.
    This is a default in most OpenStack installations, including the environment built
    in this book.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 要根据镜像元数据调度实例，请确保在`/etc/nova/nova.conf`中的`enabled_filters`列表中包含`'ImagePropertiesFilter'`过滤器。这是大多数OpenStack安装的默认设置，包括本书中构建的环境。
- en: 'In this environment, booting an instance using the modified image requiring
    an architecture of `m68k` (Motorola 68000) should result in the following error:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种环境中，使用要求架构为`m68k`（Motorola 68000）的修改后镜像引导实例应导致以下错误：
- en: '[PRE24]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Modifying the image to require `x86_64` or removing the property altogether
    should allow the instance to be scheduled according to other defined metadata
    or environmental defaults.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 修改镜像以要求`x86_64`或完全删除该属性应允许根据其他定义的元数据或环境默认值来安排实例的调度。
- en: 'A current list of image metadata properties at time of writing can be found
    at the following location:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在撰写本文时，可以在以下位置找到当前的镜像元数据属性列表：
- en: '[https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html](https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html)'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html](https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html)'
- en: Removing image metadata
  id: totrans-201
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 删除图像元数据
- en: Image metadata in OpenStack can be removed using the `openstack image unset`
    command. The `--property` argument can be used to unset individual properties.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 在OpenStack中，可以使用`openstack image unset`命令来删除图像元数据。`--property`参数可用于取消单个属性的设置。
- en: Getting ready
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When removing image metadata, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 在删除图像元数据时，请确保您已经作为管理员进行了身份验证，或者是镜像的所有者。至少需要以下详细信息：
- en: Image name or ID
  id: totrans-205
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称或ID
- en: Property name
  id: totrans-206
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 属性名称
- en: 'For our examples, the following will be used:'
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的示例，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-208
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: 'Property name: `architecture`'
  id: totrans-209
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 属性名称：`architecture`
- en: How to do it…
  id: totrans-210
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to unset
    image metadata with the following command:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了OpenStack客户端后，现在可以使用以下命令取消设置图像元数据：
- en: '[PRE25]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: No output is returned if the operation is successful. To verify that the property
    has been removed, use the `openstack image show` command.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，则不返回任何输出。要验证已删除属性，请使用`openstack image show`命令。
- en: Protecting images
  id: totrans-214
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 保护图像
- en: Like other OpenStack objects, images and snapshots are susceptible to accidental
    deletion by users. By default, images are unprotected, meaning they can be deleted
    at any time by a user within a project. The following sections explain how an
    image can be protected to ensure its survival.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 与其他OpenStack对象类似，图像和快照容易被用户意外删除。默认情况下，图像是不受保护的，这意味着可以随时由项目中的用户删除。以下各节将解释如何保护图像以确保其存活。
- en: Protecting an image
  id: totrans-216
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 保护图像
- en: Images can be protected using the `openstack image set` command with the `--protected`
    argument.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用`openstack image set`命令并带有`--protected`参数来保护图像。
- en: Getting ready
  id: totrans-218
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When protecting an image, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 在保护镜像时，请确保您已经作为管理员进行了身份验证，或者是镜像的所有者。至少需要以下详细信息：
- en: Image name or ID
  id: totrans-220
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称或ID
- en: 'For our examples, the following will be used:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的示例，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-222
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: How to do it…
  id: totrans-223
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to protect
    an image with the following command:'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了OpenStack客户端后，现在可以使用以下命令保护图像：
- en: '[PRE26]'
  id: totrans-225
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'No output is returned if the operation is successful. Use the `openstack image
    show` command to reveal the status of the image:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，则不返回任何输出。使用`openstack image show`命令来查看镜像的状态：
- en: '![How to do it…](img/00126.jpeg)'
  id: totrans-227
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作…](img/00126.jpeg)'
- en: How it works...
  id: totrans-228
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理…
- en: 'When an image is protected in OpenStack, users are unable to delete the image.
    Attempting to delete a protected image results in an error similar to the following:'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 当在OpenStack中保护图像时，用户无法删除该图像。尝试删除受保护的图像将导致类似以下的错误：
- en: '[PRE27]'
  id: totrans-230
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Protecting an image is a useful step in ensuring that snapshots and other special
    images remain unharmed in a cloud shared by many users and projects.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 保护图像是确保由许多用户和项目共享的云中快照和其他特殊图像保持完好的有用步骤。
- en: Unprotecting an image
  id: totrans-232
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 解除图像保护
- en: Images can be unprotected using the `openstack image set` command with the `--unprotected`
    argument.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用 `openstack image set` 命令与 `--unprotected` 参数解除镜像的保护。
- en: Getting ready
  id: totrans-234
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When unprotecting an image, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum:'
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 当解除保护镜像时，确保你已认证为管理员或是镜像的所有者。你至少需要以下信息：
- en: Image name or ID
  id: totrans-236
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称或 ID
- en: 'For our examples, the following will be used:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: How to do it…
  id: totrans-239
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to unprotect
    an image with the following command:'
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了 OpenStack 客户端后，我们现在可以使用以下命令解除镜像保护：
- en: '[PRE28]'
  id: totrans-241
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: No output is returned if the operation is successful. Use the `openstack image
    show` command to reveal the status of the image.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，将不返回任何输出。使用 `openstack image show` 命令查看镜像的状态。
- en: Deactivating images
  id: totrans-243
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 停用镜像
- en: By default, images are available for use immediately upon completion of the
    uploading process. At times, it may be necessary to deactivate an image to prevent
    users from booting instances with the image, especially in cases where the image
    may be outdated but must be retained for archival purposes.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，镜像在上传过程完成后即可使用。有时，可能需要停用镜像，以防止用户使用该镜像启动实例，尤其是当镜像可能过时但必须保留用于归档时。
- en: Deactivating an image
  id: totrans-245
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 停用镜像
- en: Images can be deactivated using the `openstack image set` command with the `--deactivate`
    argument.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用 `openstack image set` 命令与 `--deactivate` 参数停用镜像。
- en: Getting ready
  id: totrans-247
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When deactivating an image, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum:'
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 停用镜像时，确保你已认证为管理员或是镜像的所有者。你至少需要以下信息：
- en: Image name or ID
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称或 ID
- en: 'For our examples, the following will be used:'
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-251
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: How to do it…
  id: totrans-252
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to deactivate
    an image with the following command:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了 OpenStack 客户端后，我们现在可以使用以下命令停用镜像：
- en: '[PRE29]'
  id: totrans-254
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'No output is returned if the operation is successful. Use the `openstack image
    show` command to reveal the status of the image:'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，将不返回任何输出。使用 `openstack image show` 命令查看镜像的状态：
- en: '![How to do it…](img/00127.jpeg)'
  id: totrans-256
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作…](img/00127.jpeg)'
- en: How it works...
  id: totrans-257
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: 'When an image is deactivated in OpenStack, users are unable to boot instances
    using the image. Attempting to boot an instance with a deactivated image results
    in an error similar to the following:'
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 当镜像在 OpenStack 中被停用时，用户无法使用该镜像启动实例。尝试使用停用镜像启动实例时，将出现类似以下的错误：
- en: '[PRE30]'
  id: totrans-259
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Deactivating an image is a useful step in ensuring that images are retained
    but unusable. Existing instances using the image are not impacted.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 停用镜像是确保镜像被保留但无法使用的一个有用步骤。现有的使用该镜像的实例不会受到影响。
- en: Activating an image
  id: totrans-261
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 激活镜像
- en: Deactivated images can be activated using the `openstack image set` command
    with the `--activate` argument.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 停用的镜像可以通过 `openstack image set` 命令与 `--activate` 参数重新激活。
- en: Getting ready
  id: totrans-263
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'When activating an image, ensure that you are authenticated as an administrator
    or are the owner of the image. You will need the following details, at a minimum:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 激活镜像时，确保你已认证为管理员或是镜像的所有者。你至少需要以下信息：
- en: Image name or ID
  id: totrans-265
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称或 ID
- en: 'For our examples, the following will be used:'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，将使用以下内容：
- en: 'Image name: `COOKBOOK_UBUNTU_IMAGE`'
  id: totrans-267
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 镜像名称：`COOKBOOK_UBUNTU_IMAGE`
- en: How to do it…
  id: totrans-268
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'With the OpenStack client installed on our system, we are now able to activate
    an image with the following command:'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的系统上安装了 OpenStack 客户端后，我们现在可以使用以下命令激活镜像：
- en: '[PRE31]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: No output is returned if the operation is successful. Use the `openstack image
    show` command to reveal the status of the image.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 如果操作成功，将不返回任何输出。使用 `openstack image show` 命令查看镜像的状态。
- en: Creating custom images
  id: totrans-272
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建自定义镜像
- en: Users can create custom images of various operating systems that can be used
    within an OpenStack environment. Tools such as `cloud-init` can be installed in
    the image to provide a method of bootstrapping an instance once it has been deployed.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 用户可以创建各种操作系统的自定义镜像，这些镜像可以在 OpenStack 环境中使用。诸如 `cloud-init` 之类的工具可以安装在镜像中，以提供一种在实例部署后进行引导的方法。
- en: Note
  id: totrans-274
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The use of `cloud-init` is beyond the scope of this book. More information can
    be found at [https://cloud-init.io](https://cloud-init.io).
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: '`cloud-init`的使用超出了本书的范围。更多信息请参见[https://cloud-init.io](https://cloud-init.io)。'
- en: Getting ready
  id: totrans-276
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: To begin, ensure that you are using an operating system that is not the OpenStack
    environment used throughout this book. Software packages and libraries needed
    to create images may conflict with the software currently installed, and could
    result in a broken environment. In this example, we will use a virtual machine
    configured with Ubuntu 16.04 LTS to create a custom CentOS 7 image.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，确保你使用的操作系统不是本书中所用的OpenStack环境。创建镜像所需的软件包和库可能与当前已安装的软件发生冲突，导致环境损坏。在本示例中，我们将使用配置为Ubuntu
    16.04 LTS的虚拟机来创建自定义的CentOS 7镜像。
- en: Note
  id: totrans-278
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Configuring a virtual machine with the Ubuntu 16.04 LTS operating system is
    beyond the scope of this book. A physical server can be used in lieu of a virtual
    machine, if necessary.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 配置Ubuntu 16.04 LTS操作系统的虚拟机超出了本书的范围。如果需要，也可以使用物理服务器代替虚拟机。
- en: 'The following packages are prerequisites for the host building of the image:'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 以下软件包是构建镜像所需的主机前置条件：
- en: '`qemu-kvm`'
  id: totrans-281
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`qemu-kvm`'
- en: '`libvirt-bin`'
  id: totrans-282
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`libvirt-bin`'
- en: '`virt-manager`'
  id: totrans-283
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`virt-manager`'
- en: 'Using `apt`, install the packages with the following commands:'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`apt`，通过以下命令安装软件包：
- en: '[PRE32]'
  id: totrans-285
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: How to do it…
  id: totrans-286
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'Carry out the following steps within the virtual machine to create a custom
    image:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 在虚拟机内执行以下步骤以创建自定义镜像：
- en: 'Change to your home directory and create a kickstart file named `ks.cfg` with
    the following contents:'
  id: totrans-288
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到你的主目录，并创建一个名为`ks.cfg`的kickstart文件，内容如下：
- en: '[PRE33]'
  id: totrans-289
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Create an empty 10 GB virtual disk to be used by the CentOS virtual machine:'
  id: totrans-290
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个空的10GB虚拟磁盘供CentOS虚拟机使用：
- en: '[PRE34]'
  id: totrans-291
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'Execute the following commands to initiate an unattended installation of the
    CentOS operating system:'
  id: totrans-292
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 执行以下命令以启动CentOS操作系统的无人值守安装：
- en: '[PRE35]'
  id: totrans-293
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Note
  id: totrans-294
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If the installation is being performed inside a virtual machine using nested
    virtualization, you may need to change `virt-type` to `qemu` from `kvm` for the
    machine to start properly. Use `kvm` for better performance if the image is being
    built without nested virtualization.
  id: totrans-295
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果安装是在启用嵌套虚拟化的虚拟机内进行的，可能需要将`virt-type`从`kvm`更改为`qemu`，以便虚拟机正确启动。如果没有嵌套虚拟化，使用`kvm`能获得更好的性能。
- en: 'The output returned should resemble the following:'
  id: totrans-296
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 返回的输出应类似于以下内容：
- en: '[PRE36]'
  id: totrans-297
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'From the host machine, console to the newly-created CentOS virtual machine
    and log in as the `root` user with the `openstack` password. To escape from the
    console session, press **Ctrl** + **]**:'
  id: totrans-298
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从主机登录到新创建的CentOS虚拟机，并使用`openstack`密码作为`root`用户登录。要退出控制台会话，请按**Ctrl** + **]**：
- en: '[PRE37]'
  id: totrans-299
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'To refresh the console, press the **Enter** key. The output will resemble the
    following:'
  id: totrans-300
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要刷新控制台，请按**Enter**键。输出将类似于以下内容：
- en: '![How to do it…](img/00128.jpeg)'
  id: totrans-301
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作…](img/00128.jpeg)'
- en: The guest should be in the process of booting, and a live console log will be
    displayed. The installation process is automated and could take a while depending
    on the resources available to the host performing the build.
  id: totrans-302
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 客户机应正在启动，并且将显示实时控制台日志。安装过程是自动化的，可能会根据主机提供的资源而需要一段时间。
- en: 'When the installation is complete, the output will resemble the following:'
  id: totrans-303
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 安装完成时，输出将类似于以下内容：
- en: '[PRE38]'
  id: totrans-304
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: The console session should end, and you will be returned to a prompt on the
    host.
  id: totrans-305
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 控制台会话应结束，你将返回到主机的提示符。
- en: 'Start the VM with the following command:'
  id: totrans-306
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令启动虚拟机：
- en: '[PRE39]'
  id: totrans-307
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'From the host machine, console to the CentOS virtual machine and log in as
    the `root` user with the `openstack` password. To escape from the console session,
    press **Ctrl** + **]**:'
  id: totrans-308
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从主机登录到CentOS虚拟机，并使用`openstack`密码作为`root`用户登录。要退出控制台会话，请按**Ctrl** + **]**：
- en: '[PRE40]'
  id: totrans-309
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'To refresh the console, press the **Enter** key. The output will resemble the
    following:'
  id: totrans-310
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要刷新控制台，请按**Enter**键。输出将类似于以下内容：
- en: '[PRE41]'
  id: totrans-311
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'In the guest, install the `epel-release` and `cloud-init` packages with the
    following commands:'
  id: totrans-312
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在来宾中，通过以下命令安装`epel-release`和`cloud-init`软件包：
- en: '[PRE42]'
  id: totrans-313
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Using a text editor, replace the guest''s `cloud.cfg` file at `/etc/cloud/cloud.cfg`
    with the following contents:'
  id: totrans-314
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用文本编辑器，将来宾的`cloud.cfg`文件（位于`/etc/cloud/cloud.cfg`）替换为以下内容：
- en: '[PRE43]'
  id: totrans-315
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE43]'
- en: Note
  id: totrans-316
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The contents of `cloud.cfg` are constructed in YAML, and are interpreted by
    `cloud-init` upon startup. In this example, the default username used to access
    the instance is `centos` and no password is set. Instead, an SSH key must be used
    and will be pushed to the instance via the OpenStack metadata service. Refer to
    [Chapter 5](part0062_split_000.html#1R42S1-189e69df43a248268db97cde1b1a8e47 "Chapter 5. Nova
    – OpenStack Compute"), *Nova – OpenStack Compute*, for more information.
  id: totrans-317
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '`cloud.cfg` 的内容是以 YAML 格式构建的，在启动时由 `cloud-init` 进行解析。在这个示例中，访问实例的默认用户名是 `centos`，并且没有设置密码。相反，必须使用
    SSH 密钥，并将其通过 OpenStack 元数据服务推送到实例。更多信息请参见 [第 5 章](part0062_split_000.html#1R42S1-189e69df43a248268db97cde1b1a8e47
    "第 5 章 Nova – OpenStack 计算"), *Nova – OpenStack 计算*。'
- en: 'Ensure that the guest can communicate with the metadata service with the following
    command:'
  id: totrans-318
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保虚拟机能够通过以下命令与元数据服务进行通信：
- en: '[PRE44]'
  id: totrans-319
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'Remove persistent rules with the following command:'
  id: totrans-320
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令删除持久化规则：
- en: '[PRE45]'
  id: totrans-321
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'Remove machine-specific MAC address and UUID. Edit the `/etc/sysconfig/network-scripts/ifcfg-eth0`
    file and remove lines starting with `HWADDR` and `UUID`:'
  id: totrans-322
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 删除特定机器的 MAC 地址和 UUID。编辑 `/etc/sysconfig/network-scripts/ifcfg-eth0` 文件并删除以 `HWADDR`
    和 `UUID` 开头的行：
- en: '[PRE46]'
  id: totrans-323
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'After making the changes, ensure that the interface configuration file resembles
    the following:'
  id: totrans-324
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 做出更改后，确保接口配置文件类似于以下内容：
- en: '[PRE47]'
  id: totrans-325
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE47]'
- en: Note
  id: totrans-326
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you need IPv6 support, modify the interface file accordingly to ensure that
    instances using the image can procure their IPv6 address via DHCPv6 or SLAAC.
  id: totrans-327
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您需要支持 IPv6，请相应地修改接口文件，确保使用该镜像的实例能够通过 DHCPv6 或 SLAAC 获取其 IPv6 地址。
- en: 'Clean up various files and directories using the following commands:'
  id: totrans-328
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令清理各种文件和目录：
- en: '[PRE48]'
  id: totrans-329
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'From within the guest, cleanly shutdown the guest using the following command:'
  id: totrans-330
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在虚拟机内部，使用以下命令干净地关闭虚拟机：
- en: '[PRE49]'
  id: totrans-331
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'Once the guest is shutdown, the console session should end and you will be
    returned to a prompt on the host. Transfer the disk located at `/var/lib/libvirt/images/centos-7.qcow2`
    to your home directory, where it can be transferred out of the host and onto a
    client, where the OpenStack command-line utility is installed. Using the OpenStack
    client, upload the image to the OpenStack image repository:'
  id: totrans-332
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 一旦虚拟机关闭，控制台会话应该结束，您将返回到主机上的提示符。在主机上将位于 `/var/lib/libvirt/images/centos-7.qcow2`
    的磁盘文件传输到您的主目录，在那里它可以被传输出主机并转移到安装了 OpenStack 命令行工具的客户端。使用 OpenStack 客户端，将镜像上传到
    OpenStack 镜像库：
- en: '[PRE50]'
  id: totrans-333
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'The output should resemble the following:'
  id: totrans-334
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出应类似于以下内容：
- en: '![How to do it…](img/00129.jpeg)'
  id: totrans-335
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![如何操作…](img/00129.jpeg)'
- en: For more information on building custom images, visit [https://docs.openstack.org/image-guide/create-images-manually.html](https://docs.openstack.org/image-guide/create-images-manually.html).
  id: totrans-336
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 欲了解有关构建自定义镜像的更多信息，请访问 [https://docs.openstack.org/image-guide/create-images-manually.html](https://docs.openstack.org/image-guide/create-images-manually.html)。
